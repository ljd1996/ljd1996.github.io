<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="概述RePlugin是360在2017年推出的插件化框架，其目的是让尽可能多的模块变成插件。RePlugin与其他插件化的特色在于它只Hook住了ClassLoader，One Hook这个坚持，最大程度保证了稳定性、兼容性和可维护性。 RePlugin项目地址：RePlugin，不过RePlugin上次更新已经是2019年7月了，且其没有支持androidx，网上有一个androidx版本的Re">
<meta property="og:type" content="article">
<meta property="og:title" content="RePlugin原理解析">
<meta property="og:url" content="http://yoursite.com/2020/03/19/RePlugin%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/index.html">
<meta property="og:site_name" content="苍耳的博客">
<meta property="og:description" content="概述RePlugin是360在2017年推出的插件化框架，其目的是让尽可能多的模块变成插件。RePlugin与其他插件化的特色在于它只Hook住了ClassLoader，One Hook这个坚持，最大程度保证了稳定性、兼容性和可维护性。 RePlugin项目地址：RePlugin，不过RePlugin上次更新已经是2019年7月了，且其没有支持androidx，网上有一个androidx版本的Re">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/2020/03/19/RePlugin%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%9B%E7%A8%8BActivity.webp">
<meta property="og:image" content="http://yoursite.com/2020/03/19/RePlugin%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/RePlugin.jpg">
<meta property="og:image" content="http://yoursite.com/2020/03/19/RePlugin%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/Activity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.webp">
<meta property="article:published_time" content="2020-03-19T07:44:50.000Z">
<meta property="article:modified_time" content="2021-05-14T06:14:57.909Z">
<meta property="article:author" content="苍耳叔叔">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="插件化">
<meta property="article:tag" content="RePlugin">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2020/03/19/RePlugin%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%9B%E7%A8%8BActivity.webp">

<link rel="canonical" href="http://yoursite.com/2020/03/19/RePlugin%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>RePlugin原理解析 | 苍耳的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">苍耳的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">细水长流</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/03/19/RePlugin%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          RePlugin原理解析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-19 15:44:50" itemprop="dateCreated datePublished" datetime="2020-03-19T15:44:50+08:00">2020-03-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/%E7%83%AD%E6%9B%B4%E6%96%B0/" itemprop="url" rel="index"><span itemprop="name">热更新</span></a>
                </span>
            </span>

          
            <span id="/2020/03/19/RePlugin%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/" class="post-meta-item leancloud_visitors" data-flag-title="RePlugin原理解析" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/03/19/RePlugin%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/03/19/RePlugin%E5%8E%9F%E7%90%86%E8%A7%A3%E6%9E%90/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>RePlugin是360在2017年推出的插件化框架，其目的是<code>让尽可能多的模块变成插件</code>。RePlugin与其他插件化的特色在于它只Hook住了ClassLoader，One Hook这个坚持，最大程度保证了稳定性、兼容性和可维护性。</p>
<p>RePlugin项目地址：<a target="_blank" rel="noopener" href="https://github.com/Qihoo360/RePlugin">RePlugin</a>，不过RePlugin上次更新已经是2019年7月了，且其没有支持androidx，网上有一个androidx版本的RePlugin，地址：<a target="_blank" rel="noopener" href="https://github.com/froyohuang/replugin-androidx">replugin-androidx</a>。虽然RePlugin已经停更，但是还是挺值得研究一下的。</p>
<a id="more"></a>

<p>详细使用教程可以看<a target="_blank" rel="noopener" href="https://github.com/Qihoo360/RePlugin/wiki">官网WIKI</a>以及<a target="_blank" rel="noopener" href="https://github.com/Qihoo360/RePlugin/tree/dev/replugin-sample">Sample示例</a></p>
<p><strong>注意事项</strong></p>
<ol>
<li>宿主开启了MultiDex后，可能会导致打包时报错：<code>Cannot fit requested classes in the main-dex file</code>，当我把gradle插件版本从3.4.2升级到3.5.2后，打包成功；</li>
<li>插件工程replugin-plugin-lib不支持高版本的gradle插件，我测试的3.4.2可以支持，如果用了高版本的gradle插件，则可以通过手动让BaseActivity继承自PluginXXXActivity；</li>
<li>不支持androidx；</li>
<li>gradle在编译时会根据assets/plugins目录下的jar文件生成内置插件的json文件，当内置插件有了修改时，最好先clean project。</li>
<li>RePlugin版本目前最新是2.3.3，WIKI上的示例使用的不是最新版本，建议在项目中使用最新版本。</li>
<li>对于replugin-plugin-gradle插件在高版本gradle或者AndroidX上没有在编译器替换相关类的问题，可以参考下面关于replugin-plugin-gradle插件源码的解析去临时解决这个问题（不包括在gradle更高版本上某些编译报错的问题）。</li>
</ol>
<h1 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h1><h2 id="replugin-host-gradle"><a href="#replugin-host-gradle" class="headerlink" title="replugin-host-gradle"></a>replugin-host-gradle</h2><p>对应com.qihoo360.replugin:replugin-host-gradle:xxx依赖，主要负责在主程序的编译期中生产各类文件：</p>
<ul>
<li><p>扫描内置的插件目录assets/plugins目录，解析插件文件生成包含文件名、包名、版本、路径的plugins-builtin.json文件，这个文件的路径在<code>build/intermediates/merged_assets/debug/out/plugins-builtin.json</code>目录：</p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;high&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">&quot;frm&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">&quot;ver&quot;</span>: <span class="number">104</span>,</span><br><span class="line">        <span class="attr">&quot;low&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">&quot;pkg&quot;</span>: <span class="string">&quot;com.qihoo360.replugin.sample.demo1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;plugins/demo1.jar&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;demo1&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="attr">&quot;high&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">&quot;frm&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">&quot;ver&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;low&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">&quot;pkg&quot;</span>: <span class="string">&quot;com.hearing.plugin1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;plugins/plugin1.jar&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;plugin1&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure></li>
<li><p>根据用户的配置文件，生成HostBuildConfig类，位于<code>build/generated/source/buildConfig/debug/com/qihoo360/replugin/gen/RePluginHostConfig.java</code>，方便插件框架读取并自定义其属性，如：进程数、各类型占位坑的数量、是否使用AppCompat库、Host版本、pulgins-builtin.json文件名、内置插件文件名等。</p>
</li>
<li><p>自动生成带Activity，Service，ContentProvider坑位的 AndroidManifest.xml文件，文件中带有如：</p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">android:theme</span>=<span class="string">&quot;@style/Theme.AppCompat&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;com.qihoo360.replugin.sample.host.loader.a.ActivityN1STTS0&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">android:screenOrientation</span>=<span class="string">&quot;portrait&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:configChanges</span>=<span class="string">&quot;keyboard|keyboardHidden|orientation|screenSize&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;com.hearing.host.loader.p.Provider1&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:process</span>=<span class="string">&quot;:loader1&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:authorities</span>=<span class="string">&quot;com.hearing.host.loader.p.pr1&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">service</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;com.hearing.host.loader.s.Service1&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:process</span>=<span class="string">&quot;:loader1&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;com.qihoo360.replugin.component.process.ProcessPitProviderP0&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:process</span>=<span class="string">&quot;:p0&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:authorities</span>=<span class="string">&quot;com.hearing.host.loader.p.mainN100&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="replugin-host-library"><a href="#replugin-host-library" class="headerlink" title="replugin-host-library"></a>replugin-host-library</h2><p>对应com.qihoo360.replugin:replugin-host-lib:xxx依赖，是一个Java工程，由主程序负责引入，是RePlugin的核心工程，负责初始化、加载、启动、管理插件等。</p>
<h2 id="replugin-plugin-gradle"><a href="#replugin-plugin-gradle" class="headerlink" title="replugin-plugin-gradle"></a>replugin-plugin-gradle</h2><p>对应com.qihoo360.replugin:replugin-plugin-gradle:xxx ，是一个Gradle插件，由插件负责引入，主要负责在插件的编译期中，使用Transfrom API和Javassist实现了编译期间动态的修改字节码文件，配置插件打包相关信息；动态替换插件工程中的继承基类，如下，修改Activity的继承、动态的将插件apk中调用LocalBroadcastManager的地方修改为Replugin中的PluginLocalBroadcastManager调用，动态修改ContentResolver和ContentProviderClient的调用修改成Replugin调用，动态的修改插件工程中所有调用Resource.getIdentifier方法的地方等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* LoaderActivity 替换规则 */</span></span><br><span class="line">def <span class="keyword">private</span> <span class="keyword">static</span> loaderActivityRules = [</span><br><span class="line">        <span class="string">&#x27;android.app.Activity&#x27;</span>                    : <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginActivity&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;android.app.TabActivity&#x27;</span>                 : <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginTabActivity&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;android.app.ListActivity&#x27;</span>                : <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginListActivity&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;android.app.ActivityGroup&#x27;</span>               : <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginActivityGroup&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;android.support.v4.app.FragmentActivity&#x27;</span> : <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginFragmentActivity&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;android.support.v7.app.AppCompatActivity&#x27;</span>: <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginAppCompatActivity&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;android.preference.PreferenceActivity&#x27;</span>   : <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginPreferenceActivity&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;android.app.ExpandableListActivity&#x27;</span>      : <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginExpandableListActivity&#x27;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h2 id="replugin-plugin-library"><a href="#replugin-plugin-library" class="headerlink" title="replugin-plugin-library"></a>replugin-plugin-library</h2><p>对应com.qihoo360.replugin:replugin-plugin-lib:xxx依赖，是一个Java工程，由插件端负责引入，主要提供通过“Java反射”来调用主程序中RePlugin Host Library的相关接口，并提供“双向通信”的能力，以及各种基类Activity等。</p>
<p>其中的RePlugin、RePluginInternal、PluginServiceClient都是反射宿主App：replugin-host-library中的RePlugin、RePluginInternal、PluginServiceClient类方法。</p>
<h1 id="ClassLoader"><a href="#ClassLoader" class="headerlink" title="ClassLoader"></a>ClassLoader</h1><h2 id="RePluginClassLoader"><a href="#RePluginClassLoader" class="headerlink" title="RePluginClassLoader"></a>RePluginClassLoader</h2><p>RePluginClassLoader是宿主的ClassLoader，继承自PathClassLoader，其构造方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ClassLoader mOrig;</span><br><span class="line"><span class="keyword">private</span> Method findResourceMethod;</span><br><span class="line"><span class="keyword">private</span> Method findResourcesMethod;</span><br><span class="line"><span class="keyword">private</span> Method findLibraryMethod;</span><br><span class="line"><span class="keyword">private</span> Method getPackageMethod;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RePluginClassLoader</span><span class="params">(ClassLoader parent, ClassLoader orig)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 由于PathClassLoader在初始化时会做一些Dir的处理，所以这里必须要传一些内容进来</span></span><br><span class="line">    <span class="comment">// 但我们最终不用它，而是拷贝所有的Fields</span></span><br><span class="line">    <span class="keyword">super</span>(<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, parent);</span><br><span class="line">    mOrig = orig;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将原来宿主里的关键字段，拷贝到这个对象上，这样骗系统以为用的还是以前的东西（尤其是DexPathList）</span></span><br><span class="line">    <span class="comment">// 注意，这里用的是“浅拷贝”</span></span><br><span class="line">    copyFromOriginal(orig);</span><br><span class="line">    initMethods(orig);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在构造方法中，将原ClassLoader中的重要变量浅拷贝到RePluginClassLoader中，用于欺骗系统还处于原Loader，并且从原Loader中反射出常用方法，用于重载方法中使用。</p>
<p>RePluginClassLoader的初始化在RePlugin初始化时进行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 对宿主的HostClassLoader做修改。这是RePlugin中唯一需要修改宿主私有属性的位置了</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PatchClassLoaderUtils</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">patch</span><span class="params">(Application application)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取Application的BaseContext （来自ContextWrapper）</span></span><br><span class="line">            Context oBase = application.getBaseContext();</span><br><span class="line">            <span class="keyword">if</span> (oBase == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取mBase.mPackageInfo</span></span><br><span class="line">            <span class="comment">// 1. ApplicationContext - Android 2.1</span></span><br><span class="line">            <span class="comment">// 2. ContextImpl - Android 2.2 and higher</span></span><br><span class="line">            <span class="comment">// 3. AppContextImpl - Android 2.2 and higher</span></span><br><span class="line">            Object oPackageInfo = ReflectUtils.readField(oBase, <span class="string">&quot;mPackageInfo&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (oPackageInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// mPackageInfo的类型主要有两种：</span></span><br><span class="line">            <span class="comment">// 1. android.app.ActivityThread$PackageInfo - Android 2.1 - 2.3</span></span><br><span class="line">            <span class="comment">// 2. android.app.LoadedApk - Android 2.3.3 and higher</span></span><br><span class="line">            <span class="comment">// 获取mPackageInfo.mClassLoader</span></span><br><span class="line">            ClassLoader oClassLoader = (ClassLoader) ReflectUtils.readField(oPackageInfo, <span class="string">&quot;mClassLoader&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (oClassLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 外界可自定义ClassLoader的实现，但一定要基于RePluginClassLoader类</span></span><br><span class="line">            ClassLoader cl = RePlugin.getConfig().getCallbacks().createClassLoader(oClassLoader.getParent(), oClassLoader);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将新的ClassLoader写入mPackageInfo.mClassLoader</span></span><br><span class="line">            ReflectUtils.writeField(oPackageInfo, <span class="string">&quot;mClassLoader&quot;</span>, cl);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 设置线程上下文中的ClassLoader为RePluginClassLoader</span></span><br><span class="line">            <span class="comment">// 防止在个别Java库用到了Thread.currentThread().getContextClassLoader()时，“用了原来的PathClassLoader”，或为空指针</span></span><br><span class="line">            Thread.currentThread().setContextClassLoader(cl);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处patch的原理可以参考<a target="_blank" rel="noopener" href="https://ljd1996.github.io/2019/12/16/Android-Application/">Android Application启动的原理</a>。</p>
<p>RePluginClassLoader中主要是重载了loadClass方法，它首先会尝试从PluginDexClassLoader中加载，加载失败才会使用原ClassLoader加载，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String className, <span class="keyword">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    Class&lt;?&gt; c = <span class="keyword">null</span>;</span><br><span class="line">    c = PMF.loadClass(className, resolve);</span><br><span class="line">    <span class="keyword">if</span> (c != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        c = mOrig.loadClass(className);</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.loadClass(className, resolve);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="PluginDexClassLoader"><a href="#PluginDexClassLoader" class="headerlink" title="PluginDexClassLoader"></a>PluginDexClassLoader</h2><p>PluginDexClassLoader是插件的ClassLoader，继承自DexClassLoader，构造时持有了宿主的ClassLoader，其构造方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ClassLoader mHostClassLoader;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Method sLoadClassMethod;</span><br><span class="line"><span class="keyword">private</span> String mPluginName;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PluginDexClassLoader</span><span class="params">(PluginInfo pi, String dexPath, String optimizedDirectory, String librarySearchPath, ClassLoader parent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(dexPath, optimizedDirectory, librarySearchPath, parent);</span><br><span class="line">    mPluginName = pi.getName();</span><br><span class="line">    installMultiDexesBeforeLollipop(pi, dexPath, parent);</span><br><span class="line">    mHostClassLoader = RePluginInternal.getAppClassLoader();</span><br><span class="line">    initMethods(mHostClassLoader);  <span class="comment">// 通过从宿主ClassLoader中获取loadClass方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其初始化是在调用插件的相关组件时，通过Loader类的loadDex方法实例化的，每一个插件都会有一个PluginDexClassLoader，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">loadDex</span><span class="params">(ClassLoader parent, <span class="keyword">int</span> load)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    mClassLoader = RePlugin.getConfig().getCallbacks().createPluginClassLoader(mPluginObj.mInfo, mPath, out, soDir, parent);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// 缓存表：ClassLoader</span></span><br><span class="line">    <span class="keyword">synchronized</span> (Plugin.FILENAME_2_DEX) &#123;</span><br><span class="line">        Plugin.FILENAME_2_DEX.put(mPath, <span class="keyword">new</span> WeakReference&lt;&gt;(mClassLoader));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    mPkgContext = <span class="keyword">new</span> PluginContext(mContext, android.R.style.Theme, mClassLoader, mPkgResources, mPluginName, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PluginDexClassLoader从宿主ClassLoader中反射获取loadClass方法，当自己的loadClass方法找不到类时，从宿主Loader中加载，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String className, <span class="keyword">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// 插件自己的Class。从自己开始一直到BootClassLoader，采用正常的双亲委派模型流程，读到了就直接返回</span></span><br><span class="line">    Class&lt;?&gt; pc = <span class="keyword">null</span>;</span><br><span class="line">    ClassNotFoundException cnfException = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        pc = <span class="keyword">super</span>.loadClass(className, resolve);</span><br><span class="line">        <span class="keyword">if</span> (pc != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> pc;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        <span class="comment">// Do not throw &quot;e&quot; now</span></span><br><span class="line">        cnfException = e;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (PluginDexClassLoaderPatch.need2LoadFromHost(className)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> loadClassFromHost(className, resolve);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e1) &#123;</span><br><span class="line">                <span class="comment">// Do not throw &quot;e1&quot; now</span></span><br><span class="line">                cnfException = e1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 若插件里没有此类，则会从宿主ClassLoader中找，找到了则直接返回</span></span><br><span class="line">    <span class="comment">// 注意：需要读取isUseHostClassIfNotFound开关。默认为关闭的。可参见该开关的说明</span></span><br><span class="line">    <span class="keyword">if</span> (RePlugin.getConfig().isUseHostClassIfNotFound()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> loadClassFromHost(className, resolve);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">// Do not throw &quot;e&quot; now</span></span><br><span class="line">            cnfException = e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// At this point we can throw the previous exception</span></span><br><span class="line">    <span class="keyword">if</span> (cnfException != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> cnfException;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Class&lt;?&gt; loadClassFromHost(String className, <span class="keyword">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    Class&lt;?&gt; c;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        c = (Class&lt;?&gt;) sLoadClassMethod.invoke(mHostClassLoader, className, resolve);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">        <span class="comment">// Just rethrow</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(<span class="string">&quot;Calling the loadClass method failed (IllegalAccessException)&quot;</span>, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">        <span class="comment">// Just rethrow</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(<span class="string">&quot;Calling the loadClass method failed (InvocationTargetException)&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>关于这种 Hook 系统 ClassLoader 的方式，是否可以修改成给宿主 PathClassLoader 加一个 parent ClassLoader 呢？这样根据 “双亲委派” 的逻辑，加上去的这个 parent ClassLoader 理论上也是能完成 RePlugin 想要做的事。</p>
<h1 id="相关类"><a href="#相关类" class="headerlink" title="相关类"></a>相关类</h1><h2 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h2><ul>
<li>RePlugin：RePlugin的对外入口类，提供install、uninstall、preload、startActivity、fetchPackageInfo、fetchComponentList，fetchClassLoader等等统一的方法入口，用户操作的主要是它。</li>
<li>RePlugin.App：RePlugin中的内部类，针对Application的入口类，所有针对插件Application的调用应从此类开始和初始化。</li>
<li>PMF：框架和主程序接口代码。</li>
<li>PmBase：在RePlugin中常用mPluginMgr变量表示，可以看作插件管理者。初始化插件、加载插件等一般都是从它开始。</li>
<li>PmHostSvc：<code>class PmHostSvc extends IPluginHost.Stub</code>，运行在Persistent进程，其它进程通过Binder与Persistent进程通信。</li>
<li>PluginManagerServer：插件管理器。用来控制插件的安装、卸载、获取等。运行在常驻进程中，其内有一个<code>IPluginManagerServer mStub</code>属性。</li>
<li>PluginContainers：插件容器管理中心。</li>
<li>PluginCommImpl：负责宿主与插件、插件间的互通，可通过插件的Factory直接调用，也可通过RePlugin来跳转，包含各种本地接口实现，如startActivity，getActivityInfo，loadPluginActivity等。</li>
<li>PluginLibraryInternalProxy：内部实现了真正startActivity的逻辑、还有插件Activity生命周期的接口。plugin-library中，通过“反射”调用的内部逻辑，以及host-library中直接调用startActivity等的逻辑实现。</li>
</ul>
<h2 id="PMF-java"><a href="#PMF-java" class="headerlink" title="PMF.java"></a>PMF.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PmBase sPluginMgr</span><br><span class="line">Context sContext</span><br><span class="line">setApplicationContext()</span><br><span class="line">getApplicationContext()</span><br><span class="line">init()</span><br><span class="line">callAppCreate()</span><br><span class="line">callAttach()</span><br><span class="line">addBuiltinModule()</span><br><span class="line">getLocal()</span><br><span class="line">getInternal()</span><br><span class="line">loadClass()</span><br><span class="line">forward()</span><br><span class="line">dump()</span><br><span class="line">stopService()</span><br></pre></td></tr></table></figure>

<h2 id="PmBase-java"><a href="#PmBase-java" class="headerlink" title="PmBase.java"></a>PmBase.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PmBase</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Context mContext;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;String&gt; mContainerActivities = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;String&gt; mContainerProviders = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;String&gt; mContainerServices = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br><span class="line">    <span class="keyword">private</span> ClassLoader mClassLoader;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 所有插件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Plugin&gt; mPlugins = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 动态的类查找表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String, DynamicClass&gt; mDynamicClasses = <span class="keyword">new</span> HashMap&lt;String, DynamicClass&gt;();</span><br><span class="line">    <span class="keyword">private</span> String mDefaultPluginName;</span><br><span class="line">    <span class="keyword">private</span> Plugin mDefaultPlugin;</span><br><span class="line">    <span class="keyword">private</span> PmHostSvc mHostSvc;</span><br><span class="line">    PluginProcessPer mClient;</span><br><span class="line">    PluginCommImpl mLocal;</span><br><span class="line">    PluginLibraryInternalProxy mInternal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="PmHostSvc-java"><a href="#PmHostSvc-java" class="headerlink" title="PmHostSvc.java"></a>PmHostSvc.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PmHostSvc</span> <span class="keyword">extends</span> <span class="title">IPluginHost</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    Context mContext;</span><br><span class="line">    PmBase mPluginMgr;</span><br><span class="line">    PluginServiceServer mServiceMgr;</span><br><span class="line">    PluginManagerServer mManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mNeedRestart;</span><br><span class="line">    PluginReceiverProxy mReceiverProxy;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IPluginManagerServer <span class="title">fetchManagerServer</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mManager.getService();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="IPluginHost-aidl"><a href="#IPluginHost-aidl" class="headerlink" title="IPluginHost.aidl"></a>IPluginHost.aidl</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IPluginHost</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">installBinder</span><span class="params">(String name, in IBinder binder)</span></span>;</span><br><span class="line">    <span class="function">IBinder <span class="title">fetchBinder</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">fetchPersistentCookie</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">IPluginClient <span class="title">startPluginProcess</span><span class="params">(String plugin, <span class="keyword">int</span> process, inout PluginBinderInfo info)</span></span>;</span><br><span class="line">    <span class="function">String <span class="title">attachPluginProcess</span><span class="params">(String process, <span class="keyword">int</span> index, in IBinder binder, String def)</span></span>;</span><br><span class="line">    <span class="function">List&lt;PluginInfo&gt; <span class="title">listPlugins</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">regActivity</span><span class="params">(<span class="keyword">int</span> index, String plugin, String container, String activity)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unregActivity</span><span class="params">(<span class="keyword">int</span> index, String plugin, String container, String activity)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">regService</span><span class="params">(<span class="keyword">int</span> index, String plugin, String service)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unregService</span><span class="params">(<span class="keyword">int</span> index, String plugin, String service)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">regPluginBinder</span><span class="params">(in PluginBinderInfo info, IBinder binder)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unregPluginBinder</span><span class="params">(in PluginBinderInfo info, IBinder binder)</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 注册某插件下所有静态声明的的 receiver 到常驻进程</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">regReceiver</span><span class="params">(String plugin, in Map receiverFilterMap)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unregReceiver</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插件收到广播</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> plugin 插件名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> receiver Receiver 名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Intent 广播的 Intent 数据</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(String plugin, String receiver, in Intent intent)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">sumBinders</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updatePluginInfo</span><span class="params">(in PluginInfo info)</span></span>;</span><br><span class="line">    <span class="function">PluginInfo <span class="title">pluginDownloaded</span><span class="params">(String path)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">pluginUninstalled</span><span class="params">(in PluginInfo info)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">pluginExtracted</span><span class="params">(String path)</span></span>;</span><br><span class="line">    <span class="function">oneway <span class="keyword">void</span> <span class="title">sendIntent2Process</span><span class="params">(String target, in Intent intent)</span></span>;</span><br><span class="line">    <span class="function">oneway <span class="keyword">void</span> <span class="title">sendIntent2Plugin</span><span class="params">(String target, in Intent intent)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendIntent2ProcessSync</span><span class="params">(String target, in Intent intent)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendIntent2PluginSync</span><span class="params">(String target, in Intent intent)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isProcessAlive</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="function">IBinder <span class="title">queryPluginBinder</span><span class="params">(String plugin, String binder)</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据 Inent 查询所有插件中的与之匹配的 Receivers</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List <span class="title">queryPluginsReceiverList</span><span class="params">(in Intent intent)</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取“全新Service管理方案”在Server端的服务</span></span><br><span class="line"><span class="comment">     * Added by Jiongxuan Zhang</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">IPluginServiceServer <span class="title">fetchServiceServer</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取 IPluginManagerServer（纯APK方案使用）的插件服务</span></span><br><span class="line"><span class="comment">     * Added by Jiongxuan Zhang</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">IPluginManagerServer <span class="title">fetchManagerServer</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据 taskAffinity，判断应该取第几组 TaskAffinity</span></span><br><span class="line"><span class="comment">     * 由于 taskAffinity 是跨进程的属性，所以这里要将 taskAffinityGroup 的数据保存在常驻进程中</span></span><br><span class="line"><span class="comment">     * Added by hujunjie</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getTaskAffinityGroupIndex</span><span class="params">(String taskAffinity)</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过进程名来获取PID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getPidByProcessName</span><span class="params">(String processName)</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过PID来获取进程名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">getProcessNameByPid</span><span class="params">(<span class="keyword">int</span> pid)</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * dump详细的运行时信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">dump</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="IPluginManagerServer-aidl"><a href="#IPluginManagerServer-aidl" class="headerlink" title="IPluginManagerServer.aidl"></a>IPluginManagerServer.aidl</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IPluginManagerServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 安装一个插件</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 注意：若为旧插件（p-n开头），则应使用IPluginHost的pluginDownloaded方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 安装的插件的PluginInfo对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">PluginInfo <span class="title">install</span><span class="params">(String path)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 卸载一个插件</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 注意：只针对“纯APK”插件方案</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> info 插件信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否成功卸载插件？</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">uninstall</span><span class="params">(in PluginInfo info)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加载插件列表，方便之后使用</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * TODO 这里只返回&quot;新版插件&quot;，供PmBase使用。将来会合并</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> PluginInfo的列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;PluginInfo&gt; <span class="title">load</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新所有插件列表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> PluginInfo的列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;PluginInfo&gt; <span class="title">updateAll</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置isUsed状态，并通知所有进程更新</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pluginName 插件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> used 是否已经使用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateUsed</span><span class="params">(String pluginName, <span class="keyword">boolean</span> used)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取正在运行的插件列表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 正在运行的插件名列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">PluginRunningList <span class="title">getRunningPlugins</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 插件是否正在运行？</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pluginName 插件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> process 指定进程名，如为Null则表示查所有</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否在运行？</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isPluginRunning</span><span class="params">(String pluginName, String process)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当进程启动时，同步正在运行的插件状态到Server端</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> list         正在运行的插件名列表</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">syncRunningPlugins</span><span class="params">(in PluginRunningList list)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当进程启动时，同步正在运行的插件状态到Server端</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> processName  进程名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pluginName   正在运行的插件名</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addToRunningPlugins</span><span class="params">(String processName, <span class="keyword">int</span> pid, String pluginName)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取正在运行此插件的进程名列表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pluginName 要查询的插件名</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 正在运行此插件的进程名列表。一定不会为Null</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    String[] getRunningProcessesByPlugin(String pluginName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="PluginManagerServer-java"><a href="#PluginManagerServer-java" class="headerlink" title="PluginManagerServer.java"></a>PluginManagerServer.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 插件管理器。用来控制插件的安装、卸载、获取等。运行在常驻进程中 &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 补充：涉及到插件交互、运行机制有关的管理器，在IPluginHost中 &lt;p&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginManagerServer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> IPluginManagerServer mStub;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PluginManagerServer</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">        mStub = <span class="keyword">new</span> Stub();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IPluginManagerServer <span class="title">getService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mStub;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> PluginInfo <span class="title">installLocked</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;PluginInfo&gt; <span class="title">loadLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">IPluginManagerServer</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> PluginInfo <span class="title">install</span><span class="params">(String path)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (LOCKER) &#123;</span><br><span class="line">                <span class="keyword">return</span> PluginManagerServer.<span class="keyword">this</span>.installLocked(path);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;PluginInfo&gt; <span class="title">load</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (LOCKER) &#123;</span><br><span class="line">                <span class="keyword">return</span> PluginManagerServer.<span class="keyword">this</span>.loadLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="PluginManagerProxy-java"><a href="#PluginManagerProxy-java" class="headerlink" title="PluginManagerProxy.java"></a>PluginManagerProxy.java</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用于各进程（包括常驻自己）缓存 PluginManagerServer 的Binder实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginManagerProxy</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IPluginManagerServer sRemote;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 连接到常驻进程，并缓存IPluginManagerServer对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">connectToServer</span><span class="params">(IPluginHost host)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sRemote != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        sRemote = host.fetchManagerServer();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="相关概念"><a href="#相关概念" class="headerlink" title="相关概念"></a>相关概念</h1><h2 id="唯一Hook"><a href="#唯一Hook" class="headerlink" title="唯一Hook"></a>唯一Hook</h2><p>在应用启动的时候，Replugin使用RepluginClassLoader将系统的PathClassLoader替换掉，并且只篡改了loadClass方法的行为，用于加载插件的类。每一个插件都会有一个PluginDexClassLoader，RepluginClassLoader会调用插件的PluginDexClassLoader来加载插件中的类与资源。</p>
<h2 id="UI-Persistent进程"><a href="#UI-Persistent进程" class="headerlink" title="UI/Persistent进程"></a>UI/Persistent进程</h2><p>Replugin启动时会默认启动两个进程，一个是UI进程，一个是Persistent进程(常驻进程)，在IPluginManager接口中定义了两个常量PROCESS_UI和PROCESS_PERSIST来表示这两个进程。</p>
<p>Replugin默认会使用常驻进程作为Server端，其他插件进程和宿主进程全部属于Client端。当然如果修改不使用常驻进程，那么宿主的主进程将作为插件管理进程，而不管是使用宿主进程还是使用默认的常驻进程，Server端其实就是创建了一个运行在该进程中的Provider，通过Provider的query方法返回了Binder对象来实现多进程直接的的沟通和数据共享，或者说是插件之间和宿主之间沟通和数据共享，插件的安装，卸载，更新，状态判断等全部都在这个Server端完成。</p>
<ul>
<li>UI进程就是程序的主进程。</li>
<li>Persistent进程是一个服务器进程，默认用<code>:GuardService</code>来标识。所有其他的进程在启动组件的时候都会通过PmHostSvc与这个进程通信，以下是Persistent进程中运行的两个重要服务:<ul>
<li>PluginManagerServer 用于插件的管理，比如加载插件，更新插件信息，签名验证，版本检查，插件卸载等</li>
<li>PluginServiceServer 用于Service的启动调度等工作</li>
</ul>
</li>
</ul>
<h2 id="坑位"><a href="#坑位" class="headerlink" title="坑位"></a>坑位</h2><p>坑位的作用需要与RepluginClassLoader配合实现，所谓坑位就是预先在Host的Manifest中注册的一些组件（Activity, Service, Content Provider，没有Broadcast Receiver)，这些坑位组件的代码都是由gradle插件在编译时生成的。</p>
<p>在启动插件的组件时，会用这些坑位去替代要启动的组件，并且会建立一个坑位与真实组件之间的对应关系（用ActivityState表示)，然后在加载类的时候RepluginClassLoader会根据前文提到的被篡改过的行为偷偷使用插件的PluginDexClassLoader加载要启动的真实组件类，骗过了系统，这就是唯一hook点的作用。​</p>
<h1 id="RePlugin初始化"><a href="#RePlugin初始化" class="headerlink" title="RePlugin初始化"></a>RePlugin初始化</h1><p>Host在启动的时候会先进行UI进程的初始化工作，但在进行到中途的时候会巧妙的将Persistent进程启动起来，以提供服务，不然UI进程将无法正常启动起来，因为有很多东西是运行在Persistent进程的。</p>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><p>入口位置在RePluginApplication#attachBaseContext()，接着调用了RePlugin.App.attachBaseContext()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RePlugin.App.class</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Application app, RePluginConfig config)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sAttached) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 缓存Application</span></span><br><span class="line">    RePluginInternal.init(app);</span><br><span class="line">    sConfig = config;</span><br><span class="line">    <span class="comment">// 1.获取pn插件安装目录，即context.getFilesDir()</span></span><br><span class="line">    <span class="comment">// 2.判断如果RePluginCallbacks为空创建一个</span></span><br><span class="line">    <span class="comment">// 3.判断RePluginEventCallbacks为空创建一个</span></span><br><span class="line">    sConfig.initDefaults(app);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化进程间通信辅助类，因为不同进程的创建会使attachBaseContext方法走多次，</span></span><br><span class="line">    <span class="comment">// IPC.init中会标记当前进程类型，将会影响下面的代码在不同进程中的逻辑</span></span><br><span class="line">    IPC.init(app);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化HostConfigHelper（通过反射HostConfig来实现），一定要在IPC类初始化之后才使用</span></span><br><span class="line">    HostConfigHelper.init();</span><br><span class="line"></span><br><span class="line">    AppVar.sAppContext = app;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// PluginStatusController用来管理插件的运行状态：正常运行、被禁用等情况</span></span><br><span class="line">    PluginStatusController.setAppContext(app);</span><br><span class="line"></span><br><span class="line">    PMF.init(app);  <span class="comment">// 初始化当前进程，初始化PmBase以及Hook系统的PathClassLoader</span></span><br><span class="line">    PMF.callAttach();   <span class="comment">// 将插件与当前进程关联，如果是在单独的进程中运行插件，则会加载并运行插件</span></span><br><span class="line"></span><br><span class="line">    sAttached = <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>IPC.init方法主要就是通过proc文件获取当前进程名、进程id和宿主包名，然后设置常驻进程的名称，最后标记当前进程是否是ui进程和是不是常驻进程，源码在<code>进程管理</code>部分会给出。</p>
<p>PMF.init(app)方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Application application)</span> </span>&#123;</span><br><span class="line">    setApplicationContext(application); <span class="comment">// 保持对Application的引用</span></span><br><span class="line"></span><br><span class="line">    PluginManager.init(application);</span><br><span class="line"></span><br><span class="line">    sPluginMgr = <span class="keyword">new</span> PmBase(application);</span><br><span class="line">    sPluginMgr.init();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在上面已经解析过了，此处是Hook系统的PathClassLoader</span></span><br><span class="line">    PatchClassLoaderUtils.patch(application);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>PluginManager.init</code>方法会获取当前进程的index，这个index是RePlugin自定义的，其取值在下面会讲到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 初始化操作，方便后面执行任务，不必担心Handler为空的情况</span></span><br><span class="line">    Tasks.init();</span><br><span class="line">    sUid = android.os.Process.myUid();</span><br><span class="line">    sPluginProcessIndex = evalPluginProcess(IPC.getCurrentProcessName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PmBase和它内部引用的其他对象掌握了Replugin中很多重要的功能，例如：分配坑位、初始化插件信息、Clent端连接Server端、加载插件、更新插件、删除插件、等等。其构造方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">PmBase(Context context) &#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    <span class="comment">// isPluginProcess方法参考进程管理部分</span></span><br><span class="line">    <span class="keyword">if</span> (PluginManager.sPluginProcessIndex == IPluginManager.PROCESS_UI || PluginManager.isPluginProcess()) &#123;</span><br><span class="line">        String suffix;</span><br><span class="line">        <span class="comment">// 如果是ui进程，设置suffix = N1</span></span><br><span class="line">        <span class="keyword">if</span> (PluginManager.sPluginProcessIndex == IPluginManager.PROCESS_UI) &#123;</span><br><span class="line">            suffix = <span class="string">&quot;N1&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 后缀值0或1</span></span><br><span class="line">            suffix = <span class="string">&quot;&quot;</span> + PluginManager.sPluginProcessIndex;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// HashSet&lt;String&gt; mContainerProviders;</span></span><br><span class="line">        <span class="comment">// CONTAINER_PROVIDER_PART = .loader.p.Provider</span></span><br><span class="line">        <span class="comment">// 结果 = 包名.loader.p.ProviderN1 或者 包名.loader.p.Provider0 或者 包名.loader.p.Provider1</span></span><br><span class="line">        mContainerProviders.add(IPC.getPackageName() + CONTAINER_PROVIDER_PART + suffix);</span><br><span class="line">        <span class="comment">// 结果 = 包名.loader.s.ServiceN1 或者 包名.loader.s.Service0 或者包名.loader.s.Service1</span></span><br><span class="line">        mContainerServices.add(IPC.getPackageName() + CONTAINER_SERVICE_PART + suffix);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建了PluginProcessPer类，代表了当前Clent进程</span></span><br><span class="line">    mClient = <span class="keyword">new</span> PluginProcessPer(context, <span class="keyword">this</span>, PluginManager.sPluginProcessIndex, mContainerActivities);</span><br><span class="line">    <span class="comment">// 创建了PluginCommImpl类，负责宿主与插件、插件间的互通，可通过插件的Factory直接调用，也可通过RePlugin来跳转</span></span><br><span class="line">    mLocal = <span class="keyword">new</span> PluginCommImpl(context, <span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">// Replugin框架中内部逻辑使用的很多方法都在这里，包括插件中通过“反射”调用的内部逻辑</span></span><br><span class="line">    mInternal = <span class="keyword">new</span> PluginLibraryInternalProxy(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PmBase的构造主要做了4件事件：</p>
<ul>
<li>根据当前进程类型，拼接坑位provider和Service所对应名称并存入不同的HashSet中，PmBase类中处理保存了Provider、Service、Activitiy的坑位信息，这些名字全部都是Replugin在编译的时候在AndroidManifest.xml中声明的坑位名字：mContainerActivities，mContainerProviders，mContainerServices。</li>
<li>创建了一个叫PluginProcessPer的类，它是一个Binder对象，它代表了“当前Clent端”，使用它来和Server端进行通信，这个类的构造中有两个类，一个是PluginContainers，用来管理Activity坑位信息的容器，初始化了多种不同启动模式和样式Activity的坑位信息。另一个PluginServiceServer类，这个类是Replugin中的一个核心类，主要负责了对Service的提供和调度工作，例如startService、stopService、bindService、unbindService全部都由这个类管理。</li>
<li>创建了一个叫PluginCommImpl的类,负责宿主与插件、插件间的互通，很多对提供方法都经过这里中转或者最终调到这里。</li>
<li>创建了一个PluginLibraryInternalProxy类，Replugin框架中内部逻辑使用的很多方法都在这里，包括插件中通过“反射”调用的内部逻辑如PluginActivity类的调用、Factory2等。</li>
</ul>
<p>PmBase.init()方法会根据不同进程进行不同的操作，其逻辑如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (HostConfigHelper.PERSISTENT_ENABLE) &#123;</span><br><span class="line">        <span class="comment">// （默认）“常驻进程”作为插件管理进程，则常驻进程作为Server，其余进程作为Client</span></span><br><span class="line">        <span class="keyword">if</span> (IPC.isPersistentProcess()) &#123;</span><br><span class="line">            <span class="comment">// 初始化“Server”所做工作</span></span><br><span class="line">            initForServer();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 连接到Server</span></span><br><span class="line">            initForClient();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// “UI进程”作为插件管理进程（唯一进程），则UI进程既可以作为Server也可以作为Client</span></span><br><span class="line">        <span class="keyword">if</span> (IPC.isUIProcess()) &#123;</span><br><span class="line">            <span class="comment">// 1. 尝试初始化Server所做工作，</span></span><br><span class="line">            initForServer();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 注册该进程信息到“插件管理进程”中</span></span><br><span class="line">            <span class="comment">// 注意：这里无需再做 initForClient，因为不需要再走一次Binder</span></span><br><span class="line">            PMF.sPluginMgr.attach();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 其它进程？直接连接到Server即可</span></span><br><span class="line">            initForClient();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 从mPlugins中将所有插件信息取出，保存到PLUGINS中，PLUGINS是一个HashMap，保存的key是包名或者别名，value是PluginInfo</span></span><br><span class="line">    PluginTable.initPlugins(mPlugins);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Persistent进程启动"><a href="#Persistent进程启动" class="headerlink" title="Persistent进程启动"></a>Persistent进程启动</h2><h3 id="initForServer"><a href="#initForServer" class="headerlink" title="initForServer"></a>initForServer</h3><p>在UI进程启动流程中，可以看到如果是Persistent进程，则走如下逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">initForServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 继承于IPluginHost.Stub，是一个Binder对象</span></span><br><span class="line">    <span class="comment">// 这个类可以理解成是我们的Server端，它直接或间接参与了Server端要做的所有事情</span></span><br><span class="line">    mHostSvc = <span class="keyword">new</span> PmHostSvc(mContext, <span class="keyword">this</span>);</span><br><span class="line">    PluginProcessMain.installHost(mHostSvc);</span><br><span class="line">    StubProcessManager.schedulePluginProcessLoop(StubProcessManager.CHECK_STAGE1_DELAY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 兼容即将废弃的p-n方案</span></span><br><span class="line">    mAll = <span class="keyword">new</span> Builder.PxAll();</span><br><span class="line">    <span class="comment">// 搜索所有本地插件和V5插件信息，并添加进Builder集合中就是mAll字段，然后删除一些不符合规则的插件信息</span></span><br><span class="line">    <span class="comment">// 这里搜索了所以本地插件，也就是放在assest中的插件，是通过插件自动生成的json文件来扫描的</span></span><br><span class="line">    <span class="comment">// v5是通过context.getDir路径来扫描的</span></span><br><span class="line">    Builder.builder(mContext, mAll);</span><br><span class="line">    <span class="comment">// 将刚扫描的本地插件封装成Plugin添加进mPlugins中，mPlugins代表所有插件的集合</span></span><br><span class="line">    refreshPluginMap(mAll.getPlugins());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        List&lt;PluginInfo&gt; l = PluginManagerProxy.load();</span><br><span class="line">        <span class="keyword">if</span> (l != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 将&quot;纯APK&quot;插件信息并入总的插件信息表中，方便查询</span></span><br><span class="line">            refreshPluginMap(l);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PmHostSvc的构造方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PmHostSvc</span> <span class="keyword">extends</span> <span class="title">IPluginHost</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    PmHostSvc(Context context, PmBase packm) &#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">        mPluginMgr = packm;</span><br><span class="line">        mServiceMgr = <span class="keyword">new</span> PluginServiceServer(context);</span><br><span class="line">        mManager = <span class="keyword">new</span> PluginManagerServer(context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PluginProcessMain-installHost"><a href="#PluginProcessMain-installHost" class="headerlink" title="PluginProcessMain.installHost"></a>PluginProcessMain.installHost</h3><p>在Persistent进程中会通过PluginProcessMain.installHost(mHostSvc)连接到IPluginManagerServer，但因为IPluginManagerServer就运行在当前进程，因此这里不会进行Binder通信，而是直接调用PmHostSvc端fetchManagerServer方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> IPluginHost sPluginHostLocal;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">installHost</span><span class="params">(IPluginHost host)</span> </span>&#123;</span><br><span class="line">    sPluginHostLocal = host;</span><br><span class="line">    <span class="comment">// 连接到插件化管理器的服务端</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        PluginManagerProxy.connectToServer(sPluginHostLocal);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">connectToServer</span><span class="params">(IPluginHost host)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sRemote != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// IPluginManagerServer sRemote</span></span><br><span class="line">    sRemote = host.fetchManagerServer();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 上面的host是PmHostSvc对象，继承自IPluginHost.Stub，IPluginHost是一个AIDL文件</span></span><br><span class="line"><span class="comment">// 可以看到PmHostSvc中的fetchManagerServer方法</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IPluginManagerServer <span class="title">fetchManagerServer</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="comment">// mManager = new PluginManagerServer(context);</span></span><br><span class="line">    <span class="keyword">return</span> mManager.getService();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来看看PluginManagerServer#getService方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//PluginManagerServer类</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginManagerServer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> IPluginManagerServer mStub;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PluginManagerServer</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        mContext = context;</span><br><span class="line">        mStub = <span class="keyword">new</span> Stub();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IPluginManagerServer <span class="title">getService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mStub;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//内部类Stub继承自IPluginManagerServer.Stub</span></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">IPluginManagerServer</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出IPluginManagerServer也是一个AIDL文件，内部有许多操作插件的方法，例如安装，卸载插件等，也就是说关于插件的所有操作都在Server端吧。</p>
<h3 id="PluginManagerProxy-load"><a href="#PluginManagerProxy-load" class="headerlink" title="PluginManagerProxy.load"></a>PluginManagerProxy.load</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginManagerProxy</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IPluginManagerServer sRemote;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;PluginInfo&gt; <span class="title">load</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="comment">// 不判断sRemote在不在，因为本应该在sRemote获取后就马上调用</span></span><br><span class="line">        <span class="keyword">return</span> sRemote.load();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginManagerServer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> PluginInfoList mList = <span class="keyword">new</span> PluginInfoList();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;PluginInfo&gt; <span class="title">loadLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!mList.load(mContext)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行“更新或删除Pending”插件，并返回结果</span></span><br><span class="line">        <span class="keyword">return</span> updateAllLocked();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;PluginInfo&gt; <span class="title">updateAllLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 判断是否需要更新插件（只有未运行的才可以）</span></span><br><span class="line">        updateAllIfNeeded();</span><br><span class="line">        <span class="keyword">return</span> mList.cloneList();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateAllIfNeeded</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> updateNum = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (PluginInfo pi : mList) &#123;</span><br><span class="line">            <span class="keyword">if</span> (updateIfNeeded(pi)) &#123;</span><br><span class="line">                updateNum++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (updateNum &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            mList.save(mContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">updateIfNeeded</span><span class="params">(PluginInfo curInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isPluginRunningLocked(curInfo.getName(), <span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="comment">// 插件正在被使用，不能贸然升级或者卸载</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 更新插件前，首先判断该插件是否需要卸载，若是则直接删除，不再做更新操作</span></span><br><span class="line">        <span class="keyword">if</span> (curInfo.isNeedUninstall()) &#123;</span><br><span class="line">            <span class="comment">// 移除插件及其已释放的Dex、Native库等文件并向各进程发送广播，同步更新</span></span><br><span class="line">            <span class="keyword">return</span> uninstallNow(curInfo.getPendingDelete());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (curInfo.isNeedUpdate()) &#123;</span><br><span class="line">            <span class="comment">// 需要更新插件？那就直接来</span></span><br><span class="line">            updateNow(curInfo, curInfo.getPendingUpdate());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (curInfo.isNeedCover()) &#123;</span><br><span class="line">            updateNow(curInfo, curInfo.getPendingCover());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 既不需要删除也不需要更新</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateNow</span><span class="params">(PluginInfo curInfo, PluginInfo newInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> covered = newInfo.getIsPendingCover();</span><br><span class="line">        <span class="keyword">if</span> (covered) &#123;</span><br><span class="line">            move(curInfo, newInfo);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 删除旧版本插件，不管是不是p-n的，且清掉Dex和Native目录</span></span><br><span class="line">            delete(curInfo);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        newInfo.setType(PluginInfo.TYPE_EXTRACTED);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (covered) &#123;</span><br><span class="line">            curInfo.setPendingCover(<span class="keyword">null</span>);</span><br><span class="line">            newInfo.setIsPendingCover(<span class="keyword">false</span>);</span><br><span class="line">            <span class="comment">//修改isPendingCover属性后必须同时修改json中的path路径</span></span><br><span class="line">            newInfo.setPath(newInfo.getApkFile().getPath());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            curInfo.update(newInfo);</span><br><span class="line">            curInfo.setPendingUpdate(<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">IPluginManagerServer</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;PluginInfo&gt; <span class="title">load</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (LOCKER) &#123;</span><br><span class="line">                <span class="keyword">return</span> PluginManagerServer.<span class="keyword">this</span>.loadLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>顺着PluginManagerProxy.load()跟踪下去，最后真正做加载工作的是PluginInfoList.load()函数（只是加载插件信息）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginInfoList</span> <span class="keyword">implements</span> <span class="title">Iterable</span>&lt;<span class="title">PluginInfo</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> File <span class="title">getFile</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// public static final String LOCAL_PLUGIN_APK_SUB_DIR = &quot;p_a&quot;;</span></span><br><span class="line">        <span class="keyword">final</span> File d = context.getDir(Constant.LOCAL_PLUGIN_APK_SUB_DIR, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> File(d, <span class="string">&quot;p.l&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">load</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 读出字符串</span></span><br><span class="line">            <span class="keyword">final</span> File f = getFile(context);</span><br><span class="line">            <span class="comment">// 从配置文件中读取插件信息，插件信息以JSON格式保存在这个文件中</span></span><br><span class="line">            <span class="keyword">final</span> String result = FileUtils.readFileToString(f, Charsets.UTF_8);</span><br><span class="line">            <span class="keyword">if</span> (TextUtils.isEmpty(result)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 解析出JSON</span></span><br><span class="line">            <span class="keyword">final</span> JSONArray jArr = <span class="keyword">new</span> JSONArray(result);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; jArr.length(); i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> JSONObject jo = jArr.optJSONObject(i);</span><br><span class="line">                <span class="keyword">final</span> PluginInfo pi = PluginInfo.createByJO(jo);</span><br><span class="line">                <span class="keyword">if</span> (pi == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                addToMap(pi);   <span class="comment">// 保存插件信息</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JSONException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><p>initForServer()方法的作用：</p>
<ol>
<li>首先创建了一个PmHostSvc对象，这个类继承自IPluginHost.Stub，是一个IPluginHost类型的Binder对象，可以说所有的插件的管理工作都是直接或者间接由它处理的，PmHostSvc代表了Server端要处理的事情，也就是插件管理进程处理的事情。</li>
<li>在PmHostSvc的构造方法中又创建了两个对象，一个是PluginServiceServer，这个类是用来管理插件Service的远程Server端，还有一个是PluginManagerServer，这个类在创建的时候在构造中又创建了一个继承自IPluginServiceServer.Stub的Stub对象，Stub也是一个Binder对象，这个类掌管了所有对插件的的操作，例如插件的安装、加载、卸载、更新等等。</li>
<li>调用PluginProcessMain.installHost(mHostSvc)方法将PmHostSvc对象也就是IPluginHost类型赋值给PluginProcessMain中的字段sPluginHostLocal。接着调用了IPluginHost.fetchManagerServer()方法将PluginManagerServer中的Stub对象，也就是IPluginServiceServer类型的Binder对象赋值给PluginManagerProxy类中的字段sRemote，这个IPluginServiceServer类型的Binder对象掌握了对插件的安装、卸载、更新等等的操作。</li>
<li>PluginManagerProxy.load()则用来更新插件信息。</li>
</ol>
<h2 id="UI进程启动"><a href="#UI进程启动" class="headerlink" title="UI进程启动"></a>UI进程启动</h2><h3 id="initForClient"><a href="#initForClient" class="headerlink" title="initForClient"></a>initForClient</h3><p>Client(UI进程)的初始化如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">initForClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 先尝试连接</span></span><br><span class="line">    PluginProcessMain.connectToHostSvc();</span><br><span class="line">    <span class="comment">// 2. 从常驻进程获取插件列表，判断列表中是否有需要更新的插件，</span></span><br><span class="line">    <span class="comment">// 如果有则调用Binder对象在Server端更新插件信息</span></span><br><span class="line">    refreshPluginsFromHostSvc();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PluginProcessMain-connectToHostSvc"><a href="#PluginProcessMain-connectToHostSvc" class="headerlink" title="PluginProcessMain.connectToHostSvc"></a>PluginProcessMain.connectToHostSvc</h3><p>非常驻进程调用connectToHostSvc方法，获取常驻进程的IPluginHost：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> IPluginHost sPluginHostRemote;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">connectToHostSvc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Context context = PMF.getApplicationContext();</span><br><span class="line">    <span class="comment">// 通过判断是哪个进程然后进行远程调用返回Binder，其实返回的就是PmHostSvc对象</span></span><br><span class="line">    IBinder binder = PluginProviderStub.proxyFetchHostBinder(context);</span><br><span class="line">    <span class="keyword">if</span> (binder == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 无法连接到常驻进程，当前进程自杀</span></span><br><span class="line">        System.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        binder.linkToDeath(<span class="keyword">new</span> IBinder.DeathRecipient() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binderDied</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">// 检测到常驻进程退出，插件进程自杀</span></span><br><span class="line">                <span class="keyword">if</span> (PluginManager.isPluginProcess()) &#123;</span><br><span class="line">                    System.exit(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                sPluginHostRemote = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 断开和插件化管理器服务端的连接，因为已经失效</span></span><br><span class="line">                PluginManagerProxy.disconnect();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">0</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="comment">// 无法连接到常驻进程，当前进程自杀</span></span><br><span class="line">        System.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sPluginHostRemote = IPluginHost.Stub.asInterface(binder);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接到插件化管理器的服务端</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        PluginManagerProxy.connectToServer(sPluginHostRemote);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将当前进程的&quot;正在运行&quot;列表和常驻做同步</span></span><br><span class="line">        <span class="comment">// TODO 若常驻进程重启，则应在启动时发送广播，各存活着的进程调用该方法来同步</span></span><br><span class="line">        PluginManagerProxy.syncRunningPlugins();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        <span class="comment">// 获取PluginManagerServer时出现问题，可能常驻进程突然挂掉等，当前进程自杀</span></span><br><span class="line">        System.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注册该进程信息到“插件管理进程”中</span></span><br><span class="line">    PMF.sPluginMgr.attach();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> IBinder <span class="title">proxyFetchHostBinder</span><span class="params">(Context context, String selection)</span> </span>&#123;</span><br><span class="line">    Cursor cursor = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Uri uri = ProcessPitProviderPersist.URI;</span><br><span class="line">        cursor = context.getContentResolver().query(uri, PROJECTION_MAIN, selection, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (cursor == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (cursor.moveToNext()) &#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">        &#125;</span><br><span class="line">        IBinder binder = BinderCursor.getBinder(cursor);</span><br><span class="line">        <span class="keyword">return</span> binder;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        CloseableUtils.closeQuietly(cursor);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当前进程尝试通过ContentResolver去访问ProcessPitProviderPersist以获取一个与Persistent进程通信的IBinder对象，但是ProcessPitProviderPersist在第一次被访问时并没有运行起来，于是Android系统会自动启动它。ProcessPitProviderPersist在Manifest中的注册代码：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;com.qihoo360.replugin.component.process.ProcessPitProviderPersist&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:authorities</span>=<span class="string">&quot;$&#123;applicationId&#125;.loader.p.main&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:process</span>=<span class="string">&quot;:GuardService&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>于是Android系统立即通过ActivityManagerService向Zygote进程请求folk一个新的进程，ProcessPitProviderPersist就运行在这个进程中，这个进程就是Persistent进程了。</p>
<ol>
<li>默认情况下，GuardService会被当作Persistent进程的名字，在IPC.init()函数中会用这个名字来判断当前进程是不是Persistent进程。</li>
<li>有很多坑位组件使用android:process=”:GuardService”属性，因此如果Persistent进程不小心被杀掉了，在任何需要启动这些坑位组件的地方都会将Persistent进程重新启动起来。</li>
<li>系统在启动新进程的时候，会在新进程中执行RepluginApplication的初始化，所以以上提到的流程都会在这个进程中执行一遍，但是因为在PmBase.init()函数中有一个条件判断IPC.isPersistentProcess()，Persistent进程会执行和UI进程不同的代码路径。</li>
</ol>
<h3 id="refreshPluginsFromHostSvc"><a href="#refreshPluginsFromHostSvc" class="headerlink" title="refreshPluginsFromHostSvc"></a>refreshPluginsFromHostSvc</h3><p>refreshPluginsFromHostSvc方法从HostSvc（插件管理所在进程）获取所有的插件信息，这些信息是在Persistent进程的启动流程中被加载的，接着会判断是否有更新，如果有插件已经更新了，会通过远程调用让PluginManagerServer重新加载插件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refreshPluginsFromHostSvc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;PluginInfo&gt; plugins = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        plugins = PluginProcessMain.getPluginHost().listPlugins();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断是否有需要更新的插件</span></span><br><span class="line">    List&lt;PluginInfo&gt; updatedPlugins = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (isNeedToUpdate(plugins)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            updatedPlugins = PluginManagerProxy.updateAllPlugins();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (updatedPlugins != <span class="keyword">null</span>) &#123;</span><br><span class="line">        refreshPluginMap(updatedPlugins);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        refreshPluginMap(plugins);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> IPluginHost <span class="title">getPluginHost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sPluginHostLocal != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> sPluginHostLocal;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 可能是第一次，或者常驻进程退出了</span></span><br><span class="line">    <span class="keyword">if</span> (sPluginHostRemote == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (IPC.isPersistentProcess()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;插件框架未正常初始化&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 再次唤起常驻进程</span></span><br><span class="line">        connectToHostSvc();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sPluginHostRemote;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h3><p>initForClient()方法的作用：</p>
<ul>
<li>通过Provider的方式请求插件管理进程返回PmHostSvc这个Binder对象，接着通过PmHostSvc再得到PluginManagerServer这个Binder对象并把当前进程信息注册到Server端，最后通过得到的Binder对象来同步进程信息和更新插件信息。</li>
</ul>
<h2 id="callAttach"><a href="#callAttach" class="headerlink" title="callAttach"></a>callAttach</h2><p>PMF.callAttach()其实就是调用PmBase.callAttach()，首先将插件与当前进程关联起来，主要是将RepluginClassLoader和PluginCommImpl赋值给插件，它们会在插件真正加载运行时被用到。如果插件启动了自己的进程来运行，那么在插件的进程中会真正的去运行插件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">callAttach</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mClassLoader = PmBase.class.getClassLoader();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 挂载，将插件与当前进程关联</span></span><br><span class="line">    <span class="keyword">for</span> (Plugin p : mPlugins.values()) &#123;</span><br><span class="line">        p.attach(mContext, mClassLoader, mLocal);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果插件启动了自己单独的进程，就会load插件</span></span><br><span class="line">    <span class="keyword">if</span> (PluginManager.isPluginProcess()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(mDefaultPluginName)) &#123;</span><br><span class="line">            Plugin p = mPlugins.get(mDefaultPluginName);</span><br><span class="line">            <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> rc = p.load(Plugin.LOAD_APP, <span class="keyword">true</span>);</span><br><span class="line">                <span class="keyword">if</span> (rc) &#123;</span><br><span class="line">                    mDefaultPlugin = p;</span><br><span class="line">                    mClient.init(p);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Plugin.java</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context, ClassLoader parent, PluginCommImpl manager)</span> </span>&#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mParent = parent;</span><br><span class="line">    mPluginManager = manager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Replugin框架将插件的管理工作统一放在一个进程中，而其他进程需要通过插件管理进程返回的Binder对象来进行操作，这样既保证了信息的安全性，又可以分担其他进程的工作压力。框架的初始化主要创建了一些来管理和操作插件的Binder对象，然后通过区分进程来分别初始化插件管理进程和Clent进程各自要做的事情，插件管理进程主要是对插件信息的更新和维护，而Clent进程主要是需要获取到插件管理的进程的Binder对象来进行后续的操作等，在各进程出来完后会将所有插件的进行进行存储，然后hook系统ClassLoader，最后加载了默认插件。</p>
<p>整个流程跟系统AMS和ServiceManager有些类似。</p>
<h1 id="插件安装原理"><a href="#插件安装原理" class="headerlink" title="插件安装原理"></a>插件安装原理</h1><h2 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h2><p>简述一下系统PMS安装apk的过程：</p>
<ul>
<li>系统扫描安装：在PMS被创建的时候，在构造方法中会扫描固定几个文件夹，例如：/system/framework、/system/app、/data/app等目录，然后为其中的apk文件创建一个PackageParser对象并执行该对象的parsePackage方法去解析这个apk文件，主要是解析AndroidManifest.xml，并封装PackageParser.Package对象返回，接着释放apk文件的lib库，优化dex文件，最后将解析得到的数据缓存起来，例如四大组件，Rermission等，系统扫描安装的大概步骤就是这样。</li>
<li>调用PMS接口安装：入口是PMS的installPackage，它将apk复制到/data/app目录下，并调用解析和释放apk的方法，最后会发送一个广播通知安装完成。</li>
</ul>
<p>Replugin中的插件分为内置插件和外置插件：</p>
<ul>
<li>内置的插件的安装时在初始化的时候就自动安装和加载了，在插件管理进程初始化的时候会扫描assest目录下的一个叫plugins-builtin.json的文件，并将插件信息封装成Plugin对象存入PmBase中<br>的一个叫mPlugins的ConcurrentHashMap中统一管理。</li>
<li>外置插件的安装需要调用Replugin.install()方法来安装插件，这个过程和内置插件类似，区别就是内置插件是通过assest目录下的json文件来生成插件对象，外置插件则是通过获取插件apk的PackageInfo来生成插件对象，但是并不会处理apk中的dex、so库、资源等，只有当真正使用这个插件中的类时才会去真正的解析加载这个插件。</li>
</ul>
<h2 id="安装入口"><a href="#安装入口" class="headerlink" title="安装入口"></a>安装入口</h2><p>入口是Replugin.install()方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Replugin.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PluginInfo <span class="title">install</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 判断插件是否合法</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> MP.pluginDownloaded(path);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MP.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> PluginInfo <span class="title">pluginDownloaded</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="comment">// getPluginHost返回的是PmHostSvc对象</span></span><br><span class="line">    PluginInfo info = PluginProcessMain.getPluginHost().pluginDownloaded(path);</span><br><span class="line">    <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</span><br><span class="line">        RePlugin.getConfig().getEventCallbacks().onInstallPluginSucceed(info);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PmHostSvc.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PluginInfo <span class="title">pluginDownloaded</span><span class="params">(String path)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="comment">// 通过路径来判断是采用新方案，还是旧的P-N（即将废弃，有多种）方案</span></span><br><span class="line">    PluginInfo pi;</span><br><span class="line">    String fn = <span class="keyword">new</span> File(path).getName();</span><br><span class="line">    <span class="keyword">if</span> (fn.startsWith(<span class="string">&quot;p-n-&quot;</span>) || fn.startsWith(<span class="string">&quot;v-plugin-&quot;</span>) || fn.startsWith(<span class="string">&quot;plugin-s-&quot;</span>) || fn.startsWith(<span class="string">&quot;p-m-&quot;</span>)) &#123;</span><br><span class="line">        pi = pluginDownloadedForPn(path);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pi = mManager.getService().install(path);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pi != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 通常到这里，表示“安装已成功”，这时不管处于什么状态，都应该通知外界更新插件内存表</span></span><br><span class="line">        syncInstalledPluginInfo2All(pi);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pi;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h2><p>执行安装的是<code>mManager.getService().install(path)</code>，这个mManager是PluginManagerServer类型，它在PmHostSvc的构造方法中被创建，是用来管理插件的安装、卸载、更新、获取等功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IPluginManagerServer <span class="title">getService</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mStub;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Stub</span> <span class="keyword">extends</span> <span class="title">IPluginManagerServer</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PluginInfo <span class="title">install</span><span class="params">(String path)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (LOCKER) &#123;</span><br><span class="line">            <span class="keyword">return</span> PluginManagerServer.<span class="keyword">this</span>.installLocked(path);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> PluginInfo <span class="title">installLocked</span><span class="params">(String path)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> verifySignEnable = RePlugin.getConfig().getVerifySign();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> flags = verifySignEnable ? PackageManager.GET_META_DATA | PackageManager.GET_SIGNATURES : PackageManager.GET_META_DATA;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 读取APK内容</span></span><br><span class="line">    PackageInfo pi = mContext.getPackageManager().getPackageArchiveInfo(path, flags);</span><br><span class="line">    <span class="keyword">if</span> (pi == <span class="keyword">null</span>) &#123;</span><br><span class="line">        RePlugin.getConfig().getEventCallbacks().onInstallPluginFailed(path, RePluginEventCallbacks.InstallResult.READ_PKG_INFO_FAIL);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 校验插件签名</span></span><br><span class="line">    <span class="keyword">if</span> (verifySignEnable) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!verifySignature(pi, path)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 通过PackageInfo解析插件apk中的包名、AndroidManifest.xml中的metaData标签、根据这些信息new一个PluginInfo</span></span><br><span class="line">    PluginInfo instPli = PluginInfo.parseFromPackageInfo(pi, path);</span><br><span class="line">    instPli.setType(PluginInfo.TYPE_NOT_INSTALL);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取之前是否已经安装过这个插件，false代表是返回原对象，true返回clone后的对象</span></span><br><span class="line">    PluginInfo curPli = MP.getPlugin(instPli.getName(), <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (curPli != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 版本较老？直接返回</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> checkResult = checkVersion(instPli, curPli);</span><br><span class="line">        <span class="keyword">if</span> (checkResult &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            RePlugin.getConfig().getEventCallbacks().onInstallPluginFailed(path, RePluginEventCallbacks.InstallResult.VERIFY_VER_FAIL);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (checkResult == <span class="number">0</span>)&#123;</span><br><span class="line">            instPli.setIsPendingCover(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. 将合法的APK改名后，移动（或复制，见RePluginConfig.isMoveFileWhenInstalling）到新位置</span></span><br><span class="line">    <span class="keyword">if</span> (!copyOrMoveApk(path, instPli)) &#123;</span><br><span class="line">        RePlugin.getConfig().getEventCallbacks().onInstallPluginFailed(path, RePluginEventCallbacks.InstallResult.COPY_APK_FAIL);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. 从插件中释放 So 文件</span></span><br><span class="line">    PluginNativeLibsHelper.install(instPli.getPath(), instPli.getNativeLibsDir());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. 若已经安装旧版本插件，则尝试更新插件信息，否则直接加入到列表中</span></span><br><span class="line">    <span class="keyword">if</span> (curPli != <span class="keyword">null</span>) &#123;</span><br><span class="line">        updateOrLater(curPli, instPli);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        mList.add(instPli);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 7. 保存插件信息到文件中，下次可直接使用</span></span><br><span class="line">    mList.save(mContext);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> instPli;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="更新插件"><a href="#更新插件" class="headerlink" title="更新插件"></a>更新插件</h2><p>更新的方法updateOrLater如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateOrLater</span><span class="params">(PluginInfo curPli, PluginInfo instPli)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 已有“待更新版本”？</span></span><br><span class="line">    PluginInfo curUpdatePli = curPli.getPendingUpdate();</span><br><span class="line">    <span class="keyword">if</span> (curUpdatePli != <span class="keyword">null</span>) &#123;</span><br><span class="line">        updatePendingUpdate(curPli, instPli, curUpdatePli);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 正在运行？Later到下次使用时再释放。否则直接开始更新</span></span><br><span class="line">    <span class="keyword">if</span> (RePlugin.isPluginRunning(curPli.getName())) &#123;</span><br><span class="line">        <span class="keyword">if</span> (instPli.getVersion() &gt; curPli.getVersion()) &#123;</span><br><span class="line">            <span class="comment">// 高版本升级</span></span><br><span class="line">            curPli.setPendingUpdate(instPli);</span><br><span class="line">            curPli.setPendingDelete(<span class="keyword">null</span>);</span><br><span class="line">            curPli.setPendingCover(<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (instPli.getVersion() == curPli.getVersion())&#123;</span><br><span class="line">            <span class="comment">// 同版本覆盖</span></span><br><span class="line">            curPli.setPendingCover(instPli);</span><br><span class="line">            curPli.setPendingDelete(<span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">// 注意：并不需要对PendingUpdate信息做处理，因为此前的updatePendingUpdate方法时就已经返回了</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置其Parent为curPli，在PmBase.newPluginFound时会用到</span></span><br><span class="line">        instPli.setParentInfo(curPli);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        updateNow(curPli, instPli);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updatePendingUpdate</span><span class="params">(PluginInfo curPli, PluginInfo instPli, PluginInfo curUpdatePli)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (curUpdatePli.getVersion() &lt; instPli.getVersion()) &#123;</span><br><span class="line">        <span class="comment">// 现在的版本比之前&quot;打算要更新&quot;的版本还要新（形象的称之为“夹心层”），则删除掉该“夹心层”的版本，然后换成这个更新的</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置待更新版本至最大版本</span></span><br><span class="line">        curPli.setPendingUpdate(instPli);</span><br><span class="line">        instPli.setParentInfo(curPli);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 删除“夹心层”插件文件</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            FileUtils.forceDelete(<span class="keyword">new</span> File(curUpdatePli.getPath()));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (LogRelease.LOGR) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateNow</span><span class="params">(PluginInfo curInfo, PluginInfo newInfo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> covered = newInfo.getIsPendingCover();</span><br><span class="line">    <span class="keyword">if</span> (covered) &#123;</span><br><span class="line">        move(curInfo, newInfo);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 删除旧版本插件，不管是不是p-n的，且清掉Dex和Native目录</span></span><br><span class="line">        delete(curInfo);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    newInfo.setType(PluginInfo.TYPE_EXTRACTED);</span><br><span class="line">    <span class="keyword">if</span> (covered) &#123;</span><br><span class="line">        curInfo.setPendingCover(<span class="keyword">null</span>);</span><br><span class="line">        newInfo.setIsPendingCover(<span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">//修改isPendingCover属性后必须同时修改json中的path路径</span></span><br><span class="line">        newInfo.setPath(newInfo.getApkFile().getPath());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        curInfo.update(newInfo);</span><br><span class="line">        curInfo.setPendingUpdate(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="通知更新内存"><a href="#通知更新内存" class="headerlink" title="通知更新内存"></a>通知更新内存</h2><p>install结束后，接着看syncPluginInfo2All方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">syncInstalledPluginInfo2All</span><span class="params">(PluginInfo pi)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// PS：若更新了“正在运行”的插件（属于“下次重启进程后更新”），则由于install返回的是“新的PluginInfo”，为防止出现“错误更新”，需要使用原来的。</span></span><br><span class="line">    <span class="comment">// 举例，有一个正在运行的插件A（其Info为PluginInfoOld）升级到新版（其Info为PluginInfoNew），则：</span></span><br><span class="line">    <span class="comment">// 1. mManager.getService().install(path) 的返回值为：PluginInfoNew</span></span><br><span class="line">    <span class="comment">// 2. PluginInfoOld在常驻进程中的内容修改为：PluginInfoOld.mPendingUpdate = PendingInfoNew</span></span><br><span class="line">    <span class="comment">// 3. 同步到各进程，这里存在两种可能：</span></span><br><span class="line">    <span class="comment">//    a) （有问题）同步的是PluginInfoNew，则所有进程的内存表都强制更新到新的Info上，因此【正在运行的】插件信息将丢失，会出现严重问题</span></span><br><span class="line">    <span class="comment">//    b) （没问题）同步的是PluginInfoOld，只不过这个Old里面有个mPendingUpdate指向PendingInfoNew，则不会有问题，旧的仍被使用，符合预期</span></span><br><span class="line">    <span class="comment">// 4. 最终install方法的返回值是PluginInfoNew，这样最外面拿到的就是安装成功的新插件信息，符合开发者的预期</span></span><br><span class="line">    <span class="comment">// 简单的说就是如果这个插件正在运行则会记录这个要更新插件的信息到原插件信息对象上，</span></span><br><span class="line">    <span class="comment">// 直到所有“正在使用插件”的进程结束并重启后才会生效</span></span><br><span class="line">    PluginInfo needToSyncPi;</span><br><span class="line">    PluginInfo parent = pi.getParentInfo();</span><br><span class="line">    <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">        needToSyncPi = parent;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        needToSyncPi = pi;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在常驻进程内更新插件内存表</span></span><br><span class="line">    mPluginMgr.newPluginFound(needToSyncPi, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通知其它进程去更新</span></span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(PmBase.ACTION_NEW_PLUGIN);</span><br><span class="line">    intent.putExtra(RePluginConstants.KEY_PERSIST_NEED_RESTART, mNeedRestart);</span><br><span class="line">    intent.putExtra(<span class="string">&quot;obj&quot;</span>, (Parcelable) needToSyncPi);</span><br><span class="line">    IPC.sendLocalBroadcast2AllSync(mContext, intent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">newPluginFound</span><span class="params">(PluginInfo info, <span class="keyword">boolean</span> persistNeedRestart)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 更新最新插件表</span></span><br><span class="line">    PluginTable.updatePlugin(info);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更新可加载插件表</span></span><br><span class="line">    insertNewPlugin(info);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 清空插件的状态（解禁）</span></span><br><span class="line">    PluginStatusController.setStatus(info.getName(), info.getVersion(), PluginStatusController.STATUS_OK);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (IPC.isPersistentProcess()) &#123;</span><br><span class="line">        persistNeedRestart = mNeedRestart;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通知本进程：通知给外部使用者</span></span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(RePluginConstants.ACTION_NEW_PLUGIN);</span><br><span class="line">    intent.putExtra(RePluginConstants.KEY_PLUGIN_INFO, (Parcelable) info);</span><br><span class="line">    intent.putExtra(RePluginConstants.KEY_PERSIST_NEED_RESTART, persistNeedRestart);</span><br><span class="line">    intent.putExtra(RePluginConstants.KEY_SELF_NEED_RESTART, mNeedRestart);</span><br><span class="line">    LocalBroadcastManager.getInstance(mContext).sendBroadcast(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注册PmBase.ACTION_NEW_PLUGIN监听的代码，在RePluginApplication的onCreate方法中调用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PmBase#callAppCreate()</span></span><br><span class="line"><span class="keyword">if</span> (!IPC.isPersistentProcess()) &#123;</span><br><span class="line">    <span class="comment">// 由于常驻进程已经在内部做了相关的处理，此处仅需要在UI进程注册并更新即可</span></span><br><span class="line">    IntentFilter intentFilter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">    intentFilter.addAction(ACTION_NEW_PLUGIN);</span><br><span class="line">    intentFilter.addAction(ACTION_UNINSTALL_PLUGIN);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        LocalBroadcastManager.getInstance(mContext).registerReceiver(mBroadcastReceiver, intentFilter);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (LOGR) &#123;</span><br><span class="line">            LogRelease.e(PLUGIN_TAG, <span class="string">&quot;p m hlc a r e: &quot;</span> + e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> BroadcastReceiver mBroadcastReceiver = <span class="keyword">new</span> BroadcastReceiver() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceive</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">        String action = intent.getAction();</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(action)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (action.equals(intent.getAction())) &#123;</span><br><span class="line">            PluginInfo info = intent.getParcelableExtra(<span class="string">&quot;obj&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">                    <span class="keyword">case</span> ACTION_NEW_PLUGIN:</span><br><span class="line">                        <span class="comment">// 非常驻进程上下文</span></span><br><span class="line">                        newPluginFound(info, intent.getBooleanExtra(RePluginConstants.KEY_PERSIST_NEED_RESTART, <span class="keyword">false</span>));</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> ACTION_UNINSTALL_PLUGIN:</span><br><span class="line">                        pluginUninstalled(info);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="Activity启动流程"><a href="#Activity启动流程" class="headerlink" title="Activity启动流程"></a>Activity启动流程</h1><p>启动一个Activity的入口函数是Replugin.startActivity()，然后调用Factory.startActivityWithNoInjectCN，再经过PluginCommImpl.startActivivty()，最终来到PluginLibraryInternalProxy.startActivity()，这里是真正开始工作的地方，接下来按照顺序解析这一流程。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>在启动之前，如果有必要，需要先下载插件，可以在Application中使用继承RePluginCallbacks的自定义回调来处理下载插件的需求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (download) &#123;</span><br><span class="line">    <span class="keyword">if</span> (PluginTable.getPluginInfo(plugin) == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isNeedToDownload(context, plugin)) &#123;</span><br><span class="line">            <span class="keyword">return</span> RePlugin.getConfig().getCallbacks().onPluginNotExistsForActivity(context, plugin, intent, process);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果插件状态不正确，或者首次加载大插件，会通过回调让用户处理，用户可以可以在回调里定制自己的行为，比如弹出提示框，加载进度条等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果插件状态出现问题，则每次弹此插件的Activity都应提示无法使用，或提示升级（如有新版）</span></span><br><span class="line"><span class="keyword">if</span> (PluginStatusController.getStatus(plugin) &lt; PluginStatusController.STATUS_OK) &#123;</span><br><span class="line">    <span class="keyword">return</span> RePlugin.getConfig().getCallbacks().onPluginNotExistsForActivity(context, plugin, intent, process);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 若为首次加载插件，且是“大插件”，则应异步加载，同时弹窗提示“加载中”</span></span><br><span class="line"><span class="keyword">if</span> (!RePlugin.isPluginDexExtracted(plugin)) &#123;</span><br><span class="line">    PluginDesc pd = PluginDesc.get(plugin);</span><br><span class="line">    <span class="keyword">if</span> (pd != <span class="keyword">null</span> &amp;&amp; pd.isLarge()) &#123;</span><br><span class="line">        <span class="keyword">return</span> RePlugin.getConfig().getCallbacks().onLoadLargePluginForActivity(context, plugin, intent, process);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后会调用PluginCommImpl.loadPluginActivity来寻找坑位Activity。如果是第一次去获取信息，会首先去加载插件的Dex文件以及资源等，并创建PluginDexClassLoader。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载插件Activity，在startActivity之前调用</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ComponentName <span class="title">loadPluginActivity</span><span class="params">(Intent intent, String plugin, String activity, <span class="keyword">int</span> process)</span> </span>&#123;</span><br><span class="line">    PluginBinderInfo info = <span class="keyword">new</span> PluginBinderInfo(PluginBinderInfo.ACTIVITY_REQUEST);</span><br><span class="line">    ActivityInfo ai = getActivityInfo(plugin, activity, intent);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 存储此 Activity 在插件 Manifest 中声明主题到 Intent</span></span><br><span class="line">    intent.putExtra(INTENT_KEY_THEME_ID, ai.theme);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据 activity 的 processName，选择进程 ID 标识</span></span><br><span class="line">    <span class="keyword">if</span> (ai.processName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        process = PluginClientHelper.getProcessInt(ai.processName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 容器选择（启动目标进程）</span></span><br><span class="line">    IPluginClient client = MP.startPluginProcess(plugin, process, info);</span><br><span class="line">    <span class="comment">// 远程分配坑位</span></span><br><span class="line">    container = client.allocActivityContainer(plugin, process, ai.name, intent);</span><br><span class="line"></span><br><span class="line">    PmBase.cleanIntentPluginParams(intent);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ComponentName(IPC.getPackageName(), container);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="插件加载"><a href="#插件加载" class="headerlink" title="插件加载"></a>插件加载</h2><p>PluginCommImpl.getActivityInfo调用PmBase.loadAppPlugin获取插件对象，Replugin 是支持使用 IntentFilter 来启动组件的，完美支持原生特性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActivityInfo <span class="title">getActivityInfo</span><span class="params">(String plugin, String activity, Intent intent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取插件对象</span></span><br><span class="line">    Plugin p = mPluginMgr.loadAppPlugin(plugin);</span><br><span class="line">    ActivityInfo ai = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// activity 不为空时，从插件声明的 Activity 集合中查找</span></span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(activity)) &#123;</span><br><span class="line">        ai = p.mLoader.mComponents.getActivity(activity);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// activity 为空时，根据 Intent 匹配</span></span><br><span class="line">        ai = IntentMatcherHelper.getActivityInfo(mContext, plugin, intent);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ai;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> Plugin <span class="title">loadAppPlugin</span><span class="params">(String plugin)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> loadPlugin(mPlugins.get(plugin), Plugin.LOAD_APP, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> Plugin <span class="title">loadPlugin</span><span class="params">(Plugin p, <span class="keyword">int</span> loadType, <span class="keyword">boolean</span> useCache)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!p.load(loadType, useCache)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">load</span><span class="params">(<span class="keyword">int</span> load, <span class="keyword">boolean</span> useCache)</span> </span>&#123;</span><br><span class="line">    PluginInfo info = mInfo;</span><br><span class="line">    <span class="keyword">boolean</span> rc = loadLocked(load, useCache);</span><br><span class="line">    <span class="comment">// 尝试在此处调用Application.onCreate方法</span></span><br><span class="line">    <span class="comment">// Added by Jiongxuan Zhang</span></span><br><span class="line">    <span class="keyword">if</span> (load == LOAD_APP &amp;&amp; rc) &#123;</span><br><span class="line">        callApp();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 如果info改了，通知一下常驻</span></span><br><span class="line">    <span class="comment">// 只针对P-n的Type转化来处理，一定要通知，这样Framework_Version也会得到更新</span></span><br><span class="line">    <span class="keyword">if</span> (rc &amp;&amp; mInfo != info) &#123;</span><br><span class="line">        UpdateInfoTask task = <span class="keyword">new</span> UpdateInfoTask((PluginInfo) mInfo.clone());</span><br><span class="line">        Tasks.post2Thread(task);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PmBase.loadAppPlugin会最终调用Plugin.loadLocked()函数，这个函数有两个参数，第一个是加载类型，一共有四种加载类型，在这里使用的是Plugin.LOAD_APP，因为运行插件需要所有的东西。第二个参数是是否使用缓存，通常情况下我们会现在缓存中查找插件信息，这样会更快。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">loadLocked</span><span class="params">(<span class="keyword">int</span> load, <span class="keyword">boolean</span> useCache)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 这里先处理一下，如果cache命中，省了后面插件提取（如释放Jar包等）操作，直接返回缓存数据</span></span><br><span class="line">    <span class="keyword">if</span> (useCache) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> result = loadByCache(load);</span><br><span class="line">        <span class="keyword">if</span> (result) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PluginCommImpl manager = mPluginManager;</span><br><span class="line">    <span class="keyword">boolean</span> rc = doLoad(logTag, context, parent, manager, load);  <span class="comment">// 真正的加载</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 至此，该插件已开始运行</span></span><br><span class="line">            PluginManagerProxy.addToRunningPluginsNoThrows(mInfo.getName());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    File odex = mInfo.getDexFile();</span><br><span class="line">    <span class="keyword">if</span> (odex.exists()) &#123;</span><br><span class="line">        odex.delete();</span><br><span class="line">    &#125;</span><br><span class="line">    rc = doLoad(logTag, context, parent, manager, load);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Plugin.doLoad()用来加载插件的Dex文件，资源，以及so文件等等。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">doLoad</span><span class="params">(String tag, Context context, ClassLoader parent, PluginCommImpl manager, <span class="keyword">int</span> load)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 释放so文件，省略</span></span><br><span class="line">        <span class="comment">// 加载Dex，获取组件信息</span></span><br><span class="line">        mLoader = <span class="keyword">new</span> Loader(context, mInfo.getName(), mInfo.getPath(), <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">if</span> (!mLoader.loadDex(parent, load)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 在Persistent进程中更新插件信息，设置插件为“使用过的”</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            PluginManagerProxy.updateUsedIfNeeded(mInfo.getName(), <span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 若需要加载Dex，则还同时需要初始化插件里的Entry对象</span></span><br><span class="line">        <span class="keyword">if</span> (load == LOAD_APP) &#123;</span><br><span class="line">            <span class="comment">// NOTE Entry对象是可以在任何线程中被调用到</span></span><br><span class="line">            <span class="keyword">if</span> (!loadEntryLocked(manager)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Loader.loadDex函数会获取Dex中的组件的信息，包括Manifest中的组件属性，比如进程属性，TaskAffinity属性，注册静态广播等等，这里值得重点强调的是PluginDexClassLoader在此被初始化了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">loadDex</span><span class="params">(ClassLoader parent, <span class="keyword">int</span> load)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mClassLoader = Plugin.queryCachedClassLoader(mPath);</span><br><span class="line">        <span class="keyword">if</span> (mClassLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 创建PluginDexClassLoader</span></span><br><span class="line">            mClassLoader = RePlugin.getConfig().getCallbacks().createPluginClassLoader(mPath, out, soDir, parent);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 创建插件的Context对象</span></span><br><span class="line">        mPkgContext = <span class="keyword">new</span> PluginContext(mContext, android.R.style.Theme, mClassLoader, mPkgResources, mPluginName, <span class="keyword">this</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>插件加载的具体原理会在下一节讲到。</p>
<h2 id="寻找坑位"><a href="#寻找坑位" class="headerlink" title="寻找坑位"></a>寻找坑位</h2><h3 id="坑位初始化"><a href="#坑位初始化" class="headerlink" title="坑位初始化"></a>坑位初始化</h3><h4 id="LaunchModeStates"><a href="#LaunchModeStates" class="headerlink" title="LaunchModeStates"></a>LaunchModeStates</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LaunchModeStates</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 目前的策略是，针对每一种 launchMode 分配两种坑位（透明主题(TS)和不透明主题(NTS)）</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 例：透明主题</span></span><br><span class="line"><span class="comment">     * 　　　　　　　&lt;N1NRTS0, ActivityState&gt;</span></span><br><span class="line"><span class="comment">     * NR + TS  - &gt; &lt;N1NRTS1, ActivityState&gt;</span></span><br><span class="line"><span class="comment">     * 　　　　　　　&lt;N1NRTS2, ActivityState&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 例：不透明主题</span></span><br><span class="line"><span class="comment">     * 　　　　　　　&lt;N1NRNTS0, ActivityState&gt;</span></span><br><span class="line"><span class="comment">     * NR + NTS - &gt; &lt;N1NRNTS1, ActivityState&gt;</span></span><br><span class="line"><span class="comment">     * 　　　　　　　&lt;N1NRNTS2, ActivityState&gt;</span></span><br><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br><span class="line"><span class="comment">     * 其中：N1 表示当前为 UI 进程，NR 表示 launchMode 为 Standard，NTS 表示坑的 theme 为 Not Translucent。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, HashMap&lt;String, ActivityState&gt;&gt; mStates = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化 LaunchMode 和 Theme 对应的坑位</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> containers  保存所有 activity 坑位的引用</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> prefix      坑位前缀</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> launchMode  launchMode</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> translucent 是否是透明的坑</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> count       坑位数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addStates</span><span class="params">(Map&lt;String, ActivityState&gt; allStates, HashSet&lt;String&gt; containers, String prefix, <span class="keyword">int</span> launchMode, <span class="keyword">boolean</span> translucent, <span class="keyword">int</span> count)</span> </span>&#123;</span><br><span class="line">        String infix = getInfix(launchMode, translucent);</span><br><span class="line">        HashMap&lt;String, ActivityState&gt; states = mStates.get(infix);</span><br><span class="line">        <span class="keyword">if</span> (states == <span class="keyword">null</span>) &#123;</span><br><span class="line">            states = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            mStates.put(infix, states);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">            String key = prefix + infix + i;</span><br><span class="line">            ActivityState state = <span class="keyword">new</span> ActivityState(key);</span><br><span class="line">            states.put(key, state);</span><br><span class="line">            allStates.put(key, state);</span><br><span class="line">            containers.add(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据 launchMode 和 theme 获取对应的坑位集合</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">HashMap&lt;String, ActivityState&gt; <span class="title">getStates</span><span class="params">(<span class="keyword">int</span> launchMode, <span class="keyword">int</span> theme)</span> </span>&#123;</span><br><span class="line">        String infix = getInfix(launchMode, isTranslucentTheme(theme));</span><br><span class="line">        <span class="keyword">return</span> mStates.get(infix);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据 launchMode 和 &#x27;是否透明&#x27; 获取中缀符</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 如果是透明主题，返回 &#x27;launchMode&#x27;_TS_，否则返回 &#x27;launchMode&#x27;_NOT_TS_</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getInfix</span><span class="params">(<span class="keyword">int</span> launchMode, <span class="keyword">boolean</span> translucent)</span> </span>&#123;</span><br><span class="line">        String launchModeInfix = getLaunchModeInfix(launchMode);</span><br><span class="line">        <span class="keyword">return</span> translucent ? launchModeInfix + <span class="string">&quot;TS&quot;</span> : launchModeInfix + <span class="string">&quot;NTS&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取 launchMode 对应的前缀</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getLaunchModeInfix</span><span class="params">(<span class="keyword">int</span> launchMode)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (launchMode) &#123;</span><br><span class="line">            <span class="keyword">case</span> ActivityInfo.LAUNCH_SINGLE_TOP:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;STP&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> ActivityInfo.LAUNCH_SINGLE_TASK:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;ST&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> ActivityInfo.LAUNCH_SINGLE_INSTANCE:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;SI&quot;</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;NR&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="PluginContainers-init"><a href="#PluginContainers-init" class="headerlink" title="PluginContainers.init"></a>PluginContainers.init</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">PluginProcessPer(Context context, PmBase pm, <span class="keyword">int</span> process, HashSet&lt;String&gt; containers) &#123;</span><br><span class="line">    mContext = context;</span><br><span class="line">    mPluginMgr = pm;</span><br><span class="line">    mServiceMgr = <span class="keyword">new</span> PluginServiceServer(context);</span><br><span class="line"></span><br><span class="line">    mACM = <span class="keyword">new</span> PluginContainers();</span><br><span class="line">    mACM.init(process, containers);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PluginContainers.java</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">int</span> process, HashSet&lt;String&gt; containers)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (process != IPluginManager.PROCESS_UI</span><br><span class="line">            &amp;&amp; !PluginProcessHost.isCustomPluginProcess(process)</span><br><span class="line">            &amp;&amp; !PluginManager.isPluginProcess()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// CONTAINER_ACTIVITY_PART = &quot;.loader.a.Activity&quot;</span></span><br><span class="line">    String prefix = IPC.getPackageName() + CONTAINER_ACTIVITY_PART;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 因为自定义进程可能也会唤起使用UI进程的坑，所以这里使用&#x27;或&#x27;条件</span></span><br><span class="line">    <span class="keyword">if</span> (process == IPluginManager.PROCESS_UI || PluginProcessHost.isCustomPluginProcess(process)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* UI 进程标识为 N1 */</span></span><br><span class="line">        String suffix = <span class="string">&quot;N1&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Standard</span></span><br><span class="line">        mLaunchModeStates.addStates(mStates, containers, prefix + suffix, LAUNCH_MULTIPLE, <span class="keyword">true</span>, HostConfigHelper.ACTIVITY_PIT_COUNT_TS_STANDARD);</span><br><span class="line">        mLaunchModeStates.addStates(mStates, containers, prefix + suffix, LAUNCH_MULTIPLE, <span class="keyword">false</span>, HostConfigHelper.ACTIVITY_PIT_COUNT_NTS_STANDARD);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// SingleTop</span></span><br><span class="line">        mLaunchModeStates.addStates(mStates, containers, prefix + suffix, LAUNCH_SINGLE_TOP, <span class="keyword">true</span>, HostConfigHelper.ACTIVITY_PIT_COUNT_TS_SINGLE_TOP);</span><br><span class="line">        mLaunchModeStates.addStates(mStates, containers, prefix + suffix, LAUNCH_SINGLE_TOP, <span class="keyword">false</span>, HostConfigHelper.ACTIVITY_PIT_COUNT_NTS_SINGLE_TOP);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// SingleTask</span></span><br><span class="line">        mLaunchModeStates.addStates(mStates, containers, prefix + suffix, LAUNCH_SINGLE_TASK, <span class="keyword">true</span>, HostConfigHelper.ACTIVITY_PIT_COUNT_TS_SINGLE_TASK);</span><br><span class="line">        mLaunchModeStates.addStates(mStates, containers, prefix + suffix, LAUNCH_SINGLE_TASK, <span class="keyword">false</span>, HostConfigHelper.ACTIVITY_PIT_COUNT_NTS_SINGLE_TASK);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// SingleInstance</span></span><br><span class="line">        mLaunchModeStates.addStates(mStates, containers, prefix + suffix, LAUNCH_SINGLE_INSTANCE, <span class="keyword">true</span>, HostConfigHelper.ACTIVITY_PIT_COUNT_TS_SINGLE_INSTANCE);</span><br><span class="line">        mLaunchModeStates.addStates(mStates, containers, prefix + suffix, LAUNCH_SINGLE_INSTANCE, <span class="keyword">false</span>, HostConfigHelper.ACTIVITY_PIT_COUNT_NTS_SINGLE_INSTANCE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// taskAffinity</span></span><br><span class="line">        mTaskAffinityStates.init(prefix, suffix, mStates, containers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 因为有可能会在 UI 进程启动自定义进程的 Activity，所以此处也要初始化自定义进程的坑位数据</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PluginProcessHost.PROCESS_COUNT; i++) &#123;</span><br><span class="line">            ProcessStates processStates = <span class="keyword">new</span> ProcessStates();</span><br><span class="line">            <span class="comment">// [&quot;:p1&quot;: state(&quot;P1&quot;), &quot;:p2&quot;: state(&quot;P2&quot;)]</span></span><br><span class="line">            mProcessStatesMap.put(PluginProcessHost.PROCESS_PLUGIN_SUFFIX2 + i, processStates);</span><br><span class="line">            init2(prefix, containers, processStates, PluginProcessHost.PROCESS_PLUGIN_SUFFIX + i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 从内存中加载</span></span><br><span class="line">        loadFromPref();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化自定义进程坑坑位</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> prefix     xxx.xx.loader.a.Activity</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> containers 保存所有 Activity 坑名称</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> states     当前进程所有坑位的状态</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> suffix     p0, p1, p2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init2</span><span class="params">(String prefix, HashSet&lt;String&gt; containers, ProcessStates states, String suffix)</span> </span>&#123;</span><br><span class="line">    suffix = suffix.toUpperCase();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Standard</span></span><br><span class="line">    states.mLaunchModeStates.addStates(mStates, containers, prefix + suffix, LAUNCH_MULTIPLE, <span class="keyword">true</span>, HostConfigHelper.ACTIVITY_PIT_COUNT_TS_STANDARD);</span><br><span class="line">    states.mLaunchModeStates.addStates(mStates, containers, prefix + suffix, LAUNCH_MULTIPLE, <span class="keyword">false</span>, HostConfigHelper.ACTIVITY_PIT_COUNT_NTS_STANDARD);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SingleTop</span></span><br><span class="line">    states.mLaunchModeStates.addStates(mStates, containers, prefix + suffix, LAUNCH_SINGLE_TOP, <span class="keyword">true</span>, HostConfigHelper.ACTIVITY_PIT_COUNT_TS_SINGLE_TOP);</span><br><span class="line">    states.mLaunchModeStates.addStates(mStates, containers, prefix + suffix, LAUNCH_SINGLE_TOP, <span class="keyword">false</span>, HostConfigHelper.ACTIVITY_PIT_COUNT_NTS_SINGLE_TOP);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SingleTask</span></span><br><span class="line">    states.mLaunchModeStates.addStates(mStates, containers, prefix + suffix, LAUNCH_SINGLE_TASK, <span class="keyword">true</span>, HostConfigHelper.ACTIVITY_PIT_COUNT_TS_SINGLE_TASK);</span><br><span class="line">    states.mLaunchModeStates.addStates(mStates, containers, prefix + suffix, LAUNCH_SINGLE_TASK, <span class="keyword">false</span>, HostConfigHelper.ACTIVITY_PIT_COUNT_NTS_SINGLE_TASK);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// SingleInstance</span></span><br><span class="line">    states.mLaunchModeStates.addStates(mStates, containers, prefix + suffix, LAUNCH_SINGLE_INSTANCE, <span class="keyword">true</span>, HostConfigHelper.ACTIVITY_PIT_COUNT_TS_SINGLE_INSTANCE);</span><br><span class="line">    states.mLaunchModeStates.addStates(mStates, containers, prefix + suffix, LAUNCH_SINGLE_INSTANCE, <span class="keyword">false</span>, HostConfigHelper.ACTIVITY_PIT_COUNT_NTS_SINGLE_INSTANCE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// taskAffinity</span></span><br><span class="line">    states.mTaskAffinityStates.init(prefix, suffix, mStates, containers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>坑位示例(process, launchMode, taskAffinity, theme)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">com.hearing.host.loader.a.ActivityN1NRTS0</span><br><span class="line">com.hearing.host.loader.a.ActivityN1NRTS1</span><br><span class="line">com.hearing.host.loader.a.ActivityN1STPTS0</span><br><span class="line">com.hearing.host.loader.a.ActivityN1STTS0</span><br><span class="line">com.hearing.host.loader.a.ActivityN1SITS0</span><br><span class="line">com.hearing.host.loader.a.ActivityN1TA0STPTS0</span><br><span class="line">com.hearing.host.loader.a.ActivityN1TA0STPTS1</span><br><span class="line">com.hearing.host.loader.a.ActivityP0NRTS0</span><br><span class="line">com.hearing.host.loader.a.ActivityP0STPTS0</span><br></pre></td></tr></table></figure>

<h3 id="allocActivityContainer"><a href="#allocActivityContainer" class="headerlink" title="allocActivityContainer"></a>allocActivityContainer</h3><p>client.allocActivityContainer是一个远程调用，调用了Persistent进程中的PluginProcessPer.allocActivityContainer函数，进一步调用bindActivity函数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 加载插件；找到目标Activity；搜索匹配容器；加载目标Activity类；建立临时映射；返回容器</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> String <span class="title">bindActivity</span><span class="params">(String plugin, <span class="keyword">int</span> process, String activity, Intent intent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* 获取插件对象 */</span></span><br><span class="line">    Plugin p = mPluginMgr.loadAppPlugin(plugin);</span><br><span class="line">    <span class="comment">/* 获取 ActivityInfo */</span></span><br><span class="line">    ActivityInfo ai = p.mLoader.mComponents.getActivity(activity);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 进程名为空则使用主进程名</span></span><br><span class="line">    <span class="keyword">if</span> (ai.processName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        ai.processName = ai.applicationInfo.processName;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ai.processName == <span class="keyword">null</span>) &#123;</span><br><span class="line">        ai.processName = ai.packageName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String container;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// final PluginContainers mACM;</span></span><br><span class="line">    <span class="comment">// 自定义进程，插件中进程名称后缀PluginProcessHost.PROCESS_PLUGIN_SUFFIX2 = &quot;:p&quot;</span></span><br><span class="line">    <span class="keyword">if</span> (ai.processName.contains(PluginProcessHost.PROCESS_PLUGIN_SUFFIX2)) &#123;</span><br><span class="line">        <span class="comment">// 取进程名称中，冒号及后面的部分，如果进程名中无冒号，则返回原值。</span></span><br><span class="line">        String processTail = PluginProcessHost.processTail(ai.processName);</span><br><span class="line">        container = mACM.alloc2(ai, plugin, activity, process, intent, processTail);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        container = mACM.alloc(ai, plugin, activity, process, intent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 检查 activity 是否存在 */</span></span><br><span class="line">    Class&lt;?&gt; c = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        c = p.mLoader.mClassLoader.loadClass(activity);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> container;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里mACM.alloc用来执行位于宿主进程中的坑位分配，mACM.alloc2用来执行位于插件子进程中的坑位分配。</p>
<h3 id="alloc-amp-alloc2"><a href="#alloc-amp-alloc2" class="headerlink" title="alloc&amp;alloc2"></a>alloc&amp;alloc2</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginContainers</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 所有坑的状态集合</span></span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;String, ActivityState&gt; mStates = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">// 非默认 TaskAffinity 下，坑位的状态信息。</span></span><br><span class="line">    <span class="keyword">private</span> TaskAffinityStates mTaskAffinityStates = <span class="keyword">new</span> TaskAffinityStates();</span><br><span class="line">    <span class="comment">// 默认 TaskAffinity 下，坑位的状态信息。</span></span><br><span class="line">    <span class="keyword">private</span> LaunchModeStates mLaunchModeStates = <span class="keyword">new</span> LaunchModeStates();</span><br><span class="line">    <span class="comment">// 保存进程和进程中坑位状态的 Map</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ProcessStates&gt; mProcessStatesMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">final</span> String <span class="title">alloc</span><span class="params">(ActivityInfo ai, String plugin, String activity, <span class="keyword">int</span> process, Intent intent)</span> </span>&#123;</span><br><span class="line">        ActivityState state;</span><br><span class="line">        String defaultPluginTaskAffinity = ai.applicationInfo.packageName;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* SingleInstance 优先级最高 */</span></span><br><span class="line">        <span class="keyword">if</span> (ai.launchMode == LAUNCH_SINGLE_INSTANCE) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                state = allocLocked(ai, mLaunchModeStates.getStates(ai.launchMode, ai.theme), plugin, activity, intent);</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">/* TaskAffinity */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!defaultPluginTaskAffinity.equals(ai.taskAffinity)) &#123; <span class="comment">// 非默认 taskAffinity</span></span><br><span class="line">            <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                state = allocLocked(ai, mTaskAffinityStates.getStates(ai), plugin, activity, intent);</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">/* SingleTask, SingleTop, Standard */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                state = allocLocked(ai, mLaunchModeStates.getStates(ai.launchMode, ai.theme), plugin, activity, intent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (state != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> state.container;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">alloc2</span><span class="params">(ActivityInfo ai, String plugin, String activity, <span class="keyword">int</span> process, Intent intent, String processTail)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 根据进程名称，取得该进程对应的 PluginContainerStates</span></span><br><span class="line">        ProcessStates states = mProcessStatesMap.get(processTail);</span><br><span class="line"></span><br><span class="line">        ActivityState state;</span><br><span class="line"></span><br><span class="line">        String defaultPluginTaskAffinity = ai.applicationInfo.packageName;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* SingleInstance */</span></span><br><span class="line">        <span class="keyword">if</span> (ai.launchMode == LAUNCH_SINGLE_INSTANCE) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                state = allocLocked(ai, states.mLaunchModeStates.getStates(ai.launchMode, ai.theme), plugin, activity, intent);</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">/* TaskAffinity */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!defaultPluginTaskAffinity.equals(ai.taskAffinity)) &#123; <span class="comment">// 非默认 taskAffinity</span></span><br><span class="line">            <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                state = allocLocked(ai, states.mTaskAffinityStates.getStates(ai), plugin, activity, intent);</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">/* other mode */</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mLock) &#123;</span><br><span class="line">                state = allocLocked(ai, states.mLaunchModeStates.getStates(ai.launchMode, ai.theme), plugin, activity, intent);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (state != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> state.container;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ActivityState</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String container;</span><br><span class="line">        <span class="keyword">int</span> state;</span><br><span class="line">        String plugin;</span><br><span class="line">        String activity;</span><br><span class="line">        <span class="keyword">long</span> timestamp;</span><br><span class="line">        <span class="keyword">final</span> ArrayList&lt;WeakReference&lt;Activity&gt;&gt; refs;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isTarget</span><span class="params">(String plugin, String activity)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (TextUtils.equals(<span class="keyword">this</span>.plugin, plugin) &amp;&amp; TextUtils.equals(<span class="keyword">this</span>.activity, activity)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">occupy</span><span class="params">(String plugin, String activity)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (TextUtils.isEmpty(plugin) || TextUtils.isEmpty(activity)) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.state = STATE_OCCUPIED;</span><br><span class="line">            <span class="keyword">this</span>.plugin = plugin;</span><br><span class="line">            <span class="keyword">this</span>.activity = activity;</span><br><span class="line">            cleanRefs();</span><br><span class="line">            <span class="keyword">this</span>.timestamp = System.currentTimeMillis();</span><br><span class="line">            save2Pref(<span class="keyword">this</span>.plugin, <span class="keyword">this</span>.activity, <span class="keyword">this</span>.container);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasRef</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = refs.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                WeakReference&lt;Activity&gt; ref = refs.get(i);</span><br><span class="line">                <span class="keyword">if</span> (ref.get() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    refs.remove(i);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> refs.size() &gt; <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">cleanRefs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            refs.clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">save2Pref</span><span class="params">(String plugin, String activity, String container)</span> </span>&#123;</span><br><span class="line">        String v = plugin + <span class="string">&quot;:&quot;</span> + activity + <span class="string">&quot;:&quot;</span> + System.currentTimeMillis();</span><br><span class="line">        Pref.ipcSet(container, v);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String[] resolvePluginActivity(String container) &#123;</span><br><span class="line">        String v = Pref.ipcGet(container, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(v)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> v.split(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProcessStates</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 保存非默认 TaskAffinity 下，坑位的状态信息。</span></span><br><span class="line">    TaskAffinityStates mTaskAffinityStates = <span class="keyword">new</span> TaskAffinityStates();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存默认 TaskAffinity 下，坑位的状态信息。</span></span><br><span class="line">    LaunchModeStates mLaunchModeStates = <span class="keyword">new</span> LaunchModeStates();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="allocLocked"><a href="#allocLocked" class="headerlink" title="allocLocked"></a>allocLocked</h3><p>上面两个方法都会调用allocLocked方法，AcitivtyState对象保存了坑位Activity和真实要启动的Activity之间的对应关系，并且这个对应关系会被保存起来，在RepluginClassLoader在加载类的时候会被拿出来使用，以获取要运行的Activity的class对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">final</span> ActivityState <span class="title">allocLocked</span><span class="params">(ActivityInfo ai, HashMap&lt;String, ActivityState&gt; map, String plugin, String activity, Intent intent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 首先找上一个活的，或者已经注册的，避免多个坑到同一个activity的映射</span></span><br><span class="line">    <span class="keyword">for</span> (ActivityState state : map.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (state.isTarget(plugin, activity)) &#123;</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新分配：找空白的，第一个</span></span><br><span class="line">    <span class="keyword">for</span> (ActivityState state : map.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (state.state == STATE_NONE) &#123;</span><br><span class="line">            state.occupy(plugin, activity);</span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ActivityState found;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 重用：则找最老的那个</span></span><br><span class="line">    found = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (ActivityState state : map.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!state.hasRef()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (found == <span class="keyword">null</span>) &#123;</span><br><span class="line">                found = state;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state.timestamp &lt; found.timestamp) &#123;</span><br><span class="line">                found = state;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (found != <span class="keyword">null</span>) &#123;</span><br><span class="line">        found.occupy(plugin, activity);</span><br><span class="line">        <span class="keyword">return</span> found;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 强挤：最后一招，挤掉：最老的那个</span></span><br><span class="line">    found = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (ActivityState state : map.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (found == <span class="keyword">null</span>) &#123;</span><br><span class="line">            found = state;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (state.timestamp &lt; found.timestamp) &#123;</span><br><span class="line">            found = state;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (found != <span class="keyword">null</span>) &#123;</span><br><span class="line">        found.finishRefs();</span><br><span class="line">        found.occupy(plugin, activity);</span><br><span class="line">        <span class="keyword">return</span> found;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// never reach here</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="启动Activity"><a href="#启动Activity" class="headerlink" title="启动Activity"></a>启动Activity</h2><p>找到坑位后，PluginLibraryInternalProxy.startActivity()中开始启动坑位Activity：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">startActivity</span><span class="params">(Context context, Intent intent, String plugin, String activity, <span class="keyword">int</span> process, <span class="keyword">boolean</span> download)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 缓存打开前的Intent对象，里面将包括Action等内容</span></span><br><span class="line">    Intent from = <span class="keyword">new</span> Intent(intent);</span><br><span class="line">    ComponentName cn = mPluginMgr.mLocal.loadPluginActivity(intent, plugin, activity, process);</span><br><span class="line">    intent.setComponent(cn);</span><br><span class="line">    context.startActivity(intent);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通知外界，已准备好要打开Activity了</span></span><br><span class="line">    <span class="comment">// 其中：from为要打开的插件的Intent，intent为坑位Intent</span></span><br><span class="line">    RePlugin.getConfig().getEventCallbacks().onPrepareStartPitActivity(context, from, intent);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据之前的<a target="_blank" rel="noopener" href="https://ljd1996.github.io/2020/03/18/Android-Activity%E5%8E%9F%E7%90%86/">Activity启动原理</a>中ActivityThread.performLaunchActivity方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    ActivityInfo aInfo = r.activityInfo;</span><br><span class="line"></span><br><span class="line">    ComponentName component = r.intent.getComponent();</span><br><span class="line">    ContextImpl appContext = createBaseContextForActivity(r);</span><br><span class="line">    Activity activity = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        java.lang.ClassLoader cl = appContext.getClassLoader();</span><br><span class="line">        activity = mInstrumentation.newActivity(</span><br><span class="line">                cl, component.getClassName(), r.intent);</span><br><span class="line">        StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">        r.intent.setExtrasClassLoader(cl);</span><br><span class="line">        r.intent.prepareToEnterProcess();</span><br><span class="line">        <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) &#123;</span><br><span class="line">            r.state.setClassLoader(cl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可知系统会调用Classloader的loadClass方法，这里就是调用Replugin提供的替代者RepluginClassLoader的方法。接着又会调用PMF.loadClass，其实就是调用Pmbase.loadClass。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; loadClass(String className, <span class="keyword">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    Class&lt;?&gt; c = <span class="keyword">null</span>;</span><br><span class="line">    c = PMF.loadClass(className, resolve);</span><br><span class="line">    <span class="keyword">if</span> (c != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mOrig.loadClass(className);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.loadClass(className, resolve);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pmbase</span></span><br><span class="line"><span class="keyword">final</span> Class&lt;?&gt; loadClass(String className, <span class="keyword">boolean</span> resolve) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mContainerActivities.contains(className)) &#123;</span><br><span class="line">        <span class="comment">// PluginProcessPer mClient;</span></span><br><span class="line">        Class&lt;?&gt; c = mClient.resolveActivityClass(className);</span><br><span class="line">        <span class="keyword">if</span> (c != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> c;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// mContainerServices</span></span><br><span class="line">    <span class="comment">// mContainerProviders</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里先从PluginContainers的实例对象mACM中去查找ActivityState，它就是在分配坑位的时候，我们用来保存坑位组件与真实组件对应关系的类。然后在缓存中找到插件名对应的插件对象，因为在分配坑位的时候插件信息已经加载过了，不需要重新加载。接着取出插件的ClassLoader对象，这个对象正是加载插件时创建的PuginDexClassLoader的实例了。然后利用插件的PuginDexClassLoader对象来加载真实Activity的class对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Class&lt;?&gt; resolveActivityClass(String container) &#123;</span><br><span class="line">    String plugin = <span class="keyword">null</span>;</span><br><span class="line">    String activity = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// 先找登记的，如果找不到，则用forward activity</span></span><br><span class="line">    PluginContainers.ActivityState state = mACM.lookupByContainer(container);</span><br><span class="line">    <span class="keyword">if</span> (state == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 若坑位出现丢失或错乱，则通过读取Intent.Category来做个中转</span></span><br><span class="line">        <span class="keyword">return</span> ForwardActivity.class;</span><br><span class="line">    &#125;</span><br><span class="line">    plugin = state.plugin;</span><br><span class="line">    activity = state.activity;</span><br><span class="line">    Plugin p = mPluginMgr.loadAppPlugin(plugin); <span class="comment">//通过插件名从缓存中加载Plugin对象</span></span><br><span class="line">    ClassLoader cl = p.getClassLoader();</span><br><span class="line">    Class&lt;?&gt; c = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        c = cl.loadClass(activity);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>找到插件Activity的类对象后，Android系统就开始运行Activity的启动流程了，这些事情由ActivityManagerService和ActivityThread负责。就这样，Replugin用插件中的Activity替换了坑位Activity，巧妙地将其运行起来了。</p>
<h1 id="插件加载原理"><a href="#插件加载原理" class="headerlink" title="插件加载原理"></a>插件加载原理</h1><h2 id="Plugin加载过程"><a href="#Plugin加载过程" class="headerlink" title="Plugin加载过程"></a>Plugin加载过程</h2><p>加载插件就是启动运行插件apk的过程，插件的真正加载从调用Plugin.load方法开始，然后调用Plugin.doLoad函数，这个函数做了三件事情：</p>
<ul>
<li>释放插件文件到相应的目录，比如so库，dex文件</li>
<li>加载dex文件，比如组件信息，组件属性，资源等</li>
<li>要运行Plugin，还需要初始化Plugin的运行环境</li>
</ul>
<p>释放文件这一步很简单，就是将APK包打开以后将相应的文件放到不同的目录中。加载Dex文件是通过Loader.loadDex方法实现的，下面我们分步解析这个方法：</p>
<ol>
<li><p>获取PackageInfo并缓存插件相关的信息，比如组件，组件属性，资源等，下次就可以直接从缓存中读取。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mPackageInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 通过PackageManager获取PackageInfo</span></span><br><span class="line">    mPackageInfo = pm.getPackageArchiveInfo(mPath,</span><br><span class="line">            PackageManager.GET_ACTIVITIES | PackageManager.GET_SERVICES | PackageManager.GET_PROVIDERS | PackageManager.GET_RECEIVERS | PackageManager.GET_META_DATA);</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment">// 添加针对SO库的加载</span></span><br><span class="line">    PluginInfo pi = mPluginObj.mInfo;</span><br><span class="line">    File ld = pi.getNativeLibsDir();</span><br><span class="line">    mPackageInfo.applicationInfo.nativeLibraryDir = ld.getAbsolutePath();</span><br><span class="line">    <span class="comment">// 缓存表: pkgName -&gt; pluginName</span></span><br><span class="line">    <span class="keyword">synchronized</span> (Plugin.PKG_NAME_2_PLUGIN_NAME) &#123;</span><br><span class="line">        Plugin.PKG_NAME_2_PLUGIN_NAME.put(mPackageInfo.packageName, mPluginName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 缓存表: pluginName -&gt; fileName</span></span><br><span class="line">    <span class="keyword">synchronized</span> (Plugin.PLUGIN_NAME_2_FILENAME) &#123;</span><br><span class="line">        Plugin.PLUGIN_NAME_2_FILENAME.put(mPluginName, mPath);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 缓存表: fileName -&gt; PackageInfo</span></span><br><span class="line">    <span class="keyword">synchronized</span> (Plugin.FILENAME_2_PACKAGE_INFO) &#123;</span><br><span class="line">        Plugin.FILENAME_2_PACKAGE_INFO.put(mPath, <span class="keyword">new</span> WeakReference&lt;PackageInfo&gt;(mPackageInfo));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>解析组件信息，注册Plugin的Manifest中声明的BroadcastReceiver，调整组件的进程名及TaskAffinity。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (mComponents == <span class="keyword">null</span>) &#123;</span><br><span class="line">    mComponents = <span class="keyword">new</span> ComponentList(mPackageInfo, mPath, mPluginObj.mInfo);</span><br><span class="line">    <span class="comment">// 动态注册插件中声明的 receiver</span></span><br><span class="line">    regReceivers();</span><br><span class="line">    <span class="comment">// 缓存表Components</span></span><br><span class="line">    <span class="keyword">synchronized</span> (Plugin.FILENAME_2_COMPONENT_LIST) &#123;</span><br><span class="line">        Plugin.FILENAME_2_COMPONENT_LIST.put(mPath, <span class="keyword">new</span> WeakReference&lt;&gt;(mComponents));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* 只调整一次 */</span></span><br><span class="line">    <span class="comment">// 调整插件中组件的进程名称，详情见进程管理部分</span></span><br><span class="line">    adjustPluginProcess(mPackageInfo.applicationInfo);</span><br><span class="line">    <span class="comment">// 调整插件中Activity的TaskAffinity</span></span><br><span class="line">    adjustPluginTaskAffinity(mPluginName, mPackageInfo.applicationInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取Plugin的资源，先查找缓存，如果找不到就通过PackageManager创建Resources对象。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mPkgResources = Plugin.queryCachedResources(mPath);</span><br><span class="line"><span class="keyword">if</span> (mPkgResources == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (BuildConfig.DEBUG) &#123;</span><br><span class="line">            <span class="comment">// 如果是Debug模式的话，防止与Instant Run冲突，资源重新New一个</span></span><br><span class="line">            Resources r = pm.getResourcesForApplication(mPackageInfo.applicationInfo);</span><br><span class="line">            mPkgResources = <span class="keyword">new</span> Resources(r.getAssets(), r.getDisplayMetrics(), r.getConfiguration());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mPkgResources = pm.getResourcesForApplication(mPackageInfo.applicationInfo);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NameNotFoundException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 缓存Resources</span></span><br><span class="line">    <span class="keyword">synchronized</span> (Plugin.FILENAME_2_RESOURCES) &#123;</span><br><span class="line">        Plugin.FILENAME_2_RESOURCES.put(mPath, <span class="keyword">new</span> WeakReference&lt;&gt;(mPkgResources));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建Plugin的PluginDexClassLoader并将它缓存起来，不必每次都创建一个新的。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mClassLoader = Plugin.queryCachedClassLoader(mPath);</span><br><span class="line"><span class="keyword">if</span> (mClassLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">    String out = mPluginObj.mInfo.getDexParentDir().getPath();</span><br><span class="line">    ......</span><br><span class="line">    String soDir = mPackageInfo.applicationInfo.nativeLibraryDir;</span><br><span class="line">    <span class="comment">// 创建PluginDexClassLoader对象</span></span><br><span class="line">    mClassLoader = RePlugin.getConfig().getCallbacks().createPluginClassLoader(mPath, out, soDir, parent);   </span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">synchronized</span> (Plugin.FILENAME_2_DEX) &#123;</span><br><span class="line">        Plugin.FILENAME_2_DEX.put(mPath, <span class="keyword">new</span> WeakReference&lt;&gt;(mClassLoader)); <span class="comment">// 缓存ClassLoader</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>为Plugin创建一个全局的PluginContext，并用上面创建的ClassLoader以及Resources作为参数。而这个PluginContext对象会被赋值给Plugin的Application对象。其实每一个Plugin的Activity都会创建一个PluginContext对象，并使用相同的ClassLoader和Resources，因此在Plugin中就可以加载相关的类和使用资源了，跟原生程序一样。</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 此处mContext即是主程序Application</span></span><br><span class="line">mPkgContext = <span class="keyword">new</span> PluginContext(mContext, android.R.style.Theme,</span><br><span class="line">            mClassLoader, mPkgResources, mPluginName, <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="Plugin初始化"><a href="#Plugin初始化" class="headerlink" title="Plugin初始化"></a>Plugin初始化</h2><p>Dex文件加载完成以后，要运行Plugin还需要初始化Plugin的运行环境相关的类，在Plugin.doLoad的最后阶段调用了loadEntryLocked函数，这个函数负责初始化Plugin的运行环境。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">loadEntryLocked</span><span class="params">(PluginCommImpl manager)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mDummyPlugin) &#123;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mLoader.loadEntryMethod2()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mLoader.invoke2(manager)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mLoader.loadEntryMethod(<span class="keyword">false</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mLoader.invoke(manager)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mLoader.loadEntryMethod3()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mLoader.invoke2(manager)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Loader.loadEntryMethod3通过反射将Plugin中的Entry类的create函数对象得到并保存在mCreateMethod2中。注意这里的mClassLoader是插件的PluginDexClassLoader，所以才能得到插件中的类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">loadEntryMethod3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String className = <span class="string">&quot;com.qihoo360.replugin.Entry&quot;</span>;</span><br><span class="line">        mCreateMethod2 = c.getDeclaredMethod(<span class="string">&quot;create&quot;</span>, Factory.PLUGIN_ENTRY_EXPORT_METHOD2_PARAMS);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> mCreateMethod2 != <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">invoke2</span><span class="params">(PluginCommImpl x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        IBinder manager = <span class="keyword">null</span>; <span class="comment">// TODO</span></span><br><span class="line">        <span class="comment">// mPkgContext = new PluginContext(mContext, android.R.style.Theme, mClassLoader, mPkgResources, mPluginName, this);</span></span><br><span class="line">        IBinder b = (IBinder) mCreateMethod2.invoke(<span class="keyword">null</span>, mPkgContext, getClass().getClassLoader(), manager);</span><br><span class="line">        <span class="keyword">if</span> (b == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOGR) &#123;</span><br><span class="line">                LogRelease.e(PLUGIN_TAG, <span class="string">&quot;p.e.r.b n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mBinderPlugin = <span class="keyword">new</span> ProxyPlugin(b);</span><br><span class="line">        mPlugin = mBinderPlugin;</span><br><span class="line">        <span class="keyword">if</span> (LOG) &#123;</span><br><span class="line">            LogDebug.d(PLUGIN_TAG, <span class="string">&quot;Loader.invoke2(): plugin=&quot;</span> + mPath + <span class="string">&quot;, plugin.binder.cl=&quot;</span> + b.getClass().getClassLoader());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (LOGR) &#123;</span><br><span class="line">            LogRelease.e(PLUGIN_TAG, e.getMessage(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着Loader.invoke2函数会用反射的方式调用上面拿到的create函数。我们可以看看Plugin端的Entry.create方法，它有一个参数是ClassLoader，这个ClassLoader是Host中的RepluginClassLoader，有了它，Plugin才能找到Host当中的类并调用这些类的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> IBinder <span class="title">create</span><span class="params">(Context context, ClassLoader cl, IBinder manager)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 初始化一些代理类，这些代理类可以在Plugin中调用Host中的函数。</span></span><br><span class="line">    RePluginFramework.init(cl);</span><br><span class="line">    RePluginEnv.init(context, cl, manager);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> IPlugin.Stub() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IBinder <span class="title">query</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> RePluginServiceManager.getInstance().getService(name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RePluginEnv</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Context sPluginContext;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Context sHostContext;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ClassLoader sHostClassLoader;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IBinder sPluginManager;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context, ClassLoader cl, IBinder manager)</span> </span>&#123;</span><br><span class="line">        sPluginContext = context;</span><br><span class="line">        <span class="comment">// 确保获取的一定是主程序的Context</span></span><br><span class="line">        sHostContext = ((ContextWrapper) context).getBaseContext();</span><br><span class="line">        sHostClassLoader = cl;</span><br><span class="line">        <span class="comment">// 从宿主传过来的，目前恒为null</span></span><br><span class="line">        sPluginManager = manager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RePluginFramework.init</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">init</span><span class="params">(ClassLoader cl)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (LOCK) &#123;</span><br><span class="line">        <span class="keyword">return</span> initLocked(cl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">initLocked</span><span class="params">(ClassLoader cl)</span> </span>&#123;</span><br><span class="line">    RePluginInternal.ProxyRePluginInternalVar.initLocked(cl);</span><br><span class="line">    RePlugin.ProxyRePluginVar.initLocked(cl);</span><br><span class="line">    PluginLocalBroadcastManager.ProxyLocalBroadcastManagerVar.initLocked(cl);</span><br><span class="line">    PluginProviderClient.ProxyRePluginProviderClientVar.initLocked(cl);</span><br><span class="line">    PluginServiceClient.ProxyRePluginServiceClientVar.initLocked(cl);</span><br><span class="line">    IPC.ProxyIPCVar.initLocked(cl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此在Plugin中可以调用Host的一些方法，比如在Plugin中使用Replugin.startActivity时，实际上是通过MethodInvoker.call函数去执行Host中Replugin对应的startActivity函数。所以Plugin中的Replugin类的实现就只是一个空壳代理而已，可以看到它的实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">startActivity</span><span class="params">(Context context, Intent intent)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!RePluginFramework.mHostInitialized) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;  <span class="comment">// 用反射的方式调用Host中Replugin的startActivity函数来启动Activity</span></span><br><span class="line">        Object obj = ProxyRePluginVar.startActivity.call(<span class="keyword">null</span>, context, intent);</span><br><span class="line">        <span class="keyword">if</span> (obj != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> (Boolean) obj;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (LogDebug.LOG) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Host-Plugin类反射关系"><a href="#Host-Plugin类反射关系" class="headerlink" title="Host/Plugin类反射关系"></a>Host/Plugin类反射关系</h2><ul>
<li><code>RePluginInternal.ProxyRePluginInternalVar -&gt; com.qihoo360.i.Factory2/com.qihoo360.i.Factory</code>：Factory2中调用的是Host中PluginLibraryInternalProxy类中的方法。</li>
<li><code>RePlugin.ProxyRePluginVar -&gt; com.qihoo360.replugin.RePlugin</code>：即Host与Plugin中的RePlugin类对应。</li>
<li><code>PluginLocalBroadcastManager.ProxyLocalBroadcastManagerVar -&gt; android.support.v4.content.LocalBroadcastManager</code></li>
<li><code>PluginProviderClient.ProxyRePluginProviderClientVar -&gt; com.qihoo360.loader2.mgr.PluginProviderClient</code></li>
<li><code>PluginServiceClient.ProxyRePluginServiceClientVar -&gt; com.qihoo360.loader2.mgr.PluginServiceClient</code></li>
<li><code>IPC.ProxyIPCVar -&gt; com.qihoo360.replugin.base.IPC</code></li>
</ul>
<h2 id="插件中的Context"><a href="#插件中的Context" class="headerlink" title="插件中的Context"></a>插件中的Context</h2><p>首先看一下PluginContext类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginContext</span> <span class="keyword">extends</span> <span class="title">ContextThemeWrapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassLoader mNewClassLoader;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Resources mNewResources;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mPlugin;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Loader mLoader;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PluginContext</span><span class="params">(Context base, <span class="keyword">int</span> themeres, ClassLoader cl, Resources r, String plugin, Loader loader)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(base, themeres);</span><br><span class="line"></span><br><span class="line">        mNewClassLoader = cl;</span><br><span class="line">        mNewResources = r;</span><br><span class="line">        mPlugin = plugin;</span><br><span class="line">        mLoader = loader;</span><br><span class="line"></span><br><span class="line">        mContextInjector = RePlugin.getConfig().getCallbacks().createContextInjector();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Context <span class="title">getApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mLoader.mPluginObj.mInfo.getFrameworkVersion() &lt;= <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// 仅框架版本为3及以上的，才支持直接获取PluginContext，而非卫士ApplicationContext</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.getApplicationContext();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 直接获取插件的Application对象</span></span><br><span class="line">        <span class="comment">// entry中调用context.getApplicationContext时mApplicationClient还没被赋值，会导致空指针造成插件安装失败</span></span><br><span class="line">        <span class="keyword">if</span> (mLoader.mPluginObj.mApplicationClient == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> mLoader.mPluginObj.mApplicationClient.getObj();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!Factory2.startActivity(<span class="keyword">this</span>, intent)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mContextInjector != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mContextInjector.startActivityBefore(intent, options);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">super</span>.startActivity(intent, options);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mContextInjector != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mContextInjector.startActivityAfter(intent, options);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ComponentName <span class="title">startService</span><span class="params">(Intent service)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PluginContext类中也重写了startActivity等方法，最终走的也是RePlugin自定义的startActivity等方式。</p>
<p>在上述的loadAppPlugin方法中，实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> Plugin <span class="title">loadAppPlugin</span><span class="params">(String plugin)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> loadPlugin(mPlugins.get(plugin), Plugin.LOAD_APP, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> Plugin <span class="title">loadPlugin</span><span class="params">(Plugin p, <span class="keyword">int</span> loadType, <span class="keyword">boolean</span> useCache)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!p.load(loadType, useCache)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里调用了Plugin.load方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用来控制插件里的Application对象</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">PluginApplicationClient mApplicationClient;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Plugin.load</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">load</span><span class="params">(<span class="keyword">int</span> load, <span class="keyword">boolean</span> useCache)</span> </span>&#123;</span><br><span class="line">    PluginInfo info = mInfo;</span><br><span class="line">    <span class="keyword">boolean</span> rc = loadLocked(load, useCache); <span class="comment">//Plugin加载完成</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (load == LOAD_APP &amp;&amp; rc) &#123;</span><br><span class="line">        callApp();<span class="comment">// 关于Plugin的Application的操作都在这里了，调用了callAppLocked方法</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Plugin.callAppLocked</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callAppLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取并调用Application的几个核心方法</span></span><br><span class="line">    <span class="keyword">if</span> (!mDummyPlugin) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        mApplicationClient = PluginApplicationClient.getOrCreate(</span><br><span class="line">                mInfo.getName(), mLoader.mClassLoader, mLoader.mComponents, mLoader.mPluginObj.mInfo);  <span class="comment">// 创建Plugin的Appication对象</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mApplicationClient != <span class="keyword">null</span>) &#123; <span class="comment">// 调用Application.attach</span></span><br><span class="line">            mApplicationClient.callAttachBaseContext(mLoader.mPkgContext);</span><br><span class="line">            mApplicationClient.callOnCreate(); <span class="comment">//调用Application.onCreate</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PluginApplicationClient中的逻辑如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PluginApplicationClient <span class="title">getOrCreate</span><span class="params">(String pn, ClassLoader plgCL, ComponentList cl, PluginInfo pi)</span> </span>&#123;</span><br><span class="line">    PluginApplicationClient pac = getRunning(pn);</span><br><span class="line">    <span class="keyword">if</span> (pac != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 已经初始化过Application？直接返回</span></span><br><span class="line">        <span class="keyword">return</span> pac;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化所有需要反射的方法</span></span><br><span class="line">    <span class="comment">// sAttachBaseContextMethod = Application.class.getDeclaredMethod(&quot;attach&quot;, Context.class);</span></span><br><span class="line">    initMethods();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> PluginApplicationClient pacNew = <span class="keyword">new</span> PluginApplicationClient(plgCL, cl, pi);</span><br><span class="line">    <span class="keyword">if</span> (pacNew.isValid()) &#123;</span><br><span class="line">        sRunningClients.put(pn, <span class="keyword">new</span> WeakReference&lt;&gt;(pacNew));</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">14</span>) &#123;</span><br><span class="line">            RePluginInternal.getAppContext().registerComponentCallbacks(<span class="keyword">new</span> ComponentCallbacks2() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onTrimMemory</span><span class="params">(<span class="keyword">int</span> level)</span> </span>&#123;</span><br><span class="line">                    pacNew.callOnTrimMemory(level);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onConfigurationChanged</span><span class="params">(Configuration newConfig)</span> </span>&#123;</span><br><span class="line">                    pacNew.callOnConfigurationChanged(newConfig);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLowMemory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    pacNew.callOnLowMemory();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> pacNew;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Application对象没有初始化出来，则直接按失败处理</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">PluginApplicationClient</span><span class="params">(ClassLoader plgCL, ComponentList cl, PluginInfo pi)</span> </span>&#123;</span><br><span class="line">    mPlgClassLoader = plgCL;</span><br><span class="line">    mApplicationInfo = cl.getApplication();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 尝试使用自定义Application（如有）</span></span><br><span class="line">        <span class="keyword">if</span> (mApplicationInfo != <span class="keyword">null</span> &amp;&amp; !TextUtils.isEmpty(mApplicationInfo.className)) &#123;</span><br><span class="line">            <span class="comment">// 此处根据mApplicationInfo中的信息实例化了Plugin中自定义的Application类</span></span><br><span class="line">            <span class="comment">// 如果这个方法执行失败，则Plugin中自定义的Application回调方法不会走</span></span><br><span class="line">            initCustom();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 若自定义有误（或没有)，且框架版本为3及以上的，则可以创建空Application对象，方便插件getApplicationContext到自己</span></span><br><span class="line">        <span class="keyword">if</span> (!isValid() &amp;&amp; pi.getFrameworkVersion() &gt;= <span class="number">3</span>) &#123;</span><br><span class="line">            mApplication = <span class="keyword">new</span> Application();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        <span class="comment">// 出现异常，表示Application有问题</span></span><br><span class="line">        <span class="keyword">if</span> (BuildConfig.DEBUG) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        mApplication = <span class="keyword">new</span> Application();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Application <span class="title">getObj</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mApplication;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callAttachBaseContext</span><span class="params">(Context c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        sAttachBaseContextMethod.setAccessible(<span class="keyword">true</span>);   </span><br><span class="line">        sAttachBaseContextMethod.invoke(mApplication, c);  <span class="comment">// 将PluginContext对象传递给Application对象</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (BuildConfig.DEBUG) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callOnCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    mApplication.onCreate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Application.java</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    attachBaseContext(context);</span><br><span class="line">    mLoadedApk = ContextImpl.getImpl(context).mPackageInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里用一个PluginContext对象替换掉插件Application的Context对象，这个PluginContext对象就是在前面讲到的Dex加载过程中创建的，作为Plugin的全局Context。</p>
<p>实际上在Plugin中调用getApplication获取到的是Host的Application对象，因为别忘了我们是利用坑位原理运行插件组件的，所以在插件中我们用到的都是Host的Application，这里可以在<a target="_blank" rel="noopener" href="https://ljd1996.github.io/2020/03/18/Android-Activity%E5%8E%9F%E7%90%86/#performLaunchActivity">Activity启动的源码</a>调用中看出来：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Activity.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Application <span class="title">getApplication</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// mApplication在Activity#attach方法中赋值</span></span><br><span class="line">    <span class="keyword">return</span> mApplication;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    activity.attach(appContext, <span class="keyword">this</span>, getInstrumentation(), r.token,</span><br><span class="line">            r.ident, app, r.intent, r.activityInfo, title, r.parent,</span><br><span class="line">            r.embeddedID, r.lastNonConfigurationInstances, config,</span><br><span class="line">            r.referrer, r.voiceInteractor, window, r.configCallback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是万一Plugin的Application中有客户定制的任何动作要完成呢？所以在加载Plugin之后，Host也会通过反射创建Plugin的Application对象，并反射调用它的attach和create函数，并在PluginContext.getApplicationContext方法中返回这个Application对象。</p>
<p>在宿主中可以通过<code>RePlugin.fetchContext(String pluginName)</code>方法获取插件的Context：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Context <span class="title">fetchContext</span><span class="params">(String pluginName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Factory.queryPluginContext(pluginName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Context <span class="title">queryPluginContext</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sPluginManager.queryPluginContext(name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Context <span class="title">queryPluginContext</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    Plugin p = mPluginMgr.loadAppPlugin(name);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> p.mLoader.mPkgContext;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在插件中可以通过<code>RePlugin.fetchContext(String pluginName)</code>方法获取插件的Context，其实就是反射调用了宿主的<code>RePlugin.fetchContext(String pluginName)</code>方法。</p>
<p>在插件中可以通过<code>RePlugin.getHostContext()</code>方法获取宿主的Context：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Context <span class="title">getHostContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RePluginEnv.getHostContext();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在插件中可以通过<code>RePlugin.getPluginContext()</code>方法获取本插件的Context：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Context <span class="title">getPluginContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> RePluginEnv.getPluginContext();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="插件中启动Activity"><a href="#插件中启动Activity" class="headerlink" title="插件中启动Activity"></a>插件中启动Activity</h2><p>Android中Activity和Context都有startActivity函数，因为我们插件的组件在Host的Manifest中是没有声明的，只能通过坑位来启动，而启动坑位的动作只能在Host中完成。为了在插件中能正常启动Activity，我们要将这些函数都屏蔽掉，转而使用Replugin提供的startActivity。</p>
<p>replugin-plugin-gradle在编译阶段会将所有继承了Activity的类都被强制修改成继承PluginActivity，在上面已经给出过替换的对应规则。</p>
<p>首先PluginActivity重写了startActivity函数，并在其中通过反射调用Host中的Replugin.startActivity函数，这样就能做到在插件中启动Activity了。这里的反射调用指的就是调用前面讲过的RePlugin.ProxyRePluginVar类在初始化时得到的函数。</p>
<p>然后，PluginActivity重写了attachBaseContext函数，同样在代理类中通过反射调用Host中Factory2.createActivityContext函数创建一个PluginContext对象，并用这个对象替换掉原生的Context对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context newBase)</span> </span>&#123;</span><br><span class="line">    newBase = RePluginInternal.createActivityContext(<span class="keyword">this</span>, newBase); <span class="comment">//创建PluginContext对象</span></span><br><span class="line">    <span class="keyword">super</span>.attachBaseContext(newBase); <span class="comment">//替换原生的Context</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>PluginContext也重写了startActivity函数，并且在其中调用了Factory2.startActivity函数，接着又会调用PluginLibraryInternalProxy.startActivity。</p>
<p>另外，PluginApplicationClient为插件创建了Application对象，在PluginApplicationClient.callAttachBaseContext函数中通过反射调用Applicaiton.attach函数，用一个PluginContext对象替换掉原来Application的Context对象。</p>
<p>到这里我们在插件中就能正常的使用Replugin的启动流程在插件中启动Activity了。</p>
<h1 id="进程管理"><a href="#进程管理" class="headerlink" title="进程管理"></a>进程管理</h1><h2 id="初始化-1"><a href="#初始化-1" class="headerlink" title="初始化"></a>初始化</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IPC.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    sCurrentProcess = SysUtils.getCurrentProcessName();</span><br><span class="line">    sCurrentPid = Process.myPid();</span><br><span class="line">    sPackageName = context.getApplicationInfo().packageName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断是否使用“常驻进程”（见PERSISTENT_NAME）作为插件的管理进程</span></span><br><span class="line">    <span class="comment">// 并设置常驻进程名称，默认常驻进程名称是以:GuardService结尾的，可以通过</span></span><br><span class="line">    <span class="comment">// 宿主module下的build.gradle的repluginHostConfig&#123;&#125;中设置</span></span><br><span class="line">    <span class="keyword">if</span> (HostConfigHelper.PERSISTENT_ENABLE) &#123;</span><br><span class="line">        <span class="comment">// public static String PERSISTENT_NAME = &quot;:GuardService&quot;;</span></span><br><span class="line">        String cppn = HostConfigHelper.PERSISTENT_NAME;</span><br><span class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(cppn)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (cppn.startsWith(<span class="string">&quot;:&quot;</span>)) &#123;</span><br><span class="line">                sPersistentProcessName = sPackageName + cppn;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                sPersistentProcessName = cppn;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        sPersistentProcessName = sPackageName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sIsUIProcess = sCurrentProcess.equals(sPackageName);</span><br><span class="line">    sIsPersistentProcess = sCurrentProcess.equals(sPersistentProcessName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="进程分类"><a href="#进程分类" class="headerlink" title="进程分类"></a>进程分类</h2><p>先来看几个类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IPluginManager</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自动分配插件进程</span></span><br><span class="line">    <span class="keyword">int</span> PROCESS_AUTO = Integer.MIN_VALUE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// UI进程</span></span><br><span class="line">    <span class="keyword">int</span> PROCESS_UI = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 常驻进程</span></span><br><span class="line">    <span class="keyword">int</span> PROCESS_PERSIST = -<span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于在宿主中，处理插件自定义多进程相关业务</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginProcessHost</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 自定义插件的数量，暂时只支持3个自定义进程</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_COUNT = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自定义进程，int 标识，从 -100 开始，每次加 1；目前只支持 3 个进程，即到 -98</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PROCESS_INIT = -<span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插件中，进程名称后缀，进程名称类似 xxx.xx:p0, xxx.xx:p1, xxx.xx:p2</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PROCESS_PLUGIN_SUFFIX = <span class="string">&quot;p&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插件中，进程名称后缀（带冒号）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PROCESS_PLUGIN_SUFFIX2 = <span class="string">&quot;:&quot;</span> + PROCESS_PLUGIN_SUFFIX;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存进程后缀和其 Int 值，如：&#123;&quot;:p1&quot;:-99, &quot;:p2&quot;:-98&#125;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Integer&gt; PROCESS_INT_MAP = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存进程映射时，符号和实际进程名称的关系</span></span><br><span class="line"><span class="comment">     * 如：&#123;&quot;$p1&quot;:&quot;com.xx.xxx:p1&quot;, &quot;$p2&quot;:&quot;com.xx.xxx:p2&quot;&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, String&gt; PROCESS_ADJUST_MAP = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存进程 Int 值与对应 Provider 的 Authority 的关系</span></span><br><span class="line"><span class="comment">     * 如：&#123;-99:&quot;com.qihoo360.mobilesafe.Plugin.NP.1&quot;, -98:&quot;com.qihoo360.mobilesafe.Plugin.NP.2&quot;&#125;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> SparseArray&lt;String&gt; PROCESS_AUTHORITY_MAP = <span class="keyword">new</span> SparseArray&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PROCESS_COUNT; i++) &#123;</span><br><span class="line">            PROCESS_INT_MAP.put(PROCESS_PLUGIN_SUFFIX2 + i, PROCESS_INIT + i);</span><br><span class="line">            PROCESS_ADJUST_MAP.put(<span class="string">&quot;$&quot;</span> + PROCESS_PLUGIN_SUFFIX + i, IPC.getPackageName() + <span class="string">&quot;:&quot;</span> + PROCESS_PLUGIN_SUFFIX + i);</span><br><span class="line">            PROCESS_AUTHORITY_MAP.put(PROCESS_INIT + i, PluginPitProviderBase.AUTHORITY_PREFIX + i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取进程名称中，冒号及后面的部分，如果进程名中无冒号，则返回原值。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">processTail</span><span class="params">(String processName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> indexOfColon = processName.indexOf(<span class="string">&#x27;:&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (indexOfColon &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            processName = processName.toLowerCase();</span><br><span class="line">            <span class="keyword">return</span> processName.substring(indexOfColon);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> processName;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否是用户自定义的进程</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isCustomPluginProcess</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> index &gt;= PROCESS_INIT &amp;&amp; index &lt; PROCESS_INIT + PROCESS_COUNT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Constant.java</span></span><br><span class="line"><span class="comment">// Stub进程数</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STUB_PROCESS_COUNT = <span class="number">2</span>;</span><br><span class="line"><span class="comment">// Stub进程后缀</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String STUB_PROCESS_SUFFIX_PATTERN = <span class="string">&quot;^(.*):loader([0-&quot;</span> + (STUB_PROCESS_COUNT - <span class="number">1</span>) + <span class="string">&quot;])$&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// StubProcessManager.java</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> ProcessRecord STUB_PROCESSES[] = <span class="keyword">new</span> ProcessRecord[Constant.STUB_PROCESS_COUNT];</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; Constant.STUB_PROCESS_COUNT; i++) &#123;</span><br><span class="line">        ProcessRecord r = <span class="keyword">new</span> ProcessRecord(i, StubProcessState.STATE_UNUSED);</span><br><span class="line">        STUB_PROCESSES[i] = r;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PluginManager.java</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">isPluginProcess</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> index &gt;= <span class="number">0</span> &amp;&amp; index &lt; Constant.STUB_PROCESS_COUNT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>RePlugin中进程类别：</p>
<ul>
<li>UI进程：process = -1；</li>
<li>Persist进程：process = -1；</li>
<li>自定义进程(用户自定义进程)：process = -100~-98；</li>
<li>Stub进程(插件进程)：process = 0~1。</li>
</ul>
<h2 id="调整插件进程名称"><a href="#调整插件进程名称" class="headerlink" title="调整插件进程名称"></a>调整插件进程名称</h2><p>在第一次加载插件时，RePlugin会调整一次插件中进程的名称，用宿主中的进程坑位来接收插件中的自定义进程，如果插件中没有配置静态的<code>meta-data：process_map</code>进行静态的进程映射，则自动为插件中组件分配进程。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">adjustPluginProcess</span><span class="params">(ApplicationInfo appInfo)</span> </span>&#123;</span><br><span class="line">    HashMap&lt;String, String&gt; processMap = getConfigProcessMap(appInfo);</span><br><span class="line">    <span class="keyword">if</span> (processMap == <span class="keyword">null</span> || processMap.isEmpty()) &#123;</span><br><span class="line">        PluginInfo pi = MP.getPlugin(mPluginName, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (pi != <span class="keyword">null</span> &amp;&amp; pi.getFrameworkVersion() &gt;= <span class="number">4</span>) &#123;</span><br><span class="line">            processMap = genDynamicProcessMap();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    doAdjust(processMap, mComponents.getActivityMap());</span><br><span class="line">    doAdjust(processMap, mComponents.getServiceMap());</span><br><span class="line">    doAdjust(processMap, mComponents.getReceiverMap());</span><br><span class="line">    doAdjust(processMap, mComponents.getProviderMap());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> HashMap&lt;String, String&gt; <span class="title">getConfigProcessMap</span><span class="params">(ApplicationInfo appInfo)</span> </span>&#123;</span><br><span class="line">    HashMap&lt;String, String&gt; processMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    Bundle bdl = appInfo.metaData;</span><br><span class="line">    <span class="keyword">if</span> (bdl == <span class="keyword">null</span> || TextUtils.isEmpty(bdl.getString(<span class="string">&quot;process_map&quot;</span>))) &#123;</span><br><span class="line">        <span class="keyword">return</span> processMap;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String processMapStr = bdl.getString(<span class="string">&quot;process_map&quot;</span>);</span><br><span class="line">        JSONArray ja = <span class="keyword">new</span> JSONArray(processMapStr);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ja.length(); i++) &#123;</span><br><span class="line">            JSONObject jo = (JSONObject) ja.get(i);</span><br><span class="line">            <span class="keyword">if</span> (jo != <span class="keyword">null</span>) &#123;</span><br><span class="line">                String to = jo.getString(<span class="string">&quot;to&quot;</span>).toLowerCase();</span><br><span class="line">                <span class="keyword">if</span> (to.equals(<span class="string">&quot;$ui&quot;</span>)) &#123;</span><br><span class="line">                    to = IPC.getPackageName();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// 非 UI 进程，且是用户自定义的进程</span></span><br><span class="line">                    <span class="keyword">if</span> (to.contains(<span class="string">&quot;$&quot;</span> + PluginProcessHost.PROCESS_PLUGIN_SUFFIX)) &#123;</span><br><span class="line">                        to = PluginProcessHost.PROCESS_ADJUST_MAP.get(to);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                processMap.put(jo.getString(<span class="string">&quot;from&quot;</span>), to);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (JSONException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (BuildConfig.DEBUG) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> processMap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>getConfigProcessMap方法获取插件AndroidMainfest中配置的静态进程映射表meta-data：”process_map”。当配置如下时：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;process_map&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:value</span>=<span class="string">&quot;[</span></span></span><br><span class="line"><span class="tag"><span class="string">    &#123;&#x27;from&#x27;:&#x27;com.hearing.plugin1:activity1&#x27;, &#x27;to&#x27;:&#x27;$ui&#x27;&#125;,</span></span></span><br><span class="line"><span class="tag"><span class="string">    &#123;&#x27;from&#x27;:&#x27;com.hearing.plugin1:activity2&#x27;, &#x27;to&#x27;:&#x27;$p1&#x27;&#125;,</span></span></span><br><span class="line"><span class="tag"><span class="string">    &#123;&#x27;from&#x27;:&#x27;com.hearing.plugin1:activity3&#x27;, &#x27;to&#x27;:&#x27;$p0&#x27;&#125;,</span></span></span><br><span class="line"><span class="tag"><span class="string">    &#123;&#x27;from&#x27;:&#x27;com.hearing.plugin1:activity4&#x27;, &#x27;to&#x27;:&#x27;$p2&#x27;&#125;,</span></span></span><br><span class="line"><span class="tag"><span class="string">    &#123;&#x27;from&#x27;:&#x27;com.hearing.plugin1:activity5&#x27;, &#x27;to&#x27;:&#x27;$p3&#x27;&#125;,</span></span></span><br><span class="line"><span class="tag"><span class="string">    ]&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>getConfigProcessMap返回如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">com.hearing.plugin1:activity1 -&gt; com.hearing.host</span><br><span class="line">com.hearing.plugin1:activity2 -&gt; com.hearing.host:p1</span><br><span class="line">com.hearing.plugin1:activity3 -&gt; com.hearing.host:p0</span><br><span class="line">com.hearing.plugin1:activity4 -&gt; com.hearing.host:p2</span><br><span class="line">com.hearing.plugin1:activity5 -&gt; <span class="keyword">null</span></span><br></pre></td></tr></table></figure>

<p>静态/动态配置源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> HashMap&lt;String, String&gt; <span class="title">genDynamicProcessMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    HashMap&lt;String, String&gt; processMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    List&lt;String&gt; hostProcessList = getHostProcessList();</span><br><span class="line">    List&lt;String&gt; pluginProcessList = getPluginProcessList();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> hostProcessCount = hostProcessList != <span class="keyword">null</span> ? hostProcessList.size() : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hostProcessCount &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> processMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> pluginProcessCount = pluginProcessList != <span class="keyword">null</span> ? pluginProcessList.size() : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pluginProcessCount; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> hostProcessIndex = i % hostProcessCount;</span><br><span class="line">        processMap.put(pluginProcessList.get(i), hostProcessList.get(hostProcessIndex));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> processMap;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取宿主中可分配的自定义进程列表</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">getHostProcessList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; pluginProcessList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; PluginProcessHost.PROCESS_COUNT; i++) &#123;</span><br><span class="line">        pluginProcessList.add(IPC.getPackageName() + PluginProcessHost.PROCESS_PLUGIN_SUFFIX2 + i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> pluginProcessList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取插件中自定义进程列表</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">getPluginProcessList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Set&lt;String&gt; processSet = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    String pluginUIProcess = mComponents.getApplication().packageName;</span><br><span class="line"></span><br><span class="line">    getPluginProcess(processSet, mComponents.getProviders());</span><br><span class="line">    getPluginProcess(processSet, mComponents.getActivities());</span><br><span class="line">    getPluginProcess(processSet, mComponents.getServices());</span><br><span class="line">    getPluginProcess(processSet, mComponents.getReceivers());</span><br><span class="line"></span><br><span class="line">    processSet.remove(pluginUIProcess);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Arrays.asList(processSet.toArray(<span class="keyword">new</span> String[<span class="number">0</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getPluginProcess</span><span class="params">(Set&lt;String&gt; processSet, ComponentInfo[] componentInfos)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (componentInfos != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (ComponentInfo componentInfo : componentInfos) &#123;</span><br><span class="line">            processSet.add(componentInfo.processName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAdjust</span><span class="params">(HashMap&lt;String, String&gt; processMap, HashMap&lt;String, ? extends ComponentInfo&gt; infos)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (processMap == <span class="keyword">null</span> || processMap.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (HashMap.Entry&lt;String, ? extends ComponentInfo&gt; entry : infos.entrySet()) &#123;</span><br><span class="line">        ComponentInfo info = entry.getValue();</span><br><span class="line">        <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</span><br><span class="line">            String targetProcess = processMap.get(info.processName);</span><br><span class="line">            <span class="keyword">if</span> (!TextUtils.isEmpty(targetProcess)) &#123;</span><br><span class="line">                info.processName = targetProcess;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="请求进程：loadPluginActivity"><a href="#请求进程：loadPluginActivity" class="headerlink" title="请求进程：loadPluginActivity"></a>请求进程：loadPluginActivity</h2><p>在插件的Activity启动过程中，会调用loadPluginActivity方法(删减)，该方法会先启动目标进程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PluginCommImpl.java</span></span><br><span class="line"><span class="comment">// process = IPluginManager.PROCESS_AUTO</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ComponentName <span class="title">loadPluginActivity</span><span class="params">(Intent intent, String plugin, String activity, <span class="keyword">int</span> process)</span> </span>&#123;</span><br><span class="line">    PluginBinderInfo info = <span class="keyword">new</span> PluginBinderInfo(PluginBinderInfo.ACTIVITY_REQUEST);</span><br><span class="line">    ActivityInfo ai = getActivityInfo(plugin, activity, intent);</span><br><span class="line">    <span class="keyword">if</span> (ai.processName != <span class="keyword">null</span>) &#123;</span><br><span class="line">        process = PluginClientHelper.getProcessInt(ai.processName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 容器选择（启动目标进程）</span></span><br><span class="line">    IPluginClient client = MP.startPluginProcess(plugin, process, info);</span><br><span class="line">    container = client.allocActivityContainer(plugin, process, ai.name, intent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过插件中的进程映射，得到自定义的进程号</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title">getProcessInt</span><span class="params">(String processName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(processName)) &#123;</span><br><span class="line">        <span class="comment">// 插件若想将组件定义成在&quot;常驻进程&quot;中运行，则可以在android:process中定义：</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. （推荐）&quot;:GuardService&quot;。这样无论宿主的常驻进程名是什么，都会定向到&quot;常驻进程&quot;</span></span><br><span class="line">        String pntl = processName.toLowerCase();</span><br><span class="line">        String ppdntl = HostConfigHelper.PERSISTENT_NAME.toLowerCase();</span><br><span class="line">        <span class="keyword">if</span> (pntl.contains(ppdntl)) &#123;</span><br><span class="line">            <span class="keyword">return</span> IPluginManager.PROCESS_PERSIST;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 和宿主常驻进程名相同，这样也会定向到&quot;常驻进程&quot;，但若移植到其它宿主上则会出现问题</span></span><br><span class="line">        String ppntl = IPC.getPersistentProcessName().toLowerCase();</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.equals(pntl, ppntl)) &#123;</span><br><span class="line">            <span class="keyword">return</span> IPluginManager.PROCESS_PERSIST;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 用户自定义进程时，从 Map 中取数据</span></span><br><span class="line">        <span class="comment">// 取进程名称中，冒号及后面的部分，如果进程名中无冒号，则返回原值。</span></span><br><span class="line">        processName = PluginProcessHost.processTail(processName.toLowerCase());</span><br><span class="line">        <span class="keyword">if</span> (PROCESS_INT_MAP.containsKey(processName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> PROCESS_INT_MAP.get(processName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> IPluginManager.PROCESS_UI;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="常驻进程：启动目标进程"><a href="#常驻进程：启动目标进程" class="headerlink" title="常驻进程：启动目标进程"></a>常驻进程：启动目标进程</h2><h3 id="startPluginProcess"><a href="#startPluginProcess" class="headerlink" title="startPluginProcess"></a>startPluginProcess</h3><p>通过Binder调用，启动插件进程的工作交由常驻进程完成。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MP.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> IPluginClient <span class="title">startPluginProcess</span><span class="params">(String plugin, <span class="keyword">int</span> process, PluginBinderInfo info)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> PluginProcessMain.getPluginHost().startPluginProcess(plugin, process, info);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PmHostSvc</span> <span class="keyword">extends</span> <span class="title">IPluginHost</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IPluginClient <span class="title">startPluginProcess</span><span class="params">(String plugin, <span class="keyword">int</span> process, PluginBinderInfo info)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mPluginMgr.startPluginProcessLocked(plugin, process, info);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Pmbase.java</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> IPluginClient <span class="title">startPluginProcessLocked</span><span class="params">(String plugin, <span class="keyword">int</span> process, PluginBinderInfo info)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 强制使用UI进程</span></span><br><span class="line">    <span class="keyword">if</span> (Constant.ENABLE_PLUGIN_ACTIVITY_AND_BINDER_RUN_IN_MAIN_UI_PROCESS) &#123;</span><br><span class="line">        <span class="keyword">if</span> (info.request == PluginBinderInfo.ACTIVITY_REQUEST) &#123;</span><br><span class="line">            <span class="keyword">if</span> (process == IPluginManager.PROCESS_AUTO) &#123;</span><br><span class="line">                process = IPluginManager.PROCESS_UI;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (info.request == PluginBinderInfo.BINDER_REQUEST) &#123;</span><br><span class="line">            <span class="keyword">if</span> (process == IPluginManager.PROCESS_AUTO) &#123;</span><br><span class="line">                process = IPluginManager.PROCESS_UI;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    StubProcessManager.schedulePluginProcessLoop(StubProcessManager.CHECK_STAGE1_DELAY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取</span></span><br><span class="line">    IPluginClient client = PluginProcessMain.probePluginClient(plugin, process, info);</span><br><span class="line">    <span class="keyword">if</span> (client != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> client;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 分配</span></span><br><span class="line">    <span class="keyword">int</span> index = IPluginManager.PROCESS_AUTO;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        index = PluginProcessMain.allocProcess(plugin, process);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 分配的坑位不属于UI、自定义进程或Stub坑位进程，就返回。（没找到有效进程）</span></span><br><span class="line">    <span class="keyword">if</span> (!(index == IPluginManager.PROCESS_UI</span><br><span class="line">            || PluginProcessHost.isCustomPluginProcess(index)</span><br><span class="line">            || PluginManager.isPluginProcess(index))) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动</span></span><br><span class="line">    <span class="keyword">boolean</span> rc = PluginProviderStub.proxyStartPluginProcess(mContext, index);</span><br><span class="line">    <span class="keyword">if</span> (!rc) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 再次获取</span></span><br><span class="line">    client = PluginProcessMain.probePluginClient(plugin, process, info);</span><br><span class="line">    <span class="keyword">if</span> (client == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> client;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PluginProcessMain-allocProcess"><a href="#PluginProcessMain-allocProcess" class="headerlink" title="PluginProcessMain.allocProcess"></a>PluginProcessMain.allocProcess</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PLUGIN_NAME_UI = &quot;ui&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">allocProcess</span><span class="params">(String plugin, <span class="keyword">int</span> process)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (Constant.PLUGIN_NAME_UI.equals(plugin) || process == IPluginManager.PROCESS_UI) &#123;</span><br><span class="line">        <span class="keyword">return</span> IPluginManager.PROCESS_UI;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (PluginProcessHost.isCustomPluginProcess(process)) &#123;</span><br><span class="line">        <span class="keyword">return</span> process;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    PluginInfo info = PluginTable.getPluginInfo(plugin);</span><br><span class="line">    <span class="keyword">if</span> (info == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> IPluginManager.PROCESS_AUTO;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> StubProcessManager.allocProcess(plugin);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是Stub进程的分配：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">allocProcess</span><span class="params">(String plugin)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 取运行列表</span></span><br><span class="line">    List&lt;ActivityManager.RunningAppProcessInfo&gt; processes = AMSUtils.getRunningAppProcessesNoThrows(RePluginInternal.getAppContext());</span><br><span class="line">    <span class="comment">// 取运行列表失败，则直接返回失败</span></span><br><span class="line">    <span class="keyword">if</span> (processes == <span class="keyword">null</span> || processes.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> IPluginManager.PROCESS_AUTO;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 根据优先级分配坑位进程</span></span><br><span class="line">    <span class="keyword">int</span> prevMatchPriority = -<span class="number">1</span>; <span class="comment">// 临时变量，保存上一个ProcessRecord的进程分配优先级</span></span><br><span class="line">    ProcessRecord selectRecord = <span class="keyword">null</span>; <span class="comment">// 被选中的坑位进程</span></span><br><span class="line">    <span class="keyword">for</span> (ProcessRecord r : STUB_PROCESSES) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (r) &#123;</span><br><span class="line">            <span class="keyword">if</span> (r.calculateMatchPriority(plugin) &gt; prevMatchPriority) &#123;</span><br><span class="line">                prevMatchPriority = r.calculateMatchPriority(plugin);</span><br><span class="line">                selectRecord = r;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (r.calculateMatchPriority(plugin) == prevMatchPriority) &#123;</span><br><span class="line">                <span class="keyword">if</span> (r.mobified &lt; selectRecord.mobified) &#123;</span><br><span class="line">                    selectRecord = r;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (selectRecord == <span class="keyword">null</span>) &#123; <span class="comment">// 不应该出现</span></span><br><span class="line">        <span class="keyword">return</span> IPluginManager.PROCESS_AUTO;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">synchronized</span> (selectRecord)&#123;</span><br><span class="line">        <span class="comment">// 插件已在分配进程中运行，直接返回</span></span><br><span class="line">        <span class="keyword">if</span> (selectRecord.calculateMatchPriority(plugin) == Integer.MAX_VALUE &amp;&amp; (selectRecord.state == StubProcessState.STATE_ALLOCATED || selectRecord.state == StubProcessState.STATE_RUNNING))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> selectRecord.index;</span><br><span class="line">        &#125;</span><br><span class="line">        selectRecord.resetAllocate(plugin, processes);</span><br><span class="line">        <span class="keyword">return</span> selectRecord.index;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">calculateMatchPriority</span><span class="params">(String newPluginName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> priority = Integer.MAX_VALUE;</span><br><span class="line">    <span class="keyword">if</span> (TextUtils.equals(newPluginName, plugin)) &#123; <span class="comment">// 插件可能用过的进程</span></span><br><span class="line">        <span class="keyword">return</span> priority;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (state == StubProcessState.STATE_UNUSED) &#123; <span class="comment">// 空闲的进程</span></span><br><span class="line">        priority = Integer.MAX_VALUE - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> priority;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (state == StubProcessState.STATE_STOPED) &#123; <span class="comment">// 已停止的进程</span></span><br><span class="line">        priority = Integer.MAX_VALUE - <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">return</span> priority;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((System.currentTimeMillis() - mobified) &gt; <span class="number">10</span> * <span class="number">1000</span>) &#123; <span class="comment">// 分配时间超过10秒的</span></span><br><span class="line">        priority = Integer.MAX_VALUE - <span class="number">3</span>;</span><br><span class="line">        <span class="keyword">return</span> priority;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((activities &lt;= <span class="number">0</span>) &amp;&amp; (services &lt;= <span class="number">0</span>) &amp;&amp; (binders &lt;= <span class="number">0</span>)) &#123; <span class="comment">// 组件为空的</span></span><br><span class="line">        priority = Integer.MAX_VALUE - <span class="number">4</span>;</span><br><span class="line">        <span class="keyword">return</span> priority;</span><br><span class="line">    &#125;</span><br><span class="line">    priority = <span class="number">0</span>; <span class="comment">// 默认值</span></span><br><span class="line">    <span class="keyword">return</span> priority;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessRecord</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">resetAllocate</span><span class="params">(String plugin, List&lt;ActivityManager.RunningAppProcessInfo&gt; processes)</span> </span>&#123;</span><br><span class="line">        killProcess(processes);</span><br><span class="line">        allocate(plugin);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">allocate</span><span class="params">(String plugin)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.state = StubProcessState.STATE_ALLOCATED;</span><br><span class="line">        <span class="keyword">this</span>.mobified = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">this</span>.plugin = plugin;</span><br><span class="line">        <span class="keyword">this</span>.pid = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.binder = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">this</span>.client = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">this</span>.activities = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.services = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>.binders = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PluginProviderStub-proxyStartPluginProcess"><a href="#PluginProviderStub-proxyStartPluginProcess" class="headerlink" title="PluginProviderStub.proxyStartPluginProcess"></a>PluginProviderStub.proxyStartPluginProcess</h3><p>PluginProviderStub.proxyStartPluginProcess方法用于启动进程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">proxyStartPluginProcess</span><span class="params">(Context context, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    ContentValues values = <span class="keyword">new</span> ContentValues();</span><br><span class="line">    values.put(KEY_METHOD, METHOD_START_PROCESS);</span><br><span class="line">    values.put(KEY_COOKIE, PMF.sPluginMgr.mLocalCookie);</span><br><span class="line">    Uri uri = context.getContentResolver().insert(ProcessPitProviderBase.buildUri(index), values);</span><br><span class="line">    <span class="keyword">if</span> (uri == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessPitProviderBase</span> <span class="keyword">extends</span> <span class="title">ContentProvider</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;ProviderBase&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTHORITY_PREFIX = IPC.getPackageName() + <span class="string">&quot;.loader.p.main&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Uri <span class="title">buildUri</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">        String str = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (index &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            str += <span class="string">&quot;N&quot;</span>;</span><br><span class="line">            index *= -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        str += index;</span><br><span class="line">        Uri uri = Uri.parse(<span class="string">&quot;content://&quot;</span> + AUTHORITY_PREFIX + str + <span class="string">&quot;/main&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (BuildConfig.DEBUG) &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;buildUri: uri=&quot;</span> + uri);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> uri;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Cursor <span class="title">query</span><span class="params">(Uri uri, String[] projection, String selection, String[] selectionArgs, String sortOrder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Uri uri, ContentValues values, String selection, String[] selectionArgs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Uri <span class="title">insert</span><span class="params">(Uri uri, ContentValues values)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> PluginProviderStub.stubPlugin(uri, values);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(Uri uri, String selection, String[] selectionArgs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ProcessPitProviderBase有几个空子类，host gradle插件会将这些空子类注册在对应的进程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ContentProvider (android.content)</span><br><span class="line">    ProcessPitProviderBase (com.qihoo360.replugin.component.process)</span><br><span class="line">        ProcessPitProviderUI (com.qihoo360.replugin.component.process)</span><br><span class="line">        ProcessPitProviderP0 (com.qihoo360.replugin.component.process)</span><br><span class="line">        ProcessPitProviderLoader1 (com.qihoo360.replugin.component.process)</span><br><span class="line">        ProcessPitProviderLoader0 (com.qihoo360.replugin.component.process)</span><br><span class="line">        ProcessPitProviderP2 (com.qihoo360.replugin.component.process)</span><br><span class="line">        ProcessPitProviderP1 (com.qihoo360.replugin.component.process)</span><br></pre></td></tr></table></figure>

<p>将host apk解包可以看到：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;com.qihoo360.replugin.component.process.ProcessPitProviderUI&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:authorities</span>=<span class="string">&quot;com.hearing.host.loader.p.mainN1&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;com.qihoo360.replugin.component.process.ProcessPitProviderP1&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:process</span>=<span class="string">&quot;:p1&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:authorities</span>=<span class="string">&quot;com.hearing.host.loader.p.mainN99&quot;</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!--  --&gt;</span></span><br></pre></td></tr></table></figure>

<p>通过调用注册在指定进程的ContentProvider的insert方法，如果目标进程没有被启动，则会被先启动，然后执行insert方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PluginProviderStub.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Uri <span class="title">stubPlugin</span><span class="params">(Uri uri, ContentValues values)</span> </span>&#123;</span><br><span class="line">    String method = values.getAsString(KEY_METHOD);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (TextUtils.equals(method, METHOD_START_PROCESS)) &#123;</span><br><span class="line">        Uri rc = <span class="keyword">new</span> Uri.Builder().scheme(<span class="string">&quot;content&quot;</span>).authority(<span class="string">&quot;process&quot;</span>).encodedPath(<span class="string">&quot;status&quot;</span>).encodedQuery(URL_PARAM_KEY_LOADED + <span class="string">&quot;=&quot;</span> + <span class="number">1</span>).build();</span><br><span class="line">        <span class="keyword">long</span> cookie = values.getAsLong(KEY_COOKIE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 首次</span></span><br><span class="line">        <span class="keyword">if</span> (PMF.sPluginMgr.mLocalCookie == <span class="number">0L</span>) &#123;</span><br><span class="line">            PMF.sPluginMgr.mLocalCookie = cookie;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 常驻进程重新启动了</span></span><br><span class="line">            <span class="keyword">if</span> (PMF.sPluginMgr.mLocalCookie != cookie) &#123;</span><br><span class="line">                PMF.sPluginMgr.mLocalCookie = cookie;</span><br><span class="line">                PluginProcessMain.connectToHostSvc();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> rc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>借用ContentProvider，目标进程就被启动了，然后在目标进程中通过<code>PluginProcessMain.connectToHostSvc()</code>获取常驻进程的IPluginHost的Binder对象，用来进行IPC调用。</p>
<h3 id="PluginProcessMain-probePluginClient"><a href="#PluginProcessMain-probePluginClient" class="headerlink" title="PluginProcessMain.probePluginClient"></a>PluginProcessMain.probePluginClient</h3><p><code>PluginProcessMain.probePluginClient</code>方法用来获取IPluginClient对象，其实现是PluginProcessPer类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当前运行的所有进程的列表（常驻进程除外）</span></span><br><span class="line"><span class="comment">// 在目标进程启动后，PluginProcessMain.connectToHostSvc()方法中会将ProcessClientRecord插入ALL中</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, ProcessClientRecord&gt; ALL = <span class="keyword">new</span> HashMap&lt;String, ProcessClientRecord&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">final</span> IPluginClient <span class="title">probePluginClient</span><span class="params">(<span class="keyword">final</span> String plugin, <span class="keyword">final</span> <span class="keyword">int</span> process, <span class="keyword">final</span> PluginBinderInfo info)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> readProcessClientLock(<span class="keyword">new</span> Action&lt;IPluginClient&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IPluginClient <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (ProcessClientRecord r : ALL.values()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (process == IPluginManager.PROCESS_UI) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!TextUtils.equals(r.plugin, Constant.PLUGIN_NAME_UI)) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">/* 是否是用户自定义进程 */</span></span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (PluginProcessHost.isCustomPluginProcess(process)) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!TextUtils.equals(r.plugin, getProcessStringByIndex(process))) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!TextUtils.equals(r.plugin, plugin)) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!isBinderAlive(r)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!r.binder.pingBinder()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                info.pid = r.pid;</span><br><span class="line">                info.index = r.index;</span><br><span class="line">                <span class="keyword">return</span> r.client;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="图解"><a href="#图解" class="headerlink" title="图解"></a>图解</h2><p><img src="%E8%87%AA%E5%AE%9A%E4%B9%89%E8%BF%9B%E7%A8%8BActivity.webp" alt="自定义进程Activity"></p>
<ol>
<li>在宿主中或插件中，通过RePlugin.startActivity()启动插件中的Activity，会先入常驻进程（或者叫插件管理进程）。</li>
<li>在插件管理进程中，插件管理器，会为该Activity分配一个目标进程。并启动该目标进程(通过ContentProvider)。</li>
<li>在插件管理进程中，通过Binder调用，使用目标进程留在插件管理进程中的Binder代理，在目标进程中为该Activity动态分配坑位（每个进程中独立管理自己的Activity坑位信息，此时该坑位Activity还没有被AMS打开）。</li>
<li>把在目标进程中分配好的Activity坑位信息返回给调用方。</li>
<li>调用者获取到了一个坑位Activity，然后会把这个坑位Activity（带着自定义进程标签），会交给AMS，由于AMS去启动。</li>
<li>通过类加载器机制，加载插件Activity类。</li>
</ol>
<h1 id="插件-宿主间Binder"><a href="#插件-宿主间Binder" class="headerlink" title="插件/宿主间Binder"></a>插件/宿主间Binder</h1><p><strong>宿主RePlugin类中，在宿主内注册一个可被其它插件所获取的Binder的对象：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerHostBinder</span><span class="params">(IHostBinderFetcher hbf)</span> </span>&#123;</span><br><span class="line">    MP.installBuiltinPlugin(<span class="string">&quot;main&quot;</span>, hbf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">installBuiltinPlugin</span><span class="params">(String name, IHostBinderFetcher p)</span> </span>&#123;</span><br><span class="line">    PMF.sPluginMgr.installBuiltinPlugin(name, p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;String, IHostBinderFetcher&gt; mBuiltinPlugins;</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">installBuiltinPlugin</span><span class="params">(String name, IHostBinderFetcher p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mBuiltinPlugins) &#123;</span><br><span class="line">        mBuiltinPlugins.put(name, p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>获取上面的Binder对象：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IBinder <span class="title">fetchBinder</span><span class="params">(String pluginName, String <span class="keyword">module</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Factory.query(pluginName, <span class="keyword">module</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> IBinder <span class="title">query</span><span class="params">(String name, String binder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sPluginManager.query(name, binder);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> IBinder <span class="title">query</span><span class="params">(String name, String binder)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 先用仿插件对象判断</span></span><br><span class="line">    &#123;</span><br><span class="line">        IHostBinderFetcher p = mPluginMgr.getBuiltinPlugin(name);</span><br><span class="line">        <span class="keyword">if</span> (p != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOG) &#123;</span><br><span class="line">                LogDebug.d(PLUGIN_TAG, <span class="string">&quot;use buildin plugin&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> p.query(binder);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Plugin p = mPluginMgr.loadAppPlugin(name);</span><br><span class="line">    <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> p.query(binder);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> IHostBinderFetcher <span class="title">getBuiltinPlugin</span><span class="params">(String plugin)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mBuiltinPlugins) &#123;</span><br><span class="line">        <span class="keyword">return</span> mBuiltinPlugins.get(plugin);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注册一个无需插件名，可被全局使用的Binder对象：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">registerGlobalBinder</span><span class="params">(String name, IBinder binder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> QihooServiceManager.addService(RePluginInternal.getAppContext(), name, binder);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">addService</span><span class="params">(Context context, String serviceName, IBinder service)</span> </span>&#123;</span><br><span class="line">    IServiceChannel serviceChannel = getServerChannel(context);</span><br><span class="line">    <span class="keyword">if</span> (serviceChannel == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        serviceChannel.addService(serviceName, service);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> IServiceChannel <span class="title">getServerChannel</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    IServiceChannel serviceChannel = <span class="keyword">null</span>;</span><br><span class="line">    Cursor cursor = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        cursor = context.getContentResolver().query(getServiceChannelUri(), <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        IBinder binder = ServiceChannelCursor.getBinder(cursor);</span><br><span class="line">        serviceChannel = IServiceChannel.Stub.asInterface(binder);</span><br><span class="line">        sServerChannel = serviceChannel;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> serviceChannel;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceProvider</span> <span class="keyword">extends</span> <span class="title">ContentProvider</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Cursor <span class="title">query</span><span class="params">(Uri uri, String[] projection, String selection, String[] selectionArgs, String sortOrder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ServiceChannelImpl.sServiceChannelCursor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sServiceChannelCursor对象实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> IServiceChannel.Stub sServiceChannelImpl = <span class="keyword">new</span> IServiceChannel.Stub() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">getService</span><span class="params">(String serviceName)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        IBinder service = sServices.get(serviceName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 若没有注册此服务，则尝试从“延迟IBinder”中获取</span></span><br><span class="line">        <span class="keyword">if</span> (service == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> fetchFromDelayedMap(serviceName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断Binder是否挂掉</span></span><br><span class="line">        <span class="keyword">if</span> (!service.isBinderAlive() || !service.pingBinder()) &#123;</span><br><span class="line">            sServices.remove(serviceName);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> service;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addService</span><span class="params">(String serviceName, IBinder service)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        sServices.put(serviceName, service);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeService</span><span class="params">(String serviceName)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        sServices.remove(serviceName);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> MatrixCursor sServiceChannelCursor = ServiceChannelCursor.makeCursor(sServiceChannelImpl);</span><br></pre></td></tr></table></figure>

<p><strong>获取上面的全局Binder：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IBinder <span class="title">getGlobalBinder</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> QihooServiceManager.getService(RePluginInternal.getAppContext(), name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在插件RePlugin中调用的是反射宿主中的方法。</p>
<h1 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RePlugin</span></span><br><span class="line"><span class="comment">// 加载插件，并获取插件的资源信息</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Resources <span class="title">fetchResources</span><span class="params">(String pluginName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Factory.queryPluginResouces(pluginName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里插件的 Resources 是通过如下代码获取的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mPackageInfo = pm.getPackageArchiveInfo(mPath, PackageManager.GET_ACTIVITIES | PackageManager.GET_SERVICES | PackageManager.GET_PROVIDERS | PackageManager.GET_RECEIVERS | PackageManager.GET_META_DATA);</span><br><span class="line">mPackageInfo.applicationInfo.sourceDir = mPath;</span><br><span class="line">mPackageInfo.applicationInfo.publicSourceDir = mPath;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (TextUtils.isEmpty(mPackageInfo.applicationInfo.processName)) &#123;</span><br><span class="line">    mPackageInfo.applicationInfo.processName = mPackageInfo.applicationInfo.packageName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mPkgResources = pm.getResourcesForApplication(mPackageInfo.applicationInfo);</span><br></pre></td></tr></table></figure>

<p>拿到 Resources 后即可通过 Resources.getIdentifier() 方法拿到资源 id 了。</p>
<p>可以自己尝试用这种方式加载未安装 apk 中的资源：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">PackageInfo packageInfo = getPackageManager().getPackageArchiveInfo(APK_PATH, PackageManager.GET_ACTIVITIES);</span><br><span class="line">packageInfo.applicationInfo.sourceDir = APK_PATH;</span><br><span class="line">packageInfo.applicationInfo.publicSourceDir = APK_PATH;</span><br><span class="line"><span class="keyword">if</span> (TextUtils.isEmpty(packageInfo.applicationInfo.processName)) &#123;</span><br><span class="line">    packageInfo.applicationInfo.processName = packageInfo.applicationInfo.packageName;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Resources resources = getPackageManager().getResourcesForApplication(packageInfo.applicationInfo);</span><br><span class="line">    <span class="keyword">int</span> drawable = resources.getIdentifier(<span class="string">&quot;mytest&quot;</span>, <span class="string">&quot;drawable&quot;</span>, packageInfo.packageName);</span><br><span class="line">    ImageView imageView = findViewById(R.id.image_view);</span><br><span class="line">    imageView.setImageDrawable(resources.getDrawable(drawable));</span><br><span class="line"><span class="comment">//    imageView.setImageResource(drawable); // 加载不了</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 RePlugin 中都是通过指定插件名去获取对应插件里的资源的，并没有直接查询所有插件的 Resource 中的资源，插件资源之间比较独立，因此不存在插件之间资源 id 冲突的问题，也就不需要修改 aapt 的方式解决资源冲突。</p>
<h1 id="replugin-host-gradle-1"><a href="#replugin-host-gradle-1" class="headerlink" title="replugin-host-gradle"></a>replugin-host-gradle</h1><h2 id="概述-3"><a href="#概述-3" class="headerlink" title="概述"></a>概述</h2><p>replugin-host-gradle 是 RePlugin 插件框架中的宿主gradle插件，主要用于在宿主应用的编译期常规构建任务流中，插入一些定制化的构建任务，以便实现自动化编译期修改宿主应用的目的。</p>
<ul>
<li>生成带 RePlugin 插件坑位的 AndroidManifest.xml（允许自定义数量）</li>
<li>生成 RepluginHostConfig 类，方便插件框架读取并自定义其属性</li>
<li>生成 plugins-builtin.json，json中含有插件应用的信息，包名，插件名，插件路径等。</li>
</ul>
<p>目录概览：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">\qihoo\RePlugin\replugin-host-gradle\src</span><br><span class="line">│</span><br><span class="line">└─main</span><br><span class="line">    ├─groovy</span><br><span class="line">    │  └─com.qihoo360.replugin.gradle.host</span><br><span class="line">    │          │  AppConstant.groovy              # 程序常量定义区</span><br><span class="line">    │          │  RePlugin.groovy                 # 针对宿主的特定构建任务创建及调度</span><br><span class="line">    │          │  </span><br><span class="line">    │          ├─creator</span><br><span class="line">    │          │  │  FileCreators.groovy          # 组装生成器</span><br><span class="line">    │          │  │  IFileCreator.groovy          # 文件生成器接口</span><br><span class="line">    │          │  │  </span><br><span class="line">    │          │  └─impl</span><br><span class="line">    │          │      ├─java</span><br><span class="line">    │          │      │      RePluginHostConfigCreator.groovy       # RePluginHostConfig.java 生成器</span><br><span class="line">    │          │      │      </span><br><span class="line">    │          │      └─json</span><br><span class="line">    │          │              PluginBuiltinJsonCreator.groovy       # plugins-builtin.json 生成器</span><br><span class="line">    │          │              PluginInfo.groovy                     # 插件信息模型</span><br><span class="line">    │          │              PluginInfoParser.groovy               # 从 manifest 的 xml 中抽取 PluginInfo信息</span><br><span class="line">    │          │              </span><br><span class="line">    │          └─handlemanifest</span><br><span class="line">    │                              ComponentsGenerator.groovy       # 动态生成插件化框架中需要的组件</span><br><span class="line">    │                              </span><br><span class="line">    └─resources</span><br><span class="line">        └─META-INF</span><br><span class="line">            └─gradle-plugins</span><br><span class="line">                replugin-host-gradle.properties                     # 指定 gradle 插件实现类</span><br></pre></td></tr></table></figure>

<p>与gradle插件相关的可以参考：<a target="_blank" rel="noopener" href="https://ljd1996.github.io/2019/08/16/Gradle%E7%AC%94%E8%AE%B0/#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8F%92%E4%BB%B6">gradle自定义插件</a>，与自定义gradle Extension相关的可以参考：<a target="_blank" rel="noopener" href="https://ljd1996.github.io/2019/08/16/Gradle%E7%AC%94%E8%AE%B0/#Extension">gradle自定义Extension</a>。gradle插件的入口自然是 <code>class Replugin implements Plugin&lt;Project&gt;</code> 的apply方法：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Replugin</span> <span class="keyword">implements</span> <span class="title">Plugin</span>&lt;<span class="title">Project</span>&gt; &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="keyword">static</span> TAG = AppConstant.TAG</span><br><span class="line">    <span class="keyword">def</span> project</span><br><span class="line">    <span class="keyword">def</span> config</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> apply(Project project) &#123;</span><br><span class="line">        println <span class="string">&quot;$&#123;TAG&#125; Welcome to replugin world ! &quot;</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="生成带坑位AndroidManifest-xml"><a href="#生成带坑位AndroidManifest-xml" class="headerlink" title="生成带坑位AndroidManifest.xml"></a>生成带坑位AndroidManifest.xml</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> apply(Project project) &#123;</span><br><span class="line">    println <span class="string">&quot;$&#123;TAG&#125; Welcome to replugin world ! &quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.project = project</span><br><span class="line">    <span class="comment">// 创建自定义的extension，用于在gradle脚本中添加名为repluginHostConfig的命名空间</span></span><br><span class="line">    project.extensions.create(AppConstant.USER_CONFIG, RepluginConfig)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (project.plugins.hasPlugin(AppPlugin)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> android = project.extensions.getByType(AppExtension)</span><br><span class="line">        <span class="comment">// 遍历android命名空间下的内容</span></span><br><span class="line">        android.applicationVariants.all &#123; variant -&gt;</span><br><span class="line">            <span class="comment">// 添加 【查看所有插件信息】 任务</span></span><br><span class="line">            addShowPluginTask(variant)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (config == <span class="literal">null</span>) &#123;</span><br><span class="line">                config = project.extensions.getByName(AppConstant.USER_CONFIG)</span><br><span class="line">                <span class="comment">// 检验repluginHostConfig命名空间下的参数配置</span></span><br><span class="line">                checkUserConfig(config)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">def</span> generateBuildConfigTask = VariantCompat.getGenerateBuildConfigTask(variant)</span><br><span class="line">            <span class="keyword">def</span> appID = generateBuildConfigTask.appPackageName</span><br><span class="line">            <span class="comment">// 生成组件坑位的xml代码，最终的xml文件是在后续的task中拼装出来的，稍后会讲到</span></span><br><span class="line">            <span class="keyword">def</span> newManifest = ComponentsGenerator.generateComponent(appID, config)</span><br><span class="line">            println <span class="string">&quot;$&#123;TAG&#125; countTask=$&#123;config.countTask&#125;&quot;</span></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>project.plugins.hasPlugin(AppPlugin)</code>：判断project中是否含有AppPlugin类型插件，即是否有’application’ projects类型的Gradle plugin。</li>
<li><code>project.plugins.hasPlugin(LibraryPlugin)</code>：判断project中是否含有LibraryPlugin类型插件，即是否有’library’ projects类型的Gradle plugin。</li>
</ul>
<p>ComponentsGenerator.generateComponent方法是使用了基于Groovy的MarkupBuilder api生成坑位。</p>
<h2 id="生成RePluginHostConfig配置文件"><a href="#生成RePluginHostConfig配置文件" class="headerlink" title="生成RePluginHostConfig配置文件"></a>生成RePluginHostConfig配置文件</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> apply(Project project) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (project.plugins.hasPlugin(AppPlugin)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> android = project.extensions.getByType(AppExtension)</span><br><span class="line">        android.applicationVariants.all &#123; variant -&gt;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">def</span> variantData = variant.variantData</span><br><span class="line">            <span class="keyword">def</span> scope = variantData.scope</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 指定task名字并创建此Task：rpGenerateHostConfig</span></span><br><span class="line">            <span class="keyword">def</span> generateHostConfigTaskName = scope.getTaskName(AppConstant.TASK_GENERATE, <span class="string">&quot;HostConfig&quot;</span>)</span><br><span class="line">            <span class="keyword">def</span> generateHostConfigTask = project.task(generateHostConfigTaskName)</span><br><span class="line"></span><br><span class="line">            generateHostConfigTask.doLast &#123;</span><br><span class="line">                <span class="comment">// 自动创建RePluginHostConfig.java至BuildConfig目录</span></span><br><span class="line">                FileCreators.createHostConfig(project, variant, config)</span><br><span class="line">            &#125;</span><br><span class="line">            generateHostConfigTask.group = AppConstant.TASKS_GROUP</span><br><span class="line"></span><br><span class="line">            <span class="comment">//depends on build config task</span></span><br><span class="line">            <span class="keyword">if</span> (generateBuildConfigTask) &#123;</span><br><span class="line">                <span class="comment">// 此task依赖于生成 BuildConfig.java 的task</span></span><br><span class="line">                generateHostConfigTask.dependsOn generateBuildConfigTask</span><br><span class="line">                <span class="comment">// 设置为 BuildConfigTask 执行完后，就执行HostConfigTask</span></span><br><span class="line">                generateBuildConfigTask.finalizedBy generateHostConfigTask</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="生成插件信息json文件"><a href="#生成插件信息json文件" class="headerlink" title="生成插件信息json文件"></a>生成插件信息json文件</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> apply(Project project) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (project.plugins.hasPlugin(AppPlugin)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> android = project.extensions.getByType(AppExtension)</span><br><span class="line">        android.applicationVariants.all &#123; variant -&gt;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="comment">// 指定task名字并创建此Task：rpGenerateBuiltinJson</span></span><br><span class="line">            <span class="keyword">def</span> generateBuiltinJsonTaskName = scope.getTaskName(AppConstant.TASK_GENERATE, <span class="string">&quot;BuiltinJson&quot;</span>)</span><br><span class="line">            <span class="keyword">def</span> generateBuiltinJsonTask = project.task(generateBuiltinJsonTaskName)</span><br><span class="line"></span><br><span class="line">            generateBuiltinJsonTask.doLast &#123;</span><br><span class="line">                <span class="comment">// 扫描宿主/assets/plugins目录下的插件文件，并基于apk文件规则解析出插件信息，包名，版本号等，然后拼装成json文件</span></span><br><span class="line">                FileCreators.createBuiltinJson(project, variant, config)</span><br><span class="line">            &#125;</span><br><span class="line">            generateBuiltinJsonTask.group = AppConstant.TASKS_GROUP</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 此task依赖于merge assets文件 的task并设置为 mergeAssetsTask 执行完后，就执行BuiltinJsonTask</span></span><br><span class="line">            <span class="keyword">def</span> mergeAssetsTask = VariantCompat.getMergeAssetsTask(variant)</span><br><span class="line">            <span class="keyword">if</span> (mergeAssetsTask) &#123;</span><br><span class="line">                generateBuiltinJsonTask.dependsOn mergeAssetsTask</span><br><span class="line">                mergeAssetsTask.finalizedBy generateBuiltinJsonTask</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="拼装AndroidManifest-xml"><a href="#拼装AndroidManifest-xml" class="headerlink" title="拼装AndroidManifest.xml"></a>拼装AndroidManifest.xml</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> apply(Project project) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (project.plugins.hasPlugin(AppPlugin)) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> android = project.extensions.getByType(AppExtension)</span><br><span class="line">        android.applicationVariants.all &#123; variant -&gt;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="comment">// 将坑位 xml 字符串 与 原有xml &lt;application&gt;&lt;/application&gt; 标签内的配置信息合二为一</span></span><br><span class="line">            variant.outputs.each &#123; output -&gt;</span><br><span class="line">                VariantCompat.getProcessManifestTask(output).doLast &#123;</span><br><span class="line">                    println <span class="string">&quot;$&#123;AppConstant.TAG&#125; processManifest: $&#123;it.outputs.files&#125;&quot;</span></span><br><span class="line">                    it.outputs.files.each &#123; File file -&gt;</span><br><span class="line">                        updateManifest(file, newManifest)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="replugin-plugin-gradle-1"><a href="#replugin-plugin-gradle-1" class="headerlink" title="replugin-plugin-gradle"></a>replugin-plugin-gradle</h1><h2 id="概述-4"><a href="#概述-4" class="headerlink" title="概述"></a>概述</h2><p>replugin-plugin-gradle 是 RePlugin 插件框架中提供给replugin插件用的gradle插件，是一种动态编译方案实现。主要在插件应用的编译期，基于Transform api 注入到编译流程中, 再通过Java字节码类库对编译中间环节的 Java 字节码文件进行修改，以便实现编译期动态修改插件应用的目的。</p>
<ul>
<li>LoaderActivityInjector: 动态将插件中的Activity的继承相关代码 修改为 replugin-plugin-library 中的XXPluginActivity父类</li>
<li>LocalBroadcastInjector: 替换 插件中的LocalBroadcastManager调用代码 为 插件库的调用代码。</li>
<li>ProviderInjector: 替换 插件中的 ContentResolver 调用代码 为 插件库的调用代码</li>
<li>ProviderInjector2: 替换 插件中的 ContentProviderClient 调用代码 为 插件库的调用代码</li>
<li>GetIdentifierInjector: 替换 插件中的 Resource.getIdentifier 调用代码的参数 为 动态适配的参数</li>
</ul>
<p>目录概览：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">\qihoo\replugin\replugin-plugin-gradle\src</span><br><span class="line">└─main</span><br><span class="line">    ├─groovy</span><br><span class="line">    │  └─com.qihoo360.replugin.gradle.plugin</span><br><span class="line">    │      │  AppConstant.groovy                      # 程序常量定义区</span><br><span class="line">    │      │  ReClassPlugin.groovy                    # 插件动态编译方案入口</span><br><span class="line">    │      │  </span><br><span class="line">    │      ├─debugger</span><br><span class="line">    │      │      PluginDebugger.groovy               # 用于插件调试的gradle task实现</span><br><span class="line">    │      │      </span><br><span class="line">    │      ├─injector</span><br><span class="line">    │      │  │  BaseInjector.groovy                  # 注入器基类</span><br><span class="line">    │      │  │  IClassInjector.groovy                # 注入器接口类</span><br><span class="line">    │      │  │  Injectors.groovy                     # 注入器枚举类，定义了全部注入器</span><br><span class="line">    │      │  │  </span><br><span class="line">    │      │  ├─identifier</span><br><span class="line">    │      │  │      GetIdentifierExprEditor.groovy   # javassist 允许修改方法里的某个表达式，此类为替换 getIdentifier 方法中表达式的实现类</span><br><span class="line">    │      │  │      GetIdentifierInjector.groovy     # GetIdentifier 方法注入器</span><br><span class="line">    │      │  │      </span><br><span class="line">    │      │  ├─loaderactivity</span><br><span class="line">    │      │  │      LoaderActivityInjector.groovy    # Activity代码注入器</span><br><span class="line">    │      │  │      </span><br><span class="line">    │      │  ├─localbroadcast</span><br><span class="line">    │      │  │      LocalBroadcastExprEditor.groovy  # 替换几个广播相关方法表达式的实现类</span><br><span class="line">    │      │  │      LocalBroadcastInjector.groovy    # 广播代码注入器</span><br><span class="line">    │      │  │      </span><br><span class="line">    │      │  └─provider</span><br><span class="line">    │      │          ProviderExprEditor.groovy       # 替换ContentResolver类的几个方法表达式</span><br><span class="line">    │      │          ProviderExprEditor2.groovy      # 替换ContentProviderClient类的几个方法表达式</span><br><span class="line">    │      │          ProviderInjector.groovy         # Provider之ContentResolver代码注入器</span><br><span class="line">    │      │          ProviderInjector2.groovy        # Provider之ContentProviderClient代码注入器</span><br><span class="line">    │      │          </span><br><span class="line">    │      ├─inner</span><br><span class="line">    │      │      ClassFileVisitor.groovy             # 类文件遍历类</span><br><span class="line">    │      │      CommonData.groovy                   # 实体类</span><br><span class="line">    │      │      ReClassTransform.groovy             # 核心类，基于 transform api 实现动态修改class文件的总调度入口</span><br><span class="line">    │      │      Util.groovy                         # 工具类</span><br><span class="line">    │      │      </span><br><span class="line">    │      ├─manifest</span><br><span class="line">    │      │      IManifest.groovy                    # 接口类</span><br><span class="line">    │      │      ManifestAPI.groovy                  # 操作Manifest的API类</span><br><span class="line">    │      │      ManifestReader.groovy               # Manifest读取工具类</span><br><span class="line">    │      │      </span><br><span class="line">    │      └─util</span><br><span class="line">    │             CmdUtil.groovy                      # 命令行工具类</span><br><span class="line">    │                              </span><br><span class="line">    └─resources</span><br><span class="line">        └─META-INF.gradle-plugins</span><br><span class="line">            replugin-plugin-gradle.properties                 # 指定 gradle 插件实现类</span><br></pre></td></tr></table></figure>

<p>replugin-plugin-gradle插件的工作流：基于Gradle的Transform API，在编译期的构建任务流中，class转为dex之前，插入一个Transform，并在此Transform流中，基于Javassist实现对字节码文件的注入。</p>
<h2 id="生成用于调试的task"><a href="#生成用于调试的task" class="headerlink" title="生成用于调试的task"></a>生成用于调试的task</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> apply(Project project) &#123;</span><br><span class="line"></span><br><span class="line">    println <span class="string">&quot;$&#123;AppConstant.TAG&#125; Welcome to replugin world ! &quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建repluginPluginConfig命名空间的extension</span></span><br><span class="line">    project.extensions.create(AppConstant.USER_CONFIG, ReClassConfig)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> isApp = project.plugins.hasPlugin(AppPlugin)</span><br><span class="line">    <span class="keyword">if</span> (isApp) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> config = project.extensions.getByName(AppConstant.USER_CONFIG)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> android = project.extensions.getByType(AppExtension)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> forceStopHostAppTask = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">def</span> startHostAppTask = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">def</span> restartHostAppTask = <span class="literal">null</span></span><br><span class="line">        <span class="comment">// 遍历android命名空间下的variants组合</span></span><br><span class="line">        android.applicationVariants.all &#123; variant -&gt;</span><br><span class="line">            PluginDebugger pluginDebugger = <span class="keyword">new</span> PluginDebugger(project, config, variant)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">def</span> variantData = variant.variantData</span><br><span class="line">            <span class="keyword">def</span> scope = variantData.scope</span><br><span class="line"></span><br><span class="line">            <span class="keyword">def</span> assembleTask = VariantCompat.getAssembleTask(variant)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">def</span> installPluginTaskName = scope.getTaskName(AppConstant.TASK_INSTALL_PLUGIN, <span class="string">&quot;&quot;</span>)</span><br><span class="line">            <span class="keyword">def</span> installPluginTask = project.task(installPluginTaskName)</span><br><span class="line"></span><br><span class="line">            installPluginTask.doLast &#123;</span><br><span class="line">                pluginDebugger.startHostApp()</span><br><span class="line">                pluginDebugger.uninstall()</span><br><span class="line">                pluginDebugger.forceStopHostApp()</span><br><span class="line">                pluginDebugger.startHostApp()</span><br><span class="line">                pluginDebugger.install()</span><br><span class="line">            &#125;</span><br><span class="line">            installPluginTask.group = AppConstant.TASKS_GROUP</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>new PluginDebugger(project, config, variant)</code>: 初始化PluginDebugger类实例，主要配置了最终生成的插件应用的文件路径，以及adb文件的路径，是为了后续基于adb命令做push apk到SD卡上做准备。  <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> PluginDebugger(Project project, <span class="keyword">def</span> config, <span class="keyword">def</span> variant) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    File apkDir = <span class="keyword">new</span> File(globalScope.getBuildDir(), <span class="string">&quot;outputs&quot;</span> + File.separator + <span class="string">&quot;apk&quot;</span>)</span><br><span class="line">    String unsigned = (variantConfiguration.getSigningConfig() == <span class="literal">null</span></span><br><span class="line">            ? <span class="string">&quot;-unsigned.apk&quot;</span></span><br><span class="line">            : <span class="string">&quot;.apk&quot;</span>);</span><br><span class="line">    String apkName = apkBaseName + unsigned</span><br><span class="line">    apkFile = <span class="keyword">new</span> File(apkDir, apkName)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!apkFile.exists() || apkFile.length() == <span class="number">0</span>) &#123;</span><br><span class="line">        apkFile = <span class="keyword">new</span> File(apkDir, variantConfiguration.getBaseName() + File.separator + apkName)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    adbFile = ScopeCompat.getAdbExecutable(globalScope)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><code>def assembleTask = VariantCompat.getAssembleTask(variant)</code>，获取assemble task(即打包apk的task)，后续的task需要依赖此task，比如安装插件的task，肯定要等到assemble task打包生成apk后，才能去执行。</li>
<li>生成installPluginTask的gradle task名字: rpInstallPlugin，并创建此Task。然后指定此task的任务内容：  <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">installPluginTask.doLast &#123;</span><br><span class="line">    pluginDebugger.startHostApp()</span><br><span class="line">    pluginDebugger.uninstall()</span><br><span class="line">    pluginDebugger.forceStopHostApp()</span><br><span class="line">    pluginDebugger.startHostApp()</span><br><span class="line">    pluginDebugger.install()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>流程：启动宿主 -&gt; 卸载插件 -&gt; 强制停止宿主 -&gt; 启动宿主 -&gt; 安装插件</li>
<li>pluginDebugger 内的方法实现：基于adb shell + am 命令，实现 发送广播，push apk 等功能。比如：pluginDebugger.startHostApp()  <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">boolean</span> startHostApp() &#123;</span><br><span class="line">    <span class="keyword">if</span> (isConfigNull()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String cmd = <span class="string">&quot;$&#123;adbFile.absolutePath&#125; shell am start -n \&quot;$&#123;config.hostApplicationId&#125;/$&#123;config.hostAppLauncherActivity&#125;\&quot; -a android.intent.action.MAIN -c android.intent.category.LAUNCHER&quot;</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != CmdUtil.syncExecute(cmd)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>调试方案的整体原理：</p>
<ol>
<li>replugin-host-lib 的DebuggerReceivers类中，注册了一系列用于快速调试的广播，而replugin-host-lib是会内置在宿主应用中的。</li>
<li>replugin-plugin-gradle 中创建了一系列gradle task，用于启动停止重启宿主应用，安装卸载运行插件应用。这些gradle task都是被动型task，需要通过命令行主动的运行这些task。</li>
<li>打开命令行终端，执行replugin插件项目的某个gradle task，以实现快速调试功能。比如：gradlew.bat rpInstallPluginDebug，最终就会将宿主和插件运行起来。</li>
<li>这些gradle task被手动执行后，task会执行一系列任务，比如通过adb push 插件到sdcard，或通过am命令发送广播，启动activity等。当发送一系列步骤1中注册的广播后，宿主应用收到广播后会执行对应的操作，比如启动插件的activity等。</li>
</ol>
<h2 id="动态编译方案"><a href="#动态编译方案" class="headerlink" title="动态编译方案"></a>动态编译方案</h2><h3 id="transform"><a href="#transform" class="headerlink" title="transform"></a>transform</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> apply(Project project) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (isApp) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">def</span> transform = <span class="keyword">new</span> ReClassTransform(project)</span><br><span class="line">        android.registerTransform(transform)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看一下ReClassTransform的核心方法transform()：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">void</span> transform(Context context,</span><br><span class="line">                Collection&lt;TransformInput&gt; inputs,</span><br><span class="line">                Collection&lt;TransformInput&gt; referencedInputs,</span><br><span class="line">                TransformOutputProvider outputProvider,</span><br><span class="line">                <span class="keyword">boolean</span> isIncremental) <span class="keyword">throws</span> IOException, TransformException, InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">    welcome()</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 读取用户配置 */</span></span><br><span class="line">    <span class="keyword">def</span> config = project.extensions.getByName(<span class="string">&#x27;repluginPluginConfig&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    File rootLocation = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        rootLocation = outputProvider.rootLocation</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        <span class="comment">//android gradle plugin 3.0.0+ 修改了私有变量，将其移动到了IntermediateFolderUtils中去</span></span><br><span class="line">        rootLocation = outputProvider.folderUtils.getRootFolder()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (rootLocation == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> GradleException(<span class="string">&quot;can&#x27;t get transform root location&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    println <span class="string">&quot;&gt;&gt;&gt; rootLocation: $&#123;rootLocation&#125;&quot;</span></span><br><span class="line">    <span class="comment">// Compatible with path separators for window and Linux, and fit split param based on &#x27;Pattern.quote&#x27;</span></span><br><span class="line">    <span class="keyword">def</span> variantDir = rootLocation.absolutePath.split(getName() + Pattern.quote(File.separator))[<span class="number">1</span>]</span><br><span class="line">    println <span class="string">&quot;&gt;&gt;&gt; variantDir: $&#123;variantDir&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">    CommonData.appModule = config.appModule</span><br><span class="line">    CommonData.ignoredActivities = config.ignoredActivities</span><br><span class="line">    <span class="comment">// 返回用户未忽略的注入器的集合，因为在repluginPluginConfig中可以配置忽略配置</span></span><br><span class="line">    <span class="keyword">def</span> injectors = includedInjectors(config, variantDir)</span><br><span class="line">    <span class="keyword">if</span> (injectors.isEmpty()) &#123;</span><br><span class="line">        copyResult(inputs, outputProvider) <span class="comment">// 跳过 reclass</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        doTransform(inputs, outputProvider, config, injectors) <span class="comment">// 执行 reclass</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="doTransform"><a href="#doTransform" class="headerlink" title="doTransform"></a>doTransform</h3><p>这里会遍历除了用户已忽略过的全部代码注入器，依次执行每个注入器的特定注入任务。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> doTransform(Collection&lt;TransformInput&gt; inputs,</span><br><span class="line">                TransformOutputProvider outputProvider,</span><br><span class="line">                Object config,</span><br><span class="line">                <span class="keyword">def</span> injectors) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 初始化 ClassPool */</span></span><br><span class="line">    Object pool = initClassPool(inputs)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 进行注入操作 */</span></span><br><span class="line">    Util.newSection()</span><br><span class="line">    Injectors.values().each &#123;</span><br><span class="line">        <span class="keyword">if</span> (it.nickName <span class="keyword">in</span> injectors) &#123;</span><br><span class="line">            println <span class="string">&quot;&gt;&gt;&gt; Do: $&#123;it.nickName&#125;&quot;</span></span><br><span class="line">            <span class="comment">// 将 NickName 的第 0 个字符转换成小写，用作对应配置的名称</span></span><br><span class="line">            <span class="keyword">def</span> configPre = Util.lowerCaseAtIndex(it.nickName, <span class="number">0</span>)</span><br><span class="line">            doInject(inputs, pool, it.injector, config.properties[<span class="string">&quot;$&#123;configPre&#125;Config&quot;</span>])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            println <span class="string">&quot;&gt;&gt;&gt; Skip: $&#123;it.nickName&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (config.customInjectors != <span class="literal">null</span>) &#123;</span><br><span class="line">        config.customInjectors.each &#123;</span><br><span class="line">            doInject(inputs, pool, it)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 重打包 */</span></span><br><span class="line">    repackage()</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 拷贝 class 和 jar 包 */</span></span><br><span class="line">    copyResult(inputs, outputProvider)</span><br><span class="line"></span><br><span class="line">    Util.newSection()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="doInject"><a href="#doInject" class="headerlink" title="doInject"></a>doInject</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> doInject(Collection&lt;TransformInput&gt; inputs, ClassPool pool,</span><br><span class="line">                IClassInjector injector, Object config) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        inputs.each &#123; TransformInput input -&gt;</span><br><span class="line">            input.directoryInputs.each &#123;</span><br><span class="line">                handleDir(pool, it, injector, config)</span><br><span class="line">            &#125;</span><br><span class="line">            input.jarInputs.each &#123;</span><br><span class="line">                handleJar(pool, it, injector, config)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        println t.toString()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理目录中的 class 文件</span></span><br><span class="line"><span class="keyword">def</span> handleDir(ClassPool pool, DirectoryInput input, IClassInjector injector, Object config) &#123;</span><br><span class="line">    println <span class="string">&quot;&gt;&gt;&gt; Handle Dir: $&#123;input.file.absolutePath&#125;&quot;</span></span><br><span class="line">    injector.injectClass(pool, input.file.absolutePath, config)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> handleJar(ClassPool pool, JarInput input, IClassInjector injector, Object config) &#123;</span><br><span class="line">    File jar = input.file</span><br><span class="line">    <span class="keyword">if</span> (jar.absolutePath <span class="keyword">in</span> includeJars) &#123;</span><br><span class="line">        println <span class="string">&quot;&gt;&gt;&gt; Handle Jar: $&#123;jar.absolutePath&#125;&quot;</span></span><br><span class="line">        String dirAfterUnzip = map.get(jar.getParent() + File.separatorChar + jar.getName()).replace(<span class="string">&#x27;.jar&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        injector.injectClass(pool, dirAfterUnzip, config)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LoaderActivityInjector"><a href="#LoaderActivityInjector" class="headerlink" title="LoaderActivityInjector"></a>LoaderActivityInjector</h3><p>用来修改插件中XXActivity类中的顶级XXActivity父类 为 XXPluginActivity父类：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoaderActivityInjector</span> <span class="keyword">extends</span> <span class="title">BaseInjector</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* LoaderActivity 替换规则 */</span></span><br><span class="line">    <span class="keyword">def</span> <span class="keyword">private</span> <span class="keyword">static</span> loaderActivityRules = [</span><br><span class="line">            <span class="string">&#x27;android.app.Activity&#x27;</span>                    : <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginActivity&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;android.app.TabActivity&#x27;</span>                 : <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginTabActivity&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;android.app.ListActivity&#x27;</span>                : <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginListActivity&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;android.app.ActivityGroup&#x27;</span>               : <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginActivityGroup&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;android.support.v4.app.FragmentActivity&#x27;</span> : <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginFragmentActivity&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;android.support.v7.app.AppCompatActivity&#x27;</span>: <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginAppCompatActivity&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;android.preference.PreferenceActivity&#x27;</span>   : <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginPreferenceActivity&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;android.app.ExpandableListActivity&#x27;</span>      : <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginExpandableListActivity&#x27;</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">def</span> injectClass(ClassPool pool, String dir, Map config) &#123;</span><br><span class="line">        init()</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 遍历程序中声明的所有 Activity */</span></span><br><span class="line">        <span class="comment">// 每次都new一下，否则多个variant一起构建时只会获取到首个manifest</span></span><br><span class="line">        <span class="keyword">new</span> ManifestAPI().getActivities(project, variantDir).each &#123;</span><br><span class="line">            <span class="comment">// 处理没有被忽略的 Activity</span></span><br><span class="line">            <span class="keyword">if</span> (!(it <span class="keyword">in</span> CommonData.ignoredActivities)) &#123;</span><br><span class="line">                handleActivity(pool, it, dir)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">def</span> handleActivity(ClassPool pool, String activity, String classesDir) &#123;</span><br><span class="line">        <span class="keyword">def</span> clsFilePath = classesDir + File.separatorChar + activity.replaceAll(<span class="string">&#x27;\\.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>) + <span class="string">&#x27;.class&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">new</span> File(clsFilePath).exists()) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        println <span class="string">&quot;&gt;&gt;&gt; Handle $activity&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> stream, ctCls</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stream = <span class="keyword">new</span> FileInputStream(clsFilePath)</span><br><span class="line">            ctCls = pool.makeClass(stream);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ctCls 之前的父类</span></span><br><span class="line">            <span class="keyword">def</span> originSuperCls = ctCls.superclass</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* 从当前 Activity 往上回溯，直到找到需要替换的 Activity */</span></span><br><span class="line">            <span class="keyword">def</span> superCls = originSuperCls</span><br><span class="line">            <span class="keyword">while</span> (superCls != <span class="literal">null</span> &amp;&amp; !(superCls.name <span class="keyword">in</span> loaderActivityRules.keySet())) &#123;</span><br><span class="line">                <span class="comment">// println &quot;&gt;&gt;&gt; 向上查找 $superCls.name&quot;</span></span><br><span class="line">                ctCls = superCls</span><br><span class="line">                superCls = ctCls.superclass</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果 ctCls 已经是 LoaderActivity，则不修改</span></span><br><span class="line">            <span class="keyword">if</span> (ctCls.name <span class="keyword">in</span> loaderActivityRules.values()) &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* 找到需要替换的 Activity, 修改 Activity 的父类为 LoaderActivity */</span></span><br><span class="line">            <span class="keyword">if</span> (superCls != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">def</span> targetSuperClsName = loaderActivityRules.get(superCls.name)</span><br><span class="line">                CtClass targetSuperCls = pool.get(targetSuperClsName)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (ctCls.isFrozen()) &#123;</span><br><span class="line">                    ctCls.defrost()</span><br><span class="line">                &#125;</span><br><span class="line">                ctCls.setSuperclass(targetSuperCls)</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 修改声明的父类后，还需要方法中所有的 super 调用。</span></span><br><span class="line">                ctCls.getDeclaredMethods().each &#123; outerMethod -&gt;</span><br><span class="line">                    outerMethod.instrument(<span class="keyword">new</span> ExprEditor() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">void</span> edit(MethodCall call) <span class="keyword">throws</span> CannotCompileException &#123;</span><br><span class="line">                            <span class="keyword">if</span> (call.isSuper()) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (call.getMethod().getReturnType().getName() == <span class="string">&#x27;void&#x27;</span>) &#123;</span><br><span class="line">                                    call.replace(<span class="string">&#x27;&#123;super.&#x27;</span> + call.getMethodName() + <span class="string">&#x27;($$);&#125;&#x27;</span>)</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    call.replace(<span class="string">&#x27;&#123;$_ = super.&#x27;</span> + call.getMethodName() + <span class="string">&#x27;($$);&#125;&#x27;</span>)</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ctCls.writeFile(CommonData.getClassPath(ctCls.name))</span><br><span class="line">                println <span class="string">&quot;    Replace $&#123;ctCls.name&#125;&#x27;s SuperClass $&#123;superCls.name&#125; to $&#123;targetSuperCls.name&#125;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            println <span class="string">&quot;    [Warning] --&gt; $&#123;t.toString()&#125;&quot;</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ctCls != <span class="literal">null</span>) &#123;</span><br><span class="line">                ctCls.detach()</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (stream != <span class="literal">null</span>) &#123;</span><br><span class="line">                stream.close()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关于Jar包中的class注入：在initClassPool时已经把Jar做了unzip，解压出也是一堆.class文件，其他处理逻辑同上。也就是说，你引用的第三方sdk中的jar，以及你依赖的库中的jar，都会被注入器撸一遍。</p>
<p><strong>注意：在Androidx中其包名不一样。</strong></p>
<h3 id="LocalBroadcastInjector"><a href="#LocalBroadcastInjector" class="headerlink" title="LocalBroadcastInjector"></a>LocalBroadcastInjector</h3><p>替换插件中的 LocalBroadcastManager的方法调用 为 插件库的PluginLocalBroadcastManager中的方法调用。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalBroadcastInjector</span> <span class="keyword">extends</span> <span class="title">BaseInjector</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">def</span> injectClass(ClassPool pool, String dir, Map config) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (editor == <span class="literal">null</span>) &#123;</span><br><span class="line">            editor = <span class="keyword">new</span> LocalBroadcastExprEditor()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Util.newSection()</span><br><span class="line">        println dir</span><br><span class="line"></span><br><span class="line">        Files.walkFileTree(Paths.get(dir), <span class="keyword">new</span> SimpleFileVisitor&lt;Path&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            FileVisitResult visitFile(Path file, BasicFileAttributes attrs) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">                String filePath = file.toString()</span><br><span class="line">                editor.filePath = filePath</span><br><span class="line"></span><br><span class="line">                <span class="keyword">def</span> stream, ctCls</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 不处理 LocalBroadcastManager.class</span></span><br><span class="line">                    <span class="comment">// 保护性逻辑，避免替换掉v4包中的源码实现</span></span><br><span class="line">                    <span class="keyword">if</span> (filePath.contains(<span class="string">&#x27;android/support/v4/content/LocalBroadcastManager&#x27;</span>)) &#123;</span><br><span class="line">                        println <span class="string">&quot;Ignore $&#123;filePath&#125;&quot;</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="built_in">super</span>.visitFile(file, attrs)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    stream = <span class="keyword">new</span> FileInputStream(filePath)</span><br><span class="line">                    ctCls = pool.makeClass(stream);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// println ctCls.name</span></span><br><span class="line">                    <span class="keyword">if</span> (ctCls.isFrozen()) &#123;</span><br><span class="line">                        ctCls.defrost()</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/* 检查方法列表 */</span></span><br><span class="line">                    ctCls.getDeclaredMethods().each &#123;</span><br><span class="line">                        it.instrument(editor)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    ctCls.getMethods().each &#123;</span><br><span class="line">                        it.instrument(editor)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    ctCls.writeFile(dir)</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    println <span class="string">&quot;    [Warning] --&gt; $&#123;t.toString()&#125;&quot;</span></span><br><span class="line">                    <span class="comment">// t.printStackTrace()</span></span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ctCls != <span class="literal">null</span>) &#123;</span><br><span class="line">                        ctCls.detach()</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (stream != <span class="literal">null</span>) &#123;</span><br><span class="line">                        stream.close()</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">super</span>.visitFile(file, attrs)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LocalBroadcastExprEditor</span> <span class="keyword">extends</span> <span class="title">ExprEditor</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">def</span> TARGET_CLASS = <span class="string">&#x27;android.support.v4.content.LocalBroadcastManager&#x27;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">def</span> PROXY_CLASS = <span class="string">&#x27;com.qihoo360.replugin.loader.b.PluginLocalBroadcastManager&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 处理以下方法 */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">def</span> includeMethodCall = [<span class="string">&#x27;getInstance&#x27;</span>,</span><br><span class="line">                                    <span class="string">&#x27;registerReceiver&#x27;</span>,</span><br><span class="line">                                    <span class="string">&#x27;unregisterReceiver&#x27;</span>,</span><br><span class="line">                                    <span class="string">&#x27;sendBroadcast&#x27;</span>,</span><br><span class="line">                                    <span class="string">&#x27;sendBroadcastSync&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 待处理文件的物理路径 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">def</span> filePath</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> edit(MethodCall call) <span class="keyword">throws</span> CannotCompileException &#123;</span><br><span class="line">        <span class="keyword">if</span> (call.getClassName().equalsIgnoreCase(TARGET_CLASS)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(call.getMethodName() <span class="keyword">in</span> includeMethodCall)) &#123;</span><br><span class="line">                <span class="comment">// println &quot;Skip $methodName&quot;</span></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            replaceStatement(call)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="keyword">private</span> replaceStatement(MethodCall call) &#123;</span><br><span class="line">        String method = call.getMethodName()</span><br><span class="line">        <span class="keyword">if</span> (method == <span class="string">&#x27;getInstance&#x27;</span>) &#123;</span><br><span class="line">            call.replace(<span class="string">&#x27;&#123;$_ = &#x27;</span> + PROXY_CLASS + <span class="string">&#x27;.&#x27;</span> + method + <span class="string">&#x27;($$);&#125;&#x27;</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">def</span> returnType = call.method.returnType.getName()</span><br><span class="line">            <span class="comment">// getInstance 之外的调用，要增加一个参数，请参看 i-library 的 LocalBroadcastClient.java</span></span><br><span class="line">            <span class="keyword">if</span> (returnType == <span class="string">&#x27;void&#x27;</span>) &#123;</span><br><span class="line">                call.replace(<span class="string">&#x27;&#123;&#x27;</span> + PROXY_CLASS + <span class="string">&#x27;.&#x27;</span> + method + <span class="string">&#x27;($0, $$);&#125;&#x27;</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                call.replace(<span class="string">&#x27;&#123;$_ = &#x27;</span> + PROXY_CLASS + <span class="string">&#x27;.&#x27;</span> + method + <span class="string">&#x27;($0, $$);&#125;&#x27;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        println <span class="string">&quot;&gt;&gt;&gt; Replace: $&#123;filePath&#125; &lt;line:$&#123;call.lineNumber&#125;&gt; $&#123;TARGET_CLASS&#125;.$&#123;method&#125;() &lt;With&gt; $&#123;PROXY_CLASS&#125;.$&#123;method&#125;()\n&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：在Androidx中<code>android.support.v4.content.LocalBroadcastManager</code>是<code>androidx.localbroadcastmanager.content.LocalBroadcastManager</code>。</strong></p>
<h3 id="ProviderInjector"><a href="#ProviderInjector" class="headerlink" title="ProviderInjector"></a>ProviderInjector</h3><p>替换 插件中的 ContentResolver相关的方法调用 为 插件库的PluginProviderClient中的对应方法调用。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderInjector</span> <span class="keyword">extends</span> <span class="title">BaseInjector</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理以下方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">def</span> includeMethodCall = [<span class="string">&#x27;query&#x27;</span>,</span><br><span class="line">                                           <span class="string">&#x27;getType&#x27;</span>,</span><br><span class="line">                                           <span class="string">&#x27;insert&#x27;</span>,</span><br><span class="line">                                           <span class="string">&#x27;bulkInsert&#x27;</span>,</span><br><span class="line">                                           <span class="string">&#x27;delete&#x27;</span>,</span><br><span class="line">                                           <span class="string">&#x27;update&#x27;</span>,</span><br><span class="line">            <span class="comment">/// 以下方法 replugin plugin lib 暂未支持，导致字节码修改失败。</span></span><br><span class="line">                                           <span class="string">&#x27;openInputStream&#x27;</span>,</span><br><span class="line">                                           <span class="string">&#x27;openOutputStream&#x27;</span>,</span><br><span class="line">                                           <span class="string">&#x27;openFileDescriptor&#x27;</span>,</span><br><span class="line">                                           <span class="string">&#x27;registerContentObserver&#x27;</span>,</span><br><span class="line">                                           <span class="string">&#x27;acquireContentProviderClient&#x27;</span>,</span><br><span class="line">                                           <span class="string">&#x27;notifyChange&#x27;</span>,</span><br><span class="line">                                           <span class="string">&#x27;toCalledUri&#x27;</span>,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 表达式编辑器</span></span><br><span class="line">    <span class="keyword">def</span> editor</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">def</span> injectClass(ClassPool pool, String dir, Map config) &#123;</span><br><span class="line">        <span class="keyword">if</span> (editor == <span class="literal">null</span>) &#123;</span><br><span class="line">            editor = <span class="keyword">new</span> ProviderExprEditor()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Util.newSection()</span><br><span class="line">        println dir</span><br><span class="line"></span><br><span class="line">        Files.walkFileTree(Paths.get(dir), <span class="keyword">new</span> SimpleFileVisitor&lt;Path&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            FileVisitResult visitFile(Path file, BasicFileAttributes attrs) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">                String filePath = file.toString()</span><br><span class="line">                <span class="keyword">def</span> stream, ctCls</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (filePath.contains(<span class="string">&#x27;PluginProviderClient.class&#x27;</span>)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&#x27;can not replace self &#x27;</span>)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    stream = <span class="keyword">new</span> FileInputStream(filePath)</span><br><span class="line">                    ctCls = pool.makeClass(stream);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// println ctCls.name</span></span><br><span class="line">                    <span class="keyword">if</span> (ctCls.isFrozen()) &#123;</span><br><span class="line">                        ctCls.defrost()</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    editor.filePath = filePath</span><br><span class="line"></span><br><span class="line">                    (ctCls.getDeclaredMethods() + ctCls.getMethods()).each &#123;</span><br><span class="line">                        it.instrument(editor)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    ctCls.writeFile(dir)</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    println <span class="string">&quot;    [Warning] --&gt; $&#123;t.toString()&#125;&quot;</span></span><br><span class="line">                    <span class="comment">// t.printStackTrace()</span></span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ctCls != <span class="literal">null</span>) &#123;</span><br><span class="line">                        ctCls.detach()</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (stream != <span class="literal">null</span>) &#123;</span><br><span class="line">                        stream.close()</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">super</span>.visitFile(file, attrs)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderExprEditor</span> <span class="keyword">extends</span> <span class="title">ExprEditor</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">def</span> PROVIDER_CLASS = <span class="string">&#x27;com.qihoo360.replugin.loader.p.PluginProviderClient&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">def</span> filePath</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> edit(MethodCall m) <span class="keyword">throws</span> CannotCompileException &#123;</span><br><span class="line">        <span class="keyword">final</span> String clsName = m.getClassName()</span><br><span class="line">        <span class="keyword">final</span> String methodName = m.getMethodName()</span><br><span class="line">        <span class="keyword">if</span> (!clsName.equalsIgnoreCase(<span class="string">&#x27;android.content.ContentResolver&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!(methodName <span class="keyword">in</span> ProviderInjector.includeMethodCall)) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            replaceStatement(m, methodName, m.lineNumber)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123; <span class="comment">//确保不影响其他 MethodCall</span></span><br><span class="line">            println <span class="string">&quot;    [Warning] --&gt; ProviderExprEditor : $&#123;e.toString()&#125;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="keyword">private</span> replaceStatement(MethodCall methodCall, String method, <span class="keyword">def</span> line) &#123;</span><br><span class="line">        <span class="keyword">if</span> (methodCall.getMethodName() == <span class="string">&#x27;registerContentObserver&#x27;</span> || methodCall.getMethodName() == <span class="string">&#x27;notifyChange&#x27;</span>) &#123;</span><br><span class="line">            methodCall.replace(<span class="string">&#x27;&#123;&#x27;</span> + PROVIDER_CLASS + <span class="string">&#x27;.&#x27;</span> + method + <span class="string">&#x27;(com.qihoo360.replugin.RePlugin.getPluginContext(), $$);&#125;&#x27;</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            methodCall.replace(<span class="string">&#x27;&#123;$_ = &#x27;</span> + PROVIDER_CLASS + <span class="string">&#x27;.&#x27;</span> + method + <span class="string">&#x27;(com.qihoo360.replugin.RePlugin.getPluginContext(), $$);&#125;&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        println <span class="string">&quot;&gt;&gt;&gt; Replace: $&#123;filePath&#125; Provider.$&#123;method&#125;():$&#123;line&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ProviderInjector2"><a href="#ProviderInjector2" class="headerlink" title="ProviderInjector2"></a>ProviderInjector2</h3><p>替换 插件中的 ContentProviderClient 相关的方法调用。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderInjector2</span> <span class="keyword">extends</span> <span class="title">BaseInjector</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理以下方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">def</span> includeMethodCall = [<span class="string">&#x27;query&#x27;</span>, <span class="string">&#x27;update&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 表达式编辑器</span></span><br><span class="line">    <span class="keyword">def</span> editor</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">def</span> injectClass(ClassPool pool, String dir, Map config) &#123;</span><br><span class="line">        <span class="keyword">if</span> (editor == <span class="literal">null</span>) &#123;</span><br><span class="line">            editor = <span class="keyword">new</span> ProviderExprEditor2()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Util.newSection()</span><br><span class="line">        println dir</span><br><span class="line"></span><br><span class="line">        Files.walkFileTree(Paths.get(dir), <span class="keyword">new</span> SimpleFileVisitor&lt;Path&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            FileVisitResult visitFile(Path file, BasicFileAttributes attrs) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">                String filePath = file.toString()</span><br><span class="line">                <span class="keyword">def</span> stream, ctCls</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (filePath.contains(<span class="string">&#x27;PluginProviderClient2.class&#x27;</span>)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&#x27;can not replace self &#x27;</span>)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    stream = <span class="keyword">new</span> FileInputStream(filePath)</span><br><span class="line">                    ctCls = pool.makeClass(stream);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// println ctCls.name</span></span><br><span class="line">                    <span class="keyword">if</span> (ctCls.isFrozen()) &#123;</span><br><span class="line">                        ctCls.defrost()</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    editor.filePath = filePath</span><br><span class="line">                    ctCls.getDeclaredMethods().each &#123;</span><br><span class="line">                        it.instrument(editor)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    ctCls.getMethods().each &#123;</span><br><span class="line">                        it.instrument(editor)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    ctCls.writeFile(dir)</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    println <span class="string">&quot;    [Warning] --&gt; $&#123;t.toString()&#125;&quot;</span></span><br><span class="line">                    <span class="comment">// t.printStackTrace()</span></span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ctCls != <span class="literal">null</span>) &#123;</span><br><span class="line">                        ctCls.detach()</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (stream != <span class="literal">null</span>) &#123;</span><br><span class="line">                        stream.close()</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">super</span>.visitFile(file, attrs)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderExprEditor2</span> <span class="keyword">extends</span> <span class="title">ExprEditor</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">def</span> PROVIDER_CLASS = <span class="string">&#x27;com.qihoo360.loader2.mgr.PluginProviderClient2&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">def</span> filePath</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> edit(MethodCall m) <span class="keyword">throws</span> CannotCompileException &#123;</span><br><span class="line">        String clsName = m.getClassName()</span><br><span class="line">        String methodName = m.getMethodName()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clsName.equalsIgnoreCase(<span class="string">&#x27;android.content.ContentProviderClient&#x27;</span>)) &#123;</span><br><span class="line">            println <span class="string">&quot; $&#123;filePath&#125; ContentProviderClient.$&#123;methodName&#125;():$&#123;m.lineNumber&#125;&quot;</span></span><br><span class="line">            <span class="keyword">if</span> (!(methodName <span class="keyword">in</span> ProviderInjector2.includeMethodCall)) &#123;</span><br><span class="line">                <span class="comment">// println &quot;跳过$methodName&quot;</span></span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            replaceStatement(m, methodName, m.lineNumber)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="keyword">private</span> replaceStatement(MethodCall methodCall, String method, <span class="keyword">def</span> line) &#123;</span><br><span class="line">        methodCall.replace(<span class="string">&#x27;&#123;$_ = &#x27;</span> + PROVIDER_CLASS + <span class="string">&#x27;.&#x27;</span> + method + <span class="string">&#x27;(com.qihoo360.replugin.RePlugin.getPluginContext(), $$);&#125;&#x27;</span>)</span><br><span class="line">        println <span class="string">&quot;&gt;&gt;&gt; Replace: $&#123;filePath&#125; Provider.$&#123;method&#125;():$&#123;line&#125;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="GetIdentifierInjector"><a href="#GetIdentifierInjector" class="headerlink" title="GetIdentifierInjector"></a>GetIdentifierInjector</h3><p>替换 插件中的 Resource.getIdentifier 方法调用的参数 为 动态适配的参数。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetIdentifierInjector</span> <span class="keyword">extends</span> <span class="title">BaseInjector</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 表达式编辑器</span></span><br><span class="line">    <span class="keyword">def</span> editor</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">def</span> injectClass(ClassPool pool, String dir, Map config) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (editor == <span class="literal">null</span>) &#123;</span><br><span class="line">            editor = <span class="keyword">new</span> GetIdentifierExprEditor()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Util.newSection()</span><br><span class="line">        println dir</span><br><span class="line"></span><br><span class="line">        Files.walkFileTree(Paths.get(dir), <span class="keyword">new</span> SimpleFileVisitor&lt;Path&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            FileVisitResult visitFile(Path file, BasicFileAttributes attrs) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//todo only .class</span></span><br><span class="line">                String filePath = file.toString()</span><br><span class="line"></span><br><span class="line">                editor.filePath = filePath</span><br><span class="line"></span><br><span class="line">                <span class="keyword">def</span> stream, ctCls</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    stream = <span class="keyword">new</span> FileInputStream(filePath)</span><br><span class="line">                    ctCls = pool.makeClass(stream);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// println ctCls.name</span></span><br><span class="line">                    <span class="keyword">if</span> (ctCls.isFrozen()) &#123;</span><br><span class="line">                        ctCls.defrost()</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    ctCls.getDeclaredMethods().each &#123;</span><br><span class="line">                        it.instrument(editor)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    ctCls.getMethods().each &#123;</span><br><span class="line">                        it.instrument(editor)</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    ctCls.writeFile(dir)</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    println <span class="string">&quot;    [Warning] --&gt; $&#123;t.toString()&#125;&quot;</span></span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ctCls != <span class="literal">null</span>) &#123;</span><br><span class="line">                        ctCls.detach()</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (stream != <span class="literal">null</span>) &#123;</span><br><span class="line">                        stream.close()</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">super</span>.visitFile(file, attrs)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetIdentifierExprEditor</span> <span class="keyword">extends</span> <span class="title">ExprEditor</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">def</span> filePath</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">void</span> edit(MethodCall m) <span class="keyword">throws</span> CannotCompileException &#123;</span><br><span class="line">        String clsName = m.getClassName()</span><br><span class="line">        String methodName = m.getMethodName()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clsName.equalsIgnoreCase(<span class="string">&#x27;android.content.res.Resources&#x27;</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (methodName == <span class="string">&#x27;getIdentifier&#x27;</span>) &#123;</span><br><span class="line">                <span class="comment">// 将传入的第三个参数替换成 固定包名，防止找错资源</span></span><br><span class="line">                m.replace(<span class="string">&#x27;&#123; $3 = \&quot;&#x27;</span> + CommonData.appPackage + <span class="string">&#x27;\&quot;; &#x27;</span> +</span><br><span class="line">                        <span class="string">&#x27;$_ = $proceed($$);&#x27;</span> +</span><br><span class="line">                        <span class="string">&#x27; &#125;&#x27;</span>)</span><br><span class="line">                println <span class="string">&quot; GetIdentifierCall =&gt; $&#123;filePath&#125; $&#123;methodName&#125;():$&#123;m.lineNumber&#125;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ReclassTansfrom任务完成后，将会把输出继续传递给下一个TransfromtransformClassesWithDexFor{ProductFlavor}{BuildType}，把处理权交还给android gradle插件。至此，replugin-plugin-gradle 插件的工作就全部结束了。</p>
<h2 id="gradle高版本问题"><a href="#gradle高版本问题" class="headerlink" title="gradle高版本问题"></a>gradle高版本问题</h2><p>如果在某些gradle版本上replugin-plugin-gradle插件的LoaderActivityInjector在编译时调用Exception（读取Manifest文件出错等，应该是高版本gradle api不兼容的问题），从而造成没有自动替换PluginXXXActivity，可以尝试在插件app module的build.gradle末尾添加以下代码：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Method</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.qihoo360.replugin.gradle.plugin.inner.CommonData</span><br><span class="line"><span class="keyword">import</span> com.qihoo360.replugin.gradle.plugin.injector.loaderactivity.LoaderActivityInjector</span><br><span class="line"><span class="keyword">import</span> com.qihoo360.replugin.gradle.plugin.manifest.ManifestReader</span><br><span class="line"><span class="keyword">import</span> com.qihoo360.replugin.gradle.plugin.injector.Injectors</span><br><span class="line"></span><br><span class="line">Injectors.LOADER_ACTIVITY_CHECK_INJECTOR.injector = <span class="keyword">new</span> FixedLoaderActivityInjector()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FixedLoaderActivityInjector</span> <span class="keyword">extends</span> <span class="title">LoaderActivityInjector</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">def</span> injectClass(ClassPool pool, String dir, Map config) &#123;</span><br><span class="line">        <span class="keyword">def</span> reader = <span class="keyword">new</span> ManifestReader(manifestPath(project, variantDir))</span><br><span class="line">        Method method = LoaderActivityInjector.<span class="keyword">class</span>.getDeclaredMethod(<span class="string">&quot;handleActivity&quot;</span>, ClassPool.<span class="keyword">class</span>, String.<span class="keyword">class</span>, String.<span class="keyword">class</span>)</span><br><span class="line">        method.accessible = <span class="literal">true</span></span><br><span class="line">        reader.activities.each &#123;</span><br><span class="line">            <span class="comment">// 处理没有被忽略的 Activity</span></span><br><span class="line">            <span class="keyword">if</span> (!(it <span class="keyword">in</span> CommonData.ignoredActivities)) &#123;</span><br><span class="line">                <span class="comment">//handleActivity(pool, it, dir)</span></span><br><span class="line">                method.invoke(<span class="built_in">this</span>, pool, it, dir)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 获取 AndroidManifest.xml 路径</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">def</span> <span class="keyword">static</span> manifestPath(Project project, String variantDir) &#123;</span><br><span class="line">        <span class="comment">// Compatible with path separators for window and Linux, and fit split param based on &#x27;Pattern.quote&#x27;</span></span><br><span class="line">        <span class="keyword">def</span> variantDirArray = variantDir.split(Pattern.quote(File.separator))</span><br><span class="line">        String variantName = <span class="string">&quot;&quot;</span></span><br><span class="line">        variantDirArray.each &#123;</span><br><span class="line">            <span class="comment">//首字母大写进行拼接</span></span><br><span class="line">            variantName += it.capitalize()</span><br><span class="line">        &#125;</span><br><span class="line">        println <span class="string">&quot;&gt;&gt;&gt; variantName:$&#123;variantName&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取processManifestTask</span></span><br><span class="line">        <span class="keyword">def</span> processManifestTask = project.tasks.getByName(<span class="string">&quot;process$&#123;variantName&#125;Manifest&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果processManifestTask存在的话</span></span><br><span class="line">        <span class="comment">//transform的task目前能保证在processManifestTask之后执行</span></span><br><span class="line">        <span class="keyword">if</span> (processManifestTask) &#123;</span><br><span class="line">            File result = <span class="literal">null</span></span><br><span class="line">            <span class="comment">//正常的manifest</span></span><br><span class="line">            File manifestOutputFile = <span class="literal">null</span></span><br><span class="line">            <span class="comment">//instant run的manifest</span></span><br><span class="line">            File instantRunManifestOutputFile = <span class="literal">null</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                manifestOutputFile = processManifestTask.getManifestOutputFile()</span><br><span class="line">                instantRunManifestOutputFile = processManifestTask.getInstantRunManifestOutputFile()</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">def</span> dir = processManifestTask.getManifestOutputDirectory()</span><br><span class="line">                <span class="keyword">if</span> (dir <span class="keyword">instanceof</span> File || dir <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">                    manifestOutputFile = <span class="keyword">new</span> File(dir, <span class="string">&quot;AndroidManifest.xml&quot;</span>)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    manifestOutputFile = <span class="keyword">new</span> File(dir.getAsFile().get(), <span class="string">&quot;AndroidManifest.xml&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                dir = processManifestTask.getInstantRunManifestOutputDirectory()</span><br><span class="line">                <span class="keyword">if</span> (dir <span class="keyword">instanceof</span> File || dir <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">                    instantRunManifestOutputFile = <span class="keyword">new</span> File(dir, <span class="string">&quot;AndroidManifest.xml&quot;</span>)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    instantRunManifestOutputFile = <span class="keyword">new</span> File(dir.getAsFile().get(), <span class="string">&quot;AndroidManifest.xml&quot;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (manifestOutputFile == <span class="literal">null</span> &amp;&amp; instantRunManifestOutputFile == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> GradleException(<span class="string">&quot;can&#x27;t get manifest file&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//打印</span></span><br><span class="line">            println <span class="string">&quot; manifestOutputFile:$&#123;manifestOutputFile&#125; $&#123;manifestOutputFile.exists()&#125;&quot;</span></span><br><span class="line">            println <span class="string">&quot; instantRunManifestOutputFile:$&#123;instantRunManifestOutputFile&#125; $&#123;instantRunManifestOutputFile.exists()&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//先设置为正常的manifest</span></span><br><span class="line">            result = manifestOutputFile</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//获取instant run 的Task</span></span><br><span class="line">                <span class="keyword">def</span> instantRunTask = project.tasks.getByName(<span class="string">&quot;transformClassesWithInstantRunFor$&#123;variantName&#125;&quot;</span>)</span><br><span class="line">                <span class="comment">//查找instant run是否存在且文件存在</span></span><br><span class="line">                <span class="keyword">if</span> (instantRunTask &amp;&amp; instantRunManifestOutputFile.exists()) &#123;</span><br><span class="line">                    println <span class="string">&#x27; Instant run is enabled and the manifest is exist.&#x27;</span></span><br><span class="line">                    <span class="keyword">if</span> (!manifestOutputFile.exists()) &#123;</span><br><span class="line">                        <span class="comment">//因为这里只是为了读取activity，所以无论用哪个manifest差别不大</span></span><br><span class="line">                        <span class="comment">//正常情况下不建议用instant run的manifest，除非正常的manifest不存在</span></span><br><span class="line">                        <span class="comment">//只有当正常的manifest不存在时，才会去使用instant run产生的manifest</span></span><br><span class="line">                        result = instantRunManifestOutputFile</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ignored) &#123;</span><br><span class="line">                <span class="comment">// transformClassesWithInstantRunForXXX may not exists</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//最后检测文件是否存在，打印</span></span><br><span class="line">            <span class="keyword">if</span> (!result.exists()) &#123;</span><br><span class="line">                println <span class="string">&#x27; AndroidManifest.xml not exist&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//输出路径</span></span><br><span class="line">            println <span class="string">&quot; AndroidManifest.xml 路径：$result&quot;</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result.absolutePath</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在更高的gradle版本(<code>com.android.tools.build:gradle:3.6.3</code>)上，可能直接编译报红，这里由于replugin-plugin-gradle插件最新版本用的gradle插件版本是2.1.3，两者之间的版本跨度太大了，api肯定有不兼容的问题。</p>
<h2 id="AndroidX问题"><a href="#AndroidX问题" class="headerlink" title="AndroidX问题"></a>AndroidX问题</h2><p>在Androidx上replugin-plugin-gradle插件的Transform API不会替换Androidx包中的Activity类，因为在LoaderActivityInjector中没有指定AndroidX包，可以这样修改：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Field</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.qihoo360.replugin.gradle.plugin.inner.CommonData</span><br><span class="line"><span class="keyword">import</span> com.qihoo360.replugin.gradle.plugin.injector.loaderactivity.LoaderActivityInjector</span><br><span class="line"><span class="keyword">import</span> com.qihoo360.replugin.gradle.plugin.manifest.ManifestReader</span><br><span class="line"><span class="keyword">import</span> com.qihoo360.replugin.gradle.plugin.injector.Injectors</span><br><span class="line"></span><br><span class="line">Injectors.LOADER_ACTIVITY_CHECK_INJECTOR.injector = <span class="keyword">new</span> FixedLoaderActivityInjector()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FixedLoaderActivityInjector</span> <span class="keyword">extends</span> <span class="title">LoaderActivityInjector</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="keyword">private</span> <span class="keyword">static</span> loaderActivityRules = [</span><br><span class="line">            <span class="string">&#x27;android.app.Activity&#x27;</span>                    : <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginActivity&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;android.app.TabActivity&#x27;</span>                 : <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginTabActivity&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;android.app.ListActivity&#x27;</span>                : <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginListActivity&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;android.app.ActivityGroup&#x27;</span>               : <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginActivityGroup&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;android.support.v4.app.FragmentActivity&#x27;</span> : <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginFragmentActivity&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;android.support.v7.app.AppCompatActivity&#x27;</span>: <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginAppCompatActivity&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;android.preference.PreferenceActivity&#x27;</span>   : <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginPreferenceActivity&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;android.app.ExpandableListActivity&#x27;</span>      : <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginExpandableListActivity&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;androidx.appcompat.app.AppCompatActivity&#x27;</span>: <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginAppCompatActivity&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;androidx.fragment.app.FragmentActivity&#x27;</span>  : <span class="string">&#x27;com.qihoo360.replugin.loader.a.PluginFragmentActivity&#x27;</span>,</span><br><span class="line">            <span class="comment">// 其它需要替换的androidx规则</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">def</span> injectClass(ClassPool pool, String dir, Map config) &#123;</span><br><span class="line">        <span class="keyword">def</span> reader = <span class="keyword">new</span> ManifestReader(manifestPath(project, variantDir))</span><br><span class="line">        Field field = LoaderActivityInjector.<span class="keyword">class</span>.getDeclaredField(<span class="string">&quot;loaderActivityRules&quot;</span>)</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>)</span><br><span class="line">        field.set(<span class="literal">null</span>, loaderActivityRules)</span><br><span class="line"></span><br><span class="line">        println(<span class="string">&quot;activities = $&#123;reader.activities&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">        Method method = LoaderActivityInjector.<span class="keyword">class</span>.getDeclaredMethod(<span class="string">&quot;handleActivity&quot;</span>, ClassPool.<span class="keyword">class</span>, String.<span class="keyword">class</span>, String.<span class="keyword">class</span>)</span><br><span class="line">        method.accessible = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">        reader.activities.each &#123;</span><br><span class="line">            <span class="comment">// 处理没有被忽略的 Activity</span></span><br><span class="line">            <span class="keyword">if</span> (!(it <span class="keyword">in</span> CommonData.ignoredActivities)) &#123;</span><br><span class="line">                println(<span class="string">&quot;begin to invoke: $&#123;it&#125;&quot;</span>)</span><br><span class="line">                method.invoke(<span class="built_in">this</span>, pool, it, dir)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于LocalBroadcastInjector也可以参照这个修改。</p>
<h1 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h1><p>RePlugin初始化以及插件加载流程如下图：</p>
<p><img src="RePlugin.jpg" alt="RePlugin"></p>
<p>Activity简要启动流程如下图：</p>
<p><img src="Activity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B.webp" alt="Activity启动流程"></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android/" rel="tag"># Android</a>
              <a href="/tags/%E6%8F%92%E4%BB%B6%E5%8C%96/" rel="tag"># 插件化</a>
              <a href="/tags/RePlugin/" rel="tag"># RePlugin</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/03/18/Android-Activity%E5%8E%9F%E7%90%86/" rel="prev" title="Android-Activity原理">
      <i class="fa fa-chevron-left"></i> Android-Activity原理
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/03/25/Android%E7%B3%BB%E7%BB%9F%E5%90%AF%E5%8A%A8%E4%B8%8E%E8%BF%9B%E7%A8%8B%E7%9B%B8%E5%85%B3%E5%88%86%E4%BA%AB/" rel="next" title="Android系统启动与进程相关分享">
      Android系统启动与进程相关分享 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84"><span class="nav-number">2.</span> <span class="nav-text">项目结构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#replugin-host-gradle"><span class="nav-number">2.1.</span> <span class="nav-text">replugin-host-gradle</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#replugin-host-library"><span class="nav-number">2.2.</span> <span class="nav-text">replugin-host-library</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#replugin-plugin-gradle"><span class="nav-number">2.3.</span> <span class="nav-text">replugin-plugin-gradle</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#replugin-plugin-library"><span class="nav-number">2.4.</span> <span class="nav-text">replugin-plugin-library</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ClassLoader"><span class="nav-number">3.</span> <span class="nav-text">ClassLoader</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#RePluginClassLoader"><span class="nav-number">3.1.</span> <span class="nav-text">RePluginClassLoader</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PluginDexClassLoader"><span class="nav-number">3.2.</span> <span class="nav-text">PluginDexClassLoader</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%9D%E8%80%83"><span class="nav-number">3.3.</span> <span class="nav-text">思考</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E7%B1%BB"><span class="nav-number">4.</span> <span class="nav-text">相关类</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0-1"><span class="nav-number">4.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PMF-java"><span class="nav-number">4.2.</span> <span class="nav-text">PMF.java</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PmBase-java"><span class="nav-number">4.3.</span> <span class="nav-text">PmBase.java</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PmHostSvc-java"><span class="nav-number">4.4.</span> <span class="nav-text">PmHostSvc.java</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IPluginHost-aidl"><span class="nav-number">4.5.</span> <span class="nav-text">IPluginHost.aidl</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IPluginManagerServer-aidl"><span class="nav-number">4.6.</span> <span class="nav-text">IPluginManagerServer.aidl</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PluginManagerServer-java"><span class="nav-number">4.7.</span> <span class="nav-text">PluginManagerServer.java</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PluginManagerProxy-java"><span class="nav-number">4.8.</span> <span class="nav-text">PluginManagerProxy.java</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5"><span class="nav-number">5.</span> <span class="nav-text">相关概念</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%94%AF%E4%B8%80Hook"><span class="nav-number">5.1.</span> <span class="nav-text">唯一Hook</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UI-Persistent%E8%BF%9B%E7%A8%8B"><span class="nav-number">5.2.</span> <span class="nav-text">UI&#x2F;Persistent进程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9D%91%E4%BD%8D"><span class="nav-number">5.3.</span> <span class="nav-text">坑位</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RePlugin%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">6.</span> <span class="nav-text">RePlugin初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">6.1.</span> <span class="nav-text">初始化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Persistent%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8"><span class="nav-number">6.2.</span> <span class="nav-text">Persistent进程启动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#initForServer"><span class="nav-number">6.2.1.</span> <span class="nav-text">initForServer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PluginProcessMain-installHost"><span class="nav-number">6.2.2.</span> <span class="nav-text">PluginProcessMain.installHost</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PluginManagerProxy-load"><span class="nav-number">6.2.3.</span> <span class="nav-text">PluginManagerProxy.load</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-number">6.2.4.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UI%E8%BF%9B%E7%A8%8B%E5%90%AF%E5%8A%A8"><span class="nav-number">6.3.</span> <span class="nav-text">UI进程启动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#initForClient"><span class="nav-number">6.3.1.</span> <span class="nav-text">initForClient</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PluginProcessMain-connectToHostSvc"><span class="nav-number">6.3.2.</span> <span class="nav-text">PluginProcessMain.connectToHostSvc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#refreshPluginsFromHostSvc"><span class="nav-number">6.3.3.</span> <span class="nav-text">refreshPluginsFromHostSvc</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-1"><span class="nav-number">6.3.4.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#callAttach"><span class="nav-number">6.4.</span> <span class="nav-text">callAttach</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">6.5.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8F%92%E4%BB%B6%E5%AE%89%E8%A3%85%E5%8E%9F%E7%90%86"><span class="nav-number">7.</span> <span class="nav-text">插件安装原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0-2"><span class="nav-number">7.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E5%85%A5%E5%8F%A3"><span class="nav-number">7.2.</span> <span class="nav-text">安装入口</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%89%E8%A3%85%E6%8F%92%E4%BB%B6"><span class="nav-number">7.3.</span> <span class="nav-text">安装插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E6%8F%92%E4%BB%B6"><span class="nav-number">7.4.</span> <span class="nav-text">更新插件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%80%9A%E7%9F%A5%E6%9B%B4%E6%96%B0%E5%86%85%E5%AD%98"><span class="nav-number">7.5.</span> <span class="nav-text">通知更新内存</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Activity%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B"><span class="nav-number">8.</span> <span class="nav-text">Activity启动流程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="nav-number">8.1.</span> <span class="nav-text">准备工作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8F%92%E4%BB%B6%E5%8A%A0%E8%BD%BD"><span class="nav-number">8.2.</span> <span class="nav-text">插件加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%BB%E6%89%BE%E5%9D%91%E4%BD%8D"><span class="nav-number">8.3.</span> <span class="nav-text">寻找坑位</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9D%91%E4%BD%8D%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">8.3.1.</span> <span class="nav-text">坑位初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#LaunchModeStates"><span class="nav-number">8.3.1.1.</span> <span class="nav-text">LaunchModeStates</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PluginContainers-init"><span class="nav-number">8.3.1.2.</span> <span class="nav-text">PluginContainers.init</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#allocActivityContainer"><span class="nav-number">8.3.2.</span> <span class="nav-text">allocActivityContainer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#alloc-amp-alloc2"><span class="nav-number">8.3.3.</span> <span class="nav-text">alloc&amp;alloc2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#allocLocked"><span class="nav-number">8.3.4.</span> <span class="nav-text">allocLocked</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8Activity"><span class="nav-number">8.4.</span> <span class="nav-text">启动Activity</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8F%92%E4%BB%B6%E5%8A%A0%E8%BD%BD%E5%8E%9F%E7%90%86"><span class="nav-number">9.</span> <span class="nav-text">插件加载原理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Plugin%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B"><span class="nav-number">9.1.</span> <span class="nav-text">Plugin加载过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Plugin%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">9.2.</span> <span class="nav-text">Plugin初始化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Host-Plugin%E7%B1%BB%E5%8F%8D%E5%B0%84%E5%85%B3%E7%B3%BB"><span class="nav-number">9.3.</span> <span class="nav-text">Host&#x2F;Plugin类反射关系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8F%92%E4%BB%B6%E4%B8%AD%E7%9A%84Context"><span class="nav-number">9.4.</span> <span class="nav-text">插件中的Context</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8F%92%E4%BB%B6%E4%B8%AD%E5%90%AF%E5%8A%A8Activity"><span class="nav-number">9.5.</span> <span class="nav-text">插件中启动Activity</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86"><span class="nav-number">10.</span> <span class="nav-text">进程管理</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96-1"><span class="nav-number">10.1.</span> <span class="nav-text">初始化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%9B%E7%A8%8B%E5%88%86%E7%B1%BB"><span class="nav-number">10.2.</span> <span class="nav-text">进程分类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%B0%83%E6%95%B4%E6%8F%92%E4%BB%B6%E8%BF%9B%E7%A8%8B%E5%90%8D%E7%A7%B0"><span class="nav-number">10.3.</span> <span class="nav-text">调整插件进程名称</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E8%BF%9B%E7%A8%8B%EF%BC%9AloadPluginActivity"><span class="nav-number">10.4.</span> <span class="nav-text">请求进程：loadPluginActivity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E9%A9%BB%E8%BF%9B%E7%A8%8B%EF%BC%9A%E5%90%AF%E5%8A%A8%E7%9B%AE%E6%A0%87%E8%BF%9B%E7%A8%8B"><span class="nav-number">10.5.</span> <span class="nav-text">常驻进程：启动目标进程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#startPluginProcess"><span class="nav-number">10.5.1.</span> <span class="nav-text">startPluginProcess</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PluginProcessMain-allocProcess"><span class="nav-number">10.5.2.</span> <span class="nav-text">PluginProcessMain.allocProcess</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PluginProviderStub-proxyStartPluginProcess"><span class="nav-number">10.5.3.</span> <span class="nav-text">PluginProviderStub.proxyStartPluginProcess</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PluginProcessMain-probePluginClient"><span class="nav-number">10.5.4.</span> <span class="nav-text">PluginProcessMain.probePluginClient</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%BE%E8%A7%A3"><span class="nav-number">10.6.</span> <span class="nav-text">图解</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8F%92%E4%BB%B6-%E5%AE%BF%E4%B8%BB%E9%97%B4Binder"><span class="nav-number">11.</span> <span class="nav-text">插件&#x2F;宿主间Binder</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%B5%84%E6%BA%90"><span class="nav-number">12.</span> <span class="nav-text">资源</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#replugin-host-gradle-1"><span class="nav-number">13.</span> <span class="nav-text">replugin-host-gradle</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0-3"><span class="nav-number">13.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E5%B8%A6%E5%9D%91%E4%BD%8DAndroidManifest-xml"><span class="nav-number">13.2.</span> <span class="nav-text">生成带坑位AndroidManifest.xml</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E6%88%90RePluginHostConfig%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">13.3.</span> <span class="nav-text">生成RePluginHostConfig配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E6%8F%92%E4%BB%B6%E4%BF%A1%E6%81%AFjson%E6%96%87%E4%BB%B6"><span class="nav-number">13.4.</span> <span class="nav-text">生成插件信息json文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8B%BC%E8%A3%85AndroidManifest-xml"><span class="nav-number">13.5.</span> <span class="nav-text">拼装AndroidManifest.xml</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#replugin-plugin-gradle-1"><span class="nav-number">14.</span> <span class="nav-text">replugin-plugin-gradle</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0-4"><span class="nav-number">14.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E7%94%A8%E4%BA%8E%E8%B0%83%E8%AF%95%E7%9A%84task"><span class="nav-number">14.2.</span> <span class="nav-text">生成用于调试的task</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E7%BC%96%E8%AF%91%E6%96%B9%E6%A1%88"><span class="nav-number">14.3.</span> <span class="nav-text">动态编译方案</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#transform"><span class="nav-number">14.3.1.</span> <span class="nav-text">transform</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#doTransform"><span class="nav-number">14.3.2.</span> <span class="nav-text">doTransform</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#doInject"><span class="nav-number">14.3.3.</span> <span class="nav-text">doInject</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LoaderActivityInjector"><span class="nav-number">14.3.4.</span> <span class="nav-text">LoaderActivityInjector</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LocalBroadcastInjector"><span class="nav-number">14.3.5.</span> <span class="nav-text">LocalBroadcastInjector</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ProviderInjector"><span class="nav-number">14.3.6.</span> <span class="nav-text">ProviderInjector</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ProviderInjector2"><span class="nav-number">14.3.7.</span> <span class="nav-text">ProviderInjector2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GetIdentifierInjector"><span class="nav-number">14.3.8.</span> <span class="nav-text">GetIdentifierInjector</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gradle%E9%AB%98%E7%89%88%E6%9C%AC%E9%97%AE%E9%A2%98"><span class="nav-number">14.4.</span> <span class="nav-text">gradle高版本问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#AndroidX%E9%97%AE%E9%A2%98"><span class="nav-number">14.5.</span> <span class="nav-text">AndroidX问题</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-1"><span class="nav-number">15.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="苍耳叔叔"
      src="/images/head.png">
  <p class="site-author-name" itemprop="name">苍耳叔叔</p>
  <div class="site-description" itemprop="description">梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">159</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">40</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ljd1996" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ljd1996" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hearing1996@gmail.com" title="E-Mail → mailto:hearing1996@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">苍耳叔叔</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : true,
      notify     : true,
      appId      : 'pCnIlzs46HJGpubm7D3TnrBC-gzGzoHsz',
      appKey     : '7LzW4wBI9lY5DtVFNkFWcjs0',
      placeholder: "欢迎评论交流！",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
