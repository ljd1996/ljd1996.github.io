<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="概述注：本文基于Android 9.0源码，为了文章的简洁性，引用源码的地方可能有所删减。 在Framework层也有一套Binder的通信架构，它的实现最终是通过Native层结合Binder驱动来完成的。">
<meta property="og:type" content="article">
<meta property="og:title" content="Android-Binder原理三-Framework">
<meta property="og:url" content="http://yoursite.com/2020/06/30/Android-Binder%E5%8E%9F%E7%90%86%E4%B8%89-FrameWork/index.html">
<meta property="og:site_name" content="苍耳的博客">
<meta property="og:description" content="概述注：本文基于Android 9.0源码，为了文章的简洁性，引用源码的地方可能有所删减。 在Framework层也有一套Binder的通信架构，它的实现最终是通过Native层结合Binder驱动来完成的。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/2020/06/30/Android-Binder%E5%8E%9F%E7%90%86%E4%B8%89-FrameWork/java_binder.jpg">
<meta property="article:published_time" content="2020-06-30T12:20:35.000Z">
<meta property="article:modified_time" content="2021-05-14T06:14:57.716Z">
<meta property="article:author" content="苍耳叔叔">
<meta property="article:tag" content="Android">
<meta property="article:tag" content="Binder">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2020/06/30/Android-Binder%E5%8E%9F%E7%90%86%E4%B8%89-FrameWork/java_binder.jpg">

<link rel="canonical" href="http://yoursite.com/2020/06/30/Android-Binder%E5%8E%9F%E7%90%86%E4%B8%89-FrameWork/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Android-Binder原理三-Framework | 苍耳的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">苍耳的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">细水长流</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/30/Android-Binder%E5%8E%9F%E7%90%86%E4%B8%89-FrameWork/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Android-Binder原理三-Framework
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-06-30 20:20:35" itemprop="dateCreated datePublished" datetime="2020-06-30T20:20:35+08:00">2020-06-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/Binder/" itemprop="url" rel="index"><span itemprop="name">Binder</span></a>
                </span>
            </span>

          
            <span id="/2020/06/30/Android-Binder%E5%8E%9F%E7%90%86%E4%B8%89-FrameWork/" class="post-meta-item leancloud_visitors" data-flag-title="Android-Binder原理三-Framework" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2020/06/30/Android-Binder%E5%8E%9F%E7%90%86%E4%B8%89-FrameWork/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/06/30/Android-Binder%E5%8E%9F%E7%90%86%E4%B8%89-FrameWork/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>注：本文基于Android 9.0源码，为了文章的简洁性，引用源码的地方可能有所删减。</p>
<p>在Framework层也有一套Binder的通信架构，它的实现最终是通过Native层结合Binder驱动来完成的。</p>
<a id="more"></a>

<h1 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h1><h2 id="startReg"><a href="#startReg" class="headerlink" title="startReg"></a>startReg</h2><p>在Android系统开机过程中，Zygote进程启动时会进行虚拟机注册，该过程调用AndroidRuntime::startReg方法来完成jni方法的注册：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> RegJNIRec gRegJNI[] = &#123;</span><br><span class="line">    REG_JNI(register_com_android_internal_os_RuntimeInit),</span><br><span class="line">    REG_JNI(register_com_android_internal_os_ZygoteInit_nativeZygoteInit),</span><br><span class="line">    REG_JNI(register_android_os_SystemClock),</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    REG_JNI(register_android_os_Binder),</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">AndroidRuntime::startReg</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (register_jni_procs(gRegJNI, NELEM(gRegJNI), env) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// android_util_Binder.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_android_os_Binder</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 注册Binder类的jni方法</span></span><br><span class="line">    <span class="keyword">if</span> (int_register_android_os_Binder(env) &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">// 注册BinderInternal类的jni方法</span></span><br><span class="line">    <span class="keyword">if</span> (int_register_android_os_BinderInternal(env) &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="comment">// 注册BinderProxy类的jni方法</span></span><br><span class="line">    <span class="keyword">if</span> (int_register_android_os_BinderProxy(env) &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    jclass clazz = FindClassOrDie(env, <span class="string">&quot;android/util/Log&quot;</span>);</span><br><span class="line">    gLogOffsets.mClass = MakeGlobalRefOrDie(env, clazz);</span><br><span class="line">    gLogOffsets.mLogE = GetStaticMethodIDOrDie(env, clazz, <span class="string">&quot;e&quot;</span>, <span class="string">&quot;(Ljava/lang/String;Ljava/lang/String;Ljava/lang/Throwable;)I&quot;</span>);</span><br><span class="line"></span><br><span class="line">    clazz = FindClassOrDie(env, <span class="string">&quot;android/os/ParcelFileDescriptor&quot;</span>);</span><br><span class="line">    gParcelFileDescriptorOffsets.mClass = MakeGlobalRefOrDie(env, clazz);</span><br><span class="line">    gParcelFileDescriptorOffsets.mConstructor = GetMethodIDOrDie(env, clazz, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;(Ljava/io/FileDescriptor;)V&quot;</span>);</span><br><span class="line"></span><br><span class="line">    clazz = FindClassOrDie(env, <span class="string">&quot;android/os/StrictMode&quot;</span>);</span><br><span class="line">    gStrictModeCallbackOffsets.mClass = MakeGlobalRefOrDie(env, clazz);</span><br><span class="line">    gStrictModeCallbackOffsets.mCallback = GetStaticMethodIDOrDie(env, clazz, <span class="string">&quot;onBinderStrictModePolicyChange&quot;</span>, <span class="string">&quot;(I)V&quot;</span>);</span><br><span class="line"></span><br><span class="line">    clazz = FindClassOrDie(env, <span class="string">&quot;java/lang/Thread&quot;</span>);</span><br><span class="line">    gThreadDispatchOffsets.mClass = MakeGlobalRefOrDie(env, clazz);</span><br><span class="line">    gThreadDispatchOffsets.mDispatchUncaughtException = GetMethodIDOrDie(env, clazz, <span class="string">&quot;dispatchUncaughtException&quot;</span>, <span class="string">&quot;(Ljava/lang/Throwable;)V&quot;</span>);</span><br><span class="line">    gThreadDispatchOffsets.mCurrentThread = GetStaticMethodIDOrDie(env, clazz, <span class="string">&quot;currentThread&quot;</span>, <span class="string">&quot;()Ljava/lang/Thread;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>涉及到的相关方法如下：</p>
<ul>
<li><code>FindClassOrDie(env, kBinderPathName)</code>相当于<code>env-&gt;FindClass(kBinderPathName)</code></li>
<li><code>MakeGlobalRefOrDie()</code>相当于<code>env-&gt;NewGlobalRef()</code></li>
<li><code>GetMethodIDOrDie()</code>相当于<code>env-&gt;GetMethodID()</code></li>
<li><code>GetFieldIDOrDie()</code>相当于<code>env-&gt;GeFieldID()</code></li>
<li><code>RegisterMethodsOrDie()</code>相当于<code>Android::registerNativeMethods()</code></li>
</ul>
<h2 id="注册Binder类"><a href="#注册Binder类" class="headerlink" title="注册Binder类"></a>注册Binder类</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// android_util_Binder.cpp</span></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">bindernative_offsets_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    jclass mClass; <span class="comment">// 记录Binder类</span></span><br><span class="line">    jmethodID mExecTransact; <span class="comment">// 记录execTransact()方法</span></span><br><span class="line">    jfieldID mObject; <span class="comment">// 记录mObject属性</span></span><br><span class="line">&#125; gBinderOffsets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> JNINativeMethod gBinderMethods[] = &#123;</span><br><span class="line">    <span class="comment">/* name, signature, funcPtr */</span></span><br><span class="line">    &#123; <span class="string">&quot;getCallingPid&quot;</span>, <span class="string">&quot;()I&quot;</span>, (<span class="keyword">void</span>*)android_os_Binder_getCallingPid &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;getCallingUid&quot;</span>, <span class="string">&quot;()I&quot;</span>, (<span class="keyword">void</span>*)android_os_Binder_getCallingUid &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;clearCallingIdentity&quot;</span>, <span class="string">&quot;()J&quot;</span>, (<span class="keyword">void</span>*)android_os_Binder_clearCallingIdentity &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;restoreCallingIdentity&quot;</span>, <span class="string">&quot;(J)V&quot;</span>, (<span class="keyword">void</span>*)android_os_Binder_restoreCallingIdentity &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;setThreadStrictModePolicy&quot;</span>, <span class="string">&quot;(I)V&quot;</span>, (<span class="keyword">void</span>*)android_os_Binder_setThreadStrictModePolicy &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;getThreadStrictModePolicy&quot;</span>, <span class="string">&quot;()I&quot;</span>, (<span class="keyword">void</span>*)android_os_Binder_getThreadStrictModePolicy &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;flushPendingCommands&quot;</span>, <span class="string">&quot;()V&quot;</span>, (<span class="keyword">void</span>*)android_os_Binder_flushPendingCommands &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;getNativeBBinderHolder&quot;</span>, <span class="string">&quot;()J&quot;</span>, (<span class="keyword">void</span>*)android_os_Binder_getNativeBBinderHolder &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;getNativeFinalizer&quot;</span>, <span class="string">&quot;()J&quot;</span>, (<span class="keyword">void</span>*)android_os_Binder_getNativeFinalizer &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;blockUntilThreadAvailable&quot;</span>, <span class="string">&quot;()V&quot;</span>, (<span class="keyword">void</span>*)android_os_Binder_blockUntilThreadAvailable &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span> kBinderPathName = <span class="string">&quot;android/os/Binder&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">int_register_android_os_Binder</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    jclass clazz = FindClassOrDie(env, kBinderPathName);</span><br><span class="line">    <span class="comment">// 将Java层Binder类保存到mClass变量</span></span><br><span class="line">    gBinderOffsets.mClass = MakeGlobalRefOrDie(env, clazz);</span><br><span class="line">    <span class="comment">// 将Java层execTransact()方法保存到mExecTransact变量</span></span><br><span class="line">    gBinderOffsets.mExecTransact = GetMethodIDOrDie(env, clazz, <span class="string">&quot;execTransact&quot;</span>, <span class="string">&quot;(IJJI)Z&quot;</span>);</span><br><span class="line">    <span class="comment">// 将Java层mObject属性保存到mObject变量</span></span><br><span class="line">    gBinderOffsets.mObject = GetFieldIDOrDie(env, clazz, <span class="string">&quot;mObject&quot;</span>, <span class="string">&quot;J&quot;</span>);</span><br><span class="line">    <span class="comment">// 注册JNI方法</span></span><br><span class="line">    <span class="keyword">return</span> RegisterMethodsOrDie(env, kBinderPathName, gBinderMethods, NELEM(gBinderMethods));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>int_register_android_os_Binder方法的主要功能：</p>
<ul>
<li>通过gBinderOffsets，保存Java层Binder类的信息，为JNI层访问Java层提供通道；</li>
<li>通过RegisterMethodsOrDie，将gBinderMethods数组完成映射关系，从而为Java层访问JNI层提供通道。也就是说该过程建立了Binder类在Native层与framework层之间的相互调用的桥梁。</li>
</ul>
<h2 id="注册BinderInternal类"><a href="#注册BinderInternal类" class="headerlink" title="注册BinderInternal类"></a>注册BinderInternal类</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">binderinternal_offsets_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    jclass mClass;</span><br><span class="line">    jmethodID mForceGc;</span><br><span class="line">    jmethodID mProxyLimitCallback;</span><br><span class="line"></span><br><span class="line">&#125; gBinderInternalOffsets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> JNINativeMethod gBinderInternalMethods[] = &#123;</span><br><span class="line">    <span class="comment">/* name, signature, funcPtr */</span></span><br><span class="line">    &#123; <span class="string">&quot;getContextObject&quot;</span>, <span class="string">&quot;()Landroid/os/IBinder;&quot;</span>, (<span class="keyword">void</span>*)android_os_BinderInternal_getContextObject &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;joinThreadPool&quot;</span>, <span class="string">&quot;()V&quot;</span>, (<span class="keyword">void</span>*)android_os_BinderInternal_joinThreadPool &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;disableBackgroundScheduling&quot;</span>, <span class="string">&quot;(Z)V&quot;</span>, (<span class="keyword">void</span>*)android_os_BinderInternal_disableBackgroundScheduling &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;setMaxThreads&quot;</span>, <span class="string">&quot;(I)V&quot;</span>, (<span class="keyword">void</span>*)android_os_BinderInternal_setMaxThreads &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;handleGc&quot;</span>, <span class="string">&quot;()V&quot;</span>, (<span class="keyword">void</span>*)android_os_BinderInternal_handleGc &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;nSetBinderProxyCountEnabled&quot;</span>, <span class="string">&quot;(Z)V&quot;</span>, (<span class="keyword">void</span>*)android_os_BinderInternal_setBinderProxyCountEnabled &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;nGetBinderProxyPerUidCounts&quot;</span>, <span class="string">&quot;()Landroid/util/SparseIntArray;&quot;</span>, (<span class="keyword">void</span>*)android_os_BinderInternal_getBinderProxyPerUidCounts &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;nGetBinderProxyCount&quot;</span>, <span class="string">&quot;(I)I&quot;</span>, (<span class="keyword">void</span>*)android_os_BinderInternal_getBinderProxyCount &#125;,</span><br><span class="line">    &#123; <span class="string">&quot;nSetBinderProxyCountWatermarks&quot;</span>, <span class="string">&quot;(II)V&quot;</span>, (<span class="keyword">void</span>*)android_os_BinderInternal_setBinderProxyCountWatermarks&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span> kBinderInternalPathName = <span class="string">&quot;com/android/internal/os/BinderInternal&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">int_register_android_os_BinderInternal</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    jclass clazz = FindClassOrDie(env, kBinderInternalPathName);</span><br><span class="line"></span><br><span class="line">    gBinderInternalOffsets.mClass = MakeGlobalRefOrDie(env, clazz);</span><br><span class="line">    gBinderInternalOffsets.mForceGc = GetStaticMethodIDOrDie(env, clazz, <span class="string">&quot;forceBinderGc&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">    gBinderInternalOffsets.mProxyLimitCallback = GetStaticMethodIDOrDie(env, clazz, <span class="string">&quot;binderProxyLimitCallbackFromNative&quot;</span>, <span class="string">&quot;(I)V&quot;</span>);</span><br><span class="line"></span><br><span class="line">    jclass SparseIntArrayClass = FindClassOrDie(env, <span class="string">&quot;android/util/SparseIntArray&quot;</span>);</span><br><span class="line">    gSparseIntArrayOffsets.classObject = MakeGlobalRefOrDie(env, SparseIntArrayClass);</span><br><span class="line">    gSparseIntArrayOffsets.constructor = GetMethodIDOrDie(env, gSparseIntArrayOffsets.classObject, <span class="string">&quot;&lt;init&gt;&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">    gSparseIntArrayOffsets.put = GetMethodIDOrDie(env, gSparseIntArrayOffsets.classObject, <span class="string">&quot;put&quot;</span>, <span class="string">&quot;(II)V&quot;</span>);</span><br><span class="line"></span><br><span class="line">    BpBinder::setLimitCallback(android_os_BinderInternal_proxyLimitcallback);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> RegisterMethodsOrDie(env, kBinderInternalPathName, gBinderInternalMethods, NELEM(gBinderInternalMethods));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="注册BinderProxy类"><a href="#注册BinderProxy类" class="headerlink" title="注册BinderProxy类"></a>注册BinderProxy类</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">error_offsets_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    jclass mClass;</span><br><span class="line">&#125; gErrorOffsets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">binderproxy_offsets_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    jclass mClass;</span><br><span class="line">    jmethodID mGetInstance;</span><br><span class="line">    jmethodID mSendDeathNotice;</span><br><span class="line">    jmethodID mDumpProxyDebugInfo;</span><br><span class="line">    jfieldID mNativeData;  <span class="comment">// Field holds native pointer to BinderProxyNativeData.</span></span><br><span class="line">&#125; gBinderProxyOffsets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">class_offsets_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    jmethodID mGetName;</span><br><span class="line">&#125; gClassOffsets;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> JNINativeMethod gBinderProxyMethods[] = &#123;</span><br><span class="line">    <span class="comment">/* name, signature, funcPtr */</span></span><br><span class="line">    &#123;<span class="string">&quot;pingBinder&quot;</span>,          <span class="string">&quot;()Z&quot;</span>, (<span class="keyword">void</span>*)android_os_BinderProxy_pingBinder&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;isBinderAlive&quot;</span>,       <span class="string">&quot;()Z&quot;</span>, (<span class="keyword">void</span>*)android_os_BinderProxy_isBinderAlive&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;getInterfaceDescriptor&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>, (<span class="keyword">void</span>*)android_os_BinderProxy_getInterfaceDescriptor&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;transactNative&quot;</span>,      <span class="string">&quot;(ILandroid/os/Parcel;Landroid/os/Parcel;I)Z&quot;</span>, (<span class="keyword">void</span>*)android_os_BinderProxy_transact&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;linkToDeath&quot;</span>,         <span class="string">&quot;(Landroid/os/IBinder$DeathRecipient;I)V&quot;</span>, (<span class="keyword">void</span>*)android_os_BinderProxy_linkToDeath&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;unlinkToDeath&quot;</span>,       <span class="string">&quot;(Landroid/os/IBinder$DeathRecipient;I)Z&quot;</span>, (<span class="keyword">void</span>*)android_os_BinderProxy_unlinkToDeath&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;getNativeFinalizer&quot;</span>,  <span class="string">&quot;()J&quot;</span>, (<span class="keyword">void</span>*)android_os_BinderProxy_getNativeFinalizer&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>* <span class="keyword">const</span> kBinderProxyPathName = <span class="string">&quot;android/os/BinderProxy&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">int_register_android_os_BinderProxy</span><span class="params">(JNIEnv* env)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    jclass clazz = FindClassOrDie(env, <span class="string">&quot;java/lang/Error&quot;</span>);</span><br><span class="line">    gErrorOffsets.mClass = MakeGlobalRefOrDie(env, clazz);</span><br><span class="line"></span><br><span class="line">    clazz = FindClassOrDie(env, kBinderProxyPathName);</span><br><span class="line">    gBinderProxyOffsets.mClass = MakeGlobalRefOrDie(env, clazz);</span><br><span class="line">    gBinderProxyOffsets.mGetInstance = GetStaticMethodIDOrDie(env, clazz, <span class="string">&quot;getInstance&quot;</span>, <span class="string">&quot;(JJ)Landroid/os/BinderProxy;&quot;</span>);</span><br><span class="line">    gBinderProxyOffsets.mSendDeathNotice = GetStaticMethodIDOrDie(env, clazz, <span class="string">&quot;sendDeathNotice&quot;</span>, <span class="string">&quot;(Landroid/os/IBinder$DeathRecipient;)V&quot;</span>);</span><br><span class="line">    gBinderProxyOffsets.mDumpProxyDebugInfo = GetStaticMethodIDOrDie(env, clazz, <span class="string">&quot;dumpProxyDebugInfo&quot;</span>, <span class="string">&quot;()V&quot;</span>);</span><br><span class="line">    gBinderProxyOffsets.mNativeData = GetFieldIDOrDie(env, clazz, <span class="string">&quot;mNativeData&quot;</span>, <span class="string">&quot;J&quot;</span>);</span><br><span class="line"></span><br><span class="line">    clazz = FindClassOrDie(env, <span class="string">&quot;java/lang/Class&quot;</span>);</span><br><span class="line">    gClassOffsets.mGetName = GetMethodIDOrDie(env, clazz, <span class="string">&quot;getName&quot;</span>, <span class="string">&quot;()Ljava/lang/String;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> RegisterMethodsOrDie(env, kBinderProxyPathName, gBinderProxyMethods, NELEM(gBinderProxyMethods));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="注册服务"><a href="#注册服务" class="headerlink" title="注册服务"></a>注册服务</h1><h2 id="ServiceManager-addService"><a href="#ServiceManager-addService" class="headerlink" title="ServiceManager.addService"></a>ServiceManager.addService</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addService</span><span class="params">(String name, IBinder service, <span class="keyword">boolean</span> allowIsolated,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span> dumpPriority)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        getIServiceManager().addService(name, service, allowIsolated, dumpPriority);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;error in addService&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IServiceManager <span class="title">getIServiceManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (sServiceManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> sServiceManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sServiceManager = ServiceManagerNative.asInterface(Binder.allowBlocking(BinderInternal.getContextObject()));</span><br><span class="line">    <span class="keyword">return</span> sServiceManager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// android_util_Binder.cpp</span></span><br><span class="line"><span class="comment">// BinderInternal.getContextObject()对应JNI方法</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> jobject <span class="title">android_os_BinderInternal_getContextObject</span><span class="params">(JNIEnv* env, jobject clazz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 等价于new BpBinder(0)</span></span><br><span class="line">    sp&lt;IBinder&gt; b = ProcessState::self()-&gt;getContextObject(NULL);</span><br><span class="line">    <span class="keyword">return</span> javaObjectForIBinder(env, b);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">jobject <span class="title">javaObjectForIBinder</span><span class="params">(JNIEnv* env, <span class="keyword">const</span> sp&lt;IBinder&gt;&amp; val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (val == NULL) <span class="keyword">return</span> NULL;</span><br><span class="line"></span><br><span class="line">    BinderProxyNativeData* nativeData = gNativeDataCache;</span><br><span class="line">    <span class="keyword">if</span> (nativeData == nullptr) &#123;</span><br><span class="line">        nativeData = <span class="keyword">new</span> BinderProxyNativeData();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用getInstance方法获取BinderProxy对象实例</span></span><br><span class="line">    jobject object = env-&gt;CallStaticObjectMethod(gBinderProxyOffsets.mClass,</span><br><span class="line">            gBinderProxyOffsets.mGetInstance, (jlong) nativeData, (jlong) val.get());</span><br><span class="line">    <span class="keyword">if</span> (env-&gt;ExceptionCheck()) &#123;</span><br><span class="line">        <span class="comment">// In the exception case, getInstance still took ownership of nativeData.</span></span><br><span class="line">        gNativeDataCache = nullptr;</span><br><span class="line">        <span class="keyword">return</span> NULL;</span><br><span class="line">    &#125;</span><br><span class="line">    BinderProxyNativeData* actualNativeData = getBPNativeData(env, object);</span><br><span class="line">    <span class="keyword">if</span> (actualNativeData == nativeData) &#123;</span><br><span class="line">        <span class="comment">// New BinderProxy; we still have exclusive access.</span></span><br><span class="line">        nativeData-&gt;mOrgue = <span class="keyword">new</span> DeathRecipientList;</span><br><span class="line">        nativeData-&gt;mObject = val; <span class="comment">// BinderProxy.mNativeData成员变量的mObject记录BpBinder对象</span></span><br><span class="line">        gNativeDataCache = nullptr;</span><br><span class="line">        ++gNumProxies;</span><br><span class="line">        <span class="keyword">if</span> (gNumProxies &gt;= gProxiesWarned + PROXY_WARN_INTERVAL) &#123;</span><br><span class="line">            ALOGW(<span class="string">&quot;Unexpectedly many live BinderProxies: %d\n&quot;</span>, gNumProxies);</span><br><span class="line">            gProxiesWarned = gNumProxies;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// nativeData wasn&#x27;t used. Reuse it the next time.</span></span><br><span class="line">        gNativeDataCache = nativeData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BinderProxyNativeData* getBPNativeData(JNIEnv* env, jobject obj) &#123;</span><br><span class="line">    <span class="keyword">return</span> (BinderProxyNativeData *) env-&gt;GetLongField(obj, gBinderProxyOffsets.mNativeData);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BinderProxy.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> BinderProxy <span class="title">getInstance</span><span class="params">(<span class="keyword">long</span> nativeData, <span class="keyword">long</span> iBinder)</span> </span>&#123;</span><br><span class="line">    BinderProxy result;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        result = sProxyMap.get(iBinder);</span><br><span class="line">        <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        result = <span class="keyword">new</span> BinderProxy(nativeData);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    sProxyMap.set(iBinder, result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">BinderProxy</span><span class="params">(<span class="keyword">long</span> nativeData)</span> </span>&#123;</span><br><span class="line">    mNativeData = nativeData;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Allow blocking calls on the given interface</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IBinder <span class="title">allowBlocking</span><span class="params">(IBinder binder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (binder <span class="keyword">instanceof</span> BinderProxy) &#123;</span><br><span class="line">            ((BinderProxy) binder).mWarnOnBlocking = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (binder != <span class="keyword">null</span> &amp;&amp; binder.getInterfaceDescriptor() != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; binder.queryLocalInterface(binder.getInterfaceDescriptor()) == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Log.w(TAG, <span class="string">&quot;Unable to allow blocking on interface &quot;</span> + binder);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException ignored) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> binder;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceManagerNative</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">IServiceManager</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IServiceManager <span class="title">asInterface</span><span class="params">(IBinder obj)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        IServiceManager in = (IServiceManager)obj.queryLocalInterface(descriptor);</span><br><span class="line">        <span class="keyword">if</span> (in != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> in;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ServiceManagerProxy(obj);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BinderProxy</span></span><br><span class="line"><span class="comment">// BinderProxy代理类返回null（与Service不处于同一个进程）</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> IInterface <span class="title">queryLocalInterface</span><span class="params">(String descriptor)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Binder</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">IBinder</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attachInterface</span><span class="params">(<span class="meta">@Nullable</span> IInterface owner, <span class="meta">@Nullable</span> String descriptor)</span> </span>&#123;</span><br><span class="line">        mOwner = owner;</span><br><span class="line">        mDescriptor = descriptor;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Binder类返回自身（与Service处于同一个进程）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@Nullable</span> <span class="function">IInterface <span class="title">queryLocalInterface</span><span class="params">(<span class="meta">@NonNull</span> String descriptor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mDescriptor != <span class="keyword">null</span> &amp;&amp; mDescriptor.equals(descriptor)) &#123;</span><br><span class="line">            <span class="keyword">return</span> mOwner;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceManagerProxy</span> <span class="keyword">implements</span> <span class="title">IServiceManager</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceManagerProxy</span><span class="params">(IBinder remote)</span> </span>&#123;</span><br><span class="line">        mRemote = remote;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mRemote;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由上可知，<code>ServiceManagerNative.asInterface(Binder.allowBlocking(BinderInternal.getContextObject()))</code>等价于<code>new ServiceManagerProxy(new BinderProxy(nativeData))</code>，其中<code>nativeData-&gt;mObject = new BpBinder(0)</code>，BpBinder作为Binder代理端，指向Native层的Service Manager。</p>
<p>Framework层的ServiceManager的实际工作交给了ServiceManagerProxy的成员变量BinderProxy，而BinderProxy通过JNI方式最终会调用BpBinder对象，因此可知上层Binder架构的核心功能依赖于Native架构的服务来完成。</p>
<h2 id="ServiceManagerProxy-addService"><a href="#ServiceManagerProxy-addService" class="headerlink" title="ServiceManagerProxy.addService"></a>ServiceManagerProxy.addService</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceManagerProxy</span> <span class="keyword">implements</span> <span class="title">IServiceManager</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceManagerProxy</span><span class="params">(IBinder remote)</span> </span>&#123;</span><br><span class="line">        mRemote = remote;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mRemote;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addService</span><span class="params">(String name, IBinder service, <span class="keyword">boolean</span> allowIsolated, <span class="keyword">int</span> dumpPriority)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        Parcel data = Parcel.obtain();</span><br><span class="line">        Parcel reply = Parcel.obtain();</span><br><span class="line">        <span class="comment">// static final String descriptor = &quot;android.os.IServiceManager&quot;;</span></span><br><span class="line">        data.writeInterfaceToken(IServiceManager.descriptor);</span><br><span class="line">        data.writeString(name);</span><br><span class="line">        data.writeStrongBinder(service);</span><br><span class="line">        data.writeInt(allowIsolated ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">        data.writeInt(dumpPriority);</span><br><span class="line">        mRemote.transact(ADD_SERVICE_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">        reply.recycle();</span><br><span class="line">        data.recycle();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">writeStrongBinder</span><span class="params">(IBinder val)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 对应JNI方法android_os_Parcel_writeStrongBinder，具体可见startReg过程</span></span><br><span class="line">    nativeWriteStrongBinder(mNativePtr, val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_os_Parcel_writeStrongBinder</span><span class="params">(JNIEnv* env, jclass clazz, jlong nativePtr, jobject object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 将Java层Parcel转换为Native层Parcel</span></span><br><span class="line">    Parcel* parcel = reinterpret_cast&lt;Parcel*&gt;(nativePtr);</span><br><span class="line">    <span class="keyword">if</span> (parcel != NULL) &#123;</span><br><span class="line">        <span class="keyword">const</span> status_t err = parcel-&gt;writeStrongBinder(ibinderForJavaObject(env, object));</span><br><span class="line">        <span class="keyword">if</span> (err != NO_ERROR) &#123;</span><br><span class="line">            signalExceptionForError(env, clazz, err);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">sp&lt;IBinder&gt; <span class="title">ibinderForJavaObject</span><span class="params">(JNIEnv* env, jobject obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj == NULL) <span class="keyword">return</span> NULL;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instance of Binder?</span></span><br><span class="line">    <span class="keyword">if</span> (env-&gt;IsInstanceOf(obj, gBinderOffsets.mClass)) &#123;</span><br><span class="line">        JavaBBinderHolder* jbh = (JavaBBinderHolder*) env-&gt;GetLongField(obj, gBinderOffsets.mObject);</span><br><span class="line">        <span class="keyword">return</span> jbh-&gt;get(env, obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Instance of BinderProxy?</span></span><br><span class="line">    <span class="keyword">if</span> (env-&gt;IsInstanceOf(obj, gBinderProxyOffsets.mClass)) &#123;</span><br><span class="line">        <span class="keyword">return</span> getBPNativeData(env, obj)-&gt;mObject;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> NULL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JavaBBinderHolder</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">sp&lt;JavaBBinder&gt; <span class="title">get</span><span class="params">(JNIEnv* env, jobject obj)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="function">AutoMutex <span class="title">_l</span><span class="params">(mLock)</span></span>;</span><br><span class="line">        sp&lt;JavaBBinder&gt; b = mBinder.promote();</span><br><span class="line">        <span class="keyword">if</span> (b == NULL) &#123;</span><br><span class="line">            <span class="comment">// 首次进来，创建JavaBBinder对象</span></span><br><span class="line">            b = <span class="keyword">new</span> JavaBBinder(env, obj);</span><br><span class="line">            mBinder = b;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class JavaBBinder : public BBinder</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此可知<code>data.writeStrongBinder(service)</code>最终等价于<code>parcel-&gt;writeStrongBinder(new JavaBBinder(env, obj))</code>，至于<code>parcel-&gt;writeStrongBinder</code>方法，在前面的Native层解析中已经给出。</p>
<h2 id="BinderProxy-transact"><a href="#BinderProxy-transact" class="headerlink" title="BinderProxy.transact"></a>BinderProxy.transact</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">transact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="comment">// 检测Parcel大小是否大于800k</span></span><br><span class="line">    Binder.checkParcel(<span class="keyword">this</span>, code, data, <span class="string">&quot;Unreasonably large binder buffer&quot;</span>);</span><br><span class="line">    <span class="comment">// 对应android_os_BinderProxy_transact方法</span></span><br><span class="line">    <span class="keyword">return</span> transactNative(code, data, reply, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// android_util_Binder.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> jboolean <span class="title">android_os_BinderProxy_transact</span><span class="params">(JNIEnv* env, jobject obj,</span></span></span><br><span class="line"><span class="function"><span class="params">        jint code, jobject dataObj, jobject replyObj, jint flags)</span> <span class="comment">// throws RemoteException</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Java Parcel转为Native Parcel</span></span><br><span class="line">    Parcel* data = parcelForJavaObject(env, dataObj);</span><br><span class="line">    Parcel* reply = parcelForJavaObject(env, replyObj);</span><br><span class="line">    <span class="comment">// BpBinder(0)对象</span></span><br><span class="line">    IBinder* target = getBPNativeData(env, obj)-&gt;mObject.get();</span><br><span class="line">    <span class="keyword">if</span> (target == NULL) &#123;</span><br><span class="line">        jniThrowException(env, <span class="string">&quot;java/lang/IllegalStateException&quot;</span>, <span class="string">&quot;Binder has been finalized!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status_t err = target-&gt;transact(code, *data, reply, flags);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Java层的<code>BinderProxy.transact()</code>最终交由Native层的<code>BpBinder::transact()</code>完成，具体实现过程在之前的Native解析中已经给出。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>ServiceManager.addService注册服务过程实际上是通过Native层来具体实现注册逻辑，通过BpBinder(0)来发送ADD_SERVICE_TRANSACTION命令，与Binder驱动进行数据交互，最终由service_manager进程来完成注册服务的功能。</p>
<h1 id="获取服务"><a href="#获取服务" class="headerlink" title="获取服务"></a>获取服务</h1><h2 id="ServiceManager-getService"><a href="#ServiceManager-getService" class="headerlink" title="ServiceManager.getService"></a>ServiceManager.getService</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IBinder <span class="title">getService</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        IBinder service = sCache.get(name);</span><br><span class="line">        <span class="keyword">if</span> (service != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> service;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Binder.allowBlocking(rawGetService(name));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;error in getService&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> IBinder <span class="title">rawGetService</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> IBinder binder = getIServiceManager().getService(name);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> binder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请求获取服务过程中，先从缓存中查询是否存在，如果缓存中不存在的话，再通过binder交互来查询相应的服务，getIServiceManager返回的是ServiceManagerProxy对象。</p>
<h2 id="ServiceManagerProxy-getService"><a href="#ServiceManagerProxy-getService" class="headerlink" title="ServiceManagerProxy.getService"></a>ServiceManagerProxy.getService</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServiceManagerProxy</span> <span class="keyword">implements</span> <span class="title">IServiceManager</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceManagerProxy</span><span class="params">(IBinder remote)</span> </span>&#123;</span><br><span class="line">        mRemote = remote;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">asBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mRemote;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">getService</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">        Parcel data = Parcel.obtain();</span><br><span class="line">        Parcel reply = Parcel.obtain();</span><br><span class="line">        data.writeInterfaceToken(IServiceManager.descriptor);</span><br><span class="line">        data.writeString(name);</span><br><span class="line">        mRemote.transact(GET_SERVICE_TRANSACTION, data, reply, <span class="number">0</span>);</span><br><span class="line">        IBinder binder = reply.readStrongBinder();</span><br><span class="line">        reply.recycle();</span><br><span class="line">        data.recycle();</span><br><span class="line">        <span class="keyword">return</span> binder;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="BinderProxy-transact-1"><a href="#BinderProxy-transact-1" class="headerlink" title="BinderProxy.transact"></a>BinderProxy.transact</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">transact</span><span class="params">(<span class="keyword">int</span> code, Parcel data, Parcel reply, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</span><br><span class="line">    <span class="comment">// 检测Parcel大小是否大于800k</span></span><br><span class="line">    Binder.checkParcel(<span class="keyword">this</span>, code, data, <span class="string">&quot;Unreasonably large binder buffer&quot;</span>);</span><br><span class="line">    <span class="comment">// 对应android_os_BinderProxy_transact方法</span></span><br><span class="line">    <span class="keyword">return</span> transactNative(code, data, reply, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// android_util_Binder.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> jboolean <span class="title">android_os_BinderProxy_transact</span><span class="params">(JNIEnv* env, jobject obj,</span></span></span><br><span class="line"><span class="function"><span class="params">        jint code, jobject dataObj, jobject replyObj, jint flags)</span> <span class="comment">// throws RemoteException</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Java Parcel转为Native Parcel</span></span><br><span class="line">    Parcel* data = parcelForJavaObject(env, dataObj);</span><br><span class="line">    Parcel* reply = parcelForJavaObject(env, replyObj);</span><br><span class="line">    <span class="comment">// BpBinder(0)对象</span></span><br><span class="line">    IBinder* target = getBPNativeData(env, obj)-&gt;mObject.get();</span><br><span class="line">    <span class="keyword">if</span> (target == NULL) &#123;</span><br><span class="line">        jniThrowException(env, <span class="string">&quot;java/lang/IllegalStateException&quot;</span>, <span class="string">&quot;Binder has been finalized!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    status_t err = target-&gt;transact(code, *data, reply, flags);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟注册服务时一样，Java层的<code>BinderProxy.transact()</code>最终交由Native层的<code>BpBinder::transact()</code>完成，然后从reply中读取Binder对象。</p>
<h2 id="Parcel-readStrongBinder"><a href="#Parcel-readStrongBinder" class="headerlink" title="Parcel.readStrongBinder"></a>Parcel.readStrongBinder</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> IBinder <span class="title">readStrongBinder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> nativeReadStrongBinder(mNativePtr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> jobject <span class="title">android_os_Parcel_readStrongBinder</span><span class="params">(JNIEnv* env, jclass clazz, jlong nativePtr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 将Java层Parcel转换为Native层Parcel</span></span><br><span class="line">    Parcel* parcel = reinterpret_cast&lt;Parcel*&gt;(nativePtr);</span><br><span class="line">    <span class="keyword">if</span> (parcel != NULL) &#123;</span><br><span class="line">        <span class="keyword">return</span> javaObjectForIBinder(env, parcel-&gt;readStrongBinder());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> NULL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>readStrongBinder方法过程基本上是writeStrongBinder的逆过程。经过<code>parcel-&gt;readStrongBinder()</code>方法，最终创建了指向Binder服务端的BpBinder代理对象，然后经过javaObjectForIBinder将Native层BpBinder对象转换为Java层BinderProxy对象，也就是说通过getService()最终获取了指向目标Binder服务端的代理对象BinderProxy。</p>
<h2 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h2><p>ServiceManager.getService获取服务过程实际上是通过Native层来具体实现注册逻辑，通过BpBinder(0)来发送GET_SERVICE_TRANSACTION命令，与Binder驱动进行数据交互，最终由service_manager进程来完成获取服务的功能。获取之后会创建BinderProxy对象，并将BpBinder对象的地址保存到BinderProxy对象中。</p>
<h1 id="死亡通知"><a href="#死亡通知" class="headerlink" title="死亡通知"></a>死亡通知</h1><h2 id="Framework：linkToDeath-unlinkToDeath"><a href="#Framework：linkToDeath-unlinkToDeath" class="headerlink" title="Framework：linkToDeath/unlinkToDeath"></a>Framework：linkToDeath/unlinkToDeath</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">service.linkToDeath(<span class="keyword">new</span> IBinder.DeathRecipient() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binderDied</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;died...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">IBinder</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">linkToDeath</span><span class="params">(<span class="meta">@NonNull</span> DeathRecipient recipient, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">unlinkToDeath</span><span class="params">(<span class="meta">@NonNull</span> DeathRecipient recipient, <span class="keyword">int</span> flags)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BinderProxy</span> <span class="keyword">implements</span> <span class="title">IBinder</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">linkToDeath</span><span class="params">(DeathRecipient recipient, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">boolean</span> <span class="title">unlinkToDeath</span><span class="params">(DeathRecipient recipient, <span class="keyword">int</span> flags)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BinderProxy调用linkToDeath()/unlinkToDeath()方法是一个native方法：android_os_BinderProxy_linkToDeath/android_os_BinderProxy_unlinkToDeath。</p>
<h2 id="linkToDeath"><a href="#linkToDeath" class="headerlink" title="linkToDeath"></a>linkToDeath</h2><h3 id="Native：linkToDeath"><a href="#Native：linkToDeath" class="headerlink" title="Native：linkToDeath"></a>Native：linkToDeath</h3><h4 id="android-os-BinderProxy-linkToDeath"><a href="#android-os-BinderProxy-linkToDeath" class="headerlink" title="android_os_BinderProxy_linkToDeath"></a>android_os_BinderProxy_linkToDeath</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_os_BinderProxy_linkToDeath</span><span class="params">(JNIEnv* env, jobject obj,</span></span></span><br><span class="line"><span class="function"><span class="params">        jobject recipient, jint flags)</span> <span class="comment">// throws RemoteException</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (recipient == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        jniThrowNullPointerException(env, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取BpBinder对象</span></span><br><span class="line">    BinderProxyNativeData *nd = getBPNativeData(env, obj);</span><br><span class="line">    IBinder* target = nd-&gt;mObject.get();</span><br><span class="line">    <span class="comment">// class BpBinder : public IBinder</span></span><br><span class="line">    <span class="keyword">if</span> (!target-&gt;localBinder()) &#123;</span><br><span class="line">        DeathRecipientList* <span class="built_in">list</span> = nd-&gt;mOrgue.get();</span><br><span class="line">        sp&lt;JavaDeathRecipient&gt; jdr = <span class="keyword">new</span> JavaDeathRecipient(env, recipient, <span class="built_in">list</span>);</span><br><span class="line">        <span class="keyword">status_t</span> err = target-&gt;linkToDeath(jdr, <span class="literal">NULL</span>, flags);</span><br><span class="line">        <span class="keyword">if</span> (err != NO_ERROR) &#123;</span><br><span class="line">            <span class="comment">// Failure adding the death recipient, so clear its reference now.</span></span><br><span class="line">            jdr-&gt;clearReference();</span><br><span class="line">            signalExceptionForError(env, obj, err, <span class="literal">true</span> <span class="comment">/*canThrowRemoteException*/</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JavaDeathRecipient</span> :</span> <span class="keyword">public</span> IBinder::DeathRecipient</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    JavaDeathRecipient(JNIEnv* env, jobject object, <span class="keyword">const</span> sp&lt;DeathRecipientList&gt;&amp; <span class="built_in">list</span>)</span><br><span class="line">        : mVM(jnienv_to_javavm(env)), mObject(env-&gt;NewGlobalRef(object)),</span><br><span class="line">        mObjectWeak(<span class="literal">NULL</span>), mList(<span class="built_in">list</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 将当前对象添加到列表DeathRecipientList</span></span><br><span class="line">        <span class="built_in">list</span>-&gt;add(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        gNumDeathRefsCreated.fetch_add(<span class="number">1</span>, <span class="built_in">std</span>::memory_order_relaxed);</span><br><span class="line">        gcIfManyNewRefs(env);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">clearReference</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        sp&lt;DeathRecipientList&gt; <span class="built_in">list</span> = mList.promote();</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">list</span> != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="built_in">list</span>-&gt;remove(<span class="keyword">this</span>); <span class="comment">// 从列表中移除引用</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>android_os_BinderProxy_linkToDeath过程说明:</p>
<ul>
<li>获取DeathRecipientList：记录该BinderProxy的JavaDeathRecipient列表信息，一个BpBinder可以注册多个死亡回调；</li>
<li>创建JavaDeathRecipient：继承于IBinder::DeathRecipient；</li>
<li>通过<code>BpBinder-&gt;linkToDeath</code>方法添加死亡回调；</li>
<li>若<code>BpBinder-&gt;linkToDeath</code>失败则清除list引用。</li>
</ul>
<p>JavaDeathRecipient构造方法主要功能：</p>
<ul>
<li>通过<code>env-&gt;NewGlobalRef(object)</code>，为recipient创建相应的全局引用，并保存到mObject成员变量；</li>
<li>将当前对象JavaDeathRecipient的指针sp添加到DeathRecipientList。</li>
</ul>
<h4 id="BpBinder-linkToDeath"><a href="#BpBinder-linkToDeath" class="headerlink" title="BpBinder.linkToDeath"></a>BpBinder.linkToDeath</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">BpBinder::linkToDeath</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> sp&lt;DeathRecipient&gt;&amp; recipient, <span class="keyword">void</span>* cookie, <span class="keyword">uint32_t</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Obituary ob;</span><br><span class="line">    ob.recipient = recipient; <span class="comment">// JavaDeathRecipient</span></span><br><span class="line">    ob.cookie = cookie; <span class="comment">// cookie = NULL</span></span><br><span class="line">    ob.flags = flags;</span><br><span class="line">    &#123;</span><br><span class="line">        AutoMutex _l(mLock);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!mObitsSent) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!mObituaries) &#123;</span><br><span class="line">                mObituaries = <span class="keyword">new</span> Vector&lt;Obituary&gt;;</span><br><span class="line">                <span class="keyword">if</span> (!mObituaries) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NO_MEMORY;</span><br><span class="line">                &#125;</span><br><span class="line">                getWeakRefs()-&gt;incWeak(<span class="keyword">this</span>);</span><br><span class="line">                IPCThreadState* self = IPCThreadState::self();</span><br><span class="line">                <span class="comment">// 只在mObituaries创建时发送一次</span></span><br><span class="line">                self-&gt;requestDeathNotification(mHandle, <span class="keyword">this</span>);</span><br><span class="line">                self-&gt;flushCommands();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将新创建的Obituary添加到mObituaries</span></span><br><span class="line">            <span class="keyword">ssize_t</span> res = mObituaries-&gt;add(ob);</span><br><span class="line">            <span class="keyword">return</span> res &gt;= (<span class="keyword">ssize_t</span>)NO_ERROR ? (<span class="keyword">status_t</span>)NO_ERROR : res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> DEAD_OBJECT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">IPCThreadState::requestDeathNotification</span><span class="params">(<span class="keyword">int32_t</span> handle, BpBinder* proxy)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mOut.writeInt32(BC_REQUEST_DEATH_NOTIFICATION);</span><br><span class="line">    mOut.writeInt32((<span class="keyword">int32_t</span>)handle);</span><br><span class="line">    mOut.writePointer((<span class="keyword">uintptr_t</span>)proxy);</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">IPCThreadState::flushCommands</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mProcess-&gt;mDriverFD &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    talkWithDriver(<span class="literal">false</span>);</span><br><span class="line">    <span class="comment">// The flush could have caused post-write refcount decrements to have</span></span><br><span class="line">    <span class="comment">// been executed, which in turn could result in BC_RELEASE/BC_DECREFS</span></span><br><span class="line">    <span class="comment">// being queued in mOut. So flush again, if we need to.</span></span><br><span class="line">    <span class="keyword">if</span> (mOut.dataSize() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        talkWithDriver(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>向Kernel层的binder driver发送BC_REQUEST_DEATH_NOTIFICATION命令，经过ioctl执行到binder_ioctl_write_read()方法。</p>
<h3 id="Binder-Driver"><a href="#Binder-Driver" class="headerlink" title="Binder Driver"></a>Binder Driver</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_thread_write</span><span class="params">(struct binder_proc *proc,</span></span></span><br><span class="line"><span class="function"><span class="params">            struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">binder_uintptr_t</span> binder_buffer, <span class="keyword">size_t</span> size,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">binder_size_t</span> *consumed)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (ptr &lt; end &amp;&amp; thread-&gt;return_error.cmd == BR_OK) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">            <span class="keyword">case</span> BC_REQUEST_DEATH_NOTIFICATION:</span><br><span class="line">            <span class="keyword">case</span> BC_CLEAR_DEATH_NOTIFICATION: &#123;</span><br><span class="line">                <span class="keyword">uint32_t</span> target;</span><br><span class="line">                <span class="keyword">binder_uintptr_t</span> cookie;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref</span> *<span class="title">ref</span>;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref_death</span> *<span class="title">death</span> = <span class="title">NULL</span>;</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (get_user(target, (<span class="keyword">uint32_t</span> __user *)ptr)) <span class="keyword">return</span> -EFAULT; <span class="comment">// 获取target</span></span><br><span class="line">                ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">                <span class="keyword">if</span> (get_user(cookie, (<span class="keyword">binder_uintptr_t</span> __user *)ptr)) <span class="keyword">return</span> -EFAULT; <span class="comment">// 获取BpBinder</span></span><br><span class="line">                ptr += <span class="keyword">sizeof</span>(<span class="keyword">binder_uintptr_t</span>);</span><br><span class="line">                <span class="keyword">if</span> (cmd == BC_REQUEST_DEATH_NOTIFICATION) &#123;</span><br><span class="line">                    death = kzalloc(<span class="keyword">sizeof</span>(*death), GFP_KERNEL);</span><br><span class="line">                    <span class="keyword">if</span> (death == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                        <span class="comment">// ...</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                binder_proc_lock(proc);</span><br><span class="line">                <span class="comment">// 拿到目标服务的binder_ref</span></span><br><span class="line">                ref = binder_get_ref_olocked(proc, target, <span class="literal">false</span>);</span><br><span class="line">                binder_node_lock(ref-&gt;node);</span><br><span class="line">                <span class="keyword">if</span> (cmd == BC_REQUEST_DEATH_NOTIFICATION) &#123;</span><br><span class="line">                    <span class="comment">// Native BpBinder可注册多个死亡回调，但Kernel只允许注册一个</span></span><br><span class="line">                    <span class="keyword">if</span> (ref-&gt;death) &#123;</span><br><span class="line">                        <span class="comment">// ...</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    binder_stats_created(BINDER_STAT_DEATH);</span><br><span class="line">                    INIT_LIST_HEAD(&amp;death-&gt;work.entry);</span><br><span class="line">                    death-&gt;cookie = cookie;</span><br><span class="line">                    ref-&gt;death = death;</span><br><span class="line">                    <span class="comment">// 当目标binder服务所在进程已死，则直接发送死亡通知</span></span><br><span class="line">                    <span class="keyword">if</span> (ref-&gt;node-&gt;proc == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                        ref-&gt;death-&gt;work.type = BINDER_WORK_DEAD_BINDER;</span><br><span class="line">                        binder_inner_proc_lock(proc);</span><br><span class="line">                        binder_enqueue_work_ilocked(&amp;ref-&gt;death-&gt;work, &amp;proc-&gt;todo);</span><br><span class="line">                        binder_wakeup_proc_ilocked(proc);</span><br><span class="line">                        binder_inner_proc_unlock(proc);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                &#125;</span><br><span class="line">                binder_node_unlock(ref-&gt;node);</span><br><span class="line">                binder_proc_unlock(proc);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在处理BC_REQUEST_DEATH_NOTIFICATION过程时如果目标Binder服务所在进程已死，则向todo队列增加BINDER_WORK_DEAD_BINDER事务，直接发送死亡通知，这属于非常规情况。更常见的场景是Binder服务所在进程死亡后，会调用binder_release方法，然后调用binder_node_release，这个过程便会发出死亡通知的回调。</p>
<h3 id="触发死亡通知：binder-release"><a href="#触发死亡通知：binder-release" class="headerlink" title="触发死亡通知：binder_release"></a>触发死亡通知：binder_release</h3><p>当Binder服务所在进程死亡后，会释放进程相关的资源，当binder的fd被释放后，此处调用相应的方法是binder_release()。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">binder_fops</span> = &#123;</span></span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .poll = binder_poll,</span><br><span class="line">    .unlocked_ioctl = binder_ioctl,</span><br><span class="line">    .compat_ioctl = binder_ioctl,</span><br><span class="line">    .mmap = binder_mmap,</span><br><span class="line">    .open = binder_open,</span><br><span class="line">    .flush = binder_flush,</span><br><span class="line">    .release = binder_release,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_release</span><span class="params">(struct inode *nodp, struct file *filp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">proc</span> = <span class="title">filp</span>-&gt;<span class="title">private_data</span>;</span></span><br><span class="line"></span><br><span class="line">    debugfs_remove(proc-&gt;debugfs_entry);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (proc-&gt;binderfs_entry) &#123;</span><br><span class="line">        binderfs_remove_file(proc-&gt;binderfs_entry);</span><br><span class="line">        proc-&gt;binderfs_entry = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    binder_defer_work(proc, BINDER_DEFERRED_RELEASE);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">binder_defer_work</span><span class="params">(struct binder_proc *proc, <span class="keyword">enum</span> binder_deferred_state defer)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mutex_lock(&amp;binder_deferred_lock);</span><br><span class="line">    proc-&gt;deferred_work |= defer;</span><br><span class="line">    <span class="keyword">if</span> (hlist_unhashed(&amp;proc-&gt;deferred_work_node)) &#123;</span><br><span class="line">        hlist_add_head(&amp;proc-&gt;deferred_work_node, &amp;binder_deferred_list);</span><br><span class="line">        schedule_work(&amp;binder_deferred_work);</span><br><span class="line">    &#125;</span><br><span class="line">    mutex_unlock(&amp;binder_deferred_lock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">DECLARE_WORK</span><span class="params">(binder_deferred_work, binder_deferred_func)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DECLARE_WORK(n, f) struct work_struct n = __WORK_INITIALIZER(n, f)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __WORK_INITIALIZER(n, f) &#123;					\</span></span><br><span class="line">    .data = WORK_DATA_STATIC_INIT(),				\</span><br><span class="line">    .entry	= &#123; &amp;(n).entry, &amp;(n).entry &#125;,				\</span><br><span class="line">    .func = (f),							\</span><br><span class="line">    __WORK_INIT_LOCKDEP_MAP(#n, &amp;(n))				\</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> binder_deferred_func(struct work_struct *work)</span><br><span class="line">&#123;</span><br><span class="line">    struct binder_proc *proc;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span> *<span class="title">files</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> defer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        mutex_lock(&amp;binder_deferred_lock);</span><br><span class="line">        <span class="keyword">if</span> (!hlist_empty(&amp;binder_deferred_list)) &#123;</span><br><span class="line">            proc = hlist_entry(binder_deferred_list.first,</span><br><span class="line">                    struct binder_proc, deferred_work_node);</span><br><span class="line">            hlist_del_init(&amp;proc-&gt;deferred_work_node);</span><br><span class="line">            defer = proc-&gt;deferred_work;</span><br><span class="line">            proc-&gt;deferred_work = <span class="number">0</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            proc = <span class="literal">NULL</span>;</span><br><span class="line">            defer = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mutex_unlock(&amp;binder_deferred_lock);</span><br><span class="line"></span><br><span class="line">        files = <span class="literal">NULL</span>;</span><br><span class="line">        <span class="keyword">if</span> (defer &amp; BINDER_DEFERRED_PUT_FILES) &#123;</span><br><span class="line">            mutex_lock(&amp;proc-&gt;files_lock);</span><br><span class="line">            files = proc-&gt;files;</span><br><span class="line">            <span class="keyword">if</span> (files)</span><br><span class="line">                proc-&gt;files = <span class="literal">NULL</span>;</span><br><span class="line">            mutex_unlock(&amp;proc-&gt;files_lock);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (defer &amp; BINDER_DEFERRED_FLUSH)</span><br><span class="line">            binder_deferred_flush(proc);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (defer &amp; BINDER_DEFERRED_RELEASE)</span><br><span class="line">            binder_deferred_release(proc); <span class="comment">/* frees proc */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (files)</span><br><span class="line">            put_files_struct(files);</span><br><span class="line">    &#125; <span class="keyword">while</span> (proc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可见，binder_release最终调用的是binder_deferred_release； 同理，binder_flush最终调用的是binder_deferred_flush。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">binder_deferred_release</span><span class="params">(struct binder_proc *proc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_context</span> *<span class="title">context</span> = <span class="title">proc</span>-&gt;<span class="title">context</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_device</span> *<span class="title">device</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">n</span>;</span></span><br><span class="line">    <span class="keyword">int</span> threads, nodes, incoming_refs, outgoing_refs, active_transactions;</span><br><span class="line"></span><br><span class="line">    BUG_ON(proc-&gt;files);</span><br><span class="line"></span><br><span class="line">    mutex_lock(&amp;binder_procs_lock);</span><br><span class="line">    hlist_del(&amp;proc-&gt;proc_node); <span class="comment">// 删除proc_node节点</span></span><br><span class="line">    mutex_unlock(&amp;binder_procs_lock);</span><br><span class="line"></span><br><span class="line">    mutex_lock(&amp;context-&gt;context_mgr_node_lock);</span><br><span class="line">    <span class="keyword">if</span> (context-&gt;binder_context_mgr_node &amp;&amp;</span><br><span class="line">        context-&gt;binder_context_mgr_node-&gt;proc == proc) &#123;</span><br><span class="line">        context-&gt;binder_context_mgr_node = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mutex_unlock(&amp;context-&gt;context_mgr_node_lock);</span><br><span class="line">    device = container_of(proc-&gt;context, struct binder_device, context);</span><br><span class="line">    <span class="keyword">if</span> (refcount_dec_and_test(&amp;device-&gt;ref)) &#123;</span><br><span class="line">        kfree(context-&gt;name);</span><br><span class="line">        kfree(device);</span><br><span class="line">    &#125;</span><br><span class="line">    proc-&gt;context = <span class="literal">NULL</span>;</span><br><span class="line">    binder_inner_proc_lock(proc);</span><br><span class="line"></span><br><span class="line">    proc-&gt;tmp_ref++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放binder_thread</span></span><br><span class="line">    proc-&gt;is_dead = <span class="literal">true</span>;</span><br><span class="line">    threads = <span class="number">0</span>;</span><br><span class="line">    active_transactions = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ((n = rb_first(&amp;proc-&gt;threads))) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_thread</span> *<span class="title">thread</span>;</span></span><br><span class="line">        thread = rb_entry(n, struct binder_thread, rb_node);</span><br><span class="line">        binder_inner_proc_unlock(proc);</span><br><span class="line">        threads++;</span><br><span class="line">        active_transactions += binder_thread_release(proc, thread);</span><br><span class="line">        binder_inner_proc_lock(proc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放binder_node</span></span><br><span class="line">    nodes = <span class="number">0</span>;</span><br><span class="line">    incoming_refs = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ((n = rb_first(&amp;proc-&gt;nodes))) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_node</span> *<span class="title">node</span>;</span></span><br><span class="line">        node = rb_entry(n, struct binder_node, rb_node);</span><br><span class="line">        nodes++;</span><br><span class="line">        binder_inc_node_tmpref_ilocked(node);</span><br><span class="line">        rb_erase(&amp;node-&gt;rb_node, &amp;proc-&gt;nodes);</span><br><span class="line">        binder_inner_proc_unlock(proc);</span><br><span class="line">        incoming_refs = binder_node_release(node, incoming_refs);</span><br><span class="line">        binder_inner_proc_lock(proc);</span><br><span class="line">    &#125;</span><br><span class="line">    binder_inner_proc_unlock(proc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放binder_ref</span></span><br><span class="line">    outgoing_refs = <span class="number">0</span>;</span><br><span class="line">    binder_proc_lock(proc);</span><br><span class="line">    <span class="keyword">while</span> ((n = rb_first(&amp;proc-&gt;refs_by_desc))) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref</span> *<span class="title">ref</span>;</span></span><br><span class="line">        ref = rb_entry(n, struct binder_ref, rb_node_desc);</span><br><span class="line">        outgoing_refs++;</span><br><span class="line">        binder_cleanup_ref_olocked(ref);</span><br><span class="line">        binder_proc_unlock(proc);</span><br><span class="line">        binder_free_ref(ref);</span><br><span class="line">        binder_proc_lock(proc);</span><br><span class="line">    &#125;</span><br><span class="line">    binder_proc_unlock(proc);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 释放binder_work</span></span><br><span class="line">    binder_release_work(proc, &amp;proc-&gt;todo);</span><br><span class="line">    binder_release_work(proc, &amp;proc-&gt;delivered_death);</span><br><span class="line"></span><br><span class="line">    binder_proc_dec_tmpref(proc);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要看一下binder_node_release方法：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_node_release</span><span class="params">(struct binder_node *node, <span class="keyword">int</span> refs)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref</span> *<span class="title">ref</span>;</span></span><br><span class="line">    <span class="keyword">int</span> death = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">binder_proc</span> *<span class="title">proc</span> = <span class="title">node</span>-&gt;<span class="title">proc</span>;</span></span><br><span class="line"></span><br><span class="line">    binder_release_work(proc, &amp;node-&gt;async_todo);</span><br><span class="line"></span><br><span class="line">    binder_node_lock(node);</span><br><span class="line">    binder_inner_proc_lock(proc);</span><br><span class="line">    binder_dequeue_work_ilocked(&amp;node-&gt;work);</span><br><span class="line">    BUG_ON(!node-&gt;tmp_refs);</span><br><span class="line">    <span class="keyword">if</span> (hlist_empty(&amp;node-&gt;refs) &amp;&amp; node-&gt;tmp_refs == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 引用为空，则直接释放节点</span></span><br><span class="line">        binder_inner_proc_unlock(proc);</span><br><span class="line">        binder_node_unlock(node);</span><br><span class="line">        binder_free_node(node);</span><br><span class="line">        <span class="keyword">return</span> refs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    node-&gt;proc = <span class="literal">NULL</span>;</span><br><span class="line">    node-&gt;local_strong_refs = <span class="number">0</span>;</span><br><span class="line">    node-&gt;local_weak_refs = <span class="number">0</span>;</span><br><span class="line">    binder_inner_proc_unlock(proc);</span><br><span class="line"></span><br><span class="line">    spin_lock(&amp;binder_dead_nodes_lock);</span><br><span class="line">    hlist_add_head(&amp;node-&gt;dead_node, &amp;binder_dead_nodes);</span><br><span class="line">    spin_unlock(&amp;binder_dead_nodes_lock);</span><br><span class="line"></span><br><span class="line">    hlist_for_each_entry(ref, &amp;node-&gt;refs, node_entry) &#123;</span><br><span class="line">        refs++;</span><br><span class="line"></span><br><span class="line">        binder_inner_proc_lock(ref-&gt;proc);</span><br><span class="line">        <span class="keyword">if</span> (!ref-&gt;death) &#123;</span><br><span class="line">            binder_inner_proc_unlock(ref-&gt;proc);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        death++;</span><br><span class="line">        <span class="comment">// 添加BINDER_WORK_DEAD_BINDER事务到todo队列</span></span><br><span class="line">        ref-&gt;death-&gt;work.type = BINDER_WORK_DEAD_BINDER;</span><br><span class="line">        binder_enqueue_work_ilocked(&amp;ref-&gt;death-&gt;work, &amp;ref-&gt;proc-&gt;todo);</span><br><span class="line">        binder_wakeup_proc_ilocked(ref-&gt;proc);</span><br><span class="line">        binder_inner_proc_unlock(ref-&gt;proc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    binder_node_unlock(node);</span><br><span class="line">    binder_put_node(node);</span><br><span class="line">    <span class="keyword">return</span> refs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法会遍历该binder_node所有的binder_ref，当存在binder死亡通知时，则向相应的binder_ref所在进程的todo队列添加BINDER_WORK_DEAD_BINDER事务并唤醒处于等待状态的binder线程。</p>
<h3 id="处理死亡通知"><a href="#处理死亡通知" class="headerlink" title="处理死亡通知"></a>处理死亡通知</h3><h4 id="Binder-Driver：binder-thread-read"><a href="#Binder-Driver：binder-thread-read" class="headerlink" title="Binder Driver：binder_thread_read"></a>Binder Driver：binder_thread_read</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_thread_read</span><span class="params">(struct binder_proc *proc,</span></span></span><br><span class="line"><span class="function"><span class="params">                struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">binder_uintptr_t</span> binder_buffer, <span class="keyword">size_t</span> size,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">binder_size_t</span> *consumed, <span class="keyword">int</span> non_block)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (w-&gt;type) &#123;</span><br><span class="line">            <span class="keyword">case</span> BINDER_WORK_DEAD_BINDER:</span><br><span class="line">            <span class="keyword">case</span> BINDER_WORK_DEAD_BINDER_AND_CLEAR:</span><br><span class="line">            <span class="keyword">case</span> BINDER_WORK_CLEAR_DEATH_NOTIFICATION: &#123;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref_death</span> *<span class="title">death</span>;</span></span><br><span class="line">                <span class="keyword">uint32_t</span> cmd;</span><br><span class="line">                <span class="keyword">binder_uintptr_t</span> cookie;</span><br><span class="line"></span><br><span class="line">                death = container_of(w, struct binder_ref_death, work);</span><br><span class="line">                <span class="keyword">if</span> (w-&gt;type == BINDER_WORK_CLEAR_DEATH_NOTIFICATION)</span><br><span class="line">                    cmd = BR_CLEAR_DEATH_NOTIFICATION_DONE;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    cmd = BR_DEAD_BINDER;</span><br><span class="line">                cookie = death-&gt;cookie; <span class="comment">// 此处的cookie是前面传递的BpBinder</span></span><br><span class="line">                <span class="keyword">if</span> (w-&gt;type == BINDER_WORK_CLEAR_DEATH_NOTIFICATION) &#123;</span><br><span class="line">                    binder_inner_proc_unlock(proc);</span><br><span class="line">                    kfree(death);</span><br><span class="line">                    binder_stats_deleted(BINDER_STAT_DEATH);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    binder_enqueue_work_ilocked(w, &amp;proc-&gt;delivered_death);</span><br><span class="line">                    binder_inner_proc_unlock(proc);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (put_user(cmd, (<span class="keyword">uint32_t</span> __user *)ptr)) <span class="keyword">return</span> -EFAULT;</span><br><span class="line">                ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">                <span class="keyword">if</span> (put_user(cookie, (<span class="keyword">binder_uintptr_t</span> __user *)ptr)) <span class="keyword">return</span> -EFAULT;</span><br><span class="line">                ptr += <span class="keyword">sizeof</span>(<span class="keyword">binder_uintptr_t</span>);</span><br><span class="line">                binder_stat_br(proc, thread, cmd);</span><br><span class="line">                <span class="keyword">if</span> (cmd == BR_DEAD_BINDER)</span><br><span class="line">                    <span class="keyword">goto</span> done; <span class="comment">/* DEAD_BINDER notifications can cause transactions */</span></span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当Binder驱动收到BINDER_WORK_DEAD_BINDER时，将命令BR_DEAD_BINDER写到用户空间。</p>
<h4 id="IPCThreadState-executeCommand"><a href="#IPCThreadState-executeCommand" class="headerlink" title="IPCThreadState.executeCommand"></a>IPCThreadState.executeCommand</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">IPCThreadState::executeCommand</span><span class="params">(<span class="keyword">int32_t</span> cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BBinder* obj;</span><br><span class="line">    RefBase::weakref_type* refs;</span><br><span class="line">    <span class="keyword">status_t</span> result = NO_ERROR;</span><br><span class="line">    <span class="keyword">switch</span> ((<span class="keyword">uint32_t</span>)cmd) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">case</span> BR_DEAD_BINDER:</span><br><span class="line">            &#123;</span><br><span class="line">                BpBinder *proxy = (BpBinder*)mIn.readPointer();</span><br><span class="line">                proxy-&gt;sendObituary();</span><br><span class="line">                mOut.writeInt32(BC_DEAD_BINDER_DONE);</span><br><span class="line">                mOut.writePointer((<span class="keyword">uintptr_t</span>)proxy);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;*** BAD COMMAND %d received from Binder driver\n&quot;</span>, cmd);</span><br><span class="line">            result = UNKNOWN_ERROR;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BpBinder::sendObituary</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mAlive = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (mObitsSent) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    mLock.lock();</span><br><span class="line">    Vector&lt;Obituary&gt;* obits = mObituaries;</span><br><span class="line">    <span class="keyword">if</span>(obits != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        IPCThreadState* self = IPCThreadState::self();</span><br><span class="line">        <span class="comment">// 清空死亡通知</span></span><br><span class="line">        self-&gt;clearDeathNotification(mHandle, <span class="keyword">this</span>);</span><br><span class="line">        self-&gt;flushCommands();</span><br><span class="line">        mObituaries = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    mObitsSent = <span class="number">1</span>;</span><br><span class="line">    mLock.unlock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (obits != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">size_t</span> N = obits-&gt;size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">            <span class="comment">// 发送死亡通知</span></span><br><span class="line">            reportOneDeath(obits-&gt;itemAt(i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">delete</span> obits;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BpBinder::reportOneDeath</span><span class="params">(<span class="keyword">const</span> Obituary&amp; obit)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    sp&lt;DeathRecipient&gt; recipient = obit.recipient.promote();</span><br><span class="line">    <span class="keyword">if</span> (recipient == <span class="literal">NULL</span>) <span class="keyword">return</span>;</span><br><span class="line">    recipient-&gt;binderDied(<span class="keyword">this</span>); <span class="comment">// 回调死亡通知的方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="unlinkToDeath"><a href="#unlinkToDeath" class="headerlink" title="unlinkToDeath"></a>unlinkToDeath</h2><h3 id="Native：unlinkToDeath"><a href="#Native：unlinkToDeath" class="headerlink" title="Native：unlinkToDeath"></a>Native：unlinkToDeath</h3><h4 id="android-os-BinderProxy-unlinkToDeath"><a href="#android-os-BinderProxy-unlinkToDeath" class="headerlink" title="android_os_BinderProxy_unlinkToDeath"></a>android_os_BinderProxy_unlinkToDeath</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> jboolean <span class="title">android_os_BinderProxy_unlinkToDeath</span><span class="params">(JNIEnv* env, jobject obj,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                 jobject recipient, jint flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    jboolean res = JNI_FALSE;</span><br><span class="line">    <span class="keyword">if</span> (recipient == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        jniThrowNullPointerException(env, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BinderProxyNativeData* nd = getBPNativeData(env, obj);</span><br><span class="line">    IBinder* target = nd-&gt;mObject.get();</span><br><span class="line">    <span class="keyword">if</span> (target == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> JNI_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!target-&gt;localBinder()) &#123;</span><br><span class="line">        <span class="keyword">status_t</span> err = NAME_NOT_FOUND;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If we find the matching recipient, proceed to unlink using that</span></span><br><span class="line">        DeathRecipientList* <span class="built_in">list</span> = nd-&gt;mOrgue.get();</span><br><span class="line">        sp&lt;JavaDeathRecipient&gt; origJDR = <span class="built_in">list</span>-&gt;find(recipient);</span><br><span class="line">        <span class="keyword">if</span> (origJDR != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            wp&lt;IBinder::DeathRecipient&gt; dr;</span><br><span class="line">            err = target-&gt;unlinkToDeath(origJDR, <span class="literal">NULL</span>, flags, &amp;dr);</span><br><span class="line">            <span class="keyword">if</span> (err == NO_ERROR &amp;&amp; dr != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                sp&lt;IBinder::DeathRecipient&gt; sdr = dr.promote();</span><br><span class="line">                JavaDeathRecipient* jdr = <span class="keyword">static_cast</span>&lt;JavaDeathRecipient*&gt;(sdr.get());</span><br><span class="line">                <span class="keyword">if</span> (jdr != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    jdr-&gt;clearReference();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="BpBinder-unlinkToDeath"><a href="#BpBinder-unlinkToDeath" class="headerlink" title="BpBinder.unlinkToDeath"></a>BpBinder.unlinkToDeath</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">BpBinder::unlinkToDeath</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">const</span> wp&lt;DeathRecipient&gt;&amp; recipient, <span class="keyword">void</span>* cookie, <span class="keyword">uint32_t</span> flags,</span></span></span><br><span class="line"><span class="function"><span class="params">    wp&lt;DeathRecipient&gt;* outRecipient)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AutoMutex _l(mLock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mObitsSent) &#123;</span><br><span class="line">        <span class="keyword">return</span> DEAD_OBJECT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> N = mObituaries ? mObituaries-&gt;size() : <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> Obituary&amp; obit = mObituaries-&gt;itemAt(i);</span><br><span class="line">        <span class="keyword">if</span> ((obit.recipient == recipient || (recipient == <span class="literal">NULL</span> &amp;&amp; obit.cookie == cookie))</span><br><span class="line">                &amp;&amp; obit.flags == flags) &#123;</span><br><span class="line">            <span class="keyword">if</span> (outRecipient != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                *outRecipient = mObituaries-&gt;itemAt(i).recipient;</span><br><span class="line">            &#125;</span><br><span class="line">            mObituaries-&gt;removeAt(i); <span class="comment">// 移除死亡通知</span></span><br><span class="line">            <span class="keyword">if</span> (mObituaries-&gt;size() == <span class="number">0</span>) &#123;</span><br><span class="line">                IPCThreadState* self = IPCThreadState::self();</span><br><span class="line">                <span class="comment">// 清理死亡通知</span></span><br><span class="line">                self-&gt;clearDeathNotification(mHandle, <span class="keyword">this</span>);</span><br><span class="line">                self-&gt;flushCommands();</span><br><span class="line">                <span class="keyword">delete</span> mObituaries;</span><br><span class="line">                mObituaries = <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NAME_NOT_FOUND;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">IPCThreadState::clearDeathNotification</span><span class="params">(<span class="keyword">int32_t</span> handle, BpBinder* proxy)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    mOut.writeInt32(BC_CLEAR_DEATH_NOTIFICATION);</span><br><span class="line">    mOut.writeInt32((<span class="keyword">int32_t</span>)handle);</span><br><span class="line">    mOut.writePointer((<span class="keyword">uintptr_t</span>)proxy);</span><br><span class="line">    <span class="keyword">return</span> NO_ERROR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写入BC_CLEAR_DEATH_NOTIFICATION命令，再经过flushCommands()，则进入Kernel层。</p>
<h3 id="Binder-Driver-1"><a href="#Binder-Driver-1" class="headerlink" title="Binder Driver"></a>Binder Driver</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_thread_write</span><span class="params">(struct binder_proc *proc,</span></span></span><br><span class="line"><span class="function"><span class="params">            struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">binder_uintptr_t</span> binder_buffer, <span class="keyword">size_t</span> size,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">binder_size_t</span> *consumed)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (ptr &lt; end &amp;&amp; thread-&gt;return_error.cmd == BR_OK) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">            <span class="keyword">case</span> BC_REQUEST_DEATH_NOTIFICATION:</span><br><span class="line">            <span class="keyword">case</span> BC_CLEAR_DEATH_NOTIFICATION: &#123;</span><br><span class="line">                <span class="keyword">uint32_t</span> target;</span><br><span class="line">                <span class="keyword">binder_uintptr_t</span> cookie;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref</span> *<span class="title">ref</span>;</span></span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref_death</span> *<span class="title">death</span> = <span class="title">NULL</span>;</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (get_user(target, (<span class="keyword">uint32_t</span> __user *)ptr)) <span class="keyword">return</span> -EFAULT;</span><br><span class="line">                ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">                <span class="keyword">if</span> (get_user(cookie, (<span class="keyword">binder_uintptr_t</span> __user *)ptr)) <span class="keyword">return</span> -EFAULT;</span><br><span class="line">                ptr += <span class="keyword">sizeof</span>(<span class="keyword">binder_uintptr_t</span>);</span><br><span class="line">                binder_proc_lock(proc);</span><br><span class="line">                <span class="comment">// 拿到目标服务的binder_ref</span></span><br><span class="line">                ref = binder_get_ref_olocked(proc, target, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">                binder_node_lock(ref-&gt;node);</span><br><span class="line">                <span class="keyword">if</span> (cmd == BC_REQUEST_DEATH_NOTIFICATION) &#123;</span><br><span class="line">                    <span class="comment">// ...</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ref-&gt;death == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                        binder_node_unlock(ref-&gt;node);</span><br><span class="line">                        binder_proc_unlock(proc);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    death = ref-&gt;death;</span><br><span class="line">                    <span class="keyword">if</span> (death-&gt;cookie != cookie) &#123;</span><br><span class="line">                        <span class="comment">// 比较是否同一个BpBinder</span></span><br><span class="line">                        binder_node_unlock(ref-&gt;node);</span><br><span class="line">                        binder_proc_unlock(proc);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    ref-&gt;death = <span class="literal">NULL</span>;</span><br><span class="line">                    binder_inner_proc_lock(proc);</span><br><span class="line">                    <span class="keyword">if</span> (list_empty(&amp;death-&gt;work.entry)) &#123;</span><br><span class="line">                        <span class="comment">// 添加BINDER_WORK_CLEAR_DEATH_NOTIFICATION事务</span></span><br><span class="line">                        death-&gt;work.type = BINDER_WORK_CLEAR_DEATH_NOTIFICATION;</span><br><span class="line">                        <span class="keyword">if</span> (thread-&gt;looper &amp; (BINDER_LOOPER_STATE_REGISTERED | BINDER_LOOPER_STATE_ENTERED))</span><br><span class="line">                            binder_enqueue_thread_work_ilocked(thread, &amp;death-&gt;work);</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            binder_enqueue_work_ilocked(&amp;death-&gt;work, &amp;proc-&gt;todo);</span><br><span class="line">                            binder_wakeup_proc_ilocked(proc);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        BUG_ON(death-&gt;work.type != BINDER_WORK_DEAD_BINDER);</span><br><span class="line">                        death-&gt;work.type = BINDER_WORK_DEAD_BINDER_AND_CLEAR;</span><br><span class="line">                    &#125;</span><br><span class="line">                    binder_inner_proc_unlock(proc);</span><br><span class="line">                &#125;</span><br><span class="line">                binder_node_unlock(ref-&gt;node);</span><br><span class="line">                binder_proc_unlock(proc);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binder_thread_read</span><span class="params">(struct binder_proc *proc,</span></span></span><br><span class="line"><span class="function"><span class="params">                struct binder_thread *thread,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">binder_uintptr_t</span> binder_buffer, <span class="keyword">size_t</span> size,</span></span></span><br><span class="line"><span class="function"><span class="params">                <span class="keyword">binder_size_t</span> *consumed, <span class="keyword">int</span> non_block)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (w-&gt;type) &#123;</span><br><span class="line">            <span class="keyword">case</span> BINDER_WORK_DEAD_BINDER:</span><br><span class="line">            <span class="keyword">case</span> BINDER_WORK_DEAD_BINDER_AND_CLEAR:</span><br><span class="line">            <span class="keyword">case</span> BINDER_WORK_CLEAR_DEATH_NOTIFICATION: &#123;</span><br><span class="line">                <span class="class"><span class="keyword">struct</span> <span class="title">binder_ref_death</span> *<span class="title">death</span>;</span></span><br><span class="line">                <span class="keyword">uint32_t</span> cmd;</span><br><span class="line">                <span class="keyword">binder_uintptr_t</span> cookie;</span><br><span class="line"></span><br><span class="line">                death = container_of(w, struct binder_ref_death, work);</span><br><span class="line">                <span class="keyword">if</span> (w-&gt;type == BINDER_WORK_CLEAR_DEATH_NOTIFICATION)</span><br><span class="line">                    cmd = BR_CLEAR_DEATH_NOTIFICATION_DONE; <span class="comment">// 清除完成</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    cmd = BR_DEAD_BINDER;</span><br><span class="line">                cookie = death-&gt;cookie; <span class="comment">// 此处的cookie是前面传递的BpBinder</span></span><br><span class="line">                <span class="keyword">if</span> (w-&gt;type == BINDER_WORK_CLEAR_DEATH_NOTIFICATION) &#123;</span><br><span class="line">                    binder_inner_proc_unlock(proc);</span><br><span class="line">                    kfree(death);</span><br><span class="line">                    binder_stats_deleted(BINDER_STAT_DEATH);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    binder_enqueue_work_ilocked(w, &amp;proc-&gt;delivered_death);</span><br><span class="line">                    binder_inner_proc_unlock(proc);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (put_user(cmd, (<span class="keyword">uint32_t</span> __user *)ptr)) <span class="keyword">return</span> -EFAULT;</span><br><span class="line">                ptr += <span class="keyword">sizeof</span>(<span class="keyword">uint32_t</span>);</span><br><span class="line">                <span class="keyword">if</span> (put_user(cookie, (<span class="keyword">binder_uintptr_t</span> __user *)ptr)) <span class="keyword">return</span> -EFAULT;</span><br><span class="line">                ptr += <span class="keyword">sizeof</span>(<span class="keyword">binder_uintptr_t</span>);</span><br><span class="line">                binder_stat_br(proc, thread, cmd);</span><br><span class="line">                <span class="keyword">if</span> (cmd == BR_DEAD_BINDER)</span><br><span class="line">                    <span class="keyword">goto</span> done; <span class="comment">/* DEAD_BINDER notifications can cause transactions */</span></span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="IPCThreadState-executeCommand-1"><a href="#IPCThreadState-executeCommand-1" class="headerlink" title="IPCThreadState.executeCommand"></a>IPCThreadState.executeCommand</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">IPCThreadState::executeCommand</span><span class="params">(<span class="keyword">int32_t</span> cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    BBinder* obj;</span><br><span class="line">    RefBase::weakref_type* refs;</span><br><span class="line">    <span class="keyword">status_t</span> result = NO_ERROR;</span><br><span class="line">    <span class="keyword">switch</span> ((<span class="keyword">uint32_t</span>)cmd) &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="keyword">case</span> BR_CLEAR_DEATH_NOTIFICATION_DONE:</span><br><span class="line">            &#123;</span><br><span class="line">                BpBinder *proxy = (BpBinder*)mIn.readPointer();</span><br><span class="line">                proxy-&gt;getWeakRefs()-&gt;decWeak(proxy);</span><br><span class="line">            &#125; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;*** BAD COMMAND %d received from Binder driver\n&quot;</span>, cmd);</span><br><span class="line">            result = UNKNOWN_ERROR;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h2><p>对于Binder IPC进程都会打开/dev/binder文件，当进程异常退出时，Binder驱动会调用/dev/binder文件所对应的release回调函数，执行清理工作，并且检查BBinder是否有注册死亡通知，当发现存在死亡通知时，那么就向其对应的BpBinder端发送死亡通知消息。死亡回调DeathRecipient只有Bp才能正确使用，因为DeathRecipient用于监控Bn端挂掉的情况，如果Bn建立跟自己的死亡通知，自己进程都挂了，也就无法通知。</p>
<p>linkToDeath过程：</p>
<ul>
<li>requestDeathNotification过程向驱动传递的命令BC_REQUEST_DEATH_NOTIFICATION，参数有mHandle和BpBinder对象；</li>
<li>binder_thread_write()过程，同一个BpBinder可以注册多个死亡回调，但Kernel只允许注册一次死亡通知；</li>
<li>注册死亡回调的过程，实质就是向binder_ref结构体添加binder_ref_death指针，binder_ref_death的cookie记录BpBinder指针。</li>
</ul>
<p>触发死亡回调：</p>
<ul>
<li>服务实体进程：binder_release过程会执行binder_node_release()，循环该binder_node下所有的ref-&gt;death对象。当存在，则将BINDER_WORK_DEAD_BINDER事务添加ref-&gt;proc-&gt;todo（即ref所在进程的todo队列)；</li>
<li>引用所在进程：执行binder_thread_read()过程，向用户空间写入BR_DEAD_BINDER，并触发死亡回调；</li>
<li>发送死亡通知sendObituary。</li>
</ul>
<p>unlinkToDeath过程：</p>
<ul>
<li>unlinkToDeath只有当该BpBinder的所有mObituaries都被移除，才会向驱动层执行清除死亡通知的动作，否则只是从Native层移除某个recipient；</li>
<li>clearDeathNotification过程向驱动传递BC_CLEAR_DEATH_NOTIFICATION，参数有mHandle和BpBinder对象；</li>
<li>binder_thread_write()过程，将BINDER_WORK_CLEAR_DEATH_NOTIFICATION事务添加当前当前进程/线程的todo队列，并将ref-&gt;death置为NULL；</li>
<li>binder_thread_read()过程，向用户空间写入BR_CLEAR_DEATH_NOTIFICATION_DONE。</li>
</ul>
<h1 id="clearCallingIdentity-restoreCallingIdentity"><a href="#clearCallingIdentity-restoreCallingIdentity" class="headerlink" title="clearCallingIdentity/restoreCallingIdentity"></a>clearCallingIdentity/restoreCallingIdentity</h1><p>相关源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Binder.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">long</span> <span class="title">clearCallingIdentity</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">restoreCallingIdentity</span><span class="params">(<span class="keyword">long</span> token)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// android_util_Binder.cpp</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> jlong <span class="title">android_os_Binder_clearCallingIdentity</span><span class="params">(JNIEnv* env, jobject clazz)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> IPCThreadState::self()-&gt;clearCallingIdentity();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">android_os_Binder_restoreCallingIdentity</span><span class="params">(JNIEnv* env, jobject clazz, jlong token)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// XXX temporary sanity check to debug crashes.</span></span><br><span class="line">    <span class="keyword">int</span> uid = (<span class="keyword">int</span>)(token&gt;&gt;<span class="number">32</span>);</span><br><span class="line">    <span class="keyword">if</span> (uid &gt; <span class="number">0</span> &amp;&amp; uid &lt; <span class="number">999</span>) &#123;</span><br><span class="line">        <span class="comment">// In Android currently there are no uids in this range.</span></span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">128</span>];</span><br><span class="line">        sprintf(buf, <span class="string">&quot;Restoring bad calling ident: 0x%&quot;</span> PRIx64, token);</span><br><span class="line">        jniThrowException(env, <span class="string">&quot;java/lang/IllegalStateException&quot;</span>, buf);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    IPCThreadState::self()-&gt;restoreCallingIdentity(token);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IPCThreadState.cpp</span></span><br><span class="line">int64_t IPCThreadState::clearCallingIdentity()</span><br><span class="line">&#123;</span><br><span class="line">    int64_t token = ((int64_t)mCallingUid&lt;&lt;<span class="number">32</span>) | mCallingPid;</span><br><span class="line">    clearCaller();</span><br><span class="line">    <span class="keyword">return</span> token;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> IPCThreadState::clearCaller()</span><br><span class="line">&#123;</span><br><span class="line">    mCallingPid = getpid();</span><br><span class="line">    mCallingUid = getuid();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> IPCThreadState::restoreCallingIdentity(int64_t token)</span><br><span class="line">&#123;</span><br><span class="line">    mCallingUid = (<span class="keyword">int</span>)(token&gt;&gt;<span class="number">32</span>);</span><br><span class="line">    mCallingPid = (<span class="keyword">int</span>)token;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这两个方法涉及到两个属性：</p>
<ul>
<li>mCallingUid(记为UID)，保存Binder IPC通信的调用方进程的Uid</li>
<li>mCallingPid(记为PID)，保存Binder IPC通信的调用方进程的Pid</li>
</ul>
<p>由上面的源码可知：</p>
<ul>
<li>clearCallingIdentity作用是清空远程调用端的UID和PID，用当前本地进程的UID和PID替代</li>
<li>restoreCallingIdentity作用是恢复远程调用端的UID和PID信息，及clearCallingIdentity的反过程</li>
</ul>
<p>场景及作用：进程A通过Binder远程调用进程B的服务，在此过程中，进程B又通过Binder调用了当前进程的另一个服务。</p>
<ul>
<li>进程A通过Binder远程调用进程B的服务：进程B的IPCThreadState中的mCallingUid和mCallingPid保存的是进程A的UID和PID。这时进程B中调用Binder.getCallingPid()和Binder.getCallingUid()方法便可获取进程A的UID和PID，然后利用UID和PID进行权限比对，判断进程A是否有权限调用进程B的某个方法。</li>
<li>进程B通过Binder调用了当前进程的另一个服务：此时进程B是它另一个服务的调用端，则mCallingUid和mCallingPid应该保存当前进程B的PID和UID，故需要调用clearCallingIdentity()方法完成这个功能。当进程B调用完某个组件，由于进程B仍然处于进程A的服务端，因此mCallingUid和mCallingPid需要恢复成进程A的UID和PID，通过调用restoreCallingIdentity()即可。</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">status_t</span> <span class="title">IPCThreadState::executeCommand</span><span class="params">(<span class="keyword">int32_t</span> cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">case</span> BR_TRANSACTION:</span><br><span class="line">        &#123;</span><br><span class="line">            binder_transaction_data tr;</span><br><span class="line">            result = mIn.read(&amp;tr, <span class="keyword">sizeof</span>(tr));<span class="comment">//将数据读取到tr中</span></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">pid_t</span> origPid = mCallingPid;</span><br><span class="line">            <span class="keyword">const</span> <span class="keyword">uid_t</span> origUid = mCallingUid;</span><br><span class="line">            </span><br><span class="line">            mCallingPid = tr.sender_pid;</span><br><span class="line">            mCallingUid = tr.sender_euid;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (tr.target.ptr) &#123;</span><br><span class="line">                <span class="function">sp&lt;BBinder&gt; <span class="title">b</span><span class="params">((BBinder*)tr.cookie)</span></span>;</span><br><span class="line">                <span class="keyword">const</span> <span class="keyword">status_t</span> error = b-&gt;transact(tr.code, buffer, &amp;reply, tr.flags);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">            mCallingPid = origPid;</span><br><span class="line">            mCallingUid = origUid;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>在Framework层，Binder采用JNI技术来调用Native层的Binder架构，从而为上层应用程序提供服务。在Native层中Binder是C/S架构，分为Bn端(Server)和Bp端(Client)，对于Java层在命名与架构上也比较类似，借用网上的一张图：</p>
<p><img src="java_binder.jpg" alt="java_binder"></p>
<p>Framework层的ServiceManager类的实现最终是通过BinderProxy传递给Native层来完成的。</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Android/" rel="tag"># Android</a>
              <a href="/tags/Binder/" rel="tag"># Binder</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2020/06/30/Android-Binder%E5%8E%9F%E7%90%86%E4%BA%8C-ServiceManager/" rel="prev" title="Android-Binder原理二-ServiceManager">
      <i class="fa fa-chevron-left"></i> Android-Binder原理二-ServiceManager
    </a></div>
      <div class="post-nav-item">
    <a href="/2020/07/09/Android-Binder%E5%8E%9F%E7%90%86%E5%9B%9B-%E5%AE%9E%E4%BE%8B%E4%B8%8E%E6%80%BB%E7%BB%93/" rel="next" title="Android-Binder原理四-实例与总结">
      Android-Binder原理四-实例与总结 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">2.</span> <span class="nav-text">初始化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#startReg"><span class="nav-number">2.1.</span> <span class="nav-text">startReg</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%86%8CBinder%E7%B1%BB"><span class="nav-number">2.2.</span> <span class="nav-text">注册Binder类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%86%8CBinderInternal%E7%B1%BB"><span class="nav-number">2.3.</span> <span class="nav-text">注册BinderInternal类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B3%A8%E5%86%8CBinderProxy%E7%B1%BB"><span class="nav-number">2.4.</span> <span class="nav-text">注册BinderProxy类</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1"><span class="nav-number">3.</span> <span class="nav-text">注册服务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ServiceManager-addService"><span class="nav-number">3.1.</span> <span class="nav-text">ServiceManager.addService</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ServiceManagerProxy-addService"><span class="nav-number">3.2.</span> <span class="nav-text">ServiceManagerProxy.addService</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BinderProxy-transact"><span class="nav-number">3.3.</span> <span class="nav-text">BinderProxy.transact</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-number">3.4.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E6%9C%8D%E5%8A%A1"><span class="nav-number">4.</span> <span class="nav-text">获取服务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#ServiceManager-getService"><span class="nav-number">4.1.</span> <span class="nav-text">ServiceManager.getService</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ServiceManagerProxy-getService"><span class="nav-number">4.2.</span> <span class="nav-text">ServiceManagerProxy.getService</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BinderProxy-transact-1"><span class="nav-number">4.3.</span> <span class="nav-text">BinderProxy.transact</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Parcel-readStrongBinder"><span class="nav-number">4.4.</span> <span class="nav-text">Parcel.readStrongBinder</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-1"><span class="nav-number">4.5.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%AD%BB%E4%BA%A1%E9%80%9A%E7%9F%A5"><span class="nav-number">5.</span> <span class="nav-text">死亡通知</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Framework%EF%BC%9AlinkToDeath-unlinkToDeath"><span class="nav-number">5.1.</span> <span class="nav-text">Framework：linkToDeath&#x2F;unlinkToDeath</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#linkToDeath"><span class="nav-number">5.2.</span> <span class="nav-text">linkToDeath</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Native%EF%BC%9AlinkToDeath"><span class="nav-number">5.2.1.</span> <span class="nav-text">Native：linkToDeath</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#android-os-BinderProxy-linkToDeath"><span class="nav-number">5.2.1.1.</span> <span class="nav-text">android_os_BinderProxy_linkToDeath</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BpBinder-linkToDeath"><span class="nav-number">5.2.1.2.</span> <span class="nav-text">BpBinder.linkToDeath</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Binder-Driver"><span class="nav-number">5.2.2.</span> <span class="nav-text">Binder Driver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A6%E5%8F%91%E6%AD%BB%E4%BA%A1%E9%80%9A%E7%9F%A5%EF%BC%9Abinder-release"><span class="nav-number">5.2.3.</span> <span class="nav-text">触发死亡通知：binder_release</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%84%E7%90%86%E6%AD%BB%E4%BA%A1%E9%80%9A%E7%9F%A5"><span class="nav-number">5.2.4.</span> <span class="nav-text">处理死亡通知</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Binder-Driver%EF%BC%9Abinder-thread-read"><span class="nav-number">5.2.4.1.</span> <span class="nav-text">Binder Driver：binder_thread_read</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IPCThreadState-executeCommand"><span class="nav-number">5.2.4.2.</span> <span class="nav-text">IPCThreadState.executeCommand</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#unlinkToDeath"><span class="nav-number">5.3.</span> <span class="nav-text">unlinkToDeath</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Native%EF%BC%9AunlinkToDeath"><span class="nav-number">5.3.1.</span> <span class="nav-text">Native：unlinkToDeath</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#android-os-BinderProxy-unlinkToDeath"><span class="nav-number">5.3.1.1.</span> <span class="nav-text">android_os_BinderProxy_unlinkToDeath</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BpBinder-unlinkToDeath"><span class="nav-number">5.3.1.2.</span> <span class="nav-text">BpBinder.unlinkToDeath</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Binder-Driver-1"><span class="nav-number">5.3.2.</span> <span class="nav-text">Binder Driver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IPCThreadState-executeCommand-1"><span class="nav-number">5.3.3.</span> <span class="nav-text">IPCThreadState.executeCommand</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-2"><span class="nav-number">5.4.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#clearCallingIdentity-restoreCallingIdentity"><span class="nav-number">6.</span> <span class="nav-text">clearCallingIdentity&#x2F;restoreCallingIdentity</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">7.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="苍耳叔叔"
      src="/images/head.png">
  <p class="site-author-name" itemprop="name">苍耳叔叔</p>
  <div class="site-description" itemprop="description">梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">153</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">101</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ljd1996" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ljd1996" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hearing1996@gmail.com" title="E-Mail → mailto:hearing1996@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">苍耳叔叔</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : true,
      notify     : true,
      appId      : 'pCnIlzs46HJGpubm7D3TnrBC-gzGzoHsz',
      appKey     : '7LzW4wBI9lY5DtVFNkFWcjs0',
      placeholder: "欢迎评论交流！",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
