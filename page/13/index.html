<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ljd1996.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
<meta property="og:type" content="website">
<meta property="og:title" content="苍耳的博客">
<meta property="og:url" content="https://ljd1996.github.io/page/13/index.html">
<meta property="og:site_name" content="苍耳的博客">
<meta property="og:description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="苍耳叔叔">
<meta property="article:tag" content="诗歌，宋词，后台，Android，Java">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://ljd1996.github.io/page/13/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>苍耳的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">苍耳的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">细水长流</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ljd1996.github.io/2019/02/27/EOS%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/27/EOS%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">EOS学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-27 16:30:52" itemprop="dateCreated datePublished" datetime="2019-02-27T16:30:52+08:00">2019-02-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/" itemprop="url" rel="index"><span itemprop="name">区块链</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/EOS/" itemprop="url" rel="index"><span itemprop="name">EOS</span></a>
                </span>
            </span>

          
            <span id="/2019/02/27/EOS%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="EOS学习笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/02/27/EOS%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/02/27/EOS%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>EOS: Enterprise Operation System 中文意思为：商业级区块链操作系统。EOS 项目的目标是建立可以承载商业级智能合约与应用的区块链基础设施，成为区块链世界的“底层操作系统”。</p>
<p>EOS通过石墨烯技术解决延迟和数据吞吐量问题，TPS可达到数千，交易的确认时间也只有数秒。同时声称未来使用并行链的方式，最高可以达到数百万TPS。此外，在 EOS 上转账交易及运行智能合约不需要消耗 EOS代币。而是EOS 系统当中，抵押代币获取对应的资源，来执行相应交易，在EOS运行程序完全免费的说是不准确的。</p>
<p>EOS底层使用的是石墨烯技术，石墨烯是一个开源的区块链底层库，采用的是 DPOS（Delegated Proof-of-Stake 股份授权证明机制 ）的共识机制。DPOS为了提高出块速度TPS，限制了参与记账了人数，在DPOS中，记账者不称为矿工，而是改称为见证人Witness，现在EOS中，又有一个新词：Block Producer，简称BP，翻译为超级节点。</p>
<p>DPOS下节点需要参与见证人选举，只有赢得选举的节点才能负责出块，在EOS中，赢得选举的21个节点见证人轮流出块。另外还有100个备用见证人（候选节点），在21个见证人出现问题后做替补。EOS的发行总量是10亿，见证人在完成打包交易区块后，可以领取到区块的奖励，区块的奖励来自对发行量的通胀增发，通胀率每年接近5%。</p>
<h1 id="钱包和账户"><a href="#钱包和账户" class="headerlink" title="钱包和账户"></a>钱包和账户</h1><h2 id="钱包"><a href="#钱包" class="headerlink" title="钱包"></a>钱包</h2><p>EOS钱包功能官方上定义很单一，仅仅存私钥公钥，提供私钥公钥生成和导入，其他的功能由EOS账户统一管理，比如代币查询、交易、合约功能都属于账户关联下的功能。</p>
<h2 id="账户"><a href="#账户" class="headerlink" title="账户"></a>账户</h2><p>EOS账号由一串自定义字符组成，与以太坊中不同。账户名下有EOS系统的代币和用户调用eosio.token合约创建的代币、合约和公钥等</p>
<h2 id="钱包和账户关系"><a href="#钱包和账户关系" class="headerlink" title="钱包和账户关系"></a>钱包和账户关系</h2><p>EOS里面的key是公私钥对成对出现的，key和password不是同一个概念，虽然看起来都是一串很长的字符，但是password是针对钱包wallet的，而key则是针对账户account的。</p>
<p>假如创建了钱包hearing，不等于已经在链上有了hearing这个账户，实际上wallet和account两者之间完全是没有关系的，只有当你将account的key放在wallet里的时候，它们两者之间才有了联系。EOS账户创建需要关联钱包公钥，账户创建可以使用同一个钱包公钥创建多个账户，但各个账户是独立的。可以理解成使用同一个密码创建了不同的账户，账户数据相互独立。</p>
<p>每一个account都会有两组公私钥对，对应该账户的两个角色——owner和active。所以我们每次创建账户的时候，都需要给新账户导入两个key进去。官方推荐用户平时使用 Active 私钥，把Owner 私钥离线保存。只有重大安全问题时需要用到 Owner 私钥。</p>
<h2 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h2><p>-p</p>
<h1 id="创建钱包和账户"><a href="#创建钱包和账户" class="headerlink" title="创建钱包和账户"></a>创建钱包和账户</h1><ol>
<li><p>开启keosd</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> keosd &amp;</span></span><br></pre></td></tr></table></figure>

 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> pkill keosd</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>开启nodeos</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nodeos -e -p eosio \</span></span><br><span class="line">--plugin eosio::producer_plugin \</span><br><span class="line">--plugin eosio::chain_api_plugin \</span><br><span class="line">--plugin eosio::http_plugin \</span><br><span class="line">--plugin eosio::history_plugin \</span><br><span class="line">--plugin eosio::history_api_plugin \</span><br><span class="line">--access-control-allow-origin=&#x27;*&#x27; \</span><br><span class="line">--contracts-console \</span><br><span class="line">--http-validate-host=false \</span><br><span class="line">--verbose-http-errors \</span><br><span class="line">--filter-on=&#x27;*&#x27; &gt;&gt; nodeos.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
</li>
<li><p>钱包操作</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet list   <span class="comment"># 查看钱包</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet create --to-console/--file -n hearing    <span class="comment"># 创建钱包，生成私钥，-n指定钱包名，默认名为default</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet open   <span class="comment"># 打开钱包</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet unlock   <span class="comment"># 解锁钱包，需要提供钱包私钥</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet create_key <span class="comment"># 在钱包中创建私钥</span></span></span><br><span class="line">Created new private key with a public key of: &quot;EOS7qyuXyBtqMYLYBveB3APTiWeyu1d6Z4mTLX1mMP5ZU3kWUqXcJ&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet keys   <span class="comment"># 查看钱包的keys</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>导入开发者Key</p>
<p> 每个新的EOSIO链都有一个名为“eosio”的默认“系统”账户。此帐户用于通过加载系统合同来设置链，该合同规定了EOSIO链的治理和共识。每个新的EOSIO链都带有一个开发密钥，这个密钥是相同的(5KQwrPbwdL6PhXujxW37FSSQZ1JiwsST4cqQzDeyXtP79zkvFD3)。这个账户在我看来就是一个使用5KQwrPbwdL6PhXujxW37FSSQZ1JiwsST4cqQzDeyXtP79zkvFD3秘钥对创建的，所以开发者需要把它导入到某个钱包，并得到对应的公钥。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet import --private-key 5KQwrPbwdL6PhXujxW37FSSQZ1JiwsST4cqQzDeyXtP79zkvFD3   <span class="comment"># 将开发者私钥导入到default钱包，会输出对应的公钥，可通过-n指定钱包</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建秘钥</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos create key --to-console</span></span><br><span class="line">Private key: 5KRuAjE9xf6zK3AeMTZa9yLCZMQmhaBxuZePRtdUnWqB5nkd5Jk</span><br><span class="line">Public key: EOS8XaSdS9EieYyWuAfUma7cmB4TEuPWjcU8mpMRR2jztuwd1Cs2a</span><br></pre></td></tr></table></figure>

 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos create key --to-console</span></span><br><span class="line">Private key: 5J3BgEZ168EEP9shdnWBhZsPZRAfjjpUyKVxx1qjezXzJW9bEZv</span><br><span class="line">Public key: EOS81sw5LyVND1KjYoGA7iYNSo9ezgyucEjNzVAP1bPBHRdgkJo29</span><br></pre></td></tr></table></figure>
</li>
<li><p>向wallet导入秘钥</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet import -n hearing --private-key 5J3BgEZ168EEP9shdnWBhZsPZRAfjjpUyKVxx1qjezXzJW9bEZv</span></span><br><span class="line">imported private key for: EOS81sw5LyVND1KjYoGA7iYNSo9ezgyucEjNzVAP1bPBHRdgkJo29</span><br></pre></td></tr></table></figure>

 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet import -n hearing --private-key 5KRuAjE9xf6zK3AeMTZa9yLCZMQmhaBxuZePRtdUnWqB5nkd5Jk</span></span><br><span class="line">imported private key for: EOS8XaSdS9EieYyWuAfUma7cmB4TEuPWjcU8mpMRR2jztuwd1Cs2a</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建账户</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos create account [OPTIONS] creator name OwnerKey [ActiveKey]  <span class="comment"># 命令中的key为public-key</span></span></span><br></pre></td></tr></table></figure>

 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos create account eosio hearing EOS81sw5LyVND1KjYoGA7iYNSo9ezgyucEjNzVAP1bPBHRdgkJo29 EOS8XaSdS9EieYyWuAfUma7cmB4TEuPWjcU8mpMRR2jztuwd1Cs2a</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos create account hearing hearing1 EOS81sw5LyVND1KjYoGA7iYNSo9ezgyucEjNzVAP1bPBHRdgkJo29 EOS8XaSdS9EieYyWuAfUma7cmB4TEuPWjcU8mpMRR2jztuwd1Cs2a</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="智能合约"><a href="#智能合约" class="headerlink" title="智能合约"></a>智能合约</h1><p>在eos私有节点操作中，我们通常是一个合约对应一个合约账户，并且一个账户中只能部署一个智能合约。如果在同一个账户部署多个合约，那么最后部署的合约会覆盖掉之前的合约。</p>
<h2 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h2><ol>
<li><p>编写合约</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;eosiolib/eosio.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> eosio;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> [[<span class="title">eosio</span>:</span>:contract(<span class="string">&quot;hello&quot;</span>)]] hello : <span class="keyword">public</span> contract &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> contract::contract;</span><br><span class="line"></span><br><span class="line">    [[eosio::action]]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">hi</span><span class="params">( name user )</span> </span>&#123;</span><br><span class="line">        print( <span class="string">&quot;Hello, &quot;</span>, user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">EOSIO_DISPATCH( hello, (hi))</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译合约</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> eosio-cpp -I include -o hello.wasm hello.cpp --abigen</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建账户</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos create account eosio hello EOS7qyuXyBtqMYLYBveB3APTiWeyu1d6Z4mTLX1mMP5ZU3kWUqXcJ -p eosio@active    <span class="comment"># -p指定账户的权限</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>部署合约</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos <span class="built_in">set</span> contract hello CONTRACTS_DIR/hello -p hello@active</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>调用合约</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos push action hello hi <span class="string">&#x27;[&quot;bob&quot;]&#x27;</span> -p alice@active</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="eosio-token合约"><a href="#eosio-token合约" class="headerlink" title="eosio.token合约"></a>eosio.token合约</h2><p>在eos目录中自带的合约中，有一个eosio.token智能合约，这个智能合约的功能是为账户发放token，token可以用来转账操作。</p>
<ol>
<li><p>创建账户</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos create account eosio eosio.token EOS81sw5LyVND1KjYoGA7iYNSo9ezgyucEjNzVAP1bPBHRdgkJo29 EOS8XaSdS9EieYyWuAfUma7cmB4TEuPWjcU8mpMRR2jztuwd1Cs2a</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>把eosio.token合约部署到eosio.token账户上</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos <span class="built_in">set</span> contract eosio.token ./eosio.token</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建代币</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos push action eosio.token create <span class="string">&#x27;[ &quot;eosio&quot;, &quot;1000000000.0000 EOS&quot;, 0, 0, 0]&#x27;</span> -p eosio.token@active</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>为账户发放token</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos push action eosio.token issue <span class="string">&#x27;[ &quot;lilei&quot;, &quot;1000.0000 EOS&quot;, &quot;&quot; ]&#x27;</span> -p eosio@active</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>交易token</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos push action eosio.token transfer <span class="string">&#x27;[ &quot;eosio&quot;, &quot;hearing&quot;, &quot;25.0000 EOS&quot;, &quot;m&quot; ]&#x27;</span> -p eosio@active</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查询余额</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos get currency balance eosio.token hearing EOS</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="单主机多节点"><a href="#单主机多节点" class="headerlink" title="单主机多节点"></a>单主机多节点</h1><h2 id="关于配置"><a href="#关于配置" class="headerlink" title="关于配置"></a>关于配置</h2><p>比如机器10.186.11.211上的部分配置：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">bnet-endpoint = <span class="number">10.186</span><span class="number">.11</span><span class="number">.211</span>:<span class="number">4321</span>    </span><br><span class="line"></span><br><span class="line"><span class="comment">//for communicatin with cleos</span></span><br><span class="line">http-server-address = <span class="number">10.186</span><span class="number">.11</span><span class="number">.211</span>:<span class="number">8888</span>  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//for sync block</span></span><br><span class="line">p2p-listen-endpoint = <span class="number">10.186</span><span class="number">.11</span><span class="number">.211</span>:<span class="number">9876</span> </span><br><span class="line">p2p-peer-address = <span class="number">10.186</span><span class="number">.11</span><span class="number">.223</span>:<span class="number">9876</span></span><br><span class="line">p2p-peer-address = <span class="number">10.186</span><span class="number">.11</span><span class="number">.220</span>:<span class="number">9876</span></span><br><span class="line">p2p-peer-address = <span class="number">10.186</span><span class="number">.11</span><span class="number">.141</span>:<span class="number">9876</span> </span><br></pre></td></tr></table></figure>

<ul>
<li>bnet-endpoint: 所监听的传入链接的端点。　默认：0.0.0.0:4321</li>
<li>http-server-address: 本地的http服务地址 默认: 127.0.0.1:8888</li>
<li>p2p-listen-endpoint: 所监听的p2p传入链接的端点。　默认：0.0.0.0:9876</li>
<li>p2p-peer-address: 公共的p2p对等节点地址。</li>
</ul>
<h2 id="启动keosd"><a href="#启动keosd" class="headerlink" title="启动keosd"></a>启动keosd</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> keosd --http-server-address 127.0.0.1:8899</span></span><br></pre></td></tr></table></figure>

<h2 id="创建钱包"><a href="#创建钱包" class="headerlink" title="创建钱包"></a>创建钱包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos --wallet-url http://127.0.0.1:8899  wallet create --to-console</span></span><br><span class="line">Creating wallet: default</span><br><span class="line">Save password to use in the future to unlock this wallet.</span><br><span class="line">Without password imported keys will not be retrievable.</span><br><span class="line">&quot;PW5J2VNR7bJpNtuJXwaEy2LNug5BNbBRRZUR8DcMPd7CrqMVtvnVn&quot;</span><br></pre></td></tr></table></figure>

<h2 id="加载eosio秘钥"><a href="#加载eosio秘钥" class="headerlink" title="加载eosio秘钥"></a>加载eosio秘钥</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos --wallet-url http://127.0.0.1:8899 wallet import --private-key 5KQwrPbwdL6PhXujxW37FSSQZ1JiwsST4cqQzDeyXtP79zkvFD3</span></span><br><span class="line">imported private key for: EOS6MRyAjQq8ud7hVNYcfnVPJqcVpscN5So8BhtHuGYqET5GDW5CV</span><br></pre></td></tr></table></figure>

<h2 id="启动第一个生产节点"><a href="#启动第一个生产节点" class="headerlink" title="启动第一个生产节点"></a>启动第一个生产节点</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nodeos --enable-stale-production --producer-name eosio --plugin eosio::chain_api_plugin --plugin eosio::net_api_plugin --max-transaction-time=1000 --hard-replay-blockchain</span></span><br></pre></td></tr></table></figure>

<h2 id="启动第二个生产节点"><a href="#启动第二个生产节点" class="headerlink" title="启动第二个生产节点"></a>启动第二个生产节点</h2><h3 id="加载eosio-bios合约"><a href="#加载eosio-bios合约" class="headerlink" title="加载eosio.bios合约"></a>加载eosio.bios合约</h3><p>要启动其他节点，必须先加载eosio.bios合同。通过此合同，可以直接控制其他帐户的资源分配并访问其他特权API调用。（如果第一次已经加载了合约，那么这一步可以跳过）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos --wallet-url http://127.0.0.1:8899 <span class="built_in">set</span> contract eosio ./eosio.bios</span></span><br></pre></td></tr></table></figure>

<h3 id="创建账户-inita"><a href="#创建账户-inita" class="headerlink" title="创建账户(inita)"></a>创建账户(inita)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos create key --to-console</span></span><br><span class="line">Private key: 5JcjxL4XqNvR85aQ9hAqworWJuoJfDoGo7wUtZLDbVePRXWCxUf</span><br><span class="line">Public key: EOS58iXdanxG4nwok3AVSrDGu4Fj2dTB9HqeLUdbQu6wRRgyq18CS</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos --wallet-url http://127.0.0.1:8899 wallet import --private-key 5JcjxL4XqNvR85aQ9hAqworWJuoJfDoGo7wUtZLDbVePRXWCxUf</span></span><br><span class="line">imported private key for: EOS58iXdanxG4nwok3AVSrDGu4Fj2dTB9HqeLUdbQu6wRRgyq18CS</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos --wallet-url http://127.0.0.1:8899 create account eosio inita EOS58iXdanxG4nwok3AVSrDGu4Fj2dTB9HqeLUdbQu6wRRgyq18CS EOS58iXdanxG4nwok3AVSrDGu4Fj2dTB9HqeLUdbQu6wRRgyq18CS</span></span><br></pre></td></tr></table></figure>

<h3 id="命令行启动节点"><a href="#命令行启动节点" class="headerlink" title="命令行启动节点"></a>命令行启动节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nodeos --producer-name inita --plugin eosio::chain_api_plugin --plugin eosio::net_api_plugin --http-server-address 127.0.0.1:8889 --p2p-listen-endpoint 127.0.0.1:9877 --p2p-peer-address 127.0.0.1:9876 --config-dir node2 --data-dir node2 --private-key 5JcjxL4XqNvR85aQ9hAqworWJuoJfDoGo7wUtZLDbVePRXWCxUf</span></span><br></pre></td></tr></table></figure>

<p>将inita注册为具有bios节点的生产者，并且bios节点需要执行动作来更新生产者计划（测试失败）:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos --wallet-url http://127.0.0.1:8899 push action eosio setprods <span class="string">&quot;&#123; \&quot;schedule\&quot;: [&#123;\&quot;producer_name\&quot;: \&quot;inita\&quot;,\&quot;block_signing_key\&quot;: \&quot;EOS58iXdanxG4nwok3AVSrDGu4Fj2dTB9HqeLUdbQu6wRRgyq18CS\&quot;&#125;]&#125;&quot;</span> -p eosio@active</span></span><br></pre></td></tr></table></figure>

<h3 id="配置文件启动节点"><a href="#配置文件启动节点" class="headerlink" title="配置文件启动节点"></a>配置文件启动节点</h3><p>也可以通过conf文件启动多个节点，方式如下：</p>
<p>node2.ini：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> communicatin with cleos</span></span><br><span class="line">http-server-address = 127.0.0.1:8889</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> sync block</span></span><br><span class="line">p2p-listen-endpoint = 127.0.0.1:9877</span><br><span class="line">p2p-peer-address = 127.0.0.1:9876</span><br><span class="line">p2p-peer-address = 127.0.0.1:9878</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> agent-name = <span class="string">&quot;EOS Test Agent&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> eosio, this flag must be <span class="literal">true</span>, <span class="keyword">else</span> must be <span class="built_in">set</span> <span class="literal">false</span>, it decide whether or not </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> product block</span></span><br><span class="line">enable-stale-production = true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> producer name</span></span><br><span class="line">producer-name = inita</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> producer key,get by use<span class="string">&quot;cleos ceate key&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> private-key =[<span class="string">&quot;EOS8Znrtgwt8TfpmbVpTKvA2oB8Nqey625CLN8bCN3TEbgx86Dsvr&quot;</span>, <span class="string">&quot;5K463ynhZoCDDa4RDcr63cUwWLTnKqmdcoTKTHBjqoKfv4u5V7p&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> load plugin</span></span><br><span class="line">plugin = eosio::chain_api_plugin</span><br><span class="line">plugin = eosio::history_api_plugin</span><br><span class="line">plugin = eosio::chain_plugin</span><br><span class="line">plugin = eosio::history_plugin</span><br><span class="line">plugin = eosio::net_plugin</span><br><span class="line">plugin = eosio::net_api_plugin </span><br></pre></td></tr></table></figure>

<p>node3.ini：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> communicatin with cleos</span></span><br><span class="line">http-server-address = 127.0.0.1:8890</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> sync block</span></span><br><span class="line">p2p-listen-endpoint = 127.0.0.1:9878</span><br><span class="line">p2p-peer-address = 127.0.0.1:9876</span><br><span class="line">p2p-peer-address = 127.0.0.1:9877</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> agent-name = <span class="string">&quot;EOS Test Agent&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> eosio, this flag must be <span class="literal">true</span>, <span class="keyword">else</span> must be <span class="built_in">set</span> <span class="literal">false</span>, it decide whether or not </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> product block</span></span><br><span class="line">enable-stale-production = true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> producer name</span></span><br><span class="line">producer-name = initb</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> producer key,get by use<span class="string">&quot;cleos ceate key&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> private-key =[<span class="string">&quot;EOS8Znrtgwt8TfpmbVpTKvA2oB8Nqey625CLN8bCN3TEbgx86Dsvr&quot;</span>, <span class="string">&quot;5K463ynhZoCDDa4RDcr63cUwWLTnKqmdcoTKTHBjqoKfv4u5V7p&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> load plugin</span></span><br><span class="line">plugin = eosio::chain_api_plugin</span><br><span class="line">plugin = eosio::history_api_plugin</span><br><span class="line">plugin = eosio::chain_plugin</span><br><span class="line">plugin = eosio::history_plugin</span><br><span class="line">plugin = eosio::net_plugin</span><br><span class="line">plugin = eosio::net_api_plugin </span><br></pre></td></tr></table></figure>

<p>启动node2：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nodeos --config node2.ini --config-dir node2 --data-dir node2 --private-key 5JcjxL4XqNvR85aQ9hAqworWJuoJfDoGo7wUtZLDbVePRXWCxUf</span><br></pre></td></tr></table></figure>

<p>启动node3：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nodeos --config node3.ini --config-dir node3 --data-dir node3 --private-key 5JcjxL4XqNvR85aQ9hAqworWJuoJfDoGo7wUtZLDbVePRXWCxUf</span><br></pre></td></tr></table></figure>

<h1 id="搭建测试网络的自动化脚本"><a href="#搭建测试网络的自动化脚本" class="headerlink" title="搭建测试网络的自动化脚本"></a>搭建测试网络的自动化脚本</h1><p>为方便搭建测试环境，我将一些相关的操作都封装到了一个shell脚本中，在此附上脚本的github地址：<a target="_blank" rel="noopener" href="https://github.com/ljd1996/eos_script/tree/master/mult_node">https://github.com/ljd1996/eos_script/tree/master/mult_node</a>.</p>
<p>该脚本的目录结构如下：</p>
<pre><code>├── conf
│   ├── node10.ini
│   ├── node11.ini
│   ├── node12.ini
│   ├── node1.ini
│   ├── node2.ini
│   ├── node3.ini
│   ├── node4.ini
│   ├── node5.ini
│   ├── node6.ini
│   ├── node7.ini
│   ├── node8.ini
│   └── node9.ini
├── data
├── key
├── log
└── wpk
├── start.sh</code></pre>
<p>下面我将分别介绍每个文件和目录的作用：</p>
<ul>
<li>data目录主要存储节点启动后的区块等相关的数据，均由EOS自动生成，不需要自己做相关处理；</li>
<li>key目录用来存储节点构建过程中生成的账户的秘钥对；</li>
<li>log用来存项keos和nodeos运行过程中的日志输出；</li>
<li>wpk目录用来存储账户数据；</li>
<li>start.sh是脚本的源码。</li>
</ul>
<p>其中，在运行脚本时我们唯一需要修改的是conf下面的配置文件，下面是其中一个配置文件的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> communicatin with cleos</span></span><br><span class="line">http-server-address = 192.168.11.103:8888</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> sync block</span></span><br><span class="line">p2p-listen-endpoint = 192.168.11.103:9876</span><br><span class="line">p2p-peer-address = 192.168.11.103:9877</span><br><span class="line">p2p-peer-address = 192.168.11.103:9878</span><br><span class="line">p2p-peer-address = 192.168.11.103:9879</span><br><span class="line">p2p-peer-address = 192.168.11.135:9880</span><br><span class="line">p2p-peer-address = 192.168.11.135:9881</span><br><span class="line">p2p-peer-address = 192.168.11.135:9882</span><br><span class="line">p2p-peer-address = 192.168.11.135:9883</span><br><span class="line">p2p-peer-address = 192.168.11.135:9884</span><br><span class="line">p2p-peer-address = 192.168.11.135:9885</span><br><span class="line">p2p-peer-address = 192.168.11.135:9886</span><br><span class="line">p2p-peer-address = 192.168.11.135:9887</span><br><span class="line">p2p-peer-address = 192.168.11.135:9888</span><br><span class="line">p2p-peer-address = 192.168.11.135:9889</span><br><span class="line">p2p-peer-address = 192.168.11.103:9890</span><br><span class="line">p2p-peer-address = 192.168.11.103:9891</span><br><span class="line">p2p-peer-address = 192.168.11.103:9892</span><br><span class="line">p2p-peer-address = 192.168.11.103:9893</span><br><span class="line">p2p-peer-address = 192.168.11.103:9894</span><br><span class="line">p2p-peer-address = 192.168.11.103:9895</span><br><span class="line">p2p-peer-address = 192.168.11.103:9896</span><br><span class="line">p2p-peer-address = 192.168.11.103:9897</span><br><span class="line">p2p-peer-address = 192.168.11.135:9877</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> eosio, this flag must be <span class="literal">true</span>, <span class="keyword">else</span> must be <span class="built_in">set</span> <span class="literal">false</span>, it decide whether or not product block</span></span><br><span class="line">enable-stale-production = true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> load plugin</span></span><br><span class="line">plugin = eosio::chain_api_plugin</span><br><span class="line">plugin = eosio::history_api_plugin</span><br><span class="line">plugin = eosio::chain_plugin</span><br><span class="line">plugin = eosio::history_plugin</span><br><span class="line">plugin = eosio::net_plugin</span><br><span class="line">plugin = eosio::net_api_plugin</span><br><span class="line">plugin = eosio::txn_test_gen_plugin</span><br></pre></td></tr></table></figure>

<ul>
<li>http-server-address： 开启的节点之中，这个值不能冲突，ip为本机的ip（ip:port）</li>
<li>p2p-listen-endpoint： 在节点的端到端连接中表示自己这个节点的位置，也需保持唯一，ip为本机的ip（ip:port）</li>
<li>p2p-peer-address： 端到端连接中其他节点的位置</li>
<li>enable-stale-production： 出块节点需要设置为true</li>
<li>plugin： 插件</li>
</ul>
<p>在每次启动节点前，确定一下自己需要启动的节点数以及各自节点的网络地址，然后把conf下的配置文件按照上述原则进行修改，每个node.imi对应一个节点的配置文件，且命名规则和原来一样递增，否则可能会造成节点的开启失败。</p>
<p>脚本使用方法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 清除相关数据</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./start.sh clean</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 运行脚本启动节点</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./start.sh run wallet_dir contracts_dir node_num</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> wallet_dir：本地钱包所在目录</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> contracts_dir：EOS中系统智能合约所在目录</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> node_num：在本机要开启的节点数，视conf中的配置文件数而定</span></span><br></pre></td></tr></table></figure>

<h1 id="多主机多节点测试网搭建"><a href="#多主机多节点测试网搭建" class="headerlink" title="多主机多节点测试网搭建"></a>多主机多节点测试网搭建</h1><p>本节主要介绍如何通过自动化脚本在两台物理机上分别开启多个节点，并测试TPS的过程。</p>
<h2 id="主机A的配置"><a href="#主机A的配置" class="headerlink" title="主机A的配置"></a>主机A的配置</h2><p>在主机A：192.168.11.103中开启12个节点，其中节点1–eosio节点作为出块节点。下面给出几个配置文件的内容：</p>
<p>node1.imi：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> communicatin with cleos</span></span><br><span class="line">http-server-address = 192.168.11.103:8888</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> sync block</span></span><br><span class="line">p2p-listen-endpoint = 192.168.11.103:9876</span><br><span class="line">p2p-peer-address = 192.168.11.103:9877</span><br><span class="line">p2p-peer-address = 192.168.11.103:9878</span><br><span class="line">p2p-peer-address = 192.168.11.103:9879</span><br><span class="line">p2p-peer-address = 192.168.11.135:9880</span><br><span class="line">p2p-peer-address = 192.168.11.135:9881</span><br><span class="line">p2p-peer-address = 192.168.11.135:9882</span><br><span class="line">p2p-peer-address = 192.168.11.135:9883</span><br><span class="line">p2p-peer-address = 192.168.11.135:9884</span><br><span class="line">p2p-peer-address = 192.168.11.135:9885</span><br><span class="line">p2p-peer-address = 192.168.11.135:9886</span><br><span class="line">p2p-peer-address = 192.168.11.135:9887</span><br><span class="line">p2p-peer-address = 192.168.11.135:9888</span><br><span class="line">p2p-peer-address = 192.168.11.135:9889</span><br><span class="line">p2p-peer-address = 192.168.11.103:9890</span><br><span class="line">p2p-peer-address = 192.168.11.103:9891</span><br><span class="line">p2p-peer-address = 192.168.11.103:9892</span><br><span class="line">p2p-peer-address = 192.168.11.103:9893</span><br><span class="line">p2p-peer-address = 192.168.11.103:9894</span><br><span class="line">p2p-peer-address = 192.168.11.103:9895</span><br><span class="line">p2p-peer-address = 192.168.11.103:9896</span><br><span class="line">p2p-peer-address = 192.168.11.103:9897</span><br><span class="line">p2p-peer-address = 192.168.11.135:9877</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> eosio, this flag must be <span class="literal">true</span>, <span class="keyword">else</span> must be <span class="built_in">set</span> <span class="literal">false</span>, it decide whether or not product block</span></span><br><span class="line">enable-stale-production = true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> load plugin</span></span><br><span class="line">plugin = eosio::chain_api_plugin</span><br><span class="line">plugin = eosio::history_api_plugin</span><br><span class="line">plugin = eosio::chain_plugin</span><br><span class="line">plugin = eosio::history_plugin</span><br><span class="line">plugin = eosio::net_plugin</span><br><span class="line">plugin = eosio::net_api_plugin</span><br><span class="line">plugin = eosio::txn_test_gen_plugin</span><br></pre></td></tr></table></figure>

<p>node12.imi：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> communicatin with cleos</span></span><br><span class="line">http-server-address = 192.168.11.103:8909</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> sync block</span></span><br><span class="line">p2p-listen-endpoint = 192.168.11.103:9897</span><br><span class="line">p2p-peer-address = 192.168.11.103:9876</span><br><span class="line">p2p-peer-address = 192.168.11.103:9877</span><br><span class="line">p2p-peer-address = 192.168.11.103:9878</span><br><span class="line">p2p-peer-address = 192.168.11.103:9879</span><br><span class="line">p2p-peer-address = 192.168.11.135:9881</span><br><span class="line">p2p-peer-address = 192.168.11.135:9882</span><br><span class="line">p2p-peer-address = 192.168.11.135:9883</span><br><span class="line">p2p-peer-address = 192.168.11.135:9884</span><br><span class="line">p2p-peer-address = 192.168.11.135:9885</span><br><span class="line">p2p-peer-address = 192.168.11.135:9886</span><br><span class="line">p2p-peer-address = 192.168.11.135:9887</span><br><span class="line">p2p-peer-address = 192.168.11.135:9888</span><br><span class="line">p2p-peer-address = 192.168.11.135:9889</span><br><span class="line">p2p-peer-address = 192.168.11.103:9890</span><br><span class="line">p2p-peer-address = 192.168.11.103:9891</span><br><span class="line">p2p-peer-address = 192.168.11.103:9892</span><br><span class="line">p2p-peer-address = 192.168.11.103:9893</span><br><span class="line">p2p-peer-address = 192.168.11.103:9894</span><br><span class="line">p2p-peer-address = 192.168.11.103:9895</span><br><span class="line">p2p-peer-address = 192.168.11.103:9896</span><br><span class="line">p2p-peer-address = 192.168.11.135:9880</span><br><span class="line">p2p-peer-address = 192.168.11.135:9877</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> eosio, this flag must be <span class="literal">true</span>, <span class="keyword">else</span> must be <span class="built_in">set</span> <span class="literal">false</span>, it decide whether or not product block</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> enable-stale-production = <span class="literal">true</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> load plugin</span></span><br><span class="line">plugin = eosio::chain_api_plugin</span><br><span class="line">plugin = eosio::history_api_plugin</span><br><span class="line">plugin = eosio::chain_plugin</span><br><span class="line">plugin = eosio::history_plugin</span><br><span class="line">plugin = eosio::net_plugin</span><br><span class="line">plugin = eosio::net_api_plugin </span><br><span class="line">plugin = eosio::txn_test_gen_plugin</span><br></pre></td></tr></table></figure>

<p>开启节点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./start.sh run /home/hearing/eosio-wallet ~/Downloads/eosio.contracts 12</span></span><br></pre></td></tr></table></figure>

<h2 id="主机B的配置"><a href="#主机B的配置" class="headerlink" title="主机B的配置"></a>主机B的配置</h2><p>在主机A：192.168.11.135中开启10个节点，所有节点都不出块。下面给出一个配置文件的内容：</p>
<p>node1.imi：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> communicatin with cleos</span></span><br><span class="line">http-server-address = 192.168.11.135:8892</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> sync block</span></span><br><span class="line">p2p-listen-endpoint = 192.168.11.135:9880</span><br><span class="line">p2p-peer-address = 192.168.11.103:9876</span><br><span class="line">p2p-peer-address = 192.168.11.103:9877</span><br><span class="line">p2p-peer-address = 192.168.11.103:9878</span><br><span class="line">p2p-peer-address = 192.168.11.103:9879</span><br><span class="line">p2p-peer-address = 192.168.11.135:9881</span><br><span class="line">p2p-peer-address = 192.168.11.135:9882</span><br><span class="line">p2p-peer-address = 192.168.11.135:9883</span><br><span class="line">p2p-peer-address = 192.168.11.135:9884</span><br><span class="line">p2p-peer-address = 192.168.11.135:9885</span><br><span class="line">p2p-peer-address = 192.168.11.135:9886</span><br><span class="line">p2p-peer-address = 192.168.11.135:9887</span><br><span class="line">p2p-peer-address = 192.168.11.135:9888</span><br><span class="line">p2p-peer-address = 192.168.11.135:9889</span><br><span class="line">p2p-peer-address = 192.168.11.103:9890</span><br><span class="line">p2p-peer-address = 192.168.11.103:9891</span><br><span class="line">p2p-peer-address = 192.168.11.103:9892</span><br><span class="line">p2p-peer-address = 192.168.11.103:9893</span><br><span class="line">p2p-peer-address = 192.168.11.103:9894</span><br><span class="line">p2p-peer-address = 192.168.11.103:9895</span><br><span class="line">p2p-peer-address = 192.168.11.103:9896</span><br><span class="line">p2p-peer-address = 192.168.11.103:9897</span><br><span class="line">p2p-peer-address = 192.168.11.135:9877</span><br></pre></td></tr></table></figure>

<p>开启节点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./start.sh run /home/hearing/eosio-wallet ~/Downloads/eosio.contracts 10</span></span><br></pre></td></tr></table></figure>

<h2 id="测试tps"><a href="#测试tps" class="headerlink" title="测试tps"></a>测试tps</h2><p>使用EOS官方推荐的txn_test_gen_plugin插件作为tps的测试工具，其原理如下：</p>
<ol>
<li><p>在一个指定的节点上新建测试账户</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl --data-binary <span class="string">&#x27;[&quot;eosio&quot;, &quot;5KQwrPbwdL6PhXujxW37FSSQZ1JiwsST4cqQzDeyXtP79zkvFD3&quot;]&#x27;</span> http://192.168.11.103:8888/v1/txn_test_gen/create_test_accounts</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在测试账户间进行自动交易(每10秒产生20个交易)</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl --data-binary <span class="string">&#x27;[&quot;&quot;, 10, 20]&#x27;</span> http://192.168.11.103:8888/v1/txn_test_gen/start_generation</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>上述产生交易的步骤也可在其他节点上运行</p>
</li>
<li><p>查看节点的输出日志，计算tps</p>
<ul>
<li><p>出块节点的日志：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">info  2019-03-13T07:56:24.050 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 00000519d3484607... #1305 @ 2019-03-13T07:56:24.000 signed by eosio [trxs: 371, lib: 1304, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:24.539 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000051aaa2f783e... #1306 @ 2019-03-13T07:56:24.500 signed by eosio [trxs: 358, lib: 1305, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:25.017 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000051beb1d3276... #1307 @ 2019-03-13T07:56:25.000 signed by eosio [trxs: 257, lib: 1306, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:25.549 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000051c6c7937c6... #1308 @ 2019-03-13T07:56:25.500 signed by eosio [trxs: 155, lib: 1307, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:26.028 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000051d9113d888... #1309 @ 2019-03-13T07:56:26.000 signed by eosio [trxs: 154, lib: 1308, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:26.559 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000051ed4d34911... #1310 @ 2019-03-13T07:56:26.500 signed by eosio [trxs: 276, lib: 1309, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:27.023 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000051f69ccd987... #1311 @ 2019-03-13T07:56:27.000 signed by eosio [trxs: 163, lib: 1310, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:27.544 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 000005208f4e00f9... #1312 @ 2019-03-13T07:56:27.500 signed by eosio [trxs: 249, lib: 1311, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:28.033 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 000005210110210b... #1313 @ 2019-03-13T07:56:28.000 signed by eosio [trxs: 214, lib: 1312, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:28.526 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 00000522ea3e4544... #1314 @ 2019-03-13T07:56:28.500 signed by eosio [trxs: 314, lib: 1313, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:29.017 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 000005234705e92a... #1315 @ 2019-03-13T07:56:29.000 signed by eosio [trxs: 259, lib: 1314, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:29.527 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 00000524841be821... #1316 @ 2019-03-13T07:56:29.500 signed by eosio [trxs: 502, lib: 1315, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:30.014 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 000005257f6d4e2e... #1317 @ 2019-03-13T07:56:30.000 signed by eosio [trxs: 897, lib: 1316, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:30.521 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 00000526b3aa10f1... #1318 @ 2019-03-13T07:56:30.500 signed by eosio [trxs: 526, lib: 1317, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:31.023 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000052756e32d73... #1319 @ 2019-03-13T07:56:31.000 signed by eosio [trxs: 652, lib: 1318, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:31.514 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 000005288100c034... #1320 @ 2019-03-13T07:56:31.500 signed by eosio [trxs: 616, lib: 1319, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:32.048 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000052914f4a78b... #1321 @ 2019-03-13T07:56:32.000 signed by eosio [trxs: 662, lib: 1320, confirmed: 0]</span><br></pre></td></tr></table></figure>
</li>
<li><p>其他节点的日志：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">info  2019-03-13T07:55:53.164 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 9f6a6c4c171e385a... #1243 @ 2019-03-13T07:55:53.000 signed by eosio [trxs: 128, lib: 1242, conf: 0, latency: 164 ms]</span><br><span class="line">info  2019-03-13T07:55:53.600 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block faff04083aafe1e8... #1244 @ 2019-03-13T07:55:53.500 signed by eosio [trxs: 79, lib: 1243, conf: 0, latency: 100 ms]</span><br><span class="line">info  2019-03-13T07:55:54.139 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block bf606f4ee1ee1498... #1245 @ 2019-03-13T07:55:54.000 signed by eosio [trxs: 113, lib: 1244, conf: 0, latency: 139 ms]</span><br><span class="line">info  2019-03-13T07:55:54.806 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block e7ba16b5cda9ae0e... #1246 @ 2019-03-13T07:55:54.500 signed by eosio [trxs: 224, lib: 1245, conf: 0, latency: 306 ms]</span><br><span class="line">info  2019-03-13T07:55:55.151 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 149c694678a74f0e... #1247 @ 2019-03-13T07:55:55.000 signed by eosio [trxs: 144, lib: 1246, conf: 0, latency: 151 ms]</span><br><span class="line">info  2019-03-13T07:55:55.634 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 06efdba68e432e11... #1248 @ 2019-03-13T07:55:55.500 signed by eosio [trxs: 112, lib: 1247, conf: 0, latency: 134 ms]</span><br><span class="line">info  2019-03-13T07:55:56.100 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 1722e7db91fbc95b... #1249 @ 2019-03-13T07:55:56.000 signed by eosio [trxs: 112, lib: 1248, conf: 0, latency: 100 ms]</span><br><span class="line">info  2019-03-13T07:55:56.615 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block a1ea6b148a9669a8... #1250 @ 2019-03-13T07:55:56.500 signed by eosio [trxs: 112, lib: 1249, conf: 0, latency: 115 ms]</span><br><span class="line">info  2019-03-13T07:55:57.131 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block ea93f8c7878d058b... #1251 @ 2019-03-13T07:55:57.000 signed by eosio [trxs: 112, lib: 1250, conf: 0, latency: 131 ms]</span><br><span class="line">info  2019-03-13T07:55:57.744 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block a0f4be3b1b68b79c... #1252 @ 2019-03-13T07:55:57.500 signed by eosio [trxs: 169, lib: 1251, conf: 0, latency: 244 ms]</span><br><span class="line">info  2019-03-13T07:55:58.173 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 7334cd134b162612... #1253 @ 2019-03-13T07:55:58.000 signed by eosio [trxs: 126, lib: 1252, conf: 0, latency: 173 ms]</span><br><span class="line">info  2019-03-13T07:55:58.730 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 0c563bf6bad3095a... #1254 @ 2019-03-13T07:55:58.500 signed by eosio [trxs: 169, lib: 1253, conf: 0, latency: 230 ms]</span><br><span class="line">info  2019-03-13T07:55:59.086 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 6d0901b8f1b15739... #1255 @ 2019-03-13T07:55:59.000 signed by eosio [trxs: 64, lib: 1254, conf: 0, latency: 86 ms]</span><br><span class="line">info  2019-03-13T07:55:59.778 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 01a641dfcb07dbe5... #1256 @ 2019-03-13T07:55:59.500 signed by eosio [trxs: 251, lib: 1255, conf: 0, latency: 278 ms]</span><br><span class="line">info  2019-03-13T07:56:00.131 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 308907ac4cf4bc98... #1257 @ 2019-03-13T07:56:00.000 signed by eosio [trxs: 85, lib: 1256, conf: 0, latency: 131 ms]</span><br><span class="line">info  2019-03-13T07:56:00.688 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 3834f77aa9b994c9... #1258 @ 2019-03-13T07:56:00.500 signed by eosio [trxs: 128, lib: 1257, conf: 0, latency: 188 ms]</span><br><span class="line">info  2019-03-13T07:56:01.359 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 4ad642cb075d8d2a... #1259 @ 2019-03-13T07:56:01.000 signed by eosio [trxs: 206, lib: 1258, conf: 0, latency: 359 ms]</span><br><span class="line">info  2019-03-13T07:56:01.630 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 9ed257c131cffcee... #1260 @ 2019-03-13T07:56:01.500 signed by eosio [trxs: 114, lib: 1259, conf: 0, latency: 130 ms]</span><br><span class="line">info  2019-03-13T07:56:02.114 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block be8627adc345d6a4... #1261 @ 2019-03-13T07:56:02.000 signed by eosio [trxs: 96, lib: 1260, conf: 0, latency: 114 ms]</span><br><span class="line">info  2019-03-13T07:56:02.732 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 6d609f6c67134258... #1262 @ 2019-03-13T07:56:02.500 signed by eosio [trxs: 211, lib: 1261, conf: 0, latency: 232 ms]</span><br><span class="line">info  2019-03-13T07:56:03.152 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block d884495e2f09d7ff... #1263 @ 2019-03-13T07:56:03.000 signed by eosio [trxs: 116, lib: 1262, conf: 0, latency: 152 ms]</span><br><span class="line">info  2019-03-13T07:56:03.741 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 2735616823a12a4b... #1264 @ 2019-03-13T07:56:03.500 signed by eosio [trxs: 133, lib: 1263, conf: 0, latency: 241 ms]</span><br><span class="line">info  2019-03-13T07:56:04.321 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 55d4565cc4094b30... #1265 @ 2019-03-13T07:56:04.000 signed by eosio [trxs: 192, lib: 1264, conf: 0, latency: 321 ms]</span><br><span class="line">info  2019-03-13T07:56:04.744 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 1e4ba2d9bee5b06f... #1266 @ 2019-03-13T07:56:04.500 signed by eosio [trxs: 228, lib: 1265, conf: 0, latency: 244 ms]</span><br></pre></td></tr></table></figure>

<p>tps的计算方式为日志中的<code>trxs</code>数值乘以2，因为EOS的出块时间是每500毫秒出一个区块。</p>
</li>
</ul>
</li>
</ol>
<h1 id="启动测试网"><a href="#启动测试网" class="headerlink" title="启动测试网"></a>启动测试网</h1><p>用户可以主观地给候选节点投票，当所有代币的15%进行投票后，会由投票数靠前的节点（默认21个）出块，出块的节点票数必须大于0，且超级节点数默认<strong>不大于</strong>21个。</p>
<p>可以通过上述给出的链接中的脚本进行自动化启动，具体使用如下（我这里一共开启了包括创世节点在内共6个节点，主网启动后，由其中的三个节点轮流出块）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 初始化</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./start.sh clean                                                                        </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启节点并注册候选人</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./start.sh run_vote /home/hearing/eosio-wallet ~/Downloads/eosio.contracts/ 6</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 投票</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 数字4表示user2投票给prod2，user3投票给prod3，user4投票给user4</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./start.sh vote 4</span></span><br></pre></td></tr></table></figure>

<p>此时会由prod2，3，4作为BP轮流出块（<strong>候选账户名需要跟节点名相同</strong>）。</p>
<p>注意：由于txn_test_gen_plugin的限制，当启动测试网后，貌似不能直接通过它去测试TPS（create_test_accounts会报错），故我这里加上了手动创建测试账户的过程（秘钥不能更改）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos system newaccount --transfer eosio txn.test.a EOS5hBSuDvcU2hHZJLAWCzBCCS7pV6SeQ4FuMhLPQPYqu9hcFakhy --stake-net <span class="string">&quot;100000000.0000 EOS&quot;</span> --stake-cpu <span class="string">&quot;100000000.0000 EOS&quot;</span> --buy-ram <span class="string">&quot;20000.0000 EOS&quot;</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos system newaccount --transfer eosio txn.test.b EOS5gUGqvjsoAmqEJvSBAygi7XF75CaCDfpysZRRVPRBdAzcirTWG --stake-net <span class="string">&quot;100000000.0000 EOS&quot;</span> --stake-cpu <span class="string">&quot;100000000.0000 EOS&quot;</span> --buy-ram <span class="string">&quot;20000.0000 EOS&quot;</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos system newaccount --transfer eosio txn.test.t EOS5gUGqvjsoAmqEJvSBAygi7XF75CaCDfpysZRRVPRBdAzcirTWG --stake-net <span class="string">&quot;100000000.0000 EOS&quot;</span> --stake-cpu <span class="string">&quot;100000000.0000 EOS&quot;</span> --buy-ram <span class="string">&quot;20000.0000 EOS&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>限制端口带宽的相关命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo iptables -t mangle -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo tc qdisc del dev lo root</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo tc qdisc add dev lo root handle 1: htb default 1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo tc class add dev lo parent 1: classid 1:1 htb rate 100mbps</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo tc class add dev lo parent 1:1 classid 1:5 htb rate 256Kbit ceil 512Kbit prio 1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo tc filter add dev lo parent 1:0 prio 1 protocol ip handle 5 fw flowid 1:5</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo iptables -A OUTPUT -t mangle -p tcp --sport 9877:9879 -j MARK --set-mark 5</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo iptables -A INPUT -t mangle -p tcp --sport 9877:9879 -j MARK --set-mark 5</span></span><br></pre></td></tr></table></figure>

<p>然后通过txn_test_gen_plugin提供的start_generation接口进行模拟交易，并测试TPS。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl --data-binary <span class="string">&#x27;[&quot;&quot;, 20, 20]&#x27;</span> http://127.0.0.1:8888/v1/txn_test_gen/start_generation</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ljd1996.github.io/2019/02/26/SDN%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/26/SDN%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">SDN笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-26 10:06:09" itemprop="dateCreated datePublished" datetime="2019-02-26T10:06:09+08:00">2019-02-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a>
                </span>
            </span>

          
            <span id="/2019/02/26/SDN%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="SDN笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/02/26/SDN%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/02/26/SDN%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>现有网络中，对流量的控制和转发都依赖于网络设备实现，且设备中集成了与业务特性紧耦合的操作系统和专用硬件，这些操作系统和专用硬件都是各个厂家自己开发和设计的。</p>
<p>SDN是一种新型的网络架构，它的设计理念是将网络的控制平面与数据转发平面进行分离，从而通过集中的控制器中的软件平台去实现可编程化控制底层硬件，实现对网络资源灵活的按需调配。在SDN网络中，网络设备只负责单纯的数据转发，可以采用通用的硬件;而原来负责控制的操作系统将提炼为独立的网络操作系统，负责对不同业务特性进行适配，而且网络操作系统和业务特性以及硬件设备之间的通信都可以通过编程实现。</p>
<p>与传统网络相比，SDN的基本特征有3点：</p>
<ol>
<li>控制与转发分离。转发平面由受控转发的设备组成，转发方式以及业务逻辑由运行在分离出去的控制面上的控制应用所控制。</li>
<li>控制平面与转发平面之间的开放接口。SDN 为控制平面提供开放可编程接口。通过这种方式，控制应用只需要关注自身逻辑，而不需要关注底层更多的实现细节。</li>
<li>逻辑上的集中控制。逻辑上集中的控制平面可以控制多个转发面设备，也就是控制整个物理网络，因而可以获得全局的网络状态视图，并根据该全局网络状态视图实现对网络的优化控制。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ljd1996.github.io/2019/02/24/adb%E7%94%A8%E6%B3%95%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/24/adb%E7%94%A8%E6%B3%95%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">adb用法笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-24 00:30:03" itemprop="dateCreated datePublished" datetime="2019-02-24T00:30:03+08:00">2019-02-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">系统</span></a>
                </span>
            </span>

          
            <span id="/2019/02/24/adb%E7%94%A8%E6%B3%95%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="adb用法笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/02/24/adb%E7%94%A8%E6%B3%95%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/02/24/adb%E7%94%A8%E6%B3%95%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>ADB，即 Android Debug Bridge.</p>
<h1 id="命令语法"><a href="#命令语法" class="headerlink" title="命令语法"></a>命令语法</h1><p>adb 命令的基本语法如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb [-d|-e|-s &lt;serialNumber&gt;] &lt;command&gt;</span><br></pre></td></tr></table></figure>

<p>如果只有一个设备/模拟器连接时，可以省略掉 [-d|-e|-s &lt;serialNumber&gt;] 这一部分，直接使用 adb &lt;command&gt;。</p>
<h1 id="指定目标设备"><a href="#指定目标设备" class="headerlink" title="指定目标设备"></a>指定目标设备</h1><table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">-d</td>
<td align="center">指定当前唯一通过 USB 连接的 Android 设备为命令目标</td>
</tr>
<tr>
<td align="center">-e</td>
<td align="center">指定当前唯一运行的模拟器为命令目标</td>
</tr>
<tr>
<td align="center">-s &lt;serialNumber&gt;</td>
<td align="center">指定相应 serialNumber 号的设备/模拟器为命令目标</td>
</tr>
</tbody></table>
<p>在多个设备/模拟器连接的情况下较常用的是 -s &lt;serialNumber&gt; 参数，serialNumber 可以通过 adb devices 命令获取。</p>
<h1 id="启动-停止"><a href="#启动-停止" class="headerlink" title="启动/停止"></a>启动/停止</h1><p>启动 adb server 命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb start-server</span><br></pre></td></tr></table></figure>

<p>一般无需手动执行此命令，在运行 adb 命令时若发现 adb server 没有启动会自动调起。</p>
<p>停止 adb server 命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb kill-server</span><br></pre></td></tr></table></figure>

<h1 id="无线连接"><a href="#无线连接" class="headerlink" title="无线连接"></a>无线连接</h1><ol>
<li>将 Android 设备与将运行 adb 的电脑连接到同一个局域网。</li>
<li>将设备与电脑通过 USB 线连接。</li>
<li>让设备在 5555 端口监听 TCP/IP 连接:<code>adb tcpip 5555</code>。</li>
<li>断开 USB 连接。</li>
<li>找到设备的 IP 地址。</li>
<li>通过 IP 地址连接设备:<code>adb connect &lt;device-ip-address&gt;</code>。</li>
<li>确认连接状态:<code>adb devices</code>。</li>
<li>断开无线连接:<code>adb disconnect &lt;device-ip-address&gt;</code>。</li>
</ol>
<h1 id="应用管理"><a href="#应用管理" class="headerlink" title="应用管理"></a>应用管理</h1><h2 id="查看应用列表"><a href="#查看应用列表" class="headerlink" title="查看应用列表"></a>查看应用列表</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell pm list packages [-f] [-d] [-e] [-s] [-3] [-i] [-u] [--user USER_ID] [FILTER]</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">显示列表</th>
</tr>
</thead>
<tbody><tr>
<td align="center">无</td>
<td align="center">所有应用</td>
</tr>
<tr>
<td align="center">-f</td>
<td align="center">显示应用关联的 apk 文件</td>
</tr>
<tr>
<td align="center">-d</td>
<td align="center">只显示 disabled 的应用</td>
</tr>
<tr>
<td align="center">-e</td>
<td align="center">只显示 enabled 的应用</td>
</tr>
<tr>
<td align="center">-s</td>
<td align="center">只显示系统应用</td>
</tr>
<tr>
<td align="center">-3</td>
<td align="center">只显示第三方应用</td>
</tr>
<tr>
<td align="center">-i</td>
<td align="center">显示应用的 installer</td>
</tr>
<tr>
<td align="center">-u</td>
<td align="center">包含已卸载应用</td>
</tr>
<tr>
<td align="center">&lt;FILTER&gt;</td>
<td align="center">包名包含 &lt;FILTER&gt; 字符串</td>
</tr>
</tbody></table>
<h2 id="安装-APK"><a href="#安装-APK" class="headerlink" title="安装 APK"></a>安装 APK</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb install &lt;apk file&gt;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">-r</td>
<td align="center">允许覆盖安装。</td>
</tr>
<tr>
<td align="center">-s</td>
<td align="center">将应用安装到 sdcard。</td>
</tr>
<tr>
<td align="center">-d</td>
<td align="center">允许降级覆盖安装。</td>
</tr>
</tbody></table>
<h2 id="卸载应用"><a href="#卸载应用" class="headerlink" title="卸载应用"></a>卸载应用</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb uninstall [-k] &lt;packagename&gt;</span><br></pre></td></tr></table></figure>

<p>-k 参数可选，表示卸载应用但保留数据和缓存目录。</p>
<h2 id="清除应用数据与缓存"><a href="#清除应用数据与缓存" class="headerlink" title="清除应用数据与缓存"></a>清除应用数据与缓存</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell pm clear &lt;packagename&gt;</span><br></pre></td></tr></table></figure>

<p>这条命令的效果相当于在设置里的应用信息界面点击了「清除缓存」和「清除数据」。</p>
<h1 id="与应用交互"><a href="#与应用交互" class="headerlink" title="与应用交互"></a>与应用交互</h1><p>主要是使用 <code>am &lt;command&gt;</code> 命令，常用的 command 如下：</p>
<table>
<thead>
<tr>
<th align="center">command</th>
<th align="center">用途</th>
</tr>
</thead>
<tbody><tr>
<td align="center">start [options] &lt;INTENT&gt;</td>
<td align="center">启动 &lt;INTENT&gt; 指定的 Activity</td>
</tr>
<tr>
<td align="center">startservice [options] &lt;INTENT&gt;</td>
<td align="center">启动 &lt;INTENT&gt; 指定的 Service</td>
</tr>
<tr>
<td align="center">broadcast [options] &lt;INTENT&gt;</td>
<td align="center">发送 &lt;INTENT&gt; 指定的广播</td>
</tr>
<tr>
<td align="center">force-stop &lt;packagename&gt;</td>
<td align="center">停止 &lt;packagename&gt; 相关的进程</td>
</tr>
</tbody></table>
<p>&lt;INTENT&gt; 参数很灵活，和写 Android 程序时代码里的 Intent 相对应。用于决定 intent 对象的选项如下：</p>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">-a &lt;ACTION&gt;</td>
<td align="center">指定 action，比如 android.intent.action.VIEW</td>
</tr>
<tr>
<td align="center">-c &lt;CATEGORY&gt;</td>
<td align="center">指定 category，比如 android.intent.category.APP_CONTACTS</td>
</tr>
<tr>
<td align="center">-n &lt;COMPONENT&gt;</td>
<td align="center">指定完整 component 名，用于明确指定启动哪个 Activity，如 com.example.app/.ExampleActivity</td>
</tr>
</tbody></table>
<p>&lt;INTENT&gt; 里还能带数据，就像写代码时的 Bundle 一样：</p>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">–esn &lt;EXTRA_KEY&gt;</td>
<td align="center">null 值（只有 key 名）</td>
</tr>
<tr>
<td align="center">–es &lt;EXTRA_KEY&gt; &lt;EXTRA_STRING_VALUE&gt;</td>
<td align="center">String 值</td>
</tr>
<tr>
<td align="center">–ez &lt;EXTRA_KEY&gt; &lt;EXTRA_BOOLEAN_VALUE&gt;</td>
<td align="center">boolean 值</td>
</tr>
<tr>
<td align="center">–ei &lt;EXTRA_KEY&gt; &lt;EXTRA_INT_VALUE&gt;</td>
<td align="center">integer 值</td>
</tr>
<tr>
<td align="center">–el &lt;EXTRA_KEY&gt; &lt;EXTRA_LONG_VALUE&gt;</td>
<td align="center">long 值</td>
</tr>
<tr>
<td align="center">–ef &lt;EXTRA_KEY&gt; &lt;EXTRA_FLOAT_VALUE&gt;</td>
<td align="center">float 值</td>
</tr>
<tr>
<td align="center">–eu &lt;EXTRA_KEY&gt; &lt;EXTRA_URI_VALUE&gt;</td>
<td align="center">URI</td>
</tr>
<tr>
<td align="center">–ecn &lt;EXTRA_KEY&gt; &lt;EXTRA_COMPONENT_NAME_VALUE&gt;</td>
<td align="center">component name</td>
</tr>
<tr>
<td align="center">–eia &lt;EXTRA_KEY&gt; &lt;EXTRA_INT_VALUE&gt;[,&lt;EXTRA_INT_VALUE…]</td>
<td align="center">integer 数组</td>
</tr>
<tr>
<td align="center">–ela &lt;EXTRA_KEY&gt; &lt;EXTRA_LONG_VALUE&gt;[,&lt;EXTRA_LONG_VALUE…]</td>
<td align="center">long 数组</td>
</tr>
</tbody></table>
<h2 id="调起-Activity"><a href="#调起-Activity" class="headerlink" title="调起 Activity"></a>调起 Activity</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start [options] &lt;INTENT&gt;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -n com.tencent.mm/.ui.LauncherUI</span><br></pre></td></tr></table></figure>

<p>表示调起微信主界面。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -n org.mazhuang.boottimemeasure/.MainActivity --es &quot;toast&quot; &quot;hello, world&quot;</span><br></pre></td></tr></table></figure>

<p>表示调起 org.mazhuang.boottimemeasure/.MainActivity 并传给它 string 数据键值对 toast - hello, world。</p>
<h2 id="调起-Service"><a href="#调起-Service" class="headerlink" title="调起 Service"></a>调起 Service</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am startservice [options] &lt;INTENT&gt;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am startservice -n com.tencent.mm/.plugin.accountsync.model.AccountAuthenticatorService</span><br></pre></td></tr></table></figure>

<p>表示调起微信的某 Service。</p>
<h2 id="发送广播"><a href="#发送广播" class="headerlink" title="发送广播"></a>发送广播</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am broadcast [options] &lt;INTENT&gt;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am broadcast -a android.intent.action.BOOT_COMPLETED -n org.mazhuang.boottimemeasure/.BootCompletedReceiver</span><br></pre></td></tr></table></figure>

<p>表示向 org.mazhuang.boottimemeasure/.BootCompletedReceiver 发送一个 BOOT_COMPLETED 广播，这类用法在测试的时候很实用，比如某个广播的场景很难制造，可以考虑通过这种方式来发送广播。</p>
<h2 id="强制停止应用"><a href="#强制停止应用" class="headerlink" title="强制停止应用"></a>强制停止应用</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am force-stop &lt;packagename&gt;</span><br></pre></td></tr></table></figure>

<p>命令示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am force-stop com.qihoo360.mobilesafe</span><br></pre></td></tr></table></figure>

<h1 id="设备-进程信息"><a href="#设备-进程信息" class="headerlink" title="设备/进程信息"></a>设备/进程信息</h1><h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><p>原生Linux的查看方式见<a href="https://ljd1996.github.io/2019/08/27/Linux%E7%AC%94%E8%AE%B0/">Linux笔记</a></p>
<h2 id="procrank"><a href="#procrank" class="headerlink" title="procrank"></a>procrank</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">rocrank</span><br><span class="line">  PID      Vss      Rss      Pss      Uss  cmdline</span><br><span class="line"> 1078   59840K   59708K   42125K   39344K  com.csr.BTApp</span><br><span class="line"> 2683   59124K   59040K   37960K   33032K  com.android.launcher</span><br><span class="line"> 1042   51572K   51488K   35686K   33604K  android.process.acore</span><br><span class="line">  782   32808K   32748K   16775K   14716K  system_server</span><br><span class="line">  667   20560K   17560K   12739K    8940K  /system/bin/surfaceflinger</span><br><span class="line">  851   30124K   30036K   12085K    7996K  com.android.systemui</span><br><span class="line"> 2999   27680K   27596K    9929K    7040K  com.baidu.input</span><br><span class="line">  959   20764K   20676K    5522K    3788K  com.android.phone</span><br><span class="line"> 3468   21892K   21800K    4591K    1920K  com.apical.dreamthemetime</span><br><span class="line">  982   19880K   19792K    4438K    2644K  com.csr.csrservices</span><br><span class="line">  668   19592K   19480K    3525K    1360K  zygote</span><br><span class="line">  670    2960K    2960K    2407K    2356K  /system/bin/mediaserver</span><br><span class="line">  663    1784K    1784K    1209K    1116K  /system/bin/synergy_service</span><br><span class="line">  756    3404K    1348K    1133K    1124K  /usr/bin/gpsexe</span><br><span class="line">  669    1468K    1468K     959K     928K  /system/bin/drmserver</span><br><span class="line">  675     692K     692K     692K     692K  /bin/sh</span><br><span class="line"> 3482     656K     652K     456K     444K  procrank</span><br><span class="line">    1     164K     164K     144K     144K  /init</span><br><span class="line">                          ------   ------  ------</span><br><span class="line">                         195031K  163724K  TOTAL</span><br><span class="line"></span><br><span class="line">RAM: 480380K total, 3624K free, 732K buffers, 299788K cached, 264844K shmem, 7632K slab</span><br></pre></td></tr></table></figure>

<h2 id="dumpsys"><a href="#dumpsys" class="headerlink" title="dumpsys"></a>dumpsys</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dumpsys [options]</span><br><span class="line">        meminfo 显示内存信息</span><br><span class="line">        cpuinfo 显示CPU信息</span><br><span class="line">        account 显示accounts信息</span><br><span class="line">        activity 显示所有的activities的信息</span><br><span class="line">        window 显示键盘，窗口和它们的关系</span><br><span class="line">        wifi 显示wifi信息</span><br></pre></td></tr></table></figure>

<p>可以在其后通过包名或者进程pid展示指定进程的信息。</p>
<h2 id="型号"><a href="#型号" class="headerlink" title="型号"></a>型号</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell getprop ro.product.model</span><br></pre></td></tr></table></figure>

<h2 id="电池状况"><a href="#电池状况" class="headerlink" title="电池状况"></a>电池状况</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys battery</span><br></pre></td></tr></table></figure>

<h2 id="屏幕分辨率"><a href="#屏幕分辨率" class="headerlink" title="屏幕分辨率"></a>屏幕分辨率</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell wm size</span><br></pre></td></tr></table></figure>

<h2 id="屏幕密度"><a href="#屏幕密度" class="headerlink" title="屏幕密度"></a>屏幕密度</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell wm density</span><br></pre></td></tr></table></figure>

<h2 id="android-id"><a href="#android-id" class="headerlink" title="android_id"></a>android_id</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell settings get secure android_id</span><br></pre></td></tr></table></figure>

<h2 id="IMEI"><a href="#IMEI" class="headerlink" title="IMEI"></a>IMEI</h2><p>在 Android 4.4 及以下版本可通过如下命令获取 IMEI：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys iphonesubinfo</span><br></pre></td></tr></table></figure>

<p>而在 Android 5.0 及以上版本里这个命令输出为空，得通过其它方式获取了（需要 root 权限）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service call iphonesubinfo 1</span><br></pre></td></tr></table></figure>

<h2 id="Android-系统版本"><a href="#Android-系统版本" class="headerlink" title="Android 系统版本"></a>Android 系统版本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell getprop ro.build.version.release</span><br></pre></td></tr></table></figure>

<h2 id="Mac-地址"><a href="#Mac-地址" class="headerlink" title="Mac 地址"></a>Mac 地址</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell cat /sys/class/net/wlan0/address</span><br></pre></td></tr></table></figure>

<h2 id="CPU-信息"><a href="#CPU-信息" class="headerlink" title="CPU 信息"></a>CPU 信息</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell cat /proc/cpuinfo</span><br></pre></td></tr></table></figure>

<h2 id="更多硬件与系统属性"><a href="#更多硬件与系统属性" class="headerlink" title="更多硬件与系统属性"></a>更多硬件与系统属性</h2><p>设备的更多硬件与系统属性可以通过如下命令查看：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell cat /system/build.prop</span><br></pre></td></tr></table></figure>

<p>这会输出很多信息，包括前面几个小节提到的「型号」和「Android 系统版本」等。输出里还包括一些其它有用的信息，它们也可通过 adb shell getprop &lt;属性名&gt; 命令单独查看，列举一部分属性如下：</p>
<img src="硬件与设备信息.png"/>

<h1 id="模拟按键-输入"><a href="#模拟按键-输入" class="headerlink" title="模拟按键/输入"></a>模拟按键/输入</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Usage: input [&lt;source&gt;] &lt;command&gt; [&lt;arg&gt;...]</span><br><span class="line"></span><br><span class="line">The sources are:</span><br><span class="line">      mouse</span><br><span class="line">      keyboard</span><br><span class="line">      joystick</span><br><span class="line">      touchnavigation</span><br><span class="line">      touchpad</span><br><span class="line">      trackball</span><br><span class="line">      stylus</span><br><span class="line">      dpad</span><br><span class="line">      gesture</span><br><span class="line">      touchscreen</span><br><span class="line">      gamepad</span><br><span class="line"></span><br><span class="line">The commands and default sources are:</span><br><span class="line">      text &lt;string&gt; (Default: touchscreen)</span><br><span class="line">      keyevent [--longpress] &lt;key code number or name&gt; ... (Default: keyboard)</span><br><span class="line">      tap &lt;x&gt; &lt;y&gt; (Default: touchscreen)</span><br><span class="line">      swipe &lt;x1&gt; &lt;y1&gt; &lt;x2&gt; &lt;y2&gt; [duration(ms)] (Default: touchscreen)</span><br><span class="line">      press (Default: trackball)</span><br><span class="line">      roll &lt;dx&gt; &lt;dy&gt; (Default: trackball)</span><br></pre></td></tr></table></figure>

<p>比如使用 adb shell input keyevent &lt;keycode&gt; 命令，部分keycode如下：</p>
<img src="keycode.png"/>

<p>比如可以使用 <code>adb shell input text hello</code> 命令来输入文本。</p>
<h1 id="屏幕截图"><a href="#屏幕截图" class="headerlink" title="屏幕截图"></a>屏幕截图</h1><p>-p 指定保存为png.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell screencap -p /sdcard/sc.png</span><br></pre></td></tr></table></figure>

<h1 id="录制屏幕"><a href="#录制屏幕" class="headerlink" title="录制屏幕"></a>录制屏幕</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell screenrecord /sdcard/filename.mp4</span><br></pre></td></tr></table></figure>

<h1 id="由包名获取apk路径"><a href="#由包名获取apk路径" class="headerlink" title="由包名获取apk路径"></a>由包名获取apk路径</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell pm path pkg</span><br></pre></td></tr></table></figure>

<h1 id="获取当前APP包名"><a href="#获取当前APP包名" class="headerlink" title="获取当前APP包名"></a>获取当前APP包名</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys window | findstr mCurrentFocus</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ljd1996.github.io/2019/02/23/Network-Coding/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/23/Network-Coding/" class="post-title-link" itemprop="url">Network-Coding</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-23 21:00:53" itemprop="dateCreated datePublished" datetime="2019-02-23T21:00:53+08:00">2019-02-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a>
                </span>
            </span>

          
            <span id="/2019/02/23/Network-Coding/" class="post-meta-item leancloud_visitors" data-flag-title="Network-Coding" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/02/23/Network-Coding/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/02/23/Network-Coding/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="TCP-IP的问题"><a href="#TCP-IP的问题" class="headerlink" title="TCP/IP的问题"></a>TCP/IP的问题</h1><p>互联网上的数据传递都是封装在“包裹”里的,将信息传递到终点的程序，以及这些“包裹”的格式，通常用 TCP/IP 协议来描述。为了让 TCP 数据传输成功，接收数据的人需要按照当时发出时的顺序，准确的来接收这些“数字包裹”。如果其中有一个数据包，因为某种原因给丢失了，那么这种互联网协议就会将其看作是网络拥堵的一个信号，数据传输速度立刻下降一半，之后它速度回升起来的也非常缓慢。该处理机制在某些状况下也许很理想，但是在另外一些状况下就会很糟糕。其根本的原因就在于：这套互联网协议本身并没有足够的智能，来分别接下来做什么事才是最正确的选择。同时，尽管从理论上来说，数字包可以从 A 点到 B 点以无限条路径进行传说，但事实上，在一个 TCP 连接中，数据传输一般都走的是相同的路径，这就给了数字黑客以机会，方便他们侵入到你的通信交流中。</p>
<h1 id="网络编码"><a href="#网络编码" class="headerlink" title="网络编码"></a>网络编码</h1><p>网络编码是一种通过中继节点对接收到的信息进行编码来达到提高多播网络容量的技术。在传统的数据传输技术中，中继节点只负责数据的存储转发，而基于网络编码技术的网络的中继节点在具备传统中继功能的基础上，会根据网络编码规则将接收到的信息进行线性或非线性处理再进行传播，这种做法最直观的优势是减少了传输次数。</p>
<p>“网络编码”能够让网络中的每一个节点都变得比现在更加智能。在 TCP/IP 协议中，网络节点只是一些简单的转换节点，只负责存储“数字包裹”，并且按照之前预设的路径转发到下一节点，而相比之下，在“网络编码”中，每一个节点都可以对“数字包裹”进行再加工，比如重新编制路径，或者重新编码。将智能赋予到网络的每个节点，是该技术称得上“破坏性创新”的理由。因为这将赋予信息处理技术以史无前例的灵活性。例如，它可以利用多路径 TCP，另外，应用了再编码机制，可以进一步的提升安全性和数据传输速度，甚至能够在网络的每个节点内部存储数据信息。</p>
<p>在”网络编码”中，“数字包裹”中的内容被看作是一个真实的数字，“数字包裹”以“批”为单位进行处理。每一个节点都构建了一套线性方程，利用的是从“数字包裹”中提取出来的数字，以及随机生成的一组系数。每一个线性方程都能生成一个已编码的包裹，其系数存储在编码包裹的头部，未知的变量是每一个包裹的实际信息，当作一个数字。换句话说，每一个已编码的包裹中，都一次性的在几个“标准”的包裹上含有部分的信息，但同时还乘以不同的系数。如果你还没有忘记高中数学的话，你知道需要 N 个线性方程来解决 N 个未知变量。因为每一个以编码的数字包裹都包含一个单独的方程，这意味着接收信息者如果想要解码这段信息，就需要 N 个这样的数字包裹(当然乘以不同的系数才可以)。</p>
<p>这样做使得接收内容彻底与数字包裹接收的顺序撇开了关系,接收信息者得到了 N 个已编码的包裹，每个都配有不同的系数，所以它能够解开所有的方程，还原最原始的数据。这种打破固有顺序所带来的灵活性，意味着整个信息系统将更加高效。也意味着曾经在 TCP/IP 中发生的严重的数据传递延迟甚至数据包丢失的情况一去不复返。因为顺序不再重要，数字包裹可以在网络中以各种不同的路径进行传递，这样会提升安全性。也就没有人能够切入到私人的通信网络中。</p>
<h1 id="线性网络编码"><a href="#线性网络编码" class="headerlink" title="线性网络编码"></a>线性网络编码</h1><h2 id="线性网络编码-1"><a href="#线性网络编码-1" class="headerlink" title="线性网络编码"></a>线性网络编码</h2><p>假设网络是有向的，执行线性网络编码时每个节点收到所有连入线路的数据后，再执行编码，然后把数据从连出线路发出。新的数据包括执行线性编码所用的系数以及合成后的数据。</p>
<img src="线性网络编码.png"/>

<h2 id="随机线性网络编码"><a href="#随机线性网络编码" class="headerlink" title="随机线性网络编码"></a>随机线性网络编码</h2><p>随机线性网络编码可以取得更好的组播传输速率，较为实用。在实际网络中，节点会将来自连入线路的封包缓存起来，当节点需要发送封包时再将缓存的封包执行网络编码，然后发出。</p>
<img src="随机线性网络编码.png"/>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ljd1996.github.io/2019/02/07/Java%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/07/Java%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">Java面向对象设计模式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-07 15:11:24" itemprop="dateCreated datePublished" datetime="2019-02-07T15:11:24+08:00">2019-02-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">语言</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          
            <span id="/2019/02/07/Java%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="post-meta-item leancloud_visitors" data-flag-title="Java面向对象设计模式" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/02/07/Java%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/02/07/Java%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h1><h2 id="饿汉模式"><a href="#饿汉模式" class="headerlink" title="饿汉模式"></a>饿汉模式</h2><p><strong>线程安全的饿汉模式：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleTon</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1、构造方法私有化</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingleTon</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、创建类的唯一实例</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SingleTon instance = <span class="keyword">new</span> SingleTon();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//提供一个获取唯一实例的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleTon <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>饿汉模式在类加载(包括初始化)后便会实例化 SingleTon 对象，但是在类加载(不初始化)，SingleTon 不会被实例化，这时相当于懒汉模式。</strong>关于类加载的过程，可参考: <a href="https://ljd1996.github.io/2018/06/11/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD">JVM类加载流程</a>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Method m = ClassLoader.class.getDeclaredMethod(&quot;findLoadedClass&quot;, <span class="keyword">new</span> Class[]&#123;String.class&#125;);</span><br><span class="line">        m.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        ClassLoader cl = ClassLoader.getSystemClassLoader();</span><br><span class="line">        Object test1 = m.invoke(cl, <span class="string">&quot;SingleTon&quot;</span>);</span><br><span class="line">        System.out.println(test1 != <span class="keyword">null</span>);</span><br><span class="line">        System.out.println(SingleTon.class.getName());</span><br><span class="line">        Object test2 = m.invoke(cl, <span class="string">&quot;SingleTon&quot;</span>);</span><br><span class="line">        System.out.println(test2 != <span class="keyword">null</span>);</span><br><span class="line">        SingleTon.getInstance();</span><br><span class="line">        Object test3 = m.invoke(cl, <span class="string">&quot;SingleTon&quot;</span>);</span><br><span class="line">        System.out.println(test3 != <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingleTon</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingleTon</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;constructor&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SingleTon instance = <span class="keyword">new</span> SingleTon();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleTon <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="keyword">false</span></span><br><span class="line">SingleTon</span><br><span class="line"><span class="keyword">true</span></span><br><span class="line">constructor</span><br><span class="line"><span class="keyword">true</span></span><br></pre></td></tr></table></figure>

<p>可以看到 SingleTon 类已经被加载了，但是并没有执行初始化过程，也就没有实例化 SingleTon 对象。直到调用 getInstance 方法时(也可以是调用SingleTon中的静态变量)才会实例化。</p>
<h2 id="懒汉模式"><a href="#懒汉模式" class="headerlink" title="懒汉模式"></a>懒汉模式</h2><p><strong>线程不安全的懒汉模式：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleTon</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1、构造方法私有化</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingleTon</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、创建类的唯一实例</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SingleTon instance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//提供一个获取唯一实例的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleTon <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> SingleTon();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>线程安全的懒汉模式，双重检查锁定：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleTon</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1、构造方法私有化</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingleTon</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、创建类的唯一实例</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> SingleTon instance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//提供一个获取唯一实例的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleTon <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (SingleTon.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> SingleTon();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里之所以要加 volatile 标识，是因为 synchronized 无法禁止指令重排序，而 instance 的赋值过程可以拆分为三个步骤：</p>
<ol>
<li>申请一个内存区域（空白内存）；</li>
<li>调用构造方法等进行初始化（写内存）；</li>
<li>将对象引用赋值给变量；</li>
</ol>
<p>而 2 和 3 可能发生重排序，当线程 T1 拿到锁开始创建实例，如果发生了重排序，此时 instance 已经被赋值，但是对象没有初始化，如果此时 instance 被同步到了主内存，当线程 T2 调用 getInstance 方法时，发现 instance 不为空，则直接返回使用，进而出错。</p>
<p><strong>线程安全的懒汉模式，静态内部类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleTon</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingleTon</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> SingleTon instance = <span class="keyword">new</span> SingleTon();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleTon <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> LazyHolder.instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="枚举单例"><a href="#枚举单例" class="headerlink" title="枚举单例"></a>枚举单例</h2><p>enum有且仅有private的构造器，防止外部的额外构造，这恰好和单例模式吻合，也为保证单例性做了一个铺垫。枚举会被编译成如下形式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">T</span> <span class="keyword">extends</span> <span class="title">Enum</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，Enum是Java提供给编译器的一个用于继承的类。枚举量的实现其实是public static final T 类型的未初始化变量，之后，会在静态代码中对枚举量进行初始化。所以，如果用枚举去实现一个单例，这样的加载时间其实有点类似于饿汉模式，并没有起到lazy-loading的作用。</p>
<p>对于序列化和反序列化，因为每一个枚举类型和枚举变量在JVM中都是唯一的，即Java在序列化和反序列化枚举时做了特殊的规定，枚举的writeObject、readObject、readObjectNoData、writeReplace和readResolve等方法是被编译器禁用的，因此也不存在实现序列化接口后调用readObject会破坏单例的问题。</p>
<p>对于线程安全方面，类似于普通的饿汉模式，通过在第一次调用时的静态初始化创建的对象是线程安全的。</p>
<p>因此，选择枚举作为Singleton的实现方式，相对于其他方式尤其是类似的饿汉模式主要有以下优点：</p>
<ol>
<li>代码简单</li>
<li>自由序列化</li>
</ol>
<p>单例的枚举实现在《Effective Java》中有提到，因为其功能完整、使用简洁、无偿地提供了序列化机制、在面对复杂的序列化或者反射攻击时仍然可以绝对防止多次实例化等优点，单元素的枚举类型被作者认为是实现Singleton的最佳方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleTon</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingleTon</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleTon <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SingletonEnum.INSTANCE.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">enum</span> <span class="title">SingletonEnum</span></span>&#123;</span><br><span class="line">        INSTANCE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> SingleTon singleton;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//JVM会保证此方法绝对只调用一次</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">SingletonEnum</span><span class="params">()</span></span>&#123;</span><br><span class="line">            singleton = <span class="keyword">new</span> SingleTon();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> SingleTon <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> singleton;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更简单:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">EasySingleton</span> </span>&#123;</span><br><span class="line">    INSTANCE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="单例模板"><a href="#单例模板" class="headerlink" title="单例模板"></a>单例模板</h2><p>不像C++,C++可以通过直接new T()实现泛型单例,但Java不可以.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleTonBase</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentMap&lt;Class, Object&gt; map = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getInstance</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">        Object ob = map.get(type);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ob == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (map) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (map.get(type) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        ob = type.newInstance();</span><br><span class="line">                        map.put(type, ob);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException | IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (T) ob;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">        map.remove(type);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="反射攻击"><a href="#反射攻击" class="headerlink" title="反射攻击"></a>反射攻击</h2><p>反射可以获取到单例的私有构造函数，从而破坏单例。如果要抵御这种攻击，就要修改构造器，让他在被要求创建第二个实例的时候抛出异常。可以通过一个boolean类型的静态变量来标识。但是依然可以通过反射的方式来修改标识的值，从而破坏单例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;the program is ready to start...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SingTo singTo = SingTo.getInstance();</span><br><span class="line"></span><br><span class="line">        Class&lt;SingTo&gt; cls = SingTo.class;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Field flag = cls.getDeclaredField(<span class="string">&quot;flag&quot;</span>);</span><br><span class="line">            flag.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            flag.set(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">            Constructor&lt;SingTo&gt; constructor = cls.getDeclaredConstructor(<span class="keyword">null</span>);</span><br><span class="line">            constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            SingTo singTo1 = constructor.newInstance();</span><br><span class="line"></span><br><span class="line">            System.out.println(singTo == singTo1);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException | InstantiationException</span><br><span class="line">                | NoSuchMethodException | InvocationTargetException</span><br><span class="line">                | NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>枚举单例可以避免反射攻击，如下调用newInstance会报错：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EnumSingleton enumSingleton = EnumSingleton.INSTANCE;</span><br><span class="line">enumSingleton.test();</span><br><span class="line">Class&lt;EnumSingleton&gt; cls = EnumSingleton.class;</span><br><span class="line">System.out.println(enumSingleton == cls.newInstance());</span><br></pre></td></tr></table></figure>

<p>因为类的cls.newInstance()方法最后调用了Constructor的newInstance方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((clazz.getModifiers() &amp; Modifier.ENUM) != <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Cannot reflectively create enum objects&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="序列化与单例"><a href="#序列化与单例" class="headerlink" title="序列化与单例"></a>序列化与单例</h2><p>为了防止反射破坏单例，在私有构造方法里面加入了一个同步变量的判断，确保构造方法只调用一次。但是仍然无法阻止序列化破坏单例，而枚举类可以防止。</p>
<p>Java规范中规定，每一个枚举类型极其定义的枚举变量在JVM中都是唯一的，因此在枚举类型的序列化和反序列化上，Java做了特殊的规定。<br>在序列化的时候Java仅仅是将枚举对象的name属性输出到结果中，反序列化的时候则是通过 java.lang.Enum 的 valueOf() 方法来根据名字查找枚举对象。 也就是说，以下面枚举为例，序列化的时候只将 DATASOURCE 这个名称输出，反序列化的时候再通过这个名称，查找对于的枚举类型，因此反序列化后的实例也会和之前被序列化的对象实例相同。</p>
<p>在readObj底层实现上，是通过反射调用私有构造方法来返回实例的，但是在这段代码后面，还会检测该类是否有一个readResolve（）方法，如果有，就返回这个方法返回值。这个方法必然是为了解决序列化破坏单例的，我们可以添加这个方法，让其返回单例。</p>
<p>对于枚举单例之外的其他方式实现的单例模式，如果既想要做到可序列化，又想要反序列化为同一对象，则必须实现readResolve方法。</p>
<p>所以在单例类中添加如下方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">readResolve</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> instance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="工厂模式"><a href="#工厂模式" class="headerlink" title="工厂模式"></a>工厂模式</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><ol>
<li>抽象工厂角色：这是工厂方法模式的核心，它与应用程序无关。是具体工厂角色必须实现的接口或者必须继承的父类。在java中它由抽象类或者接口来实现。</li>
<li>具体工厂角色：它含有和具体业务逻辑有关的代码。由应用程序调用以创建对应的具体产品的对象。 </li>
<li>抽象产品角色：它是具体产品继承的父类或者是实现的接口。在java中一般有抽象类或者接口来实现。 </li>
<li>具体产品角色：具体工厂角色所创建的对象就是此角色的实例。在java中由具体的类来实现。</li>
</ol>
<p>可以使用反射方法替代多个具体工厂角色，避免新建过多的具体工厂类。</p>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p><strong>抽象工厂接口：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HairFactory</span> </span>&#123;</span><br><span class="line">    <span class="function">Hair <span class="title">create</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体工厂类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LeftHairFactory</span> <span class="keyword">implements</span> <span class="title">HairFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Hair <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LeftHair();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RightHairFactory</span> <span class="keyword">implements</span> <span class="title">HairFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Hair <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RightHair();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>抽象产品接口：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Hair</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Hair</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体产品类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LeftHair</span> <span class="keyword">extends</span> <span class="title">Hair</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LeftHair</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;LeftHair...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RightHair</span> <span class="keyword">extends</span> <span class="title">Hair</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RightHair</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;RightHair...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用反射的方法：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HairFactoryByReflect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Hair <span class="title">getHairByClass</span><span class="params">(Class c)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span>  (Hair) Class.forName(c.getName()).newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h1><h2 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h2><p>观察者模式是对象的行为模式，又叫发布-订阅(Publish/Subscribe)模式、模型-视图(Model/View)模式、源-监听器(Source/Listener)模式或从属者(Dependents)模式。观察者模式定义了一种一对多的依赖关系，让多个观察者对象同时监听某一个主题对象。这个主题对象在状态上发生变化时，会通知所有观察者对象，使它们能够自动更新自己。</p>
<p>观察者模式所涉及的角色有：</p>
<ul>
<li>抽象主题(Subject)角色：抽象主题角色把所有对观察者对象的引用保存在一个集合里，每个主题都可以有任何数量的观察者。抽象主题提供一个接口，可以增加和删除观察者对象，抽象主题角色又叫做抽象被观察者(Observable)角色。</li>
<li>具体主题(ConcreteSubject)角色：将有关状态存入具体观察者对象；在具体主题的内部状态改变时，给所有登记过的观察者发出通知。具体主题角色又叫做具体被观察者(Concrete Observable)角色。</li>
<li>抽象观察者(Observer)角色：为所有的具体观察者定义一个接口，在得到主题的通知时更新自己，这个接口叫做更新接口。</li>
<li>具体观察者(ConcreteObserver)角色：存储与主题的状态自恰的状态。具体观察者角色实现抽象观察者角色所要求的更新接口，以便使本身的状态与主题的状态 像协调。如果需要，具体观察者角色可以保持一个指向具体主题对象的引用。</li>
</ul>
<h2 id="实例-1"><a href="#实例-1" class="headerlink" title="实例"></a>实例</h2><p><strong>抽象主题角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 用来保存注册的观察者对象</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Observer&gt; list = <span class="keyword">new</span> ArrayList&lt;Observer&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 注册观察者对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Observer observer)</span></span>&#123;</span><br><span class="line">        list.add(observer);</span><br><span class="line">        System.out.println(<span class="string">&quot;Attached an observer&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除观察者对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">detach</span><span class="params">(Observer observer)</span></span>&#123;</span><br><span class="line">        list.remove(observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通知所有注册的观察者对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nodifyObservers</span><span class="params">(String newState)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(Observer observer : list)&#123;</span><br><span class="line">            observer.update(newState);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体主题角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteSubject</span> <span class="keyword">extends</span> <span class="title">Subject</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String state;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">change</span><span class="params">(String newState)</span></span>&#123;</span><br><span class="line">        state = newState;</span><br><span class="line">        System.out.println(<span class="string">&quot;主题状态为：&quot;</span> + state);</span><br><span class="line">        <span class="comment">// 状态发生改变，通知各个观察者</span></span><br><span class="line">        <span class="keyword">this</span>.nodifyObservers(state);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>抽象观察者角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(String state)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体观察者角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteObserver</span> <span class="keyword">implements</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 观察者的状态</span></span><br><span class="line">    <span class="keyword">private</span> String observerState;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(String state)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 更新观察者的状态，使其与目标的状态保持一致</span></span><br><span class="line">        observerState = state;</span><br><span class="line">        System.out.println(<span class="string">&quot;状态为：&quot;</span> + observerState);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建主题对象</span></span><br><span class="line">        ConcreteSubject subject = <span class="keyword">new</span> ConcreteSubject();</span><br><span class="line">        <span class="comment">// 创建观察者对象</span></span><br><span class="line">        Observer observer = <span class="keyword">new</span> ConcreteObserver();</span><br><span class="line">        <span class="comment">// 将观察者对象登记到主题对象上</span></span><br><span class="line">        subject.attach(observer);</span><br><span class="line">        <span class="comment">// 改变主题对象的状态</span></span><br><span class="line">        subject.change(<span class="string">&quot;new state&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="代理-委托模式"><a href="#代理-委托模式" class="headerlink" title="代理/委托模式"></a>代理/委托模式</h1><h2 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h2><p>当不能直接访问一个对象时，可以使用代理来间接访问，比如对象在另外一台机器上，或者对象被持久化了，对象是受保护的。代理模式侧重于控制对对象的访问，代理类可以对它的客户隐藏一个对象的具体信息。</p>
<p>静态代理模式的代理类只是实现了特定类的代理，如果代理类对象的方法越多，你就得写越多的重复的代码，使用动态代理可以比较好地解决这个问题，动态代理可以动态的生成代理类，实现对不同类下的不同方法的代理。</p>
<p>静态代理和动态代理的区别：</p>
<ol>
<li>静态代理在代理前就知道要代理的是哪个对象，而动态代理是运行时才知道；</li>
<li>静态代理一般只能代理一个类，而动态代理能代理实现了接口的多个类；</li>
</ol>
<h2 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h2><h3 id="概述-3"><a href="#概述-3" class="headerlink" title="概述"></a>概述</h3><p>当使用静态代理模式的时候，我们常常在一个代理类中创建一个对象的实例。</p>
<p>参与者：</p>
<ul>
<li>被代理对象基类（Subject）：定义一个接口。</li>
<li>具体被代理对象类（ConcreteSubject）：实现接口的方法。</li>
<li>代理类（Proxy）：内部有被代理对象的成员变量，且直接在内部实例化它，代理类也实现了被代理对象基类的方法。</li>
</ul>
<h3 id="实例-2"><a href="#实例-2" class="headerlink" title="实例"></a>实例</h3><p><strong>被代理对象基类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">operate</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体被代理对象类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteSubject</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;do something...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>代理类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Subject subject = <span class="keyword">new</span> ConcreteSubject();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 调用目标之前可以做相关操作</span></span><br><span class="line">        System.out.println(<span class="string">&quot;before....&quot;</span>);</span><br><span class="line">        subject.operate();</span><br><span class="line">        <span class="comment">// 调用目标之后可以做相关操作</span></span><br><span class="line">        System.out.println(<span class="string">&quot;after....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Subject subject = <span class="keyword">new</span> Proxy();</span><br><span class="line">        subject.operate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Jdk动态代理"><a href="#Jdk动态代理" class="headerlink" title="Jdk动态代理"></a>Jdk动态代理</h2><h3 id="概述-4"><a href="#概述-4" class="headerlink" title="概述"></a>概述</h3><p>jdk动态代理是利用反射机制生成一个实现代理接口的匿名类，在调用业务方法前调用InvocationHandler处理。代理类必须实现InvocationHandler接口，并且，JDK动态代理只能代理实现了接口的类，没有实现接口的类是不能实现JDK动态代理。</p>
<p>使用JDK动态代理类基本步骤：</p>
<ol>
<li>编写需要被代理的类和接口；</li>
<li>编写代理类，需要实现InvocationHandler接口，重写invoke方法；</li>
<li>使用<code>Proxy.newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h)</code>动态创建代理类对象，通过代理类对象调用业务方法。</li>
</ol>
<h3 id="实例-3"><a href="#实例-3" class="headerlink" title="实例"></a>实例</h3><p><strong>被代理对象基类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">operate</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体被代理对象类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteSubject</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;do something...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>代理类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Proxy</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object obj, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before....&quot;</span>);</span><br><span class="line">        <span class="comment">// 使用方法的反射</span></span><br><span class="line">        Object invoke = method.invoke(target, args);</span><br><span class="line">        System.out.println(<span class="string">&quot;after....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> invoke;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Subject subject = <span class="keyword">new</span> ConcreteSubject();</span><br><span class="line">        Class&lt;?&gt; clazz = subject.getClass();</span><br><span class="line">        Proxy proxy = <span class="keyword">new</span> Proxy(subject);</span><br><span class="line">        Subject subjectProxy = (Subject) Proxy.newProxyInstance(clazz.getClassLoader(), clazz.getInterfaces(), proxy);</span><br><span class="line">        subjectProxy.operate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Cglib动态代理"><a href="#Cglib动态代理" class="headerlink" title="Cglib动态代理"></a>Cglib动态代理</h2><h3 id="概述-5"><a href="#概述-5" class="headerlink" title="概述"></a>概述</h3><p>Cglib是针对类来实现代理的，类不用实现接口，Cglib会对目标类产生一个代理子类，通过方法拦截技术对过滤父类的方法调用，因此不能代理声明为final类型的类和方法。代理子类需要实现MethodInterceptor接口。</p>
<p>Cglib实现的MethodInterceptor接口在spring-core包。</p>
<h3 id="实例-4"><a href="#实例-4" class="headerlink" title="实例"></a>实例</h3><p><strong>被代理对象类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;do something...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>代理类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getProxyObj</span><span class="params">(Class clazz)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//设置父类</span></span><br><span class="line">        enhancer.setSuperclass(clazz);</span><br><span class="line">        enhancer.setCallback(<span class="keyword">this</span>);</span><br><span class="line">        enhancer.setUseCache(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> enhancer.create();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object o, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before....&quot;</span>);</span><br><span class="line">        <span class="comment">// 代理类对象实例调用父类方法</span></span><br><span class="line">        methodProxy.invokeSuper(o, args);</span><br><span class="line">        System.out.println(<span class="string">&quot;after....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Proxy proxy = <span class="keyword">new</span> Proxy();</span><br><span class="line">        Subject subjectProxy = (Subject) proxy.getProxyObj(Subject.class);</span><br><span class="line">        subjectProxy.operate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="装饰模式"><a href="#装饰模式" class="headerlink" title="装饰模式"></a>装饰模式</h1><h2 id="概述-6"><a href="#概述-6" class="headerlink" title="概述"></a>概述</h2><p>装饰模式(Decorator)，动态地给一个对象添加一些额外的职责，就增加功能来说，装饰模式比生成子类更为灵活。装饰器模式关注于在一个对象上动态的添加方法，因此，当使用装饰器模式的时候，我们通常的做法是将原始对象作为一个参数传给装饰者的构造器。</p>
<p>参与者：</p>
<ul>
<li>被装饰对象基类（Subject）：定义一个接口。</li>
<li>具体被装饰对象类（ConcreteSubject）：实现接口的方法。</li>
<li>装饰者类（Decorator）：内部有被装饰对象的成员变量，其实例由外部传入，装饰者类也实现了被装饰对象基类的方法。</li>
</ul>
<h2 id="实例-5"><a href="#实例-5" class="headerlink" title="实例"></a>实例</h2><p><strong>被装饰对象基类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">operate</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体被装饰对象类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteSubject</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;do something...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>装饰者类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Decorator</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Subject subject;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Decorator</span><span class="params">(Subject subject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.subject = subject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 调用目标之前可以做相关操作</span></span><br><span class="line">        System.out.println(<span class="string">&quot;before....&quot;</span>);</span><br><span class="line">        subject.operate();</span><br><span class="line">        <span class="comment">// 调用目标之后可以做相关操作</span></span><br><span class="line">        System.out.println(<span class="string">&quot;after....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Subject subject = <span class="keyword">new</span> ConcreteSubject();</span><br><span class="line">        Subject decorator = <span class="keyword">new</span> Decorator(subject);</span><br><span class="line">        decorator.operate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="外观-门面-Facade-模式"><a href="#外观-门面-Facade-模式" class="headerlink" title="外观/门面(Facade)模式"></a>外观/门面(Facade)模式</h1><h2 id="概述-7"><a href="#概述-7" class="headerlink" title="概述"></a>概述</h2><p>隐藏了系统的复杂性，并向客户端提供了一个可以访问系统的接口。这种类型的设计模式属于结构性模式。为子系统中的一组接口提供了一个统一的访问接口，这个接口使得子系统更容易被访问或者使用。 </p>
<ol>
<li>门面（Facede）角色：外观模式的核心。它被客户角色调用，它熟悉子系统的功能。内部根据客户角色的需求预定了几种功能的组合。</li>
<li>子系统角色：实现了子系统的功能。它对客户角色和Facade是未知的。它内部可以有系统内的相互交互，也可以由供外界调用的接口。</li>
<li>客户角色：通过调用Facede来完成要实现的功能。</li>
</ol>
<h2 id="实例-6"><a href="#实例-6" class="headerlink" title="实例"></a>实例</h2><p>每个Computer都有CPU、Memory、Disk。在Computer开启和关闭的时候，相应的部件也会开启和关闭，所以，使用了该外观模式后，会使用户和部件之间解耦。</p>
<p><strong>子系统：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CPU</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;CPU start...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;CPU shutdown...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Memory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Memory start...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Memory shutdown...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>门面：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Computer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> CPU cpu;</span><br><span class="line">    <span class="keyword">private</span> Memory memory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Computer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        cpu = <span class="keyword">new</span> CPU();</span><br><span class="line">        memory = <span class="keyword">new</span> Memory();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Computer start begin...&quot;</span>);</span><br><span class="line">        cpu.start();</span><br><span class="line">        memory.start();</span><br><span class="line">        System.out.println(<span class="string">&quot;Computer start end...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Computer shutdown begin...&quot;</span>);</span><br><span class="line">        cpu.shutdown();</span><br><span class="line">        memory.shutdown();</span><br><span class="line">        System.out.println(<span class="string">&quot;Computer shutdown end...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Computer computer = <span class="keyword">new</span> Computer();</span><br><span class="line">    computer.start();</span><br><span class="line">    System.out.println(<span class="string">&quot;=========&quot;</span>);</span><br><span class="line">    computer.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h1><h2 id="概述-8"><a href="#概述-8" class="headerlink" title="概述"></a>概述</h2><p>命令模式是对命令的封装。命令模式把发出命令的责任和执行命令的责任分割开，委派给不同的对象。</p>
<p>每一个命令都是一个操作：请求的一方发出请求要求执行一个操作；接收的一方收到请求，并执行操作。命令模式允许请求的一方和接收的一方独立开来，使得请求的一方不必知道接收请求的一方的接口，更不必知道请求是怎么被接收，以及操作是否被执行、何时被执行，以及是怎么被执行的。命令允许请求的一方和接收请求的一方能够独立演化，从而具有以下的优点：</p>
<ul>
<li>命令模式使新的命令很容易地被加入到系统里。</li>
<li>允许接收请求的一方决定是否要否决请求。</li>
<li>能较容易地设计一个命令队列。</li>
<li>可以容易地实现对请求的撤销和恢复。</li>
<li>在需要的情况下，可以较容易地将命令记入日志。</li>
</ul>
<p>命令模式涉及到五个角色，它们分别是：</p>
<ul>
<li>客户端(Client)角色：创建一个具体命令(ConcreteCommand)对象并确定其接收者。</li>
<li>命令(Command)角色：声明了一个给所有具体命令类的抽象接口。</li>
<li>具体命令(ConcreteCommand)角色：定义一个接收者和行为之间的弱耦合；实现execute()方法，负责调用接收者的相应操作。execute()方法通常叫做执行方法。</li>
<li>请求者(Invoker)角色：负责调用命令对象执行请求，相关的方法叫做行动方法。</li>
<li>接收者(Receiver)角色：负责具体实施和执行一个请求。任何一个类都可以成为接收者，实施和执行请求的方法叫做行动方法。</li>
</ul>
<h2 id="实例-7"><a href="#实例-7" class="headerlink" title="实例"></a>实例</h2><p><strong>接收者角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Receiver</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 真正执行命令相应的操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;执行操作&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>抽象命令角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Command</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体命令角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteCommand</span> <span class="keyword">implements</span> <span class="title">Command</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 持有相应的接收者对象</span></span><br><span class="line">    <span class="keyword">private</span> Receiver receiver = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcreteCommand</span><span class="params">(Receiver receiver)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.receiver = receiver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 通常会转调接收者对象的相应方法，让接收者来真正执行功能</span></span><br><span class="line">        receiver.action();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>请求者角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Invoker</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 持有命令对象</span></span><br><span class="line">    <span class="keyword">private</span> Command command = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Invoker</span><span class="params">(Command command)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.command = command;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">()</span></span>&#123;</span><br><span class="line">        command.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建接收者</span></span><br><span class="line">        Receiver receiver = <span class="keyword">new</span> Receiver();</span><br><span class="line">        <span class="comment">// 创建命令对象，设定它的接收者</span></span><br><span class="line">        Command command = <span class="keyword">new</span> ConcreteCommand(receiver);</span><br><span class="line">        <span class="comment">// 创建请求者，把命令对象设置进去</span></span><br><span class="line">        Invoker invoker = <span class="keyword">new</span> Invoker(command);</span><br><span class="line">        <span class="comment">// 执行方法</span></span><br><span class="line">        invoker.action();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="责任链模式"><a href="#责任链模式" class="headerlink" title="责任链模式"></a>责任链模式</h1><h2 id="概述-9"><a href="#概述-9" class="headerlink" title="概述"></a>概述</h2><p>责任链模式是一种对象的行为模式。在责任链模式里，很多对象由每一个对象对其下家的引用而连接起来形成一条链。请求在这个链上传递，直到链上的某一个对象决定处理此请求。发出这个请求的客户端并不知道链上的哪一个对象最终处理这个请求，这使得系统可以在不影响客户端的情况下动态地重新组织和分配责任，如Java语言的try catch。</p>
<p>责任链模式涉及到的角色如下所示：</p>
<ul>
<li>抽象处理者(Handler)角色：定义出一个处理请求的接口。如果需要，接口可以定义出一个方法以设定和返回对下家的引用。这个角色通常由一个Java抽象类或者Java接口实现。</li>
<li>具体处理者(ConcreteHandler)角色：具体处理者接到请求后，可以选择将请求处理掉，或者将请求传给下家。由于具体处理者持有对下家的引用，因此，如果需要，具体处理者可以访问下家。</li>
</ul>
<h2 id="实例-8"><a href="#实例-8" class="headerlink" title="实例"></a>实例</h2><p><strong>抽象处理者角色：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 持有后继的责任对象</span></span><br><span class="line">    <span class="keyword">protected</span> Handler nextHandler;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">handleRequest</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Handler <span class="title">getNextHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> nextHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNextHandler</span><span class="params">(Handler nextHandler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.nextHandler = nextHandler;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体处理者角色：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(getNextHandler() != <span class="keyword">null</span>) &#123;            </span><br><span class="line">            System.out.println(<span class="string">&quot;放过请求&quot;</span>);</span><br><span class="line">            getNextHandler().handleRequest();            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;            </span><br><span class="line">            System.out.println(<span class="string">&quot;处理请求&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 组装责任链</span></span><br><span class="line">        Handler handler1 = <span class="keyword">new</span> ConcreteHandler();</span><br><span class="line">        Handler handler2 = <span class="keyword">new</span> ConcreteHandler();</span><br><span class="line">        handler1.setSuccessor(handler2);</span><br><span class="line">        <span class="comment">// 提交请求</span></span><br><span class="line">        handler1.handleRequest();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="享元-Flyweight-模式"><a href="#享元-Flyweight-模式" class="headerlink" title="享元(Flyweight)模式"></a>享元(Flyweight)模式</h1><h2 id="概述-10"><a href="#概述-10" class="headerlink" title="概述"></a>概述</h2><p>享元模式(Flyweight Pattern)：运用共享技术有效地支持大量细粒度对象的复用。系统只使用少量的对象，而这些对象都很相似，状态变化很小，可以实现对象的多次复用。由于享元模式要求能够共享的对象必须是细粒度对象，因此它又称为轻量级模式，它是一种对象d结构模式。</p>
<p>Java中字符串常量，Android中的Message，线程池等都运用了享元模式，单纯享元模式所涉及到的角色如下：</p>
<ul>
<li>抽象享元(Flyweight)角色 ：给出一个抽象接口，以规定出所有具体享元角色需要实现的方法。</li>
<li>具体享元(ConcreteFlyweight)角色：实现抽象享元角色所规定出的接口。</li>
<li>享元工厂(FlyweightFactory)角色 ：本角色负责创建和管理享元角色。当一个客户端对象调用一个享元对象的时候，享元工厂角色会检查系统中是否已经有一个符合要求的享元对象，如果已经有了，享元工厂角色就应当提供这个已有的享元对象；如果系统中没有一个适当的享元对象的话，享元工厂角色就应当创建一个合适的享元对象。</li>
</ul>
<h2 id="实例-9"><a href="#实例-9" class="headerlink" title="实例"></a>实例</h2><p><strong>抽象享元角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Flyweight</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">(String state)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体享元角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteFlyweight</span> <span class="keyword">implements</span> <span class="title">Flyweight</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Character intrinsicState = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcreteFlyweight</span><span class="params">(Character state)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.intrinsicState = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">(String state)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Intrinsic State = &quot;</span> + <span class="keyword">this</span>.intrinsicState);</span><br><span class="line">        System.out.println(<span class="string">&quot;Extrinsic State = &quot;</span> + state);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>享元工厂角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlyweightFactory</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;Character, Flyweight&gt; files = <span class="keyword">new</span> HashMap&lt;Character, Flyweight&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Flyweight <span class="title">factory</span><span class="params">(Character state)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 先从缓存中查找对象</span></span><br><span class="line">        Flyweight fly = files.get(state);</span><br><span class="line">        <span class="keyword">if</span> (fly == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果对象不存在则创建一个新的Flyweight对象</span></span><br><span class="line">            fly = <span class="keyword">new</span> ConcreteFlyweight(state);</span><br><span class="line">            <span class="comment">// 把这个新的Flyweight对象添加到缓存中</span></span><br><span class="line">            files.put(state, fly);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fly;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        FlyweightFactory factory = <span class="keyword">new</span> FlyweightFactory();</span><br><span class="line">        Flyweight fly = factory.factory(<span class="keyword">new</span> Character(<span class="string">&#x27;a&#x27;</span>));</span><br><span class="line">        fly.operation(<span class="string">&quot;First Call&quot;</span>);</span><br><span class="line"></span><br><span class="line">        fly = factory.factory(<span class="keyword">new</span> Character(<span class="string">&#x27;b&#x27;</span>));</span><br><span class="line">        fly.operation(<span class="string">&quot;Second Call&quot;</span>);</span><br><span class="line"></span><br><span class="line">        fly = factory.factory(<span class="keyword">new</span> Character(<span class="string">&#x27;a&#x27;</span>));</span><br><span class="line">        fly.operation(<span class="string">&quot;Third Call&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="模板模式"><a href="#模板模式" class="headerlink" title="模板模式"></a>模板模式</h1><h2 id="概述-11"><a href="#概述-11" class="headerlink" title="概述"></a>概述</h2><p>准备一个抽象类，将部分逻辑以具体方法以及具体构造函数的形式实现，然后声明一些抽象方法来迫使子类实现剩余的逻辑。不同的子类可以以不同的方式实现这些抽象方法，从而对剩余的逻辑有不同的实现，这就是模板方法模式的用意。模板方法的角色：</p>
<ul>
<li>抽象类（AbstractClass）：实现了模板方法，定义了算法的骨架。</li>
<li>具体类（ConcreteClass)：实现抽象类中的抽象方法，已完成完整的算法。</li>
</ul>
<h2 id="实例-10"><a href="#实例-10" class="headerlink" title="实例"></a>实例</h2><p><strong>抽象类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractImageLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 抽象类定义整个流程骨架</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">downloadImage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 先获取最终的数据源URL</span></span><br><span class="line">        String finalImageUrl = getUrl();</span><br><span class="line">        <span class="comment">// 然后开始执行下载</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//以下是不同子类根据自身特性完成的具体步骤</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">getUrl</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebpImageLoader</span> <span class="keyword">extends</span> <span class="title">AbstractImageLoader</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;...&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JpgImageLoader</span> <span class="keyword">extends</span> <span class="title">AbstractImageLoader</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;.....&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AbstractImageLoader loader = <span class="keyword">new</span> WebpImageLoader();</span><br><span class="line">        loader.downloadImage();</span><br><span class="line">        loader = <span class="keyword">new</span> JpgImageLoader();</span><br><span class="line">        loader.downloadImage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="策略模式"><a href="#策略模式" class="headerlink" title="策略模式"></a>策略模式</h1><h2 id="概述-12"><a href="#概述-12" class="headerlink" title="概述"></a>概述</h2><p>策略模式属于对象的行为模式。其用意是针对一组算法，将每一个算法封装到具有共同接口的独立的类中，从而使得它们可以相互替换，策略模式使得算法可以在不影响到客户端的情况下发生变化。策略模式是对算法的包装，是把使用算法的责任和算法本身分割开来，委派给不同的对象管理。策略模式通常把一个系列的算法包装到一系列的策略类里面，作为一个抽象策略类的子类。这个模式涉及到三个角色：</p>
<ul>
<li>环境(Context)角色：持有一个Strategy的引用。</li>
<li>抽象策略(Strategy)角色：这是一个抽象角色，通常由一个接口或抽象类实现。此角色给出所有的具体策略类所需的接口。</li>
<li>具体策略(ConcreteStrategy)角色：包装了相关的算法或行为。</li>
</ul>
<h2 id="实例-11"><a href="#实例-11" class="headerlink" title="实例"></a>实例</h2><p><strong>环境角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 持有一个具体策略的对象</span></span><br><span class="line">    <span class="keyword">private</span> Strategy strategy;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Context</span><span class="params">(Strategy strategy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.strategy = strategy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInterface</span><span class="params">()</span> </span>&#123;        </span><br><span class="line">        strategy.strategyInterface();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>抽象策略角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Strategy</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">strategyInterface</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体策略角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteStrategyA</span> <span class="keyword">implements</span> <span class="title">Strategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">strategyInterface</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 相关的业务</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteStrategyB</span> <span class="keyword">implements</span> <span class="title">Strategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">strategyInterface</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 相关的业务</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteStrategyC</span> <span class="keyword">implements</span> <span class="title">Strategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">strategyInterface</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 相关的业务</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Strategy strategy = <span class="keyword">new</span> ConcreteStrategyB();</span><br><span class="line">        Context context = <span class="keyword">new</span> Context(strategy);</span><br><span class="line">        <span class="comment">// 通过不同的Strategy得到不同的结果</span></span><br><span class="line">        context.contextInterface();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ljd1996.github.io/2019/01/07/docker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/07/docker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">docker学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-07 14:32:02" itemprop="dateCreated datePublished" datetime="2019-01-07T14:32:02+08:00">2019-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E5%8F%B0/" itemprop="url" rel="index"><span itemprop="name">后台</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E5%8F%B0/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
                </span>
            </span>

          
            <span id="/2019/01/07/docker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="docker学习笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/01/07/docker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/01/07/docker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="镜像"><a href="#镜像" class="headerlink" title="镜像"></a>镜像</h1><h2 id="获取镜像"><a href="#获取镜像" class="headerlink" title="获取镜像"></a>获取镜像</h2><p>Docker 运行容器前需要本地存在对应的镜像，如果镜像不存在本地，Docker 会从镜像仓库下载（默认是 Docker Hub 公共注册服务器中的仓库）。</p>
<p>下载镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull image:tag</span><br><span class="line"><span class="meta">#</span><span class="bash"> 相当于</span></span><br><span class="line">docker pull registry.hub.docker.com/image:tag</span><br></pre></td></tr></table></figure>

<p>列出镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>

<h2 id="创建镜像"><a href="#创建镜像" class="headerlink" title="创建镜像"></a>创建镜像</h2><h3 id="修改已有镜像"><a href="#修改已有镜像" class="headerlink" title="修改已有镜像"></a>修改已有镜像</h3><ol>
<li>使用本地镜像启动容器: docker run -i -t ubuntu:12.04 /bin/bash</li>
<li>修改</li>
<li>提交: docker commit -m=”msg” -a=”author” container_id rep/name:tag </li>
</ol>
<p>提交参数：</p>
<ul>
<li>-m:提交的描述信息</li>
<li>-a:指定镜像作者</li>
<li>e218edb10161：容器ID</li>
<li>runoob/ubuntu:v2:指定要创建的目标镜像名</li>
</ul>
<h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FROM    centos:6.7</span><br><span class="line">MAINTAINER      Fisher <span class="string">&quot;fisher@sudops.com&quot;</span></span><br><span class="line"></span><br><span class="line">RUN     /bin/echo &#x27;root:123456&#x27; |chpasswd</span><br><span class="line">RUN     useradd runoob</span><br><span class="line">RUN     /bin/echo &#x27;runoob:123456&#x27; |chpasswd</span><br><span class="line">RUN     /bin/echo -e <span class="string">&quot;LANG=\&quot;en_US.UTF-8\&quot;&quot;</span> &gt;/etc/default/local</span><br><span class="line">EXPOSE  22</span><br><span class="line">EXPOSE  80</span><br><span class="line">ADD myApp /var/www</span><br><span class="line">EXPOSE 80</span><br><span class="line">CMD     /usr/sbin/sshd -D</span><br></pre></td></tr></table></figure>

<ul>
<li>使用<code>#</code>注释</li>
<li>每一个指令都会在镜像上创建一个新的层，每一个指令的前缀必须大写</li>
<li>一个镜像不能超过 127 层</li>
<li>第一条FROM指令指定使用哪个镜像源</li>
<li>MAINTAINER 表示维护者的信息</li>
<li>RUN 指令表示在镜像内执行的命令</li>
<li>ADD 命令复制本地文件到镜像</li>
<li>EXPOSE 命令向外部开放端口</li>
<li>CMD 命令描述容器启动后运行的程序</li>
<li>最后通过docker build命令来构建一个镜像</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> -t 添加 tag</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> dir 是 Dockerfile 所在的路径</span></span><br><span class="line">docker build -t runoob/centos:6.7 dir</span><br></pre></td></tr></table></figure>

<h3 id="本地文件系统导入"><a href="#本地文件系统导入" class="headerlink" title="本地文件系统导入"></a>本地文件系统导入</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat ubuntu-14.04-x86_64-minimal.tar.gz  |docker import - ubuntu:14.04</span><br></pre></td></tr></table></figure>

<h2 id="上传镜像"><a href="#上传镜像" class="headerlink" title="上传镜像"></a>上传镜像</h2><ul>
<li>登录: docker login -u user -p passwd -e email hub.c.163.com(网易蜂巢)</li>
<li>标签: docker tag image user_name/repo_name[:tag]</li>
<li>上传: docker push hub.c.163.com/user_name/repo_name[:tag]</li>
</ul>
<h2 id="导出与导入"><a href="#导出与导入" class="headerlink" title="导出与导入"></a>导出与导入</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 导出镜像到本地文件</span></span><br><span class="line">docker save -o file_name image:tag</span><br><span class="line"><span class="meta">#</span><span class="bash"> 载入镜像</span></span><br><span class="line">docker load --input file_name</span><br><span class="line"><span class="meta">#</span><span class="bash"> 或</span></span><br><span class="line">docker load &lt; file_name</span><br></pre></td></tr></table></figure>

<h2 id="移除"><a href="#移除" class="headerlink" title="移除"></a>移除</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi name/id</span><br></pre></td></tr></table></figure>

<h1 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h1><h2 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 运行容器</span></span><br><span class="line">docker run image:tag cmd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 交互式运行容器</span></span><br><span class="line">docker run -i -t image:tag cmd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 停止容器</span></span><br><span class="line">docker stop id/name</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启容器</span></span><br><span class="line">docket stop id/name</span><br></pre></td></tr></table></figure>

<ul>
<li>-t: 在新容器内指定一个伪终端或终端</li>
<li>-i: 允许对容器内的标准输入 (STDIN) 进行交互</li>
<li>-d: 后台启动一个容器</li>
<li>-p local_port:container_port: 端口映射</li>
</ul>
<h2 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h2><h3 id="attach"><a href="#attach" class="headerlink" title="attach"></a>attach</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker attach name/id</span><br></pre></td></tr></table></figure>

<h3 id="nsenter"><a href="#nsenter" class="headerlink" title="nsenter"></a>nsenter</h3><h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm name/id</span><br></pre></td></tr></table></figure>

<h1 id="数据管理"><a href="#数据管理" class="headerlink" title="数据管理"></a>数据管理</h1><h2 id="数据卷"><a href="#数据卷" class="headerlink" title="数据卷"></a>数据卷</h2><p>数据卷是一个可供一个或多个容器使用的特殊目录，它绕过 UFS，可以提供很多有用的特性：</p>
<ul>
<li>数据卷可以在容器之间共享和重用</li>
<li>对数据卷的修改会立马生效</li>
<li>对数据卷的更新，不会影响镜像</li>
<li>卷会一直存在，直到没有容器使用</li>
<li>数据卷的使用，类似于 Linux 下对目录或文件进行 mount。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 加载一个数据卷到容器的 /webapp 目录</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以在 Dockerfile 中使用 VOLUME 来添加一个或者多个新的卷到由该镜像创建的任意容器</span></span><br><span class="line">docker run -d -P --name web -v /webapp training/webapp python app.py</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定挂载一个本地主机目录到容器中</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 加载主机的 /src/webapp 目录到容器的 /opt/webapp 目录, 如果目录不存在会自动创建</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Dockerfile 中不支持这种用法，因为不同操作系统的路径格式不一样</span></span><br><span class="line">docker run -d -P --name web -v /src/webapp:/opt/webapp training/webapp python app.py</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 挂载数据卷的默认权限是读写，可以通过 :ro 指定为只读</span></span><br><span class="line">docker run -d -P --name web -v /src/webapp:/opt/webapp:ro training/webapp python app.py</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 挂载一个本地主机文件作为数据卷</span></span><br><span class="line">docker run --rm -it -v ~/.bash_history:/.bash_history ubuntu /bin/bash</span><br></pre></td></tr></table></figure>

<h2 id="数据卷容器"><a href="#数据卷容器" class="headerlink" title="数据卷容器"></a>数据卷容器</h2><p>如果有一些持续更新的数据需要在容器之间共享，最好创建数据卷容器。数据卷容器，其实就是一个正常的容器，专门用来提供数据卷供其它容器挂载的。</p>
<ol>
<li>创建一个命名的数据卷容器dbdata：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -v /dbdata --name dbdata training/postgres echo Data-only container for postgres</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在其他容器中使用 –volumes-from 来挂载 dbdata 容器中的数据卷</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --volumes-from dbdata --name db1 training/postgres</span><br><span class="line">docker run -d --volumes-from dbdata --name db2 training/postgres</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用多个 --volumes-from 参数来从多个容器挂载多个数据卷，也可以从其他已经挂载了数据卷的容器来挂载数据卷。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用 --volumes-from 参数所挂载数据卷的容器自己并不需要保持在运行状态</span></span><br><span class="line">docker run -d --name db3 --volumes-from db1 training/postgres</span><br></pre></td></tr></table></figure>

<p>如果删除了挂载的容器（包括 dbdata、db1 和 db2），数据卷并不会被自动删除。如果要删除一个数据卷，必须在删除最后一个还挂载着它的容器时使用 docker rm -v 命令来指定同时删除关联的容器。</p>
<h2 id="备份、恢复、迁移数据卷"><a href="#备份、恢复、迁移数据卷" class="headerlink" title="备份、恢复、迁移数据卷"></a>备份、恢复、迁移数据卷</h2><h3 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h3><p>首先使用 –volumes-from 标记来创建一个加载 dbdata 容器卷的容器，并从本地主机挂载当前到容器的 /backup 目录。命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --volumes-from dbdata -v $(pwd):/backup ubuntu tar cvf /backup/backup.tar /dbdata</span><br></pre></td></tr></table></figure>

<p>容器启动后，使用了 tar 命令来将 dbdata 卷备份为本地的 /backup/backup.tar。</p>
<h3 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h3><p>如果要恢复数据到一个容器，首先创建一个带有数据卷的容器 dbdata2。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -v /dbdata --name dbdata2 ubuntu /bin/bash</span><br></pre></td></tr></table></figure>

<p>然后创建另一个容器，挂载 dbdata2 的容器，并使用 untar 解压备份文件到挂载的容器卷中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --volumes-from dbdata2 -v $(pwd):/backup busybox tar xvf /backup/backup.tar</span><br></pre></td></tr></table></figure>

<h1 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h1><h2 id="外部访问容器"><a href="#外部访问容器" class="headerlink" title="外部访问容器"></a>外部访问容器</h2><ul>
<li>当使用 -P 标记时，Docker 会随机映射一个 49000~49900 的端口到内部容器开放的网络端口。</li>
<li>-p 则可以指定要映射的端口，并且，在一个指定端口上只可以绑定一个容器。支持的格式有 ip:hostPort:containerPort | ip::containerPort | hostPort:containerPort。</li>
</ul>
<p>映射所有接口地址:</p>
<ul>
<li>docker run -d -p 5000:5000 training/webapp python app.py: 默认会绑定本地所有接口上的所有地址。</li>
</ul>
<p>映射到指定地址的指定端口:</p>
<ul>
<li>使用 ip:hostPort:containerPort 格式指定映射使用一个特定地址</li>
</ul>
<p>映射到指定地址的任意端口:</p>
<ul>
<li>使用 ip::containerPort 绑定 localhost 的任意端口到容器的 5000 端口，本地主机会自动分配一个端口。</li>
</ul>
<p>还可以使用 udp 标记来指定 udp 端口:</p>
<ul>
<li>docker run -d -p 127.0.0.1:5000:5000/udp training/webapp python app.py</li>
</ul>
<p>查看映射端口配置:</p>
<ul>
<li>使用 docker port 来查看当前映射的端口配置，也可以查看到绑定的地址:port nostalgic_morse 5000</li>
</ul>
<h2 id="容器互联"><a href="#容器互联" class="headerlink" title="容器互联"></a>容器互联</h2><p>容器的连接（linking）系统是除了端口映射外，另一种跟容器中应用交互的方式。该系统会在源和接收容器之间创建一个隧道，接收容器可以看到源容器指定的信息。</p>
<h3 id="自定义容器命名"><a href="#自定义容器命名" class="headerlink" title="自定义容器命名"></a>自定义容器命名</h3><p>连接系统依据容器的名称来执行。因此，首先需要自定义一个好记的容器命名。使用 –name 标记可以为容器自定义命名。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -P --name web training/webapp python app.py</span><br></pre></td></tr></table></figure>

<p>在执行 docker run 的时候如果添加 –rm 标记，则容器在终止后会立刻删除。注意，–rm 和 -d 参数不能同时使用。</p>
<h3 id="容器互联-1"><a href="#容器互联-1" class="headerlink" title="容器互联"></a>容器互联</h3><p>使用 –link 参数可以让容器之间安全的进行交互。–link 参数的格式为 –link name:alias，其中 name 是要链接的容器的名称，alias 是这个连接的别名。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建一个新的数据库容器。</span></span><br><span class="line">docker run -d --name db training/postgres</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个新的 web 容器，并将它连接到 db 容器</span></span><br><span class="line">docker run -d -P --name web --link db:db training/webapp python app.py</span><br><span class="line"><span class="meta">#</span><span class="bash"> docker ps 查看容器的连接</span></span><br><span class="line">docker ps</span><br><span class="line"></span><br><span class="line">CONTAINER ID  IMAGE                     COMMAND               CREATED             STATUS             PORTS                    NAMES</span><br><span class="line">349169744e49  training/postgres:latest  su postgres -c &#x27;/usr  About a minute ago  Up About a minute  5432/tcp                 db, web/db</span><br><span class="line">aed84ee21bde  training/webapp:latest    python app.py         16 hours ago        Up 2 minutes       0.0.0.0:49154-&gt;5000/tcp  web</span><br></pre></td></tr></table></figure>

<p>可以看到自定义命名的容器，db 和 web，db 容器的 names 列有 db 也有 web/db。这表示 web 容器链接到 db 容器，web 容器将被允许访问 db 容器的信息。Docker 在两个互联的容器之间创建了一个安全隧道，而且不用映射它们的端口到宿主主机上。在启动 db 容器的时候并没有使用 -p 和 -P 标记，从而避免了暴露数据库端口到外部网络上。</p>
<p>Docker 通过 2 种方式为容器公开连接信息：</p>
<ol>
<li>环境变量</li>
<li>更新 /etc/hosts 文件</li>
</ol>
<p>使用 env 命令来查看 web 容器的环境变量:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo docker run --rm --name web2 --link db:db training/webapp env</span></span><br><span class="line"></span><br><span class="line">DB_NAME=/web2/db</span><br><span class="line">DB_PORT=tcp://172.17.0.5:5432</span><br><span class="line">DB_PORT_5000_TCP=tcp://172.17.0.5:5432</span><br><span class="line">DB_PORT_5000_TCP_PROTO=tcp</span><br><span class="line">DB_PORT_5000_TCP_PORT=5432</span><br><span class="line">DB_PORT_5000_TCP_ADDR=172.17.0.5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 其中 DB_ 开头的环境变量是供 web 容器连接 db 容器使用，前缀采用大写的连接别名。</span></span><br></pre></td></tr></table></figure>

<p>除了环境变量，Docker 还添加 host 信息到父容器的 /etc/hosts 的文件。下面是父容器 web 的 hosts 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -t -i --rm --link db:db training/webapp /bin/bash</span><br><span class="line">root@aed84ee21bde:/opt/webapp# cat /etc/hosts</span><br><span class="line">172.17.0.7  aed84ee21bde</span><br><span class="line">. . .</span><br><span class="line">172.17.0.5  db</span><br></pre></td></tr></table></figure>

<p>这里有两个 hosts，第一个是 web 容器，web 容器用 id 作为他的主机名，第二个是 db 容器的 ip 和主机名。可以在 web 容器中安装 ping 命令来测试跟db容器的连通。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ljd1996.github.io/2019/01/04/RPC%E5%92%8CHTTP%E7%9B%B8%E5%85%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/04/RPC%E5%92%8CHTTP%E7%9B%B8%E5%85%B3/" class="post-title-link" itemprop="url">RPC和HTTP相关</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-04 13:17:47" itemprop="dateCreated datePublished" datetime="2019-01-04T13:17:47+08:00">2019-01-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E5%8F%B0/" itemprop="url" rel="index"><span itemprop="name">后台</span></a>
                </span>
            </span>

          
            <span id="/2019/01/04/RPC%E5%92%8CHTTP%E7%9B%B8%E5%85%B3/" class="post-meta-item leancloud_visitors" data-flag-title="RPC和HTTP相关" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/01/04/RPC%E5%92%8CHTTP%E7%9B%B8%E5%85%B3/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/01/04/RPC%E5%92%8CHTTP%E7%9B%B8%E5%85%B3/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h1><p>传输协议：</p>
<ul>
<li>RPC，可以基于TCP协议，也可以基于HTTP协议</li>
<li>HTTP，基于HTTP协议</li>
</ul>
<p>传输效率：</p>
<ul>
<li>RPC，使用自定义的TCP协议，可以让请求报文体积更小，或者使用HTTP2协议，也可以很好的减少报文的体积，提高传输效率</li>
<li>HTTP，如果是基于HTTP1.1的协议，请求中会包含很多无用的内容，如果是基于HTTP2.0，那么简单的封装一下是可以作为一个RPC来使用的，这时标准RPC框架更多的是服务治理</li>
</ul>
<p>性能消耗：主要在于序列化和反序列化的耗时</p>
<ul>
<li>RPC，可以基于thrift实现高效的二进制传输</li>
<li>HTTP，大部分是通过json来实现的，字节大小和序列化耗时都比thrift要更消耗性能</li>
</ul>
<p>负载均衡：</p>
<ul>
<li>RPC，基本都自带了负载均衡策略</li>
<li>HTTP，需要配置Nginx，HAProxy来实现</li>
</ul>
<p>服务治理（下游服务新增，重启，下线时如何不影响上游调用者）：</p>
<ul>
<li>RPC，能做到自动通知，不影响上游</li>
<li>HTTP，需要事先通知，修改Nginx/HAProxy配置</li>
</ul>
<p>总结：<br>  RPC主要用于公司内部的服务调用，性能消耗低，传输效率高，服务治理方便。HTTP主要用于对外的异构环境，浏览器接口调用，APP接口调用，第三方接口调用等。</p>
<h1 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h1><p>RPC（Remote Procedure Call）：远程过程调用，它是一种通过网络从远程计算机程序上请求服务，而不需要了解底层网络技术的协议。</p>
<img src="RPC架构.jpg"/>

<ul>
<li>客户端（Client），服务的调用方。</li>
<li>服务端（Server），真正的服务提供者。</li>
<li>客户端存根（Client Stub），存放服务端的地址消息，再将客户端的请求参数打包成网络消息，然后通过网络远程发送给服务方。</li>
<li>服务端存根（Server Stub），接收客户端发送过来的消息，将消息解包，并调用本地的方法。</li>
</ul>
<p>RPC主要是为了解决的两个问题：</p>
<ul>
<li>解决分布式系统中，服务之间的调用问题。</li>
<li>远程调用时，要能够像本地调用一样方便，让调用者感知不到远程调用的逻辑。</li>
</ul>
<p>假设Service A（Client）要调用Service B（Server）中Util类的handle方法：</p>
<img src="RPC调用过程.webp"/>

<ol>
<li>Service A的应用层代码中，调用了handle方法；</li>
<li>这个Util实现类，内部并不是直接实现handle逻辑，而是通过远程调用Service B的RPC接口，来获取运算结果，因此称之为Stub；</li>
<li>Stub和Service B建立远程通讯需要用到远程通讯工具，也就是图中的Run-time Library，这个工具将实现远程通讯的功能，比如Java的Socket，就是这样一个库，当然，也可以用基于Http协议的HttpClient，或者其他通讯工具类都可以，RPC并没有规定要用何种协议进行通讯；</li>
<li>Stub通过调用通讯工具提供的方法，和Service B建立起了通讯，然后将请求数据发给Service B。需要注意的是，由于底层的网络通讯是基于二进制格式的，因此这里Stub传给通讯工具类的数据也必须是二进制，然后传给通讯工具类；</li>
<li>二进制的数据传到Service B后，Service B使用自己的通讯工具接收二进制的请求；</li>
<li>然后将二进制的数据反序列化为请求对象，再将这个请求对象交给Service B的Stub处理；</li>
<li>Stub负责解析请求对象，知道调用方要调的是哪个RPC接口，传进来的参数又是什么，然后再把这些参数传给对应的RPC接口，也就是Util的实际实现类去执行；</li>
<li>RPC接口执行完毕，返回执行结果，二者交互角色，重复以上过程。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ljd1996.github.io/2019/01/04/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/04/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">分布式系统学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-04 12:40:42" itemprop="dateCreated datePublished" datetime="2019-01-04T12:40:42+08:00">2019-01-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E5%8F%B0/" itemprop="url" rel="index"><span itemprop="name">后台</span></a>
                </span>
            </span>

          
            <span id="/2019/01/04/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="分布式系统学习笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/01/04/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/01/04/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>分布式系统（Distributed System）是由一组通过网络进行通信、为了完成共同的任务而协调工作的计算机节点组成的系统。分布式系统的出现是为了用廉价的、普通的机器完成单个计算机无法完成的计算、存储任务。<strong>其目的是利用更多的机器，处理更多的数据</strong>。</p>
<p>为了性能的提升，当单个节点的处理能力无法满足日益增长的计算、存储任务，且硬件的提升高昂到得不偿失的时候，我们才考虑用分布式系统。因为分布式系统要解决的问题本身就是和单机系统一样的，而由于分布式系统多节点、通过网络通信的拓扑结构，会引入很多单机系统没有的问题，为了解决这些问题又会引入更多的机制、协议，带来更多的问题。</p>
<p>Partition和Replication是解决分布式系统问题的一个组合，很多具体的问题都可以用这个思路去解决。当然也会引入更多的问题，比如为了可用性与可靠性保证，引用了冗余（复制集）。有了冗余，又需要考虑各个副本间的一致性问题。正如CAP、FLP等理论，在分布式系统中，没有最佳的选择，只有最合适的选择。</p>
<p>分布式系统的挑战：</p>
<ol>
<li>异构的机器与网络：分布式系统中的机器配置不一样，其上运行的服务也可能由不同的语言、架构实现，因此处理能力也不一样；节点间通过网络连接，而不同网络运营商提供的网络的带宽、延时、丢包率又不一样。</li>
<li>节点故障：当节点数目达到一定规模时，出故障的概率就变高了。分布式系统需要保证故障发生的时候，系统仍然是可用的。</li>
<li>不可靠的网络：节点间通过网络通信，而网络是不可靠的。</li>
</ol>
<p>分布式系统特性与衡量标准：</p>
<ol>
<li>透明性：分布式系统的最高境界是用户根本感知不到这是一个分布式系统。</li>
<li>可扩展性</li>
<li>可用性与可靠性</li>
<li>高性能</li>
<li>一致性</li>
</ol>
<p>一个大型网站包含诸多组件，每一个组件都是一个分布式系统，比如分布式存储就是一个分布式系统，消息队列就是一个分布式系统。</p>
<p>一些概念：</p>
<ul>
<li><p>负载均衡：</p>
<ul>
<li>Nginx</li>
<li>LVS</li>
</ul>
</li>
<li><p>webserver：</p>
<ul>
<li>Java：Tomcat，Apache，Jboss</li>
<li>Python：gunicorn、uwsgi、twisted、webpy、tornado</li>
</ul>
</li>
<li><p>service：　　</p>
<ul>
<li>SOA、微服务、spring boot，django</li>
</ul>
</li>
<li><p>容器：</p>
<ul>
<li>docker，kubernetes</li>
</ul>
</li>
<li><p>cache：</p>
<ul>
<li>memcache、redis等</li>
</ul>
</li>
<li><p>协调中心：</p>
<ul>
<li>zookeeper、etcd等</li>
</ul>
</li>
<li><p>rpc框架：</p>
<ul>
<li>grpc、dubbo、brpc</li>
</ul>
</li>
<li><p>消息队列：</p>
<ul>
<li>kafka、rabbitMQ、rocketMQ、QSP</li>
</ul>
</li>
<li><p>实时数据平台：</p>
<ul>
<li>storm、akka</li>
</ul>
</li>
<li><p>离线数据平台：</p>
<ul>
<li>hadoop、spark</li>
</ul>
</li>
<li><p>dbproxy：</p>
<ul>
<li>cobar也是阿里开源的，在阿里系中使用也非常广泛，是关系型数据库的sharding + replica 代理</li>
</ul>
</li>
<li><p>db：</p>
<ul>
<li>mysql、oracle、MongoDB、HBase</li>
</ul>
</li>
<li><p>搜索：</p>
<ul>
<li>elasticsearch、solr</li>
</ul>
</li>
<li><p>日志：</p>
<ul>
<li>rsyslog、elk、flume</li>
</ul>
</li>
</ul>
<h1 id="请求过程"><a href="#请求过程" class="headerlink" title="请求过程"></a>请求过程</h1><p>用户使用Web、APP、SDK等通过HTTP、TCP连接到系统。在分布式系统中，为了高并发、高可用，一般都是多个节点提供相同的服务，所以需要考虑负载均衡。</p>
<p>通过负载均衡找到一个节点后，接下来就是真正处理用户的请求了，请求有可能简单，也有可能很复杂。如果有缓存，则需要考虑分布式缓存，如果缓存没有命中，那么需要去数据库拉取数据。</p>
<p>假设服务A需要调用服务B的服务，首先两个节点需要通信，网络通信都是建立在TCP/IP协议的基础上，但是，每个应用都手写socket是一件冗杂、低效的事情，因此需要应用层的封装，因此有了HTTP、FTP等各种应用层协议。当系统愈加复杂，提供大量的http接口也是一件困难的事情。因此，有了更进一步的抽象，那就是RPC。</p>
<p>一个请求可能包含诸多操作，即在服务A上做一些操作，然后在服务B上做另一些操作，这就涉及到分布式事务的问题。</p>
<p>分布式系统中有大量的服务，每个服务又是多个节点组成，一个服务要想找到另一个服务的某个节点就需要服务注册与发现了。</p>
<p>用户请求操作会产生一些数据、日志等信息，其他一些系统可能会对这些消息感兴趣，这里就抽象出了两个概念，消息的生产者与消费者。那么生产者怎么讲消息发送给消费者呢，RPC并不是一个很好的选择，因为RPC肯定得指定消息发给谁，但实际的情况是生产者并不清楚、也不关心谁会消费这个消息，这个时候就需要消息队列了。</p>
<p>上面提到，用户操作会产生一些数据，这就催生了分布式计算平台用来处理这些海量的数据。</p>
<p>最后，用户的操作完成之后，用户的数据需要持久化，但数据量很大，大到按个节点无法存储，这时就需要分布式存储。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ljd1996.github.io/2018/12/28/%E4%BB%A5%E5%A4%AA%E5%9D%8ADApp%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/28/%E4%BB%A5%E5%A4%AA%E5%9D%8ADApp%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">以太坊DApp实战笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-28 18:51:00" itemprop="dateCreated datePublished" datetime="2018-12-28T18:51:00+08:00">2018-12-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/" itemprop="url" rel="index"><span itemprop="name">区块链</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/%E4%BB%A5%E5%A4%AA%E5%9D%8A/" itemprop="url" rel="index"><span itemprop="name">以太坊</span></a>
                </span>
            </span>

          
            <span id="/2018/12/28/%E4%BB%A5%E5%A4%AA%E5%9D%8ADApp%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="以太坊DApp实战笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2018/12/28/%E4%BB%A5%E5%A4%AA%E5%9D%8ADApp%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018/12/28/%E4%BB%A5%E5%A4%AA%E5%9D%8ADApp%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h1><h2 id="编写合约"><a href="#编写合约" class="headerlink" title="编写合约"></a>编写合约</h2><p>hello.sol:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.5</span><span class="number">.2</span>;</span><br><span class="line"></span><br><span class="line">contract InfoContract &#123;</span><br><span class="line"></span><br><span class="line">   string fName;</span><br><span class="line">   uint age;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">setInfo</span>(<span class="params">string memory _fName, uint _age</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">       fName = _fName;</span><br><span class="line">       age = _age;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">getInfo</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">string memory, uint</span>) </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> (fName, age);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="编译合约"><a href="#编译合约" class="headerlink" title="编译合约"></a>编译合约</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">solcjs hello.sol --abi --bin -o ./</span><br></pre></td></tr></table></figure>

<p>生成hello_sol_InfoContract.abi和hello_sol_InfoContract.bin文件。</p>
<h2 id="生成合约的Java文件"><a href="#生成合约的Java文件" class="headerlink" title="生成合约的Java文件"></a>生成合约的Java文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web3j solidity generate --solidityTypes -b hello_sol_hello.bin -a hello_sol_hello.abi -o ./ -p com.test</span><br></pre></td></tr></table></figure>

<p>将生成的Java问价导入到项目中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hello</span> <span class="keyword">extends</span> <span class="title">Contract</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String BINARY = <span class="string">&quot;608060405234801561001057600080fd5b50610346806100206000396000f3fe608060405234801561001057600080fd5b5060043610610053576000357c0100000000000000000000000000000000000000000000000000000000900480635a9b0b89146100585780638262963b146100e2575b600080fd5b6100606101a7565b6040518080602001838152602001828103825284818151815260200191508051906020019080838360005b838110156100a657808201518184015260208101905061008b565b50505050905090810190601f1680156100d35780820380516001836020036101000a031916815260200191505b50935050505060405180910390f35b6101a5600480360360408110156100f857600080fd5b810190808035906020019064010000000081111561011557600080fd5b82018360208201111561012757600080fd5b8035906020019184600183028401116401000000008311171561014957600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f82011690508083019250505050505050919291929080359060200190929190505050610253565b005b6060600080600154818054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156102445780601f1061021957610100808354040283529160200191610244565b820191906000526020600020905b81548152906001019060200180831161022757829003601f168201915b50505050509150915091509091565b8160009080519060200190610269929190610275565b50806001819055505050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106102b657805160ff19168380011785556102e4565b828001600101855582156102e4579182015b828111156102e35782518255916020019190600101906102c8565b5b5090506102f191906102f5565b5090565b61031791905b808211156103135760008160009055506001016102fb565b5090565b9056fea165627a7a7230582007c004e4d5d896b794dd7a63a8b6bdd16e95744ed1d0aa3c5b0eb8c4c7590e250029&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FUNC_GETINFO = <span class="string">&quot;getInfo&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FUNC_SETINFO = <span class="string">&quot;setInfo&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">Hello</span><span class="params">(String contractAddress, Web3j web3j, Credentials credentials, BigInteger gasPrice, BigInteger gasLimit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(BINARY, contractAddress, web3j, credentials, gasPrice, gasLimit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">Hello</span><span class="params">(String contractAddress, Web3j web3j, Credentials credentials, ContractGasProvider contractGasProvider)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(BINARY, contractAddress, web3j, credentials, contractGasProvider);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">Hello</span><span class="params">(String contractAddress, Web3j web3j, TransactionManager transactionManager, BigInteger gasPrice, BigInteger gasLimit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(BINARY, contractAddress, web3j, transactionManager, gasPrice, gasLimit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">Hello</span><span class="params">(String contractAddress, Web3j web3j, TransactionManager transactionManager, ContractGasProvider contractGasProvider)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(BINARY, contractAddress, web3j, transactionManager, contractGasProvider);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RemoteCall&lt;Tuple2&lt;Utf8String, Uint256&gt;&gt; getInfo() &#123;</span><br><span class="line">        <span class="keyword">final</span> Function function = <span class="keyword">new</span> Function(FUNC_GETINFO, </span><br><span class="line">                Arrays.&lt;Type&gt;asList(), </span><br><span class="line">                Arrays.&lt;TypeReference&lt;?&gt;&gt;asList(<span class="keyword">new</span> TypeReference&lt;Utf8String&gt;() &#123;&#125;, <span class="keyword">new</span> TypeReference&lt;Uint256&gt;() &#123;&#125;));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RemoteCall&lt;Tuple2&lt;Utf8String, Uint256&gt;&gt;(</span><br><span class="line">                <span class="keyword">new</span> Callable&lt;Tuple2&lt;Utf8String, Uint256&gt;&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Tuple2&lt;Utf8String, Uint256&gt; <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        List&lt;Type&gt; results = executeCallMultipleValueReturn(function);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;Utf8String, Uint256&gt;(</span><br><span class="line">                                (Utf8String) results.get(<span class="number">0</span>), </span><br><span class="line">                                (Uint256) results.get(<span class="number">1</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RemoteCall&lt;TransactionReceipt&gt; <span class="title">setInfo</span><span class="params">(Utf8String _fName, Uint256 _age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Function function = <span class="keyword">new</span> Function(</span><br><span class="line">                FUNC_SETINFO, </span><br><span class="line">                Arrays.&lt;Type&gt;asList(_fName, _age), </span><br><span class="line">                Collections.&lt;TypeReference&lt;?&gt;&gt;emptyList());</span><br><span class="line">        <span class="keyword">return</span> executeRemoteCallTransaction(function);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Hello <span class="title">load</span><span class="params">(String contractAddress, Web3j web3j, Credentials credentials, BigInteger gasPrice, BigInteger gasLimit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Hello(contractAddress, web3j, credentials, gasPrice, gasLimit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Hello <span class="title">load</span><span class="params">(String contractAddress, Web3j web3j, TransactionManager transactionManager, BigInteger gasPrice, BigInteger gasLimit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Hello(contractAddress, web3j, transactionManager, gasPrice, gasLimit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Hello <span class="title">load</span><span class="params">(String contractAddress, Web3j web3j, Credentials credentials, ContractGasProvider contractGasProvider)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Hello(contractAddress, web3j, credentials, contractGasProvider);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Hello <span class="title">load</span><span class="params">(String contractAddress, Web3j web3j, TransactionManager transactionManager, ContractGasProvider contractGasProvider)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Hello(contractAddress, web3j, transactionManager, contractGasProvider);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RemoteCall&lt;Hello&gt; <span class="title">deploy</span><span class="params">(Web3j web3j, Credentials credentials, ContractGasProvider contractGasProvider)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> deployRemoteCall(Hello.class, web3j, credentials, contractGasProvider, BINARY, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RemoteCall&lt;Hello&gt; <span class="title">deploy</span><span class="params">(Web3j web3j, Credentials credentials, BigInteger gasPrice, BigInteger gasLimit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> deployRemoteCall(Hello.class, web3j, credentials, gasPrice, gasLimit, BINARY, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RemoteCall&lt;Hello&gt; <span class="title">deploy</span><span class="params">(Web3j web3j, TransactionManager transactionManager, ContractGasProvider contractGasProvider)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> deployRemoteCall(Hello.class, web3j, transactionManager, contractGasProvider, BINARY, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RemoteCall&lt;Hello&gt; <span class="title">deploy</span><span class="params">(Web3j web3j, TransactionManager transactionManager, BigInteger gasPrice, BigInteger gasLimit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> deployRemoteCall(Hello.class, web3j, transactionManager, gasPrice, gasLimit, BINARY, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="获取钱包"><a href="#获取钱包" class="headerlink" title="获取钱包"></a>获取钱包</h2><h3 id="1-创建新钱包"><a href="#1-创建新钱包" class="headerlink" title="1. 创建新钱包"></a>1. 创建新钱包</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建新的钱包(钱包余额为0)</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> password: 钱包的密码(不是私钥)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> path: 钱包文件的路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> NoSuchAlgorithmException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> NoSuchProviderException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> InvalidAlgorithmParameterException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> CipherException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Credentials <span class="title">genCredentials</span><span class="params">(String password, String path)</span> <span class="keyword">throws</span> NoSuchAlgorithmException,</span></span><br><span class="line"><span class="function">        NoSuchProviderException, InvalidAlgorithmParameterException, CipherException, IOException </span>&#123;</span><br><span class="line">    String fileName = WalletUtils.generateNewWalletFile(password,</span><br><span class="line">            <span class="keyword">new</span> File(path), <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">return</span> WalletUtils.loadCredentials(password, path + <span class="string">&quot;/&quot;</span> + fileName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-获取现有钱包"><a href="#2-获取现有钱包" class="headerlink" title="2. 获取现有钱包"></a>2. 获取现有钱包</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取已存在钱包</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> privKey</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Credentials <span class="title">getCredentials</span><span class="params">(String privKey)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Credentials.create(privKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="在项目中获取合约对象"><a href="#在项目中获取合约对象" class="headerlink" title="在项目中获取合约对象"></a>在项目中获取合约对象</h2><h3 id="1-部署合约"><a href="#1-部署合约" class="headerlink" title="1. 部署合约"></a>1. 部署合约</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Hello <span class="title">ethDeploy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Web3j web3 = Web3j.build(<span class="keyword">new</span> HttpService(<span class="string">&quot;http://127.0.0.1:7545&quot;</span>)); <span class="comment">// 区块链客户端地址(ganache, geth等)</span></span><br><span class="line">    Credentials credentials = getCredentials(<span class="string">&quot;e35c46af1701a40df4b86385de0af9078c79cab9fb4e2ce1358b376cc24b0ab3&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> Hello.deploy(web3, credentials, GAS_PRICE, GAS_LIMIT).send();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-加载已部署合约"><a href="#2-加载已部署合约" class="headerlink" title="2. 加载已部署合约"></a>2. 加载已部署合约</h3><p>需要提前将合约部署到区块链中，我使用的是Remix和Ganache的方式模拟。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Hello <span class="title">ethLoad</span><span class="params">(String contractAddress)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String password = <span class="string">&quot;15927382215&quot;</span>;</span><br><span class="line">    String filePath = <span class="string">&quot;/home/hearing/WorkSpace/eth/test/src/main/resources&quot;</span>;</span><br><span class="line"></span><br><span class="line">    Web3j web3 = Web3j.build(<span class="keyword">new</span> HttpService(<span class="string">&quot;http://127.0.0.1:7545&quot;</span>));</span><br><span class="line">    Credentials credentials = getCredentials(<span class="string">&quot;e35c46af1701a40df4b86385de0af9078c79cab9fb4e2ce1358b376cc24b0ab3&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Hello.load(contractAddress, web3, credentials, GAS_PRICE, GAS_LIMIT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="调用合约"><a href="#调用合约" class="headerlink" title="调用合约"></a>调用合约</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TransactionReceipt receipt = contract.setInfo(<span class="keyword">new</span> Utf8String(<span class="string">&quot;hearing&quot;</span>), <span class="keyword">new</span> Uint256(<span class="number">21</span>)).send();</span><br><span class="line"><span class="keyword">if</span> (receipt.isStatusOK()) &#123;</span><br><span class="line">    Tuple2 tuple2 = contract.getInfo().send();</span><br><span class="line">    System.out.println(tuple2.getValue1());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="CryptoZombie"><a href="#CryptoZombie" class="headerlink" title="CryptoZombie"></a>CryptoZombie</h1><h2 id="erc721-sol"><a href="#erc721-sol" class="headerlink" title="erc721.sol"></a>erc721.sol</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line">contract ERC721 &#123;</span><br><span class="line">  event Transfer(address indexed _from, address indexed _to, uint256 _tokenId);</span><br><span class="line">  event Approval(address indexed _owner, address indexed _approved, uint256 _tokenId);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address _owner</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint256 _balance</span>);</span></span><br><span class="line"><span class="function">  <span class="title">function</span> <span class="title">ownerOf</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">address _owner</span>);</span></span><br><span class="line"><span class="function">  <span class="title">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span>;</span></span><br><span class="line"><span class="function">  <span class="title">function</span> <span class="title">approve</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span>;</span></span><br><span class="line"><span class="function">  <span class="title">function</span> <span class="title">takeOwnership</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span>;</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="safemath-sol"><a href="#safemath-sol" class="headerlink" title="safemath.sol"></a>safemath.sol</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title <span class="variable">SafeMath</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dev </span>Math operations with safety checks that throw on error</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">library SafeMath &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@dev </span>Multiplies two numbers, throws on overflow.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">mul</span>(<span class="params">uint256 a, uint256 b</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    uint256 c = a * b;</span><br><span class="line">    assert(c / a == b);</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@dev </span>Integer division of two numbers, truncating the quotient.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">div</span>(<span class="params">uint256 a, uint256 b</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// assert(b &gt; 0); // Solidity automatically throws when dividing by 0</span></span><br><span class="line">    uint256 c = a / b;</span><br><span class="line">    <span class="comment">// assert(a == b * c + a % b); // There is no case in which this doesn&#x27;t hold</span></span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@dev </span>Substracts two numbers, throws on overflow (i.e. if subtrahend is greater than minuend).</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sub</span>(<span class="params">uint256 a, uint256 b</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">    assert(b &lt;= a);</span><br><span class="line">    <span class="keyword">return</span> a - b;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@dev </span>Adds two numbers, throws on overflow.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">uint256 a, uint256 b</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">    uint256 c = a + b;</span><br><span class="line">    assert(c &gt;= a);</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ownable-sol"><a href="#ownable-sol" class="headerlink" title="ownable.sol"></a>ownable.sol</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title <span class="variable">Ownable</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dev </span>The Ownable contract has an owner address, and provides basic authorization control</span></span><br><span class="line"><span class="comment"> * functions, this simplifies the implementation of &quot;user permissions&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract Ownable &#123;</span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  event OwnershipTransferred(address indexed previousOwner, address indexed newOwner);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@dev </span>The Ownable constructor sets the original `owner` of the contract to the sender</span></span><br><span class="line"><span class="comment">   * account.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Ownable</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@dev </span>Throws if called by any account other than the owner.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  modifier onlyOwner() &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.sender == owner);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@dev </span>Allows the current owner to transfer control of the contract to a newOwner.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param </span>newOwner The address to transfer ownership to.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transferOwnership</span>(<span class="params">address newOwner</span>) <span class="title">public</span> <span class="title">onlyOwner</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(newOwner != address(<span class="number">0</span>));</span><br><span class="line">    OwnershipTransferred(owner, newOwner);</span><br><span class="line">    owner = newOwner;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="zombiefactory-sol"><a href="#zombiefactory-sol" class="headerlink" title="zombiefactory.sol"></a>zombiefactory.sol</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./ownable.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./safemath.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">contract ZombieFactory is Ownable &#123;</span><br><span class="line"></span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line"></span><br><span class="line">  event NewZombie(uint zombieId, string name, uint dna);</span><br><span class="line"></span><br><span class="line">  uint dnaDigits = <span class="number">16</span>;</span><br><span class="line">  uint dnaModulus = <span class="number">10</span> ** dnaDigits;</span><br><span class="line">  uint cooldownTime = <span class="number">1</span> days;</span><br><span class="line"></span><br><span class="line">  struct Zombie &#123;</span><br><span class="line">    string name;</span><br><span class="line">    uint dna;</span><br><span class="line">    uint32 level;</span><br><span class="line">    uint32 readyTime;</span><br><span class="line">    uint16 winCount;</span><br><span class="line">    uint16 lossCount;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Zombie[] public zombies;</span><br><span class="line"></span><br><span class="line">  mapping (<span class="function"><span class="params">uint</span> =&gt;</span> address) public zombieToOwner;</span><br><span class="line">  mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint) ownerZombieCount;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_createZombie</span>(<span class="params">string _name, uint _dna</span>) <span class="title">internal</span> </span>&#123;</span><br><span class="line">    uint id = zombies.push(Zombie(_name, _dna, <span class="number">1</span>, uint32(now + cooldownTime), <span class="number">0</span>, <span class="number">0</span>)) - <span class="number">1</span>;</span><br><span class="line">    zombieToOwner[id] = msg.sender;</span><br><span class="line">    ownerZombieCount[msg.sender]++;</span><br><span class="line">    NewZombie(id, _name, _dna);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_generateRandomDna</span>(<span class="params">string _str</span>) <span class="title">private</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">    uint rand = uint(keccak256(_str));</span><br><span class="line">    <span class="keyword">return</span> rand % dnaModulus;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">createRandomZombie</span>(<span class="params">string _name</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(ownerZombieCount[msg.sender] == <span class="number">0</span>);</span><br><span class="line">    uint randDna = _generateRandomDna(_name);</span><br><span class="line">    randDna = randDna - randDna % <span class="number">100</span>;</span><br><span class="line">    _createZombie(_name, randDna);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="zombiefeeding-sol"><a href="#zombiefeeding-sol" class="headerlink" title="zombiefeeding.sol"></a>zombiefeeding.sol</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./zombiefactory.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">contract KittyInterface &#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getKitty</span>(<span class="params">uint256 _id</span>) <span class="title">external</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    bool isGestating,</span></span></span><br><span class="line"><span class="function"><span class="params">    bool isReady,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 cooldownIndex,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 nextActionAt,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 siringWithId,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 birthTime,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 matronId,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 sireId,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 generation,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 genes</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">ZombieFeeding</span> <span class="title">is</span> <span class="title">ZombieFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  KittyInterface kittyContract;</span><br><span class="line"></span><br><span class="line">  modifier onlyOwnerOf(uint _zombieId) &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.sender == zombieToOwner[_zombieId]);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setKittyContractAddress</span>(<span class="params">address _address</span>) <span class="title">external</span> <span class="title">onlyOwner</span> </span>&#123;</span><br><span class="line">    kittyContract = KittyInterface(_address);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_triggerCooldown</span>(<span class="params">Zombie storage _zombie</span>) <span class="title">internal</span> </span>&#123;</span><br><span class="line">    _zombie.readyTime = uint32(now + cooldownTime);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_isReady</span>(<span class="params">Zombie storage _zombie</span>) <span class="title">internal</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> (_zombie.readyTime &lt;= now);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">feedAndMultiply</span>(<span class="params">uint _zombieId, uint _targetDna, string _species</span>) <span class="title">internal</span> <span class="title">onlyOwnerOf</span>(<span class="params">_zombieId</span>) </span>&#123;</span><br><span class="line">    Zombie storage myZombie = zombies[_zombieId];</span><br><span class="line">    <span class="built_in">require</span>(_isReady(myZombie));</span><br><span class="line">    _targetDna = _targetDna % dnaModulus;</span><br><span class="line">    uint newDna = (myZombie.dna + _targetDna) / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (keccak256(_species) == keccak256(<span class="string">&quot;kitty&quot;</span>)) &#123;</span><br><span class="line">      newDna = newDna - newDna % <span class="number">100</span> + <span class="number">99</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _createZombie(<span class="string">&quot;NoName&quot;</span>, newDna);</span><br><span class="line">    _triggerCooldown(myZombie);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">feedOnKitty</span>(<span class="params">uint _zombieId, uint _kittyId</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    uint kittyDna;</span><br><span class="line">    (,,,,,,,,,kittyDna) = kittyContract.getKitty(_kittyId);</span><br><span class="line">    feedAndMultiply(_zombieId, kittyDna, <span class="string">&quot;kitty&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="zombiehelper-sol"><a href="#zombiehelper-sol" class="headerlink" title="zombiehelper.sol"></a>zombiehelper.sol</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./zombiefeeding.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">contract ZombieHelper is ZombieFeeding &#123;</span><br><span class="line"></span><br><span class="line">  uint levelUpFee = <span class="number">0.001</span> ether;</span><br><span class="line"></span><br><span class="line">  modifier aboveLevel(uint _level, uint _zombieId) &#123;</span><br><span class="line">    <span class="built_in">require</span>(zombies[_zombieId].level &gt;= _level);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">withdraw</span>(<span class="params"></span>) <span class="title">external</span> <span class="title">onlyOwner</span> </span>&#123;</span><br><span class="line">    owner.transfer(<span class="built_in">this</span>.balance);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setLevelUpFee</span>(<span class="params">uint _fee</span>) <span class="title">external</span> <span class="title">onlyOwner</span> </span>&#123;</span><br><span class="line">    levelUpFee = _fee;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">levelUp</span>(<span class="params">uint _zombieId</span>) <span class="title">external</span> <span class="title">payable</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.value == levelUpFee);</span><br><span class="line">    zombies[_zombieId].level++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">changeName</span>(<span class="params">uint _zombieId, string _newName</span>) <span class="title">external</span> <span class="title">aboveLevel</span>(<span class="params"><span class="number">2</span>, _zombieId</span>) <span class="title">onlyOwnerOf</span>(<span class="params">_zombieId</span>) </span>&#123;</span><br><span class="line">    zombies[_zombieId].name = _newName;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">changeDna</span>(<span class="params">uint _zombieId, uint _newDna</span>) <span class="title">external</span> <span class="title">aboveLevel</span>(<span class="params"><span class="number">20</span>, _zombieId</span>) <span class="title">onlyOwnerOf</span>(<span class="params">_zombieId</span>) </span>&#123;</span><br><span class="line">    zombies[_zombieId].dna = _newDna;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getZombiesByOwner</span>(<span class="params">address _owner</span>) <span class="title">external</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">uint[]</span>) </span>&#123;</span><br><span class="line">    uint[] memory result = <span class="keyword">new</span> uint[](ownerZombieCount[_owner]);</span><br><span class="line">    uint counter = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; zombies.length; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (zombieToOwner[i] == _owner) &#123;</span><br><span class="line">        result[counter] = i;</span><br><span class="line">        counter++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="zombieattach-sol"><a href="#zombieattach-sol" class="headerlink" title="zombieattach.sol"></a>zombieattach.sol</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./zombiehelper.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">contract ZombieBattle is ZombieHelper &#123;</span><br><span class="line">  uint randNonce = <span class="number">0</span>;</span><br><span class="line">  uint attackVictoryProbability = <span class="number">70</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">randMod</span>(<span class="params">uint _modulus</span>) <span class="title">internal</span> <span class="title">returns</span>(<span class="params">uint</span>) </span>&#123;</span><br><span class="line">    randNonce++;</span><br><span class="line">    <span class="keyword">return</span> uint(keccak256(now, msg.sender, randNonce)) % _modulus;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">attack</span>(<span class="params">uint _zombieId, uint _targetId</span>) <span class="title">external</span> <span class="title">onlyOwnerOf</span>(<span class="params">_zombieId</span>) </span>&#123;</span><br><span class="line">    Zombie storage myZombie = zombies[_zombieId];</span><br><span class="line">    Zombie storage enemyZombie = zombies[_targetId];</span><br><span class="line">    uint rand = randMod(<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">if</span> (rand &lt;= attackVictoryProbability) &#123;</span><br><span class="line">      myZombie.winCount++;</span><br><span class="line">      myZombie.level++;</span><br><span class="line">      enemyZombie.lossCount++;</span><br><span class="line">      feedAndMultiply(_zombieId, enemyZombie.dna, <span class="string">&quot;zombie&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      myZombie.lossCount++;</span><br><span class="line">      enemyZombie.winCount++;</span><br><span class="line">      _triggerCooldown(myZombie);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="zombieownership-sol"><a href="#zombieownership-sol" class="headerlink" title="zombieownership.sol"></a>zombieownership.sol</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./zombieattack.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./erc721.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./safemath.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="doctag">TODO:</span> 把这里变成 natspec 标准的注释把</span></span><br><span class="line">contract ZombieOwnership is ZombieAttack, ERC721 &#123;</span><br><span class="line"></span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line"></span><br><span class="line">  mapping (<span class="function"><span class="params">uint</span> =&gt;</span> address) zombieApprovals;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address _owner</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint256 _balance</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ownerZombieCount[_owner];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">ownerOf</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">address _owner</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> zombieToOwner[_tokenId];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_transfer</span>(<span class="params">address _from, address _to, uint256 _tokenId</span>) <span class="title">private</span> </span>&#123;</span><br><span class="line">    ownerZombieCount[_to] = ownerZombieCount[_to].add(<span class="number">1</span>);</span><br><span class="line">    ownerZombieCount[msg.sender] = ownerZombieCount[msg.sender].sub(<span class="number">1</span>);</span><br><span class="line">    zombieToOwner[_tokenId] = _to;</span><br><span class="line">    Transfer(_from, _to, _tokenId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span> <span class="title">onlyOwnerOf</span>(<span class="params">_tokenId</span>) </span>&#123;</span><br><span class="line">    _transfer(msg.sender, _to, _tokenId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">approve</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span> <span class="title">onlyOwnerOf</span>(<span class="params">_tokenId</span>) </span>&#123;</span><br><span class="line">    zombieApprovals[_tokenId] = _to;</span><br><span class="line">    Approval(msg.sender, _to, _tokenId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">takeOwnership</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(zombieApprovals[_tokenId] == msg.sender);</span><br><span class="line">    address owner = ownerOf(_tokenId);</span><br><span class="line">    _transfer(owner, msg.sender, _tokenId);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Geth-常用命令"><a href="#Geth-常用命令" class="headerlink" title="Geth 常用命令"></a>Geth 常用命令</h1><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geth cmd console</span><br></pre></td></tr></table></figure>

<ul>
<li>-–identity：指定节点 ID；</li>
<li>-–rpc：表示开启 HTTP-RPC 服务；</li>
<li>-–rpcport：指定 HTTP-RPC 服务监听端口号（默认为 8545）；</li>
<li>-–datadir：指定区块链数据的存储位置；</li>
<li>-–port：指定和其他节点连接所用的端口号（默认为 30303）；</li>
<li>-–nodiscover：关闭节点发现机制，防止加入有同样初始配置的陌生节点。</li>
</ul>
<h2 id="控制台中的对象"><a href="#控制台中的对象" class="headerlink" title="控制台中的对象"></a>控制台中的对象</h2><p>控制台是一个交互式的JavaScript执行环境，在这里面可以执行JavaScript代码，其中也内置了一些用来操作以太坊的JavaScript对象，可以直接使用这些对象。这些对象主要包括：</p>
<ul>
<li>eth：包含一些跟操作区块链相关的方法；</li>
<li>net：包含一些查看p2p网络状态的方法；</li>
<li>admin：包含一些与管理节点相关的方法；</li>
<li>miner：包含启动&amp;停止挖矿的一些方法；</li>
<li>personal：主要包含一些管理账户的方法；</li>
<li>txpool：包含一些查看交易内存池的方法；</li>
<li>web3：包含了以上对象，还包含一些单位换算的方法。</li>
</ul>
<h2 id="控制台操作"><a href="#控制台操作" class="headerlink" title="控制台操作"></a>控制台操作</h2><p>进入以太坊Javascript Console后，就可以使用里面的内置对象做一些操作，常用命令有：</p>
<ul>
<li>personal.newAccount()：创建账户；</li>
<li>personal.unlockAccount()：解锁账户；</li>
<li>eth.accounts：枚举系统中的账户；</li>
<li>eth.getBalance()：查看账户余额，返回值的单位是 Wei（Wei 是以太坊中最小货币面额单位，类似比特币中的聪，1 ether = 10^18 Wei）；</li>
<li>eth.blockNumber：列出区块总数；</li>
<li>eth.getTransaction()：获取交易；</li>
<li>eth.getBlock()：获取区块；</li>
<li>miner.start()：开始挖矿；</li>
<li>miner.stop()：停止挖矿；</li>
<li>web3.fromWei()：把 wei 转为如下种类的以太坊单位(还有其他代币token单位)；<ul>
<li>kwei/ada</li>
<li>mwei/babbage</li>
<li>gwei/shannon</li>
<li>szabo</li>
<li>finney</li>
<li>ether</li>
<li>kether/grand/einstein</li>
<li>mether</li>
<li>gether</li>
<li>tether</li>
</ul>
</li>
<li>web3.toWei()：把以太坊单位(包含代币单位)转为 wei；</li>
<li>txpool.status：交易池中的状态；</li>
<li>admin.addPeer()：连接到其他节点；</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> web3.fromWei(<span class="string">&quot;425000000000000000000&quot;</span>, <span class="string">&quot;ether&quot;</span>)</span></span><br><span class="line">&quot;425&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> web3.toWei(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;ether&quot;</span>)</span></span><br><span class="line">&quot;1000000000000000000&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 转账：转账必须解锁账户，默认账户无需解锁</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> personal.unlockAccount(user1)</span></span><br><span class="line">Unlock account 0xf09dca9e10f3f1d0adfe9af7beeeb579c1d1dd37</span><br><span class="line">Passphrase: </span><br><span class="line">true</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> eth.accounts</span></span><br><span class="line">[&quot;0xd7ec36444d13cc079eb116b4f2602cffcdc9adee&quot;, &quot;0xf09dca9e10f3f1d0adfe9af7beeeb579c1e7456b3ded2fa250545de4de1&quot;]</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> eth.sendTransaction(&#123;from:<span class="string">&quot;0xd7ec36444d13cc079eb116b4f2602cffcdc9adee&quot;</span>,to:<span class="string">&quot;0xf09dcc1d1dd37&quot;</span>,value:web3.toWei(6,<span class="string">&quot;ether&quot;</span>)&#125;)</span></span><br><span class="line">&quot;0x68dc8f5db24371bbb3acca13ff15f3561cae4a6d8753f62beab1356380211949&quot;</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> eth.getBalance(user1)</span></span><br><span class="line">6000000000000000000</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> eth.getBalance(user0)</span></span><br><span class="line">1.15792089237316195423570985008687907853269984665640564039451584007913129639927e+77</span><br></pre></td></tr></table></figure>

<h1 id="Mist"><a href="#Mist" class="headerlink" title="Mist"></a>Mist</h1><p>Mist是以太坊官方的在线钱包管理工具，通过 Mist 可以很方便的连接上私有网络，从而更好的开发、调试、测试。可以在github上下载。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mist --rpc url</span><br></pre></td></tr></table></figure>

<h1 id="Truffle"><a href="#Truffle" class="headerlink" title="Truffle"></a>Truffle</h1><h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><ul>
<li>使用 truffle unbox <box-name> 下载任意 truffle boxes。</li>
<li>使用 truffle init 初始化一个不包含智能合约的项目。</li>
</ul>
<p>目录结构：</p>
<ul>
<li>contracts/：合约目录</li>
<li>migrations/：脚本化部署文件</li>
<li>test/：测试智能合约和应用</li>
<li>truffle.js：配置文件</li>
</ul>
<h2 id="编译合约-1"><a href="#编译合约-1" class="headerlink" title="编译合约"></a>编译合约</h2><h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">truffle compile</span><br></pre></td></tr></table></figure>

<p>Truffle仅默认编译自上次编译后被修改过的文件，来减少不必要的编译。如果你想编译全部文件，可以使用–compile-all选项。</p>
<h3 id="约定"><a href="#约定" class="headerlink" title="约定"></a>约定</h3><p>Truffle需要定义的合约名称和文件名准确匹配。举例来说，如果文件名为MyContract.sol，那么合约文件须为如下两者之一：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">contract MyContract &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// or</span></span><br><span class="line">library MyContract &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种匹配是区分大小写的，也就是说大小写也要一致，推荐大写每一个开头字母。</p>
<h2 id="移植"><a href="#移植" class="headerlink" title="移植"></a>移植</h2><h3 id="命令-1"><a href="#命令-1" class="headerlink" title="命令"></a>命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">truffle migrate</span><br></pre></td></tr></table></figure>

<p>这个命令会执行所有的位于migrations目录内的移植脚本。如果你之前的移植是成功执行的。truffle migrate仅会执行新创建的移植。如果没有新的移植脚本，这个命令不同执行任何操作。可以使用选项–reset来从头执行移植脚本。</p>
<h3 id="移植脚本文件"><a href="#移植脚本文件" class="headerlink" title="移植脚本文件"></a>移植脚本文件</h3><p>一个样例文件如下：4_example_migration.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">deployer</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// deployment steps</span></span><br><span class="line">  deployer.deploy(MyContract);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>移植js里的exports的函数接受一个deployer对象作为第一个参数。这个对象用于发布过程，提供了一个清晰的语法支持，同时提供一些通过的合约部署职责，比如保存发布的文件以备稍后使用。deployer对象是用来缓存(stage)发布任务的主要操作接口。</p>
<h3 id="初始移植"><a href="#初始移植" class="headerlink" title="初始移植"></a>初始移植</h3><p>Truffle需要一个移植合约来使用移植特性。这个合约内需要指定的接口，但你可以按你的意味修改合约。对大多数工程来说，这个合约会在第一次移植时进行的第一次部署，后续都不会再更新。通过truffle init创建一个全新工程时，你会获得一个默认的合约。</p>
<p>文件名:contracts/Migration.sol:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">contract Migrations &#123;</span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// A function with the signature `last_completed_migration()`, returning a uint, is required.</span></span><br><span class="line">  uint public last_completed_migration;</span><br><span class="line"></span><br><span class="line">  modifier restricted() &#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.sender == owner) _</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Migrations</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// A function with the signature `setCompleted(uint)` is required.</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setCompleted</span>(<span class="params">uint completed</span>) <span class="title">restricted</span> </span>&#123;</span><br><span class="line">    last_completed_migration = completed;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">upgrade</span>(<span class="params">address new_address</span>) <span class="title">restricted</span> </span>&#123;</span><br><span class="line">    Migrations upgraded = Migrations(new_address);</span><br><span class="line">    upgraded.setCompleted(last_completed_migration);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果你想使用移植特性，你必须在你第一次部署合约时，部署这个合约。可以使用如下方式来创建一次移植。</p>
<p>文件名：migrations/1_initial_migrations.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">deployer</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Deploy the Migrations contract as our only task</span></span><br><span class="line">  deployer.deploy(Migrations);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>由此，你可以接着创建递增的数字前缀来部署其它合约。</p>
<h3 id="部署器-deployer"><a href="#部署器-deployer" class="headerlink" title="部署器(deployer)"></a>部署器(deployer)</h3><p>你的移植文件会使用部署器来缓存部署任务。所以，你可以按一定顺序排列发布任务，他们会按正确顺序执行。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Stage deploying A before B</span></span><br><span class="line">deployer.deploy(A);</span><br><span class="line">deployer.deploy(B);</span><br></pre></td></tr></table></figure>

<p>另一选中可选的部署方式是使用Promise。将部署任务做成一个队列，是否部署依赖于前一个合约的执行情况。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Deploy A, then deploy B, passing in A&#x27;s newly deployed address</span></span><br><span class="line">deployer.deploy(A).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> deployer.deploy(B, A.address);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>如果你想更清晰，你也可以选择实现一个Promise链。</p>
<h3 id="网络相关"><a href="#网络相关" class="headerlink" title="网络相关"></a>网络相关</h3><p>要实现不同条件的不同部署步骤，移植代码中需要第二个参数network。示例如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">deployer, network</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Add demo data if we&#x27;re not deploying to the live network.</span></span><br><span class="line">  <span class="keyword">if</span> (network != <span class="string">&quot;live&quot;</span>) &#123;</span><br><span class="line">    deployer.exec(<span class="string">&quot;add_demo_data.js&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="移植到truffle开发环境"><a href="#移植到truffle开发环境" class="headerlink" title="移植到truffle开发环境"></a>移植到truffle开发环境</h3><p>truffle有内置的私有连用于测试，这是电脑上的本地网络。使用如下命令创建私有连并与其交互：<code>truffle develop</code>。在 truffle 交互控制台中，可以省略 truffle 前缀，例如可以直接使用 compile 。 </p>
<h3 id="移植到-Ganache"><a href="#移植到-Ganache" class="headerlink" title="移植到 Ganache"></a>移植到 Ganache</h3><p>在truffle配置文件中配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  networks: &#123;</span><br><span class="line">    development: &#123;</span><br><span class="line">      host: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">      port: <span class="number">7545</span>,</span><br><span class="line">      network_id: <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">truffle migrate</span><br></pre></td></tr></table></figure>

<h1 id="ICO-示例"><a href="#ICO-示例" class="headerlink" title="ICO 示例"></a>ICO 示例</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity <span class="number">0.4</span><span class="number">.20</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一个简单的代币合约。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> contract token &#123;</span><br><span class="line"></span><br><span class="line">     string public standard = <span class="string">&#x27;yuyangray&#x27;</span>;</span><br><span class="line">     string public name; <span class="comment">//代币名称</span></span><br><span class="line">     string public symbol; <span class="comment">//代币符号比如&#x27;$&#x27;</span></span><br><span class="line">    <span class="comment">//代币单位，展示的小数点后面多少个0,和以太币一样后面是是18个0</span></span><br><span class="line">     uint8 public decimals = <span class="number">2</span>;  </span><br><span class="line"></span><br><span class="line">     uint256 public totalSupply; <span class="comment">//代币总量</span></span><br><span class="line">    <span class="comment">/* 这里每个地址对应的是代币的数量，而不是捐赠的以太币的数量 */</span></span><br><span class="line">     mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint256) public balanceOf;</span><br><span class="line"></span><br><span class="line">     event Transfer(address indexed <span class="keyword">from</span>, address indexed to, uint256 value);  <span class="comment">//转帐通知事件</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="comment">/* 初始化合约，并且把初始的所有代币都给这合约的创建者</span></span><br><span class="line"><span class="comment">      * @param _owned 合约的管理者</span></span><br><span class="line"><span class="comment">      * @param tokenName 代币名称</span></span><br><span class="line"><span class="comment">      * @param tokenSymbol 代币符号</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     <span class="function"><span class="keyword">function</span> <span class="title">token</span>(<span class="params">address _owned, string tokenName, string tokenSymbol</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">         <span class="comment">//合约的管理者获得的代币总量</span></span><br><span class="line">         balanceOf[_owned] = totalSupply;</span><br><span class="line"></span><br><span class="line">         name = tokenName;</span><br><span class="line">         symbol = tokenSymbol;</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 转帐，具体可以根据自己的需求来实现</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param  </span>_to address 接受代币的地址</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param  </span>_value uint256 接受代币的数量</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint256 _value</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">       <span class="comment">//从发送者减掉发送额</span></span><br><span class="line">       balanceOf[msg.sender] -= _value;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//给接收者加上相同的量</span></span><br><span class="line">       balanceOf[_to] += _value;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//通知任何监听该交易的客户端</span></span><br><span class="line">       Transfer(msg.sender, _to, _value);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 增加代币，并将代币发送给捐赠新用户</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param  </span>_to address 接受代币的地址</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param  </span>_amount uint256 接受代币的数量</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     <span class="function"><span class="keyword">function</span> <span class="title">issue</span>(<span class="params">address _to, uint256 _amount</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">         totalSupply = totalSupply + _amount;</span><br><span class="line">         balanceOf[_to] += _amount;</span><br><span class="line"></span><br><span class="line">         <span class="comment">//通知任何监听该交易的客户端</span></span><br><span class="line">         Transfer(<span class="built_in">this</span>, _to, _amount);</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 众筹合约</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract Crowdsale is token &#123;</span><br><span class="line">    address public beneficiary = msg.sender; <span class="comment">//受益人地址，测试时为合约创建者</span></span><br><span class="line">    uint public fundingGoal;  <span class="comment">//众筹目标，单位是ether</span></span><br><span class="line">    uint public amountRaised; <span class="comment">//已筹集金额数量， 单位是ether</span></span><br><span class="line">    uint public deadline; <span class="comment">//截止时间</span></span><br><span class="line">    uint public price;  <span class="comment">//代币价格</span></span><br><span class="line">    bool public fundingGoalReached = <span class="literal">false</span>;  <span class="comment">//达成众筹目标</span></span><br><span class="line">    bool public crowdsaleClosed = <span class="literal">false</span>; <span class="comment">//众筹关闭</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint256) public balance; <span class="comment">//保存众筹地址及对应的以太币数量</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 受益人将众筹金额转走的通知</span></span><br><span class="line">    event GoalReached(address _beneficiary, uint _amountRaised);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用来记录众筹资金变动的通知，_isContribution表示是否是捐赠，因为有可能是捐赠者退出或发起者转移众筹资金</span></span><br><span class="line">    event FundTransfer(address _backer, uint _amount, bool _isContribution);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化构造函数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>fundingGoalInEthers 众筹以太币总量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>durationInMinutes 众筹截止,单位是分钟</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>tokenName 代币名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>tokenSymbol 代币符号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Crowdsale</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        uint fundingGoalInEthers,</span></span></span><br><span class="line"><span class="function"><span class="params">        uint durationInMinutes,</span></span></span><br><span class="line"><span class="function"><span class="params">        string tokenName,</span></span></span><br><span class="line"><span class="function"><span class="params">        string tokenSymbol</span></span></span><br><span class="line"><span class="function"><span class="params">    </span>) <span class="title">token</span>(<span class="params">this, tokenName, tokenSymbol</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        fundingGoal = fundingGoalInEthers * <span class="number">1</span> ether;</span><br><span class="line">        deadline = now + durationInMinutes * <span class="number">1</span> minutes;</span><br><span class="line">        price = <span class="number">500</span> finney; <span class="comment">//1个以太币可以买 2 个代币</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认函数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 默认函数，可以向合约直接打款</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="title">payable</span> <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断是否关闭众筹</span></span><br><span class="line">        <span class="built_in">require</span>(!crowdsaleClosed);</span><br><span class="line">        uint amount = msg.value;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//捐款人的金额累加</span></span><br><span class="line">        balance[msg.sender] += amount;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//捐款总额累加</span></span><br><span class="line">        amountRaised += amount;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//转帐操作，转多少代币给捐款人</span></span><br><span class="line">        issue(msg.sender, amount / price * <span class="number">10</span> ** uint256(decimals));</span><br><span class="line">        FundTransfer(msg.sender, amount, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断是否已经过了众筹截止限期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    modifier afterDeadline() &#123; <span class="keyword">if</span> (now &gt;= deadline) _; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检测众筹目标是否已经达到</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">checkGoalReached</span>(<span class="params"></span>) <span class="title">afterDeadline</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (amountRaised &gt;= fundingGoal)&#123;</span><br><span class="line">            <span class="comment">//达成众筹目标</span></span><br><span class="line">            fundingGoalReached = <span class="literal">true</span>;</span><br><span class="line">            GoalReached(beneficiary, amountRaised);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//关闭众筹</span></span><br><span class="line">        crowdsaleClosed = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 收回资金</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 检查是否达到了目标或时间限制，如果有，并且达到了资金目标，</span></span><br><span class="line"><span class="comment">     * 将全部金额发送给受益人。如果没有达到目标，每个贡献者都可以退出</span></span><br><span class="line"><span class="comment">     * 他们贡献的金额</span></span><br><span class="line"><span class="comment">     * 注：这里代码应该是限制了众筹时间结束且众筹目标没有达成的情况下才允许退出。如果去掉限制条件afterDeadline，应该是可以允许众筹时间还未到且众筹目标没有达成的情况下退出</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">safeWithdrawal</span>(<span class="params"></span>) <span class="title">afterDeadline</span> <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果没有达成众筹目标</span></span><br><span class="line">        <span class="keyword">if</span> (!fundingGoalReached) &#123;</span><br><span class="line">            <span class="comment">//获取合约调用者已捐款余额</span></span><br><span class="line">            uint amount = balance[msg.sender];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (amount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//返回合约发起者所有余额</span></span><br><span class="line">                msg.sender.transfer(amount);</span><br><span class="line">                FundTransfer(msg.sender, amount, <span class="literal">false</span>);</span><br><span class="line">                balance[msg.sender] = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果达成众筹目标，并且合约调用者是受益人</span></span><br><span class="line">        <span class="keyword">if</span> (fundingGoalReached &amp;&amp; beneficiary == msg.sender) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//将所有捐款从合约中给受益人</span></span><br><span class="line">            beneficiary.transfer(amountRaised);</span><br><span class="line"></span><br><span class="line">            FundTransfer(beneficiary, amount, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="代币示例"><a href="#代币示例" class="headerlink" title="代币示例"></a>代币示例</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity <span class="number">0.4</span><span class="number">.20</span>;</span><br><span class="line"></span><br><span class="line">interface tokenRecipient &#123; <span class="function"><span class="keyword">function</span> <span class="title">receiveApproval</span>(<span class="params">address _from, uint256 _value, address _token, bytes _extraData</span>) <span class="title">external</span>; &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">/**</span></span><br><span class="line"><span class="function"> * <span class="title">owned</span> 是一个管理者</span></span><br><span class="line"><span class="function"> */</span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">owned</span> </span>&#123;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初台化构造函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">owned</span> (<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断当前合约调用者是否是管理员</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    modifier onlyOwner &#123;</span><br><span class="line">        <span class="built_in">require</span> (msg.sender == owner);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指派一个新的管理员</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>newOwner address 新的管理员帐户地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">transferOwnership</span>(<span class="params">address newOwner</span>) <span class="title">onlyOwner</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (newOwner != address(<span class="number">0</span>)) &#123;</span><br><span class="line">        owner = newOwner;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title </span>基础版的代币合约</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract token &#123;</span><br><span class="line">    <span class="comment">/* 公共变量 */</span></span><br><span class="line">    string public standard = <span class="string">&#x27;https://mshk.top&#x27;</span>;</span><br><span class="line">    string public name; <span class="comment">//代币名称</span></span><br><span class="line">    string public symbol; <span class="comment">//代币符号比如&#x27;$&#x27;</span></span><br><span class="line">    uint8 public decimals = <span class="number">18</span>;  <span class="comment">//代币单位，展示的小数点后面多少个0,和以太币一样后面是是18个0</span></span><br><span class="line">    uint256 public totalSupply; <span class="comment">//代币总量</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*记录所有余额的映射*/</span></span><br><span class="line">    mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint256) public balanceOf;</span><br><span class="line">    mapping (<span class="function"><span class="params">address</span> =&gt;</span> mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint256)) public allowance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 在区块链上创建一个事件，用以通知客户端*/</span></span><br><span class="line">    event Transfer(address indexed <span class="keyword">from</span>, address indexed to, uint256 value);  <span class="comment">//转帐通知事件</span></span><br><span class="line">    event Burn(address indexed <span class="keyword">from</span>, uint256 value);  <span class="comment">//减去用户余额事件</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 初始化合约，并且把初始的所有代币都给这合约的创建者</span></span><br><span class="line"><span class="comment">     * @param initialSupply 代币的总数</span></span><br><span class="line"><span class="comment">     * @param tokenName 代币名称</span></span><br><span class="line"><span class="comment">     * @param tokenSymbol 代币符号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">token</span>(<span class="params">uint256 initialSupply, string tokenName, string tokenSymbol</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化总量</span></span><br><span class="line">        totalSupply = initialSupply * <span class="number">10</span> ** uint256(decimals);    <span class="comment">//以太币是10^18，后面18个0，所以默认decimals是18</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//给指定帐户初始化代币总量，初始化用于奖励合约创建者</span></span><br><span class="line">        <span class="comment">//balanceOf[msg.sender] = totalSupply;</span></span><br><span class="line">        balanceOf[<span class="built_in">this</span>] = totalSupply;</span><br><span class="line"></span><br><span class="line">        name = tokenName;</span><br><span class="line">        symbol = tokenSymbol;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 私有方法从一个帐户发送给另一个帐户代币</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>_from address 发送代币的地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>_to address 接受代币的地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>_value uint256 接受代币的数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">_transfer</span>(<span class="params">address _from, address _to, uint256 _value</span>) <span class="title">internal</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//避免转帐的地址是0x0</span></span><br><span class="line">      <span class="built_in">require</span>(_to != <span class="number">0x0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//检查发送者是否拥有足够余额</span></span><br><span class="line">      <span class="built_in">require</span>(balanceOf[_from] &gt;= _value);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//检查是否溢出</span></span><br><span class="line">      <span class="built_in">require</span>(balanceOf[_to] + _value &gt; balanceOf[_to]);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//保存数据用于后面的判断</span></span><br><span class="line">      uint previousBalances = balanceOf[_from] + balanceOf[_to];</span><br><span class="line"></span><br><span class="line">      <span class="comment">//从发送者减掉发送额</span></span><br><span class="line">      balanceOf[_from] -= _value;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//给接收者加上相同的量</span></span><br><span class="line">      balanceOf[_to] += _value;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//通知任何监听该交易的客户端</span></span><br><span class="line">      Transfer(_from, _to, _value);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//判断买、卖双方的数据是否和转换前一致</span></span><br><span class="line">      assert(balanceOf[_from] + balanceOf[_to] == previousBalances);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从主帐户合约调用者发送给别人代币</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>_to address 接受代币的地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>_value uint256 接受代币的数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint256 _value</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        _transfer(msg.sender, _to, _value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从某个指定的帐户中，向另一个帐户发送代币</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 调用过程，会检查设置的允许最大交易额</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>_from address 发送者地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>_to address 接受者地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>_value uint256 要转移的代币数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return </span>success        是否交易成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">transferFrom</span>(<span class="params">address _from, address _to, uint256 _value</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool success</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//检查发送者是否拥有足够余额</span></span><br><span class="line">        <span class="built_in">require</span>(_value &lt;= allowance[_from][msg.sender]);   <span class="comment">// Check allowance</span></span><br><span class="line"></span><br><span class="line">        allowance[_from][msg.sender] -= _value;</span><br><span class="line"></span><br><span class="line">        _transfer(_from, _to, _value);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置帐户允许支付的最大金额</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 一般在智能合约的时候，避免支付过多，造成风险</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>_spender 帐户地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>_value 金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">approve</span>(<span class="params">address _spender, uint256 _value</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool success</span>) </span>&#123;</span><br><span class="line">        allowance[msg.sender][_spender] = _value;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置帐户允许支付的最大金额</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 一般在智能合约的时候，避免支付过多，造成风险，加入时间参数，可以在 tokenRecipient 中做其他操作</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>_spender 帐户地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>_value 金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>_extraData 操作的时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">approveAndCall</span>(<span class="params">address _spender, uint256 _value, bytes _extraData</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool success</span>) </span>&#123;</span><br><span class="line">        tokenRecipient spender = tokenRecipient(_spender);</span><br><span class="line">        <span class="keyword">if</span> (approve(_spender, _value)) &#123;</span><br><span class="line">            spender.receiveApproval(msg.sender, _value, <span class="built_in">this</span>, _extraData);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 减少代币调用者的余额</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 操作以后是不可逆的</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>_value 要删除的数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">burn</span>(<span class="params">uint256 _value</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool success</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//检查帐户余额是否大于要减去的值</span></span><br><span class="line">        <span class="built_in">require</span>(balanceOf[msg.sender] &gt;= _value);   <span class="comment">// Check if the sender has enough</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//给指定帐户减去余额</span></span><br><span class="line">        balanceOf[msg.sender] -= _value;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//代币问题做相应扣除</span></span><br><span class="line">        totalSupply -= _value;</span><br><span class="line"></span><br><span class="line">        Burn(msg.sender, _value);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除帐户的余额（含其他帐户）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 删除以后是不可逆的</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>_from 要操作的帐户地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>_value 要减去的数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">burnFrom</span>(<span class="params">address _from, uint256 _value</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool success</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//检查帐户余额是否大于要减去的值</span></span><br><span class="line">        <span class="built_in">require</span>(balanceOf[_from] &gt;= _value);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//检查 其他帐户 的余额是否够使用</span></span><br><span class="line">        <span class="built_in">require</span>(_value &lt;= allowance[_from][msg.sender]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//减掉代币</span></span><br><span class="line">        balanceOf[_from] -= _value;</span><br><span class="line">        allowance[_from][msg.sender] -= _value;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//更新总量</span></span><br><span class="line">        totalSupply -= _value;</span><br><span class="line">        Burn(_from, _value);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 匿名方法，预防有人向这合约发送以太币</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/*function() &#123;</span></span><br><span class="line"><span class="comment">        //return;     // Prevents accidental sending of ether</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title </span>高级版代币</span></span><br><span class="line"><span class="comment"> * 增加冻结用户、挖矿、根据指定汇率购买(售出)代币价格的功能</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract MyAdvancedToken is owned, token &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//卖出的汇率,一个代币，可以卖出多少个以太币，单位是wei</span></span><br><span class="line">    uint256 public sellPrice;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//买入的汇率,1个以太币，可以买几个代币</span></span><br><span class="line">    uint256 public buyPrice;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//是否冻结帐户的列表</span></span><br><span class="line">    mapping (<span class="function"><span class="params">address</span> =&gt;</span> bool) public frozenAccount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义一个事件，当有资产被冻结的时候，通知正在监听事件的客户端</span></span><br><span class="line">    event FrozenFunds(address target, bool frozen);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*初始化合约，并且把初始的所有的令牌都给这合约的创建者</span></span><br><span class="line"><span class="comment">     * @param initialSupply 所有币的总数</span></span><br><span class="line"><span class="comment">     * @param tokenName 代币名称</span></span><br><span class="line"><span class="comment">     * @param tokenSymbol 代币符号</span></span><br><span class="line"><span class="comment">     * @param centralMinter 是否指定其他帐户为合约所有者,为0是去中心化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">MyAdvancedToken</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">      uint256 initialSupply,</span></span></span><br><span class="line"><span class="function"><span class="params">      string tokenName,</span></span></span><br><span class="line"><span class="function"><span class="params">      string tokenSymbol,</span></span></span><br><span class="line"><span class="function"><span class="params">      address centralMinter</span></span></span><br><span class="line"><span class="function"><span class="params">    </span>) <span class="title">token</span> (<span class="params">initialSupply, tokenName, tokenSymbol</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置合约的管理者</span></span><br><span class="line">        <span class="keyword">if</span>(centralMinter != <span class="number">0</span> ) owner = centralMinter;</span><br><span class="line"></span><br><span class="line">        sellPrice = <span class="number">2</span>;     <span class="comment">//设置1个单位的代币(单位是wei)，能够卖出2个以太币</span></span><br><span class="line">        buyPrice = <span class="number">4</span>;      <span class="comment">//设置1个以太币，可以买0.25个代币</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 私有方法，从指定帐户转出余额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>_from address 发送代币的地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>_to address 接受代币的地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>_value uint256 接受代币的数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">_transfer</span>(<span class="params">address _from, address _to, uint _value</span>) <span class="title">internal</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//避免转帐的地址是0x0</span></span><br><span class="line">        <span class="built_in">require</span> (_to != <span class="number">0x0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//检查发送者是否拥有足够余额</span></span><br><span class="line">        <span class="built_in">require</span> (balanceOf[_from] &gt; _value);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//检查是否溢出</span></span><br><span class="line">        <span class="built_in">require</span> (balanceOf[_to] + _value &gt; balanceOf[_to]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//检查 冻结帐户</span></span><br><span class="line">        <span class="built_in">require</span>(!frozenAccount[_from]);</span><br><span class="line">        <span class="built_in">require</span>(!frozenAccount[_to]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//从发送者减掉发送额</span></span><br><span class="line">        balanceOf[_from] -= _value;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//给接收者加上相同的量</span></span><br><span class="line">        balanceOf[_to] += _value;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通知任何监听该交易的客户端</span></span><br><span class="line">        Transfer(_from, _to, _value);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 合约拥有者，可以为指定帐户创造一些代币</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>target address 帐户地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>mintedAmount uint256 增加的金额(单位是wei)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">mintToken</span>(<span class="params">address target, uint256 mintedAmount</span>) <span class="title">onlyOwner</span> <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//给指定地址增加代币，同时总量也相加</span></span><br><span class="line">        balanceOf[target] += mintedAmount;</span><br><span class="line">        totalSupply += mintedAmount;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Transfer(<span class="number">0</span>, <span class="built_in">this</span>, mintedAmount);</span><br><span class="line">        Transfer(<span class="built_in">this</span>, target, mintedAmount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 增加冻结帐户名称</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 你可能需要监管功能以便你能控制谁可以/谁不可以使用你创建的代币合约</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>target address 帐户地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>freeze bool    是否冻结</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">freezeAccount</span>(<span class="params">address target, bool freeze</span>) <span class="title">onlyOwner</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">        frozenAccount[target] = freeze;</span><br><span class="line">        FrozenFunds(target, freeze);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置买卖价格</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 如果你想让ether(或其他代币)为你的代币进行背书,以便可以市场价自动化买卖代币,我们可以这么做。如果要使用浮动的价格，也可以在这里设置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>newSellPrice 新的卖出价格</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>newBuyPrice 新的买入价格</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setPrices</span>(<span class="params">uint256 newSellPrice, uint256 newBuyPrice</span>) <span class="title">onlyOwner</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">        sellPrice = newSellPrice;</span><br><span class="line">        buyPrice = newBuyPrice;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用以太币购买代币</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">buy</span>(<span class="params"></span>) <span class="title">payable</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">      uint amount = msg.value / buyPrice;</span><br><span class="line"></span><br><span class="line">      _transfer(<span class="built_in">this</span>, msg.sender, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@dev </span>卖出代币</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return </span>要卖出的数量(单位是wei)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">sell</span>(<span class="params">uint256 amount</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//检查合约的余额是否充足</span></span><br><span class="line">        <span class="built_in">require</span>(<span class="built_in">this</span>.balance &gt;= amount * sellPrice);</span><br><span class="line"></span><br><span class="line">        _transfer(msg.sender, <span class="built_in">this</span>, amount);</span><br><span class="line"></span><br><span class="line">        msg.sender.transfer(amount * sellPrice);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Truffle-OpenZeppelin-ERC20代币实现"><a href="#Truffle-OpenZeppelin-ERC20代币实现" class="headerlink" title="Truffle+OpenZeppelin ERC20代币实现"></a>Truffle+OpenZeppelin ERC20代币实现</h1><p>1、新建项目</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">truffle unbox react-box</span><br></pre></td></tr></table></figure>

<p>2、安装zeppelin-solidity</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install zeppelin-solidity</span><br></pre></td></tr></table></figure>

<p>3、创建标准的代币合约</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.4</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;zeppelin-solidity/contracts/token/ERC20/StandardToken.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">contract BloggerCoin is StandardToken &#123;</span><br><span class="line">  string public name = <span class="string">&quot;BloggerCoin&quot;</span>;</span><br><span class="line">  string public symbol = <span class="string">&quot;BLC&quot;</span>;</span><br><span class="line">  uint8 public decimals = <span class="number">2</span>;</span><br><span class="line">  uint256 public INITIAL_SUPPLY = <span class="number">666666</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">BloggerCoin</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    totalSupply_ = INITIAL_SUPPLY;</span><br><span class="line">    balances[msg.sender] = INITIAL_SUPPLY;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>INITIAL_SUPPLY变量定义了在合约部署时，代币将创建的数量。</code></pre>
<p>4、编译和部署</p>
<p>  在migrations/目录下建立一个3_deploy_bloggercoin.js文件，内容如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> BloggerCoin = artifacts.require(<span class="string">&quot;./BloggerCoin.sol&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">deployer</span>) </span>&#123;</span><br><span class="line">  deployer.deploy(BloggerCoin);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>编译部署：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">truffle compile</span><br><span class="line">truffle migrate 部署</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ljd1996.github.io/2018/12/20/Solidity%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/20/Solidity%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Solidity学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-20 20:23:17" itemprop="dateCreated datePublished" datetime="2018-12-20T20:23:17+08:00">2018-12-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/" itemprop="url" rel="index"><span itemprop="name">区块链</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/" itemprop="url" rel="index"><span itemprop="name">智能合约</span></a>
                </span>
            </span>

          
            <span id="/2018/12/20/Solidity%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="Solidity学习笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2018/12/20/Solidity%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018/12/20/Solidity%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="入门说明"><a href="#入门说明" class="headerlink" title="入门说明"></a>入门说明</h1><p>在把智能协议传上以太坊之后，它就变得不可更改, 这种永固性意味着你的代码永远不能被调整或更新。你编译的程序会一直，永久的，不可更改的，存在以太坊上。</p>
<p>非常重要的是，部署在以太坊上的 DApp，并不能保证它真正做到去中心，我们需要阅读并理解它的源代码，才能防止其中没有被部署者恶意植入后门；作为开发人员，如何做到既要给自己留下修复 bug 的余地，又要尽量地放权给使用者，以便让他们放心你，从而愿意把数据放在你的 DApp 中，这确实需要个微妙的平衡。</p>
<h2 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>；</span><br></pre></td></tr></table></figure>

<ol>
<li>版本要高于0.4才可以编译</li>
<li>表示高于0.5的版本则不可编译，第三位的版本号但可以变，留出来用做bug可以修复（如0.4.1的编译器有bug，可在0.4.2修复，现有合约不用改代码）。</li>
</ol>
<h2 id="引用源文件"><a href="#引用源文件" class="headerlink" title="引用源文件"></a>引用源文件</h2><p>全局引入：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> “filename”;</span><br></pre></td></tr></table></figure>

<p>自定义命名空间引入：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> symbolName <span class="keyword">from</span> “filename”</span><br></pre></td></tr></table></figure>

<p>分别定义引入：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  &#123;symbol1 <span class="keyword">as</span> alias, symbol2&#125; <span class="keyword">from</span> “filename”</span><br></pre></td></tr></table></figure>

<p>非es6兼容的简写语法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> “filename” <span class="keyword">as</span> symbolName</span><br><span class="line"><span class="comment">// 等同于上述</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> symbolName <span class="keyword">from</span> “filename”</span><br></pre></td></tr></table></figure>

<h1 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h1><p>值类型：</p>
<ul>
<li>布尔(Booleans)</li>
<li>整型(Integer)</li>
<li>地址(Address)</li>
<li>定长字节数组(fixed byte arrays)</li>
<li>有理数和整型(Rational and Integer Literals，String literals)</li>
<li>枚举类型(Enums)</li>
<li>函数(Function Types)</li>
</ul>
<p>引用类型</p>
<ul>
<li>不定长字节数组（bytes）</li>
<li>字符串（string）</li>
<li>数组（Array）</li>
<li>结构体（Struts）</li>
</ul>
<h2 id="数据位置"><a href="#数据位置" class="headerlink" title="数据位置"></a>数据位置</h2><p>复杂类型，如数组(arrays)和数据结构(struct)在Solidity中有一个额外的属性，数据的存储位置。可选为memory和storage。</p>
<p>memory存储位置同我们普通程序的内存一致。即分配，即使用，越过作用域即不可被访问，等待被回收。而在区块链上，由于底层实现了图灵完备，故而会有非常多的状态需要永久记录下来，那么我们就要使用storage类型了，一旦使用这个类型，数据将永远存在。</p>
<p>基于程序的上下文，大多数时候这样的选择是默认的，我们可以通过指定关键字storage和memory修改它。默认的函数参数，包括返回的参数，他们是memory。默认的局部变量是storage的。默认的状态变量（合约声明的公有变量）是storage。</p>
<p>另外还有第三个存储位置calldata。它存储的是函数参数，是只读的，不会永久存储的一个数据位置。外部函数的参数（不包括返回参数）被强制指定为calldata。效果与memory差不多。</p>
<ul>
<li>storage转换为storage只是修改了它的指针。</li>
<li>将一个memory类型的变量赋值给一个状态变量时，实际是将内存变量拷贝到存储中。</li>
<li>memory赋值给局部变量:局部变量虽然是一个storage的，但它仅仅是一个storage类型的指针,所以直接赋值会报错,不能将memory赋值给局部变量.</li>
<li>将storage转为memory，实际是将数据从storage拷贝到memory中。</li>
<li>将一个memory的引用类型赋值给另一个memory的引用，不会创建拷贝（即：memory之间是引用传递）。</li>
<li>对于值类型，总是会进行拷贝。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract DataLocation&#123;</span><br><span class="line">  uint valueType;</span><br><span class="line">  mapping(<span class="function"><span class="params">uint</span> =&gt;</span> uint) public refrenceType;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">changeMemory</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> tmp = valueType;</span><br><span class="line">    tmp = <span class="number">100</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">changeStorage</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> tmp = refrenceType;</span><br><span class="line">    tmp[<span class="number">1</span>] = <span class="number">100</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getAll</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint, uint</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (valueType, refrenceType[<span class="number">1</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>强制的数据位置：</p>
<ul>
<li>外部函数(External function)的参数(不包括返回参数)强制为：calldata</li>
<li>状态变量(State variables)强制为: storage</li>
</ul>
<p>默认数据位置：</p>
<ul>
<li>函数参数(包括返回参数)：memory</li>
<li>所有其它的局部变量：storage</li>
</ul>
<h2 id="布尔"><a href="#布尔" class="headerlink" title="布尔"></a>布尔</h2><p>bool可能的取值为常量值true和false</p>
<h2 id="整型"><a href="#整型" class="headerlink" title="整型"></a>整型</h2><p>int/uint:</p>
<ul>
<li>变长的有符号或无符号整型。变量支持的步长以8递增，支持从uint8到uint256，以及int8到int256。uint和int默认代表的是uint256和int256</li>
</ul>
<p>字面量:</p>
<ul>
<li>整数字面量，由包含0-9的数字序列组成，默认被解释成十进制。在Solidity中不支持八进制，前导0会被默认忽略，如0100，会被认为是100。</li>
<li>小数由<code>.</code>组成，在他的左边或右边至少要包含一个数字。如1.，.1，1.3均是有效的小数。</li>
</ul>
<p>字面量本身支持任意精度，也就是可以不会运算溢出，或除法截断。但当它被转换成对应的非字面量类型，如整数或小数。或者将他们与非字面量进行运算，则不能保证精度了。总之就是，字面量怎么都计算都行，但一旦转为对应的变量后，再计算就不保证精度了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract IntegerLiteral&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">integerTest</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint, uint</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//超出运算字长了</span></span><br><span class="line">    <span class="keyword">var</span> i = (<span class="number">2</span>**<span class="number">800</span> + <span class="number">1</span>) - <span class="number">2</span>**<span class="number">800</span>;</span><br><span class="line">    <span class="keyword">var</span> j = <span class="number">1</span>/<span class="number">3</span>*<span class="number">3</span>;</span><br><span class="line">    <span class="comment">//小数运算</span></span><br><span class="line">    <span class="keyword">var</span> k = <span class="number">0.5</span>*<span class="number">8</span>;</span><br><span class="line">    <span class="keyword">return</span> (i, j);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>十六进制字面量，以关键字hex打头，后面紧跟用单或双引号包裹的字符串。如hex”001122ff”。在内部会被表示为二进制流。由于一个字节是8位，所以一个hex是由两个[0-9a-z]字符组成的，不是成双的字符串是会报错的。十六进制的字面量与字符串可以进行同样的类似操作：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract HexLiteralBytes&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">bytes4, bytes1, bytes1, bytes1, bytes1</span>)</span>&#123;</span><br><span class="line">      bytes4 a = hex<span class="string">&quot;001122FF&quot;</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> (a, a[<span class="number">0</span>], a[<span class="number">1</span>], a[<span class="number">2</span>], a[<span class="number">3</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="地址"><a href="#地址" class="headerlink" title="地址"></a>地址</h2><p>address：以太坊地址的长度，大小20个字节，160位，所以可以用一个uint160编码。地址是所有合约的基础，所有的合约都会继承地址对象(注意：从0.5.0开始，合约不再继承自地址类型，但仍然可以显式转换为地址)，也可以随时将一个地址串，得到对应的代码进行调用。当然地址代表一个普通帐户时，就没有这么多丰富的功能了。</p>
<p>地址类型的成员：</p>
<ul>
<li>属性：balance</li>
<li>函数：send()，call()，delegatecall()，callcode()。</li>
</ul>
<p>十六进制的字符串，凡是能通过地址合法性检查（address checksum test）2，就会被认为是地址，如0xdCad3a6d3569DF655070DEd06cb7A1b2Ccd1D3AF。需要注意的是39到41位长的没有通过地址合法性检查的，会提示一个警告，但会被视为普通的有理数字面量。</p>
<p>如果只是想得到当前合约的余额，可以这样写：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract addressTest&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getBalance</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="transfer"><a href="#transfer" class="headerlink" title="transfer()"></a>transfer()</h3><p>transfer()用来发送以太币（以wei为单位）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">address x = <span class="number">0x123</span>;</span><br><span class="line">address myAddress = <span class="built_in">this</span>;</span><br><span class="line"><span class="keyword">if</span> (x.balance &lt; <span class="number">10</span> &amp;&amp; myAddress.balance &gt;= <span class="number">10</span>) x.transfer(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<p>如果x是合约地址，合约的回退函数（fallback 函数）会随transfer调用一起执行（这个是EVM特性），如果因gas耗光或其他原因失败，转移交易会还原并且合约会抛异常停止。</p>
<h3 id="send"><a href="#send" class="headerlink" title="send()"></a>send()</h3><p>用来向某个地址发送货币(货币单位是wei)。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract PayTest &#123;</span><br><span class="line">    <span class="comment">//得到当前合约的余额</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getBalance</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.balance;<span class="comment">//0</span></span><br><span class="line">    &#125;  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//向当前合约存款</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">deposit</span>(<span class="params"></span>) <span class="title">payable</span> <span class="title">returns</span>(<span class="params">address addr, uint amount, bool success</span>)</span>&#123;</span><br><span class="line">        <span class="comment">//msg.sender 全局变量，调用合约的发起方</span></span><br><span class="line">        <span class="comment">//msg.value 全局变量，调用合约的发起方转发的货币量，以wei为单位。</span></span><br><span class="line">        <span class="comment">//send() 执行的结果</span></span><br><span class="line">        <span class="keyword">return</span> (msg.sender, msg.value, <span class="built_in">this</span>.send(msg.value));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个合约实现的是充值。this.send(msg.value)意指向合约自身发送msg.value量的以太币。msg.value是合约调用方附带的以太币。</p>
<p>send()方法执行时有一些风险:</p>
<ul>
<li>send与transfer对应，但更底层。如果执行失败，transfer不会因异常停止，而send会返回false。</li>
<li>调用递归深度不能超1024。</li>
<li>如果gas不够，执行会失败。</li>
<li>所以使用这个方法要检查成功与否。或为保险起见，货币操作时要使用一些最佳实践。如果执行失败，将会回撤所有交易，所以务必留意返回结果。</li>
</ul>
<p>为了同一些不支持ABI协议的进行直接交互（一般的web3.js，soldity都是支持的）。可以使用call()函数，用来向另一个合约发送原始数据。参数支持任何类型任意数量。每个参数会按规则(规则是按ABI)打包成32字节并一一拼接到一起。call()方法支持ABI协议定义的函数选择器。如果第一个参数恰好4个字节，在这种情况下，会被认为根据ABI协议定义的函数器指定的函数签名。所以如果你只是想发送消息体，需要避免第一个参数是4个字节。call方法返回一个bool值，以表明执行成功还是失败。正常结束返回true，异常终止返回false。我们无法解析返回结果，因为这样我们得事前知道返回的数据的编码和数据大小（这里的潜在假设是不知道对方使用的协议格式，所以也不会知道返回的结果如何解析，有点祼协议测试的感觉）。</p>
<p>同样也可以使用delegatecall()，它与call方法的区别在于，仅仅是代码会执行，而其它方面，如（存储，余额等）都是用的当前的合约的数据。delegatecall()方法的目的是用来执行另一个合约中的工具库。所以开发者需要保证两个合约中的存储变量能兼容，来保证delegatecall()能顺利执行。</p>
<p>上面的这三个方法call()，delegatecall()，callcode()都是底层的消息传递调用，最好仅在万不得已才进行使用，因为他们破坏了Solidity的类型安全。上述的函数都是底层的函数，使用时要异常小心。当调用一个未知的，可能是恶意的合约时，当你把控制权交给它，它可能回调回你的合约，所以要准备好在调用返回时，应对你的状态变量可能被恶意篡改的情况。</p>
<h2 id="定长字节数组"><a href="#定长字节数组" class="headerlink" title="定长字节数组"></a>定长字节数组</h2><p>bytes1， … ，bytes32，允许值以步长1递增。byte默认表示byte1。成员变量length。</p>
<h2 id="枚举类型-enum"><a href="#枚举类型-enum" class="headerlink" title="枚举类型(enum)"></a>枚举类型(enum)</h2><p>枚举类型是在Solidity中的一种用户自定义类型。他可以显示的与整数进行转换，但不能进行隐式转换。显示的转换会在运行时检查数值范围，如果不匹配，将会引起异常。枚举类型应至少有一名成员。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract test &#123;</span><br><span class="line">    enum ActionChoices &#123; GoLeft, GoRight, GoStraight, SitStill &#125;</span><br><span class="line">    ActionChoices choice;</span><br><span class="line">    ActionChoices constant defaultChoice = ActionChoices.GoStraight;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setGoStraight</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        choice = ActionChoices.GoStraight;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Since enum types are not part of the ABI, the signature of &quot;getChoice&quot;</span></span><br><span class="line">    <span class="comment">// will automatically be changed to &quot;getChoice() returns (uint8)&quot;</span></span><br><span class="line">    <span class="comment">// for all matters external to Solidity. The integer type used is just</span></span><br><span class="line">    <span class="comment">// large enough to hold all enum values, i.e. if you have more values,</span></span><br><span class="line">    <span class="comment">// `uint16` will be used and so on.</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getChoice</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">ActionChoices</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> choice;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getDefaultChoice</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> uint(defaultChoice);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>函数的分类:</p>
<ul>
<li>内部函数(internal):因为不能在当前合约的上下文环境以外的地方执行，内部函数只能在当前合约内被使用。如在当前的代码块内，包括内部库函数，和继承的函数中。</li>
<li>外部函数（External）:外部函数由地址和函数方法签名两部分组成。可作为外部函数调用的参数，或者由外部函数调用返回。</li>
</ul>
<p>函数的定义:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> (<span class="params">&lt;parameter types&gt;</span>) </span>&#123;internal(默认)|external&#125; [constant] [payable] [returns (<span class="xml"><span class="tag">&lt;<span class="name">return</span> <span class="attr">types</span>&gt;</span>)]</span></span><br></pre></td></tr></table></figure>

<p>若不写类型，默认的函数类型是internal的。如果函数没有返回结果，则必须省略returns关键字。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Test&#123;</span><br><span class="line">    <span class="comment">//默认是internal类型的</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">noParameter</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint</span>)</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//无返回结果</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">noReturn1</span>(<span class="params">uint x</span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果无返回结果，必须省略`returns`关键字</span></span><br><span class="line">    <span class="comment">//function noReturn2(uint x) returns &#123;&#125; </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数的internal与external：调用一个函数f()时，我们可以直接调用f()，或者使用this.f()。但两者有一个区别。前者是通过internal的方式在调用，而后者是通过external的方式在调用。请注意，这里关于this的使用与大多数语言相背。下面通过一个例子来了解他们的不同：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.5</span>;</span><br><span class="line"></span><br><span class="line">contract FuntionTest&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">internalFunc</span>(<span class="params"></span>) <span class="title">internal</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">externalFunc</span>(<span class="params"></span>) <span class="title">external</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">callFunc</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">//直接使用内部的方式调用</span></span><br><span class="line">        internalFunc();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//不能在内部调用一个外部函数，会报编译错误。</span></span><br><span class="line">        <span class="comment">//Error: Undeclared identifier.</span></span><br><span class="line">        <span class="comment">//externalFunc();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//不能通过`external`的方式调用一个`internal`</span></span><br><span class="line">        <span class="comment">//Member &quot;internalFunc&quot; not found or not visible after argument-dependent lookup in contract FuntionTest</span></span><br><span class="line">        <span class="comment">//this.internalFunc();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用`this`以`external`的方式调用一个外部函数</span></span><br><span class="line">        <span class="built_in">this</span>.externalFunc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract FunctionTest1&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">externalCall</span>(<span class="params">FuntionTest ft</span>)</span>&#123;</span><br><span class="line">        <span class="comment">//调用另一个合约的外部函数</span></span><br><span class="line">        ft.externalFunc();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//不能调用另一个合约的内部函数</span></span><br><span class="line">        <span class="comment">//Error: Member &quot;internalFunc&quot; not found or not visible after argument-dependent lookup in contract FuntionTest</span></span><br><span class="line">        <span class="comment">//ft.internalFunc();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="不定长字节数组"><a href="#不定长字节数组" class="headerlink" title="不定长字节数组"></a>不定长字节数组</h2><ul>
<li>bytes：动态长度的字节数组。</li>
</ul>
<h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h2><p>字符串(string)字面量是指由单引号，或双引号引起来的字符串。字符串并不像C语言，包含结束符，“foo”这个字符串大小仅为三个字节。字符串的长度类型可以是变长的，特殊之处在于，可以隐式的转换为byte1,…byte32。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract StringConvert&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">bytes3</span>)</span>&#123;</span><br><span class="line">      bytes3 a = <span class="string">&quot;123&quot;</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//bytes3 b = &quot;1234&quot;;</span></span><br><span class="line">      <span class="comment">//Error: Type literal_string &quot;1234&quot; is not implicitly convertible to expected type bytes3.</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> a;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 上述的字符串字面量，会隐式转换为bytes3。</span></span><br></pre></td></tr></table></figure>

<h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><h3 id="创建一个数组"><a href="#创建一个数组" class="headerlink" title="创建一个数组"></a>创建一个数组</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Test &#123;</span><br><span class="line">    uint[<span class="number">5</span>] arr = [<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>];<span class="comment">//创建一个定长的数组</span></span><br><span class="line">    uint[] storageArr;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        uint[<span class="number">5</span>] memory arr1 = [uint(<span class="number">0</span>),<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>];<span class="comment">//uint8显示的转换为uint256，否则会报类型错误。</span></span><br><span class="line">        uint[] memory memoryArr;</span><br><span class="line">        <span class="comment">//storageArr[0] = 12;</span></span><br><span class="line">        <span class="comment">//memoryArr[0] = 13; //执行会报VM error: invalid opcode.，原因是数组还没有执行初始化。</span></span><br><span class="line"></span><br><span class="line">        storageArr = <span class="keyword">new</span> uint[](<span class="number">5</span>);</span><br><span class="line">        memoryArr = <span class="keyword">new</span> uint[](<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        storageArr[<span class="number">0</span>] = <span class="number">12</span>;</span><br><span class="line">        memoryArr[<span class="number">0</span>] = <span class="number">13</span>; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Memory数组"><a href="#Memory数组" class="headerlink" title="Memory数组"></a>Memory数组</h3><p>对于memory的变长数组，不支持修改length属性，来调整数组大小。memory的变长数组虽然可以通过参数灵活指定大小，但一旦创建，大小不可调整。</p>
<h3 id="push方法"><a href="#push方法" class="headerlink" title="push方法"></a>push方法</h3><p>变长的storage数组和bytes（不包括string）有一个push()方法。可以将一个新元素附加到数组最后端，返回值为当前长度uint。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Test &#123;</span><br><span class="line"></span><br><span class="line">    uint[] arr;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>)  <span class="title">public</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        arr.push(<span class="number">1</span>);<span class="comment">// 初始化前调用</span></span><br><span class="line">        arr = <span class="keyword">new</span> uint[](<span class="number">1</span>); </span><br><span class="line">        arr[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        uint len = arr.push(<span class="number">1</span>);<span class="comment">//先数组的最后添加一个元素1，方法返回的是数组的长度</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> len;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>memory的数组不可修改，不支持push方法。</p>
<h3 id="多维数组"><a href="#多维数组" class="headerlink" title="多维数组"></a>多维数组</h3><p>uint[2][3]在大多数语言中，表示的是两行三列的数组，而Solidity切好相反，它表示的是三行两列的数组。但是访问数组的方法与其他语言一致。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.4</span>;</span><br><span class="line"></span><br><span class="line">contract Test &#123;</span><br><span class="line"></span><br><span class="line">    uint[<span class="number">2</span>][<span class="number">3</span>] arr = [[<span class="number">1</span>,<span class="number">2</span>],[<span class="number">3</span>,<span class="number">4</span>],[<span class="number">5</span>,<span class="number">6</span>]];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">arr_len</span>(<span class="params"></span>)  <span class="title">public</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> arr.length; <span class="comment">//返回值为3</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="固定的字节数组和可变的字节数组"><a href="#固定的字节数组和可变的字节数组" class="headerlink" title="固定的字节数组和可变的字节数组"></a>固定的字节数组和可变的字节数组</h3><ul>
<li>bytes和string是一种特殊的数组。bytes类似于byte[],但在外部函数作为参数调用中，会进行压缩打包，更省空间，所以应该尽量使用bytes而不是byte[]. </li>
<li>bytes0~bytes32 表示创建固定字节大小的数组，不可修改。</li>
<li>string是特殊的可变字节数组。可以转换为bytes以通过length获得它的字节长度。也可以通过索引来修改对应的字节内容,通过push方法来增加字节内容。</li>
<li>由于bytes与string，可以自由转换，你可以将字符串s通过bytes(s)转为一个bytes。但需要注意的是通过这种方式访问到的是UTF-8编码的码流，并不是独立的一个个字符。比如中文编码是多字节，变长的，所以你访问到的很有可能只是其中的一个代码点。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Test &#123;</span><br><span class="line">    <span class="comment">// 声明一个固定长度的数组，不可修改</span></span><br><span class="line">    bytes9 a = <span class="number">0x6c697975656368756e</span>;</span><br><span class="line">    byte[<span class="number">9</span>] b = [byte(<span class="number">0x6c</span>),<span class="number">0x69</span>,<span class="number">0x79</span>,<span class="number">0x75</span>,<span class="number">0x65</span>,<span class="number">0x63</span>,<span class="number">0x68</span>,<span class="number">0x75</span>,<span class="number">0x6e</span>];</span><br><span class="line"></span><br><span class="line">    byte[] c = <span class="keyword">new</span> byte[](<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// function setAIndex0Byte() public &#123;</span></span><br><span class="line">    <span class="comment">//     // 错误，不可修改</span></span><br><span class="line">    <span class="comment">//     a[0] = 0x89;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setBIndex0Byte</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        b[<span class="number">0</span>] = <span class="number">0x89</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setC</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(uint i = <span class="number">0</span>; i &lt; b.length; i++) &#123;</span><br><span class="line"></span><br><span class="line">            c.push(b[i]);</span><br><span class="line">            c.push(b[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h2><ul>
<li>不能声明一个struct同时将这个struct作为这个struct的一个成员。这个限制是基于结构体的大小必须是有限的。</li>
<li>在函数中，将一个struct赋值给一个局部变量（默认是storage类型），实际是拷贝的引用，所以修改局部变量值时，会影响到原变量。</li>
<li>通常情况下不会考虑使用 uint 变种，因为无论如何定义 uint的大小，Solidity 都会为它保留256位的存储空间。例如，使用 uint8 而不是uint（uint256）不会节省任何 gas。</li>
<li>而如果一个 struct 中有多个 uint，则尽可能使用较小的 uint, Solidity 会将这些 uint 打包在一起，从而占用较少的存储空间。</li>
<li>结构体是不对外可见的(当前只支持internal)，所以只可以在当前合约，或合约的子类中使用。包含自定义结构体的函数均需要声明为internal或private的。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract CrowdFunding&#123;</span><br><span class="line">    struct Funder&#123;</span><br><span class="line">        address addr;</span><br><span class="line">        uint amount;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    struct Campaign&#123;</span><br><span class="line">        address beneficiary;</span><br><span class="line">        uint goal;</span><br><span class="line">        uint amount;</span><br><span class="line">        uint funderNum;</span><br><span class="line">        mapping(<span class="function"><span class="params">uint</span> =&gt;</span> Funder) funders;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    uint compaingnID;</span><br><span class="line">    mapping (<span class="function"><span class="params">uint</span> =&gt;</span> Campaign) campaigns;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">candidate</span>(<span class="params">address beneficiary, uint goal</span>) <span class="title">returns</span> (<span class="params">uint compaingnID</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// initialize</span></span><br><span class="line">        campaigns[compaingnID++] = Campaign(beneficiary, goal, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">vote</span>(<span class="params">uint compaingnID</span>) <span class="title">payable</span> </span>&#123;</span><br><span class="line">        Campaign c = campaigns[compaingnID];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//another way to initialize</span></span><br><span class="line">        c.funders[c.funderNum++] = Funder(&#123;<span class="attr">addr</span>: msg.sender, <span class="attr">amount</span>: msg.value&#125;);</span><br><span class="line">        c.amount += msg.value;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params">uint comapingnId</span>) <span class="title">returns</span> (<span class="params">bool</span>)</span>&#123;</span><br><span class="line">        Campaign c = campaigns[comapingnId];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(c.amount &lt; c.goal)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        uint amount = c.amount;</span><br><span class="line">        <span class="comment">// incase send much more</span></span><br><span class="line">        c.amount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(!c.beneficiary.send(amount))&#123;</span><br><span class="line">            <span class="keyword">throw</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="字典"><a href="#字典" class="headerlink" title="字典"></a>字典</h2><p>定义方式为mapping(_KeyType =&gt; _KeyValue)。键的类型允许除映射外的所有类型，如数组，合约，枚举，结构体。值的类型无限制。</p>
<p>在映射表中，我们并不存储键的数据，仅仅存储它的keccak256哈希值，用来查找值时使用。因此，映射并没有长度，键集合（或列表），值集合（或列表）这样的概念。</p>
<p>映射类型，仅能用来定义状态变量，或者是在内部函数中作为storage类型的引用。引用是指你可以声明一个，如var storage mappVal的用于存储状态变量的引用的对象，但你没办法使用非状态变量来初始化这个引用。</p>
<p>可以通过将映射标记为public，来让Solidity创建一个访问器。要想访问这样的映射，需要提供一个键值做为参数。如果映射的值类型也是映射，使用访问器访问时，要提供这个映射值所对应的键，不断重复这个过程。下面来看一个例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">contract MappingExample&#123;</span><br><span class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) public balances;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params">uint amount</span>) <span class="title">returns</span> (<span class="params">address addr</span>)</span>&#123;</span><br><span class="line">        balances[msg.sender] = amount;</span><br><span class="line">        <span class="keyword">return</span> msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于调试时，你不一定方便知道自己的发起地址，所以把这个函数，略微调整了一下，以在调用时，返回调用者的地址。编译上述合同后，可以先调用update()，执行成功后，查看调用信息，能看到你更新的地址，这样再查一下这个地址的在映射里存的值。</p>
<p>如果你想通过合约进行上述调用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//file indeed for compile</span></span><br><span class="line"><span class="comment">//may store in somewhere and import</span></span><br><span class="line">contract MappingExample&#123;</span><br><span class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) public balances;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params">uint amount</span>) <span class="title">returns</span> (<span class="params">address addr</span>)</span>&#123;</span><br><span class="line">        balances[msg.sender] = amount;</span><br><span class="line">        <span class="keyword">return</span> msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract MappingUser&#123;</span><br><span class="line">    </span><br><span class="line">    address conAddr;</span><br><span class="line">    address userAddr;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint amount</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//address not resolved!</span></span><br><span class="line">    <span class="comment">//tringing</span></span><br><span class="line">        conAddr = hex<span class="string">&quot;0xf2bd5de8b57ebfc45dcee97524a7a08fccc80aef&quot;</span>;</span><br><span class="line">        userAddr = hex<span class="string">&quot;0xca35b7d915458ef540ade6068dfe2f44e8fa733c&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> MappingExample(conAddr).balances(userAddr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>映射并未提供迭代输出的方法，可以自行实现一个数据结构。</p>
<h2 id="运算符delete"><a href="#运算符delete" class="headerlink" title="运算符delete"></a>运算符delete</h2><p>delete运算符，用于将某个变量重置为初始值。对于整数，运算符的效果等同于a = 0。而对于定长数组，则是把数组中的每个元素置为初始值，变长数组则是将长度置为0。对于结构体，也是类似，是将所有的成员均重置为初始值。delete对于映射类型几乎无影响，因为键可能是任意的，且往往不可知。所以如果你删除一个结构体，它会递归删除所有非mapping的成员。当然，你是可以单独删除映射里的某个键，以及这个键映射的某个值。</p>
<p>需要强调的是delete a的行为更像赋值，为a赋予一个新对象。我们来看看下文的示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract DeleteExample &#123;</span><br><span class="line">    uint data;</span><br><span class="line">    uint[] dataArray;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//值传递</span></span><br><span class="line">        uint x = data;</span><br><span class="line">        <span class="comment">//删除x不会影响data</span></span><br><span class="line">        <span class="keyword">delete</span> x;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//删除data，同样也不会影响x，因为是值传递，它存的是一份原值的拷贝。</span></span><br><span class="line">        <span class="keyword">delete</span> data; </span><br><span class="line"></span><br><span class="line">        <span class="comment">//引用赋值</span></span><br><span class="line">        uint[] y = dataArray;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//删除dataArray会影响y，y也将被赋值为初值。</span></span><br><span class="line">        <span class="keyword">delete</span> dataArray;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//下面的操作为报错，因为删除是一个赋值操作，不能向引用类型的storage直接赋值从而报错</span></span><br><span class="line">        <span class="comment">//delete y;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过上面的代码，我们可以看出，对于值类型，是值传递，删除x不会影响到data，同样的删除data也不会影响到x。因为他们都存了一份原值的拷贝。而对于复杂类型略有不同，复杂类型在赋值时使用的是引用传递。删除会影响所有相关变量。比如上述代码中，删除dataArray同样会影响到y。由于delete的行为更像是赋值操作，所以不能在上述代码中执行delete y，因为不能对一个storage的引用赋值</p>
<h2 id="类型推断"><a href="#类型推断" class="headerlink" title="类型推断"></a>类型推断</h2><p>为了方便，并不总是需要明确指定一个变量的类型，编译器会通过第一个向这个对象赋予的值的类型来进行推断1。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uint24 x = <span class="number">0x123</span>;</span><br><span class="line"><span class="keyword">var</span> y = x;</span><br></pre></td></tr></table></figure>

<p>函数的参数，包括返回参数，不可以使用var这种不指定类型的方式。</p>
<p>需要特别注意的是，由于类型推断是根据第一个变量进行的赋值。所以代码for (var i = 0; i &lt; 2000; i++) {}将是一个无限循环，因为一个uint8的i的将小于2000。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.4</span>;</span><br><span class="line"></span><br><span class="line">contract Test&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint</span>)</span>&#123;</span><br><span class="line">      uint count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">2000</span>; i++) &#123;</span><br><span class="line">            count++;</span><br><span class="line">            <span class="keyword">if</span>(count &gt;= <span class="number">2100</span>)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="单位"><a href="#单位" class="headerlink" title="单位"></a>单位</h1><h2 id="货币单位"><a href="#货币单位" class="headerlink" title="货币单位"></a>货币单位</h2><p>一个字面量的数字，可以使用后缀wei,finney,szabo或ether来在不同面额中转换。不含任何后缀的默认单位是wei。如2 ether == 2000 finney的结果是true。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract EthUnit&#123;</span><br><span class="line">    uint a;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">bool</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="number">2</span> ether == <span class="number">2000</span> finney)&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="时间单位-Time-Units"><a href="#时间单位-Time-Units" class="headerlink" title="时间单位(Time Units)"></a>时间单位(Time Units)</h2><p>seconds,minutes,hours,days,weeks,years均可做为后缀，并进行相互转换，默认是seconds为单位。</p>
<p>变量 now 将返回当前的unix时间戳(自1970年1月1日以来经过的秒数)。Unix时间传统用一个32位的整数进行存储，这会导致“2038年”问题，当这个32位的unix时间戳不够用，产生溢出，使用这个时间的遗留系统就麻烦了。所以，如果我们想让我们的 DApp 跑够20年，我们可以使用64位整数表示时间，但为此我们的用户又得支付更多的 gas。真是个两难的设计啊！</p>
<p>如果你需要进行使用这些单位进行日期计算，需要特别小心，因为不是每年都是365天，且并不是每天都有24小时，因为还有闰秒。由于无法预测闰秒，必须由外部的oracle来更新从而得到一个精确的日历库（内部实现一个日期库也是消耗gas的）。</p>
<p>后缀不能用于变量。如果你想对输入的变量说明其不同的单位，可以使用下面的方式。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract DeleteExample&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">nowInSeconds</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint256</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> now;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">uint start, uint daysAfter</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (now &gt;= start + daysAfter * <span class="number">1</span> days) &#123; </span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="内置特性"><a href="#内置特性" class="headerlink" title="内置特性"></a>内置特性</h1><h2 id="特殊变量及函数"><a href="#特殊变量及函数" class="headerlink" title="特殊变量及函数"></a>特殊变量及函数</h2><p>区块和交易的属性：</p>
<ul>
<li>block.blockhash(uint blockNumber) returns (bytes32)，给定区块号的哈希值，只支持最近256个区块，且不包含当前区块。</li>
<li>block.coinbase (address) 当前块矿工的地址。</li>
<li>block.difficulty (uint)当前块的难度。</li>
<li>block.gaslimit (uint)当前块的gaslimit。</li>
<li>block.number (uint)当前区块的块号。</li>
<li>block.timestamp (uint)当前块的时间戳。</li>
<li>msg.data (bytes)完整的调用数据（calldata）。</li>
<li>msg.gas (uint)当前还剩的gas。</li>
<li>msg.sender (address)当前调用发起人的地址,总是存在。</li>
<li>msg.sig (bytes4)调用数据的前四个字节（函数标识符）。</li>
<li>msg.value (uint)这个消息所附带的货币量，单位为wei。</li>
<li>now (uint)当前块的时间戳，等同于block.timestamp</li>
<li>tx.gasprice (uint) 交易的gas价格。</li>
<li>tx.origin (address)交易的发送者（完整的调用链）</li>
</ul>
<p>msg的所有成员值，如msg.sender,msg.value的值可以因为每一次外部函数调用，或库函数调用发生变化（因为msg就是和调用相关的全局变量）。如果你想在库函数中，用msg.sender实现访问控制，你需要将msg.sender做为参数（就是说不能使用默认的msg.value，因为它可能被更改）。为了可扩展性的原因，你只能查最近256个块，所有其它的将返回0.</p>
<h2 id="数学和加密函数"><a href="#数学和加密函数" class="headerlink" title="数学和加密函数"></a>数学和加密函数</h2><ul>
<li>asser(bool condition):如果条件不满足，抛出异常。</li>
<li>addmod(uint x, uint y, uint k) returns (uint):计算(x + y) % k。加法支持任意的精度。但不超过(wrap around？)2**256。</li>
<li>mulmod(uint x, uint y, uint k) returns (uint):计算(x * y) % k。乘法支持任意精度，但不超过(wrap around？)2**256。</li>
<li>keccak256(…) returns (bytes32):使用以太坊的（Keccak-256）计算HASH值。紧密打包。</li>
<li>sha3(…) returns (bytes32):等同于keccak256()。紧密打包。</li>
<li>sha256(…) returns (bytes32):使用SHA-256计算HASH值。紧密打包。</li>
<li>ripemd160(…) returns (bytes20):使用RIPEMD-160计算HASH值。紧密打包。</li>
<li>ecrecover(bytes32 hash, uint8 v, bytes32 r, bytes32 s) returns (address):通过签名信息恢复非对称加密算法公匙地址。如果出错会返回0，附录提供了一个例子1.</li>
<li>revert()：取消执行，并回撤状态变化。</li>
</ul>
<h2 id="地址相关"><a href="#地址相关" class="headerlink" title="地址相关"></a>地址相关</h2><ul>
<li><address>.balance (uint256)：Address的余额，以wei为单位。</li>
<li><address>.transfer(uint256 amount)：发送给定数量的ether，以wei为单位，到某个地址。失败时抛出异常。</li>
<li><address>.send(uint256 amount) returns (bool):发送给定数量的ether，以wei为单位，到某个地址。失败时返回false。</li>
<li><address>.call(...) returns (bool)：发起底层的call调用。失败时返回false。</li>
<li><address>.callcode(...) returns (bool)：发起底层的callcode调用，失败时返回false。</li>
<li><address>.delegatecall(...) returns (bool)：发起底层的delegatecall调用，失败时返回false。

</li>
</ul>
<p>使用send方法需要注意，调用栈深不能超过1024，或gas不足，都将导致发送失败。使用为了保证你的ether安全，要始终检查返回结果。当用户取款时，使用transfer或使用最佳实践的模式2。</p>
<h2 id="合约相关"><a href="#合约相关" class="headerlink" title="合约相关"></a>合约相关</h2><ul>
<li>this（当前合约的类型）：当前合约的类型，可以显式的转换为Address</li>
<li>selfdestruct(address recipt):销毁当前合约，并把它所有资金发送到给定的地址。</li>
</ul>
<h1 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h1><h2 id="控制语句"><a href="#控制语句" class="headerlink" title="控制语句"></a>控制语句</h2><p>不支持switch和goto，支持if，else，while，do，for，break，continue，return，?:。条件判断中的括号不可省略，但在单行语句中的大括号可以省略。</p>
<h2 id="函数调用"><a href="#函数调用" class="headerlink" title="函数调用"></a>函数调用</h2><h3 id="内部函数调用"><a href="#内部函数调用" class="headerlink" title="内部函数调用"></a>内部函数调用</h3><p>在当前的合约中，函数可以直接调用（内部调用方式），包括也可递归调用。</p>
<h3 id="外部函数调用"><a href="#外部函数调用" class="headerlink" title="外部函数调用"></a>外部函数调用</h3><p>表达式this.g(8);和c.g(2)（这里的c是一个合约实例）是外部调用函数的方式。实现上是通过一个消息调用，而不是直接通过EVM的指令跳转。需要注意的是，在合约的构造器中，不能使用this调用函数，因为当前合约还没有创建完成。</p>
<p>其它合约的函数必须通过外部的方式调用。对于一个外部调用，所有函数的参数必须要拷贝到内存中。当调用其它合约的函数时，可以通过选项.value()，和.gas()来分别指定，要发送的ether量（以wei为单位），和gas值。</p>
<h3 id="命名参数调用和匿名函数参数"><a href="#命名参数调用和匿名函数参数" class="headerlink" title="命名参数调用和匿名函数参数"></a>命名参数调用和匿名函数参数</h3><p>函数调用的参数，可以通过指定名字的方式调用，但可以以任意的顺序，使用方式是{}包含。但参数的类型和数量要与定义一致。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract C &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">uint val1, uint val2</span>) <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123; <span class="keyword">return</span> val1 + val2; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">g</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// named arguments</span></span><br><span class="line">        <span class="keyword">return</span> add(&#123;<span class="attr">val2</span>: <span class="number">2</span>, <span class="attr">val1</span>: <span class="number">1</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="省略函数名称"><a href="#省略函数名称" class="headerlink" title="省略函数名称"></a>省略函数名称</h3><p>没有使用的参数名可以省略(一般常见于返回值)。这些名字在栈(stack)上存在，但不可访问。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract C &#123;</span><br><span class="line">    <span class="comment">// omitted name for parameter</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params">uint k, uint</span>) <span class="title">returns</span>(<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> k;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建合约实例"><a href="#创建合约实例" class="headerlink" title="创建合约实例"></a>创建合约实例</h2><p>一个合约可以通过new关键字来创建一个合约。要创建合约的完整代码，必须提前知道，所以递归创建依赖是不可能的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Account&#123;</span><br><span class="line">    uint accId;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//construction?</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Account</span>(<span class="params">uint accountId</span>) <span class="title">payable</span></span>&#123;</span><br><span class="line">        accId = accountId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Initialize&#123;</span><br><span class="line">    Account account = <span class="keyword">new</span> Account(<span class="number">10</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">newAccount</span>(<span class="params">uint accountId</span>)</span>&#123;</span><br><span class="line">        account = <span class="keyword">new</span> Account(accountId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">newAccountWithEther</span>(<span class="params">uint accountId, uint amount</span>)</span>&#123;</span><br><span class="line">        account = (<span class="keyword">new</span> Account).value(amount)(accountId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的例子可以看出来，可以在创建合约中，发送ether，但不能限制gas的使用。如果创建因为out-of-stack，或无足够的余额以及其它任何问题，会抛出一个异常。</p>
<h2 id="赋值"><a href="#赋值" class="headerlink" title="赋值"></a>赋值</h2><p>Solidity内置支持元组(tuple)，可以同时返回多个结果，也可用于同时赋值给多个变量。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract C &#123;</span><br><span class="line">    uint[] data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint, bool, uint</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="number">7</span>, <span class="literal">true</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">g</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// Declares and assigns the variables. Specifying the type explicitly is not possible.</span></span><br><span class="line">        <span class="keyword">var</span> (x, b, y) = f();</span><br><span class="line">        <span class="comment">// Assigns to a pre-existing variable.</span></span><br><span class="line">        (x, y) = (<span class="number">2</span>, <span class="number">7</span>);</span><br><span class="line">        <span class="comment">// Common trick to swap values -- does not work for non-value storage types.</span></span><br><span class="line">        (x, y) = (y, x);</span><br><span class="line">        <span class="comment">// Components can be left out (also for variable declarations).</span></span><br><span class="line">        <span class="comment">// If the tuple ends in an empty component,</span></span><br><span class="line">        <span class="comment">// the rest of the values are discarded.</span></span><br><span class="line">        (data.length,) = f(); <span class="comment">// Sets the length to 7</span></span><br><span class="line">        <span class="comment">// The same can be done on the left side.</span></span><br><span class="line">        (,data[<span class="number">3</span>]) = f(); <span class="comment">// Sets data[3] to 2</span></span><br><span class="line">        <span class="comment">// Components can only be left out at the left-hand-side of assignments, with</span></span><br><span class="line">        <span class="comment">// one exception:</span></span><br><span class="line">        (x,) = (<span class="number">1</span>,);</span><br><span class="line">        <span class="comment">// (1,) is the only way to specify a 1-component tuple, because (1) is</span></span><br><span class="line">        <span class="comment">// equivalent to 1.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="作用范围和声明"><a href="#作用范围和声明" class="headerlink" title="作用范围和声明"></a>作用范围和声明</h2><p>函数内定义的变量，在整个函数中均可用，无论它在哪里定义，因为Solidity使用了javascript的变量作用范围的规则。与常规语言语法从定义处开始，到当前块结束为止不同。由此，下述代码编译时会抛出一个异常，Identifier already declared。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract ScopingErrors &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">scoping</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        uint i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (i++ &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            uint same1 = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (i++ &lt; <span class="number">2</span>) &#123;</span><br><span class="line">            uint same1 = <span class="number">0</span>;<span class="comment">// Illegal, second declaration of same1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">minimalScoping</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        &#123;</span><br><span class="line">            uint same2 = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            uint same2 = <span class="number">0</span>;<span class="comment">// Illegal, second declaration of same2</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">forLoopScoping</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (uint same3 = <span class="number">0</span>; same3 &lt; <span class="number">1</span>; same3++) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (uint same3 = <span class="number">0</span>; same3 &lt; <span class="number">1</span>; same3++) &#123;<span class="comment">// Illegal, second declaration of same3</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">crossFunction</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">       uint same1 = <span class="number">0</span>;<span class="comment">//Illegal</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外的，如果一个变量被声明了，它会在函数开始前被初始化为默认值。所以下述例子是合法的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract C&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// baz is implicitly initialized as 0</span></span><br><span class="line">        uint bar = <span class="number">5</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            bar += baz;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            uint baz = <span class="number">10</span>;<span class="comment">// never executes</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bar;<span class="comment">// returns 5</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="随机数"><a href="#随机数" class="headerlink" title="随机数"></a>随机数</h2><p>在Solidity中无法安全地生成随机数，Solidity 中最好的随机数生成器是 keccak256 哈希函数，可以这样来生成一些随机数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成一个0到100的随机数:</span></span><br><span class="line">uint randNonce = <span class="number">0</span>;</span><br><span class="line">uint random = uint(keccak256(now, msg.sender, randNonce)) % <span class="number">100</span>;</span><br><span class="line">randNonce++;</span><br><span class="line">uint random2 = uint(keccak256(now, msg.sender, randNonce)) % <span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<p>这个方法可以被不诚实的节点攻击，假设我们有一个硬币翻转合约——正面你赢双倍钱，反面你输掉所有的钱。假如它使用上面的方法来决定是正面还是反面 (random &gt;= 50 算正面, random &lt; 50 算反面)。如果我正运行一个节点，我可以只对我自己的节点发布一个事务，且不分享它。我可以运行硬币翻转方法来偷窥我的输赢：如果我输了，我就不把这个事务包含进我要解决的下一个区块中去。我可以一直运行这个方法，直到我赢得了硬币翻转并解决了下一个区块，然后获利。</p>
<p>当然，这需要很大的算力来保证自己可以挖矿成功。</p>
<h2 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h2><p>可以使用throw来手动抛出一个异常。抛出异常的效果是当前的执行被终止且被撤销(值的改变和帐户余额的变化都会被回退)。异常还会通过Solidity的函数调用向上冒泡(bubbled up)传递。（send，和底层的函数调用call,delegatecall，callcode是一个例外，当发生异常时，这些函数返回false）。捕捉异常是不可能的。</p>
<p>require使得函数在执行过程中，当不满足某些条件时抛出错误，并停止执行：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayHiToVitalik</span>(<span class="params">string _name</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">string</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 比较 _name 是否等于 &quot;Vitalik&quot;. 如果不成立，抛出异常并终止程序</span></span><br><span class="line">  <span class="comment">// (敲黑板: Solidity 并不支持原生的字符串比较, 我们只能通过比较</span></span><br><span class="line">  <span class="comment">// 两字符串的 keccak256 哈希值来进行判断)</span></span><br><span class="line">  <span class="built_in">require</span>(keccak256(_name) == keccak256(<span class="string">&quot;Vitalik&quot;</span>));</span><br><span class="line">  <span class="comment">// 如果返回 true, 运行如下语句</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;Hi!&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Sharer &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">sendHalf</span>(<span class="params">address addr</span>) <span class="title">payable</span> <span class="title">returns</span> (<span class="params">uint balance</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!addr.send(msg.value / <span class="number">2</span>))</span><br><span class="line">            <span class="keyword">throw</span>; <span class="comment">// also reverts the transfer to Sharer</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用户可以通过下述方式触发一个异常：</p>
<ul>
<li>调用throw。</li>
<li>调用require，但参数值为false。</li>
</ul>
<p>通过assert判断内部条件是否达成，require验证输入的有效性。这样的分析工具，可以假设正确的输入，减少错误。这样无效的操作码将永远不会出现。</p>
<p>assert 和 require 区别在于，require 若失败则会返还给用户剩下的 gas， assert 则不会。</p>
<h1 id="合约详解"><a href="#合约详解" class="headerlink" title="合约详解"></a>合约详解</h1><h2 id="合约"><a href="#合约" class="headerlink" title="合约"></a>合约</h2><p>Solidity中合约有点类似面向对象语言中的类。合约中有用于数据持久化的状态变量(state variables)，和可以操作他们的函数。调用另一个合约实例的函数时，会执行一个EVM函数调用，这个操作会切换执行时的上下文，这样，前一个合约的状态变量(state variables)就不能访问了。</p>
<p>合约可以通过Solidity，或不通过Solidity创建。当合约创建时，一个和合约同名的函数(构造器函数)会调用一次，用于初始化。构造器函数是可选的。仅能有一个构造器，所以不支持重载。</p>
<p>如果不通过Solidity，我们可以通过web3.js，使用JavaScript的API来完成合约创建。</p>
<p>当一个文件中有多个contract时，默认将合约名大写的那个合约当做主合约。</p>
<h2 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h2><p>修改为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">contract Test &#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="析构函数"><a href="#析构函数" class="headerlink" title="析构函数"></a>析构函数</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">kill</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (owner == msg.sender) &#123; <span class="comment">// 检查谁在调用</span></span><br><span class="line">        selfdestruct(owner); <span class="comment">// 销毁合约</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="可见性和权限控制"><a href="#可见性和权限控制" class="headerlink" title="可见性和权限控制"></a>可见性和权限控制</h2><p>Solidity有两种函数调用方式，一种是内部调用，不会创建一个EVM调用（也叫做消息调用），另一种则是外部调用，会创建EVM调用（会发起消息调用）。Solidity对函数和状态变量提供了四种可见性。分别是external,public,internal,private。其中函数默认是public。状态变量默认的可见性是internal。</p>
<ul>
<li>external: 外部函数是合约接口的一部分，所以我们可以从其它合约或通过交易来发起调用。一个外部函数f，不能通过内部的方式来发起调用，（如f()不可以，但可以通过this.f()）。外部函数在接收大的数组数据时更加有效。</li>
<li>public: 可以在任何地方调用，不管是内部还是外部。对于public类型的状态变量，会自动创建一个访问器（详见下文）。</li>
<li>internal：这样声明的函数和状态变量只能通过内部访问。如在当前合约中调用，或继承的合约里调用。需要注意的是不能加前缀this，前缀this是表示通过外部方式访问。</li>
<li>private：私有函数和状态变量仅在当前合约中可以访问，在继承的合约内，不可访问。private修饰的函数名一般以”_”开头.</li>
</ul>
<p>备注：</p>
<ul>
<li>internal 和 private 类似，不过， 如果某个合约继承自其父合约，这个合约即可以访问父合约中定义的“内部”函数。</li>
<li>所有在合约内的东西对外部的观察者来说都是可见，将某些东西标记为private仅仅阻止了其它合约来进行访问和修改，但并不能阻止其它人看到相关的信息。</li>
<li>可见性的标识符的定义位置，对于state variable是在类型后面，函数是在参数列表和返回关键字中间。来看一个定义的例子：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract C &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">uint a</span>) <span class="title">private</span> <span class="title">returns</span> (<span class="params">uint b</span>) </span>&#123; <span class="keyword">return</span> a + <span class="number">1</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setData</span>(<span class="params">uint a</span>) <span class="title">internal</span> </span>&#123; data = a; &#125;</span><br><span class="line">    uint public data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在下面的例子中，D可以调用c.getData()来访问data的值，但不能调用f。合约E继承自C，所以它可以访问compute函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract C &#123;</span><br><span class="line">    uint private data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">uint a</span>) <span class="title">private</span> <span class="title">returns</span>(<span class="params">uint b</span>) </span>&#123; <span class="keyword">return</span> a + <span class="number">1</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setData</span>(<span class="params">uint a</span>) </span>&#123; data = a; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">returns</span>(<span class="params">uint</span>) </span>&#123; <span class="keyword">return</span> data; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">compute</span>(<span class="params">uint a, uint b</span>) <span class="title">internal</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123; <span class="keyword">return</span> a+b; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract D &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">readData</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        C c = <span class="keyword">new</span> C();</span><br><span class="line">        uint local = c.f(<span class="number">7</span>); <span class="comment">// error: member &quot;f&quot; is not visible</span></span><br><span class="line">        c.setData(<span class="number">3</span>);</span><br><span class="line">        local = c.getData();</span><br><span class="line">        local = c.compute(<span class="number">3</span>, <span class="number">5</span>); <span class="comment">// error: member &quot;compute&quot; is not visible</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract E is C &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">g</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        C c = <span class="keyword">new</span> C();</span><br><span class="line">        uint val = compute(<span class="number">3</span>, <span class="number">5</span>);  <span class="comment">// acces to internal member (from derivated to parent contract)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="访问函数"><a href="#访问函数" class="headerlink" title="访问函数"></a>访问函数</h2><p>编译器为自动为所有的public的状态变量创建访问函数。下面的合约例子中，编译器会生成一个名叫data的无参，返回值是uint的类型的值data。状态变量的初始化可以在定义时完成。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract C&#123;</span><br><span class="line">    uint public c = <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract D&#123;</span><br><span class="line">    C c = <span class="keyword">new</span> C();</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getDataUsingAccessor</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> c.c();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="函数修饰符"><a href="#函数修饰符" class="headerlink" title="函数修饰符"></a>函数修饰符</h2><p>modifier 可以用来改变一个函数的行为。比如用于在函数执行前检查某种前置条件。修改器是一种合约属性，可被继承，同时还可被派生的合约重写(override)。下面我们来看一段示例代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract owned &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">owned</span>(<span class="params"></span>) </span>&#123; owner = msg.sender; &#125;</span><br><span class="line">    address owner;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This contract only defines a modifier but does not use</span></span><br><span class="line">    <span class="comment">// it - it will be used in derived contracts.</span></span><br><span class="line">    <span class="comment">// The function body is inserted where the special symbol</span></span><br><span class="line">    <span class="comment">// &quot;_;&quot; in the definition of a modifier appears.</span></span><br><span class="line">    <span class="comment">// This means that if the owner calls this function, the</span></span><br><span class="line">    <span class="comment">// function is executed and otherwise, an exception is</span></span><br><span class="line">    <span class="comment">// thrown.</span></span><br><span class="line">    modifier onlyOwner &#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.sender != owner)</span><br><span class="line">            <span class="keyword">throw</span>;</span><br><span class="line">        <span class="comment">// require(msg.sender == owner);</span></span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract mortal is owned &#123;</span><br><span class="line">    <span class="comment">// This contract inherits the &quot;onlyOwner&quot;-modifier from</span></span><br><span class="line">    <span class="comment">// &quot;owned&quot; and applies it to the &quot;close&quot;-function, which</span></span><br><span class="line">    <span class="comment">// causes that calls to &quot;close&quot; only have an effect if</span></span><br><span class="line">    <span class="comment">// they are made by the stored owner.</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>) <span class="title">onlyOwner</span> </span>&#123;</span><br><span class="line">        selfdestruct(owner);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract priced &#123;</span><br><span class="line">    <span class="comment">// Modifiers can receive arguments:</span></span><br><span class="line">    modifier costs(uint price) &#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.value &gt;= price) &#123;</span><br><span class="line">            _;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract Register is priced, owned &#123;</span><br><span class="line">    mapping (<span class="function"><span class="params">address</span> =&gt;</span> bool) registeredAddresses;</span><br><span class="line">    uint price;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Register</span>(<span class="params">uint initialPrice</span>) </span>&#123; price = initialPrice; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// It is important to also provide the</span></span><br><span class="line">    <span class="comment">// &quot;payable&quot; keyword here, otherwise the function will</span></span><br><span class="line">    <span class="comment">// automatically reject all Ether sent to it.</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"></span>) <span class="title">payable</span> <span class="title">costs</span>(<span class="params">price</span>) </span>&#123;</span><br><span class="line">        registeredAddresses[msg.sender] = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">changePrice</span>(<span class="params">uint _price</span>) <span class="title">onlyOwner</span> </span>&#123;</span><br><span class="line">        price = _price;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改器可以被继承，使用将modifier置于参数后，返回值前即可。</li>
<li>特殊_表示使用修改符的函数体的替换位置。</li>
<li>从合约Register可以看出全约可以多继承，通过<code>,</code>号分隔两个被继承的对象。</li>
<li>修改器也是可以接收参数的，如priced的costs。</li>
</ul>
<p>使用修改器实现的一个防重复进入的例子。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line">contract Mutex &#123;</span><br><span class="line">    bool locked;</span><br><span class="line">    modifier noReentrancy() &#123;</span><br><span class="line">        <span class="keyword">if</span> (locked) <span class="keyword">throw</span>;</span><br><span class="line">        locked = <span class="literal">true</span>;</span><br><span class="line">        _;</span><br><span class="line">        locked = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// This function is protected by a mutex, which means that</span></span><br><span class="line">    <span class="comment">/// reentrant calls from within msg.sender.call cannot call f again.</span></span><br><span class="line">    <span class="comment">/// The `return 7` statement assigns 7 to the return value but still</span></span><br><span class="line">    <span class="comment">/// executes the statement `locked = false` in the modifier.</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>) <span class="title">noReentrancy</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!msg.sender.call()) <span class="keyword">throw</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">7</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例子中，由于call()方法有可能会调回当前方法，修改器实现了防重入的检查。如果同一个函数有多个修改器，他们之间以空格隔开，修饰器会依次检查执行。需要注意的是，在Solidity的早期版本中，有修改器的函数，它的return语句的行为有些不同。在修改器中和函数体内的显式的return语句，仅仅跳出当前的修改器和函数体。返回的变量会被赋值，但整个执行逻辑会在前一个修改器后面定义的”_”后继续执行。修改器的参数可以是任意表达式。在对应的上下文中，所有的函数中引入的符号，在修改器中均可见。但修改器中引入的符号在函数中不可见，因为它们有可能被重写。</p>
<h2 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h2><h3 id="常量-1"><a href="#常量-1" class="headerlink" title="常量"></a>常量</h3><p>状态变量可以被定义为constant，常量。这样的话，它必须在编译期间通过一个表达式赋值。赋值的表达式不允许：1）访问storage；2）区块链数据，如now，this.balance，block.number；3）合约执行的中间数据，如msg.gas；4）向外部合约发起调用。也许会造成内存分配副作用表达式是允许的，但不允许产生其它内存对象的副作用的表达式。内置的函数keccak256，keccak256，ripemd160，ecrecover，addmod，mulmod可以允许调用，即使它们是调用的外部合约。</p>
<p>允许内存分配，从而带来可能的副作用的原因是因为这将允许构建复杂的对象，比如，查找表。虽然当前的特性尚未完整支持。</p>
<p>编译器并不会为常量在storage上预留空间，每个使用的常量都会被对应的常量表达式所替换（也许优化器会直接替换为常量表达式的结果值）。</p>
<p>不是所有的类型都支持常量，当前支持的仅有值类型和字符串。</p>
<p>新版本中:</p>
<ul>
<li>view: 把函数定义为 view, 意味着它只能读取数据不能更改数据</li>
<li>pure: pure 函数表明这个函数不访问应用里的数据</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract C &#123;</span><br><span class="line">    uint constant x = <span class="number">32</span>**<span class="number">22</span> + <span class="number">8</span>;</span><br><span class="line">    string constant text = <span class="string">&quot;abc&quot;</span>;</span><br><span class="line">    bytes32 constant myHash = keccak256(<span class="string">&quot;abc&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="常函数"><a href="#常函数" class="headerlink" title="常函数"></a>常函数</h3><p>函数也可被声明为常量，这类函数将承诺自己不修改区块链上任何状态。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract C &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">uint a, uint b</span>) <span class="title">constant</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> a * (b + <span class="number">42</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问器(Accessor)方法默认被标记为constant。当前编译器并未强制一个constant的方法不能修改状态。但建议大家对于不会修改数据的标记为constant。</p>
<h2 id="回退函数"><a href="#回退函数" class="headerlink" title="回退函数"></a>回退函数</h2><p>每一个合约有且仅有一个没有名字的函数。这个函数无参数，也无返回值。如果调用合约时，没有匹配上任何一个函数(或者没有传哪怕一点数据)，就会调用默认的回退函数。此外，当合约收到ether时（没有任何其它数据），这个函数也会被执行。在此时，一般仅有少量的gas剩余，用于执行这个函数(准确的说，还剩2300gas)。所以应该尽量保证回退函数使用少的gas。</p>
<p>下述提供给回退函数可执行的操作会比常规的花费得多一点。</p>
<ul>
<li>写入到存储(storage)</li>
<li>创建一个合约</li>
<li>执行一个外部(external)函数调用，会花费非常多的gas</li>
<li>发送ether</li>
</ul>
<p>请在部署合约到网络前，保证透彻的测试你的回退函数，来保证函数执行的花费控制在2300gas以内。一个没有定义一个回退函数的合约。如果接收ether，会触发异常，并返还ether（solidity v0.4.0开始）。所以合约要接收ether，必须实现回退函数。下面来看个例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Test &#123;</span><br><span class="line">    <span class="comment">// This function is called for all messages sent to</span></span><br><span class="line">    <span class="comment">// this contract (there is no other function).</span></span><br><span class="line">    <span class="comment">// Sending Ether to this contract will cause an exception,</span></span><br><span class="line">    <span class="comment">// because the fallback function does not have the &quot;payable&quot;</span></span><br><span class="line">    <span class="comment">// modifier.</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; x = <span class="number">1</span>; &#125;</span><br><span class="line">    uint x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// This contract keeps all Ether sent to it with no way to get it back.</span></span><br><span class="line">contract Sink &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">payable</span> </span>&#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract Caller &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">callTest</span>(<span class="params">Test test</span>) </span>&#123;</span><br><span class="line">        test.call(<span class="number">0xabcdef01</span>); <span class="comment">// hash does not exist</span></span><br><span class="line">        <span class="comment">// results in test.x becoming == 1.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// The following call will fail, reject the</span></span><br><span class="line">        <span class="comment">// Ether and return false:</span></span><br><span class="line">        test.send(<span class="number">2</span> ether);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="payable"><a href="#payable" class="headerlink" title="payable"></a>payable</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">contract OnlineStore &#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">buySomething</span>(<span class="params"></span>) <span class="title">external</span> <span class="title">payable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 检查以确定0.001以太发送出去来运行函数:</span></span><br><span class="line">    <span class="built_in">require</span>(msg.value == <span class="number">0.001</span> ether);</span><br><span class="line">    <span class="comment">// 如果为真，一些用来向函数调用者发送数字内容的逻辑</span></span><br><span class="line">    transferThing(msg.sender);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="提现"><a href="#提现" class="headerlink" title="提现"></a>提现</h2><p>在发送以太之后，它将被存储进合约的以太坊账户中，并冻结在哪里，可以写一个函数来从合约中提现以太，类似这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">contract GetPaid is Ownable &#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">withdraw</span>(<span class="params"></span>) <span class="title">external</span> <span class="title">onlyOwner</span> </span>&#123;</span><br><span class="line">    owner.transfer(<span class="built_in">this</span>.balance);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h2><p>事件是合约和区块链通讯的一种机制。前端应用“监听”某些事件，并做出反应。(触发事件需要添加emit关键字)</p>
<p>例子:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里建立事件</span></span><br><span class="line">event IntegersAdded(uint x, uint y, uint result);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">uint _x, uint _y</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">  uint result = _x + _y;</span><br><span class="line">  <span class="comment">//触发事件，通知app</span></span><br><span class="line">  emit IntegersAdded(_x, _y, result);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>app前端可以监听这个事件,JavaScript 实现如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">YourContract.IntegersAdded(<span class="function"><span class="keyword">function</span>(<span class="params">error, result</span>) </span>&#123; </span><br><span class="line">  <span class="comment">// 干些事</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract owned &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">owned</span>(<span class="params"></span>) </span>&#123; owner = msg.sender; &#125;</span><br><span class="line">    address owner;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Use &quot;is&quot; to derive from another contract. Derived</span></span><br><span class="line"><span class="comment">// contracts can access all non-private members including</span></span><br><span class="line"><span class="comment">// internal functions and state variables. These cannot be</span></span><br><span class="line"><span class="comment">// accessed externally via `this`, though.</span></span><br><span class="line">contract mortal is owned &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">kill</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.sender == owner) selfdestruct(owner);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// These abstract contracts are only provided to make the</span></span><br><span class="line"><span class="comment">// interface known to the compiler. Note the function</span></span><br><span class="line"><span class="comment">// without body. If a contract does not implement all</span></span><br><span class="line"><span class="comment">// functions it can only be used as an interface.</span></span><br><span class="line">contract Config &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">lookup</span>(<span class="params">uint id</span>) <span class="title">returns</span> (<span class="params">address adr</span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">NameReg</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params">bytes32 name</span>);</span></span><br><span class="line"><span class="function">    <span class="title">function</span> <span class="title">unregister</span>(<span class="params"></span>);</span></span><br><span class="line"><span class="function"> &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">Multiple</span> <span class="title">inheritance</span> <span class="title">is</span> <span class="title">possible</span>. <span class="title">Note</span> <span class="title">that</span> &quot;<span class="title">owned</span>&quot; <span class="title">is</span></span></span><br><span class="line"><span class="function">// <span class="title">also</span> <span class="title">a</span> <span class="title">base</span> <span class="title">class</span> <span class="title">of</span> &quot;<span class="title">mortal</span>&quot;, <span class="title">yet</span> <span class="title">there</span> <span class="title">is</span> <span class="title">only</span> <span class="title">a</span> <span class="title">single</span></span></span><br><span class="line"><span class="function">// <span class="title">instance</span> <span class="title">of</span> &quot;<span class="title">owned</span>&quot; (<span class="params">as for virtual inheritance in C++</span>).</span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">named</span> <span class="title">is</span> <span class="title">owned</span>, <span class="title">mortal</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">named</span>(<span class="params">bytes32 name</span>) </span>&#123;</span><br><span class="line">        Config config = Config(<span class="number">0xd5f9d8d94886e70b06e474c3fb14fd43e2f23970</span>);</span><br><span class="line">        NameReg(config.lookup(<span class="number">1</span>)).register(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Functions can be overridden by another function with the same name and</span></span><br><span class="line">    <span class="comment">// the same number/types of inputs.  If the overriding function has different</span></span><br><span class="line">    <span class="comment">// types of output parameters, that causes an error.</span></span><br><span class="line">    <span class="comment">// Both local and message-based function calls take these overrides</span></span><br><span class="line">    <span class="comment">// into account.</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">kill</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.sender == owner) &#123;</span><br><span class="line">            Config config = Config(<span class="number">0xd5f9d8d94886e70b06e474c3fb14fd43e2f23970</span>);</span><br><span class="line">            NameReg(config.lookup(<span class="number">1</span>)).unregister();</span><br><span class="line">            <span class="comment">// It is still possible to call a specific</span></span><br><span class="line">            <span class="comment">// overridden function.</span></span><br><span class="line">            mortal.kill();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// If a constructor takes an argument, it needs to be</span></span><br><span class="line"><span class="comment">// provided in the header (or modifier-invocation-style at</span></span><br><span class="line"><span class="comment">// the constructor of the derived contract (see below)).</span></span><br><span class="line">contract PriceFeed is owned, mortal, named(<span class="string">&quot;GoldFeed&quot;</span>) &#123;</span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">updateInfo</span>(<span class="params">uint newInfo</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (msg.sender == owner) info = newInfo;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span>) <span class="title">constant</span> <span class="title">returns</span>(<span class="params">uint r</span>) </span>&#123; <span class="keyword">return</span> info; &#125;</span><br><span class="line"></span><br><span class="line">   uint info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="基类构造器的方法"><a href="#基类构造器的方法" class="headerlink" title="基类构造器的方法"></a>基类构造器的方法</h3><p>派生的合约需要提供所有父合约需要的所有参数，所以用两种方式来做，见下面的例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Base &#123;</span><br><span class="line">    uint x;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Base</span>(<span class="params">uint _x</span>) </span>&#123; x = _x; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract Derived is Base(<span class="number">7</span>) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Derived</span>(<span class="params">uint _y</span>) <span class="title">Base</span>(<span class="params">_y * _y</span>) </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者直接在继承列表中使用is Base(7)，或像修改器(modifier)使用方式一样，做为派生构造器定义头的一部分Base(_y * _y)。第一种方式对于构造器是常量的情况比较方便，可以大概说明合约的行为。第二种方式适用于构造的参数值由派生合约的指定的情况。在上述两种都用的情况下，第二种方式优先(一般情况只用其中一种方式就好了)。</p>
<h3 id="继承有相同名字的不同类型成员"><a href="#继承有相同名字的不同类型成员" class="headerlink" title="继承有相同名字的不同类型成员"></a>继承有相同名字的不同类型成员</h3><p>当继承最终导致一个合约同时存在多个相同名字的修改器或函数，它将被视为一个错误。同新的如果事件与修改器重名，或者函数与事件重名都将产生错误。作为一个例外，状态变量的getter可以覆盖一个public的函数。</p>
<h2 id="抽象-Abstract-Contracts"><a href="#抽象-Abstract-Contracts" class="headerlink" title="抽象(Abstract Contracts)"></a>抽象(Abstract Contracts)</h2><p>抽象函数是没有函数体的的函数。如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Feline &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">utterance</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">bytes32</span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这样的合约不能通过编译，即使合约内也包含一些正常的函数。但它们可以做为基合约被继承。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Feline &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">utterance</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">bytes32</span>);</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">function</span> <span class="title">getContractName</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">string</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Feline&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract Cat is Feline &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">utterance</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">bytes32</span>) </span>&#123; <span class="keyword">return</span> <span class="string">&quot;miaow&quot;</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果一个合约从一个抽象合约里继承，但却没实现所有函数，那么它也是一个抽象合约。</p>
<h2 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h2><p>接口与抽象合约类似，与之不同的是，接口内没有任何函数是已实现的，同时还有如下限制：</p>
<ul>
<li>不能继承其它合约，或接口。</li>
<li>不能定义构造器</li>
<li>不能定义变量</li>
<li>不能定义结构体</li>
<li>不能定义枚举类</li>
<li>其中的一些限制可能在未来放开。</li>
</ul>
<p>接口基本上限制为合约ABI定义可以表示的内容，ABI和接口定义之间的转换应该是可能的，不会有任何信息丢失。接口用自己的关键词表示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">interface Token &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address recipient, uint amount</span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>

<p>合约可以继承于接口，因为他们可以继承于其它的合约。</p>
<h1 id="Gas优化"><a href="#Gas优化" class="headerlink" title="Gas优化"></a>Gas优化</h1><ul>
<li>结构体中尽量使用uint的少位数，且考虑字节对其</li>
<li>“view” 函数不花 “gas”，这是因为 view 函数不会真正改变区块链上的任何数据。如果一个 view 函数在另一个函数的内部被调用，而调用函数与 view 函数的不属于同一个合约，也会产生调用成本。这是因为如果主调函数在以太坊创建了一个事务，它仍然需要逐个节点去验证。所以标记为 view 的函数只有在外部调用时才是免费的(当玩家从web.js外部调用)。</li>
<li>在大多数编程语言中，遍历大数据集合都是昂贵的。但是在 Solidity 中，使用一个标记了external view的函数，遍历比 storage 要便宜太多，因为 view 函数不会产生任何花销。</li>
<li>为了降低成本，不到万不得已，避免将数据写入存储。这也会导致效率低下的编程逻辑：比如每次调用一个函数，都需要在 memory(内存) 中重建一个数组，而不是简单地将上次计算的数组给存储下来以便快速查找。</li>
</ul>
<h1 id="智能合约升级"><a href="#智能合约升级" class="headerlink" title="智能合约升级"></a>智能合约升级</h1><p>将合约进行分离，先部署数据合约，部署后不变。业务合约调用数据合约读取修改数据。保证数据类型不变的情况下，可以对业务合约进行修改，新增。之后部署新的业务合约，废除旧的业务合约。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract DataContract &#123;</span><br><span class="line">    mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint256) public balanceOf;</span><br><span class="line">    mapping (<span class="function"><span class="params">address</span> =&gt;</span> bool) accessAllowed;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">DataContract</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        accessAllowed[msg.sender] = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setBlance</span>(<span class="params">address _address,uint256 v</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        balanceOf[_address] = v;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    modifier platform() &#123;</span><br><span class="line">        <span class="built_in">require</span>(accessAllowed[msg.sender] == <span class="literal">true</span>);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">allowAccess</span>(<span class="params">address _addr</span>) <span class="title">platform</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">        accessAllowed[_addr] = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">denyAccess</span>(<span class="params">address _addr</span>) <span class="title">platform</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">        accessAllowed[_addr] = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract ControlContract &#123;</span><br><span class="line"></span><br><span class="line">    DataContract dataContract;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ControlContract</span>(<span class="params">address _dataContractAddr</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        dataContract = DataContract(_dataContractAddr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">addTen</span>(<span class="params">address addr</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">uint</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dataContract.balanceOf(addr) + <span class="number">11</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>部署方法如下：</p>
<ol>
<li>先部署DataContract合约。</li>
<li>使用DataContract合约地址作为部署ControlContract合约的参数。</li>
<li>用ControlContract合约地址作为参数调用DataContract合约的allowAccess方法。</li>
</ol>
<p>如果需要更新控制合约(如修复了addTen)则重新执行第2-3步，同时对老的控制合约执行denyAccess()。</p>
<h1 id="代币"><a href="#代币" class="headerlink" title="代币"></a>代币</h1><p>一个代币在以太坊上就是一个遵循一些共同规则的智能合约：以太坊代币标准(ERC-Token Standard)。建立在以太坊网络上的区块链项目代币，需要遵从以下几种代币标准：ERC-20，ERC-223，ERC-621，ERC-721，ERC-827。其中 ERC 是 Ethereum Request for Comments 的简称。</p>
<h2 id="ERC-20"><a href="#ERC-20" class="headerlink" title="ERC-20"></a>ERC-20</h2><p>这是最广泛被大家认可的一种代币形式，简单的列举一些通用的标准函数：</p>
<ul>
<li>function totalSupply() 定义 Token 的总量；</li>
<li>function balanceOf(address tokenOwner) 显示用户账户余额；</li>
<li>function allowance(address tokenOwner, address spender) 返回剩余金额，显示 address spender 能从 address tokenOwner 里提取的数量；</li>
<li>function transfer(address to, uint tokens) 转移对应的金额到指定地址；</li>
<li>function approve(address spender, uint tokens)  returns (bool success) 允许  address spender 提取部分 Token；</li>
<li>function transferFrom(address from, address to, uint tokens) returns (bool success) 从一个地址转移 token 到另一个地址；</li>
</ul>
<p>拥有以上所有必要的函数实现我们称为兼容 ERC-20 标准，但在具体实现中会做一些扩展，比如 ERC-223。</p>
<h2 id="ERC-223"><a href="#ERC-223" class="headerlink" title="ERC-223"></a>ERC-223</h2><p>这个标准支持所有 ERC-20 的函数、智能合约以及服务，并解决了一些 ERC-20 的缺陷，比如说：在 ERC-20 标准下如果你输入了错误的收款地址，你转账的费用可能会永远丢失，但在 ERC-223 里这个问题被避免了，同时在这个标准下你需要消耗的 GAS 费用只有 ERC-20 的一半。</p>
<h2 id="ERC-621"><a href="#ERC-621" class="headerlink" title="ERC-621"></a>ERC-621</h2><p>ERC-621 也是一个基于 ERC-20 升级的标准，解决了 ERC-20 不允许 Token 总量更改的问题，不过为了解决这个问题，ERC-621 增加了两种新的函数：</p>
<p>increaseSupply 和 decreaseSupply</p>
<h2 id="ERC-827"><a href="#ERC-827" class="headerlink" title="ERC-827"></a>ERC-827</h2><p>这个标准比 ERC-20 更加灵活，除用于转账外，还可以转移数据和让第三方在获取用户允许的情况下为用户转账。</p>
<h2 id="ERC-721"><a href="#ERC-721" class="headerlink" title="ERC-721"></a>ERC-721</h2><p>ERC-721 与 ERC-20 有很大的区别，如果说 ERC-20 与 ERC-223，ERC-621 能够在使用中自由转换的话，ERC-721 是不可与 ERC-20 Token 互相转换的，因为 ERC-721 拥有唯一性。这种 Token 依然可以在交易所里交易，只不过无法分割是一个独立的整体。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">contract ERC721 &#123;</span><br><span class="line">  event Transfer(address indexed _from, address indexed _to, uint256 _tokenId);</span><br><span class="line">  event Approval(address indexed _owner, address indexed _approved, uint256 _tokenId);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address _owner</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint256 _balance</span>);</span></span><br><span class="line"><span class="function">  <span class="title">function</span> <span class="title">ownerOf</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">address _owner</span>);</span></span><br><span class="line"><span class="function">  <span class="title">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span>;</span></span><br><span class="line"><span class="function">  <span class="title">function</span> <span class="title">approve</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span>;</span></span><br><span class="line"><span class="function">  <span class="title">function</span> <span class="title">takeOwnership</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span>;</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>

<p>ERC721 规范有两种不同的方法来转移代币：</p>
<ol>
<li>第一种方法是代币的拥有者调用transfer 方法，传入他想转移到的 address 和他想转移的代币的 _tokenId。</li>
<li>第二种方法是代币拥有者首先调用 approve，然后传入与以上相同的参数。接着，该合约会存储谁被允许提取代币，通常存储到一个 mapping (uint256 =&gt; address) 里。然后，当有人调用 takeOwnership 时，合约会检查 msg.sender 是否得到拥有者的批准来提取代币，如果是，则将代币转移给他。<ul>
<li>所有者，用新主人的 address 和你希望他获取的 _tokenId 来调用 approve</li>
<li>新主人用 _tokenId 来调用 takeOwnership，合约会检查确保他获得了批准，然后把代币转移给他。</li>
</ul>
</li>
</ol>
<h1 id="库"><a href="#库" class="headerlink" title="库"></a>库</h1><h2 id="Ownable"><a href="#Ownable" class="headerlink" title="Ownable"></a>Ownable</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title <span class="variable">Ownable</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dev </span>The Ownable contract has an owner address, and provides basic authorization control</span></span><br><span class="line"><span class="comment"> * functions, this simplifies the implementation of &quot;user permissions&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract Ownable &#123;</span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  event OwnershipTransferred(address indexed previousOwner, address indexed newOwner);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@dev </span>The Ownable constructor sets the original `owner` of the contract to the sender</span></span><br><span class="line"><span class="comment">   * account.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Ownable</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@dev </span>Throws if called by any account other than the owner.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  modifier onlyOwner() &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.sender == owner);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@dev </span>Allows the current owner to transfer control of the contract to a newOwner.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param </span>newOwner The address to transfer ownership to.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transferOwnership</span>(<span class="params">address newOwner</span>) <span class="title">public</span> <span class="title">onlyOwner</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(newOwner != address(<span class="number">0</span>));</span><br><span class="line">    OwnershipTransferred(owner, newOwner);</span><br><span class="line">    owner = newOwner;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SafeMath"><a href="#SafeMath" class="headerlink" title="SafeMath"></a>SafeMath</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">library SafeMath &#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">mul</span>(<span class="params">uint256 a, uint256 b</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    uint256 c = a * b;</span><br><span class="line">    assert(c / a == b);</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">div</span>(<span class="params">uint256 a, uint256 b</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// assert(b &gt; 0); // Solidity automatically throws when dividing by 0</span></span><br><span class="line">    uint256 c = a / b;</span><br><span class="line">    <span class="comment">// assert(a == b * c + a % b); // There is no case in which this doesn&#x27;t hold</span></span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sub</span>(<span class="params">uint256 a, uint256 b</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">    assert(b &lt;= a);</span><br><span class="line">    <span class="keyword">return</span> a - b;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">uint256 a, uint256 b</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">    uint256 c = a + b;</span><br><span class="line">    assert(c &gt;= a);</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SafeMath 库允许使用 using 关键字，它可以自动把库的所有方法添加给一个数据类型：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">using SafeMath <span class="keyword">for</span> uint;</span><br><span class="line"><span class="comment">// 这下我们可以为任何 uint 调用这些方法了</span></span><br><span class="line">uint test = <span class="number">2</span>;</span><br><span class="line">test = test.mul(<span class="number">3</span>); <span class="comment">// test 等于 6 了</span></span><br><span class="line">test = test.add(<span class="number">5</span>); <span class="comment">// test 等于 11 了</span></span><br></pre></td></tr></table></figure>

<p>所以简而言之， SafeMath 的 add， sub， mul， 和 div 方法只做简单的四则运算，然后在发生溢出或下溢的时候抛出错误。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/12/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><span class="page-number current">13</span><a class="page-number" href="/page/14/">14</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" href="/page/14/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="苍耳叔叔"
      src="/images/head.png">
  <p class="site-author-name" itemprop="name">苍耳叔叔</p>
  <div class="site-description" itemprop="description">梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">168</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">100</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ljd1996" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ljd1996" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hearing1996@gmail.com" title="E-Mail → mailto:hearing1996@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">苍耳叔叔</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : true,
      notify     : true,
      appId      : 'pCnIlzs46HJGpubm7D3TnrBC-gzGzoHsz',
      appKey     : '7LzW4wBI9lY5DtVFNkFWcjs0',
      placeholder: "欢迎评论交流！",
      avatar     : 'robohash',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
