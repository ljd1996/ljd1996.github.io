<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
<meta property="og:type" content="website">
<meta property="og:title" content="苍耳的博客">
<meta property="og:url" content="http://yoursite.com/page/13/index.html">
<meta property="og:site_name" content="苍耳的博客">
<meta property="og:description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="苍耳叔叔">
<meta property="article:tag" content="诗歌，宋词，后台，Android，Java">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/13/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>苍耳的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">苍耳的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">细水长流</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/28/%E4%BB%A5%E5%A4%AA%E5%9D%8ADApp%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/28/%E4%BB%A5%E5%A4%AA%E5%9D%8ADApp%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">以太坊DApp实战笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-28 18:51:00" itemprop="dateCreated datePublished" datetime="2018-12-28T18:51:00+08:00">2018-12-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/" itemprop="url" rel="index"><span itemprop="name">区块链</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/%E4%BB%A5%E5%A4%AA%E5%9D%8A/" itemprop="url" rel="index"><span itemprop="name">以太坊</span></a>
                </span>
            </span>

          
            <span id="/2018/12/28/%E4%BB%A5%E5%A4%AA%E5%9D%8ADApp%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="以太坊DApp实战笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2018/12/28/%E4%BB%A5%E5%A4%AA%E5%9D%8ADApp%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018/12/28/%E4%BB%A5%E5%A4%AA%E5%9D%8ADApp%E5%AE%9E%E6%88%98%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h1><h2 id="编写合约"><a href="#编写合约" class="headerlink" title="编写合约"></a>编写合约</h2><p>hello.sol:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.5</span><span class="number">.2</span>;</span><br><span class="line"></span><br><span class="line">contract InfoContract &#123;</span><br><span class="line"></span><br><span class="line">   string fName;</span><br><span class="line">   uint age;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">setInfo</span>(<span class="params">string memory _fName, uint _age</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">       fName = _fName;</span><br><span class="line">       age = _age;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">getInfo</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">string memory, uint</span>) </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> (fName, age);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="编译合约"><a href="#编译合约" class="headerlink" title="编译合约"></a>编译合约</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">solcjs hello.sol --abi --bin -o ./</span><br></pre></td></tr></table></figure>

<p>生成hello_sol_InfoContract.abi和hello_sol_InfoContract.bin文件。</p>
<h2 id="生成合约的Java文件"><a href="#生成合约的Java文件" class="headerlink" title="生成合约的Java文件"></a>生成合约的Java文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web3j solidity generate --solidityTypes -b hello_sol_hello.bin -a hello_sol_hello.abi -o ./ -p com.test</span><br></pre></td></tr></table></figure>

<p>将生成的Java问价导入到项目中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hello</span> <span class="keyword">extends</span> <span class="title">Contract</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String BINARY = <span class="string">&quot;608060405234801561001057600080fd5b50610346806100206000396000f3fe608060405234801561001057600080fd5b5060043610610053576000357c0100000000000000000000000000000000000000000000000000000000900480635a9b0b89146100585780638262963b146100e2575b600080fd5b6100606101a7565b6040518080602001838152602001828103825284818151815260200191508051906020019080838360005b838110156100a657808201518184015260208101905061008b565b50505050905090810190601f1680156100d35780820380516001836020036101000a031916815260200191505b50935050505060405180910390f35b6101a5600480360360408110156100f857600080fd5b810190808035906020019064010000000081111561011557600080fd5b82018360208201111561012757600080fd5b8035906020019184600183028401116401000000008311171561014957600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f82011690508083019250505050505050919291929080359060200190929190505050610253565b005b6060600080600154818054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156102445780601f1061021957610100808354040283529160200191610244565b820191906000526020600020905b81548152906001019060200180831161022757829003601f168201915b50505050509150915091509091565b8160009080519060200190610269929190610275565b50806001819055505050565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106102b657805160ff19168380011785556102e4565b828001600101855582156102e4579182015b828111156102e35782518255916020019190600101906102c8565b5b5090506102f191906102f5565b5090565b61031791905b808211156103135760008160009055506001016102fb565b5090565b9056fea165627a7a7230582007c004e4d5d896b794dd7a63a8b6bdd16e95744ed1d0aa3c5b0eb8c4c7590e250029&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FUNC_GETINFO = <span class="string">&quot;getInfo&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FUNC_SETINFO = <span class="string">&quot;setInfo&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">Hello</span><span class="params">(String contractAddress, Web3j web3j, Credentials credentials, BigInteger gasPrice, BigInteger gasLimit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(BINARY, contractAddress, web3j, credentials, gasPrice, gasLimit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">Hello</span><span class="params">(String contractAddress, Web3j web3j, Credentials credentials, ContractGasProvider contractGasProvider)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(BINARY, contractAddress, web3j, credentials, contractGasProvider);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">Hello</span><span class="params">(String contractAddress, Web3j web3j, TransactionManager transactionManager, BigInteger gasPrice, BigInteger gasLimit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(BINARY, contractAddress, web3j, transactionManager, gasPrice, gasLimit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">Hello</span><span class="params">(String contractAddress, Web3j web3j, TransactionManager transactionManager, ContractGasProvider contractGasProvider)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(BINARY, contractAddress, web3j, transactionManager, contractGasProvider);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RemoteCall&lt;Tuple2&lt;Utf8String, Uint256&gt;&gt; getInfo() &#123;</span><br><span class="line">        <span class="keyword">final</span> Function function = <span class="keyword">new</span> Function(FUNC_GETINFO, </span><br><span class="line">                Arrays.&lt;Type&gt;asList(), </span><br><span class="line">                Arrays.&lt;TypeReference&lt;?&gt;&gt;asList(<span class="keyword">new</span> TypeReference&lt;Utf8String&gt;() &#123;&#125;, <span class="keyword">new</span> TypeReference&lt;Uint256&gt;() &#123;&#125;));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RemoteCall&lt;Tuple2&lt;Utf8String, Uint256&gt;&gt;(</span><br><span class="line">                <span class="keyword">new</span> Callable&lt;Tuple2&lt;Utf8String, Uint256&gt;&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Tuple2&lt;Utf8String, Uint256&gt; <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                        List&lt;Type&gt; results = executeCallMultipleValueReturn(function);</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;Utf8String, Uint256&gt;(</span><br><span class="line">                                (Utf8String) results.get(<span class="number">0</span>), </span><br><span class="line">                                (Uint256) results.get(<span class="number">1</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RemoteCall&lt;TransactionReceipt&gt; <span class="title">setInfo</span><span class="params">(Utf8String _fName, Uint256 _age)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Function function = <span class="keyword">new</span> Function(</span><br><span class="line">                FUNC_SETINFO, </span><br><span class="line">                Arrays.&lt;Type&gt;asList(_fName, _age), </span><br><span class="line">                Collections.&lt;TypeReference&lt;?&gt;&gt;emptyList());</span><br><span class="line">        <span class="keyword">return</span> executeRemoteCallTransaction(function);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Hello <span class="title">load</span><span class="params">(String contractAddress, Web3j web3j, Credentials credentials, BigInteger gasPrice, BigInteger gasLimit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Hello(contractAddress, web3j, credentials, gasPrice, gasLimit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Hello <span class="title">load</span><span class="params">(String contractAddress, Web3j web3j, TransactionManager transactionManager, BigInteger gasPrice, BigInteger gasLimit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Hello(contractAddress, web3j, transactionManager, gasPrice, gasLimit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Hello <span class="title">load</span><span class="params">(String contractAddress, Web3j web3j, Credentials credentials, ContractGasProvider contractGasProvider)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Hello(contractAddress, web3j, credentials, contractGasProvider);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Hello <span class="title">load</span><span class="params">(String contractAddress, Web3j web3j, TransactionManager transactionManager, ContractGasProvider contractGasProvider)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Hello(contractAddress, web3j, transactionManager, contractGasProvider);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RemoteCall&lt;Hello&gt; <span class="title">deploy</span><span class="params">(Web3j web3j, Credentials credentials, ContractGasProvider contractGasProvider)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> deployRemoteCall(Hello.class, web3j, credentials, contractGasProvider, BINARY, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RemoteCall&lt;Hello&gt; <span class="title">deploy</span><span class="params">(Web3j web3j, Credentials credentials, BigInteger gasPrice, BigInteger gasLimit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> deployRemoteCall(Hello.class, web3j, credentials, gasPrice, gasLimit, BINARY, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RemoteCall&lt;Hello&gt; <span class="title">deploy</span><span class="params">(Web3j web3j, TransactionManager transactionManager, ContractGasProvider contractGasProvider)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> deployRemoteCall(Hello.class, web3j, transactionManager, contractGasProvider, BINARY, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RemoteCall&lt;Hello&gt; <span class="title">deploy</span><span class="params">(Web3j web3j, TransactionManager transactionManager, BigInteger gasPrice, BigInteger gasLimit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> deployRemoteCall(Hello.class, web3j, transactionManager, gasPrice, gasLimit, BINARY, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="获取钱包"><a href="#获取钱包" class="headerlink" title="获取钱包"></a>获取钱包</h2><h3 id="1-创建新钱包"><a href="#1-创建新钱包" class="headerlink" title="1. 创建新钱包"></a>1. 创建新钱包</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 创建新的钱包(钱包余额为0)</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> password: 钱包的密码(不是私钥)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> path: 钱包文件的路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> NoSuchAlgorithmException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> NoSuchProviderException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> InvalidAlgorithmParameterException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> CipherException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Credentials <span class="title">genCredentials</span><span class="params">(String password, String path)</span> <span class="keyword">throws</span> NoSuchAlgorithmException,</span></span><br><span class="line"><span class="function">        NoSuchProviderException, InvalidAlgorithmParameterException, CipherException, IOException </span>&#123;</span><br><span class="line">    String fileName = WalletUtils.generateNewWalletFile(password,</span><br><span class="line">            <span class="keyword">new</span> File(path), <span class="keyword">false</span>);</span><br><span class="line">    <span class="keyword">return</span> WalletUtils.loadCredentials(password, path + <span class="string">&quot;/&quot;</span> + fileName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-获取现有钱包"><a href="#2-获取现有钱包" class="headerlink" title="2. 获取现有钱包"></a>2. 获取现有钱包</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取已存在钱包</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> privKey</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Credentials <span class="title">getCredentials</span><span class="params">(String privKey)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Credentials.create(privKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="在项目中获取合约对象"><a href="#在项目中获取合约对象" class="headerlink" title="在项目中获取合约对象"></a>在项目中获取合约对象</h2><h3 id="1-部署合约"><a href="#1-部署合约" class="headerlink" title="1. 部署合约"></a>1. 部署合约</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Hello <span class="title">ethDeploy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    Web3j web3 = Web3j.build(<span class="keyword">new</span> HttpService(<span class="string">&quot;http://127.0.0.1:7545&quot;</span>)); <span class="comment">// 区块链客户端地址(ganache, geth等)</span></span><br><span class="line">    Credentials credentials = getCredentials(<span class="string">&quot;e35c46af1701a40df4b86385de0af9078c79cab9fb4e2ce1358b376cc24b0ab3&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> Hello.deploy(web3, credentials, GAS_PRICE, GAS_LIMIT).send();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-加载已部署合约"><a href="#2-加载已部署合约" class="headerlink" title="2. 加载已部署合约"></a>2. 加载已部署合约</h3><p>需要提前将合约部署到区块链中，我使用的是Remix和Ganache的方式模拟。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Hello <span class="title">ethLoad</span><span class="params">(String contractAddress)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    String password = <span class="string">&quot;15927382215&quot;</span>;</span><br><span class="line">    String filePath = <span class="string">&quot;/home/hearing/WorkSpace/eth/test/src/main/resources&quot;</span>;</span><br><span class="line"></span><br><span class="line">    Web3j web3 = Web3j.build(<span class="keyword">new</span> HttpService(<span class="string">&quot;http://127.0.0.1:7545&quot;</span>));</span><br><span class="line">    Credentials credentials = getCredentials(<span class="string">&quot;e35c46af1701a40df4b86385de0af9078c79cab9fb4e2ce1358b376cc24b0ab3&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Hello.load(contractAddress, web3, credentials, GAS_PRICE, GAS_LIMIT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="调用合约"><a href="#调用合约" class="headerlink" title="调用合约"></a>调用合约</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TransactionReceipt receipt = contract.setInfo(<span class="keyword">new</span> Utf8String(<span class="string">&quot;hearing&quot;</span>), <span class="keyword">new</span> Uint256(<span class="number">21</span>)).send();</span><br><span class="line"><span class="keyword">if</span> (receipt.isStatusOK()) &#123;</span><br><span class="line">    Tuple2 tuple2 = contract.getInfo().send();</span><br><span class="line">    System.out.println(tuple2.getValue1());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="CryptoZombie"><a href="#CryptoZombie" class="headerlink" title="CryptoZombie"></a>CryptoZombie</h1><h2 id="erc721-sol"><a href="#erc721-sol" class="headerlink" title="erc721.sol"></a>erc721.sol</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line">contract ERC721 &#123;</span><br><span class="line">  event Transfer(address indexed _from, address indexed _to, uint256 _tokenId);</span><br><span class="line">  event Approval(address indexed _owner, address indexed _approved, uint256 _tokenId);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address _owner</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint256 _balance</span>);</span></span><br><span class="line"><span class="function">  <span class="title">function</span> <span class="title">ownerOf</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">address _owner</span>);</span></span><br><span class="line"><span class="function">  <span class="title">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span>;</span></span><br><span class="line"><span class="function">  <span class="title">function</span> <span class="title">approve</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span>;</span></span><br><span class="line"><span class="function">  <span class="title">function</span> <span class="title">takeOwnership</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span>;</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="safemath-sol"><a href="#safemath-sol" class="headerlink" title="safemath.sol"></a>safemath.sol</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title <span class="variable">SafeMath</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dev </span>Math operations with safety checks that throw on error</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">library SafeMath &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@dev </span>Multiplies two numbers, throws on overflow.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">mul</span>(<span class="params">uint256 a, uint256 b</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    uint256 c = a * b;</span><br><span class="line">    assert(c / a == b);</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@dev </span>Integer division of two numbers, truncating the quotient.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">div</span>(<span class="params">uint256 a, uint256 b</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// assert(b &gt; 0); // Solidity automatically throws when dividing by 0</span></span><br><span class="line">    uint256 c = a / b;</span><br><span class="line">    <span class="comment">// assert(a == b * c + a % b); // There is no case in which this doesn&#x27;t hold</span></span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@dev </span>Substracts two numbers, throws on overflow (i.e. if subtrahend is greater than minuend).</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sub</span>(<span class="params">uint256 a, uint256 b</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">    assert(b &lt;= a);</span><br><span class="line">    <span class="keyword">return</span> a - b;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@dev </span>Adds two numbers, throws on overflow.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">uint256 a, uint256 b</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">    uint256 c = a + b;</span><br><span class="line">    assert(c &gt;= a);</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ownable-sol"><a href="#ownable-sol" class="headerlink" title="ownable.sol"></a>ownable.sol</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title <span class="variable">Ownable</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dev </span>The Ownable contract has an owner address, and provides basic authorization control</span></span><br><span class="line"><span class="comment"> * functions, this simplifies the implementation of &quot;user permissions&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract Ownable &#123;</span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  event OwnershipTransferred(address indexed previousOwner, address indexed newOwner);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@dev </span>The Ownable constructor sets the original `owner` of the contract to the sender</span></span><br><span class="line"><span class="comment">   * account.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Ownable</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@dev </span>Throws if called by any account other than the owner.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  modifier onlyOwner() &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.sender == owner);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@dev </span>Allows the current owner to transfer control of the contract to a newOwner.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param </span>newOwner The address to transfer ownership to.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transferOwnership</span>(<span class="params">address newOwner</span>) <span class="title">public</span> <span class="title">onlyOwner</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(newOwner != address(<span class="number">0</span>));</span><br><span class="line">    OwnershipTransferred(owner, newOwner);</span><br><span class="line">    owner = newOwner;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="zombiefactory-sol"><a href="#zombiefactory-sol" class="headerlink" title="zombiefactory.sol"></a>zombiefactory.sol</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./ownable.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./safemath.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">contract ZombieFactory is Ownable &#123;</span><br><span class="line"></span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line"></span><br><span class="line">  event NewZombie(uint zombieId, string name, uint dna);</span><br><span class="line"></span><br><span class="line">  uint dnaDigits = <span class="number">16</span>;</span><br><span class="line">  uint dnaModulus = <span class="number">10</span> ** dnaDigits;</span><br><span class="line">  uint cooldownTime = <span class="number">1</span> days;</span><br><span class="line"></span><br><span class="line">  struct Zombie &#123;</span><br><span class="line">    string name;</span><br><span class="line">    uint dna;</span><br><span class="line">    uint32 level;</span><br><span class="line">    uint32 readyTime;</span><br><span class="line">    uint16 winCount;</span><br><span class="line">    uint16 lossCount;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  Zombie[] public zombies;</span><br><span class="line"></span><br><span class="line">  mapping (<span class="function"><span class="params">uint</span> =&gt;</span> address) public zombieToOwner;</span><br><span class="line">  mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint) ownerZombieCount;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_createZombie</span>(<span class="params">string _name, uint _dna</span>) <span class="title">internal</span> </span>&#123;</span><br><span class="line">    uint id = zombies.push(Zombie(_name, _dna, <span class="number">1</span>, uint32(now + cooldownTime), <span class="number">0</span>, <span class="number">0</span>)) - <span class="number">1</span>;</span><br><span class="line">    zombieToOwner[id] = msg.sender;</span><br><span class="line">    ownerZombieCount[msg.sender]++;</span><br><span class="line">    NewZombie(id, _name, _dna);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_generateRandomDna</span>(<span class="params">string _str</span>) <span class="title">private</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">    uint rand = uint(keccak256(_str));</span><br><span class="line">    <span class="keyword">return</span> rand % dnaModulus;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">createRandomZombie</span>(<span class="params">string _name</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(ownerZombieCount[msg.sender] == <span class="number">0</span>);</span><br><span class="line">    uint randDna = _generateRandomDna(_name);</span><br><span class="line">    randDna = randDna - randDna % <span class="number">100</span>;</span><br><span class="line">    _createZombie(_name, randDna);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="zombiefeeding-sol"><a href="#zombiefeeding-sol" class="headerlink" title="zombiefeeding.sol"></a>zombiefeeding.sol</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./zombiefactory.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">contract KittyInterface &#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getKitty</span>(<span class="params">uint256 _id</span>) <span class="title">external</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    bool isGestating,</span></span></span><br><span class="line"><span class="function"><span class="params">    bool isReady,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 cooldownIndex,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 nextActionAt,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 siringWithId,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 birthTime,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 matronId,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 sireId,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 generation,</span></span></span><br><span class="line"><span class="function"><span class="params">    uint256 genes</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">ZombieFeeding</span> <span class="title">is</span> <span class="title">ZombieFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  KittyInterface kittyContract;</span><br><span class="line"></span><br><span class="line">  modifier onlyOwnerOf(uint _zombieId) &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.sender == zombieToOwner[_zombieId]);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setKittyContractAddress</span>(<span class="params">address _address</span>) <span class="title">external</span> <span class="title">onlyOwner</span> </span>&#123;</span><br><span class="line">    kittyContract = KittyInterface(_address);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_triggerCooldown</span>(<span class="params">Zombie storage _zombie</span>) <span class="title">internal</span> </span>&#123;</span><br><span class="line">    _zombie.readyTime = uint32(now + cooldownTime);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_isReady</span>(<span class="params">Zombie storage _zombie</span>) <span class="title">internal</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> (_zombie.readyTime &lt;= now);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">feedAndMultiply</span>(<span class="params">uint _zombieId, uint _targetDna, string _species</span>) <span class="title">internal</span> <span class="title">onlyOwnerOf</span>(<span class="params">_zombieId</span>) </span>&#123;</span><br><span class="line">    Zombie storage myZombie = zombies[_zombieId];</span><br><span class="line">    <span class="built_in">require</span>(_isReady(myZombie));</span><br><span class="line">    _targetDna = _targetDna % dnaModulus;</span><br><span class="line">    uint newDna = (myZombie.dna + _targetDna) / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> (keccak256(_species) == keccak256(<span class="string">&quot;kitty&quot;</span>)) &#123;</span><br><span class="line">      newDna = newDna - newDna % <span class="number">100</span> + <span class="number">99</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    _createZombie(<span class="string">&quot;NoName&quot;</span>, newDna);</span><br><span class="line">    _triggerCooldown(myZombie);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">feedOnKitty</span>(<span class="params">uint _zombieId, uint _kittyId</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    uint kittyDna;</span><br><span class="line">    (,,,,,,,,,kittyDna) = kittyContract.getKitty(_kittyId);</span><br><span class="line">    feedAndMultiply(_zombieId, kittyDna, <span class="string">&quot;kitty&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="zombiehelper-sol"><a href="#zombiehelper-sol" class="headerlink" title="zombiehelper.sol"></a>zombiehelper.sol</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./zombiefeeding.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">contract ZombieHelper is ZombieFeeding &#123;</span><br><span class="line"></span><br><span class="line">  uint levelUpFee = <span class="number">0.001</span> ether;</span><br><span class="line"></span><br><span class="line">  modifier aboveLevel(uint _level, uint _zombieId) &#123;</span><br><span class="line">    <span class="built_in">require</span>(zombies[_zombieId].level &gt;= _level);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">withdraw</span>(<span class="params"></span>) <span class="title">external</span> <span class="title">onlyOwner</span> </span>&#123;</span><br><span class="line">    owner.transfer(<span class="built_in">this</span>.balance);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setLevelUpFee</span>(<span class="params">uint _fee</span>) <span class="title">external</span> <span class="title">onlyOwner</span> </span>&#123;</span><br><span class="line">    levelUpFee = _fee;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">levelUp</span>(<span class="params">uint _zombieId</span>) <span class="title">external</span> <span class="title">payable</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.value == levelUpFee);</span><br><span class="line">    zombies[_zombieId].level++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">changeName</span>(<span class="params">uint _zombieId, string _newName</span>) <span class="title">external</span> <span class="title">aboveLevel</span>(<span class="params"><span class="number">2</span>, _zombieId</span>) <span class="title">onlyOwnerOf</span>(<span class="params">_zombieId</span>) </span>&#123;</span><br><span class="line">    zombies[_zombieId].name = _newName;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">changeDna</span>(<span class="params">uint _zombieId, uint _newDna</span>) <span class="title">external</span> <span class="title">aboveLevel</span>(<span class="params"><span class="number">20</span>, _zombieId</span>) <span class="title">onlyOwnerOf</span>(<span class="params">_zombieId</span>) </span>&#123;</span><br><span class="line">    zombies[_zombieId].dna = _newDna;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getZombiesByOwner</span>(<span class="params">address _owner</span>) <span class="title">external</span> <span class="title">view</span> <span class="title">returns</span>(<span class="params">uint[]</span>) </span>&#123;</span><br><span class="line">    uint[] memory result = <span class="keyword">new</span> uint[](ownerZombieCount[_owner]);</span><br><span class="line">    uint counter = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; zombies.length; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (zombieToOwner[i] == _owner) &#123;</span><br><span class="line">        result[counter] = i;</span><br><span class="line">        counter++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="zombieattach-sol"><a href="#zombieattach-sol" class="headerlink" title="zombieattach.sol"></a>zombieattach.sol</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./zombiehelper.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">contract ZombieBattle is ZombieHelper &#123;</span><br><span class="line">  uint randNonce = <span class="number">0</span>;</span><br><span class="line">  uint attackVictoryProbability = <span class="number">70</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">randMod</span>(<span class="params">uint _modulus</span>) <span class="title">internal</span> <span class="title">returns</span>(<span class="params">uint</span>) </span>&#123;</span><br><span class="line">    randNonce++;</span><br><span class="line">    <span class="keyword">return</span> uint(keccak256(now, msg.sender, randNonce)) % _modulus;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">attack</span>(<span class="params">uint _zombieId, uint _targetId</span>) <span class="title">external</span> <span class="title">onlyOwnerOf</span>(<span class="params">_zombieId</span>) </span>&#123;</span><br><span class="line">    Zombie storage myZombie = zombies[_zombieId];</span><br><span class="line">    Zombie storage enemyZombie = zombies[_targetId];</span><br><span class="line">    uint rand = randMod(<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">if</span> (rand &lt;= attackVictoryProbability) &#123;</span><br><span class="line">      myZombie.winCount++;</span><br><span class="line">      myZombie.level++;</span><br><span class="line">      enemyZombie.lossCount++;</span><br><span class="line">      feedAndMultiply(_zombieId, enemyZombie.dna, <span class="string">&quot;zombie&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      myZombie.lossCount++;</span><br><span class="line">      enemyZombie.winCount++;</span><br><span class="line">      _triggerCooldown(myZombie);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="zombieownership-sol"><a href="#zombieownership-sol" class="headerlink" title="zombieownership.sol"></a>zombieownership.sol</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./zombieattack.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./erc721.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./safemath.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// <span class="doctag">TODO:</span> 把这里变成 natspec 标准的注释把</span></span><br><span class="line">contract ZombieOwnership is ZombieAttack, ERC721 &#123;</span><br><span class="line"></span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line"></span><br><span class="line">  mapping (<span class="function"><span class="params">uint</span> =&gt;</span> address) zombieApprovals;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address _owner</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint256 _balance</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ownerZombieCount[_owner];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">ownerOf</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">address _owner</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> zombieToOwner[_tokenId];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_transfer</span>(<span class="params">address _from, address _to, uint256 _tokenId</span>) <span class="title">private</span> </span>&#123;</span><br><span class="line">    ownerZombieCount[_to] = ownerZombieCount[_to].add(<span class="number">1</span>);</span><br><span class="line">    ownerZombieCount[msg.sender] = ownerZombieCount[msg.sender].sub(<span class="number">1</span>);</span><br><span class="line">    zombieToOwner[_tokenId] = _to;</span><br><span class="line">    Transfer(_from, _to, _tokenId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span> <span class="title">onlyOwnerOf</span>(<span class="params">_tokenId</span>) </span>&#123;</span><br><span class="line">    _transfer(msg.sender, _to, _tokenId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">approve</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span> <span class="title">onlyOwnerOf</span>(<span class="params">_tokenId</span>) </span>&#123;</span><br><span class="line">    zombieApprovals[_tokenId] = _to;</span><br><span class="line">    Approval(msg.sender, _to, _tokenId);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">takeOwnership</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(zombieApprovals[_tokenId] == msg.sender);</span><br><span class="line">    address owner = ownerOf(_tokenId);</span><br><span class="line">    _transfer(owner, msg.sender, _tokenId);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Geth-常用命令"><a href="#Geth-常用命令" class="headerlink" title="Geth 常用命令"></a>Geth 常用命令</h1><h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">geth cmd console</span><br></pre></td></tr></table></figure>

<ul>
<li>-–identity：指定节点 ID；</li>
<li>-–rpc：表示开启 HTTP-RPC 服务；</li>
<li>-–rpcport：指定 HTTP-RPC 服务监听端口号（默认为 8545）；</li>
<li>-–datadir：指定区块链数据的存储位置；</li>
<li>-–port：指定和其他节点连接所用的端口号（默认为 30303）；</li>
<li>-–nodiscover：关闭节点发现机制，防止加入有同样初始配置的陌生节点。</li>
</ul>
<h2 id="控制台中的对象"><a href="#控制台中的对象" class="headerlink" title="控制台中的对象"></a>控制台中的对象</h2><p>控制台是一个交互式的JavaScript执行环境，在这里面可以执行JavaScript代码，其中也内置了一些用来操作以太坊的JavaScript对象，可以直接使用这些对象。这些对象主要包括：</p>
<ul>
<li>eth：包含一些跟操作区块链相关的方法；</li>
<li>net：包含一些查看p2p网络状态的方法；</li>
<li>admin：包含一些与管理节点相关的方法；</li>
<li>miner：包含启动&amp;停止挖矿的一些方法；</li>
<li>personal：主要包含一些管理账户的方法；</li>
<li>txpool：包含一些查看交易内存池的方法；</li>
<li>web3：包含了以上对象，还包含一些单位换算的方法。</li>
</ul>
<h2 id="控制台操作"><a href="#控制台操作" class="headerlink" title="控制台操作"></a>控制台操作</h2><p>进入以太坊Javascript Console后，就可以使用里面的内置对象做一些操作，常用命令有：</p>
<ul>
<li>personal.newAccount()：创建账户；</li>
<li>personal.unlockAccount()：解锁账户；</li>
<li>eth.accounts：枚举系统中的账户；</li>
<li>eth.getBalance()：查看账户余额，返回值的单位是 Wei（Wei 是以太坊中最小货币面额单位，类似比特币中的聪，1 ether = 10^18 Wei）；</li>
<li>eth.blockNumber：列出区块总数；</li>
<li>eth.getTransaction()：获取交易；</li>
<li>eth.getBlock()：获取区块；</li>
<li>miner.start()：开始挖矿；</li>
<li>miner.stop()：停止挖矿；</li>
<li>web3.fromWei()：把 wei 转为如下种类的以太坊单位(还有其他代币token单位)；<ul>
<li>kwei/ada</li>
<li>mwei/babbage</li>
<li>gwei/shannon</li>
<li>szabo</li>
<li>finney</li>
<li>ether</li>
<li>kether/grand/einstein</li>
<li>mether</li>
<li>gether</li>
<li>tether</li>
</ul>
</li>
<li>web3.toWei()：把以太坊单位(包含代币单位)转为 wei；</li>
<li>txpool.status：交易池中的状态；</li>
<li>admin.addPeer()：连接到其他节点；</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> web3.fromWei(<span class="string">&quot;425000000000000000000&quot;</span>, <span class="string">&quot;ether&quot;</span>)</span></span><br><span class="line">&quot;425&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> web3.toWei(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;ether&quot;</span>)</span></span><br><span class="line">&quot;1000000000000000000&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 转账：转账必须解锁账户，默认账户无需解锁</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> personal.unlockAccount(user1)</span></span><br><span class="line">Unlock account 0xf09dca9e10f3f1d0adfe9af7beeeb579c1d1dd37</span><br><span class="line">Passphrase: </span><br><span class="line">true</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> eth.accounts</span></span><br><span class="line">[&quot;0xd7ec36444d13cc079eb116b4f2602cffcdc9adee&quot;, &quot;0xf09dca9e10f3f1d0adfe9af7beeeb579c1e7456b3ded2fa250545de4de1&quot;]</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> eth.sendTransaction(&#123;from:<span class="string">&quot;0xd7ec36444d13cc079eb116b4f2602cffcdc9adee&quot;</span>,to:<span class="string">&quot;0xf09dcc1d1dd37&quot;</span>,value:web3.toWei(6,<span class="string">&quot;ether&quot;</span>)&#125;)</span></span><br><span class="line">&quot;0x68dc8f5db24371bbb3acca13ff15f3561cae4a6d8753f62beab1356380211949&quot;</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> eth.getBalance(user1)</span></span><br><span class="line">6000000000000000000</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> eth.getBalance(user0)</span></span><br><span class="line">1.15792089237316195423570985008687907853269984665640564039451584007913129639927e+77</span><br></pre></td></tr></table></figure>

<h1 id="Mist"><a href="#Mist" class="headerlink" title="Mist"></a>Mist</h1><p>Mist是以太坊官方的在线钱包管理工具，通过 Mist 可以很方便的连接上私有网络，从而更好的开发、调试、测试。可以在github上下载。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mist --rpc url</span><br></pre></td></tr></table></figure>

<h1 id="Truffle"><a href="#Truffle" class="headerlink" title="Truffle"></a>Truffle</h1><h2 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h2><ul>
<li>使用 truffle unbox <box-name> 下载任意 truffle boxes。</li>
<li>使用 truffle init 初始化一个不包含智能合约的项目。</li>
</ul>
<p>目录结构：</p>
<ul>
<li>contracts/：合约目录</li>
<li>migrations/：脚本化部署文件</li>
<li>test/：测试智能合约和应用</li>
<li>truffle.js：配置文件</li>
</ul>
<h2 id="编译合约-1"><a href="#编译合约-1" class="headerlink" title="编译合约"></a>编译合约</h2><h3 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">truffle compile</span><br></pre></td></tr></table></figure>

<p>Truffle仅默认编译自上次编译后被修改过的文件，来减少不必要的编译。如果你想编译全部文件，可以使用–compile-all选项。</p>
<h3 id="约定"><a href="#约定" class="headerlink" title="约定"></a>约定</h3><p>Truffle需要定义的合约名称和文件名准确匹配。举例来说，如果文件名为MyContract.sol，那么合约文件须为如下两者之一：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">contract MyContract &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// or</span></span><br><span class="line">library MyContract &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种匹配是区分大小写的，也就是说大小写也要一致，推荐大写每一个开头字母。</p>
<h2 id="移植"><a href="#移植" class="headerlink" title="移植"></a>移植</h2><h3 id="命令-1"><a href="#命令-1" class="headerlink" title="命令"></a>命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">truffle migrate</span><br></pre></td></tr></table></figure>

<p>这个命令会执行所有的位于migrations目录内的移植脚本。如果你之前的移植是成功执行的。truffle migrate仅会执行新创建的移植。如果没有新的移植脚本，这个命令不同执行任何操作。可以使用选项–reset来从头执行移植脚本。</p>
<h3 id="移植脚本文件"><a href="#移植脚本文件" class="headerlink" title="移植脚本文件"></a>移植脚本文件</h3><p>一个样例文件如下：4_example_migration.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">deployer</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// deployment steps</span></span><br><span class="line">  deployer.deploy(MyContract);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>移植js里的exports的函数接受一个deployer对象作为第一个参数。这个对象用于发布过程，提供了一个清晰的语法支持，同时提供一些通过的合约部署职责，比如保存发布的文件以备稍后使用。deployer对象是用来缓存(stage)发布任务的主要操作接口。</p>
<h3 id="初始移植"><a href="#初始移植" class="headerlink" title="初始移植"></a>初始移植</h3><p>Truffle需要一个移植合约来使用移植特性。这个合约内需要指定的接口，但你可以按你的意味修改合约。对大多数工程来说，这个合约会在第一次移植时进行的第一次部署，后续都不会再更新。通过truffle init创建一个全新工程时，你会获得一个默认的合约。</p>
<p>文件名:contracts/Migration.sol:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">contract Migrations &#123;</span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// A function with the signature `last_completed_migration()`, returning a uint, is required.</span></span><br><span class="line">  uint public last_completed_migration;</span><br><span class="line"></span><br><span class="line">  modifier restricted() &#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.sender == owner) _</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Migrations</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// A function with the signature `setCompleted(uint)` is required.</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setCompleted</span>(<span class="params">uint completed</span>) <span class="title">restricted</span> </span>&#123;</span><br><span class="line">    last_completed_migration = completed;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">upgrade</span>(<span class="params">address new_address</span>) <span class="title">restricted</span> </span>&#123;</span><br><span class="line">    Migrations upgraded = Migrations(new_address);</span><br><span class="line">    upgraded.setCompleted(last_completed_migration);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果你想使用移植特性，你必须在你第一次部署合约时，部署这个合约。可以使用如下方式来创建一次移植。</p>
<p>文件名：migrations/1_initial_migrations.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">deployer</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Deploy the Migrations contract as our only task</span></span><br><span class="line">  deployer.deploy(Migrations);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>由此，你可以接着创建递增的数字前缀来部署其它合约。</p>
<h3 id="部署器-deployer"><a href="#部署器-deployer" class="headerlink" title="部署器(deployer)"></a>部署器(deployer)</h3><p>你的移植文件会使用部署器来缓存部署任务。所以，你可以按一定顺序排列发布任务，他们会按正确顺序执行。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Stage deploying A before B</span></span><br><span class="line">deployer.deploy(A);</span><br><span class="line">deployer.deploy(B);</span><br></pre></td></tr></table></figure>

<p>另一选中可选的部署方式是使用Promise。将部署任务做成一个队列，是否部署依赖于前一个合约的执行情况。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Deploy A, then deploy B, passing in A&#x27;s newly deployed address</span></span><br><span class="line">deployer.deploy(A).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> deployer.deploy(B, A.address);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>如果你想更清晰，你也可以选择实现一个Promise链。</p>
<h3 id="网络相关"><a href="#网络相关" class="headerlink" title="网络相关"></a>网络相关</h3><p>要实现不同条件的不同部署步骤，移植代码中需要第二个参数network。示例如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">deployer, network</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Add demo data if we&#x27;re not deploying to the live network.</span></span><br><span class="line">  <span class="keyword">if</span> (network != <span class="string">&quot;live&quot;</span>) &#123;</span><br><span class="line">    deployer.exec(<span class="string">&quot;add_demo_data.js&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="移植到truffle开发环境"><a href="#移植到truffle开发环境" class="headerlink" title="移植到truffle开发环境"></a>移植到truffle开发环境</h3><p>truffle有内置的私有连用于测试，这是电脑上的本地网络。使用如下命令创建私有连并与其交互：<code>truffle develop</code>。在 truffle 交互控制台中，可以省略 truffle 前缀，例如可以直接使用 compile 。 </p>
<h3 id="移植到-Ganache"><a href="#移植到-Ganache" class="headerlink" title="移植到 Ganache"></a>移植到 Ganache</h3><p>在truffle配置文件中配置：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  networks: &#123;</span><br><span class="line">    development: &#123;</span><br><span class="line">      host: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">      port: <span class="number">7545</span>,</span><br><span class="line">      network_id: <span class="string">&quot;*&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">truffle migrate</span><br></pre></td></tr></table></figure>

<h1 id="ICO-示例"><a href="#ICO-示例" class="headerlink" title="ICO 示例"></a>ICO 示例</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity <span class="number">0.4</span><span class="number">.20</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 一个简单的代币合约。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> contract token &#123;</span><br><span class="line"></span><br><span class="line">     string public standard = <span class="string">&#x27;yuyangray&#x27;</span>;</span><br><span class="line">     string public name; <span class="comment">//代币名称</span></span><br><span class="line">     string public symbol; <span class="comment">//代币符号比如&#x27;$&#x27;</span></span><br><span class="line">    <span class="comment">//代币单位，展示的小数点后面多少个0,和以太币一样后面是是18个0</span></span><br><span class="line">     uint8 public decimals = <span class="number">2</span>;  </span><br><span class="line"></span><br><span class="line">     uint256 public totalSupply; <span class="comment">//代币总量</span></span><br><span class="line">    <span class="comment">/* 这里每个地址对应的是代币的数量，而不是捐赠的以太币的数量 */</span></span><br><span class="line">     mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint256) public balanceOf;</span><br><span class="line"></span><br><span class="line">     event Transfer(address indexed <span class="keyword">from</span>, address indexed to, uint256 value);  <span class="comment">//转帐通知事件</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="comment">/* 初始化合约，并且把初始的所有代币都给这合约的创建者</span></span><br><span class="line"><span class="comment">      * @param _owned 合约的管理者</span></span><br><span class="line"><span class="comment">      * @param tokenName 代币名称</span></span><br><span class="line"><span class="comment">      * @param tokenSymbol 代币符号</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     <span class="function"><span class="keyword">function</span> <span class="title">token</span>(<span class="params">address _owned, string tokenName, string tokenSymbol</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">         <span class="comment">//合约的管理者获得的代币总量</span></span><br><span class="line">         balanceOf[_owned] = totalSupply;</span><br><span class="line"></span><br><span class="line">         name = tokenName;</span><br><span class="line">         symbol = tokenSymbol;</span><br><span class="line"></span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 转帐，具体可以根据自己的需求来实现</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param  </span>_to address 接受代币的地址</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param  </span>_value uint256 接受代币的数量</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint256 _value</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">       <span class="comment">//从发送者减掉发送额</span></span><br><span class="line">       balanceOf[msg.sender] -= _value;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//给接收者加上相同的量</span></span><br><span class="line">       balanceOf[_to] += _value;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//通知任何监听该交易的客户端</span></span><br><span class="line">       Transfer(msg.sender, _to, _value);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">      * 增加代币，并将代币发送给捐赠新用户</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param  </span>_to address 接受代币的地址</span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param  </span>_amount uint256 接受代币的数量</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">     <span class="function"><span class="keyword">function</span> <span class="title">issue</span>(<span class="params">address _to, uint256 _amount</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">         totalSupply = totalSupply + _amount;</span><br><span class="line">         balanceOf[_to] += _amount;</span><br><span class="line"></span><br><span class="line">         <span class="comment">//通知任何监听该交易的客户端</span></span><br><span class="line">         Transfer(<span class="built_in">this</span>, _to, _amount);</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 众筹合约</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract Crowdsale is token &#123;</span><br><span class="line">    address public beneficiary = msg.sender; <span class="comment">//受益人地址，测试时为合约创建者</span></span><br><span class="line">    uint public fundingGoal;  <span class="comment">//众筹目标，单位是ether</span></span><br><span class="line">    uint public amountRaised; <span class="comment">//已筹集金额数量， 单位是ether</span></span><br><span class="line">    uint public deadline; <span class="comment">//截止时间</span></span><br><span class="line">    uint public price;  <span class="comment">//代币价格</span></span><br><span class="line">    bool public fundingGoalReached = <span class="literal">false</span>;  <span class="comment">//达成众筹目标</span></span><br><span class="line">    bool public crowdsaleClosed = <span class="literal">false</span>; <span class="comment">//众筹关闭</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint256) public balance; <span class="comment">//保存众筹地址及对应的以太币数量</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 受益人将众筹金额转走的通知</span></span><br><span class="line">    event GoalReached(address _beneficiary, uint _amountRaised);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用来记录众筹资金变动的通知，_isContribution表示是否是捐赠，因为有可能是捐赠者退出或发起者转移众筹资金</span></span><br><span class="line">    event FundTransfer(address _backer, uint _amount, bool _isContribution);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化构造函数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>fundingGoalInEthers 众筹以太币总量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>durationInMinutes 众筹截止,单位是分钟</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>tokenName 代币名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>tokenSymbol 代币符号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Crowdsale</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        uint fundingGoalInEthers,</span></span></span><br><span class="line"><span class="function"><span class="params">        uint durationInMinutes,</span></span></span><br><span class="line"><span class="function"><span class="params">        string tokenName,</span></span></span><br><span class="line"><span class="function"><span class="params">        string tokenSymbol</span></span></span><br><span class="line"><span class="function"><span class="params">    </span>) <span class="title">token</span>(<span class="params">this, tokenName, tokenSymbol</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        fundingGoal = fundingGoalInEthers * <span class="number">1</span> ether;</span><br><span class="line">        deadline = now + durationInMinutes * <span class="number">1</span> minutes;</span><br><span class="line">        price = <span class="number">500</span> finney; <span class="comment">//1个以太币可以买 2 个代币</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认函数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 默认函数，可以向合约直接打款</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="title">payable</span> <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//判断是否关闭众筹</span></span><br><span class="line">        <span class="built_in">require</span>(!crowdsaleClosed);</span><br><span class="line">        uint amount = msg.value;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//捐款人的金额累加</span></span><br><span class="line">        balance[msg.sender] += amount;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//捐款总额累加</span></span><br><span class="line">        amountRaised += amount;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//转帐操作，转多少代币给捐款人</span></span><br><span class="line">        issue(msg.sender, amount / price * <span class="number">10</span> ** uint256(decimals));</span><br><span class="line">        FundTransfer(msg.sender, amount, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断是否已经过了众筹截止限期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    modifier afterDeadline() &#123; <span class="keyword">if</span> (now &gt;= deadline) _; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 检测众筹目标是否已经达到</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">checkGoalReached</span>(<span class="params"></span>) <span class="title">afterDeadline</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (amountRaised &gt;= fundingGoal)&#123;</span><br><span class="line">            <span class="comment">//达成众筹目标</span></span><br><span class="line">            fundingGoalReached = <span class="literal">true</span>;</span><br><span class="line">            GoalReached(beneficiary, amountRaised);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//关闭众筹</span></span><br><span class="line">        crowdsaleClosed = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 收回资金</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 检查是否达到了目标或时间限制，如果有，并且达到了资金目标，</span></span><br><span class="line"><span class="comment">     * 将全部金额发送给受益人。如果没有达到目标，每个贡献者都可以退出</span></span><br><span class="line"><span class="comment">     * 他们贡献的金额</span></span><br><span class="line"><span class="comment">     * 注：这里代码应该是限制了众筹时间结束且众筹目标没有达成的情况下才允许退出。如果去掉限制条件afterDeadline，应该是可以允许众筹时间还未到且众筹目标没有达成的情况下退出</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">safeWithdrawal</span>(<span class="params"></span>) <span class="title">afterDeadline</span> <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果没有达成众筹目标</span></span><br><span class="line">        <span class="keyword">if</span> (!fundingGoalReached) &#123;</span><br><span class="line">            <span class="comment">//获取合约调用者已捐款余额</span></span><br><span class="line">            uint amount = balance[msg.sender];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (amount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">//返回合约发起者所有余额</span></span><br><span class="line">                msg.sender.transfer(amount);</span><br><span class="line">                FundTransfer(msg.sender, amount, <span class="literal">false</span>);</span><br><span class="line">                balance[msg.sender] = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果达成众筹目标，并且合约调用者是受益人</span></span><br><span class="line">        <span class="keyword">if</span> (fundingGoalReached &amp;&amp; beneficiary == msg.sender) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//将所有捐款从合约中给受益人</span></span><br><span class="line">            beneficiary.transfer(amountRaised);</span><br><span class="line"></span><br><span class="line">            FundTransfer(beneficiary, amount, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="代币示例"><a href="#代币示例" class="headerlink" title="代币示例"></a>代币示例</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity <span class="number">0.4</span><span class="number">.20</span>;</span><br><span class="line"></span><br><span class="line">interface tokenRecipient &#123; <span class="function"><span class="keyword">function</span> <span class="title">receiveApproval</span>(<span class="params">address _from, uint256 _value, address _token, bytes _extraData</span>) <span class="title">external</span>; &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">/**</span></span><br><span class="line"><span class="function"> * <span class="title">owned</span> 是一个管理者</span></span><br><span class="line"><span class="function"> */</span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">owned</span> </span>&#123;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初台化构造函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">owned</span> (<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断当前合约调用者是否是管理员</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    modifier onlyOwner &#123;</span><br><span class="line">        <span class="built_in">require</span> (msg.sender == owner);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指派一个新的管理员</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>newOwner address 新的管理员帐户地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">transferOwnership</span>(<span class="params">address newOwner</span>) <span class="title">onlyOwner</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (newOwner != address(<span class="number">0</span>)) &#123;</span><br><span class="line">        owner = newOwner;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title </span>基础版的代币合约</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract token &#123;</span><br><span class="line">    <span class="comment">/* 公共变量 */</span></span><br><span class="line">    string public standard = <span class="string">&#x27;https://mshk.top&#x27;</span>;</span><br><span class="line">    string public name; <span class="comment">//代币名称</span></span><br><span class="line">    string public symbol; <span class="comment">//代币符号比如&#x27;$&#x27;</span></span><br><span class="line">    uint8 public decimals = <span class="number">18</span>;  <span class="comment">//代币单位，展示的小数点后面多少个0,和以太币一样后面是是18个0</span></span><br><span class="line">    uint256 public totalSupply; <span class="comment">//代币总量</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*记录所有余额的映射*/</span></span><br><span class="line">    mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint256) public balanceOf;</span><br><span class="line">    mapping (<span class="function"><span class="params">address</span> =&gt;</span> mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint256)) public allowance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 在区块链上创建一个事件，用以通知客户端*/</span></span><br><span class="line">    event Transfer(address indexed <span class="keyword">from</span>, address indexed to, uint256 value);  <span class="comment">//转帐通知事件</span></span><br><span class="line">    event Burn(address indexed <span class="keyword">from</span>, uint256 value);  <span class="comment">//减去用户余额事件</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 初始化合约，并且把初始的所有代币都给这合约的创建者</span></span><br><span class="line"><span class="comment">     * @param initialSupply 代币的总数</span></span><br><span class="line"><span class="comment">     * @param tokenName 代币名称</span></span><br><span class="line"><span class="comment">     * @param tokenSymbol 代币符号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">token</span>(<span class="params">uint256 initialSupply, string tokenName, string tokenSymbol</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化总量</span></span><br><span class="line">        totalSupply = initialSupply * <span class="number">10</span> ** uint256(decimals);    <span class="comment">//以太币是10^18，后面18个0，所以默认decimals是18</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//给指定帐户初始化代币总量，初始化用于奖励合约创建者</span></span><br><span class="line">        <span class="comment">//balanceOf[msg.sender] = totalSupply;</span></span><br><span class="line">        balanceOf[<span class="built_in">this</span>] = totalSupply;</span><br><span class="line"></span><br><span class="line">        name = tokenName;</span><br><span class="line">        symbol = tokenSymbol;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 私有方法从一个帐户发送给另一个帐户代币</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>_from address 发送代币的地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>_to address 接受代币的地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>_value uint256 接受代币的数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">_transfer</span>(<span class="params">address _from, address _to, uint256 _value</span>) <span class="title">internal</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//避免转帐的地址是0x0</span></span><br><span class="line">      <span class="built_in">require</span>(_to != <span class="number">0x0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//检查发送者是否拥有足够余额</span></span><br><span class="line">      <span class="built_in">require</span>(balanceOf[_from] &gt;= _value);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//检查是否溢出</span></span><br><span class="line">      <span class="built_in">require</span>(balanceOf[_to] + _value &gt; balanceOf[_to]);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//保存数据用于后面的判断</span></span><br><span class="line">      uint previousBalances = balanceOf[_from] + balanceOf[_to];</span><br><span class="line"></span><br><span class="line">      <span class="comment">//从发送者减掉发送额</span></span><br><span class="line">      balanceOf[_from] -= _value;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//给接收者加上相同的量</span></span><br><span class="line">      balanceOf[_to] += _value;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//通知任何监听该交易的客户端</span></span><br><span class="line">      Transfer(_from, _to, _value);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//判断买、卖双方的数据是否和转换前一致</span></span><br><span class="line">      assert(balanceOf[_from] + balanceOf[_to] == previousBalances);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从主帐户合约调用者发送给别人代币</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>_to address 接受代币的地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>_value uint256 接受代币的数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint256 _value</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        _transfer(msg.sender, _to, _value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从某个指定的帐户中，向另一个帐户发送代币</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 调用过程，会检查设置的允许最大交易额</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>_from address 发送者地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>_to address 接受者地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>_value uint256 要转移的代币数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return </span>success        是否交易成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">transferFrom</span>(<span class="params">address _from, address _to, uint256 _value</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool success</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//检查发送者是否拥有足够余额</span></span><br><span class="line">        <span class="built_in">require</span>(_value &lt;= allowance[_from][msg.sender]);   <span class="comment">// Check allowance</span></span><br><span class="line"></span><br><span class="line">        allowance[_from][msg.sender] -= _value;</span><br><span class="line"></span><br><span class="line">        _transfer(_from, _to, _value);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置帐户允许支付的最大金额</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 一般在智能合约的时候，避免支付过多，造成风险</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>_spender 帐户地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>_value 金额</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">approve</span>(<span class="params">address _spender, uint256 _value</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool success</span>) </span>&#123;</span><br><span class="line">        allowance[msg.sender][_spender] = _value;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置帐户允许支付的最大金额</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 一般在智能合约的时候，避免支付过多，造成风险，加入时间参数，可以在 tokenRecipient 中做其他操作</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>_spender 帐户地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>_value 金额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>_extraData 操作的时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">approveAndCall</span>(<span class="params">address _spender, uint256 _value, bytes _extraData</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool success</span>) </span>&#123;</span><br><span class="line">        tokenRecipient spender = tokenRecipient(_spender);</span><br><span class="line">        <span class="keyword">if</span> (approve(_spender, _value)) &#123;</span><br><span class="line">            spender.receiveApproval(msg.sender, _value, <span class="built_in">this</span>, _extraData);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 减少代币调用者的余额</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 操作以后是不可逆的</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>_value 要删除的数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">burn</span>(<span class="params">uint256 _value</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool success</span>) </span>&#123;</span><br><span class="line">        <span class="comment">//检查帐户余额是否大于要减去的值</span></span><br><span class="line">        <span class="built_in">require</span>(balanceOf[msg.sender] &gt;= _value);   <span class="comment">// Check if the sender has enough</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//给指定帐户减去余额</span></span><br><span class="line">        balanceOf[msg.sender] -= _value;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//代币问题做相应扣除</span></span><br><span class="line">        totalSupply -= _value;</span><br><span class="line"></span><br><span class="line">        Burn(msg.sender, _value);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除帐户的余额（含其他帐户）</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 删除以后是不可逆的</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>_from 要操作的帐户地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>_value 要减去的数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">burnFrom</span>(<span class="params">address _from, uint256 _value</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool success</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//检查帐户余额是否大于要减去的值</span></span><br><span class="line">        <span class="built_in">require</span>(balanceOf[_from] &gt;= _value);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//检查 其他帐户 的余额是否够使用</span></span><br><span class="line">        <span class="built_in">require</span>(_value &lt;= allowance[_from][msg.sender]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//减掉代币</span></span><br><span class="line">        balanceOf[_from] -= _value;</span><br><span class="line">        allowance[_from][msg.sender] -= _value;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//更新总量</span></span><br><span class="line">        totalSupply -= _value;</span><br><span class="line">        Burn(_from, _value);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 匿名方法，预防有人向这合约发送以太币</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">/*function() &#123;</span></span><br><span class="line"><span class="comment">        //return;     // Prevents accidental sending of ether</span></span><br><span class="line"><span class="comment">    &#125;*/</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title </span>高级版代币</span></span><br><span class="line"><span class="comment"> * 增加冻结用户、挖矿、根据指定汇率购买(售出)代币价格的功能</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract MyAdvancedToken is owned, token &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//卖出的汇率,一个代币，可以卖出多少个以太币，单位是wei</span></span><br><span class="line">    uint256 public sellPrice;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//买入的汇率,1个以太币，可以买几个代币</span></span><br><span class="line">    uint256 public buyPrice;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//是否冻结帐户的列表</span></span><br><span class="line">    mapping (<span class="function"><span class="params">address</span> =&gt;</span> bool) public frozenAccount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//定义一个事件，当有资产被冻结的时候，通知正在监听事件的客户端</span></span><br><span class="line">    event FrozenFunds(address target, bool frozen);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*初始化合约，并且把初始的所有的令牌都给这合约的创建者</span></span><br><span class="line"><span class="comment">     * @param initialSupply 所有币的总数</span></span><br><span class="line"><span class="comment">     * @param tokenName 代币名称</span></span><br><span class="line"><span class="comment">     * @param tokenSymbol 代币符号</span></span><br><span class="line"><span class="comment">     * @param centralMinter 是否指定其他帐户为合约所有者,为0是去中心化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">MyAdvancedToken</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">      uint256 initialSupply,</span></span></span><br><span class="line"><span class="function"><span class="params">      string tokenName,</span></span></span><br><span class="line"><span class="function"><span class="params">      string tokenSymbol,</span></span></span><br><span class="line"><span class="function"><span class="params">      address centralMinter</span></span></span><br><span class="line"><span class="function"><span class="params">    </span>) <span class="title">token</span> (<span class="params">initialSupply, tokenName, tokenSymbol</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置合约的管理者</span></span><br><span class="line">        <span class="keyword">if</span>(centralMinter != <span class="number">0</span> ) owner = centralMinter;</span><br><span class="line"></span><br><span class="line">        sellPrice = <span class="number">2</span>;     <span class="comment">//设置1个单位的代币(单位是wei)，能够卖出2个以太币</span></span><br><span class="line">        buyPrice = <span class="number">4</span>;      <span class="comment">//设置1个以太币，可以买0.25个代币</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 私有方法，从指定帐户转出余额</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>_from address 发送代币的地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>_to address 接受代币的地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>_value uint256 接受代币的数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">_transfer</span>(<span class="params">address _from, address _to, uint _value</span>) <span class="title">internal</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//避免转帐的地址是0x0</span></span><br><span class="line">        <span class="built_in">require</span> (_to != <span class="number">0x0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//检查发送者是否拥有足够余额</span></span><br><span class="line">        <span class="built_in">require</span> (balanceOf[_from] &gt; _value);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//检查是否溢出</span></span><br><span class="line">        <span class="built_in">require</span> (balanceOf[_to] + _value &gt; balanceOf[_to]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//检查 冻结帐户</span></span><br><span class="line">        <span class="built_in">require</span>(!frozenAccount[_from]);</span><br><span class="line">        <span class="built_in">require</span>(!frozenAccount[_to]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//从发送者减掉发送额</span></span><br><span class="line">        balanceOf[_from] -= _value;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//给接收者加上相同的量</span></span><br><span class="line">        balanceOf[_to] += _value;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通知任何监听该交易的客户端</span></span><br><span class="line">        Transfer(_from, _to, _value);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 合约拥有者，可以为指定帐户创造一些代币</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>target address 帐户地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>mintedAmount uint256 增加的金额(单位是wei)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">mintToken</span>(<span class="params">address target, uint256 mintedAmount</span>) <span class="title">onlyOwner</span> <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//给指定地址增加代币，同时总量也相加</span></span><br><span class="line">        balanceOf[target] += mintedAmount;</span><br><span class="line">        totalSupply += mintedAmount;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Transfer(<span class="number">0</span>, <span class="built_in">this</span>, mintedAmount);</span><br><span class="line">        Transfer(<span class="built_in">this</span>, target, mintedAmount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 增加冻结帐户名称</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 你可能需要监管功能以便你能控制谁可以/谁不可以使用你创建的代币合约</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>target address 帐户地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param  </span>freeze bool    是否冻结</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">freezeAccount</span>(<span class="params">address target, bool freeze</span>) <span class="title">onlyOwner</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">        frozenAccount[target] = freeze;</span><br><span class="line">        FrozenFunds(target, freeze);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置买卖价格</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 如果你想让ether(或其他代币)为你的代币进行背书,以便可以市场价自动化买卖代币,我们可以这么做。如果要使用浮动的价格，也可以在这里设置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>newSellPrice 新的卖出价格</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param </span>newBuyPrice 新的买入价格</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setPrices</span>(<span class="params">uint256 newSellPrice, uint256 newBuyPrice</span>) <span class="title">onlyOwner</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">        sellPrice = newSellPrice;</span><br><span class="line">        buyPrice = newBuyPrice;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用以太币购买代币</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">buy</span>(<span class="params"></span>) <span class="title">payable</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">      uint amount = msg.value / buyPrice;</span><br><span class="line"></span><br><span class="line">      _transfer(<span class="built_in">this</span>, msg.sender, amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@dev </span>卖出代币</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return </span>要卖出的数量(单位是wei)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">sell</span>(<span class="params">uint256 amount</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//检查合约的余额是否充足</span></span><br><span class="line">        <span class="built_in">require</span>(<span class="built_in">this</span>.balance &gt;= amount * sellPrice);</span><br><span class="line"></span><br><span class="line">        _transfer(msg.sender, <span class="built_in">this</span>, amount);</span><br><span class="line"></span><br><span class="line">        msg.sender.transfer(amount * sellPrice);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Truffle-OpenZeppelin-ERC20代币实现"><a href="#Truffle-OpenZeppelin-ERC20代币实现" class="headerlink" title="Truffle+OpenZeppelin ERC20代币实现"></a>Truffle+OpenZeppelin ERC20代币实现</h1><p>1、新建项目</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">truffle unbox react-box</span><br></pre></td></tr></table></figure>

<p>2、安装zeppelin-solidity</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install zeppelin-solidity</span><br></pre></td></tr></table></figure>

<p>3、创建标准的代币合约</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.4</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;zeppelin-solidity/contracts/token/ERC20/StandardToken.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">contract BloggerCoin is StandardToken &#123;</span><br><span class="line">  string public name = <span class="string">&quot;BloggerCoin&quot;</span>;</span><br><span class="line">  string public symbol = <span class="string">&quot;BLC&quot;</span>;</span><br><span class="line">  uint8 public decimals = <span class="number">2</span>;</span><br><span class="line">  uint256 public INITIAL_SUPPLY = <span class="number">666666</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">BloggerCoin</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    totalSupply_ = INITIAL_SUPPLY;</span><br><span class="line">    balances[msg.sender] = INITIAL_SUPPLY;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<pre><code>INITIAL_SUPPLY变量定义了在合约部署时，代币将创建的数量。</code></pre>
<p>4、编译和部署</p>
<p>  在migrations/目录下建立一个3_deploy_bloggercoin.js文件，内容如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> BloggerCoin = artifacts.require(<span class="string">&quot;./BloggerCoin.sol&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">deployer</span>) </span>&#123;</span><br><span class="line">  deployer.deploy(BloggerCoin);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>编译部署：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">truffle compile</span><br><span class="line">truffle migrate 部署</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/20/Solidity%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/20/Solidity%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Solidity学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-20 20:23:17" itemprop="dateCreated datePublished" datetime="2018-12-20T20:23:17+08:00">2018-12-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/" itemprop="url" rel="index"><span itemprop="name">区块链</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/%E6%99%BA%E8%83%BD%E5%90%88%E7%BA%A6/" itemprop="url" rel="index"><span itemprop="name">智能合约</span></a>
                </span>
            </span>

          
            <span id="/2018/12/20/Solidity%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="Solidity学习笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2018/12/20/Solidity%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018/12/20/Solidity%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="入门说明"><a href="#入门说明" class="headerlink" title="入门说明"></a>入门说明</h1><p>在把智能协议传上以太坊之后，它就变得不可更改, 这种永固性意味着你的代码永远不能被调整或更新。你编译的程序会一直，永久的，不可更改的，存在以太坊上。</p>
<p>非常重要的是，部署在以太坊上的 DApp，并不能保证它真正做到去中心，我们需要阅读并理解它的源代码，才能防止其中没有被部署者恶意植入后门；作为开发人员，如何做到既要给自己留下修复 bug 的余地，又要尽量地放权给使用者，以便让他们放心你，从而愿意把数据放在你的 DApp 中，这确实需要个微妙的平衡。</p>
<h2 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>；</span><br></pre></td></tr></table></figure>

<ol>
<li>版本要高于0.4才可以编译</li>
<li>表示高于0.5的版本则不可编译，第三位的版本号但可以变，留出来用做bug可以修复（如0.4.1的编译器有bug，可在0.4.2修复，现有合约不用改代码）。</li>
</ol>
<h2 id="引用源文件"><a href="#引用源文件" class="headerlink" title="引用源文件"></a>引用源文件</h2><p>全局引入：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> “filename”;</span><br></pre></td></tr></table></figure>

<p>自定义命名空间引入：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> symbolName <span class="keyword">from</span> “filename”</span><br></pre></td></tr></table></figure>

<p>分别定义引入：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>  &#123;symbol1 <span class="keyword">as</span> alias, symbol2&#125; <span class="keyword">from</span> “filename”</span><br></pre></td></tr></table></figure>

<p>非es6兼容的简写语法：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> “filename” <span class="keyword">as</span> symbolName</span><br><span class="line"><span class="comment">// 等同于上述</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> symbolName <span class="keyword">from</span> “filename”</span><br></pre></td></tr></table></figure>

<h1 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h1><p>值类型：</p>
<ul>
<li>布尔(Booleans)</li>
<li>整型(Integer)</li>
<li>地址(Address)</li>
<li>定长字节数组(fixed byte arrays)</li>
<li>有理数和整型(Rational and Integer Literals，String literals)</li>
<li>枚举类型(Enums)</li>
<li>函数(Function Types)</li>
</ul>
<p>引用类型</p>
<ul>
<li>不定长字节数组（bytes）</li>
<li>字符串（string）</li>
<li>数组（Array）</li>
<li>结构体（Struts）</li>
</ul>
<h2 id="数据位置"><a href="#数据位置" class="headerlink" title="数据位置"></a>数据位置</h2><p>复杂类型，如数组(arrays)和数据结构(struct)在Solidity中有一个额外的属性，数据的存储位置。可选为memory和storage。</p>
<p>memory存储位置同我们普通程序的内存一致。即分配，即使用，越过作用域即不可被访问，等待被回收。而在区块链上，由于底层实现了图灵完备，故而会有非常多的状态需要永久记录下来，那么我们就要使用storage类型了，一旦使用这个类型，数据将永远存在。</p>
<p>基于程序的上下文，大多数时候这样的选择是默认的，我们可以通过指定关键字storage和memory修改它。默认的函数参数，包括返回的参数，他们是memory。默认的局部变量是storage的。默认的状态变量（合约声明的公有变量）是storage。</p>
<p>另外还有第三个存储位置calldata。它存储的是函数参数，是只读的，不会永久存储的一个数据位置。外部函数的参数（不包括返回参数）被强制指定为calldata。效果与memory差不多。</p>
<ul>
<li>storage转换为storage只是修改了它的指针。</li>
<li>将一个memory类型的变量赋值给一个状态变量时，实际是将内存变量拷贝到存储中。</li>
<li>memory赋值给局部变量:局部变量虽然是一个storage的，但它仅仅是一个storage类型的指针,所以直接赋值会报错,不能将memory赋值给局部变量.</li>
<li>将storage转为memory，实际是将数据从storage拷贝到memory中。</li>
<li>将一个memory的引用类型赋值给另一个memory的引用，不会创建拷贝（即：memory之间是引用传递）。</li>
<li>对于值类型，总是会进行拷贝。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract DataLocation&#123;</span><br><span class="line">  uint valueType;</span><br><span class="line">  mapping(<span class="function"><span class="params">uint</span> =&gt;</span> uint) public refrenceType;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">changeMemory</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> tmp = valueType;</span><br><span class="line">    tmp = <span class="number">100</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">changeStorage</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> tmp = refrenceType;</span><br><span class="line">    tmp[<span class="number">1</span>] = <span class="number">100</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getAll</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint, uint</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (valueType, refrenceType[<span class="number">1</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>强制的数据位置：</p>
<ul>
<li>外部函数(External function)的参数(不包括返回参数)强制为：calldata</li>
<li>状态变量(State variables)强制为: storage</li>
</ul>
<p>默认数据位置：</p>
<ul>
<li>函数参数(包括返回参数)：memory</li>
<li>所有其它的局部变量：storage</li>
</ul>
<h2 id="布尔"><a href="#布尔" class="headerlink" title="布尔"></a>布尔</h2><p>bool可能的取值为常量值true和false</p>
<h2 id="整型"><a href="#整型" class="headerlink" title="整型"></a>整型</h2><p>int/uint:</p>
<ul>
<li>变长的有符号或无符号整型。变量支持的步长以8递增，支持从uint8到uint256，以及int8到int256。uint和int默认代表的是uint256和int256</li>
</ul>
<p>字面量:</p>
<ul>
<li>整数字面量，由包含0-9的数字序列组成，默认被解释成十进制。在Solidity中不支持八进制，前导0会被默认忽略，如0100，会被认为是100。</li>
<li>小数由<code>.</code>组成，在他的左边或右边至少要包含一个数字。如1.，.1，1.3均是有效的小数。</li>
</ul>
<p>字面量本身支持任意精度，也就是可以不会运算溢出，或除法截断。但当它被转换成对应的非字面量类型，如整数或小数。或者将他们与非字面量进行运算，则不能保证精度了。总之就是，字面量怎么都计算都行，但一旦转为对应的变量后，再计算就不保证精度了。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract IntegerLiteral&#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">integerTest</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint, uint</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//超出运算字长了</span></span><br><span class="line">    <span class="keyword">var</span> i = (<span class="number">2</span>**<span class="number">800</span> + <span class="number">1</span>) - <span class="number">2</span>**<span class="number">800</span>;</span><br><span class="line">    <span class="keyword">var</span> j = <span class="number">1</span>/<span class="number">3</span>*<span class="number">3</span>;</span><br><span class="line">    <span class="comment">//小数运算</span></span><br><span class="line">    <span class="keyword">var</span> k = <span class="number">0.5</span>*<span class="number">8</span>;</span><br><span class="line">    <span class="keyword">return</span> (i, j);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>十六进制字面量，以关键字hex打头，后面紧跟用单或双引号包裹的字符串。如hex”001122ff”。在内部会被表示为二进制流。由于一个字节是8位，所以一个hex是由两个[0-9a-z]字符组成的，不是成双的字符串是会报错的。十六进制的字面量与字符串可以进行同样的类似操作：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract HexLiteralBytes&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">bytes4, bytes1, bytes1, bytes1, bytes1</span>)</span>&#123;</span><br><span class="line">      bytes4 a = hex<span class="string">&quot;001122FF&quot;</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> (a, a[<span class="number">0</span>], a[<span class="number">1</span>], a[<span class="number">2</span>], a[<span class="number">3</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="地址"><a href="#地址" class="headerlink" title="地址"></a>地址</h2><p>address：以太坊地址的长度，大小20个字节，160位，所以可以用一个uint160编码。地址是所有合约的基础，所有的合约都会继承地址对象(注意：从0.5.0开始，合约不再继承自地址类型，但仍然可以显式转换为地址)，也可以随时将一个地址串，得到对应的代码进行调用。当然地址代表一个普通帐户时，就没有这么多丰富的功能了。</p>
<p>地址类型的成员：</p>
<ul>
<li>属性：balance</li>
<li>函数：send()，call()，delegatecall()，callcode()。</li>
</ul>
<p>十六进制的字符串，凡是能通过地址合法性检查（address checksum test）2，就会被认为是地址，如0xdCad3a6d3569DF655070DEd06cb7A1b2Ccd1D3AF。需要注意的是39到41位长的没有通过地址合法性检查的，会提示一个警告，但会被视为普通的有理数字面量。</p>
<p>如果只是想得到当前合约的余额，可以这样写：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract addressTest&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getBalance</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="transfer"><a href="#transfer" class="headerlink" title="transfer()"></a>transfer()</h3><p>transfer()用来发送以太币（以wei为单位）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">address x = <span class="number">0x123</span>;</span><br><span class="line">address myAddress = <span class="built_in">this</span>;</span><br><span class="line"><span class="keyword">if</span> (x.balance &lt; <span class="number">10</span> &amp;&amp; myAddress.balance &gt;= <span class="number">10</span>) x.transfer(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<p>如果x是合约地址，合约的回退函数（fallback 函数）会随transfer调用一起执行（这个是EVM特性），如果因gas耗光或其他原因失败，转移交易会还原并且合约会抛异常停止。</p>
<h3 id="send"><a href="#send" class="headerlink" title="send()"></a>send()</h3><p>用来向某个地址发送货币(货币单位是wei)。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract PayTest &#123;</span><br><span class="line">    <span class="comment">//得到当前合约的余额</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getBalance</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.balance;<span class="comment">//0</span></span><br><span class="line">    &#125;  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//向当前合约存款</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">deposit</span>(<span class="params"></span>) <span class="title">payable</span> <span class="title">returns</span>(<span class="params">address addr, uint amount, bool success</span>)</span>&#123;</span><br><span class="line">        <span class="comment">//msg.sender 全局变量，调用合约的发起方</span></span><br><span class="line">        <span class="comment">//msg.value 全局变量，调用合约的发起方转发的货币量，以wei为单位。</span></span><br><span class="line">        <span class="comment">//send() 执行的结果</span></span><br><span class="line">        <span class="keyword">return</span> (msg.sender, msg.value, <span class="built_in">this</span>.send(msg.value));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个合约实现的是充值。this.send(msg.value)意指向合约自身发送msg.value量的以太币。msg.value是合约调用方附带的以太币。</p>
<p>send()方法执行时有一些风险:</p>
<ul>
<li>send与transfer对应，但更底层。如果执行失败，transfer不会因异常停止，而send会返回false。</li>
<li>调用递归深度不能超1024。</li>
<li>如果gas不够，执行会失败。</li>
<li>所以使用这个方法要检查成功与否。或为保险起见，货币操作时要使用一些最佳实践。如果执行失败，将会回撤所有交易，所以务必留意返回结果。</li>
</ul>
<p>为了同一些不支持ABI协议的进行直接交互（一般的web3.js，soldity都是支持的）。可以使用call()函数，用来向另一个合约发送原始数据。参数支持任何类型任意数量。每个参数会按规则(规则是按ABI)打包成32字节并一一拼接到一起。call()方法支持ABI协议定义的函数选择器。如果第一个参数恰好4个字节，在这种情况下，会被认为根据ABI协议定义的函数器指定的函数签名。所以如果你只是想发送消息体，需要避免第一个参数是4个字节。call方法返回一个bool值，以表明执行成功还是失败。正常结束返回true，异常终止返回false。我们无法解析返回结果，因为这样我们得事前知道返回的数据的编码和数据大小（这里的潜在假设是不知道对方使用的协议格式，所以也不会知道返回的结果如何解析，有点祼协议测试的感觉）。</p>
<p>同样也可以使用delegatecall()，它与call方法的区别在于，仅仅是代码会执行，而其它方面，如（存储，余额等）都是用的当前的合约的数据。delegatecall()方法的目的是用来执行另一个合约中的工具库。所以开发者需要保证两个合约中的存储变量能兼容，来保证delegatecall()能顺利执行。</p>
<p>上面的这三个方法call()，delegatecall()，callcode()都是底层的消息传递调用，最好仅在万不得已才进行使用，因为他们破坏了Solidity的类型安全。上述的函数都是底层的函数，使用时要异常小心。当调用一个未知的，可能是恶意的合约时，当你把控制权交给它，它可能回调回你的合约，所以要准备好在调用返回时，应对你的状态变量可能被恶意篡改的情况。</p>
<h2 id="定长字节数组"><a href="#定长字节数组" class="headerlink" title="定长字节数组"></a>定长字节数组</h2><p>bytes1， … ，bytes32，允许值以步长1递增。byte默认表示byte1。成员变量length。</p>
<h2 id="枚举类型-enum"><a href="#枚举类型-enum" class="headerlink" title="枚举类型(enum)"></a>枚举类型(enum)</h2><p>枚举类型是在Solidity中的一种用户自定义类型。他可以显示的与整数进行转换，但不能进行隐式转换。显示的转换会在运行时检查数值范围，如果不匹配，将会引起异常。枚举类型应至少有一名成员。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract test &#123;</span><br><span class="line">    enum ActionChoices &#123; GoLeft, GoRight, GoStraight, SitStill &#125;</span><br><span class="line">    ActionChoices choice;</span><br><span class="line">    ActionChoices constant defaultChoice = ActionChoices.GoStraight;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setGoStraight</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        choice = ActionChoices.GoStraight;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Since enum types are not part of the ABI, the signature of &quot;getChoice&quot;</span></span><br><span class="line">    <span class="comment">// will automatically be changed to &quot;getChoice() returns (uint8)&quot;</span></span><br><span class="line">    <span class="comment">// for all matters external to Solidity. The integer type used is just</span></span><br><span class="line">    <span class="comment">// large enough to hold all enum values, i.e. if you have more values,</span></span><br><span class="line">    <span class="comment">// `uint16` will be used and so on.</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getChoice</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">ActionChoices</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> choice;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getDefaultChoice</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> uint(defaultChoice);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>函数的分类:</p>
<ul>
<li>内部函数(internal):因为不能在当前合约的上下文环境以外的地方执行，内部函数只能在当前合约内被使用。如在当前的代码块内，包括内部库函数，和继承的函数中。</li>
<li>外部函数（External）:外部函数由地址和函数方法签名两部分组成。可作为外部函数调用的参数，或者由外部函数调用返回。</li>
</ul>
<p>函数的定义:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> (<span class="params">&lt;parameter types&gt;</span>) </span>&#123;internal(默认)|external&#125; [constant] [payable] [returns (<span class="xml"><span class="tag">&lt;<span class="name">return</span> <span class="attr">types</span>&gt;</span>)]</span></span><br></pre></td></tr></table></figure>

<p>若不写类型，默认的函数类型是internal的。如果函数没有返回结果，则必须省略returns关键字。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Test&#123;</span><br><span class="line">    <span class="comment">//默认是internal类型的</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">noParameter</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint</span>)</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//无返回结果</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">noReturn1</span>(<span class="params">uint x</span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果无返回结果，必须省略`returns`关键字</span></span><br><span class="line">    <span class="comment">//function noReturn2(uint x) returns &#123;&#125; </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数的internal与external：调用一个函数f()时，我们可以直接调用f()，或者使用this.f()。但两者有一个区别。前者是通过internal的方式在调用，而后者是通过external的方式在调用。请注意，这里关于this的使用与大多数语言相背。下面通过一个例子来了解他们的不同：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.5</span>;</span><br><span class="line"></span><br><span class="line">contract FuntionTest&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">internalFunc</span>(<span class="params"></span>) <span class="title">internal</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">externalFunc</span>(<span class="params"></span>) <span class="title">external</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">callFunc</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">//直接使用内部的方式调用</span></span><br><span class="line">        internalFunc();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//不能在内部调用一个外部函数，会报编译错误。</span></span><br><span class="line">        <span class="comment">//Error: Undeclared identifier.</span></span><br><span class="line">        <span class="comment">//externalFunc();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//不能通过`external`的方式调用一个`internal`</span></span><br><span class="line">        <span class="comment">//Member &quot;internalFunc&quot; not found or not visible after argument-dependent lookup in contract FuntionTest</span></span><br><span class="line">        <span class="comment">//this.internalFunc();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用`this`以`external`的方式调用一个外部函数</span></span><br><span class="line">        <span class="built_in">this</span>.externalFunc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract FunctionTest1&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">externalCall</span>(<span class="params">FuntionTest ft</span>)</span>&#123;</span><br><span class="line">        <span class="comment">//调用另一个合约的外部函数</span></span><br><span class="line">        ft.externalFunc();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//不能调用另一个合约的内部函数</span></span><br><span class="line">        <span class="comment">//Error: Member &quot;internalFunc&quot; not found or not visible after argument-dependent lookup in contract FuntionTest</span></span><br><span class="line">        <span class="comment">//ft.internalFunc();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="不定长字节数组"><a href="#不定长字节数组" class="headerlink" title="不定长字节数组"></a>不定长字节数组</h2><ul>
<li>bytes：动态长度的字节数组。</li>
</ul>
<h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h2><p>字符串(string)字面量是指由单引号，或双引号引起来的字符串。字符串并不像C语言，包含结束符，“foo”这个字符串大小仅为三个字节。字符串的长度类型可以是变长的，特殊之处在于，可以隐式的转换为byte1,…byte32。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract StringConvert&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">bytes3</span>)</span>&#123;</span><br><span class="line">      bytes3 a = <span class="string">&quot;123&quot;</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//bytes3 b = &quot;1234&quot;;</span></span><br><span class="line">      <span class="comment">//Error: Type literal_string &quot;1234&quot; is not implicitly convertible to expected type bytes3.</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> a;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 上述的字符串字面量，会隐式转换为bytes3。</span></span><br></pre></td></tr></table></figure>

<h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h2><h3 id="创建一个数组"><a href="#创建一个数组" class="headerlink" title="创建一个数组"></a>创建一个数组</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Test &#123;</span><br><span class="line">    uint[<span class="number">5</span>] arr = [<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>];<span class="comment">//创建一个定长的数组</span></span><br><span class="line">    uint[] storageArr;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        uint[<span class="number">5</span>] memory arr1 = [uint(<span class="number">0</span>),<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>];<span class="comment">//uint8显示的转换为uint256，否则会报类型错误。</span></span><br><span class="line">        uint[] memory memoryArr;</span><br><span class="line">        <span class="comment">//storageArr[0] = 12;</span></span><br><span class="line">        <span class="comment">//memoryArr[0] = 13; //执行会报VM error: invalid opcode.，原因是数组还没有执行初始化。</span></span><br><span class="line"></span><br><span class="line">        storageArr = <span class="keyword">new</span> uint[](<span class="number">5</span>);</span><br><span class="line">        memoryArr = <span class="keyword">new</span> uint[](<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        storageArr[<span class="number">0</span>] = <span class="number">12</span>;</span><br><span class="line">        memoryArr[<span class="number">0</span>] = <span class="number">13</span>; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Memory数组"><a href="#Memory数组" class="headerlink" title="Memory数组"></a>Memory数组</h3><p>对于memory的变长数组，不支持修改length属性，来调整数组大小。memory的变长数组虽然可以通过参数灵活指定大小，但一旦创建，大小不可调整。</p>
<h3 id="push方法"><a href="#push方法" class="headerlink" title="push方法"></a>push方法</h3><p>变长的storage数组和bytes（不包括string）有一个push()方法。可以将一个新元素附加到数组最后端，返回值为当前长度uint。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Test &#123;</span><br><span class="line"></span><br><span class="line">    uint[] arr;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>)  <span class="title">public</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        arr.push(<span class="number">1</span>);<span class="comment">// 初始化前调用</span></span><br><span class="line">        arr = <span class="keyword">new</span> uint[](<span class="number">1</span>); </span><br><span class="line">        arr[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        uint len = arr.push(<span class="number">1</span>);<span class="comment">//先数组的最后添加一个元素1，方法返回的是数组的长度</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> len;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>memory的数组不可修改，不支持push方法。</p>
<h3 id="多维数组"><a href="#多维数组" class="headerlink" title="多维数组"></a>多维数组</h3><p>uint[2][3]在大多数语言中，表示的是两行三列的数组，而Solidity切好相反，它表示的是三行两列的数组。但是访问数组的方法与其他语言一致。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.4</span>;</span><br><span class="line"></span><br><span class="line">contract Test &#123;</span><br><span class="line"></span><br><span class="line">    uint[<span class="number">2</span>][<span class="number">3</span>] arr = [[<span class="number">1</span>,<span class="number">2</span>],[<span class="number">3</span>,<span class="number">4</span>],[<span class="number">5</span>,<span class="number">6</span>]];</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">arr_len</span>(<span class="params"></span>)  <span class="title">public</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> arr.length; <span class="comment">//返回值为3</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="固定的字节数组和可变的字节数组"><a href="#固定的字节数组和可变的字节数组" class="headerlink" title="固定的字节数组和可变的字节数组"></a>固定的字节数组和可变的字节数组</h3><ul>
<li>bytes和string是一种特殊的数组。bytes类似于byte[],但在外部函数作为参数调用中，会进行压缩打包，更省空间，所以应该尽量使用bytes而不是byte[]. </li>
<li>bytes0~bytes32 表示创建固定字节大小的数组，不可修改。</li>
<li>string是特殊的可变字节数组。可以转换为bytes以通过length获得它的字节长度。也可以通过索引来修改对应的字节内容,通过push方法来增加字节内容。</li>
<li>由于bytes与string，可以自由转换，你可以将字符串s通过bytes(s)转为一个bytes。但需要注意的是通过这种方式访问到的是UTF-8编码的码流，并不是独立的一个个字符。比如中文编码是多字节，变长的，所以你访问到的很有可能只是其中的一个代码点。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Test &#123;</span><br><span class="line">    <span class="comment">// 声明一个固定长度的数组，不可修改</span></span><br><span class="line">    bytes9 a = <span class="number">0x6c697975656368756e</span>;</span><br><span class="line">    byte[<span class="number">9</span>] b = [byte(<span class="number">0x6c</span>),<span class="number">0x69</span>,<span class="number">0x79</span>,<span class="number">0x75</span>,<span class="number">0x65</span>,<span class="number">0x63</span>,<span class="number">0x68</span>,<span class="number">0x75</span>,<span class="number">0x6e</span>];</span><br><span class="line"></span><br><span class="line">    byte[] c = <span class="keyword">new</span> byte[](<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// function setAIndex0Byte() public &#123;</span></span><br><span class="line">    <span class="comment">//     // 错误，不可修改</span></span><br><span class="line">    <span class="comment">//     a[0] = 0x89;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setBIndex0Byte</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        b[<span class="number">0</span>] = <span class="number">0x89</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setC</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(uint i = <span class="number">0</span>; i &lt; b.length; i++) &#123;</span><br><span class="line"></span><br><span class="line">            c.push(b[i]);</span><br><span class="line">            c.push(b[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="结构体"><a href="#结构体" class="headerlink" title="结构体"></a>结构体</h2><ul>
<li>不能声明一个struct同时将这个struct作为这个struct的一个成员。这个限制是基于结构体的大小必须是有限的。</li>
<li>在函数中，将一个struct赋值给一个局部变量（默认是storage类型），实际是拷贝的引用，所以修改局部变量值时，会影响到原变量。</li>
<li>通常情况下不会考虑使用 uint 变种，因为无论如何定义 uint的大小，Solidity 都会为它保留256位的存储空间。例如，使用 uint8 而不是uint（uint256）不会节省任何 gas。</li>
<li>而如果一个 struct 中有多个 uint，则尽可能使用较小的 uint, Solidity 会将这些 uint 打包在一起，从而占用较少的存储空间。</li>
<li>结构体是不对外可见的(当前只支持internal)，所以只可以在当前合约，或合约的子类中使用。包含自定义结构体的函数均需要声明为internal或private的。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract CrowdFunding&#123;</span><br><span class="line">    struct Funder&#123;</span><br><span class="line">        address addr;</span><br><span class="line">        uint amount;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    struct Campaign&#123;</span><br><span class="line">        address beneficiary;</span><br><span class="line">        uint goal;</span><br><span class="line">        uint amount;</span><br><span class="line">        uint funderNum;</span><br><span class="line">        mapping(<span class="function"><span class="params">uint</span> =&gt;</span> Funder) funders;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    uint compaingnID;</span><br><span class="line">    mapping (<span class="function"><span class="params">uint</span> =&gt;</span> Campaign) campaigns;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">candidate</span>(<span class="params">address beneficiary, uint goal</span>) <span class="title">returns</span> (<span class="params">uint compaingnID</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// initialize</span></span><br><span class="line">        campaigns[compaingnID++] = Campaign(beneficiary, goal, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">vote</span>(<span class="params">uint compaingnID</span>) <span class="title">payable</span> </span>&#123;</span><br><span class="line">        Campaign c = campaigns[compaingnID];</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//another way to initialize</span></span><br><span class="line">        c.funders[c.funderNum++] = Funder(&#123;<span class="attr">addr</span>: msg.sender, <span class="attr">amount</span>: msg.value&#125;);</span><br><span class="line">        c.amount += msg.value;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params">uint comapingnId</span>) <span class="title">returns</span> (<span class="params">bool</span>)</span>&#123;</span><br><span class="line">        Campaign c = campaigns[comapingnId];</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span>(c.amount &lt; c.goal)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        uint amount = c.amount;</span><br><span class="line">        <span class="comment">// incase send much more</span></span><br><span class="line">        c.amount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span>(!c.beneficiary.send(amount))&#123;</span><br><span class="line">            <span class="keyword">throw</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="字典"><a href="#字典" class="headerlink" title="字典"></a>字典</h2><p>定义方式为mapping(_KeyType =&gt; _KeyValue)。键的类型允许除映射外的所有类型，如数组，合约，枚举，结构体。值的类型无限制。</p>
<p>在映射表中，我们并不存储键的数据，仅仅存储它的keccak256哈希值，用来查找值时使用。因此，映射并没有长度，键集合（或列表），值集合（或列表）这样的概念。</p>
<p>映射类型，仅能用来定义状态变量，或者是在内部函数中作为storage类型的引用。引用是指你可以声明一个，如var storage mappVal的用于存储状态变量的引用的对象，但你没办法使用非状态变量来初始化这个引用。</p>
<p>可以通过将映射标记为public，来让Solidity创建一个访问器。要想访问这样的映射，需要提供一个键值做为参数。如果映射的值类型也是映射，使用访问器访问时，要提供这个映射值所对应的键，不断重复这个过程。下面来看一个例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">contract MappingExample&#123;</span><br><span class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) public balances;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params">uint amount</span>) <span class="title">returns</span> (<span class="params">address addr</span>)</span>&#123;</span><br><span class="line">        balances[msg.sender] = amount;</span><br><span class="line">        <span class="keyword">return</span> msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于调试时，你不一定方便知道自己的发起地址，所以把这个函数，略微调整了一下，以在调用时，返回调用者的地址。编译上述合同后，可以先调用update()，执行成功后，查看调用信息，能看到你更新的地址，这样再查一下这个地址的在映射里存的值。</p>
<p>如果你想通过合约进行上述调用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//file indeed for compile</span></span><br><span class="line"><span class="comment">//may store in somewhere and import</span></span><br><span class="line">contract MappingExample&#123;</span><br><span class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) public balances;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params">uint amount</span>) <span class="title">returns</span> (<span class="params">address addr</span>)</span>&#123;</span><br><span class="line">        balances[msg.sender] = amount;</span><br><span class="line">        <span class="keyword">return</span> msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract MappingUser&#123;</span><br><span class="line">    </span><br><span class="line">    address conAddr;</span><br><span class="line">    address userAddr;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint amount</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//address not resolved!</span></span><br><span class="line">    <span class="comment">//tringing</span></span><br><span class="line">        conAddr = hex<span class="string">&quot;0xf2bd5de8b57ebfc45dcee97524a7a08fccc80aef&quot;</span>;</span><br><span class="line">        userAddr = hex<span class="string">&quot;0xca35b7d915458ef540ade6068dfe2f44e8fa733c&quot;</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> MappingExample(conAddr).balances(userAddr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>映射并未提供迭代输出的方法，可以自行实现一个数据结构。</p>
<h2 id="运算符delete"><a href="#运算符delete" class="headerlink" title="运算符delete"></a>运算符delete</h2><p>delete运算符，用于将某个变量重置为初始值。对于整数，运算符的效果等同于a = 0。而对于定长数组，则是把数组中的每个元素置为初始值，变长数组则是将长度置为0。对于结构体，也是类似，是将所有的成员均重置为初始值。delete对于映射类型几乎无影响，因为键可能是任意的，且往往不可知。所以如果你删除一个结构体，它会递归删除所有非mapping的成员。当然，你是可以单独删除映射里的某个键，以及这个键映射的某个值。</p>
<p>需要强调的是delete a的行为更像赋值，为a赋予一个新对象。我们来看看下文的示例：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract DeleteExample &#123;</span><br><span class="line">    uint data;</span><br><span class="line">    uint[] dataArray;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//值传递</span></span><br><span class="line">        uint x = data;</span><br><span class="line">        <span class="comment">//删除x不会影响data</span></span><br><span class="line">        <span class="keyword">delete</span> x;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//删除data，同样也不会影响x，因为是值传递，它存的是一份原值的拷贝。</span></span><br><span class="line">        <span class="keyword">delete</span> data; </span><br><span class="line"></span><br><span class="line">        <span class="comment">//引用赋值</span></span><br><span class="line">        uint[] y = dataArray;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//删除dataArray会影响y，y也将被赋值为初值。</span></span><br><span class="line">        <span class="keyword">delete</span> dataArray;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//下面的操作为报错，因为删除是一个赋值操作，不能向引用类型的storage直接赋值从而报错</span></span><br><span class="line">        <span class="comment">//delete y;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过上面的代码，我们可以看出，对于值类型，是值传递，删除x不会影响到data，同样的删除data也不会影响到x。因为他们都存了一份原值的拷贝。而对于复杂类型略有不同，复杂类型在赋值时使用的是引用传递。删除会影响所有相关变量。比如上述代码中，删除dataArray同样会影响到y。由于delete的行为更像是赋值操作，所以不能在上述代码中执行delete y，因为不能对一个storage的引用赋值</p>
<h2 id="类型推断"><a href="#类型推断" class="headerlink" title="类型推断"></a>类型推断</h2><p>为了方便，并不总是需要明确指定一个变量的类型，编译器会通过第一个向这个对象赋予的值的类型来进行推断1。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uint24 x = <span class="number">0x123</span>;</span><br><span class="line"><span class="keyword">var</span> y = x;</span><br></pre></td></tr></table></figure>

<p>函数的参数，包括返回参数，不可以使用var这种不指定类型的方式。</p>
<p>需要特别注意的是，由于类型推断是根据第一个变量进行的赋值。所以代码for (var i = 0; i &lt; 2000; i++) {}将是一个无限循环，因为一个uint8的i的将小于2000。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.4</span>;</span><br><span class="line"></span><br><span class="line">contract Test&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint</span>)</span>&#123;</span><br><span class="line">      uint count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">2000</span>; i++) &#123;</span><br><span class="line">            count++;</span><br><span class="line">            <span class="keyword">if</span>(count &gt;= <span class="number">2100</span>)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="单位"><a href="#单位" class="headerlink" title="单位"></a>单位</h1><h2 id="货币单位"><a href="#货币单位" class="headerlink" title="货币单位"></a>货币单位</h2><p>一个字面量的数字，可以使用后缀wei,finney,szabo或ether来在不同面额中转换。不含任何后缀的默认单位是wei。如2 ether == 2000 finney的结果是true。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract EthUnit&#123;</span><br><span class="line">    uint a;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">bool</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="number">2</span> ether == <span class="number">2000</span> finney)&#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="时间单位-Time-Units"><a href="#时间单位-Time-Units" class="headerlink" title="时间单位(Time Units)"></a>时间单位(Time Units)</h2><p>seconds,minutes,hours,days,weeks,years均可做为后缀，并进行相互转换，默认是seconds为单位。</p>
<p>变量 now 将返回当前的unix时间戳(自1970年1月1日以来经过的秒数)。Unix时间传统用一个32位的整数进行存储，这会导致“2038年”问题，当这个32位的unix时间戳不够用，产生溢出，使用这个时间的遗留系统就麻烦了。所以，如果我们想让我们的 DApp 跑够20年，我们可以使用64位整数表示时间，但为此我们的用户又得支付更多的 gas。真是个两难的设计啊！</p>
<p>如果你需要进行使用这些单位进行日期计算，需要特别小心，因为不是每年都是365天，且并不是每天都有24小时，因为还有闰秒。由于无法预测闰秒，必须由外部的oracle来更新从而得到一个精确的日历库（内部实现一个日期库也是消耗gas的）。</p>
<p>后缀不能用于变量。如果你想对输入的变量说明其不同的单位，可以使用下面的方式。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract DeleteExample&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">nowInSeconds</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint256</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> now;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">uint start, uint daysAfter</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (now &gt;= start + daysAfter * <span class="number">1</span> days) &#123; </span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="内置特性"><a href="#内置特性" class="headerlink" title="内置特性"></a>内置特性</h1><h2 id="特殊变量及函数"><a href="#特殊变量及函数" class="headerlink" title="特殊变量及函数"></a>特殊变量及函数</h2><p>区块和交易的属性：</p>
<ul>
<li>block.blockhash(uint blockNumber) returns (bytes32)，给定区块号的哈希值，只支持最近256个区块，且不包含当前区块。</li>
<li>block.coinbase (address) 当前块矿工的地址。</li>
<li>block.difficulty (uint)当前块的难度。</li>
<li>block.gaslimit (uint)当前块的gaslimit。</li>
<li>block.number (uint)当前区块的块号。</li>
<li>block.timestamp (uint)当前块的时间戳。</li>
<li>msg.data (bytes)完整的调用数据（calldata）。</li>
<li>msg.gas (uint)当前还剩的gas。</li>
<li>msg.sender (address)当前调用发起人的地址,总是存在。</li>
<li>msg.sig (bytes4)调用数据的前四个字节（函数标识符）。</li>
<li>msg.value (uint)这个消息所附带的货币量，单位为wei。</li>
<li>now (uint)当前块的时间戳，等同于block.timestamp</li>
<li>tx.gasprice (uint) 交易的gas价格。</li>
<li>tx.origin (address)交易的发送者（完整的调用链）</li>
</ul>
<p>msg的所有成员值，如msg.sender,msg.value的值可以因为每一次外部函数调用，或库函数调用发生变化（因为msg就是和调用相关的全局变量）。如果你想在库函数中，用msg.sender实现访问控制，你需要将msg.sender做为参数（就是说不能使用默认的msg.value，因为它可能被更改）。为了可扩展性的原因，你只能查最近256个块，所有其它的将返回0.</p>
<h2 id="数学和加密函数"><a href="#数学和加密函数" class="headerlink" title="数学和加密函数"></a>数学和加密函数</h2><ul>
<li>asser(bool condition):如果条件不满足，抛出异常。</li>
<li>addmod(uint x, uint y, uint k) returns (uint):计算(x + y) % k。加法支持任意的精度。但不超过(wrap around？)2**256。</li>
<li>mulmod(uint x, uint y, uint k) returns (uint):计算(x * y) % k。乘法支持任意精度，但不超过(wrap around？)2**256。</li>
<li>keccak256(…) returns (bytes32):使用以太坊的（Keccak-256）计算HASH值。紧密打包。</li>
<li>sha3(…) returns (bytes32):等同于keccak256()。紧密打包。</li>
<li>sha256(…) returns (bytes32):使用SHA-256计算HASH值。紧密打包。</li>
<li>ripemd160(…) returns (bytes20):使用RIPEMD-160计算HASH值。紧密打包。</li>
<li>ecrecover(bytes32 hash, uint8 v, bytes32 r, bytes32 s) returns (address):通过签名信息恢复非对称加密算法公匙地址。如果出错会返回0，附录提供了一个例子1.</li>
<li>revert()：取消执行，并回撤状态变化。</li>
</ul>
<h2 id="地址相关"><a href="#地址相关" class="headerlink" title="地址相关"></a>地址相关</h2><ul>
<li><address>.balance (uint256)：Address的余额，以wei为单位。</li>
<li><address>.transfer(uint256 amount)：发送给定数量的ether，以wei为单位，到某个地址。失败时抛出异常。</li>
<li><address>.send(uint256 amount) returns (bool):发送给定数量的ether，以wei为单位，到某个地址。失败时返回false。</li>
<li><address>.call(...) returns (bool)：发起底层的call调用。失败时返回false。</li>
<li><address>.callcode(...) returns (bool)：发起底层的callcode调用，失败时返回false。</li>
<li><address>.delegatecall(...) returns (bool)：发起底层的delegatecall调用，失败时返回false。

</li>
</ul>
<p>使用send方法需要注意，调用栈深不能超过1024，或gas不足，都将导致发送失败。使用为了保证你的ether安全，要始终检查返回结果。当用户取款时，使用transfer或使用最佳实践的模式2。</p>
<h2 id="合约相关"><a href="#合约相关" class="headerlink" title="合约相关"></a>合约相关</h2><ul>
<li>this（当前合约的类型）：当前合约的类型，可以显式的转换为Address</li>
<li>selfdestruct(address recipt):销毁当前合约，并把它所有资金发送到给定的地址。</li>
</ul>
<h1 id="进阶"><a href="#进阶" class="headerlink" title="进阶"></a>进阶</h1><h2 id="控制语句"><a href="#控制语句" class="headerlink" title="控制语句"></a>控制语句</h2><p>不支持switch和goto，支持if，else，while，do，for，break，continue，return，?:。条件判断中的括号不可省略，但在单行语句中的大括号可以省略。</p>
<h2 id="函数调用"><a href="#函数调用" class="headerlink" title="函数调用"></a>函数调用</h2><h3 id="内部函数调用"><a href="#内部函数调用" class="headerlink" title="内部函数调用"></a>内部函数调用</h3><p>在当前的合约中，函数可以直接调用（内部调用方式），包括也可递归调用。</p>
<h3 id="外部函数调用"><a href="#外部函数调用" class="headerlink" title="外部函数调用"></a>外部函数调用</h3><p>表达式this.g(8);和c.g(2)（这里的c是一个合约实例）是外部调用函数的方式。实现上是通过一个消息调用，而不是直接通过EVM的指令跳转。需要注意的是，在合约的构造器中，不能使用this调用函数，因为当前合约还没有创建完成。</p>
<p>其它合约的函数必须通过外部的方式调用。对于一个外部调用，所有函数的参数必须要拷贝到内存中。当调用其它合约的函数时，可以通过选项.value()，和.gas()来分别指定，要发送的ether量（以wei为单位），和gas值。</p>
<h3 id="命名参数调用和匿名函数参数"><a href="#命名参数调用和匿名函数参数" class="headerlink" title="命名参数调用和匿名函数参数"></a>命名参数调用和匿名函数参数</h3><p>函数调用的参数，可以通过指定名字的方式调用，但可以以任意的顺序，使用方式是{}包含。但参数的类型和数量要与定义一致。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract C &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">uint val1, uint val2</span>) <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123; <span class="keyword">return</span> val1 + val2; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">g</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// named arguments</span></span><br><span class="line">        <span class="keyword">return</span> add(&#123;<span class="attr">val2</span>: <span class="number">2</span>, <span class="attr">val1</span>: <span class="number">1</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="省略函数名称"><a href="#省略函数名称" class="headerlink" title="省略函数名称"></a>省略函数名称</h3><p>没有使用的参数名可以省略(一般常见于返回值)。这些名字在栈(stack)上存在，但不可访问。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract C &#123;</span><br><span class="line">    <span class="comment">// omitted name for parameter</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params">uint k, uint</span>) <span class="title">returns</span>(<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> k;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建合约实例"><a href="#创建合约实例" class="headerlink" title="创建合约实例"></a>创建合约实例</h2><p>一个合约可以通过new关键字来创建一个合约。要创建合约的完整代码，必须提前知道，所以递归创建依赖是不可能的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Account&#123;</span><br><span class="line">    uint accId;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//construction?</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Account</span>(<span class="params">uint accountId</span>) <span class="title">payable</span></span>&#123;</span><br><span class="line">        accId = accountId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Initialize&#123;</span><br><span class="line">    Account account = <span class="keyword">new</span> Account(<span class="number">10</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">newAccount</span>(<span class="params">uint accountId</span>)</span>&#123;</span><br><span class="line">        account = <span class="keyword">new</span> Account(accountId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">newAccountWithEther</span>(<span class="params">uint accountId, uint amount</span>)</span>&#123;</span><br><span class="line">        account = (<span class="keyword">new</span> Account).value(amount)(accountId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的例子可以看出来，可以在创建合约中，发送ether，但不能限制gas的使用。如果创建因为out-of-stack，或无足够的余额以及其它任何问题，会抛出一个异常。</p>
<h2 id="赋值"><a href="#赋值" class="headerlink" title="赋值"></a>赋值</h2><p>Solidity内置支持元组(tuple)，可以同时返回多个结果，也可用于同时赋值给多个变量。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract C &#123;</span><br><span class="line">    uint[] data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint, bool, uint</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="number">7</span>, <span class="literal">true</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">g</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// Declares and assigns the variables. Specifying the type explicitly is not possible.</span></span><br><span class="line">        <span class="keyword">var</span> (x, b, y) = f();</span><br><span class="line">        <span class="comment">// Assigns to a pre-existing variable.</span></span><br><span class="line">        (x, y) = (<span class="number">2</span>, <span class="number">7</span>);</span><br><span class="line">        <span class="comment">// Common trick to swap values -- does not work for non-value storage types.</span></span><br><span class="line">        (x, y) = (y, x);</span><br><span class="line">        <span class="comment">// Components can be left out (also for variable declarations).</span></span><br><span class="line">        <span class="comment">// If the tuple ends in an empty component,</span></span><br><span class="line">        <span class="comment">// the rest of the values are discarded.</span></span><br><span class="line">        (data.length,) = f(); <span class="comment">// Sets the length to 7</span></span><br><span class="line">        <span class="comment">// The same can be done on the left side.</span></span><br><span class="line">        (,data[<span class="number">3</span>]) = f(); <span class="comment">// Sets data[3] to 2</span></span><br><span class="line">        <span class="comment">// Components can only be left out at the left-hand-side of assignments, with</span></span><br><span class="line">        <span class="comment">// one exception:</span></span><br><span class="line">        (x,) = (<span class="number">1</span>,);</span><br><span class="line">        <span class="comment">// (1,) is the only way to specify a 1-component tuple, because (1) is</span></span><br><span class="line">        <span class="comment">// equivalent to 1.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="作用范围和声明"><a href="#作用范围和声明" class="headerlink" title="作用范围和声明"></a>作用范围和声明</h2><p>函数内定义的变量，在整个函数中均可用，无论它在哪里定义，因为Solidity使用了javascript的变量作用范围的规则。与常规语言语法从定义处开始，到当前块结束为止不同。由此，下述代码编译时会抛出一个异常，Identifier already declared。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract ScopingErrors &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">scoping</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        uint i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (i++ &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            uint same1 = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (i++ &lt; <span class="number">2</span>) &#123;</span><br><span class="line">            uint same1 = <span class="number">0</span>;<span class="comment">// Illegal, second declaration of same1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">minimalScoping</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        &#123;</span><br><span class="line">            uint same2 = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">            uint same2 = <span class="number">0</span>;<span class="comment">// Illegal, second declaration of same2</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">forLoopScoping</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (uint same3 = <span class="number">0</span>; same3 &lt; <span class="number">1</span>; same3++) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (uint same3 = <span class="number">0</span>; same3 &lt; <span class="number">1</span>; same3++) &#123;<span class="comment">// Illegal, second declaration of same3</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">crossFunction</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">       uint same1 = <span class="number">0</span>;<span class="comment">//Illegal</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外的，如果一个变量被声明了，它会在函数开始前被初始化为默认值。所以下述例子是合法的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract C&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        <span class="comment">// baz is implicitly initialized as 0</span></span><br><span class="line">        uint bar = <span class="number">5</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            bar += baz;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            uint baz = <span class="number">10</span>;<span class="comment">// never executes</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bar;<span class="comment">// returns 5</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="随机数"><a href="#随机数" class="headerlink" title="随机数"></a>随机数</h2><p>在Solidity中无法安全地生成随机数，Solidity 中最好的随机数生成器是 keccak256 哈希函数，可以这样来生成一些随机数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生成一个0到100的随机数:</span></span><br><span class="line">uint randNonce = <span class="number">0</span>;</span><br><span class="line">uint random = uint(keccak256(now, msg.sender, randNonce)) % <span class="number">100</span>;</span><br><span class="line">randNonce++;</span><br><span class="line">uint random2 = uint(keccak256(now, msg.sender, randNonce)) % <span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<p>这个方法可以被不诚实的节点攻击，假设我们有一个硬币翻转合约——正面你赢双倍钱，反面你输掉所有的钱。假如它使用上面的方法来决定是正面还是反面 (random &gt;= 50 算正面, random &lt; 50 算反面)。如果我正运行一个节点，我可以只对我自己的节点发布一个事务，且不分享它。我可以运行硬币翻转方法来偷窥我的输赢：如果我输了，我就不把这个事务包含进我要解决的下一个区块中去。我可以一直运行这个方法，直到我赢得了硬币翻转并解决了下一个区块，然后获利。</p>
<p>当然，这需要很大的算力来保证自己可以挖矿成功。</p>
<h2 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h2><p>可以使用throw来手动抛出一个异常。抛出异常的效果是当前的执行被终止且被撤销(值的改变和帐户余额的变化都会被回退)。异常还会通过Solidity的函数调用向上冒泡(bubbled up)传递。（send，和底层的函数调用call,delegatecall，callcode是一个例外，当发生异常时，这些函数返回false）。捕捉异常是不可能的。</p>
<p>require使得函数在执行过程中，当不满足某些条件时抛出错误，并停止执行：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sayHiToVitalik</span>(<span class="params">string _name</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">string</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 比较 _name 是否等于 &quot;Vitalik&quot;. 如果不成立，抛出异常并终止程序</span></span><br><span class="line">  <span class="comment">// (敲黑板: Solidity 并不支持原生的字符串比较, 我们只能通过比较</span></span><br><span class="line">  <span class="comment">// 两字符串的 keccak256 哈希值来进行判断)</span></span><br><span class="line">  <span class="built_in">require</span>(keccak256(_name) == keccak256(<span class="string">&quot;Vitalik&quot;</span>));</span><br><span class="line">  <span class="comment">// 如果返回 true, 运行如下语句</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;Hi!&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Sharer &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">sendHalf</span>(<span class="params">address addr</span>) <span class="title">payable</span> <span class="title">returns</span> (<span class="params">uint balance</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!addr.send(msg.value / <span class="number">2</span>))</span><br><span class="line">            <span class="keyword">throw</span>; <span class="comment">// also reverts the transfer to Sharer</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用户可以通过下述方式触发一个异常：</p>
<ul>
<li>调用throw。</li>
<li>调用require，但参数值为false。</li>
</ul>
<p>通过assert判断内部条件是否达成，require验证输入的有效性。这样的分析工具，可以假设正确的输入，减少错误。这样无效的操作码将永远不会出现。</p>
<p>assert 和 require 区别在于，require 若失败则会返还给用户剩下的 gas， assert 则不会。</p>
<h1 id="合约详解"><a href="#合约详解" class="headerlink" title="合约详解"></a>合约详解</h1><h2 id="合约"><a href="#合约" class="headerlink" title="合约"></a>合约</h2><p>Solidity中合约有点类似面向对象语言中的类。合约中有用于数据持久化的状态变量(state variables)，和可以操作他们的函数。调用另一个合约实例的函数时，会执行一个EVM函数调用，这个操作会切换执行时的上下文，这样，前一个合约的状态变量(state variables)就不能访问了。</p>
<p>合约可以通过Solidity，或不通过Solidity创建。当合约创建时，一个和合约同名的函数(构造器函数)会调用一次，用于初始化。构造器函数是可选的。仅能有一个构造器，所以不支持重载。</p>
<p>如果不通过Solidity，我们可以通过web3.js，使用JavaScript的API来完成合约创建。</p>
<p>当一个文件中有多个contract时，默认将合约名大写的那个合约当做主合约。</p>
<h2 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h2><p>修改为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">contract Test &#123;</span><br><span class="line">    <span class="keyword">constructor</span>() &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="析构函数"><a href="#析构函数" class="headerlink" title="析构函数"></a>析构函数</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">kill</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (owner == msg.sender) &#123; <span class="comment">// 检查谁在调用</span></span><br><span class="line">        selfdestruct(owner); <span class="comment">// 销毁合约</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="可见性和权限控制"><a href="#可见性和权限控制" class="headerlink" title="可见性和权限控制"></a>可见性和权限控制</h2><p>Solidity有两种函数调用方式，一种是内部调用，不会创建一个EVM调用（也叫做消息调用），另一种则是外部调用，会创建EVM调用（会发起消息调用）。Solidity对函数和状态变量提供了四种可见性。分别是external,public,internal,private。其中函数默认是public。状态变量默认的可见性是internal。</p>
<ul>
<li>external: 外部函数是合约接口的一部分，所以我们可以从其它合约或通过交易来发起调用。一个外部函数f，不能通过内部的方式来发起调用，（如f()不可以，但可以通过this.f()）。外部函数在接收大的数组数据时更加有效。</li>
<li>public: 可以在任何地方调用，不管是内部还是外部。对于public类型的状态变量，会自动创建一个访问器（详见下文）。</li>
<li>internal：这样声明的函数和状态变量只能通过内部访问。如在当前合约中调用，或继承的合约里调用。需要注意的是不能加前缀this，前缀this是表示通过外部方式访问。</li>
<li>private：私有函数和状态变量仅在当前合约中可以访问，在继承的合约内，不可访问。private修饰的函数名一般以”_”开头.</li>
</ul>
<p>备注：</p>
<ul>
<li>internal 和 private 类似，不过， 如果某个合约继承自其父合约，这个合约即可以访问父合约中定义的“内部”函数。</li>
<li>所有在合约内的东西对外部的观察者来说都是可见，将某些东西标记为private仅仅阻止了其它合约来进行访问和修改，但并不能阻止其它人看到相关的信息。</li>
<li>可见性的标识符的定义位置，对于state variable是在类型后面，函数是在参数列表和返回关键字中间。来看一个定义的例子：</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract C &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">uint a</span>) <span class="title">private</span> <span class="title">returns</span> (<span class="params">uint b</span>) </span>&#123; <span class="keyword">return</span> a + <span class="number">1</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setData</span>(<span class="params">uint a</span>) <span class="title">internal</span> </span>&#123; data = a; &#125;</span><br><span class="line">    uint public data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在下面的例子中，D可以调用c.getData()来访问data的值，但不能调用f。合约E继承自C，所以它可以访问compute函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract C &#123;</span><br><span class="line">    uint private data;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">uint a</span>) <span class="title">private</span> <span class="title">returns</span>(<span class="params">uint b</span>) </span>&#123; <span class="keyword">return</span> a + <span class="number">1</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setData</span>(<span class="params">uint a</span>) </span>&#123; data = a; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getData</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">returns</span>(<span class="params">uint</span>) </span>&#123; <span class="keyword">return</span> data; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">compute</span>(<span class="params">uint a, uint b</span>) <span class="title">internal</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123; <span class="keyword">return</span> a+b; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract D &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">readData</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        C c = <span class="keyword">new</span> C();</span><br><span class="line">        uint local = c.f(<span class="number">7</span>); <span class="comment">// error: member &quot;f&quot; is not visible</span></span><br><span class="line">        c.setData(<span class="number">3</span>);</span><br><span class="line">        local = c.getData();</span><br><span class="line">        local = c.compute(<span class="number">3</span>, <span class="number">5</span>); <span class="comment">// error: member &quot;compute&quot; is not visible</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract E is C &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">g</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        C c = <span class="keyword">new</span> C();</span><br><span class="line">        uint val = compute(<span class="number">3</span>, <span class="number">5</span>);  <span class="comment">// acces to internal member (from derivated to parent contract)</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="访问函数"><a href="#访问函数" class="headerlink" title="访问函数"></a>访问函数</h2><p>编译器为自动为所有的public的状态变量创建访问函数。下面的合约例子中，编译器会生成一个名叫data的无参，返回值是uint的类型的值data。状态变量的初始化可以在定义时完成。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract C&#123;</span><br><span class="line">    uint public c = <span class="number">10</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract D&#123;</span><br><span class="line">    C c = <span class="keyword">new</span> C();</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">getDataUsingAccessor</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">uint</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> c.c();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="函数修饰符"><a href="#函数修饰符" class="headerlink" title="函数修饰符"></a>函数修饰符</h2><p>modifier 可以用来改变一个函数的行为。比如用于在函数执行前检查某种前置条件。修改器是一种合约属性，可被继承，同时还可被派生的合约重写(override)。下面我们来看一段示例代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract owned &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">owned</span>(<span class="params"></span>) </span>&#123; owner = msg.sender; &#125;</span><br><span class="line">    address owner;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// This contract only defines a modifier but does not use</span></span><br><span class="line">    <span class="comment">// it - it will be used in derived contracts.</span></span><br><span class="line">    <span class="comment">// The function body is inserted where the special symbol</span></span><br><span class="line">    <span class="comment">// &quot;_;&quot; in the definition of a modifier appears.</span></span><br><span class="line">    <span class="comment">// This means that if the owner calls this function, the</span></span><br><span class="line">    <span class="comment">// function is executed and otherwise, an exception is</span></span><br><span class="line">    <span class="comment">// thrown.</span></span><br><span class="line">    modifier onlyOwner &#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.sender != owner)</span><br><span class="line">            <span class="keyword">throw</span>;</span><br><span class="line">        <span class="comment">// require(msg.sender == owner);</span></span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract mortal is owned &#123;</span><br><span class="line">    <span class="comment">// This contract inherits the &quot;onlyOwner&quot;-modifier from</span></span><br><span class="line">    <span class="comment">// &quot;owned&quot; and applies it to the &quot;close&quot;-function, which</span></span><br><span class="line">    <span class="comment">// causes that calls to &quot;close&quot; only have an effect if</span></span><br><span class="line">    <span class="comment">// they are made by the stored owner.</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>) <span class="title">onlyOwner</span> </span>&#123;</span><br><span class="line">        selfdestruct(owner);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract priced &#123;</span><br><span class="line">    <span class="comment">// Modifiers can receive arguments:</span></span><br><span class="line">    modifier costs(uint price) &#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.value &gt;= price) &#123;</span><br><span class="line">            _;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract Register is priced, owned &#123;</span><br><span class="line">    mapping (<span class="function"><span class="params">address</span> =&gt;</span> bool) registeredAddresses;</span><br><span class="line">    uint price;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Register</span>(<span class="params">uint initialPrice</span>) </span>&#123; price = initialPrice; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// It is important to also provide the</span></span><br><span class="line">    <span class="comment">// &quot;payable&quot; keyword here, otherwise the function will</span></span><br><span class="line">    <span class="comment">// automatically reject all Ether sent to it.</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"></span>) <span class="title">payable</span> <span class="title">costs</span>(<span class="params">price</span>) </span>&#123;</span><br><span class="line">        registeredAddresses[msg.sender] = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">changePrice</span>(<span class="params">uint _price</span>) <span class="title">onlyOwner</span> </span>&#123;</span><br><span class="line">        price = _price;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>修改器可以被继承，使用将modifier置于参数后，返回值前即可。</li>
<li>特殊_表示使用修改符的函数体的替换位置。</li>
<li>从合约Register可以看出全约可以多继承，通过<code>,</code>号分隔两个被继承的对象。</li>
<li>修改器也是可以接收参数的，如priced的costs。</li>
</ul>
<p>使用修改器实现的一个防重复进入的例子。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line">contract Mutex &#123;</span><br><span class="line">    bool locked;</span><br><span class="line">    modifier noReentrancy() &#123;</span><br><span class="line">        <span class="keyword">if</span> (locked) <span class="keyword">throw</span>;</span><br><span class="line">        locked = <span class="literal">true</span>;</span><br><span class="line">        _;</span><br><span class="line">        locked = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// This function is protected by a mutex, which means that</span></span><br><span class="line">    <span class="comment">/// reentrant calls from within msg.sender.call cannot call f again.</span></span><br><span class="line">    <span class="comment">/// The `return 7` statement assigns 7 to the return value but still</span></span><br><span class="line">    <span class="comment">/// executes the statement `locked = false` in the modifier.</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>) <span class="title">noReentrancy</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!msg.sender.call()) <span class="keyword">throw</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">7</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>例子中，由于call()方法有可能会调回当前方法，修改器实现了防重入的检查。如果同一个函数有多个修改器，他们之间以空格隔开，修饰器会依次检查执行。需要注意的是，在Solidity的早期版本中，有修改器的函数，它的return语句的行为有些不同。在修改器中和函数体内的显式的return语句，仅仅跳出当前的修改器和函数体。返回的变量会被赋值，但整个执行逻辑会在前一个修改器后面定义的”_”后继续执行。修改器的参数可以是任意表达式。在对应的上下文中，所有的函数中引入的符号，在修改器中均可见。但修改器中引入的符号在函数中不可见，因为它们有可能被重写。</p>
<h2 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h2><h3 id="常量-1"><a href="#常量-1" class="headerlink" title="常量"></a>常量</h3><p>状态变量可以被定义为constant，常量。这样的话，它必须在编译期间通过一个表达式赋值。赋值的表达式不允许：1）访问storage；2）区块链数据，如now，this.balance，block.number；3）合约执行的中间数据，如msg.gas；4）向外部合约发起调用。也许会造成内存分配副作用表达式是允许的，但不允许产生其它内存对象的副作用的表达式。内置的函数keccak256，keccak256，ripemd160，ecrecover，addmod，mulmod可以允许调用，即使它们是调用的外部合约。</p>
<p>允许内存分配，从而带来可能的副作用的原因是因为这将允许构建复杂的对象，比如，查找表。虽然当前的特性尚未完整支持。</p>
<p>编译器并不会为常量在storage上预留空间，每个使用的常量都会被对应的常量表达式所替换（也许优化器会直接替换为常量表达式的结果值）。</p>
<p>不是所有的类型都支持常量，当前支持的仅有值类型和字符串。</p>
<p>新版本中:</p>
<ul>
<li>view: 把函数定义为 view, 意味着它只能读取数据不能更改数据</li>
<li>pure: pure 函数表明这个函数不访问应用里的数据</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract C &#123;</span><br><span class="line">    uint constant x = <span class="number">32</span>**<span class="number">22</span> + <span class="number">8</span>;</span><br><span class="line">    string constant text = <span class="string">&quot;abc&quot;</span>;</span><br><span class="line">    bytes32 constant myHash = keccak256(<span class="string">&quot;abc&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="常函数"><a href="#常函数" class="headerlink" title="常函数"></a>常函数</h3><p>函数也可被声明为常量，这类函数将承诺自己不修改区块链上任何状态。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract C &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params">uint a, uint b</span>) <span class="title">constant</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> a * (b + <span class="number">42</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问器(Accessor)方法默认被标记为constant。当前编译器并未强制一个constant的方法不能修改状态。但建议大家对于不会修改数据的标记为constant。</p>
<h2 id="回退函数"><a href="#回退函数" class="headerlink" title="回退函数"></a>回退函数</h2><p>每一个合约有且仅有一个没有名字的函数。这个函数无参数，也无返回值。如果调用合约时，没有匹配上任何一个函数(或者没有传哪怕一点数据)，就会调用默认的回退函数。此外，当合约收到ether时（没有任何其它数据），这个函数也会被执行。在此时，一般仅有少量的gas剩余，用于执行这个函数(准确的说，还剩2300gas)。所以应该尽量保证回退函数使用少的gas。</p>
<p>下述提供给回退函数可执行的操作会比常规的花费得多一点。</p>
<ul>
<li>写入到存储(storage)</li>
<li>创建一个合约</li>
<li>执行一个外部(external)函数调用，会花费非常多的gas</li>
<li>发送ether</li>
</ul>
<p>请在部署合约到网络前，保证透彻的测试你的回退函数，来保证函数执行的花费控制在2300gas以内。一个没有定义一个回退函数的合约。如果接收ether，会触发异常，并返还ether（solidity v0.4.0开始）。所以合约要接收ether，必须实现回退函数。下面来看个例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Test &#123;</span><br><span class="line">    <span class="comment">// This function is called for all messages sent to</span></span><br><span class="line">    <span class="comment">// this contract (there is no other function).</span></span><br><span class="line">    <span class="comment">// Sending Ether to this contract will cause an exception,</span></span><br><span class="line">    <span class="comment">// because the fallback function does not have the &quot;payable&quot;</span></span><br><span class="line">    <span class="comment">// modifier.</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123; x = <span class="number">1</span>; &#125;</span><br><span class="line">    uint x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// This contract keeps all Ether sent to it with no way to get it back.</span></span><br><span class="line">contract Sink &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">payable</span> </span>&#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract Caller &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">callTest</span>(<span class="params">Test test</span>) </span>&#123;</span><br><span class="line">        test.call(<span class="number">0xabcdef01</span>); <span class="comment">// hash does not exist</span></span><br><span class="line">        <span class="comment">// results in test.x becoming == 1.</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// The following call will fail, reject the</span></span><br><span class="line">        <span class="comment">// Ether and return false:</span></span><br><span class="line">        test.send(<span class="number">2</span> ether);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="payable"><a href="#payable" class="headerlink" title="payable"></a>payable</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">contract OnlineStore &#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">buySomething</span>(<span class="params"></span>) <span class="title">external</span> <span class="title">payable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 检查以确定0.001以太发送出去来运行函数:</span></span><br><span class="line">    <span class="built_in">require</span>(msg.value == <span class="number">0.001</span> ether);</span><br><span class="line">    <span class="comment">// 如果为真，一些用来向函数调用者发送数字内容的逻辑</span></span><br><span class="line">    transferThing(msg.sender);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="提现"><a href="#提现" class="headerlink" title="提现"></a>提现</h2><p>在发送以太之后，它将被存储进合约的以太坊账户中，并冻结在哪里，可以写一个函数来从合约中提现以太，类似这样：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">contract GetPaid is Ownable &#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">withdraw</span>(<span class="params"></span>) <span class="title">external</span> <span class="title">onlyOwner</span> </span>&#123;</span><br><span class="line">    owner.transfer(<span class="built_in">this</span>.balance);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h2><p>事件是合约和区块链通讯的一种机制。前端应用“监听”某些事件，并做出反应。(触发事件需要添加emit关键字)</p>
<p>例子:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里建立事件</span></span><br><span class="line">event IntegersAdded(uint x, uint y, uint result);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">uint _x, uint _y</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">  uint result = _x + _y;</span><br><span class="line">  <span class="comment">//触发事件，通知app</span></span><br><span class="line">  emit IntegersAdded(_x, _y, result);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>app前端可以监听这个事件,JavaScript 实现如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">YourContract.IntegersAdded(<span class="function"><span class="keyword">function</span>(<span class="params">error, result</span>) </span>&#123; </span><br><span class="line">  <span class="comment">// 干些事</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract owned &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">owned</span>(<span class="params"></span>) </span>&#123; owner = msg.sender; &#125;</span><br><span class="line">    address owner;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// Use &quot;is&quot; to derive from another contract. Derived</span></span><br><span class="line"><span class="comment">// contracts can access all non-private members including</span></span><br><span class="line"><span class="comment">// internal functions and state variables. These cannot be</span></span><br><span class="line"><span class="comment">// accessed externally via `this`, though.</span></span><br><span class="line">contract mortal is owned &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">kill</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.sender == owner) selfdestruct(owner);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// These abstract contracts are only provided to make the</span></span><br><span class="line"><span class="comment">// interface known to the compiler. Note the function</span></span><br><span class="line"><span class="comment">// without body. If a contract does not implement all</span></span><br><span class="line"><span class="comment">// functions it can only be used as an interface.</span></span><br><span class="line">contract Config &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">lookup</span>(<span class="params">uint id</span>) <span class="title">returns</span> (<span class="params">address adr</span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">NameReg</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params">bytes32 name</span>);</span></span><br><span class="line"><span class="function">    <span class="title">function</span> <span class="title">unregister</span>(<span class="params"></span>);</span></span><br><span class="line"><span class="function"> &#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">// <span class="title">Multiple</span> <span class="title">inheritance</span> <span class="title">is</span> <span class="title">possible</span>. <span class="title">Note</span> <span class="title">that</span> &quot;<span class="title">owned</span>&quot; <span class="title">is</span></span></span><br><span class="line"><span class="function">// <span class="title">also</span> <span class="title">a</span> <span class="title">base</span> <span class="title">class</span> <span class="title">of</span> &quot;<span class="title">mortal</span>&quot;, <span class="title">yet</span> <span class="title">there</span> <span class="title">is</span> <span class="title">only</span> <span class="title">a</span> <span class="title">single</span></span></span><br><span class="line"><span class="function">// <span class="title">instance</span> <span class="title">of</span> &quot;<span class="title">owned</span>&quot; (<span class="params">as for virtual inheritance in C++</span>).</span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">named</span> <span class="title">is</span> <span class="title">owned</span>, <span class="title">mortal</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">named</span>(<span class="params">bytes32 name</span>) </span>&#123;</span><br><span class="line">        Config config = Config(<span class="number">0xd5f9d8d94886e70b06e474c3fb14fd43e2f23970</span>);</span><br><span class="line">        NameReg(config.lookup(<span class="number">1</span>)).register(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Functions can be overridden by another function with the same name and</span></span><br><span class="line">    <span class="comment">// the same number/types of inputs.  If the overriding function has different</span></span><br><span class="line">    <span class="comment">// types of output parameters, that causes an error.</span></span><br><span class="line">    <span class="comment">// Both local and message-based function calls take these overrides</span></span><br><span class="line">    <span class="comment">// into account.</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">kill</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.sender == owner) &#123;</span><br><span class="line">            Config config = Config(<span class="number">0xd5f9d8d94886e70b06e474c3fb14fd43e2f23970</span>);</span><br><span class="line">            NameReg(config.lookup(<span class="number">1</span>)).unregister();</span><br><span class="line">            <span class="comment">// It is still possible to call a specific</span></span><br><span class="line">            <span class="comment">// overridden function.</span></span><br><span class="line">            mortal.kill();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// If a constructor takes an argument, it needs to be</span></span><br><span class="line"><span class="comment">// provided in the header (or modifier-invocation-style at</span></span><br><span class="line"><span class="comment">// the constructor of the derived contract (see below)).</span></span><br><span class="line">contract PriceFeed is owned, mortal, named(<span class="string">&quot;GoldFeed&quot;</span>) &#123;</span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">updateInfo</span>(<span class="params">uint newInfo</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (msg.sender == owner) info = newInfo;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span>) <span class="title">constant</span> <span class="title">returns</span>(<span class="params">uint r</span>) </span>&#123; <span class="keyword">return</span> info; &#125;</span><br><span class="line"></span><br><span class="line">   uint info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="基类构造器的方法"><a href="#基类构造器的方法" class="headerlink" title="基类构造器的方法"></a>基类构造器的方法</h3><p>派生的合约需要提供所有父合约需要的所有参数，所以用两种方式来做，见下面的例子：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Base &#123;</span><br><span class="line">    uint x;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Base</span>(<span class="params">uint _x</span>) </span>&#123; x = _x; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract Derived is Base(<span class="number">7</span>) &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Derived</span>(<span class="params">uint _y</span>) <span class="title">Base</span>(<span class="params">_y * _y</span>) </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者直接在继承列表中使用is Base(7)，或像修改器(modifier)使用方式一样，做为派生构造器定义头的一部分Base(_y * _y)。第一种方式对于构造器是常量的情况比较方便，可以大概说明合约的行为。第二种方式适用于构造的参数值由派生合约的指定的情况。在上述两种都用的情况下，第二种方式优先(一般情况只用其中一种方式就好了)。</p>
<h3 id="继承有相同名字的不同类型成员"><a href="#继承有相同名字的不同类型成员" class="headerlink" title="继承有相同名字的不同类型成员"></a>继承有相同名字的不同类型成员</h3><p>当继承最终导致一个合约同时存在多个相同名字的修改器或函数，它将被视为一个错误。同新的如果事件与修改器重名，或者函数与事件重名都将产生错误。作为一个例外，状态变量的getter可以覆盖一个public的函数。</p>
<h2 id="抽象-Abstract-Contracts"><a href="#抽象-Abstract-Contracts" class="headerlink" title="抽象(Abstract Contracts)"></a>抽象(Abstract Contracts)</h2><p>抽象函数是没有函数体的的函数。如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Feline &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">utterance</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">bytes32</span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>

<p>这样的合约不能通过编译，即使合约内也包含一些正常的函数。但它们可以做为基合约被继承。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract Feline &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">utterance</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">bytes32</span>);</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    <span class="title">function</span> <span class="title">getContractName</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">string</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Feline&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract Cat is Feline &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">utterance</span>(<span class="params"></span>) <span class="title">returns</span> (<span class="params">bytes32</span>) </span>&#123; <span class="keyword">return</span> <span class="string">&quot;miaow&quot;</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果一个合约从一个抽象合约里继承，但却没实现所有函数，那么它也是一个抽象合约。</p>
<h2 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h2><p>接口与抽象合约类似，与之不同的是，接口内没有任何函数是已实现的，同时还有如下限制：</p>
<ul>
<li>不能继承其它合约，或接口。</li>
<li>不能定义构造器</li>
<li>不能定义变量</li>
<li>不能定义结构体</li>
<li>不能定义枚举类</li>
<li>其中的一些限制可能在未来放开。</li>
</ul>
<p>接口基本上限制为合约ABI定义可以表示的内容，ABI和接口定义之间的转换应该是可能的，不会有任何信息丢失。接口用自己的关键词表示：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">interface Token &#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address recipient, uint amount</span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>

<p>合约可以继承于接口，因为他们可以继承于其它的合约。</p>
<h1 id="Gas优化"><a href="#Gas优化" class="headerlink" title="Gas优化"></a>Gas优化</h1><ul>
<li>结构体中尽量使用uint的少位数，且考虑字节对其</li>
<li>“view” 函数不花 “gas”，这是因为 view 函数不会真正改变区块链上的任何数据。如果一个 view 函数在另一个函数的内部被调用，而调用函数与 view 函数的不属于同一个合约，也会产生调用成本。这是因为如果主调函数在以太坊创建了一个事务，它仍然需要逐个节点去验证。所以标记为 view 的函数只有在外部调用时才是免费的(当玩家从web.js外部调用)。</li>
<li>在大多数编程语言中，遍历大数据集合都是昂贵的。但是在 Solidity 中，使用一个标记了external view的函数，遍历比 storage 要便宜太多，因为 view 函数不会产生任何花销。</li>
<li>为了降低成本，不到万不得已，避免将数据写入存储。这也会导致效率低下的编程逻辑：比如每次调用一个函数，都需要在 memory(内存) 中重建一个数组，而不是简单地将上次计算的数组给存储下来以便快速查找。</li>
</ul>
<h1 id="智能合约升级"><a href="#智能合约升级" class="headerlink" title="智能合约升级"></a>智能合约升级</h1><p>将合约进行分离，先部署数据合约，部署后不变。业务合约调用数据合约读取修改数据。保证数据类型不变的情况下，可以对业务合约进行修改，新增。之后部署新的业务合约，废除旧的业务合约。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract DataContract &#123;</span><br><span class="line">    mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint256) public balanceOf;</span><br><span class="line">    mapping (<span class="function"><span class="params">address</span> =&gt;</span> bool) accessAllowed;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">DataContract</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        accessAllowed[msg.sender] = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setBlance</span>(<span class="params">address _address,uint256 v</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        balanceOf[_address] = v;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    modifier platform() &#123;</span><br><span class="line">        <span class="built_in">require</span>(accessAllowed[msg.sender] == <span class="literal">true</span>);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">allowAccess</span>(<span class="params">address _addr</span>) <span class="title">platform</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">        accessAllowed[_addr] = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">denyAccess</span>(<span class="params">address _addr</span>) <span class="title">platform</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">        accessAllowed[_addr] = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract ControlContract &#123;</span><br><span class="line"></span><br><span class="line">    DataContract dataContract;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ControlContract</span>(<span class="params">address _dataContractAddr</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        dataContract = DataContract(_dataContractAddr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">addTen</span>(<span class="params">address addr</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">uint</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dataContract.balanceOf(addr) + <span class="number">11</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>部署方法如下：</p>
<ol>
<li>先部署DataContract合约。</li>
<li>使用DataContract合约地址作为部署ControlContract合约的参数。</li>
<li>用ControlContract合约地址作为参数调用DataContract合约的allowAccess方法。</li>
</ol>
<p>如果需要更新控制合约(如修复了addTen)则重新执行第2-3步，同时对老的控制合约执行denyAccess()。</p>
<h1 id="代币"><a href="#代币" class="headerlink" title="代币"></a>代币</h1><p>一个代币在以太坊上就是一个遵循一些共同规则的智能合约：以太坊代币标准(ERC-Token Standard)。建立在以太坊网络上的区块链项目代币，需要遵从以下几种代币标准：ERC-20，ERC-223，ERC-621，ERC-721，ERC-827。其中 ERC 是 Ethereum Request for Comments 的简称。</p>
<h2 id="ERC-20"><a href="#ERC-20" class="headerlink" title="ERC-20"></a>ERC-20</h2><p>这是最广泛被大家认可的一种代币形式，简单的列举一些通用的标准函数：</p>
<ul>
<li>function totalSupply() 定义 Token 的总量；</li>
<li>function balanceOf(address tokenOwner) 显示用户账户余额；</li>
<li>function allowance(address tokenOwner, address spender) 返回剩余金额，显示 address spender 能从 address tokenOwner 里提取的数量；</li>
<li>function transfer(address to, uint tokens) 转移对应的金额到指定地址；</li>
<li>function approve(address spender, uint tokens)  returns (bool success) 允许  address spender 提取部分 Token；</li>
<li>function transferFrom(address from, address to, uint tokens) returns (bool success) 从一个地址转移 token 到另一个地址；</li>
</ul>
<p>拥有以上所有必要的函数实现我们称为兼容 ERC-20 标准，但在具体实现中会做一些扩展，比如 ERC-223。</p>
<h2 id="ERC-223"><a href="#ERC-223" class="headerlink" title="ERC-223"></a>ERC-223</h2><p>这个标准支持所有 ERC-20 的函数、智能合约以及服务，并解决了一些 ERC-20 的缺陷，比如说：在 ERC-20 标准下如果你输入了错误的收款地址，你转账的费用可能会永远丢失，但在 ERC-223 里这个问题被避免了，同时在这个标准下你需要消耗的 GAS 费用只有 ERC-20 的一半。</p>
<h2 id="ERC-621"><a href="#ERC-621" class="headerlink" title="ERC-621"></a>ERC-621</h2><p>ERC-621 也是一个基于 ERC-20 升级的标准，解决了 ERC-20 不允许 Token 总量更改的问题，不过为了解决这个问题，ERC-621 增加了两种新的函数：</p>
<p>increaseSupply 和 decreaseSupply</p>
<h2 id="ERC-827"><a href="#ERC-827" class="headerlink" title="ERC-827"></a>ERC-827</h2><p>这个标准比 ERC-20 更加灵活，除用于转账外，还可以转移数据和让第三方在获取用户允许的情况下为用户转账。</p>
<h2 id="ERC-721"><a href="#ERC-721" class="headerlink" title="ERC-721"></a>ERC-721</h2><p>ERC-721 与 ERC-20 有很大的区别，如果说 ERC-20 与 ERC-223，ERC-621 能够在使用中自由转换的话，ERC-721 是不可与 ERC-20 Token 互相转换的，因为 ERC-721 拥有唯一性。这种 Token 依然可以在交易所里交易，只不过无法分割是一个独立的整体。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">contract ERC721 &#123;</span><br><span class="line">  event Transfer(address indexed _from, address indexed _to, uint256 _tokenId);</span><br><span class="line">  event Approval(address indexed _owner, address indexed _approved, uint256 _tokenId);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address _owner</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint256 _balance</span>);</span></span><br><span class="line"><span class="function">  <span class="title">function</span> <span class="title">ownerOf</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">address _owner</span>);</span></span><br><span class="line"><span class="function">  <span class="title">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span>;</span></span><br><span class="line"><span class="function">  <span class="title">function</span> <span class="title">approve</span>(<span class="params">address _to, uint256 _tokenId</span>) <span class="title">public</span>;</span></span><br><span class="line"><span class="function">  <span class="title">function</span> <span class="title">takeOwnership</span>(<span class="params">uint256 _tokenId</span>) <span class="title">public</span>;</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>

<p>ERC721 规范有两种不同的方法来转移代币：</p>
<ol>
<li>第一种方法是代币的拥有者调用transfer 方法，传入他想转移到的 address 和他想转移的代币的 _tokenId。</li>
<li>第二种方法是代币拥有者首先调用 approve，然后传入与以上相同的参数。接着，该合约会存储谁被允许提取代币，通常存储到一个 mapping (uint256 =&gt; address) 里。然后，当有人调用 takeOwnership 时，合约会检查 msg.sender 是否得到拥有者的批准来提取代币，如果是，则将代币转移给他。<ul>
<li>所有者，用新主人的 address 和你希望他获取的 _tokenId 来调用 approve</li>
<li>新主人用 _tokenId 来调用 takeOwnership，合约会检查确保他获得了批准，然后把代币转移给他。</li>
</ul>
</li>
</ol>
<h1 id="库"><a href="#库" class="headerlink" title="库"></a>库</h1><h2 id="Ownable"><a href="#Ownable" class="headerlink" title="Ownable"></a>Ownable</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title <span class="variable">Ownable</span></span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@dev </span>The Ownable contract has an owner address, and provides basic authorization control</span></span><br><span class="line"><span class="comment"> * functions, this simplifies the implementation of &quot;user permissions&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract Ownable &#123;</span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  event OwnershipTransferred(address indexed previousOwner, address indexed newOwner);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@dev </span>The Ownable constructor sets the original `owner` of the contract to the sender</span></span><br><span class="line"><span class="comment">   * account.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Ownable</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@dev </span>Throws if called by any account other than the owner.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  modifier onlyOwner() &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.sender == owner);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@dev </span>Allows the current owner to transfer control of the contract to a newOwner.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param </span>newOwner The address to transfer ownership to.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transferOwnership</span>(<span class="params">address newOwner</span>) <span class="title">public</span> <span class="title">onlyOwner</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(newOwner != address(<span class="number">0</span>));</span><br><span class="line">    OwnershipTransferred(owner, newOwner);</span><br><span class="line">    owner = newOwner;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SafeMath"><a href="#SafeMath" class="headerlink" title="SafeMath"></a>SafeMath</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">library SafeMath &#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">mul</span>(<span class="params">uint256 a, uint256 b</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    uint256 c = a * b;</span><br><span class="line">    assert(c / a == b);</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">div</span>(<span class="params">uint256 a, uint256 b</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// assert(b &gt; 0); // Solidity automatically throws when dividing by 0</span></span><br><span class="line">    uint256 c = a / b;</span><br><span class="line">    <span class="comment">// assert(a == b * c + a % b); // There is no case in which this doesn&#x27;t hold</span></span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sub</span>(<span class="params">uint256 a, uint256 b</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">    assert(b &lt;= a);</span><br><span class="line">    <span class="keyword">return</span> a - b;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">uint256 a, uint256 b</span>) <span class="title">internal</span> <span class="title">pure</span> <span class="title">returns</span> (<span class="params">uint256</span>) </span>&#123;</span><br><span class="line">    uint256 c = a + b;</span><br><span class="line">    assert(c &gt;= a);</span><br><span class="line">    <span class="keyword">return</span> c;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SafeMath 库允许使用 using 关键字，它可以自动把库的所有方法添加给一个数据类型：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">using SafeMath <span class="keyword">for</span> uint;</span><br><span class="line"><span class="comment">// 这下我们可以为任何 uint 调用这些方法了</span></span><br><span class="line">uint test = <span class="number">2</span>;</span><br><span class="line">test = test.mul(<span class="number">3</span>); <span class="comment">// test 等于 6 了</span></span><br><span class="line">test = test.add(<span class="number">5</span>); <span class="comment">// test 等于 11 了</span></span><br></pre></td></tr></table></figure>

<p>所以简而言之， SafeMath 的 add， sub， mul， 和 div 方法只做简单的四则运算，然后在发生溢出或下溢的时候抛出错误。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/10/%E8%BF%85%E9%9B%B7%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/10/%E8%BF%85%E9%9B%B7%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">迅雷案例分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-10 21:19:46" itemprop="dateCreated datePublished" datetime="2018-12-10T21:19:46+08:00">2018-12-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:58" itemprop="dateModified" datetime="2021-05-14T14:14:58+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BD%9C%E4%B8%9A/" itemprop="url" rel="index"><span itemprop="name">作业</span></a>
                </span>
            </span>

          
            <span id="/2018/12/10/%E8%BF%85%E9%9B%B7%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/" class="post-meta-item leancloud_visitors" data-flag-title="迅雷案例分析" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2018/12/10/%E8%BF%85%E9%9B%B7%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018/12/10/%E8%BF%85%E9%9B%B7%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>”深圳市迅雷网络技术有限公司“前身称“深圳市三代科技开发有限公司”（简称“三代科技”），三代科技开发有限公司于2002年底由邹胜龙先生及程浩先生始创于美国硅谷。2003年1月底，两位创办者回国发展并正式成立深圳市三代科技开发有限公司（简称“三代科技”）。由于发展的需要，“三代科技”于2005年5月正式更名为“深圳市迅雷网络技术有限公司”，暨迅雷在大中华区的研发中心和运营中心。即我们通常所称的“迅雷”。</p>
<p>迅雷立足于为全球互联网提供最好的多媒体下载服务。经过艰苦创业，迅雷在大中华地区以领先的技术和诚信的服务，赢得广大用户的深深喜爱和许多合作伙伴的认同与支持。公司旗舰产品，迅雷，已经成为中国互联网最流行的应用服务软件之一。后又陆续开始进军云计算与区块链领域，推出了玩客云，星域云和迅雷链等产品。<font color="0000FF">[1]</font></p>
<h2 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h2><p>迅雷的一些发展历程：</p>
<ul>
<li>2006年，迅雷用户数突破1亿，成为用户规模最大的下载加速软件</li>
<li>2007年，迅雷首次对外发布视频业务迅雷看看</li>
<li>2008年，发布迅雷软件助手、迅雷游戏、迅雷安全助手等</li>
<li>2009年，迅雷群侠传网页游戏发布；迅雷会员系统正式发布</li>
<li>2010年，迅雷用户数突破3亿，付费用户达100万</li>
<li>2011年，迅雷看看成为国内首家实现全网高清的在线视频网站</li>
<li>2012年，手机迅雷发布，手机下载进入高速时代</li>
<li>2013年，迅雷用户数突破4.6亿，付费用户达520万</li>
<li>2014年，迅雷开始做云计算和CDN服务</li>
<li>2015年，迅雷、小米联合发布“星域CDN”，随后星域CDN陆续与小米、爱奇艺达成战略合作；迅雷赚钱宝Pro上市，引发用户秒抢热潮</li>
<li>2016年，迅雷赚钱宝全新升级为星域共享平台，获得超过400万“玩客”支持；星域CDN发布“卓越版”和“标准版”直播新品，成为小米、爱奇艺、熊猫直播、bilibili、陌陌等百家企业直播业务首选服务商</li>
<li>2017年，迅雷短视频日均播放量破亿；迅雷召开玩客云战略发布会，宣布共享计算和区块链的全新战略</li>
<li>2018年，超级区块链平台迅雷链正式发布，引领区块链进入3.0时代；星域CDN升级为综合型云计算平台——星域云；迅雷举办全球区块链应用大赛</li>
</ul>
<h2 id="事件"><a href="#事件" class="headerlink" title="事件"></a>事件</h2><p>提起”迅雷“这个词，可能大部分的人心中都是满满的回忆感，如一个相处十多年的老友般熟悉，可如今细细想来，去网上搜一搜迅雷现在的业务，却会发现现在的迅雷早已经不是当初那个只有下载业务，靠着会员收费盈利的公司了，它早已不仅仅是一个简单的下载工具了。</p>
<p>迅雷早期的时候，是一个比较纯粹的下载工具，在下载领域，前前后后出现过许多的下载工具，如QQ旋风，VeryCD电驴,快车等，也都成功过，但在技术与行业的发展之下，最终活下来的只有迅雷。在2007年前后，几乎每个PC用户有两个软件都是必装的，一个是QQ，而另一个便是迅雷。当时迅雷用户达到了4亿，装机量达到8000万台，市场份额超过50%，是中国互联网仅次于QQ的客户端软件。而达到这一成就，迅雷仅仅用了4年。这样的迅雷曾经感染了无数的有志青年，在那段时间，有许多的腾讯员工跳槽到了迅雷，弄得腾讯非常紧张，甚至影响到了马化腾。腾讯前产品运营副总监黄卓生回忆道，“Pony挺忌惮这个事，在内部开会，要抢占这个入口，在PC时代，大家都还在强调装机量。”<font color="0000FF">[2]</font> 腾讯后来推出了QQ旋风，可惜最后也败下阵来，停更下架。</p>
<p>然而，迅雷却没有如腾讯等公司一样抓住发展的机遇，扶摇直上，发展成为互联网大头，反之，迅雷前几年一直在走下坡路，接连错过了许多的发展机遇与风口，慢慢地从巨无霸沦落成为了路人，而前段时间迅雷的内讧,也让人唏嘘。</p>
<p>曾经有许多专业人士，其中也包括迅雷自己内部的管理人员，对迅雷错过的一些风口做过总结，迅雷在互联网的发展过程中，先后错过了”浏览器”，“流媒体”以及“应用商店”等重要的机遇。一观迅雷的发展历程，迅雷都曾从这些风口中找到过切入点，投入过一小部分资源发展这些方向，但大部分都浅尝辄止，等到重点投入资源的时候，已经是红海市场了。</p>
<h2 id="转折"><a href="#转折" class="headerlink" title="转折"></a>转折</h2><p>2014年11月，前腾讯云计算公司总裁陈磊正式出任迅雷CTO，同时兼任迅雷旗下网心科技CEO，2015年11月，迅雷董事会通过决议任命陈磊为迅雷网络技术有限公司联席CEO。陈磊曾在腾讯负责过腾讯云和腾讯开放平台的管理工作，也曾在Google和微软从事过云计算相关的工作。由下载工具起家的迅雷，却选了一个云计算相关的人才做CEO，事情自然会有所转折。</p>
<p>果然，陈磊没有辜负大家的期望。在他上任后，他对公司业务方向做出了果断的调整，始终坚持以技术创新带动业务发展的策略，也取得了一些阶段性的成果。近两年来，迅雷推出了一个名为星域云的产品，这是一款创新型的云计算产品。2017年年初，迅雷的云计算业务营收规模开始高速增长，连续多个季度均保持数十个百分比的增速。在云计算业务的拉动下，迅雷逐渐突破了原有的商业模式，不再局限于传统的下载业务，而是在其基础之上衍生出了一些更具发展前景的新业务。</p>
<p>2018年11月14日，迅雷正式发布了截至2018年9月30日的第三季度未经审计的财务报告。财报显示，迅雷报告期内总营收为4530万美元，同比增长1.1%，连续3年实现同比增长；毛利率52.7%，而2017年同期为35.5%。<font color="0000FF">[3]</font></p>
<p>而毛利率提升的主要原因来自于带宽成本的大幅降低，这主要得益于迅雷独有的共享计算模式，它通过玩客云收集闲置的带宽资源，进行再分配，从而让用户就近获取内容，加快访问速度。而对于用户来说，它通过赚钱宝奖励的方式使用户贡献出自己的闲置带宽，用户从中获得奖励，而迅雷则使得这些用户无形之中都成为了自己的CDN节点，大幅度地降低了部署CDN的成本。</p>
<p>在云计算成为迅雷的业务重心后，它还在集中资源发展其区块链业务，吸取之前对错过的风口浅尝辄止的教训，看准了方向之后，All in区块链，在风口之上创新。迅雷是国内共享计算与区块链的先行者，已实现将区块链技术与共享计算业务结合，吸引了海量共享计算的参与者。2018年4月，迅雷正式发布了当前全球范围内唯一实现百万TPS性能的主链——迅雷链，同期迅雷也举办了一场全球区块链开发大赛，为迅雷链聚集了两千多名来自世界各地的开发者。在7月初的大赛决赛上，迅雷又发布了其自主研发的一个迅雷链文件系统TCFS(Thunder Chain File System)，进一步完善了迅雷链的开发者生态。这些技术高度让迅雷成为国内区块链行业的领军者，目前迅雷链已经向生态化发展，并被视为区块链3.0时代的标杆性主链。</p>
<p>在今年的第三季度，迅雷及旗下网心科技被中国管理科学研究院授予“中国区块链技术示范基地”，以表彰迅雷在区块链行业的领头作用以及为行业发展做出的重大贡献。同年10月份，在世界级管理奖项“拉姆.查兰管理实践奖”的评选中，迅雷集团凭借近几年的成功转型实践，荣获了这一管理界的重量级荣誉奖项。</p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>平心而论，迅雷的技术能力是很强的，它本身也长于技术上的创新，他们发明了P2SP的内容传输算法，并第一个将之用于实际应用，同时也第一个将P2SP应用在流媒体点播领域。在最近一年，迅雷又用共享的思想颠覆了传统CDN的应用方式，通过玩客云将家庭中原本闲置的带宽、存储和计算资源收集回收，转化为低成本的云计算服务输送至互联网企业。共享计算绕开了传统云计算耗能耗资巨大的数据中心模式，从而得以实现带宽成本的大幅度降低。</p>
<p>然而，迅雷之所以错过了这么多的机遇，有一个原因是没有定好一个准确而正确的战略，战略上的不确定，会导致战术的失误，也因此，迅雷虽然都有涉足过浏览器，流媒体以及应用商店等方向，却都没有深入地进行研究与开发，没有All in 他们的优势资源，最终导致当行业已经到了红海之时，已经失去了最好的时机。</p>
<p>而对于当时的CEO邹胜龙先生来说，很多人把矛头指向了他。他过于干涉项目，总是亲自去参与某些项目，自身过于深入项目的细节。CEO在很多时候，应该关注大方向，而不是过度执着于某些细节，不然反而会成为项目进行的阻碍。在迅雷的历史上，有几个里程碑式的大版本，比如说迅雷6，就是邹胜龙亲自关心开发的，最后却都不了了之。和他对比鲜明的是马化腾，马化腾自己会亲自去体验产品，对产品的细节要求很严格，但他从来只把握大方向，提出要修改的细节，却不会干涉项目具体的执行。</p>
<p>另外，邹胜龙先生也过于关注技术了，总给人一种理工男，技术宅的感觉，从没有站出来为自己的产品代言过。而且他凡事太过于精打细算，放不开。就像当年做视频一样，他由于觉得版权价格太高而选择了退出，结果却错失良机。</p>
<p>在迅雷的巅峰岁月2007的年初，《环球企业家》杂志采访邹胜龙，问他当年的最重要目标是什么，邹胜龙的回答却是：“保住目前的市场份额”。当时的竞争已经很激烈了，腾讯的竞争产品已经推出来了，网际快车也准备卷土重来。然而他的目标不是与竞争对手争，而是保住目前的市场份额，这也许是跟他的性格有关吧，他不喜欢打仗，喜欢关起门来把事做好，一个标准的技术男形象。</p>
<p>在陈磊上任CEO之后，针对迅雷的发展，提出了改革和转型的方案，突破传统的局限，开展新业务，进军云计算和区块链的领域，不止在技术上创新，同时也追求商业模式上的创新，抓住发展趋势，明确战略方向，重点投入资源发展，使这个曾经的巨无霸有了新的转机与发展。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><ul>
<li>领导者不应事事亲为，过分拘泥于细节</li>
<li>领导者需要有长远的眼光，不能只在意眼前的得失</li>
<li>领导者需要能看清楚发展的趋势，企业或者公司需要有明确的战略方向，才能决定投入的资源比例，才能抓住机遇。</li>
<li>在互联网行业，需要有创新才能更好地发展，如果故步自封，踟蹰不前，则终将被淘汰。</li>
<li>技术创新固然重要，商业模式上的创新也不容忽视。</li>
</ul>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p><font color="0000FF">[1]</font>：百度百科词条：深圳市迅雷网络技术有限公司<br><font color="0000FF">[2]</font>：投资界：<a target="_blank" rel="noopener" href="https://news.pedaily.cn/201711/423767.shtml">https://news.pedaily.cn/201711/423767.shtml</a><br><font color="0000FF">[3]</font>：同花顺财经：<a target="_blank" rel="noopener" href="http://stock.10jqka.com.cn/usstock/20181114/c608162184.shtml">http://stock.10jqka.com.cn/usstock/20181114/c608162184.shtml</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/05/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/05/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">区块链入门笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-05 21:20:32" itemprop="dateCreated datePublished" datetime="2018-12-05T21:20:32+08:00">2018-12-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/" itemprop="url" rel="index"><span itemprop="name">区块链</span></a>
                </span>
            </span>

          
            <span id="/2018/12/05/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="区块链入门笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2018/12/05/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018/12/05/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="区块链概述"><a href="#区块链概述" class="headerlink" title="区块链概述"></a>区块链概述</h1><p>区块链并非单一创新技术，而是将许多跨领域技术凑在一起，包括密码学、数学、演算法与经济模型，并结合点对点网路关系，利用数学基础就能建立信任效果，成为一个不需基于彼此信任基础、也不需仰赖单一中心化机构就能够运作的分散式系统，而比特币便是第一个采用区块链技术而打造出的一套P2P电子现金系统，用来实现一个可去中心化，并确保交易安全性、可追踪性的数位货币体系。</p>
<p>区块链:一种特殊的公开的分布式数据库,具有分布式存储，分布式记录，去中心化，分布式维护等特性。</p>
<ul>
<li>全民记账</li>
<li>不可篡改（只能增查,不能改删）</li>
<li>可追溯</li>
<li>去中心化</li>
</ul>
<p>核心技术：</p>
<ul>
<li>区块链底层</li>
<li>智能合约</li>
<li>密码学和数字签名用于身份地址标识</li>
<li>共识算法用于工作量证明</li>
<li>分布式存储技术用于存储交易记录和区块，分布式网络技术用于网络通信和节点发现</li>
</ul>
<p>区块链分类:</p>
<ul>
<li>共有链</li>
<li>私有链</li>
<li>联盟链</li>
</ul>
<p>区块链版本：</p>
<ul>
<li>区块链1.0-可编程货币：数字货币去中心化，数字化货币及支付系统</li>
<li>区块链2.0-可编程金融：智能合约，数字资产，金融应用</li>
<li>区块链3.0-可编程社会：去中心化互信网络，去中心化信任机制，公证，仲裁，审计，物流，医疗等领域</li>
</ul>
<p>区块链2.0是指智能合约,智能合约与货币相结合,对金融领域提供了更加广泛的应用场景，代表是’以太坊’，以太坊 = 区块链 + 智能合约。</p>
<img src="区块链的发展.png"/>

<h1 id="账本验证"><a href="#账本验证" class="headerlink" title="账本验证"></a>账本验证</h1><ul>
<li>Hash</li>
</ul>
<h1 id="账户所有权"><a href="#账户所有权" class="headerlink" title="账户所有权"></a>账户所有权</h1><p>非对称加密：公开密钥与私有密钥是一对，如果用公开密钥对数据进行加密，只有用对应的私有密钥才能解密；因为加密和解密使用的是两个不同的密钥，所以这种算法叫作非对称加密算法。</p>
<ul>
<li>账户用一个地址（Hash值）来标识</li>
<li>一个地址拥有一个私钥（如果私钥丢失了，比特币可能会丢失；私钥丢失了的话，是不能找回的；私钥可以通过两次哈希处理得到地址，而地址不能推导出私钥；非对称）</li>
<li>不泄露私钥的情况下证明我们拥有某个地址的私钥：通过交易签名（非对称）的方式<ul>
<li>把交易进行Hash得到摘要</li>
<li>用私钥对摘要进行签名（加密）,同时私钥也生成付款方的公钥</li>
<li>广播交易，验证信息</li>
<li>用签名和付款方的公钥进行验证，返回交易摘要，验证是否是原始的交易信息（解密）</li>
</ul>
</li>
</ul>
<p>私钥-公钥关系:</p>
<ul>
<li>公钥和私钥成对出现</li>
<li>公开的密钥叫公钥，只有自己知道的叫私钥</li>
<li>用公钥加密的数据只有对应的私钥可以解密</li>
<li>用私钥加密的数据只有对应的公钥可以解密</li>
<li>如果可以用公钥解密，则必然是对应的私钥加的密</li>
<li>如果可以用私钥解密，则必然是对应的公钥加的密</li>
</ul>
<img src="私钥和公钥.png"/>

<h1 id="钱包"><a href="#钱包" class="headerlink" title="钱包"></a>钱包</h1><p>加密数字货币是一种基于区块链技术的数字货币，加密数字货币钱包是专门用来管理这些资产的应用。加密数字货币钱包提供钱包地址的创建、加密数字货币转账、每个钱包地址交易历史的查询等基础金融功能。钱包应用按照密码学原理创建1个或多个钱包地址，每个钱包地址都对应1个密钥对：私钥和公钥。公钥是根据私钥进行一定的数学运算生成，与私钥一一对应。公钥主要是对外交易使用，每次交易都必须使用私钥对交易记录进行签名以证明对相关钱包地址里面的资产有控制权。私钥是唯一能够证明对于数字资产有控制权的凭证,因此对于数字资产钱包来说，私钥是最重要的。私钥的生成和存储方式决定了资产安全与否。因此，通常意义上的数字资产安全其实就是私钥的安全，一个钱包是不是安全主要看它能否安全的管理和使用私钥。</p>
<h1 id="挖矿（记账）"><a href="#挖矿（记账）" class="headerlink" title="挖矿（记账）"></a>挖矿（记账）</h1><ul>
<li>记账：Hash打包过程</li>
<li>节点消耗资源，有奖励</li>
</ul>
<p>挖矿-工作量证明：</p>
<ol>
<li>一段时间内，只有一人可以记账成功</li>
<li>通过解决密码学难题（即工作量证明）竞争获得唯一记账权</li>
<li>其他节点复制记账结果</li>
</ol>
<p>普通的hash打包过程会获得一个摘要信息（hash值），规定获得的摘要信息必须以特定值开头才能算作挖矿成功，获得唯一记账权，故需要引入一个“随机数”作为Hash运算的参数。</p>
<h1 id="共识机制"><a href="#共识机制" class="headerlink" title="共识机制"></a>共识机制</h1><ul>
<li>两个节点同时完成工作量证明，使用谁的区块，使用共识机制。</li>
<li>节点工作量只有在其他得节点认同其是有效的，因此会主动遵守规定</li>
<li>每个节点会选择一条累计工作量最大（最长）的区块链，延长最长链</li>
</ul>
<img src="分叉解决.png"/>

<p>例如，两个节点同时完成工作量证明，分别打包成3458A和3458B，周围的节点选择出累计工作量最大（/最长）的区块链为3458A后进行广播，以3458A作为主链，3458B作为备用链。若之后节点接收到3458B传来的3459B区块，周围的节点选择出累计工作量最大（/最长）的区块链为3458B&lt;——3459B，此时再把备用链3458B作为主链，3458B&lt;——3459B接入区块链。有时候某些节点先接收了3459B，此时会将3459B作为孤块保存，一旦该节点接收到3458B，就会将3458B&lt;——3459B接入区块链。</p>
<h1 id="交易原理"><a href="#交易原理" class="headerlink" title="交易原理"></a>交易原理</h1><p>当你发起一笔比特币交易后，将交易广播到全网，挖矿节点接收到交易后，先将其放入本地内存池进行一些基本验证，比如该笔交易发费的比特币是否是未被花费的交易，如果验证成功，则将其放入”未确认交易池“等待被打包，如果验证失败，则被标记为”无效交易“不会被打包，也就是说，旷工在寻找nonce的同时还需要及时验证每笔交易。</p>
<p>所谓比特币交易就是从一个比特币钱包向另一个中转账，每笔交易都有数字签名来保证安全。一个交易一旦发生那么就是对所有人都公开的，每个交易的历史可以最终追溯到相应的比特币最初被挖出来的那个点。</p>
<p>比特币转账需要支付给旷工手续费，按交易所占的字节数计费，旷工一般会优先打包手续费高的交易到区块里。</p>
<h2 id="比特币的UTXO模型"><a href="#比特币的UTXO模型" class="headerlink" title="比特币的UTXO模型"></a>比特币的UTXO模型</h2><p>比特币系统没有余额的概念，它使用的是UTXO模型（Unspent Transaction Outputs，未使用过的交易输出），我们在交易过程中经常说的钱包余额，实际上是一个钱包地址的UTXO集合。所以，在比特币网络中，存储比特币余额的是交易输出，准确点说就是未使用过的交易输出，而每一笔交易的输入实际上引用的是上一笔交易的输出。所以，要计算一个用户的比特币余额，就需要遍历整个交易的历史。而以太坊由于采用了Account模型，也就是采用余额的概念，所以不需要溯源整个交易历史。</p>
<img src="交易输入输出过程.jpg"/>

<h2 id="交易分类"><a href="#交易分类" class="headerlink" title="交易分类"></a>交易分类</h2><p>交易分为2类：</p>
<ul>
<li>Coinbase交易：挖矿奖励，没有输入，只有输出</li>
<li>普通交易：用户之间的普通转账交易</li>
</ul>
<h2 id="交易过程"><a href="#交易过程" class="headerlink" title="交易过程"></a>交易过程</h2><img src="交易输入结构.png"/>

<img src="交易输出结构.png"/>

<p>假设，由于Alice挖矿被奖励了12.5个比特币。而Alice在一笔交易中，需要转账给Bob10个比特币。而Bob最终确认并接收了Alice发送的10个比特币，而同时由于多出了2.5个比特币。其实这笔交易最终是生成了2个输出，一个是发送给Bob的10个比特币，另一个是找零产生的发给Alice的2.5个比特币（备注：这里不考虑交易费）。</p>
<img src="交易基本过程.png"/>

<p>Alice的锁定脚本的作用是，设定成只有Alice才能使用这笔输出。而要使用这个UTXO，就必须要证明自己是Alice。</p>
<p>比特币交易解码后的内容:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;version&quot;: 1,    </span><br><span class="line">    &quot;locktime&quot;: 0,    </span><br><span class="line">    #交易输入(input)部分</span><br><span class="line">    &quot;vin&quot;: [           </span><br><span class="line">    &#123;    </span><br><span class="line">        #输入引用的交易(transaction)HASH</span><br><span class="line">        &quot;txid&quot;: &quot;7957a35fe64f80d234d76d83a2a8f1a0d8149a41d81de548f0a65a8a999f6f18&quot;,       </span><br><span class="line">        </span><br><span class="line">        #引用交易中的UTXO索引（第一个为0，此处代表上述txid交易中的第一个UTXO）</span><br><span class="line">        &quot;vout&quot;: 0,                                    </span><br><span class="line">        </span><br><span class="line">        #解锁脚本，用于解锁UTXO的脚本（这是可以花费这笔UTXO的关键信息）</span><br><span class="line">        &quot;scriptSig&quot;: &quot;3045022100884d142d86652a3f47ba4746ec719bbfbd040a570b1deccbb6498c75c4ae24cb02204b9f039ff08df09cbe9f6addac960298cad530a863ea8f53982c09db8f6e3813</span><br><span class="line">        [ALL] 0484ecc0d46f1918b30928fa0e4ed99f16a0fb4fde0735e7ade8416ab9fe423cc5412336376789d172787ec3457eee41c04f4938de5cc17b4a10fa336a8d752adf&quot;,          </span><br><span class="line">        &quot;sequence&quot;: 4294967295            </span><br><span class="line">    &#125;    </span><br><span class="line">    ],    </span><br><span class="line">    #交易输出(output)部分 </span><br><span class="line">    &quot;vout&quot;: [         </span><br><span class="line">    &#123;    </span><br><span class="line">        #第一个输出的比特币数量</span><br><span class="line">        &quot;value&quot;: 0.01500000,             </span><br><span class="line">        #锁定脚本，后续的交易如要使用该输出，必须解锁锁定脚本</span><br><span class="line">        &quot;scriptPubKey&quot;: &quot;OP_DUP OP_HASH160 ab68025513c3dbd2f7b92a94e0581f5d50f654e7 OP_EQUALVERIFY OP_CHECKSIG&quot;          </span><br><span class="line">    &#125;,    </span><br><span class="line">    &#123;    </span><br><span class="line">        #第二个输出的比特币数量</span><br><span class="line">        &quot;value&quot;: 0.08450000,             </span><br><span class="line">        &quot;scriptPubKey&quot;: &quot;OP_DUP OP_HASH160 7f9b1a7fb68d60c536c2fd8aeaa53a8f3cc025a8 OP_EQUALVERIFY OP_CHECKSIG&quot;,    </span><br><span class="line">    &#125;    </span><br><span class="line">    ]    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="交易脚本"><a href="#交易脚本" class="headerlink" title="交易脚本"></a>交易脚本</h2><p>比特币客户端使用一个用类Forth脚本语言编写的脚本去验证比特币的交易，这个脚本语言不是图灵完备的，不具备循环等复杂的特性。它是一种基于堆栈的执行语言，该脚本语言的简单特性，虽然使得它不能实现复杂的功能，但是也提高了交易脚本的安全性（设计简单，减少了攻击面）。而以太坊就是诟病比特币交易脚本功能有限，所以设计了一个图灵完备的脚本语言，也就是我们常说的智能合约脚本语言，能实现更复杂的功能，但同时也增加了安全隐患。</p>
<p>当一笔比特币交易被验证时，每一个输入中的解锁脚本与其所引用的输出中的锁定脚本同时执行，从而检查这笔交易是否有效。如图所示，是最为常见类型的比特币交易的解锁和锁定脚本:</p>
<img src="解锁脚本和锁定脚本.png"/>

<p>验证过程:当我们拿到一笔交易时，将当前输入的解锁脚本，和该输入所引用的上一笔交易输出的锁定脚本进行特定的验证过程，最终若返回TRUE，说明交易有效。</p>
<h1 id="区块链架构模型"><a href="#区块链架构模型" class="headerlink" title="区块链架构模型"></a>区块链架构模型</h1><img src="区块链架构模型.jpg"/>

<ul>
<li>数据层：封装了底层数据区块的链式结构，以及相关的非对称的公钥私钥加密技术和时间戳技术；是整个区块链最底层的数据结构。</li>
<li>网络层：P2P机制，数据传播机制，数据间认证机制</li>
<li>共识层：共识机制算法</li>
<li>激励层：用于公有链，联盟链</li>
<li>合约层：智能合约</li>
<li>应用层：与上述区块链核心架构分开部署，通过RPC（Remote Procedure Call:远程过程调用)互联</li>
</ul>
<h1 id="链式结构"><a href="#链式结构" class="headerlink" title="链式结构"></a>链式结构</h1><img src="链式结构图.jpg"/>

<p>Hash函数:</p>
<ul>
<li>MD系列:已经不再安全</li>
<li>SHA系列:推荐SHA256, SHA3</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hash</span><span class="params">(input <span class="keyword">string</span>)</span> <span class="title">string</span></span>  &#123;</span><br><span class="line">    <span class="comment">// func Sum256(data []byte) [Size]byte</span></span><br><span class="line">    hashInByte :=sha256.Sum256([]<span class="keyword">byte</span> (input))</span><br><span class="line">    <span class="comment">// func EncodeToString(src []byte) string</span></span><br><span class="line">    <span class="keyword">return</span> hex.EncodeToString(hashInByte[:])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="ICO和IPO"><a href="#ICO和IPO" class="headerlink" title="ICO和IPO"></a>ICO和IPO</h1><ul>
<li>ICO（Initial Coin Offering），首次币发行，源自股票市场的首次公开发行（IPO）概念，是区块链项目首次发行代币，募集比特币、以太坊等通用数字货币的行为。</li>
<li>IPO（Initial Public Offerings），首次公开募股，是指一家企业或公司 （股份有限公司）第一次将它的股份向公众出售（首次公开发行，指股份公司首次向社会公众公开招股的发行方式）。</li>
</ul>
<h1 id="智能合约"><a href="#智能合约" class="headerlink" title="智能合约"></a>智能合约</h1><p>智能合约是一套以数字形式定义的承诺，包括合约参与方可以在上面执行这些承诺的协议，也就是说智能合约是一套能够自动执行某些手动才能完成任务的协议。其实智能合约相当于在计算机系统中构建一份参与方均可读的合同。只有当某一事件触发后，则会立即执行。例如，A向B付款XX元，B则给予A货物。</p>
<p>智能合约并不是一定要依赖于区块链来实现，而区块链的部分基础特性决定了智能合约更加适合于在区块链上来实现。比如去中心化，数据的防篡改，高可用性等。去中心化能够保证数据的全网备份与不可受第三方机构的干扰，无需担心数据会被篡改。同时也立于以后的审计工作。高可用性不会存在如目前的中心服务或者中心存储系统受到攻击或其他问题而发生合约不执行的问题。其实综合来说,区块链给予智能合约最好的特性就是“信任机制。</p>
<p>目前来说，智能合约同样也有很多的局限性。例如线下的问题解决起来还是无法与线上的问题相提并论的。如商品问题，给予的商品质量如何评估与上链，是否还需要依赖于第三方？ 同时智能合约的编写者对于合约的细节把控必须特别的严谨。一是合约漏洞，不严谨的合约造成对某个参与者的损失。二是可能会出现Bug，而如果bug被黑客所利用那么就会造成重大的损失。同样智能合约的法律问题也是要考虑的重点。</p>
<h1 id="以太坊"><a href="#以太坊" class="headerlink" title="以太坊"></a>以太坊</h1><p>以太坊（英文Ethereum）是一个开源的有智能合约功能的公共区块链平台，通过其专用加密货币以太币（Ether）提供去中心化的虚拟机（“以太虚拟机” Ethereum Virtual Machine）来处理点对点合约。</p>
<p>比特币并不完美，其中协议的扩展性是一项不足，例如比特币网络里只有一种符号——比特币，用户无法自定义另外的符号，这些符号可以是代表公司的股票，或者是债务凭证等，这就损失了一些功能。另外，比特币协议里使用了一套基于堆栈的脚本语言，这语言虽然具有一定灵活性，使得像多重签名这样的功能得以实现，然而却不足以构建更高级的应用，例如去中心化交易所等。以太坊从设计上就是为了解决比特币扩展性不足的问题。</p>
<p>以太坊是一个平台，它上面提供各种模块让用户来搭建应用。具体来说，以太坊通过一套图灵完备的脚本语言（EthereumVirtual Machinecode，简称EVM语言）来建立应用，它类似于汇编语言，但以太坊里的编程并不需要直接使用EVM语言，而是类似C语言、Python、Lisp等高级语言，再通过编译器转成EVM语言。</p>
<p>上面所说的平台之上的应用，其实就是合约，这是以太坊的核心。合约是一个活在以太坊系统里的自动代理人，他有一个自己的以太币地址，当用户向合约的地址里发送一笔交易后，该合约就被激活，然后根据交易中的额外信息，合约会运行自身的代码，最后返回一个结果，这个结果可能是从合约的地址发出另外一笔交易。需要指出的是，以太坊中的交易，不单只是发送以太币而已，它还可以嵌入相当多的额外信息。如果一笔交易是发送给合约的，那么这些信息就非常重要，因为合约将根据这些信息来完成自身的业务逻辑。合约所能提供的业务，几乎是无穷无尽的，它的边界就是你的想象力，因为图灵完备的语言提供了完整的自由度，让用户搭建各种应用。</p>
<p>比特币网络事实上是一套分布式的数据库，而以太坊则更进一步，她可以看作是一台分布式的计算机：区块链是计算机的ROM，合约是程序，而以太坊的矿工们则负责计算，担任CPU的角色。这台计算机不是、也不可能是免费使用的，不然任何人都可以往里面存储各种垃圾信息和执行各种鸡毛蒜皮的计算，使用它至少需要支付计算费和存储费，当然还有其它一些费用。</p>
<h1 id="分叉"><a href="#分叉" class="headerlink" title="分叉"></a>分叉</h1><p>比特币社区开发者一直在致力于改进比特币,但是不像传统软件的升级，一个分布式共识系统的升级是非常困难的，需要协调好所有的系统参与者。每次升级可能会伴随着区块链的共识规则改变，这会导致整个网络中升级了软件的节点与未升级软件的节点运行在不同的规则下，于是分叉就产生了。</p>
<h2 id="硬分叉"><a href="#硬分叉" class="headerlink" title="硬分叉"></a>硬分叉</h2><p>如果区块链软件的共识规则被改变，并且这种规则改变无法向前兼容，旧节点无法认可新节点产生的区块，即为硬分叉。这时候旧节点会拒绝新规则的区块，于是新节点和旧节点会开始在不同的区块链上运行（挖矿、交易、验证等），由于新旧节点可能长期存在，这种分叉也可能会长期持续下去。</p>
<h2 id="软分叉"><a href="#软分叉" class="headerlink" title="软分叉"></a>软分叉</h2><p>如果区块链的共识规则改变后，这种改变是向前兼容的，旧节点可以兼容新节点产生的区块，即为软分叉。实际上，软分叉通常刚开始并不会产生两条区块链，因为新规则下产生的块会被旧节点接受，旧节点只是无法识别新规则的真实意义。所以新旧节点仍然处于同一条区块链上，对整个系统的影响也就较小。</p>
<h1 id="共识算法"><a href="#共识算法" class="headerlink" title="共识算法"></a>共识算法</h1><h2 id="PoW"><a href="#PoW" class="headerlink" title="PoW"></a>PoW</h2><p>POW（Proof of Work）：工作量证明，即你能够获得的币的数量，取决于你挖矿贡献的有效工作，也就是说，你用于挖矿的矿机的性能越好，分给你的收益就会越多，这就是根据你的工作证明来执行币的分配方式。通俗的说，PoW 的意思就是社会主义，按劳分配，多劳多得。</p>
<p>PoW 的优势与劣势：</p>
<ul>
<li>PoW机制的设计目的是保证安全。无论是在中心化还是非中心化系统中，防止作弊都是很重要的。</li>
<li>PoW 假设大多数人不会作弊，如果你想作弊，你要有压倒大多数人的算力（51%攻击），但不能防止矿工抱团取暖。</li>
</ul>
<h2 id="PoS"><a href="#PoS" class="headerlink" title="PoS"></a>PoS</h2><p>PoS（Proof of Stake）：权益证明，类似比特币这样的 PoW 币种挖矿带来了巨大的电力能源消耗，为了解决这种情况，所以有了 PoS。PoS 试图解决 PoW 机制中大量资源被浪费的情况。这种机制通过计算你持有占总币数的百分比以及占有币数的时间来决定记账权。在现实世界中 PoS 很普遍，最为熟知的例子就是股票。股票是用来记录股权的证明，股票持有量多的，拥有更高更多的投票权和收益权。通俗的说，PoS 就是资本主义，按钱分配，钱生钱。</p>
<ul>
<li>Proof of Deposit：这次挖到矿的旷工投入的币会锁定一段时间才能接着投入。如果有分叉的话锁定的币只会在当前分支起锁定效果。</li>
</ul>
<p>PoS 的优势与劣势：</p>
<ul>
<li>Pos 当然也能防作弊，因为如果一名持有 51%以上股权的人作弊，相当于他坑了自己，因为一个人自己不会杀死自己的钱。</li>
<li>PoS 机制由股东自己保证安全，工作原理是利益捆绑。在这个模式下，不持有 PoS 的人无法对 PoS 构成威胁。PoS 的安全取决于持有者，和其他任何因素无关。</li>
</ul>
<h2 id="DPoS"><a href="#DPoS" class="headerlink" title="DPoS"></a>DPoS</h2><h3 id="算法概述"><a href="#算法概述" class="headerlink" title="算法概述"></a>算法概述</h3><p>DPoS（Delegated Proof of Stake）：委托股权证明，是 PoS 的进化方案，由 Dan Larimer 发明。（例子：比特股 BTS）</p>
<p>在常规 PoW 和 PoS 中，一大影响效率之处在于任何一个新加入的 Block，都需要被整个网络所有节点做确认。DPoS 优化方案在于：通过不同的策略，不定时的选中一小群节点，这一小群节点做新区块的创建，验证，签名和相互监督，这样就大幅度的减少了区块创建和确认所需要消耗的时间和算力成本。</p>
<p>DPOS算法分为两部分：选择一组块生产者和调度生产。选举过程确保利益相关方最终得到控制，因为当网络不能顺利运行时，利益相关方的损失最大。选举方法对实际运行中如何达成共识几乎没有影响，因此主要介绍如何在块生产者被选择之后达成共识。</p>
<p>假设3个块生产者A，B和C。因为共识（的达成）需要2/3+1多数来解决所有情况，这个简化的模型将假设生产者C是打破僵局的那个人。在现实世界中，将有21个或更多的块生产者。像工作量证明一样，一般规则是最长链胜出。任何时候当一个诚实的对等节点看到一个有效的更长链，它都会从当前分叉切换到更长的这条链。</p>
<h3 id="正常操作"><a href="#正常操作" class="headerlink" title="正常操作"></a>正常操作</h3><p>在正常操作模式下，块生产者每3秒钟轮流生成一个块。假设没有人错过自己的轮次，那么这将产生最长链。块生产者在被调度轮次之外的任何时间段出块都是无效的。</p>
<h3 id="少数分叉"><a href="#少数分叉" class="headerlink" title="少数分叉"></a>少数分叉</h3><p>不超过节点总数三分之一的恶意或故障节点可能创建少数分叉。在这种情况下，少数分叉每9秒只能产生一个块，而多数分叉每9秒可以产生两个块。这样，诚实的2/3多数将永远比少数（的链）更长。</p>
<h3 id="离线少数的多重生产"><a href="#离线少数的多重生产" class="headerlink" title="离线少数的多重生产"></a>离线少数的多重生产</h3><p>（离线的）少数人可以试图产生无限数量的分叉，但是他们的所有分叉都将比多数人的那条链短，因为少数人在出块速度上注定比多数人来的更慢。</p>
<h3 id="网络碎片化"><a href="#网络碎片化" class="headerlink" title="网络碎片化"></a>网络碎片化</h3><p>网络完全有可能碎片化，导致没有任何分叉拥有多数块生成者。在这种情况下，最长的链将倒向最大的那个少数群体。当网络连通性恢复时，较小的少数群体会自然切换到最长的那条链，明确的共识将恢复。</p>
<p>有可能存在这样三个分叉，其中两个最长的分叉长度相同。在这种情况下，第3个（较小）分叉的块生产者重新加入网络时会打破平局。块生产者总数为奇数，因此不可能长时间保持平局。稍后我们还会讲到生产者“洗牌”，它使得出块顺序随机化，从而确保即使是生产者数目相同的两个分叉也会以不同的步长增长，最终导致一个分叉超过另一个。</p>
<h3 id="在线少数的多重生产"><a href="#在线少数的多重生产" class="headerlink" title="在线少数的多重生产"></a>在线少数的多重生产</h3><p>在这种场景下，少数节点B在其时间段内产生了两个或更多可供选择的块。下一个计划生产者（C）可以选择基于B产生的任何一种方案继续构建链条。一旦如此，这个选择就成为最长的链，而所有选择B1的节点都将切换分叉。少数不良生产者企图广播再多的替代块也无关紧要，它们作为最长链的一部分永远不会超过一轮。</p>
<h3 id="最后不可逆块"><a href="#最后不可逆块" class="headerlink" title="最后不可逆块"></a>最后不可逆块</h3><p>在网络碎片化的情况下，多个分叉都有可能持续不断增长相当长的时间。长远来看最长的链终将获胜，但观察者需要一种确切的手段来判定一个块是否绝对处于增长最快的那条链。这可以通过观察来自2/3+1多数块生产者的确认来决定。</p>
<h3 id="多数生产者舞弊"><a href="#多数生产者舞弊" class="headerlink" title="多数生产者舞弊"></a>多数生产者舞弊</h3><p>如果多数生产者变得腐败，那么他们可以产生无限数量的分叉，每个分叉都看起来以2/3多数确认向前走。这种情况下，最后不可逆块算法蜕变为最长链算法。最长链就是为最大多数所批准的那条链，而这将由少数剩下的诚实节点决定。这种行为不会持续很长时间，因为利益相关方最终会投票替换生产者。</p>
<h3 id="确定性生产者洗牌"><a href="#确定性生产者洗牌" class="headerlink" title="确定性生产者洗牌"></a>确定性生产者洗牌</h3><p>在上面所有例子中，我们展示的都是块生产者按循环调度出块。实际上，每出N个块（N是生产者数量），块生产者集合都会洗牌一次。这种随机性确保块生成者B不会总是忽略块生成者A，每当形成多个拥有相同数量生产者的分叉时，平局最终都会被打破。</p>
<h3 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h3><p>在每一个我们能想到的自然网络分裂的情况下，委托权益证明都是强健的，甚至在面对相当数量生产者舞弊的情形时也是安全的。不像其它共识算法，当大多数生产者不合格时，DPOS还是可以继续工作。在此过程中，社区可以投票替换掉不合格的生产者，直到恢复100％参与率。</p>
<p>说到底，DPOS引人注目的安全性来自于其选择块生产者和验证节点质量的算法。运用赞成投票的过程可以确保一个人即使拥有50％的有效投票权也不能独自挑选哪怕一个生产者。DPOS旨在优化拥有强壮网络连接的诚实节点100％参与（共识过程）的名义条件。这使得DPOS有能力在平均只有1.5秒的时间内以99.9％的确定性确认交易，同时以优雅和可检测的方式降级 – 从降级中恢复正常也不过是小事一桩。</p>
<h2 id="PoW-PoS-混合机制"><a href="#PoW-PoS-混合机制" class="headerlink" title="PoW + PoS 混合机制"></a>PoW + PoS 混合机制</h2><p>为了结合两种挖矿方式的优点，开始有了基于 PoW+PoS 混合共识机制的币。例如 Hcash，以及以太坊 ETH 也正在向 PoW+PoS 混合挖升级矿转变。</p>
<p>PoW + PoS 混合机制的优势：</p>
<ul>
<li>假设一个币它的机制是PoW + PoS 的混合机制。那么持有该币的用户与矿工均可以参与到投票中，共同参与该币社区的重大决定，持币者与矿工都可以影响预先编制好的更新，如隔离见证（SegWit）、增大区块等等。如果这些更新被广泛认可，无需开发者干预，链就会自动分叉以配合更新。而这才是真正的去中心化。</li>
<li>以混合机制来实现广义上的 DAO（去中心化自治组织）的高效运行。通过 PoW+PoS 公平的按持币数量与工作量分配投票权重，实现社区自治。</li>
</ul>
<h2 id="DAG"><a href="#DAG" class="headerlink" title="DAG"></a>DAG</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>DAG：Directed Acyclic Graph，即“有向无环图”。区块链是每个区块记多笔交易，而DAG是每个区块存一笔交易，所以它们的本质相同。在IOTA白皮书里，把结扎在一起的交易称为缠结（Tangle）。</p>
<p>使用者每发起一笔交易，必须验证之前的两笔交易。如果一笔交易不被后来的交易所验证，它就会在账本里失去合法性。交易发起者自己选择两笔合法交易，花2秒钟找出一个随机数，让“随机数+信息”的哈希值符合系统要求。</p>
<p>验证所需的工作量与前手交易权重成正比，交易权重相当于验证难度，难度越高验证时间越长。IOTA中，权重是以3为底的指数增长：3的1次方、3的2次方、3的3次方……被验证次数越多的交易权重越大。所以，不用担心验证完两笔正确交易却没人来验证你，因为验证新鲜交易更容易，如果验证靠前的陈旧交易，工作量会指数级地翻上去.</p>
<p>如果只往前验证一笔，网络会被大算力操控。算力强者很容易抬高交易权重，拉长尾巴，以堵死后面的验证通路，让随后的诚实交易不得不屈从大算力；可验太多交易又会耗时过长。所以，验两笔能兼顾安全和效率。</p>
<p>于是，发起者一边提交自己的交易，一边验证别人的交易，以此编织着一个去中心化网络。</p>
<h3 id="DAG保证账本安全"><a href="#DAG保证账本安全" class="headerlink" title="DAG保证账本安全"></a>DAG保证账本安全</h3><p>假如A转给B价值100万元的IOTA，B确认后把100万元货物交给A，A靠算力发起攻击，用一笔权重更大的交易验证合法交易之前的交易。只要超过主体诚实的DAG，随后的交易都会接在A的DAG后面生长，这样就赖掉之前的交易，白白从B手里拿走100万元的货。此时需要汇聚34%才能实现双重支付？</p>
<p>IOTA团队说，网络还没成熟，所以先找了个协管员看场子，这名协管员就是一台名叫Coordinator的服务器。所有交易是否合法，暂时全由这位协管员拍板，拍板后告诉其他节点，该验证哪些交易。</p>
<p>影响账本安全的另一个因素是数字签名，因为攻击者无法使用他们没有的私钥签出和你一样的数字签名，而保障这件事的是哈希算法.IOTA使用了自己开发的哈希算法curl，但是curl算法的哈希值极易发生碰撞，于是就能伪造数字签名。</p>
<p>IOTA的DAG是靠后手保护前手，一旦攻击者成功伪造数字签名，后手挑不出伪造者的错，非法交易就能大摇大摆地通过验证，这意味着别人用其他私钥也能撬走你账户里的钱。现在IOTA有协管员保护，但如果撤下协管员，签名能否会被仿冒，就完全得寄希望于攻击者没有哈希出和你一样的签名。而协管员自己也有私钥，一旦泄露，造成的结果将比服务器电源插座被拔还要严重，因为此时持有私钥者具备改动任意交易的技术可能，这就是集中管账的风险。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>DAG是一种数据存储结构，从它被发明的30多年来一直都有人使用，本身并没有问题。但它和区块链的区别在于DAG没有传统意义上的共识，每笔交易的可信与否取决于相信这笔交易的人数。所以采用DAG技术的核心问题在于如何保护全网达成的一致.</p>
<p>IOTA使用了中心化方案：先协管员看护，以后慢慢放开。同样采用DAG的另一种加密货币Byteball就很淳朴，12名矿工通过收交易手续费的方式保护系统安全。</p>
<p>DAG曾经作为比特币扩容的方案，但最终没被采用，因为基于DAG的分布式网络在保护共识方面很难比区块更有效。</p>
<h2 id="HashNet"><a href="#HashNet" class="headerlink" title="HashNet"></a>HashNet</h2><img src="HashNet共识机制.webp"/>

<p>HashNet采用分层分片共识机制, 上层网络中的节点称为全节点（full node），主要负责下层分片建立、下层分片重组、新局部全节点加入、局部全节点退出，不参与全局共识，也不参与记账，这避免了形成性能瓶颈的风险，极大的提高了交易吞吐量。下层网络中的节点称为局部全节点（local full node），形成各个分片，片内进行交易达成共识，采用后缀匹配法确保每笔交易只由一个特定的分片处理，避免了双重支付，同时片间通过异步机制同步各个片内的共识结果，从而达到每个局部全节点拥有全局账本。</p>
<p>HashNet共识机制的主要优势在于：</p>
<ol>
<li>全节点和局部全节点具有较强的稳定性和处理能力，能够有效避免HashGraph长时间无法达成共识的问题，也能够避免因网络被分割造成的恶意节点攻击问题；</li>
<li>与当前其他带分片的区块链项目相比，HashNet采用分布式异步分片重组，完全打破了集中式分片重组的机制，极大地提高了重组时的安全性；</li>
<li>交易共识不需要上层节点参与，交易达成速度极快（交易确认时间仅仅依赖于片内节点数量），更重要的是，交易吞吐量，即TPS，与下层分片数量成正比，即分片数量越多，TPS越高；</li>
<li>片内和片间节点均为对等，没有所谓的Leader，避免了潜在的中心化可能和性能瓶颈。</li>
</ol>
<h1 id="区块链项目"><a href="#区块链项目" class="headerlink" title="区块链项目"></a>区块链项目</h1><img src="区块链项目分类.JPEG"/>

<h1 id="实践一-创建区块链"><a href="#实践一-创建区块链" class="headerlink" title="实践一-创建区块链"></a>实践一-创建区块链</h1><p><a target="_blank" rel="noopener" href="https://github.com/ljd1996/blockchain_go/tree/part_1">https://github.com/ljd1996/blockchain_go/tree/part_1</a></p>
<h2 id="创建Block"><a href="#创建Block" class="headerlink" title="创建Block"></a>创建Block</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> code</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;crypto/sha256&quot;</span></span><br><span class="line">    <span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Block <span class="keyword">struct</span> &#123;</span><br><span class="line">    Index        <span class="keyword">int64</span>  <span class="comment">// 区块编号</span></span><br><span class="line">    Timestamp    <span class="keyword">int64</span>  <span class="comment">// 区块时间戳</span></span><br><span class="line">    PreBlockHash <span class="keyword">string</span> <span class="comment">// 上一个区块Hash值</span></span><br><span class="line">    Hash         <span class="keyword">string</span> <span class="comment">// 当前区块Hash值</span></span><br><span class="line">    Data         <span class="keyword">string</span> <span class="comment">//区块数据</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(block *Block)</span> <span class="title">Print</span><span class="params">()</span></span>  &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;Index: %d\n&quot;</span>, block.Index)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;PreHash: %s\n&quot;</span>, block.PreBlockHash)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;CurHash: %s\n&quot;</span>, block.Hash)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;Data: %s\n&quot;</span>, block.Data)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;Timestamp: %d\n&quot;</span>, block.Timestamp)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 计算Hash值 */</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">calculateHash</span><span class="params">(b Block)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    blockData := <span class="keyword">string</span>(b.Index) + <span class="keyword">string</span>(b.Timestamp) + <span class="keyword">string</span>(b.PreBlockHash) + <span class="keyword">string</span>(b.Data)</span><br><span class="line">    hashByte := sha256.Sum256([]<span class="keyword">byte</span>(blockData))</span><br><span class="line">    <span class="keyword">return</span> hex.EncodeToString(hashByte[:])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 生成下一个区块 */</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GenNewBlock</span><span class="params">(preBlock Block, data <span class="keyword">string</span>)</span> <span class="title">Block</span></span> &#123;</span><br><span class="line">    newBlock := Block&#123;&#125;</span><br><span class="line">    newBlock.Index = preBlock.Index + <span class="number">1</span></span><br><span class="line">    newBlock.Timestamp = time.Now().Unix()</span><br><span class="line">    newBlock.PreBlockHash = preBlock.Hash</span><br><span class="line">    newBlock.Data = data</span><br><span class="line">    newBlock.Hash = calculateHash(newBlock)</span><br><span class="line">    <span class="keyword">return</span> newBlock</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 生成创始区块 */</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GenGenesisBlock</span><span class="params">()</span> <span class="title">Block</span></span> &#123;</span><br><span class="line">    preBlock := Block&#123;&#125;</span><br><span class="line">    preBlock.Index = <span class="number">-1</span></span><br><span class="line">    preBlock.Hash = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> GenNewBlock(preBlock, <span class="string">&quot;Genesis Block&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="创建BlockChain"><a href="#创建BlockChain" class="headerlink" title="创建BlockChain"></a>创建BlockChain</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> code</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> BlockChain <span class="keyword">struct</span> &#123;</span><br><span class="line">    Blocks []*Block</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *BlockChain)</span> <span class="title">Print</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> _, block := <span class="keyword">range</span> bc.Blocks &#123;</span><br><span class="line">        block.Print()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *BlockChain)</span> <span class="title">SendData</span><span class="params">(data <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    preBlock := bc.Blocks[<span class="built_in">len</span>(bc.Blocks)<span class="number">-1</span>]</span><br><span class="line">    newBlock := GenNewBlock(*preBlock, data)</span><br><span class="line">    bc.appendBlock(&amp;newBlock)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *BlockChain)</span> <span class="title">appendBlock</span><span class="params">(newBlock *Block)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(bc.Blocks) == <span class="number">0</span> &#123;</span><br><span class="line">        bc.Blocks = <span class="built_in">append</span>(bc.Blocks, newBlock)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> isValid(*newBlock, *bc.Blocks[<span class="built_in">len</span>(bc.Blocks)<span class="number">-1</span>]) &#123;</span><br><span class="line">        bc.Blocks = <span class="built_in">append</span>(bc.Blocks, newBlock)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.Print(<span class="string">&quot;invalid block!&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">isValid</span><span class="params">(newBlock Block, oldBlock Block)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (newBlock.Index<span class="number">-1</span> == oldBlock.Index) &amp;&amp;</span><br><span class="line">        (newBlock.PreBlockHash == oldBlock.Hash) &amp;&amp;</span><br><span class="line">        (calculateHash(newBlock) == newBlock.Hash)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBlockChain</span><span class="params">()</span> *<span class="title">BlockChain</span></span> &#123;</span><br><span class="line">    genesisBLock := GenGenesisBlock()</span><br><span class="line">    blockChain := BlockChain&#123;&#125;</span><br><span class="line">    blockChain.appendBlock(&amp;genesisBLock)</span><br><span class="line">    <span class="keyword">return</span> &amp;blockChain</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="实践二-工作量证明"><a href="#实践二-工作量证明" class="headerlink" title="实践二-工作量证明"></a>实践二-工作量证明</h1><p><a target="_blank" rel="noopener" href="https://github.com/ljd1996/blockchain_go/tree/part_2">https://github.com/ljd1996/blockchain_go/tree/part_2</a></p>
<h2 id="Block"><a href="#Block" class="headerlink" title="Block"></a>Block</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Block keeps block headers</span></span><br><span class="line"><span class="keyword">type</span> Block <span class="keyword">struct</span> &#123;</span><br><span class="line">	Timestamp     <span class="keyword">int64</span></span><br><span class="line">	Data          []<span class="keyword">byte</span></span><br><span class="line">	PrevBlockHash []<span class="keyword">byte</span></span><br><span class="line">	Hash          []<span class="keyword">byte</span></span><br><span class="line">	Nonce         <span class="keyword">int</span>   <span class="comment">// 跟工作量证明相关</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewBlock creates and returns Block</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBlock</span><span class="params">(data <span class="keyword">string</span>, prevBlockHash []<span class="keyword">byte</span>)</span> *<span class="title">Block</span></span> &#123;</span><br><span class="line">	block := &amp;Block&#123;time.Now().Unix(), []<span class="keyword">byte</span>(data), prevBlockHash, []<span class="keyword">byte</span>&#123;&#125;, <span class="number">0</span>&#125;</span><br><span class="line">	pow := NewProofOfWork(block)</span><br><span class="line">	nonce, hash := pow.Run()</span><br><span class="line"></span><br><span class="line">	block.Hash = hash[:]</span><br><span class="line">	block.Nonce = nonce</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> block</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewGenesisBlock creates and returns genesis Block</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewGenesisBlock</span><span class="params">()</span> *<span class="title">Block</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> NewBlock(<span class="string">&quot;Genesis Block&quot;</span>, []<span class="keyword">byte</span>&#123;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="BlockChain"><a href="#BlockChain" class="headerlink" title="BlockChain"></a>BlockChain</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="comment">// Blockchain keeps a sequence of Blocks</span></span><br><span class="line"><span class="keyword">type</span> Blockchain <span class="keyword">struct</span> &#123;</span><br><span class="line">	blocks []*Block</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// AddBlock saves provided data as a block in the blockchain</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(bc *Blockchain)</span> <span class="title">AddBlock</span><span class="params">(data <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">	prevBlock := bc.blocks[<span class="built_in">len</span>(bc.blocks)<span class="number">-1</span>]</span><br><span class="line">	newBlock := NewBlock(data, prevBlock.Hash)</span><br><span class="line">	bc.blocks = <span class="built_in">append</span>(bc.blocks, newBlock)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewBlockchain creates a new Blockchain with genesis Block</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewBlockchain</span><span class="params">()</span> *<span class="title">Blockchain</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;Blockchain&#123;[]*Block&#123;NewGenesisBlock()&#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ProofOfWork"><a href="#ProofOfWork" class="headerlink" title="ProofOfWork"></a>ProofOfWork</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;bytes&quot;</span></span><br><span class="line">	<span class="string">&quot;crypto/sha256&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;math&quot;</span></span><br><span class="line">	<span class="string">&quot;math/big&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">	maxNonce = math.MaxInt64</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> targetBits = <span class="number">24</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ProofOfWork represents a proof-of-work</span></span><br><span class="line"><span class="keyword">type</span> ProofOfWork <span class="keyword">struct</span> &#123;</span><br><span class="line">	block  *Block</span><br><span class="line">	target *big.Int</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewProofOfWork builds and returns a ProofOfWork</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewProofOfWork</span><span class="params">(b *Block)</span> *<span class="title">ProofOfWork</span></span> &#123;</span><br><span class="line">	target := big.NewInt(<span class="number">1</span>)</span><br><span class="line">	target.Lsh(target, <span class="keyword">uint</span>(<span class="number">256</span>-targetBits))</span><br><span class="line"></span><br><span class="line">	pow := &amp;ProofOfWork&#123;b, target&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> pow</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pow *ProofOfWork)</span> <span class="title">prepareData</span><span class="params">(nonce <span class="keyword">int</span>)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">	data := bytes.Join(</span><br><span class="line">		[][]<span class="keyword">byte</span>&#123;</span><br><span class="line">			pow.block.PrevBlockHash,</span><br><span class="line">			pow.block.Data,</span><br><span class="line">			IntToHex(pow.block.Timestamp),</span><br><span class="line">			IntToHex(<span class="keyword">int64</span>(targetBits)),</span><br><span class="line">			IntToHex(<span class="keyword">int64</span>(nonce)),</span><br><span class="line">		&#125;,</span><br><span class="line">		[]<span class="keyword">byte</span>&#123;&#125;,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> data</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Run performs a proof-of-work</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pow *ProofOfWork)</span> <span class="title">Run</span><span class="params">()</span> <span class="params">(<span class="keyword">int</span>, []<span class="keyword">byte</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> hashInt big.Int</span><br><span class="line">	<span class="keyword">var</span> hash [<span class="number">32</span>]<span class="keyword">byte</span></span><br><span class="line">	nonce := <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;Mining the block containing \&quot;%s\&quot;\n&quot;</span>, pow.block.Data)</span><br><span class="line">	<span class="keyword">for</span> nonce &lt; maxNonce &#123;</span><br><span class="line">		data := pow.prepareData(nonce)</span><br><span class="line"></span><br><span class="line">		hash = sha256.Sum256(data)</span><br><span class="line">		fmt.Printf(<span class="string">&quot;\r%x&quot;</span>, hash)</span><br><span class="line">		hashInt.SetBytes(hash[:])</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> hashInt.Cmp(pow.target) == <span class="number">-1</span> &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			nonce++</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Print(<span class="string">&quot;\n\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> nonce, hash[:]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Validate validates block&#x27;s PoW</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(pow *ProofOfWork)</span> <span class="title">Validate</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> hashInt big.Int</span><br><span class="line"></span><br><span class="line">	data := pow.prepareData(pow.block.Nonce)</span><br><span class="line">	hash := sha256.Sum256(data)</span><br><span class="line">	hashInt.SetBytes(hash[:])</span><br><span class="line"></span><br><span class="line">	isValid := hashInt.Cmp(pow.target) == <span class="number">-1</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> isValid</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="实践三-持久化-bolt"><a href="#实践三-持久化-bolt" class="headerlink" title="实践三-持久化(bolt)"></a>实践三-持久化(bolt)</h1><p><a target="_blank" rel="noopener" href="https://github.com/ljd1996/blockchain_go/tree/part_3">https://github.com/ljd1996/blockchain_go/tree/part_3</a></p>
<h1 id="实践四-交易"><a href="#实践四-交易" class="headerlink" title="实践四-交易"></a>实践四-交易</h1><p><a target="_blank" rel="noopener" href="https://github.com/ljd1996/blockchain_go/tree/part_4">https://github.com/ljd1996/blockchain_go/tree/part_4</a></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Block <span class="keyword">struct</span> &#123;</span><br><span class="line">	Timestamp     <span class="keyword">int64</span></span><br><span class="line">	Transactions  []*Transaction</span><br><span class="line">	PrevBlockHash []<span class="keyword">byte</span></span><br><span class="line">	Hash          []<span class="keyword">byte</span></span><br><span class="line">	Nonce         <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Transaction represents a Bitcoin transaction</span></span><br><span class="line"><span class="keyword">type</span> Transaction <span class="keyword">struct</span> &#123;</span><br><span class="line">	ID   []<span class="keyword">byte</span></span><br><span class="line">	Vin  []TXInput</span><br><span class="line">	Vout []TXOutput</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TXInput represents a transaction input</span></span><br><span class="line"><span class="keyword">type</span> TXInput <span class="keyword">struct</span> &#123;</span><br><span class="line">	Txid      []<span class="keyword">byte</span></span><br><span class="line">	Vout      <span class="keyword">int</span></span><br><span class="line">	ScriptSig <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// TXOutput represents a transaction output</span></span><br><span class="line"><span class="keyword">type</span> TXOutput <span class="keyword">struct</span> &#123;</span><br><span class="line">	Value        <span class="keyword">int</span></span><br><span class="line">	ScriptPubKey <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="实践五-地址及身份标识"><a href="#实践五-地址及身份标识" class="headerlink" title="实践五-地址及身份标识"></a>实践五-地址及身份标识</h1><p><a target="_blank" rel="noopener" href="https://github.com/ljd1996/blockchain_go/tree/part_5">https://github.com/ljd1996/blockchain_go/tree/part_5</a></p>
<h1 id="实践六-钱包-交易-RPC"><a href="#实践六-钱包-交易-RPC" class="headerlink" title="实践六-钱包/交易/RPC"></a>实践六-钱包/交易/RPC</h1><p><a target="_blank" rel="noopener" href="https://github.com/ljd1996/blockchain_go/tree/part_6">https://github.com/ljd1996/blockchain_go/tree/part_6</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/ljd1996/blockchain_go/tree/part_7">https://github.com/ljd1996/blockchain_go/tree/part_7</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/ljd1996/blockchain_go/tree/master">https://github.com/ljd1996/blockchain_go/tree/master</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" class="post-title-link" itemprop="url">计算机基础</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-05 16:43:01" itemprop="dateCreated datePublished" datetime="2018-12-05T16:43:01+08:00">2018-12-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:58" itemprop="dateModified" datetime="2021-05-14T14:14:58+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a>
                </span>
            </span>

          
            <span id="/2018/12/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" class="post-meta-item leancloud_visitors" data-flag-title="计算机基础" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2018/12/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018/12/05/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="图灵"><a href="#图灵" class="headerlink" title="图灵"></a>图灵</h1><h2 id="图灵-1"><a href="#图灵-1" class="headerlink" title="图灵"></a>图灵</h2><p>艾伦·麦席森·图灵（Alan Mathison Turing，1912年6月23日－1954年6月7日），英国数学家、逻辑学家，被称为计算机科学之父，人工智能之父。</p>
<h2 id="图灵机"><a href="#图灵机" class="headerlink" title="图灵机"></a>图灵机</h2><p>停机问题通俗地说，停机问题就是判断任意一个程序是否能在有限的时间之内结束运行的问题。该问题等价于如下的判定问题：是否存在一个程序P，对于任意输入的程序w，能够判断w会在有限时间内结束或者死循环。有人猜测图灵机模型是图灵在思考停机问题而顺带设计出来的.</p>
<img src="图灵机的组成.webp"/>

<p>图灵的基本思想是用机器来模拟人们用纸笔进行数学运算的过程，它运算过程看作下列两种简单的动作：</p>
<ul>
<li>在纸上写上或擦除某个符号；</li>
<li>把注意力从纸的一个位置移动到另一个位置；</li>
</ul>
<p>逻辑结构上图灵机有四个部分组成:</p>
<ul>
<li>一个无限长的存储带，带子有一个个连续的存储格子组成，每个格子可以存储一个数字或符号</li>
<li>一个读写头，读写头可以在存储带上左右移动，并可以读、修改存储格上的数字或符号</li>
<li>内部状态存储器，该存储器可以记录图灵机的当前状态，并且有一种特殊状态为停机状态</li>
<li>控制程序指令，指令可以根据当前状态以及当前读写头所指的格子上的符号来确定读写头下一步的动作（左移还是右移），并改变状态存储器的值，令机器进入一个新的状态或保持状态不变。</li>
</ul>
<h2 id="图灵完备"><a href="#图灵完备" class="headerlink" title="图灵完备"></a>图灵完备</h2><p>可图灵指在可计算性理论中，编程语言或任意其他的逻辑系统如具有等用于通用图灵机的计算能力。换言之，此系统可与通用图灵机互相模拟。</p>
<p>简单来说，能够抽象成图灵机的系统或编程语言就是图灵完备的；一切可计算的问题图灵机都能计算，因此满足这样要求的逻辑系统、装置或者编程语言就叫图灵完备的。</p>
<p>在可计算性理论里，如果一系列操作数据的规则（如指令集、编程语言、细胞自动机）按照一定的顺序可以计算出结果，被称为图灵完备（turing complete）。</p>
<p>一个有图灵完备指令集的设备被定义为通用计算机。如果是图灵完备的，它（计算机设备）有能力执行条件跳转（if、while、goto语句）以及改变内存数据。如果某个东西展现出了图灵完备，它就有能力表现出可以模拟原始计算机，而即使最简单的计算机也能模拟出最复杂的计算机。所有的通用编程语言和现代计算机的指令集都是图灵完备的（C++ template就是图灵完备的），都能解决内存有限的问题。图灵完备的机器都被定义有无限内存，但是机器指令集却通常定义为只工作在特定的、有限数量的RAM上。</p>
<p>图灵完备的语言，有循环执行语句，判断分支语句等。理论上能解决任何算法。但有可能进入死循环而程序崩溃。</p>
<p>图灵不完备也不是没有意义，有些场景我们需要限制语言本身。如限制循环和递归, 可以保证该语言能写的程序一定是终止的。</p>
<p>比特币的脚本系统是图灵不完备的，以太坊的智能合约系统是图灵完备的。各有优缺点，图灵不完备会更安全些，图灵完备会更智能些。</p>
<h1 id="IO模型"><a href="#IO模型" class="headerlink" title="IO模型"></a>IO模型</h1><p>IO可以理解为对流的操作，当一个read操作发生时，它会经历两个阶段：</p>
<ol>
<li>等待数据准备。</li>
<li>将数据从内核拷贝到进程中</li>
</ol>
<h2 id="同步阻塞IO"><a href="#同步阻塞IO" class="headerlink" title="同步阻塞IO"></a>同步阻塞IO</h2><img src="同步阻塞IO.png"/>

<p>用户线程通过系统调用read发起IO读操作，由用户空间转到内核空间。内核等到数据包到达后，然后将接收的数据拷贝到用户空间，完成read操作。</p>
<h2 id="同步非阻塞IO"><a href="#同步非阻塞IO" class="headerlink" title="同步非阻塞IO"></a>同步非阻塞IO</h2><img src="同步非阻塞IO.png"/>

<p>由于socket是非阻塞的方式，因此用户线程发起IO请求时立即返回。但并未读取到任何数据，用户线程需要不断地发起IO请求，直到数据到达后，才真正读取到数据，继续执行。</p>
<p>即用户需要不断地调用read，尝试读取socket中的数据，直到读取成功后，才继续处理接收的数据。整个IO请求的过程中，虽然用户线程每次发起IO请求后可以立即返回，但是为了等到数据，仍需要不断地轮询、重复请求，消耗了大量的CPU的资源。一般很少直接使用这种模型，而是在其他IO模型中使用非阻塞IO这一特性。</p>
<h2 id="IO多路复用"><a href="#IO多路复用" class="headerlink" title="IO多路复用"></a>IO多路复用</h2><img src="IO多路复用.png"/>

<p>IO多路复用模型是建立在内核提供的多路分离函数select基础之上的，使用select函数可以避免同步非阻塞IO模型中轮询等待的问题。</p>
<p>用户首先将需要进行IO操作的socket添加到select中，然后阻塞等待select系统调用返回。当数据到达时，socket被激活，select函数返回。用户线程正式发起read请求，读取数据并继续执行。</p>
<p>从流程上来看，使用select函数进行IO请求和同步阻塞模型没有太大的区别，甚至还多了添加监视socket，以及调用select函数的额外操作，效率更差。但是，使用select以后最大的优势是用户可以在一个线程内同时处理多个socket的IO请求。用户可以注册多个socket，然后不断地调用select读取被激活的socket，即可达到<font color="#FF0000">在同一个线程内同时处理多个IO请求的目的</font>。而在同步阻塞模型中，必须通过多线程的方式才能达到这个目的。</p>
<h2 id="异步IO"><a href="#异步IO" class="headerlink" title="异步IO"></a>异步IO</h2><img src="异步IO.png"/>

<p>“真正”的异步IO需要操作系统更强的支持。在IO多路复用模型中，事件循环将文件句柄的状态事件通知给用户线程，由用户线程自行读取数据、处理数据。而在异步IO模型中，当用户线程收到通知时，数据已经被内核读取完毕，并放在了用户线程指定的缓冲区内，内核在IO完成后通知用户线程直接使用即可。</p>
<h1 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h1><p>闭包的本质源自两点，<strong>词法作用域和函数当作值传递</strong>。</p>
<ul>
<li>词法作用域就是按照代码书写时的样子，内部函数可以访问函数外面的变量。</li>
<li>函数当作值传递，就是可以把函数当作一个值来赋值，当作参数传给别的函数，也可以把函数当作一个值 return。一个函数被当作值返回时，也就相当于返回了一个通道，这个通道可以访问这个函数词法作用域中的变量，即函数所需要的数据结构保存了下来，数据结构中的值在外层函数执行时创建，外层函数执行完毕时理因销毁，但由于内部函数作为值返回出去，这些值得以保存下来。而且无法直接访问，必须通过返回的函数。这也就是私有性。本来执行过程和词法作用域是封闭的，这种返回的函数就好比是一个虫洞。</li>
</ul>
<p>显然，闭包的形成很简单，在执行过程完毕后，返回函数，或者将函数得以保留下来，即形成闭包。</p>
<p>闭包可以理解成：一个持有外部环境变量的函数就是闭包。理解闭包通常有着以下几个关键点：</p>
<ol>
<li>函数</li>
<li>自由变量</li>
<li>环境</li>
</ol>
<p>举例如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(x, y) <span class="comment">//在这里，x和y都不是自由变量</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(x, y) <span class="comment">//但在这个内部函数b中，x和y相对于b都是自由变量，而函数a的作用域则是环境。</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//无论b最终是否会作为返回值被函数a返回，b本身都已经形成了闭包。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>“闭”的意思不是封闭内部状态，而是封闭外部状态，当外部状态的scope失效的时候，还有一份保留在内部状态里，就是所说的封闭外部状态。</p>
<p>知乎有个回答：我叫独孤求败，我在一个山洞里，里面有世界上最好的剑法，还有最好的武器。我学习了里面的剑法，拿走了最好的剑。离开了这里。我来到这个江湖，快意恩仇。但是从来没有人知道我这把剑的来历，和我这一身的武功。那山洞就是一个闭包，而我，就是那个山洞里唯一一个可以与外界交汇的地方。这山洞的一切对外人而言就像不存在一样，只有我才拥有这里面的宝藏！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/01/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/01/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">区块链学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-12-01 20:10:28" itemprop="dateCreated datePublished" datetime="2018-12-01T20:10:28+08:00">2018-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/" itemprop="url" rel="index"><span itemprop="name">区块链</span></a>
                </span>
            </span>

          
            <span id="/2018/12/01/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="区块链学习笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2018/12/01/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018/12/01/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="名词及概念"><a href="#名词及概念" class="headerlink" title="名词及概念"></a>名词及概念</h1><ul>
<li>Coinbase transcation</li>
<li>1 BTC(比特币) = 100 cBTC(比特分) = 1000 mBTC(毫比特) = 1000000 uBTC(微比特) = 1E8(100000000)聪</li>
<li>Genesis block:第一个区块(有特殊hash值)</li>
<li>mining,miner,nonce</li>
<li>selfish mining:恶意节点挖到区块后不发布,而是等到积累一定数量的区块后再一次性发布,用来防止six confirmation(需要恶意节点数超过50%)</li>
<li>比特币 translation-based ledger</li>
<li>以太坊 account-based ledger</li>
<li>比特币中缺省six confirmation:防止恶意节点攻击(区块链增加一个区块后,后续要等待五个区块的添加)</li>
<li>比特币：double spending attack(付款人)；以太坊：replay attack(收款人)</li>
<li>bounty：赏金</li>
<li>区块链的安全性：所有的全节点要独立验证发布的区块</li>
<li>zhenxiao.com/</li>
<li>最初每个区块可以产生50枚比特币奖励，在每21万个区块后(每21万个区块约4年时间)，每个区块的奖励减半（现在每个区块可以奖励12.5枚比特币）,所以比特币共有2100万个，到2140年，比特币将无法细分。</li>
<li>安全性保证:密码学以及共识机制</li>
<li>密码朋克（cypherpunk）：结合了电脑朋克的思想，在电脑化空间下的个体精神，使用强加密（密文）保护个人隐私。</li>
<li>比特币水龙头网站：给访问网站的每个人分发小额比特币奖励，达到引流作用。</li>
<li>每个钱包都是一个节点，其中拥有完整区块链账本的节点叫做全节点，只拥有根hash值和一些信息的叫轻节点。</li>
<li>算力（也称哈希率）是比特币网络处理能力的度量单位。即为计算机（CPU）计算哈希函数输出的速度。一个挖矿机每秒钟能做多少次hash碰撞，就是其“算力”的代表，单位写成hash/s。</li>
<li>零知识证明:证明者能够在不向验证者提供信息本身内容的情况下,使验证者相信某个论断是真实可信的一种技术.可以在不泄漏信息本身内容的情况下,证明拥有某个秘密.</li>
<li>重放攻击:在比特币硬分叉后，新链与原链拥有相同的交易数据、地址、私钥、交易方式。在硬分叉之前的一种币，会因为分叉而变成两种,即可得到等额的新币.同时,在一种币上进行的交易,也可以广播到另一种币上.</li>
</ul>
<h1 id="比特币"><a href="#比特币" class="headerlink" title="比特币"></a>比特币</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>交易流程：</p>
<ol>
<li>有一个新的交易，要向全网公布广播。</li>
<li>每一个节点，都要将收集到的交易信息，放入一个区块中。</li>
<li>每一个节点都要试着在自己的区块中，找到一个足够难的工作量证明。</li>
<li>当一个节点找到了自己的工作量证明，都要对全网进行公布广播。</li>
<li>当且仅当这个区块中的所有交易是有效且之前从未有过，其他的节点才承认这个交易过程的有效性。</li>
<li>其他节点表示承认这个区块，表示认可的方法就是，根据这个区块的编码，往后延长这个链接。</li>
</ol>
<p>UTXO可以看做是一个比特币驱动的状态机。</p>
<h2 id="密码学原理"><a href="#密码学原理" class="headerlink" title="密码学原理"></a>密码学原理</h2><h2 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h2><h3 id="Hash-Pointer"><a href="#Hash-Pointer" class="headerlink" title="Hash Pointer"></a>Hash Pointer</h3><h3 id="Merkle-Tree"><a href="#Merkle-Tree" class="headerlink" title="Merkle Tree"></a>Merkle Tree</h3><ul>
<li>block header：包含某个区块所包含的所有交易组成的Merkle Tree组成的根Hash值，但是没有交易的具体内容。</li>
<li>block body：包含交易的列表和内容</li>
<li>全节点：包含header和body</li>
<li>轻节点：只包含header</li>
</ul>
<img src="Merkle Tree.png"/>

<p><code>Merkle Proof</code>/<code>Proof of membership</code>/<code>Proof of inclusion</code>：</p>
<ul>
<li>证明数据(交易)是否归属于此merkle树。</li>
<li>在不需要存储整个数据的情况下，就可以简明地证明数据是否属于资料组的一部分。</li>
<li>验证某些数据组是包含在更大的数据组中，而无须显示整个数据组或其子资料组。</li>
</ul>
<p><code>Proof of non-membership</code></p>
<ul>
<li>sorted merkle tree</li>
</ul>
<img src="全节点.png"/>

<img src="轻节点.png"/>

<h2 id="共识协议"><a href="#共识协议" class="headerlink" title="共识协议"></a>共识协议</h2><p>账本的内容要取得分布式的共识.</p>
<p>普通投票法:</p>
<ul>
<li>少数服从多数:恶意节点可以生成许多帐号投票,直到超过阈值(没有决定是否有投票权,简单的直接投票不行).</li>
</ul>
<p>最长链投票法:</p>
<ul>
<li>分叉攻击:选择最长链</li>
<li>两个节点同时记账成功(等长分叉):两个区块会保留一段时间,直到其中某个区块找到下一个区块.</li>
</ul>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>用户把交易发布到区块链网络上,节点把这些交易打包成区块,然后添加到区块链中.</p>
<img src="BlockHeader字段.jpeg"/>

<p>可以通过修改Coinbase交易中的Coinbase字段来修改MarkleRoot的hash值，Coinbase tx中保存有旷工的地址，BlockHeader中保存有Nonce。</p>
<img src=""/>

<h2 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h2><h2 id="挖矿"><a href="#挖矿" class="headerlink" title="挖矿"></a>挖矿</h2><p>挖矿设备:</p>
<ul>
<li>CPU-&gt;GPU-&gt;ASIC(Application Specific Integranted Circle)-&gt;矿池</li>
</ul>
<p>矿池:</p>
<ul>
<li>一个pool manager(打包等计算hash之外的工作)和许多miner(只负责计算hash)</li>
<li>可以用almost valid block(不可用)来计算每个miner的工作量.</li>
</ul>
<h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><p>比特币使用的脚本语言特别简单，基于堆栈。</p>
<img src="比特币交易结构.png"/>

<img src="比特币交易输入结构.png"/>

<img src="比特币交易输出结构.png"/>

<img src="比特币交易过程.png"/>

<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><ul>
<li>“区块恋”：把一个私钥分成两部分，一人持有一份，会降低安全性，破解私钥难度变低。</li>
<li>使用多重签名(multisig)的方式让多个合伙人拥有同一个钱包。</li>
<li>分布式共识：理论上被证明不可能(共识一旦达成就不可修改)。</li>
</ul>
<h1 id="以太坊"><a href="#以太坊" class="headerlink" title="以太坊"></a>以太坊</h1><h2 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h2><p>可以把以太坊看做一个交易驱动的状态机(transaction-driven state machine)。以太坊（Ethereum）是一个建立在区块链技术之上，去中心化应用平台，它允许任何人在平台中建立和使用通过区块链技术运行的去中心化应用。</p>
<p>在没有以太坊之前，写区块链应用是这样的：拷贝一份比特币代码，然后去改底层代码如加密算法，共识机制，网络协议等等（很多山寨币就是这样，改改就出来一个新币）。</p>
<p>以太坊平台对底层区块链技术进行了封装，让区块链应用开发者可以直接基于以太坊平台进行开发，开发者只要专注于应用本身的开发，从而大大降低了难度。</p>
<h2 id="账户"><a href="#账户" class="headerlink" title="账户"></a>账户</h2><p>为防止replay attack，转账的时候转账人会携带一个nonce值来标识当前他已进行交易的总数，然后对这些信息进行签名。</p>
<p>账户分类：</p>
<ul>
<li>外部账户(externally owned account)：人操作的账户。公私钥对，balance和nonce</li>
<li>合约账户(smart contract account)：智能合约的载体。balance，nonce，code(代码)，storage()；不能自己发起交易；</li>
</ul>
<h2 id="状态树"><a href="#状态树" class="headerlink" title="状态树"></a>状态树</h2><p>账户：account addr(160bits)-&gt;account state(40个16bits)</p>
<p>每次有账户记录更改都是新建新的MPT，只不过大部分节点是复用的(不直接在原MPT上修改是为了防止分叉出现时便于回滚)。</p>
<img src="MPT.png"/>

<img src="MPT1.png"/>

<img src="以太坊BlockHeader.png"/>

<table>
<thead>
<tr>
<th align="center">名称</th>
<th align="center">类型</th>
<th align="center">意义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">parentHash</td>
<td align="center">common.Hash</td>
<td align="center">父区块的哈希值</td>
</tr>
<tr>
<td align="center">UncleHash</td>
<td align="center">common.Hash</td>
<td align="center">叔父区块列表的哈希值</td>
</tr>
<tr>
<td align="center">Coinbase</td>
<td align="center">common.Address</td>
<td align="center">打包该区块的矿工的地址，用于接收矿工费</td>
</tr>
<tr>
<td align="center">Root</td>
<td align="center">common.Hash</td>
<td align="center">状态树的根哈希值</td>
</tr>
<tr>
<td align="center">TxHash</td>
<td align="center">common.Hash</td>
<td align="center">交易树的根哈希值</td>
</tr>
<tr>
<td align="center">ReceiptHash</td>
<td align="center">common.Hash</td>
<td align="center">收据树的根哈希值</td>
</tr>
<tr>
<td align="center">Bloom</td>
<td align="center">Bloom</td>
<td align="center">交易收据日志组成的Bloom过滤器</td>
</tr>
<tr>
<td align="center">Difficulty</td>
<td align="center">*Big.Int</td>
<td align="center">本区块的难度</td>
</tr>
<tr>
<td align="center">Number</td>
<td align="center">*Big.Int</td>
<td align="center">本区块块号，区块号从0号开始算起</td>
</tr>
<tr>
<td align="center">GasLimit</td>
<td align="center">uint64</td>
<td align="center">本区块中所有交易消耗的Gas上限，这个数值不等于所有交易的中Gas limit字段的和</td>
</tr>
<tr>
<td align="center">GasUsed</td>
<td align="center">uint64</td>
<td align="center">本区块中所有交易使用的Gas之和</td>
</tr>
<tr>
<td align="center">Time</td>
<td align="center">*big.Int</td>
<td align="center">区块产生的unix时间戳，一般是打包区块的时间，这个字段不是出块的时间戳</td>
</tr>
<tr>
<td align="center">Extra</td>
<td align="center">[]byte</td>
<td align="center">区块的附加数据</td>
</tr>
<tr>
<td align="center">MixDigest</td>
<td align="center">common.Hash</td>
<td align="center">哈希值，与Nonce的组合用于工作量计算</td>
</tr>
<tr>
<td align="center">Nonce</td>
<td align="center">BlockNonce</td>
<td align="center">区块产生时的随机值</td>
</tr>
</tbody></table>
<img src="以太坊Block.png"/>

<h2 id="交易树和收据树"><a href="#交易树和收据树" class="headerlink" title="交易树和收据树"></a>交易树和收据树</h2><p>交易树和收据树都属于MPT，只把当前区块包含的交易组织起来，而状态树包含了所有的账户信息，块头包含这三棵树的根hash值。</p>
<p>bloom filter：支持查找某个元素是否包含在某个大的集合里(哈希映射)(一般来说不支持删除元素操作，因为考虑到哈希碰撞)。</p>
<p>Merkle Proof：每个交易完成后会生成一个收据，里面包含一个bloom filter记录交易的类型，地址等。发布的区块在它的块头里也有一个总的bloom filter，是这个区块里所有的bloom filter的并集。</p>
<img src="Receipt数据结构.png"/>

<h2 id="GHOST协议"><a href="#GHOST协议" class="headerlink" title="GHOST协议"></a>GHOST协议</h2><ul>
<li>一个区块可以包括两个uncle block(7代之内有共同的祖先，随着代数增加，奖励越来越少)。</li>
<li>一个分叉的非主分支的区块，最多是接下来6个区块的uncle，是当前主分支区块的兄弟区块。</li>
<li>只会接收当前分叉的第一个区块作为uncle block。</li>
<li>主分支的区块招安两个uncle block都由多到少有一定的奖励。</li>
<li>以太坊区块链中7代及其以内的叔父区块都能得到奖励，超过7代的叔父区块将不会得到奖励，这样是为了避免有些矿工专门在之前的链上制造分叉后坐等被后面的节点招安情况。</li>
<li>以太坊中的出块奖励不会随着区块数量的增多而减少，以太坊中无论何时出块都会获得出块奖励，而比特币中区块的树目超过两千一百万以后就没有出块奖励，此后矿工挖矿的动力来自于交易费了。</li>
</ul>
<h2 id="挖矿算法"><a href="#挖矿算法" class="headerlink" title="挖矿算法"></a>挖矿算法</h2><ul>
<li>difficult to solve but easy to verify.</li>
<li>以太坊使用GPU挖矿(原则上的设计应该是可以让旷工使用普通电脑的CPU挖矿)</li>
</ul>
<p>挖矿过程(ethash算法)：</p>
<ol>
<li>对于每一个块，首先计算一个种子(seed)，该种子只和当前块的信息有关;然后根据种子生成一个32M的随机数据集（cache），每隔30000个块会重新生成seed(对原来的seed求hash)，并根据新的seed计算新的cache。cache的初始大小为16M，每隔30000个块大小增大。</li>
<li>根据Cache生成一个1GB大小的数据集合DAG(有向非循环图)，它是一个完整的搜索空间，挖矿的过程就是从DAG中随机选择元素(类似于比特币挖矿中查找合适Nonce)再进行哈希运算，可以从Cache快速计算DAG指定位置的元素，进而哈希验证。每隔30000个块会重新更新，并增大容量。</li>
</ol>
<p>轻节点可以只保存cache，而旷工要保存整个DAG。</p>
<h2 id="难度调整算法"><a href="#难度调整算法" class="headerlink" title="难度调整算法"></a>难度调整算法</h2><p>出块时间：15s</p>
<h2 id="智能合约"><a href="#智能合约" class="headerlink" title="智能合约"></a>智能合约</h2><h3 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h3><p>智能合约是运行在区块链上的一段代码，代码的逻辑定义了合约的内容，智能合约可以理解为在区块链上可以自动执行的（由消息驱动的）、以代码形式编写的合同（特殊的交易）。Solidity是智能合约最常用的语言。智能合约的账户保存了合约当前的运行状态：</p>
<ul>
<li>balance：余额</li>
<li>nonce：交易次数</li>
<li>code：合约代码</li>
<li>storage：存储，数据结构是一颗MPT</li>
</ul>
<p>EVM（Ethereum Virtual Machine）以太坊虚拟机是以太坊中智能合约的运行环境。它运行在以太坊节点上，当我们把合约部署到以太坊网络上之后，合约就可以在以太坊网络中运行了。</p>
<p>外部账户调用智能合约：创建一个交易，接收地址为要调用的智能合约的地址，data域填写要调用的函数和参数的编码值。</p>
<p>一个合约调用另一个合约中的函数：</p>
<ul>
<li>直接调用(代码中)</li>
<li>使用address类型的call函数</li>
<li>代理调用delegatecall()</li>
</ul>
<p>智能合约的创建和运行：</p>
<ul>
<li>以太坊虚拟机上运行的是合约的字节码形式，需要我们在部署之前先对合约进行编译，代码编写完成后，编译成bytecode</li>
<li>创建合约：外部账户发起一个转账交易到0x0的地址<ul>
<li>转账金额为0，但是要支付汽油费</li>
<li>合约的代码放在data域</li>
</ul>
</li>
<li>智能合约运行在EVM(Ethereum Virtual Machine)上</li>
<li>以太坊是交易驱动的状态机<ul>
<li>调用智能合约的交易发布到区块链上后，每个旷工都会执行这个交易，从当前状态确定性地转移到下一个状态</li>
</ul>
</li>
</ul>
<h3 id="合约部署"><a href="#合约部署" class="headerlink" title="合约部署"></a>合约部署</h3><ul>
<li>以太坊客户端，可以理解为一个开发者工具，它提供账户管理、挖矿、转账、智能合约的部署和执行等等功能</li>
<li>EVM是由以太坊客户端提供的</li>
</ul>
<p>Geth是典型的开发以太坊时使用的客户端，基于Go语言开发。 Geth提供了一个交互式命令控制台，通过命令控制台中包含了以太坊的各种功能（API）。Geth控制台和Chrome浏览器开发者工具里的面的控制台是类似的，不过Geth控制台是跑在终端里。相对于Geth，Mist则是图形化操作界面的以太坊客户端。</p>
<p>智能合约的部署是指把合约字节码发布到区块链上，并使用一个特定的地址来标示这个合约，这个地址称为合约账户。</p>
<p>外部账户与合约账户的区别和关系是这样的：一个外部账户可以通过创建和用自己的私钥来对交易进行签名，来发送消息给另一个外部账户或合约账户。</p>
<p>在两个外部账户之间传送消息是价值转移的过程。但从外部账户到合约账户的消息会激活合约账户的代码，允许它执行各种动作（比如转移代币，写入内部存储，挖出一个新代币，执行一些运算，创建一个新的合约等等）。</p>
<p>只有当外部账户发出指令时，合同账户才会执行相应的操作。</p>
<p>合约部署就是将编译好的合约字节码通过外部账号发送交易的形式部署到以太坊区块链上（由实际矿工出块之后，才真正部署成功）。</p>
<h3 id="合约运行"><a href="#合约运行" class="headerlink" title="合约运行"></a>合约运行</h3><p>合约部署之后，当需要调用这个智能合约的方法时只需要向这个合约账户发送消息（交易）即可，通过消息触发后智能合约的代码就会在EVM中执行了。</p>
<h3 id="Gas"><a href="#Gas" class="headerlink" title="Gas"></a>Gas</h3><ul>
<li>以太坊上用Gas机制来计费，Gas也可以认为是一个工作量单位，智能合约越复杂（计算步骤的数量和类型，占用的内存等），用来完成运行就需要越多Gas。</li>
<li>任何特定的合约所需的运行合约的Gas数量是固定的，由合约的复杂度决定。</li>
<li>而Gas价格由运行合约的人在提交运行合约请求的时候规定，以确定他愿意为这次交易愿意付出的费用：Gas价格（用以太币计价） * Gas数量。</li>
</ul>
<p>Gas的目的是限制执行交易所需的工作量，同时为执行支付费用。当EVM执行交易时，Gas将按照特定规则被逐渐消耗，无论执行到什么位置，一旦Gas被耗尽，将会触发异常。当前调用帧所做的所有状态修改都将被回滚， 如果执行结束还有Gas剩余，这些Gas将被返还给发送账户。如果没有这个限制，就会有人写出无法停止（如：死循环）的合约来阻塞网络。</p>
<p>因此实际上（把前面的内容串起来），我们需要一个有以太币余额的外部账户，来发起一个交易（普通交易或部署、运行一个合约），运行时，矿工收取相应的工作量费用。</p>
<p>汽油费(gas fee)：只有挖矿成功的那个人可以得到</p>
<ul>
<li>智能合约是一个Turing-complete Programming Model</li>
<li>智能合约中的指定要收取汽油费，由交易的人来支付</li>
<li>EVM中不同的指令消耗的汽油费不一样</li>
</ul>
<img src="智能合约可以获取的区块信息.png"/>

<center>智能合约可以获取的区块信息</center>

<p>注意：</p>
<ul>
<li>旷工先执行智能合约，再进行挖矿</li>
<li>旷工要验证刚发布的区块(无偿)，才能更新状态，不然无法进行接下来的挖矿，因为发布的区块里没有三棵树的内容，只是块头里有根hash值。</li>
<li>发布到区块链上的交易不一定是成功执行的，因为要发布后旷工才能拿到汽油费(即使是执行失败的交易也要支付汽油费)。</li>
<li>不支持多线程，无法产生真正意义的随机数(智能合约必须有确定性)。</li>
</ul>
<h2 id="以太坊网络"><a href="#以太坊网络" class="headerlink" title="以太坊网络"></a>以太坊网络</h2><h3 id="以太坊官网测试网络Testnet"><a href="#以太坊官网测试网络Testnet" class="headerlink" title="以太坊官网测试网络Testnet"></a>以太坊官网测试网络Testnet</h3><p>测试网络中，我们可以很容易获得免费的以太币，缺点是需要发很长时间初始化节点。</p>
<h3 id="私有链"><a href="#私有链" class="headerlink" title="私有链"></a>私有链</h3><p>创建自己的以太币私有测试网络，通常也称为私有链，我们可以用它来作为一个测试环境来开发、调试和测试智能合约。通过Geth很容易就可以创建一个属于自己的测试网络，以太币想挖多少挖多少，也免去了同步正式网络的整个区块链数据。</p>
<h3 id="开发者网络-模式"><a href="#开发者网络-模式" class="headerlink" title="开发者网络(模式)"></a>开发者网络(模式)</h3><p>相比私有链，开发者网络(模式)下，会自动分配一个有大量余额的开发者账户给我们使用。</p>
<h3 id="模拟环境"><a href="#模拟环境" class="headerlink" title="模拟环境"></a>模拟环境</h3><p>另一个创建测试网络的方法是使用testrpc，testrpc是在本地使用内存模拟的一个以太坊环境，对于开发调试来说，更方便快捷。而且testrpc可以在启动时帮我们创建10个存有资金的测试账户。进行合约开发时，可以在testrpc中测试通过后，再部署到Geth节点中去。</p>
<p>testrpc 现在已经并入到Truffle 开发框架中，现在名字是Ganache CLI。</p>
<h2 id="DAO"><a href="#DAO" class="headerlink" title="DAO"></a>DAO</h2><ul>
<li>Decentralized Autonomous Organization(去中心化的自治组织)：建立在代码之上，基于共识协议来维护组织制度。</li>
<li>The DAO：一个DAO组织</li>
</ul>
<h2 id="美链"><a href="#美链" class="headerlink" title="美链"></a>美链</h2><p>美链是一个部署在以太坊上的智能合约，有自己的代币BEC。</p>
<h2 id="ABI"><a href="#ABI" class="headerlink" title="ABI"></a>ABI</h2><p>ABI 全称是 Application Binary Interface，应用程序二进制接口，简单来说就是以太坊的合约调用时的接口说明。</p>
<p>从外部施加给以太坊的行为都称之为向以太坊网络提交了一个交易，调用合约函数其实是向合约地址（账户）提交了一个交易，这个交易有一个附加数据，这个附加的数据就是ABI的编码数据。因此要想和合约交互，就离不开ABI数据。</p>
<p>演示调用set(1)时，这个交易附带的数据：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line">contract SimpleStorage &#123;</span><br><span class="line">    </span><br><span class="line">    uint storedData;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params">uint x</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        storedData = x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">constant</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> storedData;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>部署到以太坊网络上后，通过参数1调用set函数，打开etherscan查看实时交易数据：</p>
<img src="abi.jpg"/>

<p>这个数据就是ABI的编码数据：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x60fe47b10000000000000000000000000000000000000000000000000000000000000001</span></span><br></pre></td></tr></table></figure>

<p>这个数据可以分成两个子部分：</p>
<ol>
<li>函数选择器(4字节):0x60fe47b1</li>
<li>第一个参数(32字节):00000000000000000000000000000000000000000000000000000000000000001</li>
</ol>
<p>函数选择器值实际是对函数签名字符串进行sha3（keccak256）哈希运算之后，取前4个字节，用代码表示就是(参数部分则是使用对应的16进制数)：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bytes4(sha3(“set(uint256)”)) == <span class="number">0x60fe47b1</span></span><br></pre></td></tr></table></figure>

<p>获得函数对应的ABI有两种方法：</p>
<p>一个是 solidity 提供了ABI的相关API，用来直接得到ABI编码信息，这些函数有：</p>
<ul>
<li>abi.encode(…) returns (bytes)：计算参数的ABI编码。</li>
<li>abi.encodePacked(…) returns (bytes)：计算参数的紧密打包编码</li>
<li>abi. encodeWithSelector(bytes4 selector, …) returns (bytes)： 计算函数选择器和参数的ABI编码</li>
<li>abi.encodeWithSignature(string signature, …) returns (bytes): 等价于* abi.encodeWithSelector(bytes4(keccak256(signature), …)</li>
</ul>
<p>通过ABI编码函数可以在不用调用函数的情况下，获得ABI编码值，下面通过一段代码来看看这些方法的使用：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.24</span>;</span><br><span class="line"></span><br><span class="line">contract testABI &#123;</span><br><span class="line">    uint storedData;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params">uint x</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        storedData = x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">abiEncode</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">constant</span> <span class="title">returns</span> (<span class="params">bytes</span>) </span>&#123;</span><br><span class="line">        abi.encode(<span class="number">1</span>);  <span class="comment">// 计算1的ABI编码</span></span><br><span class="line">        <span class="keyword">return</span> abi.encodeWithSignature(<span class="string">&quot;set(uint256)&quot;</span>, <span class="number">1</span>); <span class="comment">//计算函数set(uint256) 及参数1 的ABI 编码</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另一个web3提供相应的API，例如使用web3计算函数选择器的方式如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web3.eth.abi.encodeFunctionSignature(<span class="string">&#x27;myMethod(uint256,string)&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="Dapp"><a href="#Dapp" class="headerlink" title="Dapp"></a>Dapp</h2><p>以太坊社区把基于智能合约的应用称为去中心化的应用程序(Decentralized App)。如果我们把区块链理解为一个不可篡改的数据库，智能合约理解为和数据库打交道的程序，那就很容易理解Dapp了，一个Dapp不单单有智能合约，比如还需要有一个友好的用户界面和其他的东西。</p>
<p>Truffle是Dapp开发框架，他可以帮我们处理掉大量无关紧要的小事情，让我们可以迅速开始写代码-编译-部署-测试-打包DApp这个流程。</p>
<img src="dapp.jpg"/>

<p>DAPP和传统App关键是后端部分不同，后端不再是一个中心化的服务器，而是分布式网络上任意节点，注意可以是任意一个节点，在应用中给节点发送的请求通常称为交易，交易和中心化下的请求有几个很大的不同是：交易的数据经过用户个人签名之后发送到节点，节点收到交易请求之后，会把请求广播到整个网络，交易在网络达成共识之后，才算是真正的执行。中心化下的请求大多数都是同步的（及时拿到结果），而交易大多数是异步的，这也是在开发去中心应用时需要注意的地方，从节点上获得数据状态（比如交易的结果），一般是通过事件回调来获得。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>以太坊是平台，它让我们方便的使用区块链技术开发去中心化的应用，在这个应用中，使用Solidity来编写和区块链交互的智能合约，合约编写好后之后，我们需要用以太坊客户端用一个有余额的账户去部署及运行合约（使用Truffle框架可以更好的帮助我们做这些事情了）。为了开发方便，我们可以用Geth或testrpc来搭建一个测试网络。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/22/%E5%B7%A5%E5%85%B7%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/22/%E5%B7%A5%E5%85%B7%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">工具笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-11-22 13:49:44" itemprop="dateCreated datePublished" datetime="2018-11-22T13:49:44+08:00">2018-11-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
                </span>
            </span>

          
            <span id="/2018/11/22/%E5%B7%A5%E5%85%B7%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="工具笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2018/11/22/%E5%B7%A5%E5%85%B7%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018/11/22/%E5%B7%A5%E5%85%B7%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="爬百度图片"><a href="#爬百度图片" class="headerlink" title="爬百度图片"></a>爬百度图片</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_page_url</span>(<span class="params">url, param</span>):</span></span><br><span class="line">    response = requests.get(url, params=param)</span><br><span class="line">    response.encoding = <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> response.text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parse_page</span>(<span class="params">str</span>):</span></span><br><span class="line">    pattern = re.compile(<span class="string">&#x27;&quot;middleURL&quot;:&quot;(.*?)&quot;,&#x27;</span>)  <span class="comment">#利用正则匹配图片url</span></span><br><span class="line">    url_list = re.findall(pattern, str)</span><br><span class="line">    <span class="keyword">return</span> url_list</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">keyword, path, num</span>):</span></span><br><span class="line">    url = <span class="string">&quot;https://image.baidu.com/search/acjson&quot;</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line"><span class="comment">#    size = 0</span></span><br><span class="line"><span class="comment">#    if int(num) &lt; 30:</span></span><br><span class="line"><span class="comment">#        size = int(num)</span></span><br><span class="line"><span class="comment">#    else:</span></span><br><span class="line"><span class="comment">#        size = 30</span></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>, int(num), <span class="number">30</span>):</span><br><span class="line">        params = &#123;<span class="string">&quot;ipn&quot;</span>: <span class="string">&quot;rj&quot;</span>, <span class="string">&quot;tn&quot;</span>: <span class="string">&quot;resultjson_com&quot;</span>, <span class="string">&quot;word&quot;</span>: keyword, <span class="string">&quot;pn&quot;</span>: str(j)&#125;</span><br><span class="line">        html = get_page_url(url, params)</span><br><span class="line">        lists = parse_page(html)</span><br><span class="line">        print(lists)</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> lists:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                img_data = requests.get(item, timeout=<span class="number">10</span>).content</span><br><span class="line">                <span class="keyword">with</span> open(path + <span class="string">&quot;/&quot;</span> + str(i) + <span class="string">&quot;.jpg&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    f.write(img_data)</span><br><span class="line">                    f.close()</span><br><span class="line">                i = i+<span class="number">1</span></span><br><span class="line">            <span class="keyword">except</span> requests.exceptions.ConnectionError:</span><br><span class="line">                print(<span class="string">&#x27;can not download&#x27;</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_dir</span>(<span class="params">keyword</span>):</span></span><br><span class="line">    path = <span class="string">&#x27;百度图片/&#x27;</span></span><br><span class="line">    path = path+keyword</span><br><span class="line">    is_exists = os.path.exists(path)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> is_exists:</span><br><span class="line">        os.makedirs(path)</span><br><span class="line">        <span class="keyword">return</span> path</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(path + <span class="string">&#x27;目录已存在&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> path</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    keyword = input(<span class="string">&quot;input keyword about images you want to download: &quot;</span>)</span><br><span class="line">    num = input(<span class="string">&quot;input the number that you want: &quot;</span>)</span><br><span class="line">    path = make_dir(keyword)</span><br><span class="line">    run(keyword, path, num)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<h1 id="爬百度资讯文章"><a href="#爬百度资讯文章" class="headerlink" title="爬百度资讯文章"></a>爬百度资讯文章</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery <span class="keyword">as</span> pq</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_page</span>(<span class="params">url</span>):</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">        <span class="string">&#x27;user-agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.77 Safari/537.36&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;accept-language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;cache-control&#x27;</span>: <span class="string">&#x27;max-age=0&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;accept&#x27;</span>: <span class="string">&#x27;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    response = requests.get(url=url,headers=headers)</span><br><span class="line">    response.encoding = <span class="string">&quot;utf-8&quot;</span></span><br><span class="line">    <span class="comment"># print(response.status_code)</span></span><br><span class="line">    <span class="keyword">if</span> response.status_code == <span class="number">200</span>:</span><br><span class="line">        <span class="keyword">return</span> response.text</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    keyword = input(<span class="string">&quot;input keyword about news that you want to download: &quot;</span>)</span><br><span class="line">    numStart = input(<span class="string">&quot;input the start number that you want: &quot;</span>)</span><br><span class="line">    numEnd = input(<span class="string">&quot;input the end number that you want: &quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> page <span class="keyword">in</span> range(int(numStart), int(numEnd)):</span><br><span class="line">        url = <span class="string">&#x27;https://www.baidu.com/s?rtt=1&amp;bsst=1&amp;cl=2&amp;tn=news&amp;medium=2&amp;word=&#x27;</span> + keyword + <span class="string">&#x27;&amp;pn=&#x27;</span> + str(page*<span class="number">10</span>)</span><br><span class="line">        result = pq(get_page(url))</span><br><span class="line">        print(<span class="string">&#x27;\nnow the page is &#x27;</span>+str(page) + <span class="string">&#x27; and the url is &#x27;</span> + url)</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> range(result(<span class="string">&#x27;.result&#x27;</span>).size()):</span><br><span class="line">            url = pq(result(<span class="string">&#x27;.result&#x27;</span>).eq(item).html())(<span class="string">&#x27;a&#x27;</span>).attr(<span class="string">&#x27;href&#x27;</span>)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 下载文章</span></span><br><span class="line">                d = pq(url=url)</span><br><span class="line">                title = d(<span class="string">&#x27;.article-title&#x27;</span>).text()</span><br><span class="line">                print(<span class="string">&#x27;now the article is &#x27;</span> + title)</span><br><span class="line">                print(<span class="string">&#x27;now the url is &#x27;</span> + url + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(title):</span><br><span class="line">                    os.mkdir(title)</span><br><span class="line">                fobj = open(title + <span class="string">&#x27;/&#x27;</span> + title + <span class="string">&#x27;.txt&#x27;</span>, <span class="string">&#x27;w+&#x27;</span>)</span><br><span class="line">                fobj.write(d(<span class="string">&#x27;.article-title&#x27;</span>).text())</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> range(d(<span class="string">&#x27;.bjh-p&#x27;</span>).size()):</span><br><span class="line">                    fobj.write(<span class="string">&#x27;\n&#x27;</span> + d(<span class="string">&#x27;.bjh-p&#x27;</span>).eq(i).text())</span><br><span class="line">                fobj.close()</span><br><span class="line">                <span class="comment"># 下载图片</span></span><br><span class="line">                <span class="keyword">for</span> imgIndex <span class="keyword">in</span> range(d(<span class="string">&#x27;.img-container&#x27;</span>).size()):</span><br><span class="line">                    img_data = requests.get(pq(d(<span class="string">&#x27;.img-container&#x27;</span>).eq(imgIndex).html())(<span class="string">&#x27;img&#x27;</span>).attr(<span class="string">&#x27;src&#x27;</span>), timeout=<span class="number">10</span>).content</span><br><span class="line">                    <span class="keyword">with</span> open(title + <span class="string">&quot;/&quot;</span> + str(imgIndex) + <span class="string">&quot;.jpg&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                        f.write(img_data)</span><br><span class="line">                        f.close()</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                print(<span class="string">&#x27;there is a error when parsing this article, maybe it is not exist.&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="比较目录差异"><a href="#比较目录差异" class="headerlink" title="比较目录差异"></a>比较目录差异</h1><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.security.MessageDigest</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimilarCalculate</span> &#123;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> main(String[] args) &#123;</span><br><span class="line">        <span class="keyword">if</span> (args == <span class="literal">null</span> || args.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        String path1 = args[<span class="number">0</span>]</span><br><span class="line">        String path2 = args[<span class="number">1</span>]</span><br><span class="line">        compareByCode(path1, path2)</span><br><span class="line">        println(<span class="string">&quot;--------------------------------------&quot;</span>)</span><br><span class="line">        compareByShell(path1, path2)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> compareByCode(String path1, String path2) &#123;</span><br><span class="line">        <span class="keyword">def</span> f1 = <span class="keyword">new</span> File(path1)</span><br><span class="line">        <span class="keyword">def</span> f2 = <span class="keyword">new</span> File(path2)</span><br><span class="line">        <span class="keyword">int</span> diffCount1, nonCount1, diffCount2, nonCount2</span><br><span class="line">        (diffCount1, nonCount1) = compareDir(f1, f2)</span><br><span class="line">        (diffCount2, nonCount2) = compareDir(f2, f1)</span><br><span class="line">        println(<span class="string">&quot;Value: $diffCount1, $nonCount1, $diffCount2, $nonCount2&quot;</span>)</span><br><span class="line">        printResult(f1, diffCount1 + nonCount1 + nonCount2)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Integer&gt; compareDir(File src, File des) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!src.isDirectory() || !des.isDirectory()) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> diffCount = <span class="number">0</span></span><br><span class="line">        <span class="keyword">int</span> nonCount = <span class="number">0</span></span><br><span class="line">        src.eachFileRecurse &#123;</span><br><span class="line">            <span class="keyword">if</span> (it.isFile()) &#123;</span><br><span class="line">                String subPath = src.relativePath(it)</span><br><span class="line">                File desFile = <span class="keyword">new</span> File(des, subPath)</span><br><span class="line">                <span class="keyword">if</span> (desFile.exists()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!fileSame(it, desFile)) &#123;</span><br><span class="line">                        diffCount++</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    nonCount++</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> [diffCount, nonCount]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> printResult(File origin, <span class="keyword">int</span> diff) &#123;</span><br><span class="line">        <span class="keyword">int</span> total = <span class="number">0</span></span><br><span class="line">        origin.eachFileRecurse &#123;</span><br><span class="line">            <span class="keyword">if</span> (it.isFile()) &#123;</span><br><span class="line">                total++</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        println(<span class="string">&quot;Diff: $&#123;diff&#125;, Total: $&#123;total&#125;, Percentage: $&#123;diff * 1f / total&#125;&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> compareByShell(String path1, String path2) &#123;</span><br><span class="line">        <span class="keyword">def</span> f1 = <span class="keyword">new</span> File(path1)</span><br><span class="line">        <span class="keyword">def</span> f2 = <span class="keyword">new</span> File(path2)</span><br><span class="line">        createDir(f1, f2)</span><br><span class="line">        createDir(f2, f1)</span><br><span class="line">        String result = <span class="string">&quot;diff -rq $path1 $path2&quot;</span>.execute().text.trim()</span><br><span class="line">        printResult(f1, getLineNumberByIo(result))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> getLineNumberByIo(String target) &#123;</span><br><span class="line">        LineNumberReader lnr = <span class="keyword">new</span> LineNumberReader(<span class="keyword">new</span> CharArrayReader(target.toCharArray()))</span><br><span class="line">        lnr.skip(Long.MAX_VALUE)</span><br><span class="line">        lnr.close()</span><br><span class="line">        <span class="keyword">return</span> lnr.getLineNumber() + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> createDir(File src, File des) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!src.isDirectory() || !des.isDirectory()) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        src.eachFileRecurse &#123;</span><br><span class="line">            <span class="keyword">if</span> (it.isDirectory()) &#123;</span><br><span class="line">                String subPath = src.relativePath(it)</span><br><span class="line">                File newFile = <span class="keyword">new</span> File(des, subPath)</span><br><span class="line">                <span class="keyword">if</span> (!newFile.exists()) &#123;</span><br><span class="line"><span class="comment">//                    println(&quot;Create path in $&#123;des.absolutePath&#125;: $subPath&quot;)</span></span><br><span class="line">                    newFile.mkdirs()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// --------------------------------------------------------------------------------------------------------- //</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> fileSame(File f1, File f2) &#123;</span><br><span class="line">        <span class="keyword">return</span> getMD5(f1) == getMD5(f2)</span><br><span class="line"><span class="comment">//        String s1 = is2String(new FileInputStream(f1))</span></span><br><span class="line"><span class="comment">//        String s2 = is2String(new FileInputStream(f2))</span></span><br><span class="line"><span class="comment">//        return s1 == s2</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String is2String(InputStream is) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(is)).lines().parallel().collect(Collectors.joining(<span class="string">&quot;\n&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String getMD5(File file) &#123;</span><br><span class="line">        FileInputStream fileInputStream = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            MessageDigest MD5 = MessageDigest.getInstance(<span class="string">&quot;MD5&quot;</span>)</span><br><span class="line">            fileInputStream = <span class="keyword">new</span> FileInputStream(file)</span><br><span class="line">            <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">8192</span>]</span><br><span class="line">            <span class="keyword">int</span> length</span><br><span class="line">            <span class="keyword">while</span> ((length = fileInputStream.read(buffer)) != <span class="number">-1</span>) &#123;</span><br><span class="line">                MD5.update(buffer, <span class="number">0</span>, length)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String(encodeHex(MD5.digest()))</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace()</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (fileInputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">                    fileInputStream.close()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Used to build output as Hex</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">char</span>[] DIGITS_LOWER =</span><br><span class="line">            [<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Used to build output as Hex</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">char</span>[] DIGITS_UPPER =</span><br><span class="line">            [<span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;1&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;3&#x27;</span>, <span class="string">&#x27;4&#x27;</span>, <span class="string">&#x27;5&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;9&#x27;</span>, <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;F&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">char</span>[] encodeHex(<span class="keyword">final</span> <span class="keyword">byte</span>[] data) &#123;</span><br><span class="line">        <span class="keyword">return</span> encodeHex(data, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">char</span>[] encodeHex(<span class="keyword">final</span> <span class="keyword">byte</span>[] data, <span class="keyword">final</span> <span class="keyword">boolean</span> toLowerCase) &#123;</span><br><span class="line">        <span class="keyword">return</span> encodeHex(data, toLowerCase ? DIGITS_LOWER : DIGITS_UPPER);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">char</span>[] encodeHex(<span class="keyword">final</span> <span class="keyword">byte</span>[] data, <span class="keyword">final</span> <span class="keyword">char</span>[] toDigits) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> l = data.length;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">char</span>[] out = <span class="keyword">new</span> <span class="keyword">char</span>[l &lt;&lt; <span class="number">1</span>];</span><br><span class="line">        <span class="comment">// two characters form the hex value.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; l; i++) &#123;</span><br><span class="line">            out[j++] = toDigits[(<span class="number">0xF0</span> &amp; data[i]) &gt;&gt;&gt; <span class="number">4</span>];</span><br><span class="line">            out[j++] = toDigits[<span class="number">0x0F</span> &amp; data[i]];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> out;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/20/Go%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/20/Go%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Go学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-11-20 22:01:29" itemprop="dateCreated datePublished" datetime="2018-11-20T22:01:29+08:00">2018-11-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">语言</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/Go/" itemprop="url" rel="index"><span itemprop="name">Go</span></a>
                </span>
            </span>

          
            <span id="/2018/11/20/Go%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="Go学习笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2018/11/20/Go%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018/11/20/Go%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="安装与配置"><a href="#安装与配置" class="headerlink" title="安装与配置"></a>安装与配置</h1><p>环境变量：</p>
<ul>
<li>GOROOT：Go的安装目录</li>
<li>GOPATH：Go的工作区的集合，通过go get下载的扩展包会放在其中</li>
<li>GOBIN：存放Go程序的可执行文件</li>
<li>PATH：<code>export PATH=$PATH:$GOROOT:/bin:$GOBIN</code></li>
</ul>
<h1 id="基本规则"><a href="#基本规则" class="headerlink" title="基本规则"></a>基本规则</h1><h2 id="工作区"><a href="#工作区" class="headerlink" title="工作区"></a>工作区</h2><p>工作区是放置Go源码文件的目录。一般情况下，Go源码文件都需要存放到工作区中。但是对于命令源码文件来说，这不是必须的。</p>
<p>每一个工作区的结构都类似包含：golib/,src/,pkg/,bin/</p>
<ul>
<li>src目录用于存放源码文件;以代码包为组织形式</li>
<li>pkg目录用于存放归档文件(名称以.a为后缀的文件) 所有归档文件都会被存放到该目录下的平台相关目录中，用样以代码包为组织形式</li>
<li>平台相关目录:两个隐含的Go语言环境变量:GOOS和GOARCH</li>
</ul>
<h1 id="命令基础"><a href="#命令基础" class="headerlink" title="命令基础"></a>命令基础</h1><ul>
<li>go build 用于编译源码文件、代码包、依赖包</li>
<li>go run  可以编译并运行Go源码文件</li>
<li>go get  主要是用来动态获取远程代码包</li>
</ul>
<h1 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h1><h2 id="基本结构"><a href="#基本结构" class="headerlink" title="基本结构"></a>基本结构</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> NAME <span class="keyword">string</span> = <span class="string">&quot;Hello&quot;</span> <span class="comment">//常量</span></span><br><span class="line"><span class="keyword">var</span> a <span class="keyword">string</span> = <span class="string">&quot;aaa&quot;</span>        <span class="comment">//全局变量的声明和赋值</span></span><br><span class="line"><span class="keyword">type</span> b <span class="keyword">int</span>                  <span class="comment">//一般类型的声明</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;                           <span class="comment">//结构体的声明</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> IUser <span class="keyword">interface</span> &#123;</span><br><span class="line">&#125;                           <span class="comment">//接口的声明</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">fun</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;                           <span class="comment">//函数声明</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;hello&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="package"><a href="#package" class="headerlink" title="package"></a>package</h2><ul>
<li>package是<strong>最基本得分发单位</strong>和<strong>工程管理中依赖关系的体现</strong></li>
<li>每个Go语言的代码文件<strong>开头</strong>都拥有一个package声明，表示源码文件所属的代码包</li>
<li>要生成GO语言<strong>可执行程序</strong>，必须要有main的package包，且必须在该包下有**main()**函数</li>
<li><strong>同一路径下只能存在一个package</strong>，一个package可以拆分成多个源文件组成</li>
</ul>
<h2 id="import"><a href="#import" class="headerlink" title="import"></a>import</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;pac1&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;pac2&quot;</span></span><br></pre></td></tr></table></figure>

<p>等价于：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;pac1&quot;</span></span><br><span class="line">	<span class="string">&quot;pac2&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>如果一个main导入其他包，包将被顺序导入</li>
<li>如果导入的包中有其他包（包B），会首先导入B包，然后初始化B包中的常量与变量，最后如果B中有init，会自动执行init（）；</li>
<li>所有包导入完成之后才会对main中常量和变量进行初始化，然后执行main中的init函数（如果存在），最后执行main函数；</li>
<li>如果一个包被导入多次，则该包只会被导入一次。</li>
</ul>
<img src="import原理.png"/>

<h1 id="变量和常量"><a href="#变量和常量" class="headerlink" title="变量和常量"></a>变量和常量</h1><h2 id="变量声明"><a href="#变量声明" class="headerlink" title="变量声明"></a>变量声明</h2><p>第一种，指定变量类型，声明后若不赋值，使用默认值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> v_name v_type</span><br><span class="line">v_name = value</span><br></pre></td></tr></table></figure>

<p>第二种，根据值自行判定变量类型。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> v_name = value</span><br></pre></td></tr></table></figure>

<p>第三种，省略var, <strong><code>:=</code>左侧的变量不应该是已经声明过的，否则会导致编译错误。这是使用变量的首选形式，但是它只能被用在函数体内，而不可以用于全局变量的声明与赋值。使用操作符 := 可以高效地创建一个新的变量，称之为初始化声明。</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v_name := value</span><br></pre></td></tr></table></figure>

<p><strong>如果想要交换两个变量的值，则可以简单地使用 a, b = b, a，两个变量的类型必须是相同。</strong></p>
<h2 id="多变量声明"><a href="#多变量声明" class="headerlink" title="多变量声明"></a>多变量声明</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//类型相同多个变量, 非全局变量</span></span><br><span class="line"><span class="keyword">var</span> vname1, vname2, vname3 <span class="keyword">type</span></span><br><span class="line">vname1, vname2, vname3 = v1, v2, v3</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> vname1, vname2, vname3 = v1, v2, v3 <span class="comment">//和python很像,不需要显示声明类型，自动推断</span></span><br><span class="line"></span><br><span class="line">vname1, vname2, vname3 := v1, v2, v3 <span class="comment">//出现在:=左侧的变量不应该是已经被声明过的，否则会导致编译错误</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 这种因式分解关键字的写法一般用于声明全局变量</span></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    vname1 v_type1</span><br><span class="line">    vname2 v_type2</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> x, y <span class="keyword">int</span></span><br><span class="line"><span class="keyword">var</span> (  <span class="comment">// 这种因式分解关键字的写法一般用于声明全局变量</span></span><br><span class="line">    a <span class="keyword">int</span></span><br><span class="line">    b <span class="keyword">bool</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> c, d <span class="keyword">int</span> = <span class="number">1</span>, <span class="number">2</span></span><br><span class="line"><span class="keyword">var</span> e, f = <span class="number">123</span>, <span class="string">&quot;hello&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//这种不带声明格式的只能在函数体中出现</span></span><br><span class="line"><span class="comment">//g, h := 123, &quot;hello&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    g, h := <span class="number">123</span>, <span class="string">&quot;hello&quot;</span></span><br><span class="line">    <span class="built_in">println</span>(x, y, a, b, c, d, e, f, g, h)</span><br><span class="line">&#125;</span><br><span class="line">以上实例执行结果为：</span><br><span class="line"></span><br><span class="line"><span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="literal">false</span> <span class="number">1</span> <span class="number">2</span> <span class="number">123</span> hello <span class="number">123</span> hello</span><br></pre></td></tr></table></figure>

<h2 id="值类型和引用类型"><a href="#值类型和引用类型" class="headerlink" title="值类型和引用类型"></a>值类型和引用类型</h2><p>所有像 int、float、bool 和 string 这些基本类型都属于值类型，使用这些类型的变量直接指向存在内存中的值,当使用等号 = 将一个变量的值赋值给另一个变量时，如：j = i，实际上是在内存中将 i 的值进行了拷贝, 值类型的变量的值存储在栈中。</p>
<p>更复杂的数据通常会需要使用多个字，这些数据一般使用引用类型保存。一个引用类型的变量 r1 存储的是 r1 的值所在的内存地址（数字），或内存地址中第一个字所在的位置。这个内存地址为称之为指针，这个指针实际上也被存在另外的某一个字中。同一个引用类型的指针指向的多个字可以是在连续的内存地址中（内存布局是连续的），这也是计算效率最高的一种存储形式；也可以将这些字分散存放在内存中，每个字都指示了下一个字所在的内存地址。</p>
<p>当使用赋值语句 r2 = r1 时，只有引用（地址）被复制,如果 r1 的值被改变了，那么这个值的所有引用都会指向被修改后的内容。</p>
<h2 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> identifier [<span class="keyword">type</span>] = value</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多个相同类型的声明可以简写为：</span></span><br><span class="line"><span class="keyword">const</span> c_name1, c_name2 = value1, value2</span><br><span class="line"></span><br><span class="line"><span class="comment">// 常量还可以用作枚举：</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    Unknown = <span class="number">0</span></span><br><span class="line">    Female = <span class="number">1</span></span><br><span class="line">    Male = <span class="number">2</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>字符串类型在 go 里是个结构, 包含指向底层数组的指针和长度,这两部分每部分都是 8 个字节，所以字符串类型大小为 16 个字节。</p>
<h2 id="iota"><a href="#iota" class="headerlink" title="iota"></a>iota</h2><p>iota，特殊常量，可以认为是一个可以被编译器修改的常量。iota 在 const关键字出现时将被重置为 0(const 内部的第一行之前)，const 中每新增一行常量声明将使 iota 计数一次(iota 可理解为 const 语句块中的行索引)。</p>
<p>iota 可以被用作枚举值：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    a = <span class="literal">iota</span></span><br><span class="line">    b = <span class="literal">iota</span></span><br><span class="line">    c = <span class="literal">iota</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>第一个 iota 等于 0，每当 iota 在新的一行被使用时，它的值都会自动加 1；所以 a=0, b=1, c=2 可以简写为如下形式：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    a = <span class="literal">iota</span></span><br><span class="line">    b</span><br><span class="line">    c</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">const</span> (</span><br><span class="line">            a = <span class="literal">iota</span>   <span class="comment">//0</span></span><br><span class="line">            b          <span class="comment">//1</span></span><br><span class="line">            c          <span class="comment">//2</span></span><br><span class="line">            d = <span class="string">&quot;ha&quot;</span>   <span class="comment">//独立值，iota += 1</span></span><br><span class="line">            e          <span class="comment">//&quot;ha&quot;   iota += 1</span></span><br><span class="line">            f = <span class="number">100</span>    <span class="comment">//iota +=1</span></span><br><span class="line">            g          <span class="comment">//100  iota +=1</span></span><br><span class="line">            h = <span class="literal">iota</span>   <span class="comment">//7,恢复计数</span></span><br><span class="line">            i          <span class="comment">//8</span></span><br><span class="line">    )</span><br><span class="line">    fmt.Println(a,b,c,d,e,f,g,h,i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 以上实例运行结果为：</span></span><br><span class="line"><span class="comment">//0 1 2 ha ha 100 100 7 8</span></span><br></pre></td></tr></table></figure>

<p>再看个有趣的的 iota 实例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    i=<span class="number">1</span>&lt;&lt;<span class="literal">iota</span></span><br><span class="line">    j=<span class="number">3</span>&lt;&lt;<span class="literal">iota</span></span><br><span class="line">    k</span><br><span class="line">    l</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;i=&quot;</span>,i)</span><br><span class="line">    fmt.Println(<span class="string">&quot;j=&quot;</span>,j)</span><br><span class="line">    fmt.Println(<span class="string">&quot;k=&quot;</span>,k)</span><br><span class="line">    fmt.Println(<span class="string">&quot;l=&quot;</span>,l)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//以上实例运行结果为：</span></span><br><span class="line"><span class="comment">//i= 1</span></span><br><span class="line"><span class="comment">//j= 6</span></span><br><span class="line"><span class="comment">//k= 12</span></span><br><span class="line"><span class="comment">//l= 24</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//i=1：左移 0 位,不变仍为 1;</span></span><br><span class="line"><span class="comment">//j=3：左移 1 位,变为二进制 110, 即 6;</span></span><br><span class="line"><span class="comment">//k=3：左移 2 位,变为二进制 1100, 即 12;</span></span><br><span class="line"><span class="comment">//l=3：左移 3 位,变为二进制 11000,即 24。</span></span><br></pre></td></tr></table></figure>

<h2 id="new和make"><a href="#new和make" class="headerlink" title="new和make"></a>new和make</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">make</span><span class="params">(t Type, size ...IntegerType)</span> <span class="title">Type</span></span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">new</span><span class="params">(Type)</span> *<span class="title">Type</span></span></span><br></pre></td></tr></table></figure>

<p>二者都是内存的分配（堆上），但是make只用于slice、map以及channel的初始化（非零值）；而new用于类型的内存分配，并且内存置为零(new不常用)。</p>
<h1 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h1><h2 id="条件语句"><a href="#条件语句" class="headerlink" title="条件语句"></a>条件语句</h2><h3 id="if-else-switch"><a href="#if-else-switch" class="headerlink" title="if-else/switch"></a>if-else/switch</h3><table>
<thead>
<tr>
<th align="center">语句</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">if bool {} else {}</td>
<td align="center">判断语句</td>
</tr>
<tr>
<td align="center">switch</td>
<td align="center">switch 语句用于基于不同条件执行不同动作。</td>
</tr>
</tbody></table>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="literal">true</span> &#123;</span><br><span class="line">	</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">switch</span> expr &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="select"><a href="#select" class="headerlink" title="select"></a>select</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line">ch2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">1</span>)</span><br><span class="line"><span class="comment">// 省略若干条语句</span></span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line">	<span class="keyword">case</span> e1 := &lt;-ch1:</span><br><span class="line">		fmt.Printf(<span class="string">&quot;1th case is selected. e1=%v.\n&quot;</span>, e1)</span><br><span class="line">	<span class="keyword">case</span> e2 := &lt;-ch2:</span><br><span class="line">		fmt.Printf(<span class="string">&quot;2th case is selected. e2=%v.\n&quot;</span>, e2)</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		fmt.Println(<span class="string">&quot;No data!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果该select语句被执行时通道ch1和ch2中都没有任何数据，那么肯定只有default case会被执行。但是，只要有一个通道在当时有数据就不会轮到default case执行了。显然，对于包含通道接收操作的case来讲，其执行条件就是通道中存在数据（或者说通道未空）。如果在当时有数据的通道多于一个，那么Go语言会通过一种伪随机的算法来决定哪一个case将被执行。</p>
<h3 id="defer"><a href="#defer" class="headerlink" title="defer"></a>defer</h3><p>defer代码块会在函数调用链表中增加一个函数调用。这个函数调用不是普通的函数调用，而是会在函数正常返回，也就是return之后添加一个函数调用。因此，defer通常用来释放函数内部变量。</p>
<ol>
<li>defer执行顺序为先进后出</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">deferIt</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    	fmt.Print(<span class="number">1</span>)</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		fmt.Print(<span class="number">2</span>)</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">   		fmt.Print(<span class="number">3</span>)</span><br><span class="line">	&#125;()</span><br><span class="line">	fmt.Print(<span class="number">4</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// deferIt函数的执行会使标准输出上打印出4321。</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>当defer被声明时，其参数就会被实时解析,函数值和函数参数被求值，但函数不会立即调用</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">a</span><span class="params">()</span></span> &#123;</span><br><span class="line">	i := <span class="number">0</span></span><br><span class="line">	<span class="keyword">defer</span> fmt.Println(i)</span><br><span class="line">	i++</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;	<span class="comment">// 0</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">deferIt3</span><span class="params">()</span></span> &#123;</span><br><span class="line">    f := <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;%d &quot;</span>,i)</span><br><span class="line">        <span class="keyword">return</span> i * <span class="number">10</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">defer</span> fmt.Printf(<span class="string">&quot;%d &quot;</span>, f(i))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;	<span class="comment">// 1 2 3 4 40 30 20 10</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>defer可以读取有名返回值</li>
</ol>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">c</span><span class="params">()</span> <span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; i++ &#125;()</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;	<span class="comment">// 1	2</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">deferIt4</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            fmt.Print(i)</span><br><span class="line">        &#125;()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;	<span class="comment">// 5555</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">deferIt4</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">(n <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">            fmt.Print(n)</span><br><span class="line">        &#125;(i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;	<span class="comment">// 4321</span></span><br></pre></td></tr></table></figure>

<h2 id="循环语句"><a href="#循环语句" class="headerlink" title="循环语句"></a>循环语句</h2><p>go语言没有while语句，可用for实现。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="number">101</span>; i++ &#123;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h1><p>go中函数可以返回多个值：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">function_name</span><span class="params">([parameter <span class="keyword">type</span>])</span> [<span class="title">return_types</span>...]</span> &#123;</span><br><span class="line">	<span class="comment">// 函数体</span></span><br><span class="line">	[<span class="keyword">return</span> x...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数作为变量：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">   <span class="comment">/* 声明函数变量 */</span></span><br><span class="line">   getSquareRoot := <span class="function"><span class="keyword">func</span><span class="params">(x <span class="keyword">float64</span>)</span> <span class="title">float64</span></span> &#123;</span><br><span class="line">      <span class="keyword">return</span> math.Sqrt(x)</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/* 使用函数 */</span></span><br><span class="line">   fmt.Println(getSquareRoot(<span class="number">9</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Go 语言支持匿名函数，可作为闭包：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getSequence</span><span class="params">()</span> <span class="title">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">	i:=<span class="number">0</span></span><br><span class="line">	<span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">		i+=<span class="number">1</span></span><br><span class="line">		<span class="keyword">return</span> i  </span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="comment">/* nextNumber 为一个函数，函数 i 为 0 */</span></span><br><span class="line">	nextNumber := getSequence()  </span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 调用 nextNumber 函数，i 变量自增 1 并返回 */</span></span><br><span class="line">	fmt.Println(nextNumber())</span><br><span class="line">	fmt.Println(nextNumber())</span><br><span class="line">	fmt.Println(nextNumber())</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 创建新的函数 nextNumber1，并查看结果 */</span></span><br><span class="line">	nextNumber1 := getSequence()  </span><br><span class="line">	fmt.Println(nextNumber1())</span><br><span class="line">	fmt.Println(nextNumber1())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>既然可以在代表函数的变量上实施调用表达式，那么在匿名函数上肯定也是可行的。因为它们的本质是相同的。示例如下(这里的result变量的类型不是函数类型，而与后面的匿名函数的结果类型是相同的)：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> result = <span class="function"><span class="keyword">func</span><span class="params">(part1 <span class="keyword">string</span>, part2 <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> part1 + part2</span><br><span class="line">&#125;(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>方法就是一个包含了接受者的函数，接受者可以是命名类型或者结构体类型的一个值或者是一个指针。所有给定类型的方法属于该类型的方法集。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(variable_name variable_data_type)</span> <span class="title">function_name</span><span class="params">()</span> [<span class="title">return_type</span>]</span>&#123;</span><br><span class="line">	<span class="comment">/* 函数体*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 定义结构体 */</span></span><br><span class="line"><span class="keyword">type</span> Circle <span class="keyword">struct</span> &#123;</span><br><span class="line">	radius <span class="keyword">float64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> c1 Circle</span><br><span class="line">	c1.radius = <span class="number">10.00</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;圆的面积 = &quot;</span>, c1.getArea())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//该 method 属于 Circle 类型对象中的方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c Circle)</span> <span class="title">getArea</span><span class="params">()</span> <span class="title">float64</span></span> &#123;</span><br><span class="line">	<span class="comment">//c.radius 即为 Circle 类型对象中的属性</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">3.14</span> * c.radius * c.radius</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h1><h2 id="bool"><a href="#bool" class="headerlink" title="bool"></a>bool</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> b <span class="keyword">bool</span> = <span class="literal">true</span>/<span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h2 id="数字类型"><a href="#数字类型" class="headerlink" title="数字类型"></a>数字类型</h2><ul>
<li>uint: 32或64位</li>
<li>int: 同于uint</li>
<li>uint8</li>
<li>uint16</li>
<li>uint32</li>
<li>uint64</li>
<li>int8</li>
<li>int16</li>
<li>int32</li>
<li>int64</li>
<li>float32</li>
<li>float64</li>
<li>complex64: 32位实数和虚数</li>
<li>complex128: 64位实数和虚数</li>
<li>byte: 类似uint8</li>
<li>rune: 类似int32</li>
<li>uintptr: 无符号整型，用于存放一个指针</li>
</ul>
<h2 id="字符串类型"><a href="#字符串类型" class="headerlink" title="字符串类型"></a>字符串类型</h2><p>string：Go的字符串是由单个字节连接起来的。Go语言的字符串的字节使用UTF-8编码标识Unicode文本。</p>
<h2 id="数组类型"><a href="#数组类型" class="headerlink" title="数组类型"></a>数组类型</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> variable_name [SIZE] variable_type</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> balance = [<span class="number">5</span>]<span class="keyword">float32</span>&#123;<span class="number">1000.0</span>, <span class="number">2.0</span>, <span class="number">3.4</span>, <span class="number">7.0</span>, <span class="number">50.0</span>&#125;</span><br></pre></td></tr></table></figure>

<p>如果忽略 [] 中的数字不设置数组大小，Go 语言会根据元素的个数来设置数组的大小：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> balance = [...]<span class="keyword">float32</span>&#123;<span class="number">1000.0</span>, <span class="number">2.0</span>, <span class="number">3.4</span>, <span class="number">7.0</span>, <span class="number">50.0</span>&#125;</span><br></pre></td></tr></table></figure>

<p>多维数组：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> variable_name [SIZE1][SIZE2]...[SIZEN] variable_type</span><br></pre></td></tr></table></figure>

<p>初始化二维数组：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">3</span>][<span class="number">4</span>]<span class="keyword">int</span>&#123;  </span><br><span class="line">	&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125; ,   <span class="comment">/*  第一行索引为 0 */</span></span><br><span class="line">	&#123;<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>&#125; ,   <span class="comment">/*  第二行索引为 1 */</span></span><br><span class="line">	&#123;<span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>&#125;,   <span class="comment">/* 第三行索引为 2 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>向函数传递数组：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 形参设定数组大小：</span></span><br><span class="line">void myFunction(param [<span class="number">10</span>]<span class="keyword">int</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 形参未设定数组大小：</span></span><br><span class="line">void myFunction(param []<span class="keyword">int</span>)</span><br></pre></td></tr></table></figure>

<h2 id="指针"><a href="#指针" class="headerlink" title="指针"></a>指针</h2><p>空指针为nil，指代零值或空值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> var_name *<span class="keyword">var</span>-<span class="keyword">type</span></span><br><span class="line"><span class="comment">// 指针数组</span></span><br><span class="line"><span class="keyword">var</span> var_name [<span class="number">5</span>]*<span class="keyword">var</span>-<span class="keyword">type</span></span><br><span class="line"><span class="comment">// 指向指针的指针</span></span><br><span class="line"><span class="keyword">var</span> var_name **<span class="keyword">var</span>-<span class="keyword">type</span></span><br></pre></td></tr></table></figure>

<p>指针作为函数参数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">/* 定义局部变量 */</span></span><br><span class="line">	<span class="keyword">var</span> a <span class="keyword">int</span> = <span class="number">100</span></span><br><span class="line">	<span class="keyword">var</span> b <span class="keyword">int</span>= <span class="number">200</span></span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;交换前 a 的值 : %d\n&quot;</span>, a )</span><br><span class="line">	fmt.Printf(<span class="string">&quot;交换前 b 的值 : %d\n&quot;</span>, b )</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 调用函数用于交换值</span></span><br><span class="line"><span class="comment">	* &amp;a 指向 a 变量的地址</span></span><br><span class="line"><span class="comment">	* &amp;b 指向 b 变量的地址</span></span><br><span class="line"><span class="comment">	*/</span></span><br><span class="line">	swap(&amp;a, &amp;b);</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;交换后 a 的值 : %d\n&quot;</span>, a )</span><br><span class="line">	fmt.Printf(<span class="string">&quot;交换后 b 的值 : %d\n&quot;</span>, b )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">swap</span><span class="params">(x *<span class="keyword">int</span>, y *<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> temp <span class="keyword">int</span></span><br><span class="line">	temp = *x    <span class="comment">/* 保存 x 地址的值 */</span></span><br><span class="line">	*x = *y      <span class="comment">/* 将 y 赋值给 x */</span></span><br><span class="line">	*y = temp    <span class="comment">/* 将 temp 赋值给 y */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="结构体类型"><a href="#结构体类型" class="headerlink" title="结构体类型"></a>结构体类型</h2><p>用法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> struct_variable_type <span class="keyword">struct</span> &#123;</span><br><span class="line">	member definition;</span><br><span class="line">	member definition;</span><br><span class="line">	...</span><br><span class="line">	member definition;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable_name := structure_variable_type &#123;value1, value2...valuen&#125;</span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line">variable_name := structure_variable_type &#123; key1: value1, key2: value2..., keyn: valuen&#125;</span><br></pre></td></tr></table></figure>

<p>访问时通过<code>.</code>操作访问结构体成员。</p>
<h2 id="切片类型"><a href="#切片类型" class="headerlink" title="切片类型"></a>切片类型</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 声明一个未指定大小的数组来定义切片：</span></span><br><span class="line"><span class="keyword">var</span> identifier []<span class="keyword">type</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用make()函数来创建切片:</span></span><br><span class="line"><span class="keyword">var</span> slice1 []<span class="keyword">type</span> = <span class="built_in">make</span>([]<span class="keyword">type</span>, <span class="built_in">len</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 也可以简写为：</span></span><br><span class="line">slice1 := <span class="built_in">make</span>([]<span class="keyword">type</span>, <span class="built_in">len</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 也可以指定容量，其中capacity为可选参数。</span></span><br><span class="line"><span class="built_in">make</span>([]T, length, capacity)</span><br><span class="line"><span class="comment">// 这里 len 是数组的长度并且也是切片的初始长度。</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">s :=[] <span class="keyword">int</span> &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span> &#125; </span><br><span class="line"><span class="comment">// 直接初始化切片，[]表示是切片类型，&#123;1,2,3&#125;初始化值依次是1,2,3.其cap=len=3</span></span><br><span class="line"></span><br><span class="line">s := arr[:] </span><br><span class="line"><span class="comment">// 初始化切片s,是数组arr的引用</span></span><br><span class="line"></span><br><span class="line">s := arr[startIndex:endIndex] </span><br><span class="line"><span class="comment">// 将arr中从下标startIndex到endIndex-1 下的元素创建为一个新的切片</span></span><br><span class="line"></span><br><span class="line">s := arr[startIndex:] </span><br><span class="line"><span class="comment">// 缺省endIndex时将表示一直到arr的最后一个元素</span></span><br><span class="line"></span><br><span class="line">s := arr[:endIndex] </span><br><span class="line"><span class="comment">// 缺省startIndex时将表示从arr的第一个元素开始</span></span><br><span class="line"></span><br><span class="line">s1 := s[startIndex:endIndex] </span><br><span class="line"><span class="comment">// 通过切片s初始化切片s1</span></span><br><span class="line"></span><br><span class="line">s :=<span class="built_in">make</span>([]<span class="keyword">int</span>,<span class="built_in">len</span>,<span class="built_in">cap</span>) </span><br><span class="line"><span class="comment">// 通过内置函数make()初始化切片s,[]int 标识为其元素类型为int的切片</span></span><br></pre></td></tr></table></figure>

<ul>
<li>切片是可索引的，并且可以由 len() 方法获取长度。切片提供了计算容量的方法 cap() 可以测量切片最长可以达到多少。</li>
<li>一个切片在未初始化之前默认为 nil，长度为 0.</li>
<li>对于底层数组容量是 k 的切片 slice[i:j] 来说：长度: j-i;容量: k-i.</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> numbers []<span class="keyword">int</span></span><br><span class="line"></span><br><span class="line">	printSlice(numbers)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(numbers == <span class="literal">nil</span>)&#123;</span><br><span class="line">	  fmt.Printf(<span class="string">&quot;切片是空的&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printSlice</span><span class="params">(x []<span class="keyword">int</span>)</span></span>&#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;len=%d cap=%d slice=%v\n&quot;</span>,<span class="built_in">len</span>(x),<span class="built_in">cap</span>(x),x)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 以上实例运行输出结果为:</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// len=0 cap=0 slice=[]</span></span><br><span class="line"><span class="comment">// 切片是空的</span></span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">/* 创建切片 */</span></span><br><span class="line">	numbers := []<span class="keyword">int</span>&#123;<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>&#125;   </span><br><span class="line">	printSlice(numbers)	<span class="comment">// len=9 cap=9 slice=[0 1 2 3 4 5 6 7 8]</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 打印原始切片 */</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;numbers ==&quot;</span>, numbers)	<span class="comment">// numbers == [0 1 2 3 4 5 6 7 8]</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 打印子切片从索引1(包含) 到索引4(不包含)*/</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;numbers[1:4] ==&quot;</span>, numbers[<span class="number">1</span>:<span class="number">4</span>])	<span class="comment">// numbers[1:4] == [1 2 3]</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 默认下限为 0*/</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;numbers[:3] ==&quot;</span>, numbers[:<span class="number">3</span>])	<span class="comment">// numbers[:3] == [0 1 2]</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 默认上限为 len(s)*/</span></span><br><span class="line">	fmt.Println(<span class="string">&quot;numbers[4:] ==&quot;</span>, numbers[<span class="number">4</span>:])	<span class="comment">// numbers[4:] == [4 5 6 7 8]</span></span><br><span class="line"></span><br><span class="line">	numbers1 := <span class="built_in">make</span>([]<span class="keyword">int</span>,<span class="number">0</span>,<span class="number">5</span>)</span><br><span class="line">	printSlice(numbers1)	<span class="comment">// len=0 cap=5 slice=[]</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 打印子切片从索引  0(包含) 到索引 2(不包含) */</span></span><br><span class="line">	number2 := numbers[:<span class="number">2</span>]</span><br><span class="line">	printSlice(number2)	<span class="comment">// len=2 cap=9 slice=[0 1]</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 打印子切片从索引 2(包含) 到索引 5(不包含) */</span></span><br><span class="line">	number3 := numbers[<span class="number">2</span>:<span class="number">5</span>]</span><br><span class="line">	printSlice(number3)	<span class="comment">// len=3 cap=7 slice=[2 3 4]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printSlice</span><span class="params">(x []<span class="keyword">int</span>)</span></span>&#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;len=%d cap=%d slice=%v\n&quot;</span>,<span class="built_in">len</span>(x),<span class="built_in">cap</span>(x),x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>append的用法有两种：</p>
<ul>
<li>slice = append(slice, elem1, elem2)</li>
<li>slice = append(slice, anotherSlice…)</li>
</ul>
<p>append要点：</p>
<ul>
<li>用append把一个或多个元素添加在一个slice的后面；</li>
<li>append的slice有一个underlying array，此即slice和array的关系；</li>
<li>另外slice有一个length和capability的概念；</li>
<li>如果slice还有剩余的空间，可以添加这些新元素，那么append就将新的元素放在slice后面的空余空间中；</li>
<li>如果slice的空间不足以放下新增的元素，那么就需要重现创建一个数组；这时可能是alloc、也可能是realloc的方式分配这个新的数组；也就是说，这个新的slice可能和之前的slice在同一个起始地址上，也可能不是一个新的地址。——通常而言，是一个新的地址。</li>
<li>分配了新的地址之后，再把原来slice中的元素逐个拷贝到新的slice中，并返回。</li>
<li>当一个append执行达到了切片的容量，它会自动扩容为原来的两倍大小</li>
</ul>
<p>copy用法：</p>
<ul>
<li>copy(to_slide, from_slide)</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> numbers []<span class="keyword">int</span></span><br><span class="line">	printSlice(numbers) <span class="comment">// len=0 cap=0 slice=[]</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 允许追加空切片 */</span></span><br><span class="line">	numbers = <span class="built_in">append</span>(numbers, <span class="number">0</span>) <span class="comment">// len=1 cap=1 slice=[0]</span></span><br><span class="line">	printSlice(numbers)</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 向切片添加一个元素 */</span></span><br><span class="line">	numbers = <span class="built_in">append</span>(numbers, <span class="number">1</span>)</span><br><span class="line">	printSlice(numbers) <span class="comment">// len=2 cap=2 slice=[0 1]</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 同时添加多个元素 */</span></span><br><span class="line">	numbers = <span class="built_in">append</span>(numbers, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)</span><br><span class="line">	printSlice(numbers) <span class="comment">// len=5 cap=6 slice=[0 1 2 3 4]</span></span><br><span class="line"></span><br><span class="line">	numbers = <span class="built_in">append</span>(numbers, <span class="number">5</span>, <span class="number">6</span>)</span><br><span class="line">	printSlice(numbers) <span class="comment">// len=7 cap=12 slice=[0 1 2 3 4 5 6]</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 创建切片 numbers1 是之前切片的两倍容量*/</span></span><br><span class="line">	numbers1 := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="built_in">len</span>(numbers), (<span class="built_in">cap</span>(numbers))*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 拷贝 numbers 的内容到 numbers1 */</span></span><br><span class="line">	<span class="built_in">copy</span>(numbers1, numbers)</span><br><span class="line">	printSlice(numbers1) <span class="comment">// len=7 cap=24 slice=[0 1 2 3 4 5 6]</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printSlice</span><span class="params">(x []<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">	fmt.Printf(<span class="string">&quot;len=%d cap=%d slice=%v\n&quot;</span>, <span class="built_in">len</span>(x), <span class="built_in">cap</span>(x), x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Range"><a href="#Range" class="headerlink" title="Range"></a>Range</h2><p>range 关键字用于 for 循环中迭代数组(array)、切片(slice)、通道(channel)或集合(map)的元素。在数组和切片中它返回元素的索引和索引对应的值，在集合中返回 key-value 对的 key 值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">//这是我们使用range去求一个slice的和。使用数组跟这个很类似</span></span><br><span class="line">	nums := []<span class="keyword">int</span>&#123;<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>&#125;</span><br><span class="line">	sum := <span class="number">0</span></span><br><span class="line">	<span class="keyword">for</span> _, num := <span class="keyword">range</span> nums &#123;</span><br><span class="line">		sum += num</span><br><span class="line">	&#125;</span><br><span class="line">	fmt.Println(<span class="string">&quot;sum:&quot;</span>, sum)</span><br><span class="line">	<span class="comment">//在数组上使用range将传入index和值两个变量。上面那个例子我们不需要使用该元素的序号，所以我们使用空白符&quot;_&quot;省略了。有时侯我们确实需要知道它的索引。</span></span><br><span class="line">	<span class="keyword">for</span> i, num := <span class="keyword">range</span> nums &#123;</span><br><span class="line">		<span class="keyword">if</span> num == <span class="number">3</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">&quot;index:&quot;</span>, i)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//range也可以用在map的键值对上。</span></span><br><span class="line">	kvs := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">&quot;a&quot;</span>: <span class="string">&quot;apple&quot;</span>, <span class="string">&quot;b&quot;</span>: <span class="string">&quot;banana&quot;</span>&#125;</span><br><span class="line">	<span class="keyword">for</span> k, v := <span class="keyword">range</span> kvs &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;%s -&gt; %s\n&quot;</span>, k, v)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//range也可以用来枚举Unicode字符串。第一个参数是字符的索引，第二个是字符（Unicode的值）本身。</span></span><br><span class="line">	<span class="keyword">for</span> i, c := <span class="keyword">range</span> <span class="string">&quot;go&quot;</span> &#123;</span><br><span class="line">		fmt.Println(i, c)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Map类型"><a href="#Map类型" class="headerlink" title="Map类型"></a>Map类型</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 声明变量，默认 map 是 nil */</span></span><br><span class="line"><span class="keyword">var</span> map_variable <span class="keyword">map</span>[key_data_type]value_data_type</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 使用 make 函数 */</span></span><br><span class="line">map_variable := <span class="built_in">make</span>(<span class="keyword">map</span>[key_data_type]value_data_type)</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> countryCapitalMap <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span> <span class="comment">/*创建集合 */</span></span><br><span class="line">	countryCapitalMap = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* map插入key - value对,各个国家对应的首都 */</span></span><br><span class="line">	countryCapitalMap [ <span class="string">&quot;France&quot;</span> ] = <span class="string">&quot;Paris&quot;</span></span><br><span class="line">	countryCapitalMap [ <span class="string">&quot;Italy&quot;</span> ] = <span class="string">&quot;罗马&quot;</span></span><br><span class="line">	countryCapitalMap [ <span class="string">&quot;Japan&quot;</span> ] = <span class="string">&quot;东京&quot;</span></span><br><span class="line">	countryCapitalMap [ <span class="string">&quot;India &quot;</span> ] = <span class="string">&quot;新德里&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*使用键输出地图值 */</span> </span><br><span class="line">	<span class="keyword">for</span> country := <span class="keyword">range</span> countryCapitalMap &#123;</span><br><span class="line">		fmt.Println(country, <span class="string">&quot;首都是&quot;</span>, countryCapitalMap [country])</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*查看元素在集合中是否存在 */</span></span><br><span class="line">	captial, ok := countryCapitalMap [ <span class="string">&quot;美国&quot;</span> ] <span class="comment">/*如果确定是真实的,则存在,否则不存在 */</span></span><br><span class="line">	<span class="comment">/*fmt.Println(captial) */</span></span><br><span class="line">	<span class="comment">/*fmt.Println(ok) */</span></span><br><span class="line">	<span class="keyword">if</span> (ok) &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;美国的首都是&quot;</span>, captial)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">&quot;美国的首都不存在&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>delete() 函数用于删除集合的元素, 参数为 map 和其对应的 key。实例如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">/* 创建map */</span></span><br><span class="line">	countryCapitalMap := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;<span class="string">&quot;France&quot;</span>: <span class="string">&quot;Paris&quot;</span>, <span class="string">&quot;Italy&quot;</span>: <span class="string">&quot;Rome&quot;</span>, <span class="string">&quot;Japan&quot;</span>: <span class="string">&quot;Tokyo&quot;</span>, <span class="string">&quot;India&quot;</span>: <span class="string">&quot;New delhi&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">&quot;原始地图&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* 打印地图 */</span></span><br><span class="line">	<span class="keyword">for</span> country := <span class="keyword">range</span> countryCapitalMap &#123;</span><br><span class="line">		fmt.Println(country, <span class="string">&quot;首都是&quot;</span>, countryCapitalMap [ country ])</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*删除元素*/</span> <span class="built_in">delete</span>(countryCapitalMap, <span class="string">&quot;France&quot;</span>)</span><br><span class="line">	fmt.Println(<span class="string">&quot;法国条目被删除&quot;</span>)</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">&quot;删除元素后地图&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*打印地图*/</span></span><br><span class="line">	<span class="keyword">for</span> country := <span class="keyword">range</span> countryCapitalMap &#123;</span><br><span class="line">		fmt.Println(country, <span class="string">&quot;首都是&quot;</span>, countryCapitalMap [ country ])</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="List"><a href="#List" class="headerlink" title="List"></a>List</h2><p>包含于conatiner/list包中。</p>
<p>初始化：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. New方法初始化list</span></span><br><span class="line">变量名 := list.New()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 通过声明初始化list</span></span><br><span class="line"><span class="keyword">var</span> 变量名 list.List</span><br></pre></td></tr></table></figure>

<p>添加元素：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 追加新元素到末尾，返回该元素指针</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">PushBack</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;)</span> *<span class="title">Element</span></span></span><br><span class="line"><span class="comment">// 追加另一个列表到末尾</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">PushBackList</span><span class="params">(other *List)</span></span></span><br><span class="line"><span class="comment">// 添加新元素到开头，返回该元素指针</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">PushFront</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;)</span> *<span class="title">Element</span></span></span><br><span class="line"><span class="comment">// 添加另一个列表到开头</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">PushFrontList</span><span class="params">(other *List)</span></span></span><br><span class="line"><span class="comment">// 在mark后面插入新元素，返回新元素指针</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">InsertAfter</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;, mark *Element)</span> *<span class="title">Element</span></span></span><br><span class="line"><span class="comment">// 在mark前插入新元素，返回新元素指针</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">InsertBefore</span><span class="params">(v <span class="keyword">interface</span>&#123;&#125;, mark *Element)</span> *<span class="title">Element</span></span></span><br></pre></td></tr></table></figure>

<p>移动元素：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 移动e到mark之后</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">MoveAfter</span><span class="params">(e, mark *Element)</span></span></span><br><span class="line"><span class="comment">// 移动e到mark之前</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">MoveBefore</span><span class="params">(e, mark *Element)</span></span></span><br><span class="line"><span class="comment">// 移动e到末尾</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">MoveToBack</span><span class="params">(e *Element)</span></span></span><br><span class="line"><span class="comment">// 移动e到开头</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">MoveToFront</span><span class="params">(e *Element)</span></span></span><br></pre></td></tr></table></figure>

<p>访问元素：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回结尾元素</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">Back</span><span class="params">()</span> *<span class="title">Element</span></span></span><br><span class="line"><span class="comment">// 返回开头元素</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">Front</span><span class="params">()</span> *<span class="title">Element</span></span></span><br></pre></td></tr></table></figure>

<p>遍历列表：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回下一个元素，如果没有下一个元素，返回nil</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Element)</span> <span class="title">Next</span><span class="params">()</span> *<span class="title">Element</span></span></span><br><span class="line"><span class="comment">// 返回前一个元素，如果没有前一个元素，返回nil</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *Element)</span> <span class="title">Prev</span><span class="params">()</span> *<span class="title">Element</span></span></span><br></pre></td></tr></table></figure>

<p>获取列表长度：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span></span><br></pre></td></tr></table></figure>

<p>移除元素：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 移除e，返回e的值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">Remove</span><span class="params">(e *Element)</span> <span class="title">interface</span></span>&#123;&#125;</span><br><span class="line"><span class="comment">// 清空列表</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *List)</span> <span class="title">Init</span><span class="params">()</span> *<span class="title">List</span></span></span><br></pre></td></tr></table></figure>

<h2 id="interface类型"><a href="#interface类型" class="headerlink" title="interface类型"></a>interface类型</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 定义接口 */</span></span><br><span class="line"><span class="keyword">type</span> interface_name <span class="keyword">interface</span> &#123;</span><br><span class="line">	method_name1 [return_type]</span><br><span class="line">	method_name2 [return_type]</span><br><span class="line">	method_name3 [return_type]</span><br><span class="line">	...</span><br><span class="line">	method_namen [return_type]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 定义结构体 */</span></span><br><span class="line"><span class="keyword">type</span> struct_name <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">/* variables */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 实现接口方法 */</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(struct_name_variable struct_name)</span> <span class="title">method_name1</span><span class="params">()</span> [<span class="title">return_type</span>]</span> &#123;</span><br><span class="line">	<span class="comment">/* 方法实现 */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(struct_name_variable struct_name)</span> <span class="title">method_namen</span><span class="params">()</span> [<span class="title">return_type</span>]</span> &#123;</span><br><span class="line">	<span class="comment">/* 方法实现*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Phone <span class="keyword">interface</span> &#123;</span><br><span class="line">	call()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> NokiaPhone <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(nokiaPhone NokiaPhone)</span> <span class="title">call</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;I am Nokia, I can call you!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> IPhone <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(iPhone IPhone)</span> <span class="title">call</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;I am iPhone, I can call you!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> phone Phone</span><br><span class="line"></span><br><span class="line">	phone = <span class="built_in">new</span>(NokiaPhone)</span><br><span class="line">	phone.call()</span><br><span class="line"></span><br><span class="line">	phone = <span class="built_in">new</span>(IPhone)</span><br><span class="line">	phone.call()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Channel类型"><a href="#Channel类型" class="headerlink" title="Channel类型"></a>Channel类型</h2><h3 id="Channel创建"><a href="#Channel创建" class="headerlink" title="Channel创建"></a>Channel创建</h3><p>channel 使用内置的 make 函数创建:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Channel读写"><a href="#Channel读写" class="headerlink" title="Channel读写"></a>Channel读写</h3><p>channel的读写操作(channel 一定要初始化后才能进行读写操作，否则会永久阻塞):</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// write to channel</span></span><br><span class="line">ch &lt;- x</span><br><span class="line"></span><br><span class="line"><span class="comment">// read from channel</span></span><br><span class="line">x &lt;- ch</span><br><span class="line"></span><br><span class="line"><span class="comment">// another way to read</span></span><br><span class="line">x = &lt;- ch</span><br><span class="line"></span><br><span class="line">value, ok := &lt;- ch1</span><br></pre></td></tr></table></figure>

<p>这里的变量ok的值同样是bool类型的。它代表了通道值的状态，true代表通道值有效，而false则代表通道值已无效（或称已关闭）。如果在接收操作进行之前或过程中通道值被关闭了，则接收操作会立即结束并返回一个该通道值的元素类型的零值。</p>
<h3 id="Channel关闭"><a href="#Channel关闭" class="headerlink" title="Channel关闭"></a>Channel关闭</h3><p>golang 提供了内置的 close 函数对 channel 进行关闭操作。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"><span class="built_in">close</span>(ch)</span><br></pre></td></tr></table></figure>

<ul>
<li>关闭一个未初始化(nil) 的 channel 会产生 panic</li>
<li>重复关闭同一个 channel 会产生 panic</li>
<li>向一个已关闭的 channel 中发送消息会产生 panic</li>
<li>从已关闭的 channel 读取消息不会产生 panic，且能读出 channel 中还未被读取的消息，若消息均已读出，则会读到类型的零值。从一个已关闭的 channel 中读取消息永远不会阻塞，并且会返回一个为 false 的 ok-idiom，可以用它来判断 channel 是否关闭</li>
<li>关闭 channel 会产生一个广播机制，所有向 channel 读取消息的 goroutine 都会收到消息</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line">ch &lt;- <span class="number">11</span></span><br><span class="line">ch &lt;- <span class="number">12</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">close</span>(ch)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x := <span class="keyword">range</span> ch &#123;</span><br><span class="line">    fmt.Println(x)	<span class="comment">// 11	12</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">x, ok := &lt;- ch</span><br><span class="line">fmt.Println(x, ok)	<span class="comment">// 0 false</span></span><br></pre></td></tr></table></figure>

<h3 id="无缓存的-channel"><a href="#无缓存的-channel" class="headerlink" title="无缓存的 channel"></a>无缓存的 channel</h3><p>从无缓存的 channel 中读取消息会阻塞，直到有 goroutine 向该 channel 中发送消息；同理，向无缓存的 channel 中发送消息也会阻塞，直到有 goroutine 从 channel 中读取消息。</p>
<p>非缓冲的通道值的初始化方法如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<h3 id="有缓存的-channel"><a href="#有缓存的-channel" class="headerlink" title="有缓存的 channel"></a>有缓存的 channel</h3><p>有缓存的 channel 的声明方式为指定 make 函数的第二个参数，该参数为 channel 缓存的容量</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<p>有缓存的 channel 类似一个阻塞队列(采用环形数组实现)。当缓存未满时，向 channel 中发送消息时不会阻塞，当缓存满时，发送操作将被阻塞，直到有其他 goroutine 从中读取消息；相应的，当 channel 中消息不为空时，读取消息不会出现阻塞，当 channel 为空时，读取操作会造成阻塞，直到有 goroutine 向 channel 中写入消息。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// blocked, read from empty buffered channel</span></span><br><span class="line">&lt;- ch</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">3</span>)</span><br><span class="line">ch &lt;- <span class="number">1</span></span><br><span class="line">ch &lt;- <span class="number">2</span></span><br><span class="line">ch &lt;- <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// blocked, send to full buffered channel</span></span><br><span class="line">ch &lt;- <span class="number">4</span></span><br></pre></td></tr></table></figure>

<p>通过 len 函数可以获得 chan 中的元素个数，通过 cap 函数可以得到 channel 的缓存长度。</p>
<h3 id="双向-单向Channel"><a href="#双向-单向Channel" class="headerlink" title="双向/单向Channel"></a>双向/单向Channel</h3><p>默认情况下，通道都是双向的，即双向通道。如果数据只能在通道中单向传输，那么该通道就被称作单向通道。在编写类型声明的时候可以这样做：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Receiver &lt;-<span class="keyword">chan</span> <span class="keyword">int</span></span><br></pre></td></tr></table></figure>

<p>类型Receiver代表了一个只可从中接收数据的单向通道类型。这样的通道也被称为接收通道。在关键字chan左边的接收操作符&lt;-形象地表示出了数据的流向。相对应的，如果想声明一个发送通道类型，那么应该这样：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Sender <span class="keyword">chan</span>&lt;- <span class="keyword">int</span></span><br></pre></td></tr></table></figure>

<p>可以把一个双向通道值赋予上述类型的变量：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myChannel = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">3</span>)</span><br><span class="line"><span class="keyword">var</span> sender Sender = myChannel</span><br><span class="line"><span class="keyword">var</span> receiver Receiver = myChannel  </span><br><span class="line"></span><br><span class="line"><span class="comment">//但是，反之则是不行的。像下面这样的代码是通不过编译的：</span></span><br><span class="line"><span class="keyword">var</span> myChannel1 <span class="keyword">chan</span> <span class="keyword">int</span> = sender</span><br></pre></td></tr></table></figure>

<p>单向通道的主要作用是约束程序对通道值的使用方式。</p>
<h3 id="channel应用"><a href="#channel应用" class="headerlink" title="channel应用"></a>channel应用</h3><h4 id="广播功能实现"><a href="#广播功能实现" class="headerlink" title="广播功能实现"></a>广播功能实现</h4><p>当一个通道关闭时, 所有对此通道的读取的goroutine都会退出阻塞。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">notify</span><span class="params">(id <span class="keyword">int</span>, channel <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span>&#123;</span><br><span class="line">   &lt;-channel<span class="comment">//接收到数据或通道关闭时退出阻塞</span></span><br><span class="line">   fmt.Printf(<span class="string">&quot;%d receive a message.\n&quot;</span>, id)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">broadcast</span><span class="params">(channel <span class="keyword">chan</span> <span class="keyword">int</span>)</span></span>&#123;</span><br><span class="line">   fmt.Printf(<span class="string">&quot;Broadcast:\n&quot;</span>)</span><br><span class="line">   <span class="built_in">close</span>(channel)<span class="comment">//关闭通道&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">   channel := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>,<span class="number">1</span>)</span><br><span class="line">   <span class="keyword">for</span> i:=<span class="number">0</span>;i&lt;<span class="number">10</span> ;i++  &#123;</span><br><span class="line">      <span class="keyword">go</span> notify(i,channel)</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">go</span> broadcast(channel)</span><br><span class="line">   time.Sleep(time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="select使用"><a href="#select使用" class="headerlink" title="select使用"></a>select使用</h4><p>select用于在多个channel上同时进行侦听并收发消息，当任何一个case满足条件时即执行，如果没有可执行的case则会执行default的case，如果没有指定default case，则会阻塞程序。select的语法如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> communication clause :</span><br><span class="line">   statement(s);</span><br><span class="line"><span class="keyword">case</span> communication clause :</span><br><span class="line">   statement(s);   <span class="comment">/*可以定义任意数量的 case */</span><span class="keyword">default</span> : <span class="comment">/*可选 */</span></span><br><span class="line">   statement(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Select多路复用中：</p>
<ul>
<li>每个case都必须是一次通信</li>
<li>所有channel表达式都会被求值</li>
<li>所有被发送的表达式都会被求值</li>
<li>如果任意某个通信可以进行，它就执行；其它被忽略。</li>
<li>如果有多个case都可以运行，Select会随机公平地选出一个执行。其它不会执行。</li>
<li>否则，如果有default子句，则执行default语句。如果没有default子句，select将阻塞，直到某个通信可以运行；Go不会重新对channel或值进行求值。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> mainimport (</span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;time&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doWork</span><span class="params">(channels *[10]<span class="keyword">chan</span> <span class="keyword">int</span>)</span></span>&#123;</span><br><span class="line">     <span class="keyword">for</span> &#123;</span><br><span class="line">       <span class="keyword">select</span> &#123;</span><br><span class="line">       <span class="keyword">case</span> x1 := &lt;-channels[<span class="number">0</span>]:</span><br><span class="line">         fmt.Println(<span class="string">&quot;receive x1: &quot;</span>,x1)</span><br><span class="line">       <span class="keyword">case</span> x2 := &lt;-channels[<span class="number">1</span>]:</span><br><span class="line">         fmt.Println(<span class="string">&quot;receive x2: &quot;</span>,x2)</span><br><span class="line">       <span class="keyword">case</span> x3 := &lt;-channels[<span class="number">2</span>]:</span><br><span class="line">         fmt.Println(<span class="string">&quot;receive x3: &quot;</span>,x3)</span><br><span class="line">       <span class="keyword">case</span> x4 := &lt;-channels[<span class="number">3</span>]:</span><br><span class="line">         fmt.Println(<span class="string">&quot;receive x4: &quot;</span>,x4)</span><br><span class="line">       <span class="keyword">case</span> x5 := &lt;-channels[<span class="number">4</span>]:</span><br><span class="line">         fmt.Println(<span class="string">&quot;receive x5: &quot;</span>,x5)</span><br><span class="line">       <span class="keyword">case</span> x6 := &lt;-channels[<span class="number">5</span>]:</span><br><span class="line">         fmt.Println(<span class="string">&quot;receive x6: &quot;</span>,x6)</span><br><span class="line">       <span class="keyword">case</span> x7 := &lt;-channels[<span class="number">6</span>]:</span><br><span class="line">         fmt.Println(<span class="string">&quot;receive x7: &quot;</span>,x7)</span><br><span class="line">       <span class="keyword">case</span> x8 := &lt;-channels[<span class="number">7</span>]:</span><br><span class="line">         fmt.Println(<span class="string">&quot;receive x8: &quot;</span>,x8)</span><br><span class="line">       <span class="keyword">case</span> x9 := &lt;-channels[<span class="number">8</span>]:</span><br><span class="line">         fmt.Println(<span class="string">&quot;receive x9: &quot;</span>,x9)</span><br><span class="line">       <span class="keyword">case</span> x10 := &lt;-channels[<span class="number">9</span>]:</span><br><span class="line">         fmt.Println(<span class="string">&quot;receive x10: &quot;</span>,x10)</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">   <span class="keyword">var</span> channels [<span class="number">10</span>]<span class="keyword">chan</span> <span class="keyword">int</span></span><br><span class="line">   <span class="keyword">go</span> doWork(&amp;channels)</span><br><span class="line">   <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">      channels[i] = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>,<span class="number">1</span>)</span><br><span class="line">      channels[i]&lt;- i</span><br><span class="line">   &#125;</span><br><span class="line">   time.Sleep(time.Second*<span class="number">5</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 结果如下：</span></span><br><span class="line">receive x4:  <span class="number">3</span></span><br><span class="line">receive x10:  <span class="number">9</span></span><br><span class="line">receive x9:  <span class="number">8</span></span><br><span class="line">receive x5:  <span class="number">4</span></span><br><span class="line">receive x2:  <span class="number">1</span></span><br><span class="line">receive x7:  <span class="number">6</span></span><br><span class="line">receive x8:  <span class="number">7</span></span><br><span class="line">receive x1:  <span class="number">0</span></span><br><span class="line">receive x3:  <span class="number">2</span></span><br><span class="line">receive x6:  <span class="number">5</span></span><br></pre></td></tr></table></figure>

<h2 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type_name(expression)</span><br></pre></td></tr></table></figure>

<h1 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h1><h2 id="error"><a href="#error" class="headerlink" title="error"></a>error</h2><p>Go 语言通过内置的错误接口提供了非常简单的错误处理机制。error类型是一个接口类型，这是它的定义：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> error <span class="keyword">interface</span> &#123;</span><br><span class="line">	Error() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> errors</span><br><span class="line"></span><br><span class="line"><span class="comment">// New returns an error that formats as the given text.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">(text <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;errorString&#123;text&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// errorString is a trivial implementation of error.</span></span><br><span class="line"><span class="keyword">type</span> errorString <span class="keyword">struct</span> &#123;</span><br><span class="line">	s <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(e *errorString)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> e.s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以在编码中通过实现 error 接口类型来生成错误信息。函数通常在最后的返回值中返回错误信息。使用errors.New 可返回一个错误信息：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Sqrt</span><span class="params">(f <span class="keyword">float64</span>)</span> <span class="params">(<span class="keyword">float64</span>, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> f &lt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">&quot;math: square root of negative number&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 实现</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	result, err:= Sqrt(<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>自定义：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 定义一个 DivideError 结构</span></span><br><span class="line"><span class="keyword">type</span> DivideError <span class="keyword">struct</span> &#123;</span><br><span class="line">    dividee <span class="keyword">int</span></span><br><span class="line">    divider <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 实现 `error` 接口</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(de *DivideError)</span> <span class="title">Error</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line">    strFormat := <span class="string">`</span></span><br><span class="line"><span class="string">		Cannot proceed, the divider is zero.</span></span><br><span class="line"><span class="string">		dividee: %d</span></span><br><span class="line"><span class="string">		divider: 0</span></span><br><span class="line"><span class="string">	`</span></span><br><span class="line">    <span class="keyword">return</span> fmt.Sprintf(strFormat, de.dividee)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义 `int` 类型除法运算的函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Divide</span><span class="params">(varDividee <span class="keyword">int</span>, varDivider <span class="keyword">int</span>)</span> <span class="params">(result <span class="keyword">int</span>, errorMsg <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> varDivider == <span class="number">0</span> &#123;</span><br><span class="line">        dData := DivideError&#123;</span><br><span class="line">            dividee: varDividee,</span><br><span class="line">            divider: varDivider,</span><br><span class="line">        &#125;</span><br><span class="line">        errorMsg = dData.Error()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> varDividee / varDivider, <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 正常情况</span></span><br><span class="line">    <span class="keyword">if</span> result, errorMsg := Divide(<span class="number">100</span>, <span class="number">10</span>); errorMsg == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;100/10 = &quot;</span>, result)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 当被除数为零的时候会返回错误信息</span></span><br><span class="line">    <span class="keyword">if</span> _, errorMsg := Divide(<span class="number">100</span>, <span class="number">0</span>); errorMsg != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;errorMsg is: &quot;</span>, errorMsg)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="panic"><a href="#panic" class="headerlink" title="panic"></a>panic</h2><p>panic可被意译为运行时恐慌,因为它只有在程序运行的时候才会被“抛出来”,并且，恐慌是会被扩散的,当有运行时恐慌发生时，它会被迅速地向调用栈的上层传递。如果不显式地处理它的话，程序的运行瞬间就会被终止——程序崩溃。内建函数panic可以让我们人为地产生一个运行时恐慌,不过，这种致命错误是可以被恢复的,在Go语言中，内建函数recover就可以做到这一点。</p>
<p>实际上，内建函数panic和recover是天生的一对,前者用于产生运行时恐慌，而后者用于“恢复”它。不过要注意，recover函数必须要在defer语句中调用才有效,因为一旦有运行时恐慌发生，当前函数以及在调用栈上的所有代码都是失去对流程的控制权,只有defer语句携带的函数中的代码才可能在运行时恐慌迅速向调用栈上层蔓延时“拦截到”它。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> p := <span class="built_in">recover</span>(); p != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;Fatal error: %s\n&quot;</span>, p)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>

<p>recover()函数会返回一个interface{}类型的值,如果不为nil，那么就说明当前确有运行时恐慌发生,这时我们需根据情况做相应处理。注意，一旦defer语句中的recover函数调用被执行了，运行时恐慌就会被恢复，不论是否进行了后续处理, 所以，我们一定不要只“拦截”不处理。</p>
<p>panic函数可接受一个interface{}类型的值作为其参数，也就是说，可以在调用panic函数的时候可以传入任何类型的值，不过，建议在这里只传入error类型的值,这样它表达的语义才是精确的,更重要的是，当我们调用recover函数来“恢复”由于调用panic函数而引发的运行时恐慌的时候，得到的值正是调用后者时传给它的那个参数,因此，有这样一个约定是很有必要的。</p>
<h1 id="面向对象编程"><a href="#面向对象编程" class="headerlink" title="面向对象编程"></a>面向对象编程</h1><p>在Golang的对象可以用一句话总结：“面向对象就是将要处理的数据跟函数进行绑定的方法”。</p>
<h2 id="封装"><a href="#封装" class="headerlink" title="封装"></a>封装</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Foo <span class="keyword">struct</span> &#123;</span><br><span class="line">	baz <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类似于成员函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *Foo)</span> <span class="title">echo</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(f.baz)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	f := Foo&#123;baz: <span class="string">&quot;hello&quot;</span>&#125;</span><br><span class="line">	f.echo()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Foo <span class="keyword">struct</span> &#123;</span><br><span class="line">	baz <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Bar <span class="keyword">struct</span> &#123;</span><br><span class="line">	Foo</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *Foo)</span> <span class="title">echo</span><span class="params">()</span></span> &#123;</span><br><span class="line">	fmt.Println(f.baz)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	b := Bar&#123;Foo&#123;baz: <span class="string">&quot;hello&quot;</span>&#125;&#125;</span><br><span class="line">	b.echo()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Foo <span class="keyword">interface</span> &#123;</span><br><span class="line">	test()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Bar <span class="keyword">struct</span> &#123;&#125;</span><br><span class="line"><span class="keyword">type</span> Baz <span class="keyword">struct</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b Bar)</span> <span class="title">test</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b Baz)</span> <span class="title">test</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> f Foo</span><br><span class="line">	f = Bar&#123;&#125;</span><br><span class="line">	f = Baz&#123;&#125;</span><br><span class="line">	fmt.Println(f)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/obj</span></span><br><span class="line"><span class="comment">// 在其他包引用时，需要把要被引用的标志首字母大写</span></span><br><span class="line"><span class="keyword">package</span> obj</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">interface</span> &#123;</span><br><span class="line">	Buy(value <span class="keyword">int</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">	Name  <span class="keyword">string</span></span><br><span class="line">	Money <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(user *User)</span> <span class="title">Buy</span><span class="params">(value <span class="keyword">int</span>)</span></span>  &#123;</span><br><span class="line">	user.Money -= value</span><br><span class="line">	fmt.Printf(<span class="string">&quot;%s Buy a thing of %d, rest %d\n&quot;</span>, user.Name, value, user.Money)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Worker <span class="keyword">struct</span> &#123;</span><br><span class="line">	User</span><br><span class="line">	IdW <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Student <span class="keyword">struct</span> &#123;</span><br><span class="line">	IdS <span class="keyword">string</span></span><br><span class="line">	User</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	user := obj.Worker&#123;User: obj.User&#123;Name: <span class="string">&quot;hearing&quot;</span>, Money:<span class="number">21</span>&#125;, IdW: <span class="string">&quot;001&quot;</span>&#125;</span><br><span class="line">	user.Buy(<span class="number">10</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Go并发编程"><a href="#Go并发编程" class="headerlink" title="Go并发编程"></a>Go并发编程</h1><h2 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h2><ul>
<li>并行(parallel)：指在同一时刻，有多条指令在多个处理器上同时执行。</li>
<li>并发(concurrency)：指在同一时刻只能有一条指令执行，但多个进程指令被快速的轮换执行，使得在宏观上具有多个进程同时执行的效果，但在微观上并不是同时执行的，只是把时间分成若干段，使多个进程快速交替的执行。</li>
</ul>
<h2 id="Coroutine-协程"><a href="#Coroutine-协程" class="headerlink" title="Coroutine(协程)"></a>Coroutine(协程)</h2><p>Coroutine（协程）是一种用户态的轻量级线程，特点如下：</p>
<ol>
<li>轻量级线程</li>
<li>非抢占式多任务处理，由协程主动交出控制权。</li>
<li>编译器/解释器/虚拟机层面的任务</li>
<li>多个协程可能在一个或多个线程上运行。</li>
<li>子程序是协程的一个特例。</li>
</ol>
<p>不同语言对协程的支持：</p>
<ol>
<li>C++通过Boost.Coroutine实现对协程的支持</li>
<li>Java不支持</li>
<li>Python通过yield关键字实现协程，Python3.5开始使用async def对原生协程的支持</li>
</ol>
<h2 id="Goroutine"><a href="#Goroutine" class="headerlink" title="Goroutine"></a>Goroutine</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>goroutine说到底其实就是线程，但是它比线程更小，十几个goroutine可能体现在底层就是五六个线程，Go语言内部帮你实现了这些goroutine之间的内存共享。执行goroutine只需极少的栈内存(大概是4~5KB)，当然会根据相应的数据伸缩。</p>
<p>在Go语言中，只需要在函数调用前加上关键字go即可创建一个并发任务单元，新建的任务会被放入队列中，等待调度器安排。进程在启动的时候，会创建一个主线程，主线程结束时，程序进程将终止，因此，进程至少有一个线程。main函数里，必须让主线程等待，确保进程不会被终止。go语言中并发指的是让某个函数独立于其它函数运行的能力，一个goroutine是一个独立的工作单元，Go的runtime（运行时）会在逻辑处理器上调度goroutine来运行，一个逻辑处理器绑定一个操作系统线程，因此goroutine不是线程，是一个协程。</p>
<ul>
<li>进程：一个程序对应一个独立程序空间</li>
<li>线程：一个执行空间，一个进程可以有多个线程</li>
<li>逻辑处理器：执行创建的goroutine，绑定一个线程</li>
<li>调度器：Go运行时中的，分配goroutine给不同的逻辑处理器</li>
<li>全局运行队列：所有刚创建的goroutine队列</li>
<li>本地运行队列：逻辑处理器的goroutine队列</li>
</ul>
<p>当创建一个goroutine后，会先存放在全局运行队列中，等待Go运行时的调度器进行调度，把goroutine分配给其中的一个逻辑处理器，并放到逻辑处理器对应的本地运行队列中，最终等着被逻辑处理器执行即可。</p>
<p>Go的并发是管理、调度、执行goroutine的方式。默认情况下，Go默认会给每个可用的物理处理器都分配一个逻辑处理器。可以在程序开头使用<code>runtime.GOMAXPROCS(n)</code>设置逻辑处理器的数量。<br>如果需要设置逻辑处理器的数量，一般采用如下代码设置：<code>runtime.GOMAXPROCS(runtime.NumCPU())</code>。对于并发，Go语言本身自己实现的调度，对于并行，与物理处理器的核数有关，多核就可以并行并发，单核只能并发。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">	wg.Add(<span class="number">2</span>)</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> wg.Done()</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;Hello,Go.This is %d\n&quot;</span>, i)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">defer</span> wg.Done()</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;Hello,World.This is %d\n&quot;</span>, i)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">	wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>sync.WaitGroup使用非常简单，使用Add方法设设置计数器为2，每一个goroutine的函数执行完后，调用Done方法减1。Wait方法表示如果计数器大于0，就会阻塞，main函数会一直等待2个goroutine完成再结束。</p>
<h3 id="调度机制"><a href="#调度机制" class="headerlink" title="调度机制"></a>调度机制</h3><img src="Goroutine.png"/>

<p>为了实现M：N线程调度机制，Go引入了3个结构体：</p>
<ul>
<li>M：操作系统的内核空间线程</li>
<li>G：goroutine对象，G结构体包含调度一个goroutine所需要的堆栈和instruction pointer（IP指令指针），以及其它一些重要的调度信息。每次go调用的时候，都创建一个G对象。</li>
<li>P：Processor，调度的上下文，实现M：N调度模型的关键，M必须拿到P才能对G进行调度，P限定了go调度goroutine的最大并发度。每一个运行的M都必须绑定一个P。</li>
</ul>
<p>P的个数是GOMAXPROCS（最大256），启动时固定，一般不修改； M的个数和P的个数不一定相同（会有休眠的M或者不需要太多的M）；每一个P保存着本地G任务队列，也能使用全局G任务队列。</p>
<h3 id="runtime包"><a href="#runtime包" class="headerlink" title="runtime包"></a>runtime包</h3><ul>
<li>runtime.Gosched()用于让出CPU时间片，让出当前goroutine的执行权限，调度器安排其它等待的任务运行，并在下次某个时候从该位置恢复执行。</li>
<li>调用runtime.Goexit()将立即终止当前goroutine执⾏，调度器确保所有已注册defer延迟调用被执行。</li>
<li>调用runtime.GOMAXPROCS()用来设置可以并行计算的CPU核数的最大值，并返回设置前的值。</li>
</ul>
<h3 id="死锁"><a href="#死锁" class="headerlink" title="死锁"></a>死锁</h3><p>Go程序中死锁是指所有的goroutine在等待资源的释放,Goroutine死锁产生的原因如下：</p>
<ul>
<li>只在单一的goroutine里操作无缓冲信道，一定死锁</li>
<li>非缓冲信道上如果发生流入无流出，或者流出无流入，会导致死锁</li>
</ul>
<p>因此，解决死锁的方法有：</p>
<ul>
<li>取走无缓冲通道的数据或是发送数据到无缓冲通道</li>
<li>使用缓冲通道</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/20/%E5%8E%9F%E5%88%9B%E5%AE%8B%E8%AF%8D-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/20/%E5%8E%9F%E5%88%9B%E5%AE%8B%E8%AF%8D-3/" class="post-title-link" itemprop="url">原创宋词-3</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-11-20 16:09:59" itemprop="dateCreated datePublished" datetime="2018-11-20T16:09:59+08:00">2018-11-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%96%87%E5%AD%97/" itemprop="url" rel="index"><span itemprop="name">文字</span></a>
                </span>
            </span>

          
            <span id="/2018/11/20/%E5%8E%9F%E5%88%9B%E5%AE%8B%E8%AF%8D-3/" class="post-meta-item leancloud_visitors" data-flag-title="原创宋词-3" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2018/11/20/%E5%8E%9F%E5%88%9B%E5%AE%8B%E8%AF%8D-3/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018/11/20/%E5%8E%9F%E5%88%9B%E5%AE%8B%E8%AF%8D-3/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="定风波·湖村晚"><a href="#定风波·湖村晚" class="headerlink" title="定风波·湖村晚"></a><center>定风波·湖村晚</center></h2><p><font color="#111196"><center>苍耳</center></font></p>
<center>&nbsp;&nbsp;湖面蒹葭荡影重，黄昏渐映水寒清。远处人家芦絮乱，亲唤，小童归去老村惊。&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;候鸟返巢双戏景，微冷，农家冬至夜燃灯。灯影幢幢人影瘦，浊酒，菜花香入梦回轻。</center>

<hr>
<h2 id="忆王孙·何事"><a href="#忆王孙·何事" class="headerlink" title="忆王孙·何事"></a><center>忆王孙·何事</center></h2><p><font color="#111196"><center>苍耳</center></font></p>
<center>风吹雨落夜眠惊，半醒难分睡意轻。<br>梦入江南画柳情。<br>呓呢声，侧卧窗帘闲点灯。</center>

<hr>
<h2 id="忆王孙·洛书记"><a href="#忆王孙·洛书记" class="headerlink" title="忆王孙·洛书记"></a><center>忆王孙·洛书记</center></h2><p><font color="#111196"><center>苍耳</center></font></p>
<center>墨花纸染化龙飞，门掩窗寒瑟瑟吹。<br>今日闲情久假回。笔轻挥，平仄无声春似归。</center>

<hr>
<h2 id="青玉案·初八天"><a href="#青玉案·初八天" class="headerlink" title="青玉案·初八天"></a><center>青玉案·初八天</center></h2><p><font color="#111196"><center>苍耳</center></font></p>
<center>空山雾隐闻声去。犬出没、人来处。寒意不消听落雨。楼台风闹，绿拂三五。未见春些许。<br>夜来明灭灯如诉。酒过三巡醒梁祝。辗转难眠人不宿。贪嗔爱恨，七情六欲。梦里花开故。</center>

<hr>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/20/%E5%8E%9F%E5%88%9B%E5%AE%8B%E8%AF%8D-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/20/%E5%8E%9F%E5%88%9B%E5%AE%8B%E8%AF%8D-2/" class="post-title-link" itemprop="url">原创宋词-2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2018-11-20 16:05:06" itemprop="dateCreated datePublished" datetime="2018-11-20T16:05:06+08:00">2018-11-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%96%87%E5%AD%97/" itemprop="url" rel="index"><span itemprop="name">文字</span></a>
                </span>
            </span>

          
            <span id="/2018/11/20/%E5%8E%9F%E5%88%9B%E5%AE%8B%E8%AF%8D-2/" class="post-meta-item leancloud_visitors" data-flag-title="原创宋词-2" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2018/11/20/%E5%8E%9F%E5%88%9B%E5%AE%8B%E8%AF%8D-2/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2018/11/20/%E5%8E%9F%E5%88%9B%E5%AE%8B%E8%AF%8D-2/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="浣溪沙·凡草"><a href="#浣溪沙·凡草" class="headerlink" title="浣溪沙·凡草"></a><center>浣溪沙·凡草</center></h2><p><font color="#111196"><center>苍耳</center></font></p>
<center>媚影妖娆咏作仙，千般颜色惹人怜。一朝散尽满枝闲。<br>最是平常孤草晃，青青风里荡花间。春泥一化百芳翩。</center>

<hr>
<h2 id="青玉案·秋书"><a href="#青玉案·秋书" class="headerlink" title="青玉案·秋书"></a><center>青玉案·秋书</center></h2><p><font color="#111196"><center>苍耳</center></font></p>
<center>&nbsp;&nbsp;林间阡陌行清秋。道凉意，风如哭。梢末黄鹂轻唤舞。却身反顾，碧空云天，尽是千金缕。&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;梧桐也似金黄雨，银杏终将叶颜枯。昨岁不堪风落处。如此这般，盈盈笑语，只是秋书苦。</center>

<hr>
<h2 id="潇湘梦-如仙"><a href="#潇湘梦-如仙" class="headerlink" title="潇湘梦-如仙"></a><center>潇湘梦-如仙</center></h2><p><font color="#111196"><center>苍耳</center></font></p>
<center>风如烟，卿画颜。<br>小楼帘下舞蹁跹。<br>浊酒几杯还故里，<br>青丝如梦九天仙。</center>

<hr>
<h2 id="点绛唇-冬醉"><a href="#点绛唇-冬醉" class="headerlink" title="点绛唇-冬醉"></a><center>点绛唇-冬醉</center></h2><p><font color="#111196"><center>苍耳</center></font><br><font color="#11AF96"><center>2018/11/20</center></font></p>
<center>雨霁天回，庭前思是春疏影。梧桐满径，凉却知冬盛。<br>念道寻禅，难揣天书命。趁酒兴，醉饮小令，一曲南山梦。</center>

<hr>
<h2 id="忆王孙·九月随想"><a href="#忆王孙·九月随想" class="headerlink" title="忆王孙·九月随想"></a><center>忆王孙·九月随想</center></h2><p><font color="#111196"><center>苍耳</center></font></p>
<center>秋风吹散雨携情，九月萧萧孤叶清。<br>半掩楼台午梦惊。<br>呓呢声，侧卧窗帘闲点灯。</center>

<hr>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/12/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><span class="page-number current">13</span><a class="page-number" href="/page/14/">14</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" href="/page/14/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="苍耳叔叔"
      src="/images/head.png">
  <p class="site-author-name" itemprop="name">苍耳叔叔</p>
  <div class="site-description" itemprop="description">梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">161</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">100</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ljd1996" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ljd1996" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hearing1996@gmail.com" title="E-Mail → mailto:hearing1996@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">苍耳叔叔</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : true,
      notify     : true,
      appId      : 'pCnIlzs46HJGpubm7D3TnrBC-gzGzoHsz',
      appKey     : '7LzW4wBI9lY5DtVFNkFWcjs0',
      placeholder: "欢迎评论交流！",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
