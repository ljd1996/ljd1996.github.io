<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ljd1996.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
<meta property="og:type" content="website">
<meta property="og:title" content="苍耳的博客">
<meta property="og:url" content="https://ljd1996.github.io/page/13/index.html">
<meta property="og:site_name" content="苍耳的博客">
<meta property="og:description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="苍耳叔叔">
<meta property="article:tag" content="诗歌，宋词，后台，Android，Java">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://ljd1996.github.io/page/13/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>苍耳的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">苍耳的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">细水长流</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ljd1996.github.io/2019/03/12/Git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/12/Git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Git学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-12 10:51:16" itemprop="dateCreated datePublished" datetime="2019-03-12T10:51:16+08:00">2019-03-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-07-09 15:41:15" itemprop="dateModified" datetime="2021-07-09T15:41:15+08:00">2021-07-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
                </span>
            </span>

          
            <span id="/2019/03/12/Git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="Git学习笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/03/12/Git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/03/12/Git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p><strong>仓库</strong></p>
<p>存放代码的目录，分为本地仓库和远程仓库，本地和远程可以通过 git remote add 建立关联。</p>
<p>本地仓库有三大分区：</p>
<ul>
<li>工作区 (Working Directory): 是我们编辑代码的地方</li>
<li>暂存区 (Stage or Index): 数据暂时存放的区域，可以在工作区和版本库之间进行数据的交流</li>
<li>版本库 (Commit History): 存放已经提交的数据，push 的时候就是把这个区域的数据推送到远程仓库</li>
</ul>
<p><strong>分支</strong></p>
<p>git 中的分支本质上是一个指向某个 commit 的指针。</p>
<p><strong>文件的生命周期</strong></p>
<p>对于 git 仓库里的每一个文件（除了 .git 目录和被 .gitignore 忽略的文件），有如下几种状态：</p>
<ul>
<li>Untracked 未跟踪</li>
<li>Unmodified 未修改</li>
<li>Modified 已修改</li>
<li>Staged 暂存区</li>
</ul>
<img src="git文件生命周期.jpg"/>

<h1 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">git init # 在当前目录下初始化一个本地 git 仓库</span><br><span class="line">git status # 检查当前文件状态</span><br><span class="line">git diff # 比较工作区和暂存区</span><br><span class="line">git diff HEAD # 比较工作区和版本库</span><br><span class="line">git diff --cached # 比较暂存区和版本库</span><br><span class="line">git add &lt;filename&gt; # 将 &lt;filename&gt; 添加到暂存区</span><br><span class="line">git add -A # 将所有文件添加到暂存区</span><br><span class="line">git add . # 将当前目录下的所有文件添加到暂存区</span><br><span class="line">git commit # 提交更改（将暂存区的文件提交到 Commit History）</span><br><span class="line">git commit --amend # 修改 commit 信息</span><br><span class="line">git push origin &lt;branch&gt; # 将本地分支推送到远程仓库</span><br><span class="line">git pull origin &lt;branch&gt; # 将远程仓库的分支拉取到本地</span><br><span class="line">git clone &lt;repository&gt; [&lt;directory&gt;] # 克隆远程分支到本地，repository 可以由 schema 为 http[s], ssh, git, ftp[s], file 等各种 uri 表示，也可以是 scp 风格的路径表示。directory 表示克隆下来的仓库目录名</span><br><span class="line">git config [--global|--local] user.name &quot;&lt;username&gt;&quot; # 设置用户名，用户名会出现在 commit 信息里，加了--local参数只影响当前仓库的配置，加--global参数会影响本机上所有仓库的配置，默认是--local</span><br><span class="line">git config [--global|--local] user.email &quot;&lt;email&gt;&quot; # 设置用户邮箱，邮箱会出现在 commit 信息里</span><br><span class="line">git remote add origin &lt;repository&gt; # 添加一个远程分支，命名为 origin</span><br><span class="line">git log [--oneline] # 查看 commit 信息</span><br><span class="line">git log --oneline --graph # 查看 commit 节点树</span><br></pre></td></tr></table></figure>

<h1 id="高级操作"><a href="#高级操作" class="headerlink" title="高级操作"></a>高级操作</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">git branch # 查看本地分支</span><br><span class="line">git branch -a # 查看所有分支，包括远程分支</span><br><span class="line">git branch &lt;name&gt; # 创建一个和当前分支版本库一样的分支</span><br><span class="line">git checkout &lt;branch&gt; # 切换分支</span><br><span class="line">git checkout -b &lt;branch&gt; &lt;start_point&gt; # 创建一个新分支并切换，新分支的 HEAD 指针指向 start_point, start_point 可以是本地分支或远程分支的任意一个 commit</span><br><span class="line">git reset --soft &lt;commit&gt; # 将版本库的 HEAD 指向 commit</span><br><span class="line">git reset --mixed &lt;commit&gt; # 将版本库和暂存区的 HEAD 指向 commit</span><br><span class="line">git reset --hard &lt;commit&gt; # 将版本库、暂存区和工作区的 HEAD 指向 commit，但不会影响未跟踪的文件</span><br><span class="line">git rebase &lt;branch&gt; # 把当前分支变基到 branch 上</span><br><span class="line">git stash # 将暂存区中的文件储藏起来</span><br><span class="line">git stash apply # 恢复储藏的文件到暂存区</span><br><span class="line">git revert &lt;commit&gt; # 撤销之前的某一个 commit</span><br></pre></td></tr></table></figure>

<p>如下实例中，蓝色是版本库，绿色是暂存区，红色是工作区：</p>
<img src="reset1.png"/>

<p>git reset有三个选项：</p>
<ul>
<li>soft就是只动repo</li>
<li>mixed就是动repo还有staging(这个是默认参数)</li>
<li>hard就是动repo还有staging还有working</li>
</ul>
<ol>
<li><p>soft：只修改版本库repo</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --soft &lt;B commit&gt;</span><br></pre></td></tr></table></figure>

 <img src="reset2.png"/>
</li>
<li><p>mixed：修改版本库和暂存区</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --mixed &lt;B commit&gt;</span><br></pre></td></tr></table></figure>

 <img src="reset3.png"/>
</li>
<li><p>hard：修改版本库、暂存区和工作区</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard &lt;B commit&gt;</span><br></pre></td></tr></table></figure>

 <img src="reset4.png"/>

</li>
</ol>
<h1 id="冲突解决"><a href="#冲突解决" class="headerlink" title="冲突解决"></a>冲突解决</h1><p>当发生冲突的时候，冲突的文件中会出现以下格式的内容。</p>
<p>解决冲突的时候，可以选择保留当前修改，保留另一个分支的修改，或是两个都不保留，重新编辑。</p>
<p>解决冲突的时候既要解决文本冲突，也要注意逻辑冲突。当冲突解决完成后，应该将当前文件加入暂存区，并执行对应命令加上 –continue 参数。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</span><br><span class="line">            modification belongs to current branch</span><br><span class="line">=======</span><br><span class="line">            modification belongs to other branch</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt;&gt;&gt;&gt;&gt; commit 38a1cab...</span></span><br></pre></td></tr></table></figure>

<h1 id="gitignore"><a href="#gitignore" class="headerlink" title=".gitignore"></a>.gitignore</h1><p>文件 .gitignore 的格式规范如下：</p>
<ul>
<li>所有空行或者以 ＃ 开头的行都会被 Git 忽略。</li>
<li>可以使用标准的 glob 模式匹配。</li>
<li>匹配模式可以以（/）开头防止递归。</li>
<li>匹配模式可以以（/）结尾指定目录。</li>
<li>要忽略指定模式以外的文件或目录，可以在模式前加上惊叹号（!）取反。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> no .a files</span></span><br><span class="line">*.a</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> but <span class="keyword">do</span> track lib.a, even though you<span class="string">&#x27;re ignoring .a files above</span></span></span><br><span class="line">!lib.a</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> only ignore the TODO file <span class="keyword">in</span> the current directory, not subdir/TODO</span></span><br><span class="line">/TODO</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ignore all files <span class="keyword">in</span> the build/ directory</span></span><br><span class="line">build/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ignore doc/notes.txt, but not doc/server/arch.txt</span></span><br><span class="line">doc/*.txt</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ignore all .pdf files <span class="keyword">in</span> the doc/ directory</span></span><br><span class="line">doc/**/*.pdf</span><br></pre></td></tr></table></figure>

<h1 id="Merge-amp-Rebase"><a href="#Merge-amp-Rebase" class="headerlink" title="Merge &amp; Rebase"></a>Merge &amp; Rebase</h1><ul>
<li>Merge: 合并两个分支</li>
<li>Rebase: 改变分支的 base commit</li>
</ul>
<p>这两种操作都可以合并分支，rebase 的优势在于可以使 commit history 的线性程度更高。线性程度高的好处在于，浏览历史的时候更整洁，不容易碰到分叉，分叉部分的代码差异可能更大。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git merge &lt;branch&gt; # 把 branch 合并到当前分支</span><br><span class="line">git rebase &lt;commit&gt; # 把当前分支 rebase 到 commit 上</span><br></pre></td></tr></table></figure>

<p>rebase黄金准则: 永远不要 rebase 到一个共享的分支，只能 rebase 自己使用的私有分支。</p>
<p>假设我们有如下图一所示仓库，该仓库有master和develop两个分支，且develop是在（3.added merge.txt file）commit处从master拉出来的分支。 </p>
<img src="rebase1.png"/>

<p><strong>merge</strong></p>
<p>假设现在HEAD在（6.added hello.txt file）处，也就是在master分支最近的一次提交处，此时执行git merge develop, 结果如下图所示。 </p>
<img src="rebase2.png"/>

<p>工作原理就是：git 会自动根据两个分支的共同祖先即 (3.added merge.txt file)这个 commit 和两个分支的最新提交即 (6.added hello.txt file) 和 (5.added test.txt file) 进行一个三方合并，然后将合并中修改的内容生成一个新的 commit，即图二的(7.Merge branch ‘develop’)。<br>这是merge的效果，简单来说就合并两个分支并生成一个新的提交。</p>
<p><strong>rebase</strong></p>
<p>假设初始状态也是图一所显示的。两个分支一个master，一个develop，此时HEAD在（6.added hello.txt file）处，现在执行git rebase develop,结果如下图三所示。 </p>
<img src="rebase3.png"/>

<p>在执行git rebase develop之前，HEAD在（6.added hello.txt file）处，当执行rebase操作时，git 会从两个分支的共同祖先 (3.added merge.txt file)开始提取 当前分支（此时是master分支）上的修改，即 （6.added hello.txt file）这个commit，再将 master 分支指向 目标分支的最新提交（此时是develop分支）即（5.added test.txt file） 处，然后将刚刚提取的修改应用到这个最新提交后面。如果提取的修改有多个，那git将依次应用到最新的提交后面，如下两图所示，图四为初始状态，图五为执行rebase后的状态。 </p>
<img src="rebase4.png"/>

<img src="rebase5.png"/>

<p>初始状态如下图六所示,和之前一样的是，develop分支也是在 (3.added merge.txt file)处从master分支拉取develop分支。不一样的是两个分支各个commit的时间不同，之前develop分支的4和5commit在master分支3之后6之前，现在是develop分支的4提交早于master分支的5提交，develop分支的6提交晚于master的5提交早于master的7提交。 </p>
<img src="rebase6.png"/>

<p>在上图情况下，在master分支的7commit处，执行git merge develop，结果如下图七所示：</p>
<img src="rebase7.png"/>

<p>执行git rebase develop，结果如下图八所示：</p>
<img src="rebase8.png"/>

<ol>
<li>可以看出merge结果能够体现出时间线，但是rebase会打乱时间线。 </li>
<li>而rebase看起来简洁，但是merge看起来不太简洁。 </li>
<li>最终结果是都把代码合起来了，所以具体怎么使用这两个命令看项目需要。</li>
</ol>
<p>还有一点说明的是，在项目中经常使用git pull来拉取代码，git pull相当于是git fetch + git merge，如果此时运行git pull -r，也就是git pull –rebase，相当于git fetch + git rebase</p>
<h1 id="撤销rebase"><a href="#撤销rebase" class="headerlink" title="撤销rebase"></a>撤销rebase</h1><p>当我们在本地的develop分支开发完成后，commit修改的内容，然后将origin/develop分支rebase到本地的develop分支，准备push代码的时候发现origin/develop分支的内容有问题，需要回退本地分支到rebase之前的状态（也可以撤销rebase其他本地分支的操作），首先执行命令：<code>git reflog</code>。输出如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git reflog</span></span><br><span class="line">eec33cda (HEAD -&gt; develop) HEAD@&#123;0&#125;: rebase finished: returning to refs/heads/develop</span><br><span class="line">eec33cda (HEAD -&gt; develop) HEAD@&#123;1&#125;: rebase: commit test</span><br><span class="line">bf335175 (origin/develop) HEAD@&#123;2&#125;: rebase: checkout origin/develop</span><br><span class="line">af69383a HEAD@&#123;3&#125;: commit: commit test</span><br></pre></td></tr></table></figure>

<p>解释一下上述输出：</p>
<ul>
<li>HEAD@{3}：提交本次内容</li>
<li>HEAD@{2}：开始rebase，首先checkout到origin/develop分支</li>
<li>HEAD@{1}：将origin/develop分支上的变动rebase到本地develop分支</li>
<li>HEAD@{0}：rebase结束</li>
</ul>
<p>如果要撤销本地rebase操作，只需要执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard HEAD@&#123;3&#125;</span><br></pre></td></tr></table></figure>

<p>即可成功撤销rebase操作，回退到之前commit的状态。</p>
<h1 id="detached-HEAD"><a href="#detached-HEAD" class="headerlink" title="detached HEAD"></a>detached HEAD</h1><p>首先看看下面这种常规的commit情况：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">        HEAD (refers to branch &#x27;master&#x27;)</span><br><span class="line">        |</span><br><span class="line">        v</span><br><span class="line">a---b---c branch &#x27;master&#x27; (refers to commit &#x27;c&#x27;)</span><br><span class="line">    ^</span><br><span class="line">    |</span><br><span class="line">    tag &#x27;v2.0&#x27; (refers to commit &#x27;b&#x27;)</span><br></pre></td></tr></table></figure>

<p>此时再执行下述操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> edit; git add; git commit</span></span><br><span class="line"></span><br><span class="line">            HEAD (refers to branch &#x27;master&#x27;)</span><br><span class="line">            |</span><br><span class="line">            v</span><br><span class="line">a---b---c---d branch &#x27;master&#x27; (refers to commit &#x27;d&#x27;)</span><br><span class="line">    ^</span><br><span class="line">    |</span><br><span class="line">    tag &#x27;v2.0&#x27; (refers to commit &#x27;b&#x27;)</span><br></pre></td></tr></table></figure>

<p>运行命令<code>git checkout master</code>后会checkout到master的最新commit上，接下来运行下述命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git checkout v2.0  <span class="comment"># 或 git checkout master^^</span></span></span><br><span class="line"></span><br><span class="line">    HEAD (refers to commit &#x27;b&#x27;)</span><br><span class="line">    |</span><br><span class="line">    v</span><br><span class="line">a---b---c---d branch &#x27;master&#x27; (refers to commit &#x27;d&#x27;)</span><br><span class="line">    ^</span><br><span class="line">    |</span><br><span class="line">    tag &#x27;v2.0&#x27; (refers to commit &#x27;b&#x27;)</span><br></pre></td></tr></table></figure>

<p>现在head已经指向commit b，这就是所谓的dedatched head状态。从这里可以看出，head是当前index的状态，而不是当前分支（的最近commit节点）。这仅仅意味着head指向某个特定的commit点，而不是指向每一个特定的分支（的顶端节点）。如果我们此时提交一个commit：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> edit; git add; git commit</span></span><br><span class="line"></span><br><span class="line">    HEAD (refers to commit &#x27;e&#x27;)</span><br><span class="line">    |</span><br><span class="line">    v</span><br><span class="line">    e</span><br><span class="line">    |</span><br><span class="line">    |</span><br><span class="line">a---b---c---d branch &#x27;master&#x27; (refers to commit &#x27;d&#x27;)</span><br><span class="line">    ^</span><br><span class="line">    |</span><br><span class="line">    tag &#x27;v2.0&#x27; (refers to commit &#x27;b&#x27;)</span><br></pre></td></tr></table></figure>

<p>注意，此时产生了一个新的提交点，但是它只能被head索引到，不属于任何一个分支。当然，我们还可以给在这个“无名分支”的基础上继续提交。实际上，我们可以进行任何git的常规操作。但是，当我们运行<code>git checkout master</code>后：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git checkout master</span></span><br><span class="line"></span><br><span class="line">            HEAD (refers to branch &#x27;master&#x27;)</span><br><span class="line">    e       |</span><br><span class="line">    |       |</span><br><span class="line">    |       v</span><br><span class="line">a---b---c---d branch &#x27;master&#x27; (refers to commit &#x27;d&#x27;)</span><br><span class="line">    ^</span><br><span class="line">    |</span><br><span class="line">    tag &#x27;v2.0&#x27; (refers to commit &#x27;b&#x27;)</span><br></pre></td></tr></table></figure>

<p>此时，<code>commit e</code>已经处于无法被索引到的状态。最终e将被git的默认回收机制所回收，除非在它们被回收之前创建一个指向它们的索引。如果我们没有从<code>commit e</code>离开的话，可以这样创建一个指向e的索引：        </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git checkout -b develop  <span class="comment"># 创建一个develop分支，指向e，接着更新head指向分支develop，此时不再处在detached head的状态</span></span></span><br></pre></td></tr></table></figure>

<h1 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h1><p><strong>概述</strong></p>
<p>如果一个软件有了新版本，我们可以完整地下载新版本的代码进行编译安装。然而，像Linux Kernel这样的大型项目，代码即使压缩，也超过70MB，每次全新下载是有相当大的代价的。然而，每次更新变动的代码可能不超过1MB，因此，我们只要能够有两个版本代码的diff的数据，应该就可以以极低的代价更新程序了。</p>
<p>git提供了两种简单的patch方案。一是用git diff生成的标准patch，二是git format-patch生成的Git专用Patch。</p>
<p><strong>git diff生成的标准patch</strong></p>
<ul>
<li>最初在master(或别的分支上)</li>
<li>新建分支修改bug： git checkout -b fix</li>
<li>在fix分支上，提交修改内容： git commit -m “fix a bug”</li>
<li>与master分支对比产生patch: git diff &gt; patch</li>
<li>使用git apply命令，在一条干净的分支上应用patch: git checkout master —&gt; git checkout -b PATCH — &gt; git apply –check patch —–&gt; (补丁patch可以加入的话) git apply patch —&gt; git commit -m “apply patch”</li>
<li>切换到master上合并PATCH分支：git checkout master —-&gt; git merge PATCH</li>
</ul>
<p>注意：无论多少个文件、多少次commit的diff，都只会产生一个patch。</p>
<p><strong>git format-patch生成的git专用补丁</strong></p>
<ul>
<li>最初在master(或别的分支上)</li>
<li>新建分支修改bug： git checkout -b fix</li>
<li>在fix分支上，提交修改内容： git commit -m “fix a bug”</li>
<li>将此次commit后的fix分支内容与master对比，根据commit msg生成一个patch: git format-patch -M master —-&gt;生成0001-fix-a-bug.patch</li>
<li>使用git am命令，在一条干净的分支上应用patch: git checkout master —&gt; git checkout -b PATCH —&gt; git am 0001-fix-a-bug.patch —&gt; git commit -m “apply patch”</li>
<li>切换到master上合并PATCH分支：git checkout master —-&gt; git merge PATCH</li>
</ul>
<p>注意：每次commit，都只会产生对应的一个patch。</p>
<ul>
<li>git am时出错：<code>.git/rebase-apply still exists but mbox given</code><br>  <code>git am –abort</code>（该命令将git的状态恢复到之前状态就可以继续提交patch了）</li>
<li>打补丁<br>  <code>patch -p1 &lt; my.patch</code></li>
<li>取消补丁<br>  <code>patch -R -p1 &lt; my.patch</code></li>
</ul>
<p><strong>创建patch 文件的常用命令行</strong></p>
<ul>
<li>某次提交（含）之前的几次提交：<code>git format-patch 【commit sha1 id】-n</code><br>  n指从sha1 id对应的commit开始算起n个提交。<br>  eg：<code>git format-patch  2a2fb4539925bfa4a141fe492d9828d030f7c8a8 -2</code></li>
<li>某个提交的patch：<code>git format-patch 【commit sha1 id】 -1</code><br>  eg：<code>git format-patch  2a2fb4539925bfa4a141fe492d9828d030f7c8a8 -1</code></li>
<li>某两次提交之间的所有patch:<code>git format-patch 【commit sha1 id】..【commit sha1 id】</code><br>  eg：<code>git format-patch  2a2fb4539925bfa4a141fe492d9828d030f7c8a8..89aebfcc73bdac8054be1a242598610d8ed5f3c8</code></li>
</ul>
<p><strong>创建diff文件的常用方法</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git diff  【commit sha1 id】 【commit sha1 id】 &gt;  【diff文件名】</span><br><span class="line"><span class="meta">#</span><span class="bash"> eg：</span></span><br><span class="line">git diff  2a2fb4539925bfa4a141fe492d9828d030f7c8a8  89aebfcc73bdac8054be1a242598610d8ed5f3c8 &gt; patch.diff</span><br></pre></td></tr></table></figure>

<p><strong>两种patch的比较</strong></p>
<ul>
<li>兼容性：很明显，git diff生成的Patch兼容性强。如果你在修改的代码的官方版本库不是Git管理的版本库，那么你必须使用git diff生成的patch才能让你的代码被项目的维护人接受。</li>
<li>除错功能：对于git diff生成的patch，你可以用git apply –check 查看补丁是否能够干净顺利地应用到当前分支中；如果git format-patch 生成的补丁不能打到当前分支，git am会给出提示，并协助你完成打补丁工作，你也可以使用git am -3进行三方合并。从这一点上看，两者除错功能都很强。</li>
<li>版本库信息：由于git format-patch生成的补丁中含有这个补丁开发者的名字，因此在应用补丁时，这个名字会被记录进版本库，显然，这样做是恰当的。因此，目前使用Git的开源社区往往建议使用format-patch生成补丁。</li>
</ul>
<h1 id="submodule"><a href="#submodule" class="headerlink" title="submodule"></a>submodule</h1><ul>
<li>添加：<code>git submodule add repo_address path</code>，path可省略</li>
<li>更新：<code>git submodule update</code></li>
<li>初始化/更新：<code>git submodule update --init --recursive</code></li>
<li>删除：首先，要在<code>.gitmodules</code>文件中删除相应配置信息。然后，执行<code>git rm –cached</code>命令将子模块所在的文件从git中删除</li>
<li>clone带有submodule的项目：<code>git clone --recurse-submodules address</code></li>
</ul>
<h1 id="Git-LFS"><a href="#Git-LFS" class="headerlink" title="Git LFS"></a>Git LFS</h1><p>Git 在 clone 过程中会将仓库的整个历史记录传输到客户端，对于包涵大文件（尤其是经常被修改的大文件）的项目，初始克隆需要大量时间，因为客户端会下载每个文件的每个版本。</p>
<p>Git LFS(Large File Storage) 是 Git 的一个扩展，用于实现 Git 对大文件的支持。它通过延迟下载大文件的相关版本来减少大文件在仓库中的影响，大文件是在 checkout 过程中下载的，而不在 clone 或 fetch 过程中下载, Git LFS 通过将仓库中的大文件替换为小指针文件来做到这一点。使用时用户不会注意到这些指针文件，因为它们是由 Git LFS 自动处理的：</p>
<ol>
<li>当 add 一个文件到仓库时，Git LFS 用一个指针替换其内容，并将文件内容存储在本地 Git LFS 缓存中(缓存位于 <code>.git/lfs/objects</code> 目录中)。</li>
<li>当 push 新的提交到服务器时，新提交引用的所有 Git LFS 文件都会从本地 Git LFS 缓存传输到绑定到 Git 仓库的远程 Git LFS 存储(即 lfs 文件内容会直接从本地 Git LFS 缓存传输到远程 Git LFS 存储服务器)。</li>
<li>当 checkout 一个包含 Git LFS 指针的提交时，指针文件将替换为本地 Git LFS 缓存中的文件，或者从远端 Git LFS 存储区下载。</li>
</ol>
<p>git clone 和 git pull 将明显更快，因为只下载实际 checkout 的提交所引用的大文件版本，而不是曾经存在过的文件的每一个版本。使用 Git LFS 需要一个支持 Git LFS 的托管服务器如 <a target="_blank" rel="noopener" href="https://bitbucket.org/">Bitbucket Cloud</a> 或 <a target="_blank" rel="noopener" href="https://www.atlassian.com/software/bitbucket/enterprise/data-center">Bitbucket Server</a>, 另外 GitHub 和 GitLab 也都支持 Git LFS。</p>
<p><strong>一些用法</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装 git-lfs</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> brew install git-lfs</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 初始化 Git LFS, 只需运行一次，后面当 <span class="built_in">clone</span> 包含 Git LFS 内容的仓库时，Git LFS 将自动启用</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git lfs install</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个新的 Git LFS 仓库</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git init</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git lfs install</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git lfs track ... <span class="comment"># 指定要跟踪的文件</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用 git <span class="built_in">clone</span> 命令来克隆 Git LFS 仓库，当克隆包含大量 lfs 文件的仓库时显式使用 git lfs <span class="built_in">clone</span> 命令性能更好</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> git lfs <span class="built_in">clone</span> 命令不会一次下载一个 Git LFS 文件，而是等到 checkout 完成后再批量下载所有必需的 lfs 文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 利用并行下载的优势，并显著减少了产生的 HTTP 请求和进程的数量</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git lfs <span class="built_in">clone</span> git@xxx.git</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用常规的 git pull 命令拉取 Git LFS 仓库，拉取完成后需要的 Git LFS 文件都会作为自动检出过程的一部分而被下载</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果检出因为意外原因而失败则可通过 git lfs pull 命令来下载当前所有丢失的 Gi t 内容</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git lfs pull</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用 git lfs track 命令指定一个模式告诉 Git LFS 对其进行跟踪</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行 git lfs track 后会在仓库中发现名为 .gitattributes 的新文件，Git LFS 自动创建或更新 .gitattributes 文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> gitattributes 是一种 Git 机制，用于将特殊行为绑定到某些文件模式</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git lfs track <span class="string">&quot;*.ogg&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以通过调用不带参数的 git lfs track 命令来显示 Git LFS 当前正在跟踪的所有模式的列表及 .gitattributes 文件</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git lfs track</span></span><br><span class="line">Listing tracked patterns</span><br><span class="line">    *.ogg (.gitattributes)</span><br><span class="line">    *.a (lib/.gitattributes)</span><br><span class="line">Listing excluded patterns</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以从 .gitattributes 文件中删除相应的行或者运行 git lfs untrack 命令来停止使用 Git LFS 跟踪特定模式</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git lfs untrack <span class="string">&quot;*.ogg&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以按常规方式 push 到包含 Git LFS 内容的仓库，如果传输 LFS 文件失败，推送将被终止，可以放心地重试</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git push</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用 git lfs prune 命令从本地 Git LFS 缓存中删除文件，这将删除所有被认为是旧的本地 Git LFS 文件</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用 git lfs prune --dry-run 来测试修剪操作将产生什么效果</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用 git lfs prune --verbose --dry-run 命令精确查看哪些 Git LFS 对象将被修剪</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用 --verify-remote 选项在删除之前，检查远程 Git LFS 存储区是否具有你的 Git LFS 对象的副本，更安全</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以通过全局配置 lfs.pruneverifyremotealways 属性为系统永久启用 --verify-remote 选项</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git lfs prune</span></span><br><span class="line">✔ 4 local objects, 33 retained</span><br><span class="line">Pruning 4 files, (2.1 MB)</span><br><span class="line">✔ Deleted 4 files</span><br><span class="line"><span class="meta">$</span><span class="bash"> git config --global lfs.pruneverifyremotealways <span class="literal">true</span></span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ljd1996.github.io/2019/03/04/EOS%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/04/EOS%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" class="post-title-link" itemprop="url">EOS源码解读</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-04 15:11:27" itemprop="dateCreated datePublished" datetime="2019-03-04T15:11:27+08:00">2019-03-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/" itemprop="url" rel="index"><span itemprop="name">区块链</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/EOS/" itemprop="url" rel="index"><span itemprop="name">EOS</span></a>
                </span>
            </span>

          
            <span id="/2019/03/04/EOS%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" class="post-meta-item leancloud_visitors" data-flag-title="EOS源码解读" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/03/04/EOS%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/03/04/EOS%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h1><img src="eos_block_structure.png"/>

<h2 id="Block"><a href="#Block" class="headerlink" title="Block"></a>Block</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /eos/libraries/chain/include/eosio/chain/block.hpp</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">signed_block</span> :</span> <span class="keyword">public</span> signed_block_header &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	signed_block( <span class="keyword">const</span> signed_block&amp; ) = <span class="keyword">default</span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	signed_block() = <span class="keyword">default</span>;</span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">signed_block</span><span class="params">( <span class="keyword">const</span> signed_block_header&amp; h )</span>:<span class="title">signed_block_header</span><span class="params">(h)</span></span>&#123;&#125;</span><br><span class="line">	signed_block( signed_block&amp;&amp; ) = <span class="keyword">default</span>;</span><br><span class="line">	signed_block&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> signed_block&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">	<span class="function">signed_block <span class="title">clone</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> *<span class="keyword">this</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">vector</span>&lt;transaction_receipt&gt;   transactions; <span class="comment">/// new or generated transactions</span></span><br><span class="line">	extensions_type               block_extensions;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// /eos/libraries/chain/include/eosio/chain/types.hpp</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">pair</span>&lt;<span class="keyword">uint16_t</span>,<span class="built_in">vector</span>&lt;<span class="keyword">char</span>&gt;&gt;&gt; extensions_type;</span><br></pre></td></tr></table></figure>

<p>signed_block结构体是从signed_block_header继承而来的，这个signed_block_header结构体只是包含了一条数据，那就是producer的签名。signed_block_header结构体又是从block_header继承而来的，这个结构体就包含了一个block中很多重要的数据，包括时间戳，producer的名字，所有交易的merkle root，所有action的root等信息。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /eos/libraries/chain/include/eosio/chain/block_header.hpp</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">block_header</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	 block_timestamp_type             timestamp;</span><br><span class="line">	 account_name                     producer;</span><br><span class="line">	 <span class="keyword">uint16_t</span>                         confirmed = <span class="number">1</span>;  </span><br><span class="line"></span><br><span class="line">	 block_id_type                    previous;</span><br><span class="line"></span><br><span class="line">	 checksum256_type                 transaction_mroot;</span><br><span class="line">	 checksum256_type                 action_mroot;</span><br><span class="line"></span><br><span class="line">	 <span class="keyword">uint32_t</span>                          schedule_version = <span class="number">0</span>;</span><br><span class="line">	 optional&lt;producer_schedule_type&gt;  new_producers;</span><br><span class="line">	 extensions_type                   header_extensions;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">signed_block_header</span> :</span> <span class="keyword">public</span> block_header</span><br><span class="line">&#123;</span><br><span class="line">	 signature_type    producer_signature;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Transaction"><a href="#Transaction" class="headerlink" title="Transaction"></a>Transaction</h2><p>signed_block中定义了transaction_receipt类型的vector，表示区块是由按顺序组织的交易来构成的集合。block_extensions则定义了一系列的扩展信息，这些信息都由一个整数类型的code来定义，需要的时候，都可以根据这个整数code来解析相应的信息。下面看看transaction_receipt的定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /eos/libraries/chain/include/eosio/chain/block.hpp</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">transaction_receipt_header</span> &#123;</span></span><br><span class="line">   <span class="keyword">enum</span> status_enum &#123;</span><br><span class="line">      executed  = <span class="number">0</span>, <span class="comment">///&lt; succeed, no error handler executed</span></span><br><span class="line">      soft_fail = <span class="number">1</span>, <span class="comment">///&lt; objectively failed (not executed), error handler executed</span></span><br><span class="line">      hard_fail = <span class="number">2</span>, <span class="comment">///&lt; objectively failed and error handler objectively failed thus no state change</span></span><br><span class="line">      delayed   = <span class="number">3</span>, <span class="comment">///&lt; transaction delayed/deferred/scheduled for future execution</span></span><br><span class="line">      expired   = <span class="number">4</span>  <span class="comment">///&lt; transaction expired and storage space refuned to user</span></span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   transaction_receipt_header():status(hard_fail)&#123;&#125;</span><br><span class="line">   <span class="function"><span class="keyword">explicit</span> <span class="title">transaction_receipt_header</span><span class="params">( status_enum s )</span>:<span class="title">status</span><span class="params">(s)</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">friend</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="keyword">operator</span> ==( <span class="keyword">const</span> transaction_receipt_header&amp; lhs, <span class="keyword">const</span> transaction_receipt_header&amp; rhs ) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">std</span>::tie(lhs.status, lhs.cpu_usage_us, lhs.net_usage_words) == <span class="built_in">std</span>::tie(rhs.status, rhs.cpu_usage_us, rhs.net_usage_words);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   fc::enum_type&lt;<span class="keyword">uint8_t</span>,status_enum&gt;   status;</span><br><span class="line">   <span class="keyword">uint32_t</span>                             cpu_usage_us = <span class="number">0</span>; <span class="comment">///&lt; total billed CPU usage (microseconds)</span></span><br><span class="line">   fc::unsigned_int                     net_usage_words; <span class="comment">///&lt;  total billed NET usage, so we can reconstruct resource state when skipping context free data... hard failures...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">transaction_receipt</span> :</span> <span class="keyword">public</span> transaction_receipt_header &#123;</span><br><span class="line"></span><br><span class="line">   transaction_receipt():transaction_receipt_header()&#123;&#125;</span><br><span class="line">   explicit transaction_receipt( const transaction_id_type&amp; tid ):transaction_receipt_header(executed),trx(tid)&#123;&#125;</span><br><span class="line">   explicit transaction_receipt( const packed_transaction&amp; ptrx ):transaction_receipt_header(executed),trx(ptrx)&#123;&#125;</span><br><span class="line"></span><br><span class="line">   fc::static_variant&lt;transaction_id_type, packed_transaction&gt; trx;</span><br><span class="line"></span><br><span class="line">   <span class="function">digest_type <span class="title">digest</span><span class="params">()</span><span class="keyword">const</span> </span>&#123;</span><br><span class="line">      digest_type::encoder enc;</span><br><span class="line">      fc::raw::pack( enc, status );</span><br><span class="line">      fc::raw::pack( enc, cpu_usage_us );</span><br><span class="line">      fc::raw::pack( enc, net_usage_words );</span><br><span class="line">      <span class="keyword">if</span>( trx.contains&lt;transaction_id_type&gt;() )</span><br><span class="line">         fc::raw::pack( enc, trx.get&lt;transaction_id_type&gt;() );</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">         fc::raw::pack( enc, trx.get&lt;packed_transaction&gt;().packed_digest() );</span><br><span class="line">      <span class="keyword">return</span> enc.result();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// /eos/libraries/chain/include/eosio/chain/types.hpp</span></span><br><span class="line"><span class="keyword">using</span> checksum_type       = fc::sha256;</span><br><span class="line"><span class="keyword">using</span> transaction_id_type = checksum_type;</span><br><span class="line"></span><br><span class="line"><span class="comment">// /eos/libraries/chain/include/eosio/chain/transaction.hpp</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packed_transaction</span> &#123;</span></span><br><span class="line">   <span class="comment">// 定义打包数据是否压缩的枚举类型</span></span><br><span class="line">   <span class="keyword">enum</span> compression_type &#123;</span><br><span class="line">      <span class="comment">// 没有压缩</span></span><br><span class="line">      none = <span class="number">0</span>,</span><br><span class="line">      <span class="comment">// 使用zlib压缩</span></span><br><span class="line">      zlib = <span class="number">1</span>,</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 签名信息</span></span><br><span class="line">   <span class="built_in">vector</span>&lt;signature_type&gt;                  signatures;</span><br><span class="line">   <span class="comment">// 是否压缩的标识信息</span></span><br><span class="line">   fc::enum_type&lt;<span class="keyword">uint8_t</span>,compression_type&gt; compression;</span><br><span class="line">   <span class="comment">// 上下文无关的信息</span></span><br><span class="line">   bytes                                   packed_context_free_data;</span><br><span class="line">   <span class="comment">// 打包后的交易数据</span></span><br><span class="line">   bytes                                   packed_trx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>transaction_receipt_header主要是记录了这个交易的状态信息，以及CPU和网络的使用情况。当一笔交易被某个区块引用时，区块生产者针对这笔交易会做出相应的操作，而操作的不同结果会导致这笔交易的不同状态.而transaction_receipt结构体主要包含了一个打包过的交易以及其对应的交易类型。</p>
<p>packed_transaction中打包的数据来自于signed_transaction结构体，这个结构体的主要作用就是对交易做签名。signed_transaction又是从transaction结构体继承而来，一个transaction结构体的实例包含一系列的action，这些action要么全部成功，要么全部失败。</p>
<p>交易ID是通过对交易内容本身经过Hash运算得出，所以每个交易的ID是与其内容一一对应的。交易的主体是由操作构成的。一个交易在纳入区块之前必须含有签名，用以验证交易的合法性。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /eos/libraries/chain/include/eosio/chain/transaction.hpp</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">signed_transaction</span> :</span> <span class="keyword">public</span> transaction</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 签名信息</span></span><br><span class="line">	 <span class="built_in">vector</span>&lt;signature_type&gt;    signatures;</span><br><span class="line">	 <span class="comment">// 上下文无关的数据</span></span><br><span class="line">	 <span class="built_in">vector</span>&lt;bytes&gt;             context_free_data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">transaction</span> :</span> <span class="keyword">public</span> transaction_header &#123;</span><br><span class="line">	 <span class="comment">// 上下文无关的action</span></span><br><span class="line">	 <span class="built_in">vector</span>&lt;action&gt;         context_free_actions;</span><br><span class="line">	 <span class="comment">// 交易操作</span></span><br><span class="line">	 <span class="built_in">vector</span>&lt;action&gt;         actions;</span><br><span class="line">	 <span class="comment">// 交易扩展类型</span></span><br><span class="line">	 extensions_type        transaction_extensions;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// /eos/libraries/chain/include/eosio/chain/transaction.hpp</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">transaction_header</span> &#123;</span></span><br><span class="line">	 <span class="comment">// 这个交易的过期时间</span></span><br><span class="line">	 time_point_sec         expiration;</span><br><span class="line">	 <span class="comment">// 在最后的2^16 blocks中指定一个具体的block number</span></span><br><span class="line">	 <span class="keyword">uint16_t</span>               ref_block_num       = <span class="number">0U</span>;</span><br><span class="line">	 <span class="comment">// 在指定的get_ref_blocknum的blockid中取低位的32bit</span></span><br><span class="line">	 <span class="keyword">uint32_t</span>               ref_block_prefix    = <span class="number">0U</span>L;</span><br><span class="line">	 <span class="comment">// 最大的网络带块</span></span><br><span class="line">	 fc::unsigned_int       max_net_usage_words = <span class="number">0U</span>L;</span><br><span class="line">	 <span class="comment">// 最大的CPU使用</span></span><br><span class="line">	 <span class="keyword">uint8_t</span>                max_cpu_usage_ms    = <span class="number">0</span>;</span><br><span class="line">	 <span class="comment">// 这个交易的延期时间</span></span><br><span class="line">	 fc::unsigned_int       delay_sec           = <span class="number">0U</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>交易分为两种类型：一种是账户发起的普通交易，一种是由代码生成的自动交易，自动交易可以设置一个延迟时间，这样的交易叫延迟型交易，这种交易不会立即被执行，而是等到设定时间到时才会被执行。</p>
<p>transaction_header结构体包含了与每一个交易相关联的固定大小的数据，这些数据从具体的交易数据中分离出来，可以在需要的时候，帮助解析交易数据，而不再需要更多的动态内存分配。</p>
<p>所有的交易都有一个期限，这个期限限定了一个交易必须在规定时间内被纳入区块链，如果我们发现一个交易的时限已经过去，就可以放心的放弃这个交易，因为所有生产者都不会将它纳入任何区块。</p>
<h2 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /eos/contracts/eosiolib/action.hpp</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">action</span> &#123;</span></span><br><span class="line">   <span class="comment">// 账户：操作的来源</span></span><br><span class="line">   account_name               account;</span><br><span class="line">   <span class="comment">// 名称：操作的标识</span></span><br><span class="line">   action_name                name;</span><br><span class="line">   <span class="comment">// 授权：执行操作的许可列表</span></span><br><span class="line">   <span class="built_in">vector</span>&lt;permission_level&gt;   authorization;</span><br><span class="line">   <span class="comment">// 数据：执行操作需要用到的信息</span></span><br><span class="line">   bytes                      data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EOS区块链中的交易是由一个个action组成的，操作可以理解成一个能够更改区块链全局状态的方法，操作的顺序是确定的，一个交易内的操作要么全部执行成功，要么都不执行，这与交易的本意是一致的。操作是区块链的最底层逻辑，相当于区块链这个大脑的神经元，区块链的智能最终也是通过一个个操作的组合来实现的。</p>
<p>操作的设计原则：</p>
<ul>
<li>独立原则 操作本身须包含足以解释操作含义的信息，而不需要依赖区块链提供的上下文信息来帮助解释。所以，即便一个操作的当前状态可以通过区块链上的数据推导得出，我们也需要将状态信息纳入操作数据中，以便每个操作是容易理解的。这个原则体现的是区块的可解释性，这一点非常重要，这个底层的设计原则将影响整个区块链的使用效率</li>
<li>余额可计算原则 一个账户当前的余额计算，仅仅依赖于与这个账户相关的信息便可得出，而不需要解析整个区块链才能获得。这个原则针对的是比特币的设计，由于比特币的余额计算需要扫描区块链中的所有交易才能精准的计算出一个账户的余额，这使得一个非常基础的计算落地起来都变得相当繁琐，EOS的这个设计目的在于提升运算效率。</li>
<li>明确费用原则 区块链的交易费用随时间变化而变化，所以，一个签名过的交易须明确的认同这个交易所需要支付的费用，这个费用是在交易形成之前就已经设定并且明确好了的，这一点也非常重要，因为明确的费用协议才能保证余额的正确计算。</li>
<li>明确授权原则 每个操作须包含足够的授权信息以标明是哪一个账户拥有授权这个操作的权力，这种明确授权的设计思路带来几个好处：</li>
<li>便于集中管理</li>
<li>可以优化授权管理</li>
<li>便于并行处理</li>
<li>关联账户原则 每个操作须包含足够的关联账户信息，以保证这个操作能够遍历所有相关联的账户，也就是这个操作能够影响的所有账户，这个原则的目的同样是为了确保账户的余额能够得到及时和准确的运算</li>
</ul>
<p>操作的来源：</p>
<ul>
<li>由一个账号产生，通过签名来授权，即显性方式。</li>
<li>由代码生成，即隐形方式。</li>
</ul>
<h2 id="区块日志"><a href="#区块日志" class="headerlink" title="区块日志"></a>区块日志</h2><p>区块日志是存储区块的二进制文件，区块日志的特性是只能从末尾追加(append only)，区块日志包含两类文件：</p>
<p>区块文件，结构如下：</p>
<p>+———+—————-+———+—————-+—–+————+——————-+</p>
<p>| Block 1 | Pos of Block 1 | Block 2 | Pos of Block 2 | … | Head Block | Pos of Head Block |</p>
<p>+———+—————-+———+—————-+—–+————+——————-+</p>
<p>区块文件包含区块的内容以及每个区块的位置信息。区块位置信息是固定的8字节宽度，这样便于在连续读取区块的时候，按照读一个区块，向后跳跃8个字节，读一个区块，向后跳跃8个字节的模式快速加载区块内容。</p>
<p>索引文件，结构如下：</p>
<p>+—————-+—————-+—–+——————-+</p>
<p>| Pos of Block 1 | Pos of Block 2 | … | Pos of Head Block |</p>
<p>+—————-+—————-+—–+——————-+</p>
<p>区块索引的目的在于提供一个基于区块序号的快速随机搜索方法，使用索引文件可以快速定位目标区块在区块文件中的具体位置。索引文件不是必须的，没有索引文件区块链仍然可以运行，索引文件的主要作用是通过少量空间换取速度提升。索引文件可以通过顺序读取区块文件来重新构建。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ljd1996.github.io/2019/02/27/EOS%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/27/EOS%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">EOS学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-27 16:30:52" itemprop="dateCreated datePublished" datetime="2019-02-27T16:30:52+08:00">2019-02-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/" itemprop="url" rel="index"><span itemprop="name">区块链</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/EOS/" itemprop="url" rel="index"><span itemprop="name">EOS</span></a>
                </span>
            </span>

          
            <span id="/2019/02/27/EOS%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="EOS学习笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/02/27/EOS%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/02/27/EOS%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>EOS: Enterprise Operation System 中文意思为：商业级区块链操作系统。EOS 项目的目标是建立可以承载商业级智能合约与应用的区块链基础设施，成为区块链世界的“底层操作系统”。</p>
<p>EOS通过石墨烯技术解决延迟和数据吞吐量问题，TPS可达到数千，交易的确认时间也只有数秒。同时声称未来使用并行链的方式，最高可以达到数百万TPS。此外，在 EOS 上转账交易及运行智能合约不需要消耗 EOS代币。而是EOS 系统当中，抵押代币获取对应的资源，来执行相应交易，在EOS运行程序完全免费的说是不准确的。</p>
<p>EOS底层使用的是石墨烯技术，石墨烯是一个开源的区块链底层库，采用的是 DPOS（Delegated Proof-of-Stake 股份授权证明机制 ）的共识机制。DPOS为了提高出块速度TPS，限制了参与记账了人数，在DPOS中，记账者不称为矿工，而是改称为见证人Witness，现在EOS中，又有一个新词：Block Producer，简称BP，翻译为超级节点。</p>
<p>DPOS下节点需要参与见证人选举，只有赢得选举的节点才能负责出块，在EOS中，赢得选举的21个节点见证人轮流出块。另外还有100个备用见证人（候选节点），在21个见证人出现问题后做替补。EOS的发行总量是10亿，见证人在完成打包交易区块后，可以领取到区块的奖励，区块的奖励来自对发行量的通胀增发，通胀率每年接近5%。</p>
<h1 id="钱包和账户"><a href="#钱包和账户" class="headerlink" title="钱包和账户"></a>钱包和账户</h1><h2 id="钱包"><a href="#钱包" class="headerlink" title="钱包"></a>钱包</h2><p>EOS钱包功能官方上定义很单一，仅仅存私钥公钥，提供私钥公钥生成和导入，其他的功能由EOS账户统一管理，比如代币查询、交易、合约功能都属于账户关联下的功能。</p>
<h2 id="账户"><a href="#账户" class="headerlink" title="账户"></a>账户</h2><p>EOS账号由一串自定义字符组成，与以太坊中不同。账户名下有EOS系统的代币和用户调用eosio.token合约创建的代币、合约和公钥等</p>
<h2 id="钱包和账户关系"><a href="#钱包和账户关系" class="headerlink" title="钱包和账户关系"></a>钱包和账户关系</h2><p>EOS里面的key是公私钥对成对出现的，key和password不是同一个概念，虽然看起来都是一串很长的字符，但是password是针对钱包wallet的，而key则是针对账户account的。</p>
<p>假如创建了钱包hearing，不等于已经在链上有了hearing这个账户，实际上wallet和account两者之间完全是没有关系的，只有当你将account的key放在wallet里的时候，它们两者之间才有了联系。EOS账户创建需要关联钱包公钥，账户创建可以使用同一个钱包公钥创建多个账户，但各个账户是独立的。可以理解成使用同一个密码创建了不同的账户，账户数据相互独立。</p>
<p>每一个account都会有两组公私钥对，对应该账户的两个角色——owner和active。所以我们每次创建账户的时候，都需要给新账户导入两个key进去。官方推荐用户平时使用 Active 私钥，把Owner 私钥离线保存。只有重大安全问题时需要用到 Owner 私钥。</p>
<h2 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h2><p>-p</p>
<h1 id="创建钱包和账户"><a href="#创建钱包和账户" class="headerlink" title="创建钱包和账户"></a>创建钱包和账户</h1><ol>
<li><p>开启keosd</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> keosd &amp;</span></span><br></pre></td></tr></table></figure>

 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> pkill keosd</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>开启nodeos</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nodeos -e -p eosio \</span></span><br><span class="line">--plugin eosio::producer_plugin \</span><br><span class="line">--plugin eosio::chain_api_plugin \</span><br><span class="line">--plugin eosio::http_plugin \</span><br><span class="line">--plugin eosio::history_plugin \</span><br><span class="line">--plugin eosio::history_api_plugin \</span><br><span class="line">--access-control-allow-origin=&#x27;*&#x27; \</span><br><span class="line">--contracts-console \</span><br><span class="line">--http-validate-host=false \</span><br><span class="line">--verbose-http-errors \</span><br><span class="line">--filter-on=&#x27;*&#x27; &gt;&gt; nodeos.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
</li>
<li><p>钱包操作</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet list   <span class="comment"># 查看钱包</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet create --to-console/--file -n hearing    <span class="comment"># 创建钱包，生成私钥，-n指定钱包名，默认名为default</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet open   <span class="comment"># 打开钱包</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet unlock   <span class="comment"># 解锁钱包，需要提供钱包私钥</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet create_key <span class="comment"># 在钱包中创建私钥</span></span></span><br><span class="line">Created new private key with a public key of: &quot;EOS7qyuXyBtqMYLYBveB3APTiWeyu1d6Z4mTLX1mMP5ZU3kWUqXcJ&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet keys   <span class="comment"># 查看钱包的keys</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>导入开发者Key</p>
<p> 每个新的EOSIO链都有一个名为“eosio”的默认“系统”账户。此帐户用于通过加载系统合同来设置链，该合同规定了EOSIO链的治理和共识。每个新的EOSIO链都带有一个开发密钥，这个密钥是相同的(5KQwrPbwdL6PhXujxW37FSSQZ1JiwsST4cqQzDeyXtP79zkvFD3)。这个账户在我看来就是一个使用5KQwrPbwdL6PhXujxW37FSSQZ1JiwsST4cqQzDeyXtP79zkvFD3秘钥对创建的，所以开发者需要把它导入到某个钱包，并得到对应的公钥。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet import --private-key 5KQwrPbwdL6PhXujxW37FSSQZ1JiwsST4cqQzDeyXtP79zkvFD3   <span class="comment"># 将开发者私钥导入到default钱包，会输出对应的公钥，可通过-n指定钱包</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建秘钥</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos create key --to-console</span></span><br><span class="line">Private key: 5KRuAjE9xf6zK3AeMTZa9yLCZMQmhaBxuZePRtdUnWqB5nkd5Jk</span><br><span class="line">Public key: EOS8XaSdS9EieYyWuAfUma7cmB4TEuPWjcU8mpMRR2jztuwd1Cs2a</span><br></pre></td></tr></table></figure>

 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos create key --to-console</span></span><br><span class="line">Private key: 5J3BgEZ168EEP9shdnWBhZsPZRAfjjpUyKVxx1qjezXzJW9bEZv</span><br><span class="line">Public key: EOS81sw5LyVND1KjYoGA7iYNSo9ezgyucEjNzVAP1bPBHRdgkJo29</span><br></pre></td></tr></table></figure>
</li>
<li><p>向wallet导入秘钥</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet import -n hearing --private-key 5J3BgEZ168EEP9shdnWBhZsPZRAfjjpUyKVxx1qjezXzJW9bEZv</span></span><br><span class="line">imported private key for: EOS81sw5LyVND1KjYoGA7iYNSo9ezgyucEjNzVAP1bPBHRdgkJo29</span><br></pre></td></tr></table></figure>

 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet import -n hearing --private-key 5KRuAjE9xf6zK3AeMTZa9yLCZMQmhaBxuZePRtdUnWqB5nkd5Jk</span></span><br><span class="line">imported private key for: EOS8XaSdS9EieYyWuAfUma7cmB4TEuPWjcU8mpMRR2jztuwd1Cs2a</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建账户</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos create account [OPTIONS] creator name OwnerKey [ActiveKey]  <span class="comment"># 命令中的key为public-key</span></span></span><br></pre></td></tr></table></figure>

 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos create account eosio hearing EOS81sw5LyVND1KjYoGA7iYNSo9ezgyucEjNzVAP1bPBHRdgkJo29 EOS8XaSdS9EieYyWuAfUma7cmB4TEuPWjcU8mpMRR2jztuwd1Cs2a</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos create account hearing hearing1 EOS81sw5LyVND1KjYoGA7iYNSo9ezgyucEjNzVAP1bPBHRdgkJo29 EOS8XaSdS9EieYyWuAfUma7cmB4TEuPWjcU8mpMRR2jztuwd1Cs2a</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="智能合约"><a href="#智能合约" class="headerlink" title="智能合约"></a>智能合约</h1><p>在eos私有节点操作中，我们通常是一个合约对应一个合约账户，并且一个账户中只能部署一个智能合约。如果在同一个账户部署多个合约，那么最后部署的合约会覆盖掉之前的合约。</p>
<h2 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h2><ol>
<li><p>编写合约</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;eosiolib/eosio.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> eosio;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> [[<span class="title">eosio</span>:</span>:contract(<span class="string">&quot;hello&quot;</span>)]] hello : <span class="keyword">public</span> contract &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> contract::contract;</span><br><span class="line"></span><br><span class="line">    [[eosio::action]]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">hi</span><span class="params">( name user )</span> </span>&#123;</span><br><span class="line">        print( <span class="string">&quot;Hello, &quot;</span>, user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">EOSIO_DISPATCH( hello, (hi))</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译合约</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> eosio-cpp -I include -o hello.wasm hello.cpp --abigen</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建账户</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos create account eosio hello EOS7qyuXyBtqMYLYBveB3APTiWeyu1d6Z4mTLX1mMP5ZU3kWUqXcJ -p eosio@active    <span class="comment"># -p指定账户的权限</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>部署合约</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos <span class="built_in">set</span> contract hello CONTRACTS_DIR/hello -p hello@active</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>调用合约</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos push action hello hi <span class="string">&#x27;[&quot;bob&quot;]&#x27;</span> -p alice@active</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="eosio-token合约"><a href="#eosio-token合约" class="headerlink" title="eosio.token合约"></a>eosio.token合约</h2><p>在eos目录中自带的合约中，有一个eosio.token智能合约，这个智能合约的功能是为账户发放token，token可以用来转账操作。</p>
<ol>
<li><p>创建账户</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos create account eosio eosio.token EOS81sw5LyVND1KjYoGA7iYNSo9ezgyucEjNzVAP1bPBHRdgkJo29 EOS8XaSdS9EieYyWuAfUma7cmB4TEuPWjcU8mpMRR2jztuwd1Cs2a</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>把eosio.token合约部署到eosio.token账户上</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos <span class="built_in">set</span> contract eosio.token ./eosio.token</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建代币</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos push action eosio.token create <span class="string">&#x27;[ &quot;eosio&quot;, &quot;1000000000.0000 EOS&quot;, 0, 0, 0]&#x27;</span> -p eosio.token@active</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>为账户发放token</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos push action eosio.token issue <span class="string">&#x27;[ &quot;lilei&quot;, &quot;1000.0000 EOS&quot;, &quot;&quot; ]&#x27;</span> -p eosio@active</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>交易token</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos push action eosio.token transfer <span class="string">&#x27;[ &quot;eosio&quot;, &quot;hearing&quot;, &quot;25.0000 EOS&quot;, &quot;m&quot; ]&#x27;</span> -p eosio@active</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查询余额</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos get currency balance eosio.token hearing EOS</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="单主机多节点"><a href="#单主机多节点" class="headerlink" title="单主机多节点"></a>单主机多节点</h1><h2 id="关于配置"><a href="#关于配置" class="headerlink" title="关于配置"></a>关于配置</h2><p>比如机器10.186.11.211上的部分配置：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">bnet-endpoint = <span class="number">10.186</span><span class="number">.11</span><span class="number">.211</span>:<span class="number">4321</span>    </span><br><span class="line"></span><br><span class="line"><span class="comment">//for communicatin with cleos</span></span><br><span class="line">http-server-address = <span class="number">10.186</span><span class="number">.11</span><span class="number">.211</span>:<span class="number">8888</span>  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//for sync block</span></span><br><span class="line">p2p-listen-endpoint = <span class="number">10.186</span><span class="number">.11</span><span class="number">.211</span>:<span class="number">9876</span> </span><br><span class="line">p2p-peer-address = <span class="number">10.186</span><span class="number">.11</span><span class="number">.223</span>:<span class="number">9876</span></span><br><span class="line">p2p-peer-address = <span class="number">10.186</span><span class="number">.11</span><span class="number">.220</span>:<span class="number">9876</span></span><br><span class="line">p2p-peer-address = <span class="number">10.186</span><span class="number">.11</span><span class="number">.141</span>:<span class="number">9876</span> </span><br></pre></td></tr></table></figure>

<ul>
<li>bnet-endpoint: 所监听的传入链接的端点。　默认：0.0.0.0:4321</li>
<li>http-server-address: 本地的http服务地址 默认: 127.0.0.1:8888</li>
<li>p2p-listen-endpoint: 所监听的p2p传入链接的端点。　默认：0.0.0.0:9876</li>
<li>p2p-peer-address: 公共的p2p对等节点地址。</li>
</ul>
<h2 id="启动keosd"><a href="#启动keosd" class="headerlink" title="启动keosd"></a>启动keosd</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> keosd --http-server-address 127.0.0.1:8899</span></span><br></pre></td></tr></table></figure>

<h2 id="创建钱包"><a href="#创建钱包" class="headerlink" title="创建钱包"></a>创建钱包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos --wallet-url http://127.0.0.1:8899  wallet create --to-console</span></span><br><span class="line">Creating wallet: default</span><br><span class="line">Save password to use in the future to unlock this wallet.</span><br><span class="line">Without password imported keys will not be retrievable.</span><br><span class="line">&quot;PW5J2VNR7bJpNtuJXwaEy2LNug5BNbBRRZUR8DcMPd7CrqMVtvnVn&quot;</span><br></pre></td></tr></table></figure>

<h2 id="加载eosio秘钥"><a href="#加载eosio秘钥" class="headerlink" title="加载eosio秘钥"></a>加载eosio秘钥</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos --wallet-url http://127.0.0.1:8899 wallet import --private-key 5KQwrPbwdL6PhXujxW37FSSQZ1JiwsST4cqQzDeyXtP79zkvFD3</span></span><br><span class="line">imported private key for: EOS6MRyAjQq8ud7hVNYcfnVPJqcVpscN5So8BhtHuGYqET5GDW5CV</span><br></pre></td></tr></table></figure>

<h2 id="启动第一个生产节点"><a href="#启动第一个生产节点" class="headerlink" title="启动第一个生产节点"></a>启动第一个生产节点</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nodeos --enable-stale-production --producer-name eosio --plugin eosio::chain_api_plugin --plugin eosio::net_api_plugin --max-transaction-time=1000 --hard-replay-blockchain</span></span><br></pre></td></tr></table></figure>

<h2 id="启动第二个生产节点"><a href="#启动第二个生产节点" class="headerlink" title="启动第二个生产节点"></a>启动第二个生产节点</h2><h3 id="加载eosio-bios合约"><a href="#加载eosio-bios合约" class="headerlink" title="加载eosio.bios合约"></a>加载eosio.bios合约</h3><p>要启动其他节点，必须先加载eosio.bios合同。通过此合同，可以直接控制其他帐户的资源分配并访问其他特权API调用。（如果第一次已经加载了合约，那么这一步可以跳过）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos --wallet-url http://127.0.0.1:8899 <span class="built_in">set</span> contract eosio ./eosio.bios</span></span><br></pre></td></tr></table></figure>

<h3 id="创建账户-inita"><a href="#创建账户-inita" class="headerlink" title="创建账户(inita)"></a>创建账户(inita)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos create key --to-console</span></span><br><span class="line">Private key: 5JcjxL4XqNvR85aQ9hAqworWJuoJfDoGo7wUtZLDbVePRXWCxUf</span><br><span class="line">Public key: EOS58iXdanxG4nwok3AVSrDGu4Fj2dTB9HqeLUdbQu6wRRgyq18CS</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos --wallet-url http://127.0.0.1:8899 wallet import --private-key 5JcjxL4XqNvR85aQ9hAqworWJuoJfDoGo7wUtZLDbVePRXWCxUf</span></span><br><span class="line">imported private key for: EOS58iXdanxG4nwok3AVSrDGu4Fj2dTB9HqeLUdbQu6wRRgyq18CS</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos --wallet-url http://127.0.0.1:8899 create account eosio inita EOS58iXdanxG4nwok3AVSrDGu4Fj2dTB9HqeLUdbQu6wRRgyq18CS EOS58iXdanxG4nwok3AVSrDGu4Fj2dTB9HqeLUdbQu6wRRgyq18CS</span></span><br></pre></td></tr></table></figure>

<h3 id="命令行启动节点"><a href="#命令行启动节点" class="headerlink" title="命令行启动节点"></a>命令行启动节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nodeos --producer-name inita --plugin eosio::chain_api_plugin --plugin eosio::net_api_plugin --http-server-address 127.0.0.1:8889 --p2p-listen-endpoint 127.0.0.1:9877 --p2p-peer-address 127.0.0.1:9876 --config-dir node2 --data-dir node2 --private-key 5JcjxL4XqNvR85aQ9hAqworWJuoJfDoGo7wUtZLDbVePRXWCxUf</span></span><br></pre></td></tr></table></figure>

<p>将inita注册为具有bios节点的生产者，并且bios节点需要执行动作来更新生产者计划（测试失败）:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos --wallet-url http://127.0.0.1:8899 push action eosio setprods <span class="string">&quot;&#123; \&quot;schedule\&quot;: [&#123;\&quot;producer_name\&quot;: \&quot;inita\&quot;,\&quot;block_signing_key\&quot;: \&quot;EOS58iXdanxG4nwok3AVSrDGu4Fj2dTB9HqeLUdbQu6wRRgyq18CS\&quot;&#125;]&#125;&quot;</span> -p eosio@active</span></span><br></pre></td></tr></table></figure>

<h3 id="配置文件启动节点"><a href="#配置文件启动节点" class="headerlink" title="配置文件启动节点"></a>配置文件启动节点</h3><p>也可以通过conf文件启动多个节点，方式如下：</p>
<p>node2.ini：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> communicatin with cleos</span></span><br><span class="line">http-server-address = 127.0.0.1:8889</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> sync block</span></span><br><span class="line">p2p-listen-endpoint = 127.0.0.1:9877</span><br><span class="line">p2p-peer-address = 127.0.0.1:9876</span><br><span class="line">p2p-peer-address = 127.0.0.1:9878</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> agent-name = <span class="string">&quot;EOS Test Agent&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> eosio, this flag must be <span class="literal">true</span>, <span class="keyword">else</span> must be <span class="built_in">set</span> <span class="literal">false</span>, it decide whether or not </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> product block</span></span><br><span class="line">enable-stale-production = true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> producer name</span></span><br><span class="line">producer-name = inita</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> producer key,get by use<span class="string">&quot;cleos ceate key&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> private-key =[<span class="string">&quot;EOS8Znrtgwt8TfpmbVpTKvA2oB8Nqey625CLN8bCN3TEbgx86Dsvr&quot;</span>, <span class="string">&quot;5K463ynhZoCDDa4RDcr63cUwWLTnKqmdcoTKTHBjqoKfv4u5V7p&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> load plugin</span></span><br><span class="line">plugin = eosio::chain_api_plugin</span><br><span class="line">plugin = eosio::history_api_plugin</span><br><span class="line">plugin = eosio::chain_plugin</span><br><span class="line">plugin = eosio::history_plugin</span><br><span class="line">plugin = eosio::net_plugin</span><br><span class="line">plugin = eosio::net_api_plugin </span><br></pre></td></tr></table></figure>

<p>node3.ini：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> communicatin with cleos</span></span><br><span class="line">http-server-address = 127.0.0.1:8890</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> sync block</span></span><br><span class="line">p2p-listen-endpoint = 127.0.0.1:9878</span><br><span class="line">p2p-peer-address = 127.0.0.1:9876</span><br><span class="line">p2p-peer-address = 127.0.0.1:9877</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> agent-name = <span class="string">&quot;EOS Test Agent&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> eosio, this flag must be <span class="literal">true</span>, <span class="keyword">else</span> must be <span class="built_in">set</span> <span class="literal">false</span>, it decide whether or not </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> product block</span></span><br><span class="line">enable-stale-production = true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> producer name</span></span><br><span class="line">producer-name = initb</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> producer key,get by use<span class="string">&quot;cleos ceate key&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> private-key =[<span class="string">&quot;EOS8Znrtgwt8TfpmbVpTKvA2oB8Nqey625CLN8bCN3TEbgx86Dsvr&quot;</span>, <span class="string">&quot;5K463ynhZoCDDa4RDcr63cUwWLTnKqmdcoTKTHBjqoKfv4u5V7p&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> load plugin</span></span><br><span class="line">plugin = eosio::chain_api_plugin</span><br><span class="line">plugin = eosio::history_api_plugin</span><br><span class="line">plugin = eosio::chain_plugin</span><br><span class="line">plugin = eosio::history_plugin</span><br><span class="line">plugin = eosio::net_plugin</span><br><span class="line">plugin = eosio::net_api_plugin </span><br></pre></td></tr></table></figure>

<p>启动node2：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nodeos --config node2.ini --config-dir node2 --data-dir node2 --private-key 5JcjxL4XqNvR85aQ9hAqworWJuoJfDoGo7wUtZLDbVePRXWCxUf</span><br></pre></td></tr></table></figure>

<p>启动node3：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nodeos --config node3.ini --config-dir node3 --data-dir node3 --private-key 5JcjxL4XqNvR85aQ9hAqworWJuoJfDoGo7wUtZLDbVePRXWCxUf</span><br></pre></td></tr></table></figure>

<h1 id="搭建测试网络的自动化脚本"><a href="#搭建测试网络的自动化脚本" class="headerlink" title="搭建测试网络的自动化脚本"></a>搭建测试网络的自动化脚本</h1><p>为方便搭建测试环境，我将一些相关的操作都封装到了一个shell脚本中，在此附上脚本的github地址：<a target="_blank" rel="noopener" href="https://github.com/ljd1996/eos_script/tree/master/mult_node">https://github.com/ljd1996/eos_script/tree/master/mult_node</a>.</p>
<p>该脚本的目录结构如下：</p>
<pre><code>├── conf
│   ├── node10.ini
│   ├── node11.ini
│   ├── node12.ini
│   ├── node1.ini
│   ├── node2.ini
│   ├── node3.ini
│   ├── node4.ini
│   ├── node5.ini
│   ├── node6.ini
│   ├── node7.ini
│   ├── node8.ini
│   └── node9.ini
├── data
├── key
├── log
└── wpk
├── start.sh</code></pre>
<p>下面我将分别介绍每个文件和目录的作用：</p>
<ul>
<li>data目录主要存储节点启动后的区块等相关的数据，均由EOS自动生成，不需要自己做相关处理；</li>
<li>key目录用来存储节点构建过程中生成的账户的秘钥对；</li>
<li>log用来存项keos和nodeos运行过程中的日志输出；</li>
<li>wpk目录用来存储账户数据；</li>
<li>start.sh是脚本的源码。</li>
</ul>
<p>其中，在运行脚本时我们唯一需要修改的是conf下面的配置文件，下面是其中一个配置文件的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> communicatin with cleos</span></span><br><span class="line">http-server-address = 192.168.11.103:8888</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> sync block</span></span><br><span class="line">p2p-listen-endpoint = 192.168.11.103:9876</span><br><span class="line">p2p-peer-address = 192.168.11.103:9877</span><br><span class="line">p2p-peer-address = 192.168.11.103:9878</span><br><span class="line">p2p-peer-address = 192.168.11.103:9879</span><br><span class="line">p2p-peer-address = 192.168.11.135:9880</span><br><span class="line">p2p-peer-address = 192.168.11.135:9881</span><br><span class="line">p2p-peer-address = 192.168.11.135:9882</span><br><span class="line">p2p-peer-address = 192.168.11.135:9883</span><br><span class="line">p2p-peer-address = 192.168.11.135:9884</span><br><span class="line">p2p-peer-address = 192.168.11.135:9885</span><br><span class="line">p2p-peer-address = 192.168.11.135:9886</span><br><span class="line">p2p-peer-address = 192.168.11.135:9887</span><br><span class="line">p2p-peer-address = 192.168.11.135:9888</span><br><span class="line">p2p-peer-address = 192.168.11.135:9889</span><br><span class="line">p2p-peer-address = 192.168.11.103:9890</span><br><span class="line">p2p-peer-address = 192.168.11.103:9891</span><br><span class="line">p2p-peer-address = 192.168.11.103:9892</span><br><span class="line">p2p-peer-address = 192.168.11.103:9893</span><br><span class="line">p2p-peer-address = 192.168.11.103:9894</span><br><span class="line">p2p-peer-address = 192.168.11.103:9895</span><br><span class="line">p2p-peer-address = 192.168.11.103:9896</span><br><span class="line">p2p-peer-address = 192.168.11.103:9897</span><br><span class="line">p2p-peer-address = 192.168.11.135:9877</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> eosio, this flag must be <span class="literal">true</span>, <span class="keyword">else</span> must be <span class="built_in">set</span> <span class="literal">false</span>, it decide whether or not product block</span></span><br><span class="line">enable-stale-production = true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> load plugin</span></span><br><span class="line">plugin = eosio::chain_api_plugin</span><br><span class="line">plugin = eosio::history_api_plugin</span><br><span class="line">plugin = eosio::chain_plugin</span><br><span class="line">plugin = eosio::history_plugin</span><br><span class="line">plugin = eosio::net_plugin</span><br><span class="line">plugin = eosio::net_api_plugin</span><br><span class="line">plugin = eosio::txn_test_gen_plugin</span><br></pre></td></tr></table></figure>

<ul>
<li>http-server-address： 开启的节点之中，这个值不能冲突，ip为本机的ip（ip:port）</li>
<li>p2p-listen-endpoint： 在节点的端到端连接中表示自己这个节点的位置，也需保持唯一，ip为本机的ip（ip:port）</li>
<li>p2p-peer-address： 端到端连接中其他节点的位置</li>
<li>enable-stale-production： 出块节点需要设置为true</li>
<li>plugin： 插件</li>
</ul>
<p>在每次启动节点前，确定一下自己需要启动的节点数以及各自节点的网络地址，然后把conf下的配置文件按照上述原则进行修改，每个node.imi对应一个节点的配置文件，且命名规则和原来一样递增，否则可能会造成节点的开启失败。</p>
<p>脚本使用方法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 清除相关数据</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./start.sh clean</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 运行脚本启动节点</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./start.sh run wallet_dir contracts_dir node_num</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> wallet_dir：本地钱包所在目录</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> contracts_dir：EOS中系统智能合约所在目录</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> node_num：在本机要开启的节点数，视conf中的配置文件数而定</span></span><br></pre></td></tr></table></figure>

<h1 id="多主机多节点测试网搭建"><a href="#多主机多节点测试网搭建" class="headerlink" title="多主机多节点测试网搭建"></a>多主机多节点测试网搭建</h1><p>本节主要介绍如何通过自动化脚本在两台物理机上分别开启多个节点，并测试TPS的过程。</p>
<h2 id="主机A的配置"><a href="#主机A的配置" class="headerlink" title="主机A的配置"></a>主机A的配置</h2><p>在主机A：192.168.11.103中开启12个节点，其中节点1–eosio节点作为出块节点。下面给出几个配置文件的内容：</p>
<p>node1.imi：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> communicatin with cleos</span></span><br><span class="line">http-server-address = 192.168.11.103:8888</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> sync block</span></span><br><span class="line">p2p-listen-endpoint = 192.168.11.103:9876</span><br><span class="line">p2p-peer-address = 192.168.11.103:9877</span><br><span class="line">p2p-peer-address = 192.168.11.103:9878</span><br><span class="line">p2p-peer-address = 192.168.11.103:9879</span><br><span class="line">p2p-peer-address = 192.168.11.135:9880</span><br><span class="line">p2p-peer-address = 192.168.11.135:9881</span><br><span class="line">p2p-peer-address = 192.168.11.135:9882</span><br><span class="line">p2p-peer-address = 192.168.11.135:9883</span><br><span class="line">p2p-peer-address = 192.168.11.135:9884</span><br><span class="line">p2p-peer-address = 192.168.11.135:9885</span><br><span class="line">p2p-peer-address = 192.168.11.135:9886</span><br><span class="line">p2p-peer-address = 192.168.11.135:9887</span><br><span class="line">p2p-peer-address = 192.168.11.135:9888</span><br><span class="line">p2p-peer-address = 192.168.11.135:9889</span><br><span class="line">p2p-peer-address = 192.168.11.103:9890</span><br><span class="line">p2p-peer-address = 192.168.11.103:9891</span><br><span class="line">p2p-peer-address = 192.168.11.103:9892</span><br><span class="line">p2p-peer-address = 192.168.11.103:9893</span><br><span class="line">p2p-peer-address = 192.168.11.103:9894</span><br><span class="line">p2p-peer-address = 192.168.11.103:9895</span><br><span class="line">p2p-peer-address = 192.168.11.103:9896</span><br><span class="line">p2p-peer-address = 192.168.11.103:9897</span><br><span class="line">p2p-peer-address = 192.168.11.135:9877</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> eosio, this flag must be <span class="literal">true</span>, <span class="keyword">else</span> must be <span class="built_in">set</span> <span class="literal">false</span>, it decide whether or not product block</span></span><br><span class="line">enable-stale-production = true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> load plugin</span></span><br><span class="line">plugin = eosio::chain_api_plugin</span><br><span class="line">plugin = eosio::history_api_plugin</span><br><span class="line">plugin = eosio::chain_plugin</span><br><span class="line">plugin = eosio::history_plugin</span><br><span class="line">plugin = eosio::net_plugin</span><br><span class="line">plugin = eosio::net_api_plugin</span><br><span class="line">plugin = eosio::txn_test_gen_plugin</span><br></pre></td></tr></table></figure>

<p>node12.imi：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> communicatin with cleos</span></span><br><span class="line">http-server-address = 192.168.11.103:8909</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> sync block</span></span><br><span class="line">p2p-listen-endpoint = 192.168.11.103:9897</span><br><span class="line">p2p-peer-address = 192.168.11.103:9876</span><br><span class="line">p2p-peer-address = 192.168.11.103:9877</span><br><span class="line">p2p-peer-address = 192.168.11.103:9878</span><br><span class="line">p2p-peer-address = 192.168.11.103:9879</span><br><span class="line">p2p-peer-address = 192.168.11.135:9881</span><br><span class="line">p2p-peer-address = 192.168.11.135:9882</span><br><span class="line">p2p-peer-address = 192.168.11.135:9883</span><br><span class="line">p2p-peer-address = 192.168.11.135:9884</span><br><span class="line">p2p-peer-address = 192.168.11.135:9885</span><br><span class="line">p2p-peer-address = 192.168.11.135:9886</span><br><span class="line">p2p-peer-address = 192.168.11.135:9887</span><br><span class="line">p2p-peer-address = 192.168.11.135:9888</span><br><span class="line">p2p-peer-address = 192.168.11.135:9889</span><br><span class="line">p2p-peer-address = 192.168.11.103:9890</span><br><span class="line">p2p-peer-address = 192.168.11.103:9891</span><br><span class="line">p2p-peer-address = 192.168.11.103:9892</span><br><span class="line">p2p-peer-address = 192.168.11.103:9893</span><br><span class="line">p2p-peer-address = 192.168.11.103:9894</span><br><span class="line">p2p-peer-address = 192.168.11.103:9895</span><br><span class="line">p2p-peer-address = 192.168.11.103:9896</span><br><span class="line">p2p-peer-address = 192.168.11.135:9880</span><br><span class="line">p2p-peer-address = 192.168.11.135:9877</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> eosio, this flag must be <span class="literal">true</span>, <span class="keyword">else</span> must be <span class="built_in">set</span> <span class="literal">false</span>, it decide whether or not product block</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> enable-stale-production = <span class="literal">true</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> load plugin</span></span><br><span class="line">plugin = eosio::chain_api_plugin</span><br><span class="line">plugin = eosio::history_api_plugin</span><br><span class="line">plugin = eosio::chain_plugin</span><br><span class="line">plugin = eosio::history_plugin</span><br><span class="line">plugin = eosio::net_plugin</span><br><span class="line">plugin = eosio::net_api_plugin </span><br><span class="line">plugin = eosio::txn_test_gen_plugin</span><br></pre></td></tr></table></figure>

<p>开启节点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./start.sh run /home/hearing/eosio-wallet ~/Downloads/eosio.contracts 12</span></span><br></pre></td></tr></table></figure>

<h2 id="主机B的配置"><a href="#主机B的配置" class="headerlink" title="主机B的配置"></a>主机B的配置</h2><p>在主机A：192.168.11.135中开启10个节点，所有节点都不出块。下面给出一个配置文件的内容：</p>
<p>node1.imi：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> communicatin with cleos</span></span><br><span class="line">http-server-address = 192.168.11.135:8892</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> sync block</span></span><br><span class="line">p2p-listen-endpoint = 192.168.11.135:9880</span><br><span class="line">p2p-peer-address = 192.168.11.103:9876</span><br><span class="line">p2p-peer-address = 192.168.11.103:9877</span><br><span class="line">p2p-peer-address = 192.168.11.103:9878</span><br><span class="line">p2p-peer-address = 192.168.11.103:9879</span><br><span class="line">p2p-peer-address = 192.168.11.135:9881</span><br><span class="line">p2p-peer-address = 192.168.11.135:9882</span><br><span class="line">p2p-peer-address = 192.168.11.135:9883</span><br><span class="line">p2p-peer-address = 192.168.11.135:9884</span><br><span class="line">p2p-peer-address = 192.168.11.135:9885</span><br><span class="line">p2p-peer-address = 192.168.11.135:9886</span><br><span class="line">p2p-peer-address = 192.168.11.135:9887</span><br><span class="line">p2p-peer-address = 192.168.11.135:9888</span><br><span class="line">p2p-peer-address = 192.168.11.135:9889</span><br><span class="line">p2p-peer-address = 192.168.11.103:9890</span><br><span class="line">p2p-peer-address = 192.168.11.103:9891</span><br><span class="line">p2p-peer-address = 192.168.11.103:9892</span><br><span class="line">p2p-peer-address = 192.168.11.103:9893</span><br><span class="line">p2p-peer-address = 192.168.11.103:9894</span><br><span class="line">p2p-peer-address = 192.168.11.103:9895</span><br><span class="line">p2p-peer-address = 192.168.11.103:9896</span><br><span class="line">p2p-peer-address = 192.168.11.103:9897</span><br><span class="line">p2p-peer-address = 192.168.11.135:9877</span><br></pre></td></tr></table></figure>

<p>开启节点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./start.sh run /home/hearing/eosio-wallet ~/Downloads/eosio.contracts 10</span></span><br></pre></td></tr></table></figure>

<h2 id="测试tps"><a href="#测试tps" class="headerlink" title="测试tps"></a>测试tps</h2><p>使用EOS官方推荐的txn_test_gen_plugin插件作为tps的测试工具，其原理如下：</p>
<ol>
<li><p>在一个指定的节点上新建测试账户</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl --data-binary <span class="string">&#x27;[&quot;eosio&quot;, &quot;5KQwrPbwdL6PhXujxW37FSSQZ1JiwsST4cqQzDeyXtP79zkvFD3&quot;]&#x27;</span> http://192.168.11.103:8888/v1/txn_test_gen/create_test_accounts</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在测试账户间进行自动交易(每10秒产生20个交易)</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl --data-binary <span class="string">&#x27;[&quot;&quot;, 10, 20]&#x27;</span> http://192.168.11.103:8888/v1/txn_test_gen/start_generation</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>上述产生交易的步骤也可在其他节点上运行</p>
</li>
<li><p>查看节点的输出日志，计算tps</p>
<ul>
<li><p>出块节点的日志：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">info  2019-03-13T07:56:24.050 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 00000519d3484607... #1305 @ 2019-03-13T07:56:24.000 signed by eosio [trxs: 371, lib: 1304, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:24.539 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000051aaa2f783e... #1306 @ 2019-03-13T07:56:24.500 signed by eosio [trxs: 358, lib: 1305, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:25.017 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000051beb1d3276... #1307 @ 2019-03-13T07:56:25.000 signed by eosio [trxs: 257, lib: 1306, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:25.549 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000051c6c7937c6... #1308 @ 2019-03-13T07:56:25.500 signed by eosio [trxs: 155, lib: 1307, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:26.028 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000051d9113d888... #1309 @ 2019-03-13T07:56:26.000 signed by eosio [trxs: 154, lib: 1308, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:26.559 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000051ed4d34911... #1310 @ 2019-03-13T07:56:26.500 signed by eosio [trxs: 276, lib: 1309, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:27.023 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000051f69ccd987... #1311 @ 2019-03-13T07:56:27.000 signed by eosio [trxs: 163, lib: 1310, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:27.544 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 000005208f4e00f9... #1312 @ 2019-03-13T07:56:27.500 signed by eosio [trxs: 249, lib: 1311, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:28.033 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 000005210110210b... #1313 @ 2019-03-13T07:56:28.000 signed by eosio [trxs: 214, lib: 1312, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:28.526 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 00000522ea3e4544... #1314 @ 2019-03-13T07:56:28.500 signed by eosio [trxs: 314, lib: 1313, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:29.017 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 000005234705e92a... #1315 @ 2019-03-13T07:56:29.000 signed by eosio [trxs: 259, lib: 1314, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:29.527 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 00000524841be821... #1316 @ 2019-03-13T07:56:29.500 signed by eosio [trxs: 502, lib: 1315, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:30.014 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 000005257f6d4e2e... #1317 @ 2019-03-13T07:56:30.000 signed by eosio [trxs: 897, lib: 1316, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:30.521 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 00000526b3aa10f1... #1318 @ 2019-03-13T07:56:30.500 signed by eosio [trxs: 526, lib: 1317, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:31.023 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000052756e32d73... #1319 @ 2019-03-13T07:56:31.000 signed by eosio [trxs: 652, lib: 1318, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:31.514 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 000005288100c034... #1320 @ 2019-03-13T07:56:31.500 signed by eosio [trxs: 616, lib: 1319, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:32.048 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000052914f4a78b... #1321 @ 2019-03-13T07:56:32.000 signed by eosio [trxs: 662, lib: 1320, confirmed: 0]</span><br></pre></td></tr></table></figure>
</li>
<li><p>其他节点的日志：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">info  2019-03-13T07:55:53.164 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 9f6a6c4c171e385a... #1243 @ 2019-03-13T07:55:53.000 signed by eosio [trxs: 128, lib: 1242, conf: 0, latency: 164 ms]</span><br><span class="line">info  2019-03-13T07:55:53.600 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block faff04083aafe1e8... #1244 @ 2019-03-13T07:55:53.500 signed by eosio [trxs: 79, lib: 1243, conf: 0, latency: 100 ms]</span><br><span class="line">info  2019-03-13T07:55:54.139 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block bf606f4ee1ee1498... #1245 @ 2019-03-13T07:55:54.000 signed by eosio [trxs: 113, lib: 1244, conf: 0, latency: 139 ms]</span><br><span class="line">info  2019-03-13T07:55:54.806 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block e7ba16b5cda9ae0e... #1246 @ 2019-03-13T07:55:54.500 signed by eosio [trxs: 224, lib: 1245, conf: 0, latency: 306 ms]</span><br><span class="line">info  2019-03-13T07:55:55.151 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 149c694678a74f0e... #1247 @ 2019-03-13T07:55:55.000 signed by eosio [trxs: 144, lib: 1246, conf: 0, latency: 151 ms]</span><br><span class="line">info  2019-03-13T07:55:55.634 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 06efdba68e432e11... #1248 @ 2019-03-13T07:55:55.500 signed by eosio [trxs: 112, lib: 1247, conf: 0, latency: 134 ms]</span><br><span class="line">info  2019-03-13T07:55:56.100 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 1722e7db91fbc95b... #1249 @ 2019-03-13T07:55:56.000 signed by eosio [trxs: 112, lib: 1248, conf: 0, latency: 100 ms]</span><br><span class="line">info  2019-03-13T07:55:56.615 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block a1ea6b148a9669a8... #1250 @ 2019-03-13T07:55:56.500 signed by eosio [trxs: 112, lib: 1249, conf: 0, latency: 115 ms]</span><br><span class="line">info  2019-03-13T07:55:57.131 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block ea93f8c7878d058b... #1251 @ 2019-03-13T07:55:57.000 signed by eosio [trxs: 112, lib: 1250, conf: 0, latency: 131 ms]</span><br><span class="line">info  2019-03-13T07:55:57.744 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block a0f4be3b1b68b79c... #1252 @ 2019-03-13T07:55:57.500 signed by eosio [trxs: 169, lib: 1251, conf: 0, latency: 244 ms]</span><br><span class="line">info  2019-03-13T07:55:58.173 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 7334cd134b162612... #1253 @ 2019-03-13T07:55:58.000 signed by eosio [trxs: 126, lib: 1252, conf: 0, latency: 173 ms]</span><br><span class="line">info  2019-03-13T07:55:58.730 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 0c563bf6bad3095a... #1254 @ 2019-03-13T07:55:58.500 signed by eosio [trxs: 169, lib: 1253, conf: 0, latency: 230 ms]</span><br><span class="line">info  2019-03-13T07:55:59.086 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 6d0901b8f1b15739... #1255 @ 2019-03-13T07:55:59.000 signed by eosio [trxs: 64, lib: 1254, conf: 0, latency: 86 ms]</span><br><span class="line">info  2019-03-13T07:55:59.778 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 01a641dfcb07dbe5... #1256 @ 2019-03-13T07:55:59.500 signed by eosio [trxs: 251, lib: 1255, conf: 0, latency: 278 ms]</span><br><span class="line">info  2019-03-13T07:56:00.131 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 308907ac4cf4bc98... #1257 @ 2019-03-13T07:56:00.000 signed by eosio [trxs: 85, lib: 1256, conf: 0, latency: 131 ms]</span><br><span class="line">info  2019-03-13T07:56:00.688 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 3834f77aa9b994c9... #1258 @ 2019-03-13T07:56:00.500 signed by eosio [trxs: 128, lib: 1257, conf: 0, latency: 188 ms]</span><br><span class="line">info  2019-03-13T07:56:01.359 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 4ad642cb075d8d2a... #1259 @ 2019-03-13T07:56:01.000 signed by eosio [trxs: 206, lib: 1258, conf: 0, latency: 359 ms]</span><br><span class="line">info  2019-03-13T07:56:01.630 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 9ed257c131cffcee... #1260 @ 2019-03-13T07:56:01.500 signed by eosio [trxs: 114, lib: 1259, conf: 0, latency: 130 ms]</span><br><span class="line">info  2019-03-13T07:56:02.114 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block be8627adc345d6a4... #1261 @ 2019-03-13T07:56:02.000 signed by eosio [trxs: 96, lib: 1260, conf: 0, latency: 114 ms]</span><br><span class="line">info  2019-03-13T07:56:02.732 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 6d609f6c67134258... #1262 @ 2019-03-13T07:56:02.500 signed by eosio [trxs: 211, lib: 1261, conf: 0, latency: 232 ms]</span><br><span class="line">info  2019-03-13T07:56:03.152 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block d884495e2f09d7ff... #1263 @ 2019-03-13T07:56:03.000 signed by eosio [trxs: 116, lib: 1262, conf: 0, latency: 152 ms]</span><br><span class="line">info  2019-03-13T07:56:03.741 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 2735616823a12a4b... #1264 @ 2019-03-13T07:56:03.500 signed by eosio [trxs: 133, lib: 1263, conf: 0, latency: 241 ms]</span><br><span class="line">info  2019-03-13T07:56:04.321 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 55d4565cc4094b30... #1265 @ 2019-03-13T07:56:04.000 signed by eosio [trxs: 192, lib: 1264, conf: 0, latency: 321 ms]</span><br><span class="line">info  2019-03-13T07:56:04.744 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 1e4ba2d9bee5b06f... #1266 @ 2019-03-13T07:56:04.500 signed by eosio [trxs: 228, lib: 1265, conf: 0, latency: 244 ms]</span><br></pre></td></tr></table></figure>

<p>tps的计算方式为日志中的<code>trxs</code>数值乘以2，因为EOS的出块时间是每500毫秒出一个区块。</p>
</li>
</ul>
</li>
</ol>
<h1 id="启动测试网"><a href="#启动测试网" class="headerlink" title="启动测试网"></a>启动测试网</h1><p>用户可以主观地给候选节点投票，当所有代币的15%进行投票后，会由投票数靠前的节点（默认21个）出块，出块的节点票数必须大于0，且超级节点数默认<strong>不大于</strong>21个。</p>
<p>可以通过上述给出的链接中的脚本进行自动化启动，具体使用如下（我这里一共开启了包括创世节点在内共6个节点，主网启动后，由其中的三个节点轮流出块）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 初始化</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./start.sh clean                                                                        </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启节点并注册候选人</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./start.sh run_vote /home/hearing/eosio-wallet ~/Downloads/eosio.contracts/ 6</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 投票</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 数字4表示user2投票给prod2，user3投票给prod3，user4投票给user4</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./start.sh vote 4</span></span><br></pre></td></tr></table></figure>

<p>此时会由prod2，3，4作为BP轮流出块（<strong>候选账户名需要跟节点名相同</strong>）。</p>
<p>注意：由于txn_test_gen_plugin的限制，当启动测试网后，貌似不能直接通过它去测试TPS（create_test_accounts会报错），故我这里加上了手动创建测试账户的过程（秘钥不能更改）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos system newaccount --transfer eosio txn.test.a EOS5hBSuDvcU2hHZJLAWCzBCCS7pV6SeQ4FuMhLPQPYqu9hcFakhy --stake-net <span class="string">&quot;100000000.0000 EOS&quot;</span> --stake-cpu <span class="string">&quot;100000000.0000 EOS&quot;</span> --buy-ram <span class="string">&quot;20000.0000 EOS&quot;</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos system newaccount --transfer eosio txn.test.b EOS5gUGqvjsoAmqEJvSBAygi7XF75CaCDfpysZRRVPRBdAzcirTWG --stake-net <span class="string">&quot;100000000.0000 EOS&quot;</span> --stake-cpu <span class="string">&quot;100000000.0000 EOS&quot;</span> --buy-ram <span class="string">&quot;20000.0000 EOS&quot;</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos system newaccount --transfer eosio txn.test.t EOS5gUGqvjsoAmqEJvSBAygi7XF75CaCDfpysZRRVPRBdAzcirTWG --stake-net <span class="string">&quot;100000000.0000 EOS&quot;</span> --stake-cpu <span class="string">&quot;100000000.0000 EOS&quot;</span> --buy-ram <span class="string">&quot;20000.0000 EOS&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>限制端口带宽的相关命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo iptables -t mangle -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo tc qdisc del dev lo root</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo tc qdisc add dev lo root handle 1: htb default 1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo tc class add dev lo parent 1: classid 1:1 htb rate 100mbps</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo tc class add dev lo parent 1:1 classid 1:5 htb rate 256Kbit ceil 512Kbit prio 1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo tc filter add dev lo parent 1:0 prio 1 protocol ip handle 5 fw flowid 1:5</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo iptables -A OUTPUT -t mangle -p tcp --sport 9877:9879 -j MARK --set-mark 5</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo iptables -A INPUT -t mangle -p tcp --sport 9877:9879 -j MARK --set-mark 5</span></span><br></pre></td></tr></table></figure>

<p>然后通过txn_test_gen_plugin提供的start_generation接口进行模拟交易，并测试TPS。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl --data-binary <span class="string">&#x27;[&quot;&quot;, 20, 20]&#x27;</span> http://127.0.0.1:8888/v1/txn_test_gen/start_generation</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ljd1996.github.io/2019/02/26/SDN%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/26/SDN%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">SDN笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-26 10:06:09" itemprop="dateCreated datePublished" datetime="2019-02-26T10:06:09+08:00">2019-02-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a>
                </span>
            </span>

          
            <span id="/2019/02/26/SDN%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="SDN笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/02/26/SDN%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/02/26/SDN%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>现有网络中，对流量的控制和转发都依赖于网络设备实现，且设备中集成了与业务特性紧耦合的操作系统和专用硬件，这些操作系统和专用硬件都是各个厂家自己开发和设计的。</p>
<p>SDN是一种新型的网络架构，它的设计理念是将网络的控制平面与数据转发平面进行分离，从而通过集中的控制器中的软件平台去实现可编程化控制底层硬件，实现对网络资源灵活的按需调配。在SDN网络中，网络设备只负责单纯的数据转发，可以采用通用的硬件;而原来负责控制的操作系统将提炼为独立的网络操作系统，负责对不同业务特性进行适配，而且网络操作系统和业务特性以及硬件设备之间的通信都可以通过编程实现。</p>
<p>与传统网络相比，SDN的基本特征有3点：</p>
<ol>
<li>控制与转发分离。转发平面由受控转发的设备组成，转发方式以及业务逻辑由运行在分离出去的控制面上的控制应用所控制。</li>
<li>控制平面与转发平面之间的开放接口。SDN 为控制平面提供开放可编程接口。通过这种方式，控制应用只需要关注自身逻辑，而不需要关注底层更多的实现细节。</li>
<li>逻辑上的集中控制。逻辑上集中的控制平面可以控制多个转发面设备，也就是控制整个物理网络，因而可以获得全局的网络状态视图，并根据该全局网络状态视图实现对网络的优化控制。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ljd1996.github.io/2019/02/24/adb%E7%94%A8%E6%B3%95%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/24/adb%E7%94%A8%E6%B3%95%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">adb用法笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-24 00:30:03" itemprop="dateCreated datePublished" datetime="2019-02-24T00:30:03+08:00">2019-02-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">系统</span></a>
                </span>
            </span>

          
            <span id="/2019/02/24/adb%E7%94%A8%E6%B3%95%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="adb用法笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/02/24/adb%E7%94%A8%E6%B3%95%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/02/24/adb%E7%94%A8%E6%B3%95%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>ADB，即 Android Debug Bridge.</p>
<h1 id="命令语法"><a href="#命令语法" class="headerlink" title="命令语法"></a>命令语法</h1><p>adb 命令的基本语法如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb [-d|-e|-s &lt;serialNumber&gt;] &lt;command&gt;</span><br></pre></td></tr></table></figure>

<p>如果只有一个设备/模拟器连接时，可以省略掉 [-d|-e|-s &lt;serialNumber&gt;] 这一部分，直接使用 adb &lt;command&gt;。</p>
<h1 id="指定目标设备"><a href="#指定目标设备" class="headerlink" title="指定目标设备"></a>指定目标设备</h1><table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">-d</td>
<td align="center">指定当前唯一通过 USB 连接的 Android 设备为命令目标</td>
</tr>
<tr>
<td align="center">-e</td>
<td align="center">指定当前唯一运行的模拟器为命令目标</td>
</tr>
<tr>
<td align="center">-s &lt;serialNumber&gt;</td>
<td align="center">指定相应 serialNumber 号的设备/模拟器为命令目标</td>
</tr>
</tbody></table>
<p>在多个设备/模拟器连接的情况下较常用的是 -s &lt;serialNumber&gt; 参数，serialNumber 可以通过 adb devices 命令获取。</p>
<h1 id="启动-停止"><a href="#启动-停止" class="headerlink" title="启动/停止"></a>启动/停止</h1><p>启动 adb server 命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb start-server</span><br></pre></td></tr></table></figure>

<p>一般无需手动执行此命令，在运行 adb 命令时若发现 adb server 没有启动会自动调起。</p>
<p>停止 adb server 命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb kill-server</span><br></pre></td></tr></table></figure>

<h1 id="无线连接"><a href="#无线连接" class="headerlink" title="无线连接"></a>无线连接</h1><ol>
<li>将 Android 设备与将运行 adb 的电脑连接到同一个局域网。</li>
<li>将设备与电脑通过 USB 线连接。</li>
<li>让设备在 5555 端口监听 TCP/IP 连接:<code>adb tcpip 5555</code>。</li>
<li>断开 USB 连接。</li>
<li>找到设备的 IP 地址。</li>
<li>通过 IP 地址连接设备:<code>adb connect &lt;device-ip-address&gt;</code>。</li>
<li>确认连接状态:<code>adb devices</code>。</li>
<li>断开无线连接:<code>adb disconnect &lt;device-ip-address&gt;</code>。</li>
</ol>
<h1 id="应用管理"><a href="#应用管理" class="headerlink" title="应用管理"></a>应用管理</h1><h2 id="查看应用列表"><a href="#查看应用列表" class="headerlink" title="查看应用列表"></a>查看应用列表</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell pm list packages [-f] [-d] [-e] [-s] [-3] [-i] [-u] [--user USER_ID] [FILTER]</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">显示列表</th>
</tr>
</thead>
<tbody><tr>
<td align="center">无</td>
<td align="center">所有应用</td>
</tr>
<tr>
<td align="center">-f</td>
<td align="center">显示应用关联的 apk 文件</td>
</tr>
<tr>
<td align="center">-d</td>
<td align="center">只显示 disabled 的应用</td>
</tr>
<tr>
<td align="center">-e</td>
<td align="center">只显示 enabled 的应用</td>
</tr>
<tr>
<td align="center">-s</td>
<td align="center">只显示系统应用</td>
</tr>
<tr>
<td align="center">-3</td>
<td align="center">只显示第三方应用</td>
</tr>
<tr>
<td align="center">-i</td>
<td align="center">显示应用的 installer</td>
</tr>
<tr>
<td align="center">-u</td>
<td align="center">包含已卸载应用</td>
</tr>
<tr>
<td align="center">&lt;FILTER&gt;</td>
<td align="center">包名包含 &lt;FILTER&gt; 字符串</td>
</tr>
</tbody></table>
<h2 id="安装-APK"><a href="#安装-APK" class="headerlink" title="安装 APK"></a>安装 APK</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb install &lt;apk file&gt;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">-r</td>
<td align="center">允许覆盖安装。</td>
</tr>
<tr>
<td align="center">-s</td>
<td align="center">将应用安装到 sdcard。</td>
</tr>
<tr>
<td align="center">-d</td>
<td align="center">允许降级覆盖安装。</td>
</tr>
</tbody></table>
<h2 id="卸载应用"><a href="#卸载应用" class="headerlink" title="卸载应用"></a>卸载应用</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb uninstall [-k] &lt;packagename&gt;</span><br></pre></td></tr></table></figure>

<p>-k 参数可选，表示卸载应用但保留数据和缓存目录。</p>
<h2 id="清除应用数据与缓存"><a href="#清除应用数据与缓存" class="headerlink" title="清除应用数据与缓存"></a>清除应用数据与缓存</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell pm clear &lt;packagename&gt;</span><br></pre></td></tr></table></figure>

<p>这条命令的效果相当于在设置里的应用信息界面点击了「清除缓存」和「清除数据」。</p>
<h1 id="与应用交互"><a href="#与应用交互" class="headerlink" title="与应用交互"></a>与应用交互</h1><p>主要是使用 <code>am &lt;command&gt;</code> 命令，常用的 command 如下：</p>
<table>
<thead>
<tr>
<th align="center">command</th>
<th align="center">用途</th>
</tr>
</thead>
<tbody><tr>
<td align="center">start [options] &lt;INTENT&gt;</td>
<td align="center">启动 &lt;INTENT&gt; 指定的 Activity</td>
</tr>
<tr>
<td align="center">startservice [options] &lt;INTENT&gt;</td>
<td align="center">启动 &lt;INTENT&gt; 指定的 Service</td>
</tr>
<tr>
<td align="center">broadcast [options] &lt;INTENT&gt;</td>
<td align="center">发送 &lt;INTENT&gt; 指定的广播</td>
</tr>
<tr>
<td align="center">force-stop &lt;packagename&gt;</td>
<td align="center">停止 &lt;packagename&gt; 相关的进程</td>
</tr>
</tbody></table>
<p>&lt;INTENT&gt; 参数很灵活，和写 Android 程序时代码里的 Intent 相对应。用于决定 intent 对象的选项如下：</p>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">-a &lt;ACTION&gt;</td>
<td align="center">指定 action，比如 android.intent.action.VIEW</td>
</tr>
<tr>
<td align="center">-c &lt;CATEGORY&gt;</td>
<td align="center">指定 category，比如 android.intent.category.APP_CONTACTS</td>
</tr>
<tr>
<td align="center">-n &lt;COMPONENT&gt;</td>
<td align="center">指定完整 component 名，用于明确指定启动哪个 Activity，如 com.example.app/.ExampleActivity</td>
</tr>
</tbody></table>
<p>&lt;INTENT&gt; 里还能带数据，就像写代码时的 Bundle 一样：</p>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">–esn &lt;EXTRA_KEY&gt;</td>
<td align="center">null 值（只有 key 名）</td>
</tr>
<tr>
<td align="center">–es &lt;EXTRA_KEY&gt; &lt;EXTRA_STRING_VALUE&gt;</td>
<td align="center">String 值</td>
</tr>
<tr>
<td align="center">–ez &lt;EXTRA_KEY&gt; &lt;EXTRA_BOOLEAN_VALUE&gt;</td>
<td align="center">boolean 值</td>
</tr>
<tr>
<td align="center">–ei &lt;EXTRA_KEY&gt; &lt;EXTRA_INT_VALUE&gt;</td>
<td align="center">integer 值</td>
</tr>
<tr>
<td align="center">–el &lt;EXTRA_KEY&gt; &lt;EXTRA_LONG_VALUE&gt;</td>
<td align="center">long 值</td>
</tr>
<tr>
<td align="center">–ef &lt;EXTRA_KEY&gt; &lt;EXTRA_FLOAT_VALUE&gt;</td>
<td align="center">float 值</td>
</tr>
<tr>
<td align="center">–eu &lt;EXTRA_KEY&gt; &lt;EXTRA_URI_VALUE&gt;</td>
<td align="center">URI</td>
</tr>
<tr>
<td align="center">–ecn &lt;EXTRA_KEY&gt; &lt;EXTRA_COMPONENT_NAME_VALUE&gt;</td>
<td align="center">component name</td>
</tr>
<tr>
<td align="center">–eia &lt;EXTRA_KEY&gt; &lt;EXTRA_INT_VALUE&gt;[,&lt;EXTRA_INT_VALUE…]</td>
<td align="center">integer 数组</td>
</tr>
<tr>
<td align="center">–ela &lt;EXTRA_KEY&gt; &lt;EXTRA_LONG_VALUE&gt;[,&lt;EXTRA_LONG_VALUE…]</td>
<td align="center">long 数组</td>
</tr>
</tbody></table>
<h2 id="调起-Activity"><a href="#调起-Activity" class="headerlink" title="调起 Activity"></a>调起 Activity</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start [options] &lt;INTENT&gt;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -n com.tencent.mm/.ui.LauncherUI</span><br></pre></td></tr></table></figure>

<p>表示调起微信主界面。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -n org.mazhuang.boottimemeasure/.MainActivity --es &quot;toast&quot; &quot;hello, world&quot;</span><br></pre></td></tr></table></figure>

<p>表示调起 org.mazhuang.boottimemeasure/.MainActivity 并传给它 string 数据键值对 toast - hello, world。</p>
<h2 id="调起-Service"><a href="#调起-Service" class="headerlink" title="调起 Service"></a>调起 Service</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am startservice [options] &lt;INTENT&gt;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am startservice -n com.tencent.mm/.plugin.accountsync.model.AccountAuthenticatorService</span><br></pre></td></tr></table></figure>

<p>表示调起微信的某 Service。</p>
<h2 id="发送广播"><a href="#发送广播" class="headerlink" title="发送广播"></a>发送广播</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am broadcast [options] &lt;INTENT&gt;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am broadcast -a android.intent.action.BOOT_COMPLETED -n org.mazhuang.boottimemeasure/.BootCompletedReceiver</span><br></pre></td></tr></table></figure>

<p>表示向 org.mazhuang.boottimemeasure/.BootCompletedReceiver 发送一个 BOOT_COMPLETED 广播，这类用法在测试的时候很实用，比如某个广播的场景很难制造，可以考虑通过这种方式来发送广播。</p>
<h2 id="强制停止应用"><a href="#强制停止应用" class="headerlink" title="强制停止应用"></a>强制停止应用</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am force-stop &lt;packagename&gt;</span><br></pre></td></tr></table></figure>

<p>命令示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am force-stop com.qihoo360.mobilesafe</span><br></pre></td></tr></table></figure>

<h1 id="设备-进程信息"><a href="#设备-进程信息" class="headerlink" title="设备/进程信息"></a>设备/进程信息</h1><h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><p>原生Linux的查看方式见<a href="https://ljd1996.github.io/2019/08/27/Linux%E7%AC%94%E8%AE%B0/">Linux笔记</a></p>
<h2 id="procrank"><a href="#procrank" class="headerlink" title="procrank"></a>procrank</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">rocrank</span><br><span class="line">  PID      Vss      Rss      Pss      Uss  cmdline</span><br><span class="line"> 1078   59840K   59708K   42125K   39344K  com.csr.BTApp</span><br><span class="line"> 2683   59124K   59040K   37960K   33032K  com.android.launcher</span><br><span class="line"> 1042   51572K   51488K   35686K   33604K  android.process.acore</span><br><span class="line">  782   32808K   32748K   16775K   14716K  system_server</span><br><span class="line">  667   20560K   17560K   12739K    8940K  /system/bin/surfaceflinger</span><br><span class="line">  851   30124K   30036K   12085K    7996K  com.android.systemui</span><br><span class="line"> 2999   27680K   27596K    9929K    7040K  com.baidu.input</span><br><span class="line">  959   20764K   20676K    5522K    3788K  com.android.phone</span><br><span class="line"> 3468   21892K   21800K    4591K    1920K  com.apical.dreamthemetime</span><br><span class="line">  982   19880K   19792K    4438K    2644K  com.csr.csrservices</span><br><span class="line">  668   19592K   19480K    3525K    1360K  zygote</span><br><span class="line">  670    2960K    2960K    2407K    2356K  /system/bin/mediaserver</span><br><span class="line">  663    1784K    1784K    1209K    1116K  /system/bin/synergy_service</span><br><span class="line">  756    3404K    1348K    1133K    1124K  /usr/bin/gpsexe</span><br><span class="line">  669    1468K    1468K     959K     928K  /system/bin/drmserver</span><br><span class="line">  675     692K     692K     692K     692K  /bin/sh</span><br><span class="line"> 3482     656K     652K     456K     444K  procrank</span><br><span class="line">    1     164K     164K     144K     144K  /init</span><br><span class="line">                          ------   ------  ------</span><br><span class="line">                         195031K  163724K  TOTAL</span><br><span class="line"></span><br><span class="line">RAM: 480380K total, 3624K free, 732K buffers, 299788K cached, 264844K shmem, 7632K slab</span><br></pre></td></tr></table></figure>

<h2 id="dumpsys"><a href="#dumpsys" class="headerlink" title="dumpsys"></a>dumpsys</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dumpsys [options]</span><br><span class="line">        meminfo 显示内存信息</span><br><span class="line">        cpuinfo 显示CPU信息</span><br><span class="line">        account 显示accounts信息</span><br><span class="line">        activity 显示所有的activities的信息</span><br><span class="line">        window 显示键盘，窗口和它们的关系</span><br><span class="line">        wifi 显示wifi信息</span><br></pre></td></tr></table></figure>

<p>可以在其后通过包名或者进程pid展示指定进程的信息。</p>
<h2 id="型号"><a href="#型号" class="headerlink" title="型号"></a>型号</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell getprop ro.product.model</span><br></pre></td></tr></table></figure>

<h2 id="电池状况"><a href="#电池状况" class="headerlink" title="电池状况"></a>电池状况</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys battery</span><br></pre></td></tr></table></figure>

<h2 id="屏幕分辨率"><a href="#屏幕分辨率" class="headerlink" title="屏幕分辨率"></a>屏幕分辨率</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell wm size</span><br></pre></td></tr></table></figure>

<h2 id="屏幕密度"><a href="#屏幕密度" class="headerlink" title="屏幕密度"></a>屏幕密度</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell wm density</span><br></pre></td></tr></table></figure>

<h2 id="android-id"><a href="#android-id" class="headerlink" title="android_id"></a>android_id</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell settings get secure android_id</span><br></pre></td></tr></table></figure>

<h2 id="IMEI"><a href="#IMEI" class="headerlink" title="IMEI"></a>IMEI</h2><p>在 Android 4.4 及以下版本可通过如下命令获取 IMEI：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys iphonesubinfo</span><br></pre></td></tr></table></figure>

<p>而在 Android 5.0 及以上版本里这个命令输出为空，得通过其它方式获取了（需要 root 权限）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service call iphonesubinfo 1</span><br></pre></td></tr></table></figure>

<h2 id="Android-系统版本"><a href="#Android-系统版本" class="headerlink" title="Android 系统版本"></a>Android 系统版本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell getprop ro.build.version.release</span><br></pre></td></tr></table></figure>

<h2 id="Mac-地址"><a href="#Mac-地址" class="headerlink" title="Mac 地址"></a>Mac 地址</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell cat /sys/class/net/wlan0/address</span><br></pre></td></tr></table></figure>

<h2 id="CPU-信息"><a href="#CPU-信息" class="headerlink" title="CPU 信息"></a>CPU 信息</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell cat /proc/cpuinfo</span><br></pre></td></tr></table></figure>

<h2 id="更多硬件与系统属性"><a href="#更多硬件与系统属性" class="headerlink" title="更多硬件与系统属性"></a>更多硬件与系统属性</h2><p>设备的更多硬件与系统属性可以通过如下命令查看：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell cat /system/build.prop</span><br></pre></td></tr></table></figure>

<p>这会输出很多信息，包括前面几个小节提到的「型号」和「Android 系统版本」等。输出里还包括一些其它有用的信息，它们也可通过 adb shell getprop &lt;属性名&gt; 命令单独查看，列举一部分属性如下：</p>
<img src="硬件与设备信息.png"/>

<h1 id="模拟按键-输入"><a href="#模拟按键-输入" class="headerlink" title="模拟按键/输入"></a>模拟按键/输入</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Usage: input [&lt;source&gt;] &lt;command&gt; [&lt;arg&gt;...]</span><br><span class="line"></span><br><span class="line">The sources are:</span><br><span class="line">      mouse</span><br><span class="line">      keyboard</span><br><span class="line">      joystick</span><br><span class="line">      touchnavigation</span><br><span class="line">      touchpad</span><br><span class="line">      trackball</span><br><span class="line">      stylus</span><br><span class="line">      dpad</span><br><span class="line">      gesture</span><br><span class="line">      touchscreen</span><br><span class="line">      gamepad</span><br><span class="line"></span><br><span class="line">The commands and default sources are:</span><br><span class="line">      text &lt;string&gt; (Default: touchscreen)</span><br><span class="line">      keyevent [--longpress] &lt;key code number or name&gt; ... (Default: keyboard)</span><br><span class="line">      tap &lt;x&gt; &lt;y&gt; (Default: touchscreen)</span><br><span class="line">      swipe &lt;x1&gt; &lt;y1&gt; &lt;x2&gt; &lt;y2&gt; [duration(ms)] (Default: touchscreen)</span><br><span class="line">      press (Default: trackball)</span><br><span class="line">      roll &lt;dx&gt; &lt;dy&gt; (Default: trackball)</span><br></pre></td></tr></table></figure>

<p>比如使用 adb shell input keyevent &lt;keycode&gt; 命令，部分keycode如下：</p>
<img src="keycode.png"/>

<p>比如可以使用 <code>adb shell input text hello</code> 命令来输入文本。</p>
<h1 id="屏幕截图"><a href="#屏幕截图" class="headerlink" title="屏幕截图"></a>屏幕截图</h1><p>-p 指定保存为png.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell screencap -p /sdcard/sc.png</span><br></pre></td></tr></table></figure>

<h1 id="录制屏幕"><a href="#录制屏幕" class="headerlink" title="录制屏幕"></a>录制屏幕</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell screenrecord /sdcard/filename.mp4</span><br></pre></td></tr></table></figure>

<h1 id="由包名获取apk路径"><a href="#由包名获取apk路径" class="headerlink" title="由包名获取apk路径"></a>由包名获取apk路径</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell pm path pkg</span><br></pre></td></tr></table></figure>

<h1 id="获取当前APP包名"><a href="#获取当前APP包名" class="headerlink" title="获取当前APP包名"></a>获取当前APP包名</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys window | findstr mCurrentFocus</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ljd1996.github.io/2019/02/23/Network-Coding/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/23/Network-Coding/" class="post-title-link" itemprop="url">Network-Coding</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-23 21:00:53" itemprop="dateCreated datePublished" datetime="2019-02-23T21:00:53+08:00">2019-02-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a>
                </span>
            </span>

          
            <span id="/2019/02/23/Network-Coding/" class="post-meta-item leancloud_visitors" data-flag-title="Network-Coding" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/02/23/Network-Coding/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/02/23/Network-Coding/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="TCP-IP的问题"><a href="#TCP-IP的问题" class="headerlink" title="TCP/IP的问题"></a>TCP/IP的问题</h1><p>互联网上的数据传递都是封装在“包裹”里的,将信息传递到终点的程序，以及这些“包裹”的格式，通常用 TCP/IP 协议来描述。为了让 TCP 数据传输成功，接收数据的人需要按照当时发出时的顺序，准确的来接收这些“数字包裹”。如果其中有一个数据包，因为某种原因给丢失了，那么这种互联网协议就会将其看作是网络拥堵的一个信号，数据传输速度立刻下降一半，之后它速度回升起来的也非常缓慢。该处理机制在某些状况下也许很理想，但是在另外一些状况下就会很糟糕。其根本的原因就在于：这套互联网协议本身并没有足够的智能，来分别接下来做什么事才是最正确的选择。同时，尽管从理论上来说，数字包可以从 A 点到 B 点以无限条路径进行传说，但事实上，在一个 TCP 连接中，数据传输一般都走的是相同的路径，这就给了数字黑客以机会，方便他们侵入到你的通信交流中。</p>
<h1 id="网络编码"><a href="#网络编码" class="headerlink" title="网络编码"></a>网络编码</h1><p>网络编码是一种通过中继节点对接收到的信息进行编码来达到提高多播网络容量的技术。在传统的数据传输技术中，中继节点只负责数据的存储转发，而基于网络编码技术的网络的中继节点在具备传统中继功能的基础上，会根据网络编码规则将接收到的信息进行线性或非线性处理再进行传播，这种做法最直观的优势是减少了传输次数。</p>
<p>“网络编码”能够让网络中的每一个节点都变得比现在更加智能。在 TCP/IP 协议中，网络节点只是一些简单的转换节点，只负责存储“数字包裹”，并且按照之前预设的路径转发到下一节点，而相比之下，在“网络编码”中，每一个节点都可以对“数字包裹”进行再加工，比如重新编制路径，或者重新编码。将智能赋予到网络的每个节点，是该技术称得上“破坏性创新”的理由。因为这将赋予信息处理技术以史无前例的灵活性。例如，它可以利用多路径 TCP，另外，应用了再编码机制，可以进一步的提升安全性和数据传输速度，甚至能够在网络的每个节点内部存储数据信息。</p>
<p>在”网络编码”中，“数字包裹”中的内容被看作是一个真实的数字，“数字包裹”以“批”为单位进行处理。每一个节点都构建了一套线性方程，利用的是从“数字包裹”中提取出来的数字，以及随机生成的一组系数。每一个线性方程都能生成一个已编码的包裹，其系数存储在编码包裹的头部，未知的变量是每一个包裹的实际信息，当作一个数字。换句话说，每一个已编码的包裹中，都一次性的在几个“标准”的包裹上含有部分的信息，但同时还乘以不同的系数。如果你还没有忘记高中数学的话，你知道需要 N 个线性方程来解决 N 个未知变量。因为每一个以编码的数字包裹都包含一个单独的方程，这意味着接收信息者如果想要解码这段信息，就需要 N 个这样的数字包裹(当然乘以不同的系数才可以)。</p>
<p>这样做使得接收内容彻底与数字包裹接收的顺序撇开了关系,接收信息者得到了 N 个已编码的包裹，每个都配有不同的系数，所以它能够解开所有的方程，还原最原始的数据。这种打破固有顺序所带来的灵活性，意味着整个信息系统将更加高效。也意味着曾经在 TCP/IP 中发生的严重的数据传递延迟甚至数据包丢失的情况一去不复返。因为顺序不再重要，数字包裹可以在网络中以各种不同的路径进行传递，这样会提升安全性。也就没有人能够切入到私人的通信网络中。</p>
<h1 id="线性网络编码"><a href="#线性网络编码" class="headerlink" title="线性网络编码"></a>线性网络编码</h1><h2 id="线性网络编码-1"><a href="#线性网络编码-1" class="headerlink" title="线性网络编码"></a>线性网络编码</h2><p>假设网络是有向的，执行线性网络编码时每个节点收到所有连入线路的数据后，再执行编码，然后把数据从连出线路发出。新的数据包括执行线性编码所用的系数以及合成后的数据。</p>
<img src="线性网络编码.png"/>

<h2 id="随机线性网络编码"><a href="#随机线性网络编码" class="headerlink" title="随机线性网络编码"></a>随机线性网络编码</h2><p>随机线性网络编码可以取得更好的组播传输速率，较为实用。在实际网络中，节点会将来自连入线路的封包缓存起来，当节点需要发送封包时再将缓存的封包执行网络编码，然后发出。</p>
<img src="随机线性网络编码.png"/>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ljd1996.github.io/2019/02/07/Java%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/07/Java%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">Java面向对象设计模式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-07 15:11:24" itemprop="dateCreated datePublished" datetime="2019-02-07T15:11:24+08:00">2019-02-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">语言</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          
            <span id="/2019/02/07/Java%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="post-meta-item leancloud_visitors" data-flag-title="Java面向对象设计模式" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/02/07/Java%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/02/07/Java%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h1><h2 id="饿汉模式"><a href="#饿汉模式" class="headerlink" title="饿汉模式"></a>饿汉模式</h2><p><strong>线程安全的饿汉模式：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleTon</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1、构造方法私有化</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingleTon</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、创建类的唯一实例</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SingleTon instance = <span class="keyword">new</span> SingleTon();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//提供一个获取唯一实例的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleTon <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>饿汉模式在类加载(包括初始化)后便会实例化 SingleTon 对象，但是在类加载(不初始化)，SingleTon 不会被实例化，这时相当于懒汉模式。</strong>关于类加载的过程，可参考: <a href="https://ljd1996.github.io/2018/06/11/JVM%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD">JVM类加载流程</a>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Method m = ClassLoader.class.getDeclaredMethod(&quot;findLoadedClass&quot;, <span class="keyword">new</span> Class[]&#123;String.class&#125;);</span><br><span class="line">        m.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        ClassLoader cl = ClassLoader.getSystemClassLoader();</span><br><span class="line">        Object test1 = m.invoke(cl, <span class="string">&quot;SingleTon&quot;</span>);</span><br><span class="line">        System.out.println(test1 != <span class="keyword">null</span>);</span><br><span class="line">        System.out.println(SingleTon.class.getName());</span><br><span class="line">        Object test2 = m.invoke(cl, <span class="string">&quot;SingleTon&quot;</span>);</span><br><span class="line">        System.out.println(test2 != <span class="keyword">null</span>);</span><br><span class="line">        SingleTon.getInstance();</span><br><span class="line">        Object test3 = m.invoke(cl, <span class="string">&quot;SingleTon&quot;</span>);</span><br><span class="line">        System.out.println(test3 != <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingleTon</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingleTon</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;constructor&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SingleTon instance = <span class="keyword">new</span> SingleTon();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleTon <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="keyword">false</span></span><br><span class="line">SingleTon</span><br><span class="line"><span class="keyword">true</span></span><br><span class="line">constructor</span><br><span class="line"><span class="keyword">true</span></span><br></pre></td></tr></table></figure>

<p>可以看到 SingleTon 类已经被加载了，但是并没有执行初始化过程，也就没有实例化 SingleTon 对象。直到调用 getInstance 方法时(也可以是调用SingleTon中的静态变量)才会实例化。</p>
<h2 id="懒汉模式"><a href="#懒汉模式" class="headerlink" title="懒汉模式"></a>懒汉模式</h2><p><strong>线程不安全的懒汉模式：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleTon</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1、构造方法私有化</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingleTon</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、创建类的唯一实例</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SingleTon instance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//提供一个获取唯一实例的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleTon <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            instance = <span class="keyword">new</span> SingleTon();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>线程安全的懒汉模式，双重检查锁定：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleTon</span> </span>&#123;</span><br><span class="line">    <span class="comment">//1、构造方法私有化</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingleTon</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、创建类的唯一实例</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> SingleTon instance;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//提供一个获取唯一实例的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleTon <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (SingleTon.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> SingleTon();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里之所以要加 volatile 标识，是因为 synchronized 无法禁止指令重排序，而 instance 的赋值过程可以拆分为三个步骤：</p>
<ol>
<li>申请一个内存区域（空白内存）；</li>
<li>调用构造方法等进行初始化（写内存）；</li>
<li>将对象引用赋值给变量；</li>
</ol>
<p>而 2 和 3 可能发生重排序，当线程 T1 拿到锁开始创建实例，如果发生了重排序，此时 instance 已经被赋值，但是对象没有初始化，如果此时 instance 被同步到了主内存，当线程 T2 调用 getInstance 方法时，发现 instance 不为空，则直接返回使用，进而出错。</p>
<p><strong>线程安全的懒汉模式，静态内部类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleTon</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingleTon</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> SingleTon instance = <span class="keyword">new</span> SingleTon();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleTon <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> LazyHolder.instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="枚举单例"><a href="#枚举单例" class="headerlink" title="枚举单例"></a>枚举单例</h2><p>enum有且仅有private的构造器，防止外部的额外构造，这恰好和单例模式吻合，也为保证单例性做了一个铺垫。枚举会被编译成如下形式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">T</span> <span class="keyword">extends</span> <span class="title">Enum</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，Enum是Java提供给编译器的一个用于继承的类。枚举量的实现其实是public static final T 类型的未初始化变量，之后，会在静态代码中对枚举量进行初始化。所以，如果用枚举去实现一个单例，这样的加载时间其实有点类似于饿汉模式，并没有起到lazy-loading的作用。</p>
<p>对于序列化和反序列化，因为每一个枚举类型和枚举变量在JVM中都是唯一的，即Java在序列化和反序列化枚举时做了特殊的规定，枚举的writeObject、readObject、readObjectNoData、writeReplace和readResolve等方法是被编译器禁用的，因此也不存在实现序列化接口后调用readObject会破坏单例的问题。</p>
<p>对于线程安全方面，类似于普通的饿汉模式，通过在第一次调用时的静态初始化创建的对象是线程安全的。</p>
<p>因此，选择枚举作为Singleton的实现方式，相对于其他方式尤其是类似的饿汉模式主要有以下优点：</p>
<ol>
<li>代码简单</li>
<li>自由序列化</li>
</ol>
<p>单例的枚举实现在《Effective Java》中有提到，因为其功能完整、使用简洁、无偿地提供了序列化机制、在面对复杂的序列化或者反射攻击时仍然可以绝对防止多次实例化等优点，单元素的枚举类型被作者认为是实现Singleton的最佳方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleTon</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingleTon</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingleTon <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SingletonEnum.INSTANCE.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">enum</span> <span class="title">SingletonEnum</span></span>&#123;</span><br><span class="line">        INSTANCE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> SingleTon singleton;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//JVM会保证此方法绝对只调用一次</span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">SingletonEnum</span><span class="params">()</span></span>&#123;</span><br><span class="line">            singleton = <span class="keyword">new</span> SingleTon();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> SingleTon <span class="title">getInstance</span><span class="params">()</span></span>&#123;</span><br><span class="line">            <span class="keyword">return</span> singleton;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更简单:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">EasySingleton</span> </span>&#123;</span><br><span class="line">    INSTANCE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="单例模板"><a href="#单例模板" class="headerlink" title="单例模板"></a>单例模板</h2><p>不像C++,C++可以通过直接new T()实现泛型单例,但Java不可以.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleTonBase</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentMap&lt;Class, Object&gt; map = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getInstance</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">        Object ob = map.get(type);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (ob == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (map) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (map.get(type) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        ob = type.newInstance();</span><br><span class="line">                        map.put(type, ob);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException | IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (T) ob;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">remove</span><span class="params">(Class&lt;T&gt; type)</span> </span>&#123;</span><br><span class="line">        map.remove(type);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="反射攻击"><a href="#反射攻击" class="headerlink" title="反射攻击"></a>反射攻击</h2><p>反射可以获取到单例的私有构造函数，从而破坏单例。如果要抵御这种攻击，就要修改构造器，让他在被要求创建第二个实例的时候抛出异常。可以通过一个boolean类型的静态变量来标识。但是依然可以通过反射的方式来修改标识的值，从而破坏单例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;the program is ready to start...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        SingTo singTo = SingTo.getInstance();</span><br><span class="line"></span><br><span class="line">        Class&lt;SingTo&gt; cls = SingTo.class;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Field flag = cls.getDeclaredField(<span class="string">&quot;flag&quot;</span>);</span><br><span class="line">            flag.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            flag.set(<span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">            Constructor&lt;SingTo&gt; constructor = cls.getDeclaredConstructor(<span class="keyword">null</span>);</span><br><span class="line">            constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            SingTo singTo1 = constructor.newInstance();</span><br><span class="line"></span><br><span class="line">            System.out.println(singTo == singTo1);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException | InstantiationException</span><br><span class="line">                | NoSuchMethodException | InvocationTargetException</span><br><span class="line">                | NoSuchFieldException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>枚举单例可以避免反射攻击，如下调用newInstance会报错：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EnumSingleton enumSingleton = EnumSingleton.INSTANCE;</span><br><span class="line">enumSingleton.test();</span><br><span class="line">Class&lt;EnumSingleton&gt; cls = EnumSingleton.class;</span><br><span class="line">System.out.println(enumSingleton == cls.newInstance());</span><br></pre></td></tr></table></figure>

<p>因为类的cls.newInstance()方法最后调用了Constructor的newInstance方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((clazz.getModifiers() &amp; Modifier.ENUM) != <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Cannot reflectively create enum objects&quot;</span>);</span><br></pre></td></tr></table></figure>

<h2 id="序列化与单例"><a href="#序列化与单例" class="headerlink" title="序列化与单例"></a>序列化与单例</h2><p>为了防止反射破坏单例，在私有构造方法里面加入了一个同步变量的判断，确保构造方法只调用一次。但是仍然无法阻止序列化破坏单例，而枚举类可以防止。</p>
<p>Java规范中规定，每一个枚举类型极其定义的枚举变量在JVM中都是唯一的，因此在枚举类型的序列化和反序列化上，Java做了特殊的规定。<br>在序列化的时候Java仅仅是将枚举对象的name属性输出到结果中，反序列化的时候则是通过 java.lang.Enum 的 valueOf() 方法来根据名字查找枚举对象。 也就是说，以下面枚举为例，序列化的时候只将 DATASOURCE 这个名称输出，反序列化的时候再通过这个名称，查找对于的枚举类型，因此反序列化后的实例也会和之前被序列化的对象实例相同。</p>
<p>在readObj底层实现上，是通过反射调用私有构造方法来返回实例的，但是在这段代码后面，还会检测该类是否有一个readResolve（）方法，如果有，就返回这个方法返回值。这个方法必然是为了解决序列化破坏单例的，我们可以添加这个方法，让其返回单例。</p>
<p>对于枚举单例之外的其他方式实现的单例模式，如果既想要做到可序列化，又想要反序列化为同一对象，则必须实现readResolve方法。</p>
<p>所以在单例类中添加如下方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">readResolve</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> instance();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="工厂模式"><a href="#工厂模式" class="headerlink" title="工厂模式"></a>工厂模式</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><ol>
<li>抽象工厂角色：这是工厂方法模式的核心，它与应用程序无关。是具体工厂角色必须实现的接口或者必须继承的父类。在java中它由抽象类或者接口来实现。</li>
<li>具体工厂角色：它含有和具体业务逻辑有关的代码。由应用程序调用以创建对应的具体产品的对象。 </li>
<li>抽象产品角色：它是具体产品继承的父类或者是实现的接口。在java中一般有抽象类或者接口来实现。 </li>
<li>具体产品角色：具体工厂角色所创建的对象就是此角色的实例。在java中由具体的类来实现。</li>
</ol>
<p>可以使用反射方法替代多个具体工厂角色，避免新建过多的具体工厂类。</p>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p><strong>抽象工厂接口：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HairFactory</span> </span>&#123;</span><br><span class="line">    <span class="function">Hair <span class="title">create</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体工厂类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LeftHairFactory</span> <span class="keyword">implements</span> <span class="title">HairFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Hair <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LeftHair();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RightHairFactory</span> <span class="keyword">implements</span> <span class="title">HairFactory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Hair <span class="title">create</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RightHair();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>抽象产品接口：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Hair</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Hair</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体产品类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LeftHair</span> <span class="keyword">extends</span> <span class="title">Hair</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LeftHair</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;LeftHair...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RightHair</span> <span class="keyword">extends</span> <span class="title">Hair</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RightHair</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;RightHair...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>使用反射的方法：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HairFactoryByReflect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Hair <span class="title">getHairByClass</span><span class="params">(Class c)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span>  (Hair) Class.forName(c.getName()).newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h1><h2 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h2><p>观察者模式是对象的行为模式，又叫发布-订阅(Publish/Subscribe)模式、模型-视图(Model/View)模式、源-监听器(Source/Listener)模式或从属者(Dependents)模式。观察者模式定义了一种一对多的依赖关系，让多个观察者对象同时监听某一个主题对象。这个主题对象在状态上发生变化时，会通知所有观察者对象，使它们能够自动更新自己。</p>
<p>观察者模式所涉及的角色有：</p>
<ul>
<li>抽象主题(Subject)角色：抽象主题角色把所有对观察者对象的引用保存在一个集合里，每个主题都可以有任何数量的观察者。抽象主题提供一个接口，可以增加和删除观察者对象，抽象主题角色又叫做抽象被观察者(Observable)角色。</li>
<li>具体主题(ConcreteSubject)角色：将有关状态存入具体观察者对象；在具体主题的内部状态改变时，给所有登记过的观察者发出通知。具体主题角色又叫做具体被观察者(Concrete Observable)角色。</li>
<li>抽象观察者(Observer)角色：为所有的具体观察者定义一个接口，在得到主题的通知时更新自己，这个接口叫做更新接口。</li>
<li>具体观察者(ConcreteObserver)角色：存储与主题的状态自恰的状态。具体观察者角色实现抽象观察者角色所要求的更新接口，以便使本身的状态与主题的状态 像协调。如果需要，具体观察者角色可以保持一个指向具体主题对象的引用。</li>
</ul>
<h2 id="实例-1"><a href="#实例-1" class="headerlink" title="实例"></a>实例</h2><p><strong>抽象主题角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 用来保存注册的观察者对象</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Observer&gt; list = <span class="keyword">new</span> ArrayList&lt;Observer&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 注册观察者对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">attach</span><span class="params">(Observer observer)</span></span>&#123;</span><br><span class="line">        list.add(observer);</span><br><span class="line">        System.out.println(<span class="string">&quot;Attached an observer&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除观察者对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">detach</span><span class="params">(Observer observer)</span></span>&#123;</span><br><span class="line">        list.remove(observer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通知所有注册的观察者对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nodifyObservers</span><span class="params">(String newState)</span></span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(Observer observer : list)&#123;</span><br><span class="line">            observer.update(newState);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体主题角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteSubject</span> <span class="keyword">extends</span> <span class="title">Subject</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String state;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getState</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">change</span><span class="params">(String newState)</span></span>&#123;</span><br><span class="line">        state = newState;</span><br><span class="line">        System.out.println(<span class="string">&quot;主题状态为：&quot;</span> + state);</span><br><span class="line">        <span class="comment">// 状态发生改变，通知各个观察者</span></span><br><span class="line">        <span class="keyword">this</span>.nodifyObservers(state);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>抽象观察者角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(String state)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体观察者角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteObserver</span> <span class="keyword">implements</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 观察者的状态</span></span><br><span class="line">    <span class="keyword">private</span> String observerState;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(String state)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 更新观察者的状态，使其与目标的状态保持一致</span></span><br><span class="line">        observerState = state;</span><br><span class="line">        System.out.println(<span class="string">&quot;状态为：&quot;</span> + observerState);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建主题对象</span></span><br><span class="line">        ConcreteSubject subject = <span class="keyword">new</span> ConcreteSubject();</span><br><span class="line">        <span class="comment">// 创建观察者对象</span></span><br><span class="line">        Observer observer = <span class="keyword">new</span> ConcreteObserver();</span><br><span class="line">        <span class="comment">// 将观察者对象登记到主题对象上</span></span><br><span class="line">        subject.attach(observer);</span><br><span class="line">        <span class="comment">// 改变主题对象的状态</span></span><br><span class="line">        subject.change(<span class="string">&quot;new state&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="代理-委托模式"><a href="#代理-委托模式" class="headerlink" title="代理/委托模式"></a>代理/委托模式</h1><h2 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h2><p>当不能直接访问一个对象时，可以使用代理来间接访问，比如对象在另外一台机器上，或者对象被持久化了，对象是受保护的。代理模式侧重于控制对对象的访问，代理类可以对它的客户隐藏一个对象的具体信息。</p>
<p>静态代理模式的代理类只是实现了特定类的代理，如果代理类对象的方法越多，你就得写越多的重复的代码，使用动态代理可以比较好地解决这个问题，动态代理可以动态的生成代理类，实现对不同类下的不同方法的代理。</p>
<p>静态代理和动态代理的区别：</p>
<ol>
<li>静态代理在代理前就知道要代理的是哪个对象，而动态代理是运行时才知道；</li>
<li>静态代理一般只能代理一个类，而动态代理能代理实现了接口的多个类；</li>
</ol>
<h2 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h2><h3 id="概述-3"><a href="#概述-3" class="headerlink" title="概述"></a>概述</h3><p>当使用静态代理模式的时候，我们常常在一个代理类中创建一个对象的实例。</p>
<p>参与者：</p>
<ul>
<li>被代理对象基类（Subject）：定义一个接口。</li>
<li>具体被代理对象类（ConcreteSubject）：实现接口的方法。</li>
<li>代理类（Proxy）：内部有被代理对象的成员变量，且直接在内部实例化它，代理类也实现了被代理对象基类的方法。</li>
</ul>
<h3 id="实例-2"><a href="#实例-2" class="headerlink" title="实例"></a>实例</h3><p><strong>被代理对象基类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">operate</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体被代理对象类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteSubject</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;do something...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>代理类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Subject subject = <span class="keyword">new</span> ConcreteSubject();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 调用目标之前可以做相关操作</span></span><br><span class="line">        System.out.println(<span class="string">&quot;before....&quot;</span>);</span><br><span class="line">        subject.operate();</span><br><span class="line">        <span class="comment">// 调用目标之后可以做相关操作</span></span><br><span class="line">        System.out.println(<span class="string">&quot;after....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Subject subject = <span class="keyword">new</span> Proxy();</span><br><span class="line">        subject.operate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Jdk动态代理"><a href="#Jdk动态代理" class="headerlink" title="Jdk动态代理"></a>Jdk动态代理</h2><h3 id="概述-4"><a href="#概述-4" class="headerlink" title="概述"></a>概述</h3><p>jdk动态代理是利用反射机制生成一个实现代理接口的匿名类，在调用业务方法前调用InvocationHandler处理。代理类必须实现InvocationHandler接口，并且，JDK动态代理只能代理实现了接口的类，没有实现接口的类是不能实现JDK动态代理。</p>
<p>使用JDK动态代理类基本步骤：</p>
<ol>
<li>编写需要被代理的类和接口；</li>
<li>编写代理类，需要实现InvocationHandler接口，重写invoke方法；</li>
<li>使用<code>Proxy.newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h)</code>动态创建代理类对象，通过代理类对象调用业务方法。</li>
</ol>
<h3 id="实例-3"><a href="#实例-3" class="headerlink" title="实例"></a>实例</h3><p><strong>被代理对象基类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">operate</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体被代理对象类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteSubject</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;do something...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>代理类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Proxy</span><span class="params">(Object target)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object obj, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before....&quot;</span>);</span><br><span class="line">        <span class="comment">// 使用方法的反射</span></span><br><span class="line">        Object invoke = method.invoke(target, args);</span><br><span class="line">        System.out.println(<span class="string">&quot;after....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> invoke;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Subject subject = <span class="keyword">new</span> ConcreteSubject();</span><br><span class="line">        Class&lt;?&gt; clazz = subject.getClass();</span><br><span class="line">        Proxy proxy = <span class="keyword">new</span> Proxy(subject);</span><br><span class="line">        Subject subjectProxy = (Subject) Proxy.newProxyInstance(clazz.getClassLoader(), clazz.getInterfaces(), proxy);</span><br><span class="line">        subjectProxy.operate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Cglib动态代理"><a href="#Cglib动态代理" class="headerlink" title="Cglib动态代理"></a>Cglib动态代理</h2><h3 id="概述-5"><a href="#概述-5" class="headerlink" title="概述"></a>概述</h3><p>Cglib是针对类来实现代理的，类不用实现接口，Cglib会对目标类产生一个代理子类，通过方法拦截技术对过滤父类的方法调用，因此不能代理声明为final类型的类和方法。代理子类需要实现MethodInterceptor接口。</p>
<p>Cglib实现的MethodInterceptor接口在spring-core包。</p>
<h3 id="实例-4"><a href="#实例-4" class="headerlink" title="实例"></a>实例</h3><p><strong>被代理对象类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;do something...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>代理类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">MethodInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Enhancer enhancer = <span class="keyword">new</span> Enhancer();</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getProxyObj</span><span class="params">(Class clazz)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//设置父类</span></span><br><span class="line">        enhancer.setSuperclass(clazz);</span><br><span class="line">        enhancer.setCallback(<span class="keyword">this</span>);</span><br><span class="line">        enhancer.setUseCache(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> enhancer.create();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object o, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before....&quot;</span>);</span><br><span class="line">        <span class="comment">// 代理类对象实例调用父类方法</span></span><br><span class="line">        methodProxy.invokeSuper(o, args);</span><br><span class="line">        System.out.println(<span class="string">&quot;after....&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Proxy proxy = <span class="keyword">new</span> Proxy();</span><br><span class="line">        Subject subjectProxy = (Subject) proxy.getProxyObj(Subject.class);</span><br><span class="line">        subjectProxy.operate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="装饰模式"><a href="#装饰模式" class="headerlink" title="装饰模式"></a>装饰模式</h1><h2 id="概述-6"><a href="#概述-6" class="headerlink" title="概述"></a>概述</h2><p>装饰模式(Decorator)，动态地给一个对象添加一些额外的职责，就增加功能来说，装饰模式比生成子类更为灵活。装饰器模式关注于在一个对象上动态的添加方法，因此，当使用装饰器模式的时候，我们通常的做法是将原始对象作为一个参数传给装饰者的构造器。</p>
<p>参与者：</p>
<ul>
<li>被装饰对象基类（Subject）：定义一个接口。</li>
<li>具体被装饰对象类（ConcreteSubject）：实现接口的方法。</li>
<li>装饰者类（Decorator）：内部有被装饰对象的成员变量，其实例由外部传入，装饰者类也实现了被装饰对象基类的方法。</li>
</ul>
<h2 id="实例-5"><a href="#实例-5" class="headerlink" title="实例"></a>实例</h2><p><strong>被装饰对象基类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">operate</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体被装饰对象类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteSubject</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;do something...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>装饰者类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Decorator</span> <span class="keyword">implements</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Subject subject;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Decorator</span><span class="params">(Subject subject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.subject = subject;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 调用目标之前可以做相关操作</span></span><br><span class="line">        System.out.println(<span class="string">&quot;before....&quot;</span>);</span><br><span class="line">        subject.operate();</span><br><span class="line">        <span class="comment">// 调用目标之后可以做相关操作</span></span><br><span class="line">        System.out.println(<span class="string">&quot;after....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Subject subject = <span class="keyword">new</span> ConcreteSubject();</span><br><span class="line">        Subject decorator = <span class="keyword">new</span> Decorator(subject);</span><br><span class="line">        decorator.operate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="外观-门面-Facade-模式"><a href="#外观-门面-Facade-模式" class="headerlink" title="外观/门面(Facade)模式"></a>外观/门面(Facade)模式</h1><h2 id="概述-7"><a href="#概述-7" class="headerlink" title="概述"></a>概述</h2><p>隐藏了系统的复杂性，并向客户端提供了一个可以访问系统的接口。这种类型的设计模式属于结构性模式。为子系统中的一组接口提供了一个统一的访问接口，这个接口使得子系统更容易被访问或者使用。 </p>
<ol>
<li>门面（Facede）角色：外观模式的核心。它被客户角色调用，它熟悉子系统的功能。内部根据客户角色的需求预定了几种功能的组合。</li>
<li>子系统角色：实现了子系统的功能。它对客户角色和Facade是未知的。它内部可以有系统内的相互交互，也可以由供外界调用的接口。</li>
<li>客户角色：通过调用Facede来完成要实现的功能。</li>
</ol>
<h2 id="实例-6"><a href="#实例-6" class="headerlink" title="实例"></a>实例</h2><p>每个Computer都有CPU、Memory、Disk。在Computer开启和关闭的时候，相应的部件也会开启和关闭，所以，使用了该外观模式后，会使用户和部件之间解耦。</p>
<p><strong>子系统：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CPU</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;CPU start...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;CPU shutdown...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Memory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Memory start...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Memory shutdown...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>门面：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Computer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> CPU cpu;</span><br><span class="line">    <span class="keyword">private</span> Memory memory;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Computer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        cpu = <span class="keyword">new</span> CPU();</span><br><span class="line">        memory = <span class="keyword">new</span> Memory();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Computer start begin...&quot;</span>);</span><br><span class="line">        cpu.start();</span><br><span class="line">        memory.start();</span><br><span class="line">        System.out.println(<span class="string">&quot;Computer start end...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Computer shutdown begin...&quot;</span>);</span><br><span class="line">        cpu.shutdown();</span><br><span class="line">        memory.shutdown();</span><br><span class="line">        System.out.println(<span class="string">&quot;Computer shutdown end...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Computer computer = <span class="keyword">new</span> Computer();</span><br><span class="line">    computer.start();</span><br><span class="line">    System.out.println(<span class="string">&quot;=========&quot;</span>);</span><br><span class="line">    computer.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h1><h2 id="概述-8"><a href="#概述-8" class="headerlink" title="概述"></a>概述</h2><p>命令模式是对命令的封装。命令模式把发出命令的责任和执行命令的责任分割开，委派给不同的对象。</p>
<p>每一个命令都是一个操作：请求的一方发出请求要求执行一个操作；接收的一方收到请求，并执行操作。命令模式允许请求的一方和接收的一方独立开来，使得请求的一方不必知道接收请求的一方的接口，更不必知道请求是怎么被接收，以及操作是否被执行、何时被执行，以及是怎么被执行的。命令允许请求的一方和接收请求的一方能够独立演化，从而具有以下的优点：</p>
<ul>
<li>命令模式使新的命令很容易地被加入到系统里。</li>
<li>允许接收请求的一方决定是否要否决请求。</li>
<li>能较容易地设计一个命令队列。</li>
<li>可以容易地实现对请求的撤销和恢复。</li>
<li>在需要的情况下，可以较容易地将命令记入日志。</li>
</ul>
<p>命令模式涉及到五个角色，它们分别是：</p>
<ul>
<li>客户端(Client)角色：创建一个具体命令(ConcreteCommand)对象并确定其接收者。</li>
<li>命令(Command)角色：声明了一个给所有具体命令类的抽象接口。</li>
<li>具体命令(ConcreteCommand)角色：定义一个接收者和行为之间的弱耦合；实现execute()方法，负责调用接收者的相应操作。execute()方法通常叫做执行方法。</li>
<li>请求者(Invoker)角色：负责调用命令对象执行请求，相关的方法叫做行动方法。</li>
<li>接收者(Receiver)角色：负责具体实施和执行一个请求。任何一个类都可以成为接收者，实施和执行请求的方法叫做行动方法。</li>
</ul>
<h2 id="实例-7"><a href="#实例-7" class="headerlink" title="实例"></a>实例</h2><p><strong>接收者角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Receiver</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 真正执行命令相应的操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;执行操作&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>抽象命令角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Command</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体命令角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteCommand</span> <span class="keyword">implements</span> <span class="title">Command</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 持有相应的接收者对象</span></span><br><span class="line">    <span class="keyword">private</span> Receiver receiver = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcreteCommand</span><span class="params">(Receiver receiver)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.receiver = receiver;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 通常会转调接收者对象的相应方法，让接收者来真正执行功能</span></span><br><span class="line">        receiver.action();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>请求者角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Invoker</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 持有命令对象</span></span><br><span class="line">    <span class="keyword">private</span> Command command = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Invoker</span><span class="params">(Command command)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.command = command;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">action</span><span class="params">()</span></span>&#123;</span><br><span class="line">        command.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建接收者</span></span><br><span class="line">        Receiver receiver = <span class="keyword">new</span> Receiver();</span><br><span class="line">        <span class="comment">// 创建命令对象，设定它的接收者</span></span><br><span class="line">        Command command = <span class="keyword">new</span> ConcreteCommand(receiver);</span><br><span class="line">        <span class="comment">// 创建请求者，把命令对象设置进去</span></span><br><span class="line">        Invoker invoker = <span class="keyword">new</span> Invoker(command);</span><br><span class="line">        <span class="comment">// 执行方法</span></span><br><span class="line">        invoker.action();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="责任链模式"><a href="#责任链模式" class="headerlink" title="责任链模式"></a>责任链模式</h1><h2 id="概述-9"><a href="#概述-9" class="headerlink" title="概述"></a>概述</h2><p>责任链模式是一种对象的行为模式。在责任链模式里，很多对象由每一个对象对其下家的引用而连接起来形成一条链。请求在这个链上传递，直到链上的某一个对象决定处理此请求。发出这个请求的客户端并不知道链上的哪一个对象最终处理这个请求，这使得系统可以在不影响客户端的情况下动态地重新组织和分配责任，如Java语言的try catch。</p>
<p>责任链模式涉及到的角色如下所示：</p>
<ul>
<li>抽象处理者(Handler)角色：定义出一个处理请求的接口。如果需要，接口可以定义出一个方法以设定和返回对下家的引用。这个角色通常由一个Java抽象类或者Java接口实现。</li>
<li>具体处理者(ConcreteHandler)角色：具体处理者接到请求后，可以选择将请求处理掉，或者将请求传给下家。由于具体处理者持有对下家的引用，因此，如果需要，具体处理者可以访问下家。</li>
</ul>
<h2 id="实例-8"><a href="#实例-8" class="headerlink" title="实例"></a>实例</h2><p><strong>抽象处理者角色：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 持有后继的责任对象</span></span><br><span class="line">    <span class="keyword">protected</span> Handler nextHandler;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">handleRequest</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Handler <span class="title">getNextHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> nextHandler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNextHandler</span><span class="params">(Handler nextHandler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.nextHandler = nextHandler;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体处理者角色：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(getNextHandler() != <span class="keyword">null</span>) &#123;            </span><br><span class="line">            System.out.println(<span class="string">&quot;放过请求&quot;</span>);</span><br><span class="line">            getNextHandler().handleRequest();            </span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;            </span><br><span class="line">            System.out.println(<span class="string">&quot;处理请求&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 组装责任链</span></span><br><span class="line">        Handler handler1 = <span class="keyword">new</span> ConcreteHandler();</span><br><span class="line">        Handler handler2 = <span class="keyword">new</span> ConcreteHandler();</span><br><span class="line">        handler1.setSuccessor(handler2);</span><br><span class="line">        <span class="comment">// 提交请求</span></span><br><span class="line">        handler1.handleRequest();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="享元-Flyweight-模式"><a href="#享元-Flyweight-模式" class="headerlink" title="享元(Flyweight)模式"></a>享元(Flyweight)模式</h1><h2 id="概述-10"><a href="#概述-10" class="headerlink" title="概述"></a>概述</h2><p>享元模式(Flyweight Pattern)：运用共享技术有效地支持大量细粒度对象的复用。系统只使用少量的对象，而这些对象都很相似，状态变化很小，可以实现对象的多次复用。由于享元模式要求能够共享的对象必须是细粒度对象，因此它又称为轻量级模式，它是一种对象d结构模式。</p>
<p>Java中字符串常量，Android中的Message，线程池等都运用了享元模式，单纯享元模式所涉及到的角色如下：</p>
<ul>
<li>抽象享元(Flyweight)角色 ：给出一个抽象接口，以规定出所有具体享元角色需要实现的方法。</li>
<li>具体享元(ConcreteFlyweight)角色：实现抽象享元角色所规定出的接口。</li>
<li>享元工厂(FlyweightFactory)角色 ：本角色负责创建和管理享元角色。当一个客户端对象调用一个享元对象的时候，享元工厂角色会检查系统中是否已经有一个符合要求的享元对象，如果已经有了，享元工厂角色就应当提供这个已有的享元对象；如果系统中没有一个适当的享元对象的话，享元工厂角色就应当创建一个合适的享元对象。</li>
</ul>
<h2 id="实例-9"><a href="#实例-9" class="headerlink" title="实例"></a>实例</h2><p><strong>抽象享元角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Flyweight</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">(String state)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体享元角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteFlyweight</span> <span class="keyword">implements</span> <span class="title">Flyweight</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Character intrinsicState = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConcreteFlyweight</span><span class="params">(Character state)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.intrinsicState = state;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operation</span><span class="params">(String state)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Intrinsic State = &quot;</span> + <span class="keyword">this</span>.intrinsicState);</span><br><span class="line">        System.out.println(<span class="string">&quot;Extrinsic State = &quot;</span> + state);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>享元工厂角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlyweightFactory</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;Character, Flyweight&gt; files = <span class="keyword">new</span> HashMap&lt;Character, Flyweight&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Flyweight <span class="title">factory</span><span class="params">(Character state)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 先从缓存中查找对象</span></span><br><span class="line">        Flyweight fly = files.get(state);</span><br><span class="line">        <span class="keyword">if</span> (fly == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果对象不存在则创建一个新的Flyweight对象</span></span><br><span class="line">            fly = <span class="keyword">new</span> ConcreteFlyweight(state);</span><br><span class="line">            <span class="comment">// 把这个新的Flyweight对象添加到缓存中</span></span><br><span class="line">            files.put(state, fly);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> fly;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        FlyweightFactory factory = <span class="keyword">new</span> FlyweightFactory();</span><br><span class="line">        Flyweight fly = factory.factory(<span class="keyword">new</span> Character(<span class="string">&#x27;a&#x27;</span>));</span><br><span class="line">        fly.operation(<span class="string">&quot;First Call&quot;</span>);</span><br><span class="line"></span><br><span class="line">        fly = factory.factory(<span class="keyword">new</span> Character(<span class="string">&#x27;b&#x27;</span>));</span><br><span class="line">        fly.operation(<span class="string">&quot;Second Call&quot;</span>);</span><br><span class="line"></span><br><span class="line">        fly = factory.factory(<span class="keyword">new</span> Character(<span class="string">&#x27;a&#x27;</span>));</span><br><span class="line">        fly.operation(<span class="string">&quot;Third Call&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="模板模式"><a href="#模板模式" class="headerlink" title="模板模式"></a>模板模式</h1><h2 id="概述-11"><a href="#概述-11" class="headerlink" title="概述"></a>概述</h2><p>准备一个抽象类，将部分逻辑以具体方法以及具体构造函数的形式实现，然后声明一些抽象方法来迫使子类实现剩余的逻辑。不同的子类可以以不同的方式实现这些抽象方法，从而对剩余的逻辑有不同的实现，这就是模板方法模式的用意。模板方法的角色：</p>
<ul>
<li>抽象类（AbstractClass）：实现了模板方法，定义了算法的骨架。</li>
<li>具体类（ConcreteClass)：实现抽象类中的抽象方法，已完成完整的算法。</li>
</ul>
<h2 id="实例-10"><a href="#实例-10" class="headerlink" title="实例"></a>实例</h2><p><strong>抽象类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractImageLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 抽象类定义整个流程骨架</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">downloadImage</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 先获取最终的数据源URL</span></span><br><span class="line">        String finalImageUrl = getUrl();</span><br><span class="line">        <span class="comment">// 然后开始执行下载</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//以下是不同子类根据自身特性完成的具体步骤</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">getUrl</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebpImageLoader</span> <span class="keyword">extends</span> <span class="title">AbstractImageLoader</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;...&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JpgImageLoader</span> <span class="keyword">extends</span> <span class="title">AbstractImageLoader</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> String <span class="title">getUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;.....&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        AbstractImageLoader loader = <span class="keyword">new</span> WebpImageLoader();</span><br><span class="line">        loader.downloadImage();</span><br><span class="line">        loader = <span class="keyword">new</span> JpgImageLoader();</span><br><span class="line">        loader.downloadImage();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="策略模式"><a href="#策略模式" class="headerlink" title="策略模式"></a>策略模式</h1><h2 id="概述-12"><a href="#概述-12" class="headerlink" title="概述"></a>概述</h2><p>策略模式属于对象的行为模式。其用意是针对一组算法，将每一个算法封装到具有共同接口的独立的类中，从而使得它们可以相互替换，策略模式使得算法可以在不影响到客户端的情况下发生变化。策略模式是对算法的包装，是把使用算法的责任和算法本身分割开来，委派给不同的对象管理。策略模式通常把一个系列的算法包装到一系列的策略类里面，作为一个抽象策略类的子类。这个模式涉及到三个角色：</p>
<ul>
<li>环境(Context)角色：持有一个Strategy的引用。</li>
<li>抽象策略(Strategy)角色：这是一个抽象角色，通常由一个接口或抽象类实现。此角色给出所有的具体策略类所需的接口。</li>
<li>具体策略(ConcreteStrategy)角色：包装了相关的算法或行为。</li>
</ul>
<h2 id="实例-11"><a href="#实例-11" class="headerlink" title="实例"></a>实例</h2><p><strong>环境角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Context</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 持有一个具体策略的对象</span></span><br><span class="line">    <span class="keyword">private</span> Strategy strategy;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Context</span><span class="params">(Strategy strategy)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.strategy = strategy;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextInterface</span><span class="params">()</span> </span>&#123;        </span><br><span class="line">        strategy.strategyInterface();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>抽象策略角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Strategy</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">strategyInterface</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>具体策略角色类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteStrategyA</span> <span class="keyword">implements</span> <span class="title">Strategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">strategyInterface</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 相关的业务</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteStrategyB</span> <span class="keyword">implements</span> <span class="title">Strategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">strategyInterface</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 相关的业务</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteStrategyC</span> <span class="keyword">implements</span> <span class="title">Strategy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">strategyInterface</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 相关的业务</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>客户端类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Strategy strategy = <span class="keyword">new</span> ConcreteStrategyB();</span><br><span class="line">        Context context = <span class="keyword">new</span> Context(strategy);</span><br><span class="line">        <span class="comment">// 通过不同的Strategy得到不同的结果</span></span><br><span class="line">        context.contextInterface();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ljd1996.github.io/2019/01/07/docker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/07/docker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">docker学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-07 14:32:02" itemprop="dateCreated datePublished" datetime="2019-01-07T14:32:02+08:00">2019-01-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E5%8F%B0/" itemprop="url" rel="index"><span itemprop="name">后台</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E5%8F%B0/Docker/" itemprop="url" rel="index"><span itemprop="name">Docker</span></a>
                </span>
            </span>

          
            <span id="/2019/01/07/docker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="docker学习笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/01/07/docker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/01/07/docker%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="镜像"><a href="#镜像" class="headerlink" title="镜像"></a>镜像</h1><h2 id="获取镜像"><a href="#获取镜像" class="headerlink" title="获取镜像"></a>获取镜像</h2><p>Docker 运行容器前需要本地存在对应的镜像，如果镜像不存在本地，Docker 会从镜像仓库下载（默认是 Docker Hub 公共注册服务器中的仓库）。</p>
<p>下载镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull image:tag</span><br><span class="line"><span class="meta">#</span><span class="bash"> 相当于</span></span><br><span class="line">docker pull registry.hub.docker.com/image:tag</span><br></pre></td></tr></table></figure>

<p>列出镜像：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>

<h2 id="创建镜像"><a href="#创建镜像" class="headerlink" title="创建镜像"></a>创建镜像</h2><h3 id="修改已有镜像"><a href="#修改已有镜像" class="headerlink" title="修改已有镜像"></a>修改已有镜像</h3><ol>
<li>使用本地镜像启动容器: docker run -i -t ubuntu:12.04 /bin/bash</li>
<li>修改</li>
<li>提交: docker commit -m=”msg” -a=”author” container_id rep/name:tag </li>
</ol>
<p>提交参数：</p>
<ul>
<li>-m:提交的描述信息</li>
<li>-a:指定镜像作者</li>
<li>e218edb10161：容器ID</li>
<li>runoob/ubuntu:v2:指定要创建的目标镜像名</li>
</ul>
<h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FROM    centos:6.7</span><br><span class="line">MAINTAINER      Fisher <span class="string">&quot;fisher@sudops.com&quot;</span></span><br><span class="line"></span><br><span class="line">RUN     /bin/echo &#x27;root:123456&#x27; |chpasswd</span><br><span class="line">RUN     useradd runoob</span><br><span class="line">RUN     /bin/echo &#x27;runoob:123456&#x27; |chpasswd</span><br><span class="line">RUN     /bin/echo -e <span class="string">&quot;LANG=\&quot;en_US.UTF-8\&quot;&quot;</span> &gt;/etc/default/local</span><br><span class="line">EXPOSE  22</span><br><span class="line">EXPOSE  80</span><br><span class="line">ADD myApp /var/www</span><br><span class="line">EXPOSE 80</span><br><span class="line">CMD     /usr/sbin/sshd -D</span><br></pre></td></tr></table></figure>

<ul>
<li>使用<code>#</code>注释</li>
<li>每一个指令都会在镜像上创建一个新的层，每一个指令的前缀必须大写</li>
<li>一个镜像不能超过 127 层</li>
<li>第一条FROM指令指定使用哪个镜像源</li>
<li>MAINTAINER 表示维护者的信息</li>
<li>RUN 指令表示在镜像内执行的命令</li>
<li>ADD 命令复制本地文件到镜像</li>
<li>EXPOSE 命令向外部开放端口</li>
<li>CMD 命令描述容器启动后运行的程序</li>
<li>最后通过docker build命令来构建一个镜像</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> -t 添加 tag</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> dir 是 Dockerfile 所在的路径</span></span><br><span class="line">docker build -t runoob/centos:6.7 dir</span><br></pre></td></tr></table></figure>

<h3 id="本地文件系统导入"><a href="#本地文件系统导入" class="headerlink" title="本地文件系统导入"></a>本地文件系统导入</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat ubuntu-14.04-x86_64-minimal.tar.gz  |docker import - ubuntu:14.04</span><br></pre></td></tr></table></figure>

<h2 id="上传镜像"><a href="#上传镜像" class="headerlink" title="上传镜像"></a>上传镜像</h2><ul>
<li>登录: docker login -u user -p passwd -e email hub.c.163.com(网易蜂巢)</li>
<li>标签: docker tag image user_name/repo_name[:tag]</li>
<li>上传: docker push hub.c.163.com/user_name/repo_name[:tag]</li>
</ul>
<h2 id="导出与导入"><a href="#导出与导入" class="headerlink" title="导出与导入"></a>导出与导入</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 导出镜像到本地文件</span></span><br><span class="line">docker save -o file_name image:tag</span><br><span class="line"><span class="meta">#</span><span class="bash"> 载入镜像</span></span><br><span class="line">docker load --input file_name</span><br><span class="line"><span class="meta">#</span><span class="bash"> 或</span></span><br><span class="line">docker load &lt; file_name</span><br></pre></td></tr></table></figure>

<h2 id="移除"><a href="#移除" class="headerlink" title="移除"></a>移除</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi name/id</span><br></pre></td></tr></table></figure>

<h1 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h1><h2 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 运行容器</span></span><br><span class="line">docker run image:tag cmd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 交互式运行容器</span></span><br><span class="line">docker run -i -t image:tag cmd</span><br><span class="line"><span class="meta">#</span><span class="bash"> 停止容器</span></span><br><span class="line">docker stop id/name</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重启容器</span></span><br><span class="line">docket stop id/name</span><br></pre></td></tr></table></figure>

<ul>
<li>-t: 在新容器内指定一个伪终端或终端</li>
<li>-i: 允许对容器内的标准输入 (STDIN) 进行交互</li>
<li>-d: 后台启动一个容器</li>
<li>-p local_port:container_port: 端口映射</li>
</ul>
<h2 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h2><h3 id="attach"><a href="#attach" class="headerlink" title="attach"></a>attach</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker attach name/id</span><br></pre></td></tr></table></figure>

<h3 id="nsenter"><a href="#nsenter" class="headerlink" title="nsenter"></a>nsenter</h3><h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm name/id</span><br></pre></td></tr></table></figure>

<h1 id="数据管理"><a href="#数据管理" class="headerlink" title="数据管理"></a>数据管理</h1><h2 id="数据卷"><a href="#数据卷" class="headerlink" title="数据卷"></a>数据卷</h2><p>数据卷是一个可供一个或多个容器使用的特殊目录，它绕过 UFS，可以提供很多有用的特性：</p>
<ul>
<li>数据卷可以在容器之间共享和重用</li>
<li>对数据卷的修改会立马生效</li>
<li>对数据卷的更新，不会影响镜像</li>
<li>卷会一直存在，直到没有容器使用</li>
<li>数据卷的使用，类似于 Linux 下对目录或文件进行 mount。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 加载一个数据卷到容器的 /webapp 目录</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以在 Dockerfile 中使用 VOLUME 来添加一个或者多个新的卷到由该镜像创建的任意容器</span></span><br><span class="line">docker run -d -P --name web -v /webapp training/webapp python app.py</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 指定挂载一个本地主机目录到容器中</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 加载主机的 /src/webapp 目录到容器的 /opt/webapp 目录, 如果目录不存在会自动创建</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Dockerfile 中不支持这种用法，因为不同操作系统的路径格式不一样</span></span><br><span class="line">docker run -d -P --name web -v /src/webapp:/opt/webapp training/webapp python app.py</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 挂载数据卷的默认权限是读写，可以通过 :ro 指定为只读</span></span><br><span class="line">docker run -d -P --name web -v /src/webapp:/opt/webapp:ro training/webapp python app.py</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 挂载一个本地主机文件作为数据卷</span></span><br><span class="line">docker run --rm -it -v ~/.bash_history:/.bash_history ubuntu /bin/bash</span><br></pre></td></tr></table></figure>

<h2 id="数据卷容器"><a href="#数据卷容器" class="headerlink" title="数据卷容器"></a>数据卷容器</h2><p>如果有一些持续更新的数据需要在容器之间共享，最好创建数据卷容器。数据卷容器，其实就是一个正常的容器，专门用来提供数据卷供其它容器挂载的。</p>
<ol>
<li>创建一个命名的数据卷容器dbdata：</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -v /dbdata --name dbdata training/postgres echo Data-only container for postgres</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在其他容器中使用 –volumes-from 来挂载 dbdata 容器中的数据卷</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --volumes-from dbdata --name db1 training/postgres</span><br><span class="line">docker run -d --volumes-from dbdata --name db2 training/postgres</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以使用多个 --volumes-from 参数来从多个容器挂载多个数据卷，也可以从其他已经挂载了数据卷的容器来挂载数据卷。</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用 --volumes-from 参数所挂载数据卷的容器自己并不需要保持在运行状态</span></span><br><span class="line">docker run -d --name db3 --volumes-from db1 training/postgres</span><br></pre></td></tr></table></figure>

<p>如果删除了挂载的容器（包括 dbdata、db1 和 db2），数据卷并不会被自动删除。如果要删除一个数据卷，必须在删除最后一个还挂载着它的容器时使用 docker rm -v 命令来指定同时删除关联的容器。</p>
<h2 id="备份、恢复、迁移数据卷"><a href="#备份、恢复、迁移数据卷" class="headerlink" title="备份、恢复、迁移数据卷"></a>备份、恢复、迁移数据卷</h2><h3 id="备份"><a href="#备份" class="headerlink" title="备份"></a>备份</h3><p>首先使用 –volumes-from 标记来创建一个加载 dbdata 容器卷的容器，并从本地主机挂载当前到容器的 /backup 目录。命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --volumes-from dbdata -v $(pwd):/backup ubuntu tar cvf /backup/backup.tar /dbdata</span><br></pre></td></tr></table></figure>

<p>容器启动后，使用了 tar 命令来将 dbdata 卷备份为本地的 /backup/backup.tar。</p>
<h3 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h3><p>如果要恢复数据到一个容器，首先创建一个带有数据卷的容器 dbdata2。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -v /dbdata --name dbdata2 ubuntu /bin/bash</span><br></pre></td></tr></table></figure>

<p>然后创建另一个容器，挂载 dbdata2 的容器，并使用 untar 解压备份文件到挂载的容器卷中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --volumes-from dbdata2 -v $(pwd):/backup busybox tar xvf /backup/backup.tar</span><br></pre></td></tr></table></figure>

<h1 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h1><h2 id="外部访问容器"><a href="#外部访问容器" class="headerlink" title="外部访问容器"></a>外部访问容器</h2><ul>
<li>当使用 -P 标记时，Docker 会随机映射一个 49000~49900 的端口到内部容器开放的网络端口。</li>
<li>-p 则可以指定要映射的端口，并且，在一个指定端口上只可以绑定一个容器。支持的格式有 ip:hostPort:containerPort | ip::containerPort | hostPort:containerPort。</li>
</ul>
<p>映射所有接口地址:</p>
<ul>
<li>docker run -d -p 5000:5000 training/webapp python app.py: 默认会绑定本地所有接口上的所有地址。</li>
</ul>
<p>映射到指定地址的指定端口:</p>
<ul>
<li>使用 ip:hostPort:containerPort 格式指定映射使用一个特定地址</li>
</ul>
<p>映射到指定地址的任意端口:</p>
<ul>
<li>使用 ip::containerPort 绑定 localhost 的任意端口到容器的 5000 端口，本地主机会自动分配一个端口。</li>
</ul>
<p>还可以使用 udp 标记来指定 udp 端口:</p>
<ul>
<li>docker run -d -p 127.0.0.1:5000:5000/udp training/webapp python app.py</li>
</ul>
<p>查看映射端口配置:</p>
<ul>
<li>使用 docker port 来查看当前映射的端口配置，也可以查看到绑定的地址:port nostalgic_morse 5000</li>
</ul>
<h2 id="容器互联"><a href="#容器互联" class="headerlink" title="容器互联"></a>容器互联</h2><p>容器的连接（linking）系统是除了端口映射外，另一种跟容器中应用交互的方式。该系统会在源和接收容器之间创建一个隧道，接收容器可以看到源容器指定的信息。</p>
<h3 id="自定义容器命名"><a href="#自定义容器命名" class="headerlink" title="自定义容器命名"></a>自定义容器命名</h3><p>连接系统依据容器的名称来执行。因此，首先需要自定义一个好记的容器命名。使用 –name 标记可以为容器自定义命名。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d -P --name web training/webapp python app.py</span><br></pre></td></tr></table></figure>

<p>在执行 docker run 的时候如果添加 –rm 标记，则容器在终止后会立刻删除。注意，–rm 和 -d 参数不能同时使用。</p>
<h3 id="容器互联-1"><a href="#容器互联-1" class="headerlink" title="容器互联"></a>容器互联</h3><p>使用 –link 参数可以让容器之间安全的进行交互。–link 参数的格式为 –link name:alias，其中 name 是要链接的容器的名称，alias 是这个连接的别名。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建一个新的数据库容器。</span></span><br><span class="line">docker run -d --name db training/postgres</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个新的 web 容器，并将它连接到 db 容器</span></span><br><span class="line">docker run -d -P --name web --link db:db training/webapp python app.py</span><br><span class="line"><span class="meta">#</span><span class="bash"> docker ps 查看容器的连接</span></span><br><span class="line">docker ps</span><br><span class="line"></span><br><span class="line">CONTAINER ID  IMAGE                     COMMAND               CREATED             STATUS             PORTS                    NAMES</span><br><span class="line">349169744e49  training/postgres:latest  su postgres -c &#x27;/usr  About a minute ago  Up About a minute  5432/tcp                 db, web/db</span><br><span class="line">aed84ee21bde  training/webapp:latest    python app.py         16 hours ago        Up 2 minutes       0.0.0.0:49154-&gt;5000/tcp  web</span><br></pre></td></tr></table></figure>

<p>可以看到自定义命名的容器，db 和 web，db 容器的 names 列有 db 也有 web/db。这表示 web 容器链接到 db 容器，web 容器将被允许访问 db 容器的信息。Docker 在两个互联的容器之间创建了一个安全隧道，而且不用映射它们的端口到宿主主机上。在启动 db 容器的时候并没有使用 -p 和 -P 标记，从而避免了暴露数据库端口到外部网络上。</p>
<p>Docker 通过 2 种方式为容器公开连接信息：</p>
<ol>
<li>环境变量</li>
<li>更新 /etc/hosts 文件</li>
</ol>
<p>使用 env 命令来查看 web 容器的环境变量:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo docker run --rm --name web2 --link db:db training/webapp env</span></span><br><span class="line"></span><br><span class="line">DB_NAME=/web2/db</span><br><span class="line">DB_PORT=tcp://172.17.0.5:5432</span><br><span class="line">DB_PORT_5000_TCP=tcp://172.17.0.5:5432</span><br><span class="line">DB_PORT_5000_TCP_PROTO=tcp</span><br><span class="line">DB_PORT_5000_TCP_PORT=5432</span><br><span class="line">DB_PORT_5000_TCP_ADDR=172.17.0.5</span><br><span class="line"><span class="meta">#</span><span class="bash"> 其中 DB_ 开头的环境变量是供 web 容器连接 db 容器使用，前缀采用大写的连接别名。</span></span><br></pre></td></tr></table></figure>

<p>除了环境变量，Docker 还添加 host 信息到父容器的 /etc/hosts 的文件。下面是父容器 web 的 hosts 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run -t -i --rm --link db:db training/webapp /bin/bash</span><br><span class="line">root@aed84ee21bde:/opt/webapp# cat /etc/hosts</span><br><span class="line">172.17.0.7  aed84ee21bde</span><br><span class="line">. . .</span><br><span class="line">172.17.0.5  db</span><br></pre></td></tr></table></figure>

<p>这里有两个 hosts，第一个是 web 容器，web 容器用 id 作为他的主机名，第二个是 db 容器的 ip 和主机名。可以在 web 容器中安装 ping 命令来测试跟db容器的连通。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ljd1996.github.io/2019/01/04/RPC%E5%92%8CHTTP%E7%9B%B8%E5%85%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/04/RPC%E5%92%8CHTTP%E7%9B%B8%E5%85%B3/" class="post-title-link" itemprop="url">RPC和HTTP相关</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-04 13:17:47" itemprop="dateCreated datePublished" datetime="2019-01-04T13:17:47+08:00">2019-01-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E5%8F%B0/" itemprop="url" rel="index"><span itemprop="name">后台</span></a>
                </span>
            </span>

          
            <span id="/2019/01/04/RPC%E5%92%8CHTTP%E7%9B%B8%E5%85%B3/" class="post-meta-item leancloud_visitors" data-flag-title="RPC和HTTP相关" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/01/04/RPC%E5%92%8CHTTP%E7%9B%B8%E5%85%B3/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/01/04/RPC%E5%92%8CHTTP%E7%9B%B8%E5%85%B3/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h1><p>传输协议：</p>
<ul>
<li>RPC，可以基于TCP协议，也可以基于HTTP协议</li>
<li>HTTP，基于HTTP协议</li>
</ul>
<p>传输效率：</p>
<ul>
<li>RPC，使用自定义的TCP协议，可以让请求报文体积更小，或者使用HTTP2协议，也可以很好的减少报文的体积，提高传输效率</li>
<li>HTTP，如果是基于HTTP1.1的协议，请求中会包含很多无用的内容，如果是基于HTTP2.0，那么简单的封装一下是可以作为一个RPC来使用的，这时标准RPC框架更多的是服务治理</li>
</ul>
<p>性能消耗：主要在于序列化和反序列化的耗时</p>
<ul>
<li>RPC，可以基于thrift实现高效的二进制传输</li>
<li>HTTP，大部分是通过json来实现的，字节大小和序列化耗时都比thrift要更消耗性能</li>
</ul>
<p>负载均衡：</p>
<ul>
<li>RPC，基本都自带了负载均衡策略</li>
<li>HTTP，需要配置Nginx，HAProxy来实现</li>
</ul>
<p>服务治理（下游服务新增，重启，下线时如何不影响上游调用者）：</p>
<ul>
<li>RPC，能做到自动通知，不影响上游</li>
<li>HTTP，需要事先通知，修改Nginx/HAProxy配置</li>
</ul>
<p>总结：<br>  RPC主要用于公司内部的服务调用，性能消耗低，传输效率高，服务治理方便。HTTP主要用于对外的异构环境，浏览器接口调用，APP接口调用，第三方接口调用等。</p>
<h1 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h1><p>RPC（Remote Procedure Call）：远程过程调用，它是一种通过网络从远程计算机程序上请求服务，而不需要了解底层网络技术的协议。</p>
<img src="RPC架构.jpg"/>

<ul>
<li>客户端（Client），服务的调用方。</li>
<li>服务端（Server），真正的服务提供者。</li>
<li>客户端存根（Client Stub），存放服务端的地址消息，再将客户端的请求参数打包成网络消息，然后通过网络远程发送给服务方。</li>
<li>服务端存根（Server Stub），接收客户端发送过来的消息，将消息解包，并调用本地的方法。</li>
</ul>
<p>RPC主要是为了解决的两个问题：</p>
<ul>
<li>解决分布式系统中，服务之间的调用问题。</li>
<li>远程调用时，要能够像本地调用一样方便，让调用者感知不到远程调用的逻辑。</li>
</ul>
<p>假设Service A（Client）要调用Service B（Server）中Util类的handle方法：</p>
<img src="RPC调用过程.webp"/>

<ol>
<li>Service A的应用层代码中，调用了handle方法；</li>
<li>这个Util实现类，内部并不是直接实现handle逻辑，而是通过远程调用Service B的RPC接口，来获取运算结果，因此称之为Stub；</li>
<li>Stub和Service B建立远程通讯需要用到远程通讯工具，也就是图中的Run-time Library，这个工具将实现远程通讯的功能，比如Java的Socket，就是这样一个库，当然，也可以用基于Http协议的HttpClient，或者其他通讯工具类都可以，RPC并没有规定要用何种协议进行通讯；</li>
<li>Stub通过调用通讯工具提供的方法，和Service B建立起了通讯，然后将请求数据发给Service B。需要注意的是，由于底层的网络通讯是基于二进制格式的，因此这里Stub传给通讯工具类的数据也必须是二进制，然后传给通讯工具类；</li>
<li>二进制的数据传到Service B后，Service B使用自己的通讯工具接收二进制的请求；</li>
<li>然后将二进制的数据反序列化为请求对象，再将这个请求对象交给Service B的Stub处理；</li>
<li>Stub负责解析请求对象，知道调用方要调的是哪个RPC接口，传进来的参数又是什么，然后再把这些参数传给对应的RPC接口，也就是Util的实际实现类去执行；</li>
<li>RPC接口执行完毕，返回执行结果，二者交互角色，重复以上过程。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ljd1996.github.io/2019/01/04/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/01/04/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">分布式系统学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-01-04 12:40:42" itemprop="dateCreated datePublished" datetime="2019-01-04T12:40:42+08:00">2019-01-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E5%8F%B0/" itemprop="url" rel="index"><span itemprop="name">后台</span></a>
                </span>
            </span>

          
            <span id="/2019/01/04/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="分布式系统学习笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/01/04/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/01/04/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>分布式系统（Distributed System）是由一组通过网络进行通信、为了完成共同的任务而协调工作的计算机节点组成的系统。分布式系统的出现是为了用廉价的、普通的机器完成单个计算机无法完成的计算、存储任务。<strong>其目的是利用更多的机器，处理更多的数据</strong>。</p>
<p>为了性能的提升，当单个节点的处理能力无法满足日益增长的计算、存储任务，且硬件的提升高昂到得不偿失的时候，我们才考虑用分布式系统。因为分布式系统要解决的问题本身就是和单机系统一样的，而由于分布式系统多节点、通过网络通信的拓扑结构，会引入很多单机系统没有的问题，为了解决这些问题又会引入更多的机制、协议，带来更多的问题。</p>
<p>Partition和Replication是解决分布式系统问题的一个组合，很多具体的问题都可以用这个思路去解决。当然也会引入更多的问题，比如为了可用性与可靠性保证，引用了冗余（复制集）。有了冗余，又需要考虑各个副本间的一致性问题。正如CAP、FLP等理论，在分布式系统中，没有最佳的选择，只有最合适的选择。</p>
<p>分布式系统的挑战：</p>
<ol>
<li>异构的机器与网络：分布式系统中的机器配置不一样，其上运行的服务也可能由不同的语言、架构实现，因此处理能力也不一样；节点间通过网络连接，而不同网络运营商提供的网络的带宽、延时、丢包率又不一样。</li>
<li>节点故障：当节点数目达到一定规模时，出故障的概率就变高了。分布式系统需要保证故障发生的时候，系统仍然是可用的。</li>
<li>不可靠的网络：节点间通过网络通信，而网络是不可靠的。</li>
</ol>
<p>分布式系统特性与衡量标准：</p>
<ol>
<li>透明性：分布式系统的最高境界是用户根本感知不到这是一个分布式系统。</li>
<li>可扩展性</li>
<li>可用性与可靠性</li>
<li>高性能</li>
<li>一致性</li>
</ol>
<p>一个大型网站包含诸多组件，每一个组件都是一个分布式系统，比如分布式存储就是一个分布式系统，消息队列就是一个分布式系统。</p>
<p>一些概念：</p>
<ul>
<li><p>负载均衡：</p>
<ul>
<li>Nginx</li>
<li>LVS</li>
</ul>
</li>
<li><p>webserver：</p>
<ul>
<li>Java：Tomcat，Apache，Jboss</li>
<li>Python：gunicorn、uwsgi、twisted、webpy、tornado</li>
</ul>
</li>
<li><p>service：　　</p>
<ul>
<li>SOA、微服务、spring boot，django</li>
</ul>
</li>
<li><p>容器：</p>
<ul>
<li>docker，kubernetes</li>
</ul>
</li>
<li><p>cache：</p>
<ul>
<li>memcache、redis等</li>
</ul>
</li>
<li><p>协调中心：</p>
<ul>
<li>zookeeper、etcd等</li>
</ul>
</li>
<li><p>rpc框架：</p>
<ul>
<li>grpc、dubbo、brpc</li>
</ul>
</li>
<li><p>消息队列：</p>
<ul>
<li>kafka、rabbitMQ、rocketMQ、QSP</li>
</ul>
</li>
<li><p>实时数据平台：</p>
<ul>
<li>storm、akka</li>
</ul>
</li>
<li><p>离线数据平台：</p>
<ul>
<li>hadoop、spark</li>
</ul>
</li>
<li><p>dbproxy：</p>
<ul>
<li>cobar也是阿里开源的，在阿里系中使用也非常广泛，是关系型数据库的sharding + replica 代理</li>
</ul>
</li>
<li><p>db：</p>
<ul>
<li>mysql、oracle、MongoDB、HBase</li>
</ul>
</li>
<li><p>搜索：</p>
<ul>
<li>elasticsearch、solr</li>
</ul>
</li>
<li><p>日志：</p>
<ul>
<li>rsyslog、elk、flume</li>
</ul>
</li>
</ul>
<h1 id="请求过程"><a href="#请求过程" class="headerlink" title="请求过程"></a>请求过程</h1><p>用户使用Web、APP、SDK等通过HTTP、TCP连接到系统。在分布式系统中，为了高并发、高可用，一般都是多个节点提供相同的服务，所以需要考虑负载均衡。</p>
<p>通过负载均衡找到一个节点后，接下来就是真正处理用户的请求了，请求有可能简单，也有可能很复杂。如果有缓存，则需要考虑分布式缓存，如果缓存没有命中，那么需要去数据库拉取数据。</p>
<p>假设服务A需要调用服务B的服务，首先两个节点需要通信，网络通信都是建立在TCP/IP协议的基础上，但是，每个应用都手写socket是一件冗杂、低效的事情，因此需要应用层的封装，因此有了HTTP、FTP等各种应用层协议。当系统愈加复杂，提供大量的http接口也是一件困难的事情。因此，有了更进一步的抽象，那就是RPC。</p>
<p>一个请求可能包含诸多操作，即在服务A上做一些操作，然后在服务B上做另一些操作，这就涉及到分布式事务的问题。</p>
<p>分布式系统中有大量的服务，每个服务又是多个节点组成，一个服务要想找到另一个服务的某个节点就需要服务注册与发现了。</p>
<p>用户请求操作会产生一些数据、日志等信息，其他一些系统可能会对这些消息感兴趣，这里就抽象出了两个概念，消息的生产者与消费者。那么生产者怎么讲消息发送给消费者呢，RPC并不是一个很好的选择，因为RPC肯定得指定消息发给谁，但实际的情况是生产者并不清楚、也不关心谁会消费这个消息，这个时候就需要消息队列了。</p>
<p>上面提到，用户操作会产生一些数据，这就催生了分布式计算平台用来处理这些海量的数据。</p>
<p>最后，用户的操作完成之后，用户的数据需要持久化，但数据量很大，大到按个节点无法存储，这时就需要分布式存储。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/12/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><span class="page-number current">13</span><a class="page-number" href="/page/14/">14</a><span class="space">&hellip;</span><a class="page-number" href="/page/17/">17</a><a class="extend next" rel="next" href="/page/14/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="苍耳叔叔"
      src="/images/head.png">
  <p class="site-author-name" itemprop="name">苍耳叔叔</p>
  <div class="site-description" itemprop="description">梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">170</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">41</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">100</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ljd1996" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ljd1996" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hearing1996@gmail.com" title="E-Mail → mailto:hearing1996@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">苍耳叔叔</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : true,
      notify     : true,
      appId      : 'pCnIlzs46HJGpubm7D3TnrBC-gzGzoHsz',
      appKey     : '7LzW4wBI9lY5DtVFNkFWcjs0',
      placeholder: "欢迎评论交流！",
      avatar     : 'robohash',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
