<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
<meta property="og:type" content="website">
<meta property="og:title" content="苍耳的博客">
<meta property="og:url" content="http://yoursite.com/page/10/index.html">
<meta property="og:site_name" content="苍耳的博客">
<meta property="og:description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="苍耳叔叔">
<meta property="article:tag" content="诗歌，宋词，后台，Android，Java">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/10/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>苍耳的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">苍耳的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">细水长流</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/12/%E6%95%8F%E6%8D%B7%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/12/%E6%95%8F%E6%8D%B7%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/" class="post-title-link" itemprop="url">敏捷开发基础</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-12 11:36:40" itemprop="dateCreated datePublished" datetime="2019-09-12T11:36:40+08:00">2019-09-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:58" itemprop="dateModified" datetime="2021-05-14T14:14:58+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%85%B6%E5%AE%83/" itemprop="url" rel="index"><span itemprop="name">其它</span></a>
                </span>
            </span>

          
            <span id="/2019/09/12/%E6%95%8F%E6%8D%B7%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/" class="post-meta-item leancloud_visitors" data-flag-title="敏捷开发基础" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/09/12/%E6%95%8F%E6%8D%B7%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/09/12/%E6%95%8F%E6%8D%B7%E5%BC%80%E5%8F%91%E5%9F%BA%E7%A1%80/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="CI：持续集成（CONTINUOUS-INTEGRATION）"><a href="#CI：持续集成（CONTINUOUS-INTEGRATION）" class="headerlink" title="CI：持续集成（CONTINUOUS INTEGRATION）"></a>CI：持续集成（CONTINUOUS INTEGRATION）</h1><p>CI的全称是Continuous Integration，表示持续集成。</p>
<p>在CI环境中，开发人员将会频繁地向主干提交代码。这些新提交的代码在最终合并到主干前，需要经过编译和自动化测试流进行验证。持续集成过程中很重视自动化测试验证结果，以保障所有的提交在合并主线之后的质量问题，对可能出现的一些问题进行预警。</p>
<h1 id="CD：持续部署（CONTINUOUS-DEPLOYMENT）"><a href="#CD：持续部署（CONTINUOUS-DEPLOYMENT）" class="headerlink" title="CD：持续部署（CONTINUOUS DEPLOYMENT）"></a>CD：持续部署（CONTINUOUS DEPLOYMENT）</h1><p>CD的全称是Continuous Deployment，表示持续部署。</p>
<p>在CD环境中，通过自动化的构建、测试和部署循环来快速交付高质量的产品。某种程度上代表了一个开发团队工程化的程度，任何修改通过了所有已有的工作流就会直接和客户见面，只有当一个修改在工作流中构建失败才能阻止它部署到产品线。</p>
<p>持续部署是一个很优秀的方式，可以加速与客户的反馈循环，但是会给团队带来压力，因为不再有“发布日”了。开发人员可以专注于构建软件，他们看到他们的修改在他们完成工作后几分钟就上线了。</p>
<p>基本上，当开发人员在主分支中合并一个提交时，这个分支将被构建、测试，如果一切顺利，则部署到生产环境中。</p>
<h1 id="CD：持续交付（CONTINUOUS-DELIVERY）"><a href="#CD：持续交付（CONTINUOUS-DELIVERY）" class="headerlink" title="CD：持续交付（CONTINUOUS DELIVERY）"></a>CD：持续交付（CONTINUOUS DELIVERY）</h1><p>持续交付的英文全称是：Continuous delivery，缩写也是CD，它是一种软件工程手法。</p>
<p>它可以让软件产品的产出过程在一个短周期内完成，以保证软件可以稳定、持续的保持在随时可以释出的状况。它的目标在于让软件的建置、测试与释出变得更快以及更频繁。这种方式可以减少软件开发的成本与时间，减少风险。</p>
<p>有时候，持续交付也与持续部署混淆。持续部署意味着所有的变更都会被自动部署到生产环境中。持续交付意味着所有的变更都可以被部署到生产环境中，但是出于业务考虑，可以选择不部署。如果要实施持续部署，必须先实施持续交付。</p>
<h1 id="DevOps"><a href="#DevOps" class="headerlink" title="DevOps"></a>DevOps</h1><p>DevOps是Development和Operations的组合，是一种方法论，是一组过程、方法与系统的统称，用于促进应用开发、应用运维和质量保障（QA）部门之间的沟通、协作与整合。以期打破传统开发和运营之间的壁垒和鸿沟。</p>
<p>DevOps是一种重视“软件开发人员（Dev）”和“IT运维技术人员（Ops）”之间沟通合作的文化、运动或惯例。通过自动化“软件交付”和“架构变更”的流程，来使得构建、测试、发布软件能够更加地快捷、频繁和可靠。具体来说，就是在软件交付和部署过程中提高沟通与协作的效率，旨在更快、更可靠的的发布更高质量的产品。</p>
<p>也就是说DevOps是一组过程和方法的统称，并不指代某一特定的软件工具或软件工具组合。各种工具软件或软件组合可以实现DevOps的概念方法。其本质是一整套的方法论，而不是指某种或某些工具集合，与软件开发中设计到的OOP、AOP、IOC（或DI）等类似，是一种理论或过程或方法的抽象或代称。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/11/Android%E7%BB%84%E4%BB%B6%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/11/Android%E7%BB%84%E4%BB%B6%E5%8C%96/" class="post-title-link" itemprop="url">Android组件化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-11 17:40:10" itemprop="dateCreated datePublished" datetime="2019-09-11T17:40:10+08:00">2019-09-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-06-16 16:25:33" itemprop="dateModified" datetime="2021-06-16T16:25:33+08:00">2021-06-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/%E6%9E%B6%E6%9E%84/" itemprop="url" rel="index"><span itemprop="name">架构</span></a>
                </span>
            </span>

          
            <span id="/2019/09/11/Android%E7%BB%84%E4%BB%B6%E5%8C%96/" class="post-meta-item leancloud_visitors" data-flag-title="Android组件化" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/09/11/Android%E7%BB%84%E4%BB%B6%E5%8C%96/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/09/11/Android%E7%BB%84%E4%BB%B6%E5%8C%96/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p><strong>模块</strong></p>
<p>模块指的是独立的业务模块，比如<code>直播模块</code>，<code>会员模块</code>等。</p>
<p><strong>组件</strong></p>
<p>组件指的是单一的功能组件，如<code>登录组件</code>、<code>上报组件</code>等，每个组件都可以以一个单独的module开发，并且可以单独抽出来作为SDK对外发布使用。</p>
<p><code>模块</code>和<code>组件</code>间最明显的区别就是模块相对与组件来说粒度更大，一个模块中可能包含多个组件。并且两种方式的本质思想是一样的，都是为了代码重用和业务解耦。在划分的时候，模块化是业务导向，组件化是功能导向。</p>
<p><img src="%E7%BB%84%E4%BB%B6%E5%8C%96.jpg" alt="组件化"></p>
<p>一个可用的组件化架构图从上向下分别为APP壳，业务层、组件层和基础层：</p>
<ul>
<li>基础层：基础层包含的是一些基础库以及对基础库的封装，比如常用的图片加载，网络请求，数据上报操作等等，其他模块或者组件甚至App应用都可以引用同一套基础库，因此这些基础库最好在另一个项目/git仓库中维护。在基础库上面可以再增加一个Common组件，它位于App应用所在的项目中，用来添加一些都需要引用到的依赖以及本App应用独有的共有方法，UI控件等。</li>
<li>组件层：基础层往上是组件层，组件层包含一些功能组件，比如分享，登录，下载，播放等等。</li>
<li>业务层：组件层往上是业务层，一个具体的业务模块会按需引用不同的组件，最终实现业务功能。</li>
<li>APP壳：在APP模块中根据需求统筹各个业务组件，最终输出为一个完整的应用。</li>
</ul>
<h1 id="组件单独调试"><a href="#组件单独调试" class="headerlink" title="组件单独调试"></a>组件单独调试</h1><p>Android Gradle提供了三种插件，在开发中可以通过配置不同的插件来配置不同的工程。</p>
<ul>
<li>App插件：com.android.application</li>
<li>Library插件：com.android.libraay</li>
<li>Test插件：com.android.test</li>
</ul>
<p>可以在gradle.properties配置文件中声明一个boolean变量：isAlone，在build.gradle中通过判断这个变量来动态加载不同的插件，ApplicationId以及AndroidManifest文件：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- main/manifest/AndroidManifest.xml 单独调试 --&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">&quot;com.hearing.share&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:allowBackup</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">&quot;@mipmap/ic_launcher&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;@string/app_name&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:roundIcon</span>=<span class="string">&quot;@mipmap/ic_launcher_round&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:supportsRtl</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">&quot;@style/AppTheme&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;.ShareActivity&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- main/AndroidManifest.xml 集成调试 --&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">&quot;com.hearing.share&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span> <span class="attr">android:theme</span>=<span class="string">&quot;@style/AppTheme&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;.ShareActivity&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在组件的build.gradle中配置：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        <span class="keyword">if</span> (isAlone.toBoolean()) &#123;</span><br><span class="line">            <span class="comment">// 单独调试时添加 applicationId ，集成调试时移除</span></span><br><span class="line">            applicationId <span class="string">&quot;com.hearing.login&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sourceSets &#123;</span><br><span class="line">        main &#123;</span><br><span class="line">            <span class="comment">// 单独调试与集成调试时使用不同的 AndroidManifest.xml 文件</span></span><br><span class="line">            <span class="keyword">if</span> (isAlone.toBoolean()) &#123;</span><br><span class="line">                manifest.srcFile <span class="string">&#x27;src/main/manifest/AndroidManifest.xml&#x27;</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                manifest.srcFile <span class="string">&#x27;src/main/AndroidManifest.xml&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外为了使组件化项目中的所有组件的compileSdkVersion、buildToolsVersion以及开源库版本等都能保持统一，也为了方便修改版本号，统一在Android工程根目录下的build.gradle中定义这些版本号，当然也可以在项目根目录添加一个单独的gradle文件定义这些常量，然后由根build.gradle引入。</p>
<h1 id="组件混淆方案"><a href="#组件混淆方案" class="headerlink" title="组件混淆方案"></a>组件混淆方案</h1><p>组件化项目的代码混淆方案采用在集成模式下集中在app壳工程中混淆，各个业务组件不配置混淆文件。</p>
<h1 id="组件Application"><a href="#组件Application" class="headerlink" title="组件Application"></a>组件Application</h1><p>组件化开发中每一个组件可能都会自定义一个Application类，当所有组件要打包合并在一起的时候，由于程序只能有一个Application，组件中自己定义的Application无法使用。因此需要想办法在任何一个业务组件中都能获取到一个可用的全局Context，而且这个Context不管是在组件开发模式还是在集成开发模式都是生效的。</p>
<p>在基础库组件中封装了项目中用到的各种Base类（BaseActivity，BaseFragment等），这些基类中有一个BaseApplication类，它主要作用是使各个业务组件和app壳工程中都能访问到全局Context，且在其中可以存储一些全局对象：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> BaseApplication &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mGlobalObjects = mutableMapOf&lt;Any, Any&gt;()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mApplication: Application? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mContext: Context? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">init</span><span class="params">(application: <span class="type">Application</span>)</span></span> &#123;</span><br><span class="line">        mApplication = application</span><br><span class="line">        mContext = application.baseContext</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getContext</span><span class="params">()</span></span>: Context? &#123;</span><br><span class="line">        <span class="keyword">return</span> mContext ?: mApplication</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getApplication</span><span class="params">()</span></span>: Application? &#123;</span><br><span class="line">        <span class="keyword">return</span> mApplication</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Synchronized</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">putGlobalObject</span><span class="params">(key: <span class="type">Any</span>, obj: <span class="type">Any</span>)</span></span> &#123;</span><br><span class="line">        mGlobalObjects[key] = obj</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Synchronized</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getGlobalObject</span><span class="params">(key: <span class="type">Any</span>)</span></span>: Any? &#123;</span><br><span class="line">        <span class="keyword">return</span> mGlobalObjects[key]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Synchronized</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">removeGlobalObject</span><span class="params">(key: <span class="type">Any</span>)</span></span>: Any? &#123;</span><br><span class="line">        <span class="keyword">return</span> mGlobalObjects.remove(key)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后可以在本应用的Common组件中定义一个公用的Application基类，然后在各自组件中定义一个Application继承这个基类，这样就可以通过BaseApplication来获取全局的Context了：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBaseApplication</span> : <span class="type">Application</span></span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">attachBaseContext</span><span class="params">(base: <span class="type">Context</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.attachBaseContext(base)</span><br><span class="line">        BaseApplication.<span class="keyword">init</span>(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外需要在项目从组件模式转换到集成模式后将组件的Application剔除出项目，可以在组件的Java文件夹下创建一个debug文件夹，用于存放不会在业务组件中引用的类，比如说Application类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sourceSets &#123;</span><br><span class="line">    main &#123;</span><br><span class="line">        <span class="keyword">if</span> (isAlone.toBoolean()) &#123;</span><br><span class="line">            manifest.srcFile <span class="string">&#x27;src/main/module/AndroidManifest.xml&#x27;</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            manifest.srcFile <span class="string">&#x27;src/main/AndroidManifest.xml&#x27;</span></span><br><span class="line">            <span class="comment">// 集成开发模式下排除debug文件夹中的所有Java文件</span></span><br><span class="line">            java &#123;</span><br><span class="line">                exclude <span class="string">&#x27;debug/**&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="组件间数据传递与方法调用"><a href="#组件间数据传递与方法调用" class="headerlink" title="组件间数据传递与方法调用"></a>组件间数据传递与方法调用</h1><p>接下来模拟一个组件间数据传递和方法调用的场景：分享组件分享时需要根据用户是否登录来判断分享的动作。</p>
<h2 id="base-component"><a href="#base-component" class="headerlink" title="base_component"></a>base_component</h2><p>base_component组件用来提供组件间数据传递和方法调用的功能。</p>
<p><strong>ILoginService</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ILoginService</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">isLogin</span><span class="params">()</span></span>: <span class="built_in">Boolean</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getUserId</span><span class="params">()</span></span>: String</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>空实现：EmptyLoginService</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmptyLoginService</span> : <span class="type">ILoginService &#123;</span></span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">isLogin</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getUserId</span><span class="params">()</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Service工厂：ServiceFactory</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> ServiceFactory &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> mServices = CopyOnWriteArrayList&lt;Any&gt;()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">register</span><span class="params">(service: <span class="type">Any</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!mServices.contains(service)) &#123;</span><br><span class="line">            mServices.add(service)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">getService</span><span class="params">(cls: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;)</span></span>: Any? &#123;</span><br><span class="line">        mServices.forEach &#123;</span><br><span class="line">            <span class="keyword">if</span> (cls.isInstance(it)) &#123;</span><br><span class="line">                <span class="keyword">return</span> it</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getLoginService</span><span class="params">()</span></span>: ILoginService &#123;</span><br><span class="line">        <span class="keyword">val</span> service = getService(ILoginService::<span class="keyword">class</span>.java)</span><br><span class="line">        <span class="keyword">return</span> service <span class="keyword">as</span>? ILoginService ?: EmptyLoginService()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="component-login"><a href="#component-login" class="headerlink" title="component_login"></a>component_login</h2><p>登录组件中提供ILoginService的具体实现：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LoginService</span> : <span class="type">ILoginService &#123;</span></span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">isLogin</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getUserId</span><span class="params">()</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1024&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="component-share"><a href="#component-share" class="headerlink" title="component_share"></a>component_share</h2><p>分享组件中进行分享的逻辑判断：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> ShareHelper &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">share</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> loginService = ServiceFactory.getLoginService()</span><br><span class="line">        <span class="keyword">if</span> (loginService.isLogin()) &#123;</span><br><span class="line">            Toast.makeText(</span><br><span class="line">                BaseApplication.getContext(),</span><br><span class="line">                <span class="string">&quot;Share from <span class="subst">$&#123;loginService.getUserId()&#125;</span>&quot;</span>, Toast.LENGTH_SHORT</span><br><span class="line">            ).show()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            Toast.makeText(</span><br><span class="line">                BaseApplication.getContext(),</span><br><span class="line">                <span class="string">&quot;Not login&quot;</span>, Toast.LENGTH_SHORT</span><br><span class="line">            ).show()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="app"><a href="#app" class="headerlink" title="app"></a>app</h2><p>在App主Module中进行ILoginService服务的注册：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainApplication</span> : <span class="type">MyBaseApplication</span></span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate()</span><br><span class="line">        ServiceFactory.register(LoginService())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后根据业务逻辑调用分享组件的功能：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line">        findViewById&lt;TextView&gt;(R.id.text_view).setOnClickListener &#123;</span><br><span class="line">            ShareHelper.share()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="组件间界面跳转"><a href="#组件间界面跳转" class="headerlink" title="组件间界面跳转"></a>组件间界面跳转</h1><p>可以使用开源框架：<a target="_blank" rel="noopener" href="https://github.com/alibaba/ARouter">ARouter</a>或者<a target="_blank" rel="noopener" href="https://github.com/luckybilly/CC">CC</a>等。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>以上组件化的内容是在参考了网络上一些关于Android组件化的解析后，结合了自己的理解与思考得到的一些想法，在实际场景里可能会有问题，期待在以后的开发中有更多的实践与思考！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/10/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/10/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6/" class="post-title-link" itemprop="url">Android四大组件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-10 14:49:41" itemprop="dateCreated datePublished" datetime="2019-09-10T14:49:41+08:00">2019-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/Framework/" itemprop="url" rel="index"><span itemprop="name">Framework</span></a>
                </span>
            </span>

          
            <span id="/2019/09/10/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6/" class="post-meta-item leancloud_visitors" data-flag-title="Android四大组件" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/09/10/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/09/10/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Activity"><a href="#Activity" class="headerlink" title="Activity"></a>Activity</h1><h2 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h2><img src="Activity生命周期.png"/>

<p>看一下以下操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 程序启动</span></span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">05</span>:<span class="number">34.687</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: onCreate</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">05</span>:<span class="number">34.718</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: MainActivity-onCreate</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">05</span>:<span class="number">34.819</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: MainActivity-onStart</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">05</span>:<span class="number">34.823</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: MainActivity-onResume</span><br><span class="line"><span class="comment">// 进入SecondActivity</span></span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">05</span>:<span class="number">53.802</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: MainActivity-onPause</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">05</span>:<span class="number">53.815</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: SecondActivity-onCreate</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">05</span>:<span class="number">53.822</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: SecondActivity-onStart</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">05</span>:<span class="number">53.824</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: SecondActivity-onResume</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">05</span>:<span class="number">54.156</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: MainActivity-onStop</span><br><span class="line"><span class="comment">// 按下back键</span></span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">04</span>.<span class="number">672</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: SecondActivity-onPause</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">04</span>.<span class="number">716</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: MainActivity-onRestart</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">04</span>.<span class="number">717</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: MainActivity-onStart</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">04</span>.<span class="number">718</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: MainActivity-onResume</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">05</span>.<span class="number">071</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: SecondActivity-onStop</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">05</span>.<span class="number">071</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: SecondActivity-onDestroy</span><br><span class="line"><span class="comment">// 按下home键</span></span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">14.703</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: MainActivity-onPause</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">14.722</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: MainActivity-onStop</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">14.723</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: onTrimMemory</span><br><span class="line"><span class="comment">// 返回应用</span></span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">18.968</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: MainActivity-onRestart</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">18.970</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: MainActivity-onStart</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">18.970</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: MainActivity-onResume</span><br><span class="line"><span class="comment">// 按下back键</span></span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">20.822</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: MainActivity-onPause</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">21.274</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: onTrimMemory</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">21.275</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: MainActivity-onStop</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">21.275</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: MainActivity-onDestroy</span><br><span class="line"><span class="comment">// 进入应用</span></span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">39.925</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: MainActivity-onCreate</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">39.959</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: MainActivity-onStart</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">39.963</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: MainActivity-onResume</span><br><span class="line"><span class="comment">// 进入task</span></span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">47.056</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: MainActivity-onPause</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">47.068</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: MainActivity-onStop</span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">47.088</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: onTrimMemory</span><br><span class="line"><span class="comment">// 后台终止</span></span><br><span class="line"><span class="number">09</span>-<span class="number">25</span> <span class="number">22</span>:<span class="number">06</span>:<span class="number">51.310</span> <span class="number">13204</span>-<span class="number">13204</span>/com.hearing.demo D/LLL: MainActivity-onDestroy</span><br></pre></td></tr></table></figure>

<p>各个生命周期的作用：</p>
<ul>
<li>onCreate: Activity <code>已创建</code> 状态，在 Activity 的整个生命周期中只发生一次，用来进行 Activity 的一些初始化工作。</li>
<li>onStart: 为 Activity 可见做准备工作，此时还不在前台。</li>
<li>onResume: Activity 进入前台，对用户可见了。</li>
<li>onPause: 将要离开 Activity, 此时 Activity 依旧可见。可以做一些轻量级数据存储任务，因为在跳转 Activity 时只有当一个 Activity 执行完了 onPause 方法后另一个 Activity 才会启动。</li>
<li>onStop: 此时 Activity 已经不可见了，但是 Activity 对象还在内存中，在此可以做一些资源回收操作。</li>
<li>onDestroy: Activity 被销毁。</li>
</ul>
<p>关于 onRestoreInstanceState 和 onSaveInstanceState 方法：</p>
<ul>
<li>onSaveInstanceState 在 onStop 后被调用；</li>
<li>onRestoreInstanceState 在 onStart 后被调用；</li>
</ul>
<p>在 Activity 中有一个属性 — <code>View mDecor</code>, 在 PhoneWindow 中有一个属性 — <code>DecorView mDecor</code>，在 handleResumeActivity 方法中，会把 PhoneWindow 中的 mDecor 赋值给 Activity.mDecor。</p>
<h2 id="启动方式"><a href="#启动方式" class="headerlink" title="启动方式"></a>启动方式</h2><p><strong>standard</strong></p>
<p>standard 是 Activity 默认的启动模式。在 standard 模式下，每启动一个 Activity 都会创建一个新的实例进入任务栈栈顶。</p>
<p><strong>singleTop</strong></p>
<p>singleTop 模式与 standard 类似，不同的是当启动的 Activity 已经位于栈顶时，则直接使用它不创建新的实例，此时栈顶的 Activity 实例会调 onNewIntent 方法。如果启动的 Activity 没有位于栈顶时，则创建一个新的实例位于栈顶。</p>
<p><strong>singleTask</strong></p>
<p>当 Activity 的启动模式指定为 singleTask，每次启动该 Activity 时，系统首先会检查栈中是否存在该 Activity 的实例，如果发现已经存在则直接使用该实例，此时栈顶的 Activity 实例会调 onNewIntent 方法，并将当前 Activity 之上的所有 Activity 出栈，如果没有发现则创建一个新的实例。</p>
<p><strong>singleInstance</strong></p>
<p>在程序开发过程中，如果需要 Activity 在整个系统中都只有一个实例，这时就需要用到 singleInstance 模式。指定为 singleInstance 模式的 Activity 会启动一个新的任务栈来管理这个 Activity。</p>
<p>singleInstance模式加载Activity时，无论从哪个任务栈中启动该Activity，只会创建一个Activity实例，并且会使用一个全新的任务栈来装载该Activity实例。采用这种模式启动Activity会分为一下两种情况：</p>
<ul>
<li>如果要启动的Activity不存在，系统会创建一个新的任务栈，在创建该Activity的实例，并把该Activity加入栈顶.</li>
<li>如果要启动的Activity已经存在，无论位于哪个应用程序或者哪个任务栈中，系统都会把该Activity所在的任务栈转到前台，从而使该Activity显示出来。</li>
</ul>
<h2 id="taskAffinity"><a href="#taskAffinity" class="headerlink" title="taskAffinity"></a>taskAffinity</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>每个Activity都有taskAffinity属性，这个属性指出了它希望进入的Task。如果一个Activity没有显式的指明该Activity的taskAffinity，那么它的这个属性就等于Application指明的taskAffinity，如果Application也没有指明，那么该taskAffinity的值就等于包名。而Task也有自己的affinity属性，它的值等于它的根Activity的taskAffinity的值。</p>
<h3 id="allowTaskReparenting"><a href="#allowTaskReparenting" class="headerlink" title="allowTaskReparenting"></a>allowTaskReparenting</h3><p>如果该Activity的allowTaskReparenting设置为true，它进入后台，当一个和它有相同affinity的Task进入前台时，它会重新宿主，进入到该前台的task中。</p>
<table>
<thead>
<tr>
<th align="center">Application</th>
<th align="center">Activity</th>
<th align="center">taskAffinity</th>
<th align="center">allowTaskReparenting</th>
</tr>
</thead>
<tbody><tr>
<td align="center">application1</td>
<td align="center">Activity1</td>
<td align="center">com.winuxxan.affinity</td>
<td align="center">true</td>
</tr>
<tr>
<td align="center">application2</td>
<td align="center">Activity2</td>
<td align="center">com.winuxxan.affinity</td>
<td align="center">false</td>
</tr>
</tbody></table>
<p>创建两个工程：application1和application2，分别含有Activity1和Activity2，它们的taskAffinity相同，Activity1的allowTaskReparenting为true。</p>
<p>首先，我们启动application1,加载Activity1，然后按Home键，使该task（假设为task1）进入后台。然后启动application2，默认加载Activity2。本来应该是显示Activity2，但是我们却看到了Activity1。实际上Activity2也被加载了，只是Activity1重新宿主，所以看到了Activity1。</p>
<h3 id="FLAG-ACTIVITY-NEW-TASK"><a href="#FLAG-ACTIVITY-NEW-TASK" class="headerlink" title="FLAG_ACTIVITY_NEW_TASK"></a>FLAG_ACTIVITY_NEW_TASK</h3><p>如果加载某个Activity的intent，Flag被设置成FLAG_ACTIVITY_NEW_TASK时，它会首先检查是否存在与自己taskAffinity相同的Task，如果存在，那么它会直接宿主到该Task中，如果不存在则重新创建Task。</p>
<p>写一个应用，包含两个Activity：Activity1的taskAffinity为<code>com.hearing.task</code>，Activity2为入口，且点击Activity2会以FLAG_ACTIVITY_NEW_TASK启动Activity1。再写一个应用MyActivity，它包含一个Activity（MyActivity），其taskAffinity为<code>com.hearing.task</code>。</p>
<p>首先启动MyActivity，然后Home回桌面，然后打开Activity2，点击Activity2，进入Activity1。然后按返回键。进入Activity的顺序为Activity2-&gt;Activity1，而返回时顺序为Activity1-&gt;MyActivity。这就说明了一个问题，Activity1在启动时，重新宿主到了MyActivity所在的Task中去了。</p>
<h3 id="launchMode"><a href="#launchMode" class="headerlink" title="launchMode"></a>launchMode</h3><ul>
<li>当一个应用程序加载一个singleTask模式的Activity时，首先该Activity会检查是否存在与它的taskAffinity相同的Task。如果存在，那么检查是否实例化，如果已经实例化，那么销毁在该Activity以上的Activity并调用onNewIntent。如果没有实例化，那么该Activity实例化并入栈。如果不存在，那么就重新创建Task，并入栈。</li>
<li>当一个应用程序加载一个singleInstance模式的Activity时，如果该Activity没有被实例化，那么就重新创建一个Task，并入栈，如果已经被实例化，那么就调用该Activity的onNewIntent.singleInstance的Activity所在的Task不允许存在其他Activity，任何从该Activity加载的其它Activity（假设为Activity2）都会被放入其它的Task中，如果存在与Activity2相同affinity的Task，则在该Task内创建Activity2。如果不存在，则重新生成新的Task并入栈。</li>
</ul>
<h2 id="启动方式的问题"><a href="#启动方式的问题" class="headerlink" title="启动方式的问题"></a>启动方式的问题</h2><p>MainActivity是SingleTask或者SingleInstance模式，启动TestActivity，TestActivity马上跳转到MainActivity，这种情况下，MainActivity的onResume会回调两次。日志如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">com.hearing.activitytest.MainActivity@2c5d2eb onCreate</span><br><span class="line">com.hearing.activitytest.MainActivity@2c5d2eb onStart</span><br><span class="line">com.hearing.activitytest.MainActivity@2c5d2eb onResume</span><br><span class="line">com.hearing.activitytest.MainActivity@2c5d2eb onPause</span><br><span class="line">TestActivity onCreate</span><br><span class="line">TestActivity onStart</span><br><span class="line">TestActivity onResume</span><br><span class="line">TestActivity onPause</span><br><span class="line">com.hearing.activitytest.MainActivity@2c5d2eb onNewIntent</span><br><span class="line">com.hearing.activitytest.MainActivity@2c5d2eb onResume</span><br><span class="line">com.hearing.activitytest.MainActivity@2c5d2eb onPause</span><br><span class="line">com.hearing.activitytest.MainActivity@2c5d2eb onResume</span><br><span class="line">TestActivity onStop</span><br></pre></td></tr></table></figure>

<p>适当延时500ms再跳转回MainActivity可以解决这个问题（可能由于业务场景不同，会带来新的问题）。</p>
<p>在<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/11092101/startactivity-on-foreground-application-causes-onpause-onresume">stackoverflow</a>上也有人发现过类似的问题。</p>
<h1 id="BroadcastReceiver"><a href="#BroadcastReceiver" class="headerlink" title="BroadcastReceiver"></a>BroadcastReceiver</h1><h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><ul>
<li>普通广播（Normal Broadcast）</li>
<li>系统广播（System Broadcast）</li>
<li>有序广播（Ordered Broadcast）</li>
<li>粘性广播（Sticky Broadcast）（已弃用）</li>
<li>App应用内广播（Local Broadcast）</li>
</ul>
<h2 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h2><h3 id="BroadcastReceiver-1"><a href="#BroadcastReceiver-1" class="headerlink" title="BroadcastReceiver"></a>BroadcastReceiver</h3><ul>
<li>继承BroadcastReceivre基类</li>
<li>复写抽象方法onReceive()方法</li>
</ul>
<h3 id="注册"><a href="#注册" class="headerlink" title="注册"></a>注册</h3><h4 id="静态注册"><a href="#静态注册" class="headerlink" title="静态注册"></a>静态注册</h4><ul>
<li>常驻：不受任何组件声明周期影响</li>
<li>耗电，占内存</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">receiver</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">android:enabled</span>=<span class="string">[</span>&quot;<span class="attr">true</span>&quot; | &quot;<span class="attr">false</span>&quot;]</span></span><br><span class="line"><span class="tag">    //此<span class="attr">broadcastReceiver</span>能否接收其他<span class="attr">App</span>的发出的广播</span></span><br><span class="line"><span class="tag">    //默认值是由<span class="attr">receiver</span>中有无<span class="attr">intent-filter</span>决定的：如果有<span class="attr">intent-filter</span>，默认值为<span class="attr">true</span>，否则为<span class="attr">false</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">[</span>&quot;<span class="attr">true</span>&quot; | &quot;<span class="attr">false</span>&quot;]</span></span><br><span class="line"><span class="tag">    <span class="attr">android:icon</span>=<span class="string">&quot;drawable resource&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:label</span>=<span class="string">&quot;string resource&quot;</span></span></span><br><span class="line"><span class="tag">    //继承<span class="attr">BroadcastReceiver</span>子类的类名</span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.mBroadcastReceiver&quot;</span></span></span><br><span class="line"><span class="tag">    //具有相应权限的广播发送者发送的广播才能被此<span class="attr">BroadcastReceiver</span>所接收；</span></span><br><span class="line"><span class="tag">    <span class="attr">android:permission</span>=<span class="string">&quot;string&quot;</span></span></span><br><span class="line"><span class="tag">    //<span class="attr">BroadcastReceiver</span>运行所处的进程</span></span><br><span class="line"><span class="tag">    //默认为<span class="attr">app</span>的进程，可以指定独立的进程</span></span><br><span class="line"><span class="tag">    //注：<span class="attr">Android</span>四大基本组件都可以通过此属性指定自己的独立进程</span></span><br><span class="line"><span class="tag">    <span class="attr">android:process</span>=<span class="string">&quot;string&quot;</span> &gt;</span></span><br><span class="line"></span><br><span class="line">    //用于指定此广播接收器将接收的广播类型</span><br><span class="line">    //本示例中给出的是用于接收网络状态改变时发出的广播</span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.net.conn.CONNECTIVITY_CHANGE&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="动态注册"><a href="#动态注册" class="headerlink" title="动态注册"></a>动态注册</h4><ul>
<li>非常驻，灵活</li>
<li>手动释放</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onResume();</span><br><span class="line">    mBroadcastReceiver mBroadcastReceiver = <span class="keyword">new</span> mBroadcastReceiver();</span><br><span class="line">    IntentFilter intentFilter = <span class="keyword">new</span> IntentFilter();</span><br><span class="line">    intentFilter.addAction(android.net.conn.CONNECTIVITY_CHANGE);</span><br><span class="line">    registerReceiver(mBroadcastReceiver, intentFilter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onPause();</span><br><span class="line">    unregisterReceiver(mBroadcastReceiver);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h1><h2 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h2><p>生命周期:</p>
<ol>
<li><p>startService()</p>
<ul>
<li>作用：启动Service服务</li>
<li>手动调用startService()后，自动调用内部方法：onCreate()、onStartCommand() </li>
<li>如果一个service被startService多次启动，onCreate()只会调用一次 </li>
<li>onStartCommand()调用次数=startService()次数</li>
</ul>
</li>
<li><p>stopService()</p>
<ul>
<li>作用：关闭Service服务 </li>
<li>手动调用stopService()后，自动调用内部方法：onDestory() </li>
<li>如果一个service被启动且被绑定，如果没有在绑定的前提下stopService()是无法停止服务的。</li>
</ul>
</li>
<li><p>bindService()</p>
<ul>
<li>作用：绑定Service服务 </li>
<li>手动调用bindService()后，自动调用内部方法：onCreate()、onBind()</li>
</ul>
</li>
<li><p>unbindService()</p>
<ul>
<li>作用：解绑Service服务 </li>
<li>手动调用unbindService()后，自动调用内部方法：onCreate()、onBind()、onDestory()</li>
</ul>
</li>
</ol>
<p>接口函数：</p>
<ul>
<li>onStartCommand()：当其他组件调用startService()方法请求启动Service时，该方法被回调。一旦Service启动，它会在后台独立运行。当Service执行完以后，需调用stopSelf() 或 stopService()方法停止Service。（若您只希望bind Service，则无需调用这些方法）</li>
<li>onBind()：当其他组件调用bindService()方法请求绑定Service时，该方法被回调。该方法返回一个IBinder接口，该接口是Service与绑定的组件进行交互的桥梁。若Service未绑定其他组件，该方法应返回null。</li>
<li>onCreate()：当Service第一次创建时，回调该方法。该方法只被回调一次，并在onStartCommand() 或 onBind()方法被回调之前执行。若Service处于运行状态，该方法不会回调。</li>
<li>onDestroy()：当Service被销毁时回调，在该方法中应清除一些占用的资源，如停止线程、接触绑定注册的监听器或broadcast receiver 等。该方法是Service中的最后一个回调。</li>
</ul>
<p>启动方式：</p>
<ul>
<li>Started：其他组件调用startService()方法启动一个Service。一旦启动，Service将一直运行在后台（run in the background indefinitely）即便启动Service的组件已被destroy。通常，一个被start的Service会在后台执行单独的操作，也并不给启动它的组件返回结果。比如说，一个start的Service执行在后台下载或上传一个文件的操作，完成之后，Service应自己停止。</li>
<li>Bound：其他组件调用bindService()方法绑定一个Service。通过绑定方式启动的Service是一个client-server结构，该Service可以与绑定它的组件进行交互。一个bound service仅在有组件与其绑定时才会运行（A bound service runs only as long as another application component is bound to it），多个组件可与一个service绑定，service不再与任何组件绑定时，该service会被destroy。</li>
</ul>
<p>注意：</p>
<ul>
<li>Service运行在主线程中（A service runs in the main thread of its hosting process），Service并不是一个新的线程，也不是新的进程。也就是说，若您需要在Service中执行较为耗时的操作（如播放音乐、执行网络请求等），需要在Service中创建一个新的线程。这可以防止ANR的发生，同时主线程可以执行正常的UI操作。</li>
<li>如果某个组件通过调用startService()启动了Service（系统会回调onStartCommand()方法），那么直到在Service中手动调用stopSelf()方法、或在其他组件中手动调用stopService()方法，该Service才会停止。</li>
<li>如果某个组件通过调用bindService()绑定了Service（系统不会回调onStartCommand()方法），只要该组件与Service处于绑定状态，Service就会一直运行，当Service不再与组件绑定时，该Service将被destroy。</li>
<li>当系统内存低时，系统将强制停止Service的运行；若Service绑定了正在与用户交互的activity，那么该Service将不大可能被系统kill（ less likely to be killed）。如果创建的是前台Service，那么该Service几乎不会被kill（almost never be killed）。否则，当创建了一个长时间在后台运行的Service后，系统会降低该Service在后台任务栈中的级别——这意味着它容易被kill（lower its position in the list of background tasks over time and the service will become highly susceptible to killing），所以在开发Service时，需要使Service变得容易被restart，因为一旦Service被kill，再restart它需要其资源可用时才行</li>
</ul>
<h2 id="注册-1"><a href="#注册-1" class="headerlink" title="注册"></a>注册</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.servicetest.MyService&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="继承IntentService类"><a href="#继承IntentService类" class="headerlink" title="继承IntentService类"></a>继承IntentService类</h2><ul>
<li>默认在子线程中处理回传到onStartCommand()方法中的Intent；</li>
<li>在重写的onHandleIntent()方法中处理按时间排序的Intent队列，所以不用担心多线程带来的问题。</li>
<li>当所有请求处理完成后，自动停止service，无需手动调用stopSelf()方法；</li>
<li>默认实现了onBind()方法，并返回null；</li>
<li>默认实现了onStartCommand()方法，并将回传的Intent以序列的形式发送给onHandleIntent()，只需重写该方法并处理Intent即可。</li>
</ul>
<p>示例：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyService</span> : <span class="type">IntentService</span></span>(<span class="string">&quot;MyService&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;LLL&quot;</span>, <span class="string">&quot;onCreate&quot;</span>)</span><br><span class="line">        <span class="keyword">super</span>.onCreate()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onStartCommand</span><span class="params">(intent: <span class="type">Intent</span>?, flags: <span class="type">Int</span>, startId: <span class="type">Int</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;LLL&quot;</span>, <span class="string">&quot;onStartCommand: <span class="variable">$startId</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;LLL&quot;</span>, <span class="string">&quot;onDestroy&quot;</span>)</span><br><span class="line">        <span class="keyword">super</span>.onDestroy()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onHandleIntent</span><span class="params">(intent: <span class="type">Intent</span>?)</span></span> &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;LLL&quot;</span>, <span class="string">&quot;Current thread: <span class="subst">$&#123;Thread.currentThread().name&#125;</span>&quot;</span>)</span><br><span class="line">        Log.d(<span class="string">&quot;LLL&quot;</span>, <span class="string">&quot;Intent: <span class="subst">$&#123;intent?.getStringExtra(<span class="string">&quot;name&quot;</span>)&#125;</span>&quot;</span>)</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用</span></span><br><span class="line"><span class="keyword">val</span> intent = Intent(<span class="keyword">this</span>, MyService::<span class="keyword">class</span>.java)</span><br><span class="line">intent.putExtra(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;hearing-1&quot;</span>)</span><br><span class="line">startService(intent)</span><br><span class="line">Thread.sleep(<span class="number">20</span>)</span><br><span class="line">intent.putExtra(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;hearing-2&quot;</span>)</span><br><span class="line">startService(intent)</span><br><span class="line">Thread.sleep(<span class="number">20</span>)</span><br><span class="line">intent.putExtra(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;hearing-3&quot;</span>)</span><br><span class="line">startService(intent)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 日志</span></span><br><span class="line">D/LLL: onCreate</span><br><span class="line">D/LLL: onStartCommand: <span class="number">1</span></span><br><span class="line">D/LLL: onStartCommand: <span class="number">2</span></span><br><span class="line">D/LLL: onStartCommand: <span class="number">3</span></span><br><span class="line">D/LLL: Current thread: IntentService[MyService]</span><br><span class="line">D/LLL: Intent: hearing-<span class="number">1</span></span><br><span class="line">D/LLL: Current thread: IntentService[MyService]</span><br><span class="line">D/LLL: Intent: hearing-<span class="number">2</span></span><br><span class="line">D/LLL: Current thread: IntentService[MyService]</span><br><span class="line">D/LLL: Intent: hearing-<span class="number">3</span></span><br><span class="line">D/LLL: onDestroy</span><br></pre></td></tr></table></figure>

<p>如果启动的 Service 存在则不会再次创，而会回调 onStartCommand 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(<span class="meta">@Nullable</span> Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">    onStart(intent, startId);</span><br><span class="line">    <span class="keyword">return</span> mRedelivery ? START_REDELIVER_INTENT : START_NOT_STICKY;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStart</span><span class="params">(<span class="meta">@Nullable</span> Intent intent, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">    Message msg = mServiceHandler.obtainMessage();</span><br><span class="line">    msg.arg1 = startId;</span><br><span class="line">    msg.obj = intent;</span><br><span class="line">    mServiceHandler.sendMessage(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceHandler</span><span class="params">(Looper looper)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(looper);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">        onHandleIntent((Intent)msg.obj);</span><br><span class="line">        <span class="comment">// 会检查 id 是否为最后一个 id，是则停止服务</span></span><br><span class="line">        stopSelf(msg.arg1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="继承Service类"><a href="#继承Service类" class="headerlink" title="继承Service类"></a>继承Service类</h2><p>如果需要在Service中执行多线程而不是处理一个请求队列，那么需要继承Service类，分别处理每个Intent。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">&quot;MyService&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MyBinder mBinder = <span class="keyword">new</span> MyBinder();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onCreate() executed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onStartCommand() executed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onStartCommand(intent, flags, startId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onDestroy() executed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mBinder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MyBinder</span> <span class="keyword">extends</span> <span class="title">Binder</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startDownload</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            Log.d(<span class="string">&quot;TAG&quot;</span>, <span class="string">&quot;startDownload() executed&quot;</span>);</span><br><span class="line">            <span class="comment">// 执行具体的下载任务</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>onStartCommand()返回一个整形变量，该变量必须是下列常量之一：</p>
<ul>
<li>START_NOT_STICKY：若执行完onStartCommand()方法后，系统就kill了service，不要再重新创建service，除非系统回传了一个pending intent。这避免了在不必要的时候运行service，您的应用也可以restart任何未完成的操作。</li>
<li>START_STICKY：若系统在onStartCommand()执行并返回后kill了service，那么service会被recreate并回调onStartCommand()。dangerous不要重新传递最后一个Intent（do not redeliver the last intent）。相反，系统回调onStartCommand()时回传一个空的Intent，除非有 pending intents传递，否则Intent将为null。该模式适合做一些类似播放音乐的操作。</li>
<li>START_REDELIVER_INTENT：若系统在onStartCommand()执行并返回后kill了service，那么service会被recreate并回调onStartCommand()并将最后一个Intent回传至该方法。任何 pending intents都会被轮流传递。该模式适合做一些类似下载文件的操作。</li>
</ul>
<h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><p>startService(intent)方法将立即返回，并回调onStartCommand()（请不要手动调用该方法），若该Service未处于运行状态，系统将首先回调onCreate()，接着再回调onStartCommand()。若您希望Service可以返回结果，那么需要通过调用getBroadcast 返回的PendingIntent启动Service（将PendingIntent包装为Intent），service可使用broadcast 传递结果。</p>
<p>多个启动Service的请求可能导致onStartCommand()多次调用，但只需调用stopSelf() 、 stopService()这两个方法之一，就可停止该服务。</p>
<h2 id="绑定Service"><a href="#绑定Service" class="headerlink" title="绑定Service"></a>绑定Service</h2><ul>
<li>通过其他组件调用bindService()方法可以绑定一个Service以保持长连接（long-standing connection），这时一般不允许其他组件调用startService()启动Service。</li>
<li>当其他组件需要与Service交互或者需要跨进程通信时，可以创建一个bound Service。</li>
<li>为创建一个bound Service，必须重写onBind()回调，该方法返回一个IBinder接口。该接口时组件与Service通信的桥梁。组件调用bindService()与Service绑定，该组件可获取IBinder接口，一旦获取该接口，就可以调用Service中的方法。一旦没有组件与Service绑定，系统将destroy它，您不必手动停止它。</li>
<li>为创建一个bound Service，必须定义一个接口 ，该接口指定组件与Service如何通信。定义的接口在组件与Service之间，且必须实现IBinder接口。这正是onBind()的返回值。一旦组件接收了IBinder，组件与Service便可以开始通信。</li>
<li>多个组件可同时与Service绑定，当组件与Service交互结束后，可调用unbindService()方法解绑。bound Service比start Service要复杂，故我将在后续单独翻译。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">OnClickListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> MyService.MyBinder myBinder;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ServiceConnection connection = <span class="keyword">new</span> ServiceConnection() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line">            myBinder = (MyService.MyBinder) service;</span><br><span class="line">            myBinder.startDownload();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (v.getId()) &#123;</span><br><span class="line">        <span class="keyword">case</span> R.id.start_service:</span><br><span class="line">            Intent startIntent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, MyService.class);</span><br><span class="line">            startService(startIntent);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.stop_service:</span><br><span class="line">            Intent stopIntent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, MyService.class);</span><br><span class="line">            stopService(stopIntent);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.bind_service:</span><br><span class="line">            Intent bindIntent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, MyService.class);</span><br><span class="line">            bindService(bindIntent, connection, BIND_AUTO_CREATE);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> R.id.unbind_service:</span><br><span class="line">            unbindService(connection);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="运行前台Service"><a href="#运行前台Service" class="headerlink" title="运行前台Service"></a>运行前台Service</h2><ul>
<li>前台Service用于动态通知消息，如天气预报。该Service不易被kill。前台Service必须提供status bar，只有前台Service被destroy后，status bar才能消失。</li>
<li>举例来说，一个播放音乐的Service必须是前台Service，只有这样用户才能确知其运行状态。为前台Service提供的status bar可以显示当前音乐的播放状态，并可以启动播放音乐的Activity。</li>
<li>调用startForeground()可以启动前台Service。该方法接收两个参数，参数一是一个int型变量，用户指定该通知的唯一性标识，而参数而是一个Notification用于配置status bar</li>
</ul>
<h1 id="ContentProvider"><a href="#ContentProvider" class="headerlink" title="ContentProvider"></a>ContentProvider</h1><h2 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h2><p>ContentProvider 需要实现的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Uri <span class="title">insert</span><span class="params">(Uri uri, ContentValues values)</span> </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(Uri uri, String selection, String[] selectionArgs)</span> </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Uri uri, ContentValues values, String selection, String[] selectionArgs)</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Cursor <span class="title">query</span><span class="params">(Uri uri, String[] projection, String selection, String[] selectionArgs,  String sortOrder)</span>　 </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreate</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">(Uri uri)</span></span></span><br></pre></td></tr></table></figure>

<p>参数含义：</p>
<ul>
<li>projection: 返回内容(conlumn名)，null 表示返回所有</li>
<li>selection: 设置条件</li>
<li>selectionArgs: selection 参数条件的内容</li>
<li>sortOrder: ASC(升序)，DESC(降序)，默认升序</li>
</ul>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cursor cursor = contentResolver.query(uri, <span class="keyword">new</span> String[]&#123;<span class="string">&quot;name&quot;</span>&#125;, <span class="string">&quot;name=?&quot;</span>, <span class="keyword">new</span> String[]&#123;<span class="string">&quot;hearing&quot;</span>&#125;, <span class="string">&quot;id DESC&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>可以通过 ContentResolver 类与 ContentProvider 统一进行交互；可以通过 ContentObserver 类监听 ContentProvider 中指定 Uri 的数据变化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyObserver</span> <span class="keyword">extends</span> <span class="title">ContentObserver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyObserver</span><span class="params">(Handler handler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(handler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onChange</span><span class="params">(<span class="keyword">boolean</span> selfChange, Uri uri)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onChange(selfChange, uri);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 步骤1：注册内容观察者ContentObserver</span></span><br><span class="line">getContentResolver().registerContentObserver(uri, <span class="keyword">true</span>, myOberver);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 步骤2：当该URI的ContentProvider数据发生变化时，通知外界</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserContentProvider</span> <span class="keyword">extends</span> <span class="title">ContentProvider</span> </span>&#123; </span><br><span class="line">    <span class="function"><span class="keyword">public</span> Uri <span class="title">insert</span><span class="params">(Uri uri, ContentValues values)</span> </span>&#123; </span><br><span class="line">        db.insert(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;userid&quot;</span>, values); </span><br><span class="line">        getContext().getContentResolver().notifyChange(uri, <span class="keyword">null</span>); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 步骤3：解除观察者</span></span><br><span class="line">getContentResolver().unregisterContentObserver(myOberver);</span><br></pre></td></tr></table></figure>

<h2 id="Uri"><a href="#Uri" class="headerlink" title="Uri"></a>Uri</h2><p>Uri 的四个组成部分：<code>content://contacts/people/5</code></p>
<ul>
<li>schema：已由Android固定设置为content://</li>
<li>authority：ContentProvider权限，在AndroidMenifest中设置权限</li>
<li>path：要操作的数据库表</li>
<li>id：查询的关键字（可选字段）</li>
</ul>
<p>Uri匹配模式：Uri的匹配表示要查询的数据，对于单个数据查询，可直接使用Uri定位具体的资源位置，但当范围查询时就需要结合通配符的使用，Uri提供以下两种通配符：</p>
<ul>
<li><code>*</code>：匹配由任意长度的任何有效字符组成的字符串</li>
<li><code>#</code>：匹配由任意长度的数字字符组成的字符串</li>
</ul>
<p>示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">content:<span class="comment">//com.example.app.provider/table2/*  //多数据查询</span></span><br><span class="line">content:<span class="comment">//com.example.app.provider/table3/#</span></span><br><span class="line">content:<span class="comment">//com.example.app.provider/table3/6  //单数据查询</span></span><br></pre></td></tr></table></figure>

<h2 id="ContentUris"><a href="#ContentUris" class="headerlink" title="ContentUris"></a>ContentUris</h2><p>核心方法有两个：</p>
<ul>
<li>withAppendedId()：向Uri追加一个id</li>
<li>parseId()：从Uri中获取id</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Uri uri = Uri.parse(<span class="string">&quot;content://com.hearing.provider/user&quot;</span>)</span><br><span class="line"><span class="comment">// 生成的Uri为：content://com.hearing.provider/user/7</span></span><br><span class="line">Uri resultUri = ContentUris.withAppendedId(uri, <span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">Uri uri = Uri.parse(<span class="string">&quot;content://com.hearing.provider/user/7&quot;</span>)</span><br><span class="line"><span class="comment">//获取的结果为:7</span></span><br><span class="line"><span class="keyword">long</span> personid = ContentUris.parseId(uri);</span><br></pre></td></tr></table></figure>

<h2 id="UriMatcher"><a href="#UriMatcher" class="headerlink" title="UriMatcher"></a>UriMatcher</h2><p>UriMatcher的作用：</p>
<ul>
<li>在 ContentProvider 中注册Uri</li>
<li>根据 Uri 匹配 ContentProvider 中对应的数据表</li>
</ul>
<p>使用步骤：</p>
<ol>
<li>初始化UriMatcher对象</li>
<li>在ContentProvider 中注册URI（addURI()）</li>
<li>根据URI 匹配 URI_CODE，从而匹配ContentProvider中相应的资源（match()）</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 步骤1：初始化UriMatcher对象</span></span><br><span class="line"><span class="comment">// 常量UriMatcher.NO_MATCH：不匹配任何路径的返回码</span></span><br><span class="line">UriMatcher matcher = <span class="keyword">new</span> UriMatcher(UriMatcher.NO_MATCH);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 步骤2：在ContentProvider 中注册URI</span></span><br><span class="line"><span class="keyword">int</span> URI_CODE_a = <span class="number">1</span>；</span><br><span class="line"><span class="keyword">int</span> URI_CODE_b = <span class="number">2</span>；</span><br><span class="line">matcher.addURI(<span class="string">&quot;com.hearing.provider&quot;</span>, <span class="string">&quot;user1&quot;</span>, URI_CODE_a); </span><br><span class="line">matcher.addURI(<span class="string">&quot;com.hearing.provider&quot;</span>, <span class="string">&quot;user2&quot;</span>, URI_CODE_b); </span><br><span class="line"><span class="comment">// 若URI资源路径 = content://com.hearing.provider/user1 ，则返回注册码URI_CODE_a</span></span><br><span class="line"><span class="comment">// 若URI资源路径 = content://com.hearing.provider/user2 ，则返回注册码URI_CODE_b</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 步骤3：根据URI 匹配 URI_CODE，从而匹配ContentProvider中相应的资源</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getTableName</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">    Uri uri = Uri.parse(<span class="string">&quot;content://com.hearing.provider/user1&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(matcher.match(uri)) &#123;</span><br><span class="line">        <span class="keyword">case</span> URI_CODE_a:</span><br><span class="line">            <span class="keyword">return</span> tableNameUser1;</span><br><span class="line">        <span class="keyword">case</span> URI_CODE_b:</span><br><span class="line">            <span class="keyword">return</span> tableNameUser2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h2><h3 id="概述-3"><a href="#概述-3" class="headerlink" title="概述"></a>概述</h3><p>指定其他应用访问提供程序的数据所必须具备权限的属性。</p>
<h3 id="grantUriPermssions"><a href="#grantUriPermssions" class="headerlink" title="grantUriPermssions"></a>grantUriPermssions</h3><p><code>android:grantUriPermssions</code>：表示是否可以通过临时权限访问数据，默认为false，在开发中可以只对限定的内容提供临时权限，如对照片的内容 URI 设置临时权限。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">android:grantUriPermissions=&quot;false&quot;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">grant-uri-permission</span> <span class="attr">android:path</span>=<span class="string">&quot;string&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:pathPattern</span>=<span class="string">&quot;string&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:pathPrefix</span>=<span class="string">&quot;string&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>true：系统会向整个系统授予临时权限，并替代其他设置的权限。</li>
<li>false：需添加<code>&lt;grant-uri-permission&gt;</code>并表明可以授权临时权限所对应的URI<ul>
<li>path：表示绝对路径Uri</li>
<li>pathPattern：表示限定完整的路径但可以使用./*通配符匹配</li>
<li>pathPrefix：限定路径的初始部分后面可以变化，只要初始部分符合即可授权</li>
</ul>
</li>
</ul>
<h3 id="permission"><a href="#permission" class="headerlink" title="permission"></a>permission</h3><ul>
<li>android:permission：统一提供程序范围读取/写入权限</li>
<li>android:readPermission：提供程序范围读取权限，优先于permission权限</li>
<li>android:writePermission：提供程序范围写入权限，优先于permission权限</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">android:readPermission=&quot;com.hearing.provider.permission.READ_PERMISSION&quot;</span><br><span class="line">android:writePermission=&quot;com.hearing.provider.permission.WRITE_PERMISSION&quot;</span><br><span class="line">android:permission=&quot;com.hearing.provider.permission.PERMISSION&quot;</span><br></pre></td></tr></table></figure>

<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><ol>
<li>创建两个程序A和B，在程序A中使用ContentProvider保存数据，在程序B中进行查询，在开始A程序中不设置任何权限，B程序进行访问数据会报错；</li>
<li>修改A程序清单文件添加android:exported=”true”，再次访问数据访问成功；</li>
<li>在A程序的清单文件中，为Provider添加两个读写权限，添加完权限后再次在B程序中获取数据，还是会报错，也很正常因为已经对数据的访问设置了门槛，所以在B程序中声明读写权限即可。</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- A程序 --&gt;</span></span><br><span class="line">android:writePermission=&quot;com.hearing.provider.provider.WRITE&quot;</span><br><span class="line">android:readPermission=&quot;com.hearing.provider.provider.READ&quot;</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- B程序 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;com.hearing.provider.provider.READ&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;com.hearing.provider.provider.WRITE&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="实例：IPC"><a href="#实例：IPC" class="headerlink" title="实例：IPC"></a>实例：IPC</h2><h3 id="进程一"><a href="#进程一" class="headerlink" title="进程一"></a>进程一</h3><p><strong>创建数据库类：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DBHelper</span> <span class="keyword">extends</span> <span class="title">SQLiteOpenHelper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据库名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DATABASE_NAME = <span class="string">&quot;finch.db&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 表名</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String USER_TABLE_NAME = <span class="string">&quot;user&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String JOB_TABLE_NAME = <span class="string">&quot;job&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据库版本号</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DATABASE_VERSION = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DBHelper</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, DATABASE_NAME, <span class="keyword">null</span>, DATABASE_VERSION);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(SQLiteDatabase db)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 创建两个表格:用户表 和职业表</span></span><br><span class="line">        db.execSQL(<span class="string">&quot;CREATE TABLE IF NOT EXISTS &quot;</span> + USER_TABLE_NAME + <span class="string">&quot;(_id INTEGER PRIMARY KEY AUTOINCREMENT,&quot;</span> + <span class="string">&quot; name TEXT)&quot;</span>);</span><br><span class="line">        db.execSQL(<span class="string">&quot;CREATE TABLE IF NOT EXISTS &quot;</span> + JOB_TABLE_NAME + <span class="string">&quot;(_id INTEGER PRIMARY KEY AUTOINCREMENT,&quot;</span> + <span class="string">&quot; job TEXT)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUpgrade</span><span class="params">(SQLiteDatabase db, <span class="keyword">int</span> oldVersion, <span class="keyword">int</span> newVersion)</span>   </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>自定义ContentProvider：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyProvider</span> <span class="keyword">extends</span> <span class="title">ContentProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Context mContext;</span><br><span class="line">    DBHelper mDbHelper = <span class="keyword">null</span>;</span><br><span class="line">    SQLiteDatabase db = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置ContentProvider的唯一标识</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTOHORITY = <span class="string">&quot;com.hearing.provider&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> User_Code = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> Job_Code = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// UriMatcher类使用:在ContentProvider 中注册URI</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> UriMatcher mMatcher;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        mMatcher = <span class="keyword">new</span> UriMatcher(UriMatcher.NO_MATCH);</span><br><span class="line">        <span class="comment">// 初始化</span></span><br><span class="line">        mMatcher.addURI(AUTOHORITY, <span class="string">&quot;user&quot;</span>, User_Code);</span><br><span class="line">        mMatcher.addURI(AUTOHORITY, <span class="string">&quot;job&quot;</span>, Job_Code);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mContext = getContext();</span><br><span class="line">        <span class="comment">// 在ContentProvider创建时对数据库进行初始化，不能做耗时操作，此处仅作展示</span></span><br><span class="line">        mDbHelper = <span class="keyword">new</span> DBHelper(getContext());</span><br><span class="line">        db = mDbHelper.getWritableDatabase();</span><br><span class="line"></span><br><span class="line">        db.execSQL(<span class="string">&quot;delete from user&quot;</span>);</span><br><span class="line">        db.execSQL(<span class="string">&quot;insert into user values(1,&#x27;Carson&#x27;);&quot;</span>);</span><br><span class="line">        db.execSQL(<span class="string">&quot;insert into user values(2,&#x27;Kobe&#x27;);&quot;</span>);</span><br><span class="line"></span><br><span class="line">        db.execSQL(<span class="string">&quot;delete from job&quot;</span>);</span><br><span class="line">        db.execSQL(<span class="string">&quot;insert into job values(1,&#x27;Android&#x27;);&quot;</span>);</span><br><span class="line">        db.execSQL(<span class="string">&quot;insert into job values(2,&#x27;iOS&#x27;);&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Uri <span class="title">insert</span><span class="params">(Uri uri, ContentValues values)</span> </span>&#123;</span><br><span class="line">        String table = getTableName(uri);</span><br><span class="line">        db.insert(table, <span class="keyword">null</span>, values);</span><br><span class="line">        mContext.getContentResolver().notifyChange(uri, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> uri;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Cursor <span class="title">query</span><span class="params">(Uri uri, String[] projection, String selection, String[] selectionArgs, String sortOrder)</span> </span>&#123;</span><br><span class="line">        String table = getTableName(uri);</span><br><span class="line">        <span class="keyword">return</span> db.query(table, projection, selection, selectionArgs, <span class="keyword">null</span>, <span class="keyword">null</span>, sortOrder, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(Uri uri, ContentValues values, String selection, String[] selectionArgs)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 此处不作展开</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(Uri uri, String selection, String[] selectionArgs)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 此处不作展开</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 此处不作展开</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getTableName</span><span class="params">(Uri uri)</span> </span>&#123;</span><br><span class="line">        String tableName = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> (mMatcher.match(uri)) &#123;</span><br><span class="line">            <span class="keyword">case</span> User_Code:</span><br><span class="line">                tableName = DBHelper.USER_TABLE_NAME;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Job_Code:</span><br><span class="line">                tableName = DBHelper.JOB_TABLE_NAME;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> tableName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注册ContentProvider：</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;MyProvider&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:authorities</span>=<span class="string">&quot;com.hearing.provider.myprovider&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:permission</span>=<span class="string">&quot;com.hearing.provider.PROVIDER&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:readPermission</span> = <span class="string">&quot;com.hearing.provider.Read&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:writePermission</span> = <span class="string">&quot;com.hearing.provider.Write&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">&quot;com.hearing.provider.Read&quot;</span> <span class="attr">android:protectionLevel</span>=<span class="string">&quot;normal&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">&quot;com.hearing.provider.Write&quot;</span> <span class="attr">android:protectionLevel</span>=<span class="string">&quot;normal&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">&quot;com.hearing.provider.PROVIDER&quot;</span> <span class="attr">android:protectionLevel</span>=<span class="string">&quot;normal&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="进程二"><a href="#进程二" class="headerlink" title="进程二"></a>进程二</h3><p><strong>声明权限：</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;com.hearing.provider.PROVIDER&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;com.hearing.provider.Read&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">&quot;com.hearing.provider.Write&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>访问ContentProvider：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置URI</span></span><br><span class="line">        Uri uri_user = Uri.parse(<span class="string">&quot;content://com.hearing.provider.myprovider/user&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 插入表中数据</span></span><br><span class="line">        ContentValues values = <span class="keyword">new</span> ContentValues();</span><br><span class="line">        values.put(<span class="string">&quot;_id&quot;</span>, <span class="number">4</span>);</span><br><span class="line">        values.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;Jordan&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取ContentResolver</span></span><br><span class="line">        ContentResolver resolver = getContentResolver();</span><br><span class="line">        <span class="comment">// 通过ContentResolver 根据URI 向ContentProvider中插入数据</span></span><br><span class="line">        resolver.insert(uri_user, values);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过ContentResolver 向ContentProvider中查询数据</span></span><br><span class="line">        Cursor cursor = resolver.query(uri_user, <span class="keyword">new</span> String[]&#123;<span class="string">&quot;_id&quot;</span>,<span class="string">&quot;name&quot;</span>&#125;, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">while</span> (cursor.moveToNext()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;query book:&quot;</span> + cursor.getInt(<span class="number">0</span>) +<span class="string">&quot; &quot;</span>+ cursor.getString(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        cursor.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 和上述类似,只是URI需要更改,从而匹配不同的URI CODE,从而找到不同的数据资源</span></span><br><span class="line">        Uri uri_job = Uri.parse(<span class="string">&quot;content://com.hearing.provider.myprovider/job&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 插入表中数据</span></span><br><span class="line">        ContentValues values2 = <span class="keyword">new</span> ContentValues();</span><br><span class="line">        values2.put(<span class="string">&quot;_id&quot;</span>, <span class="number">4</span>);</span><br><span class="line">        values2.put(<span class="string">&quot;job&quot;</span>, <span class="string">&quot;NBA Player&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取ContentResolver</span></span><br><span class="line">        ContentResolver resolver2 = getContentResolver();</span><br><span class="line">        <span class="comment">// 通过ContentResolver 根据URI 向ContentProvider中插入数据</span></span><br><span class="line">        resolver2.insert(uri_job,values2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过ContentResolver 向ContentProvider中查询数据</span></span><br><span class="line">        Cursor cursor2 = resolver2.query(uri_job, <span class="keyword">new</span> String[]&#123;<span class="string">&quot;_id&quot;</span>,<span class="string">&quot;job&quot;</span>&#125;, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">while</span> (cursor2.moveToNext()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;query job:&quot;</span> + cursor2.getInt(<span class="number">0</span>) +<span class="string">&quot; &quot;</span>+ cursor2.getString(<span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        cursor2.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="FileProvider"><a href="#FileProvider" class="headerlink" title="FileProvider"></a>FileProvider</h2><h3 id="概述-4"><a href="#概述-4" class="headerlink" title="概述"></a>概述</h3><p>对于面向Android 7.0及以上的应用，Android禁止在应用外部公开<code>file://url</code>。如果一项包含文件URI的intent离开应用，则应用会抛出FileUriExposedException异常。</p>
<p>解决方案：要在应用间共享文件，应发送一项content://URI，并授予URI临时访问权限。进行此授权的最简单方式是使用FileProvider类。FileProvider是ContentProvider的一个特殊的子类，它让应用间共享文件变得更加容易，其通过创建一个Content URI来代替File URI。</p>
<h3 id="注册FileProvider"><a href="#注册FileProvider" class="headerlink" title="注册FileProvider"></a>注册FileProvider</h3><p>由于FileProvider中已经包含了为file生成Content URI的基本代码了，所以开发者不必再去定义一个FileProvider的子类。你可以在XML文件中指定一个FileProvider：在manifest中使用<code>&lt;provider&gt;</code>标签来指定。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;android.support.v4.content.FileProvider&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:authorities</span>=<span class="string">&quot;com.hearing.fileprovider&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:grantUriPermissions</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:name</span>=<span class="string">&quot;android.support.FILE_PROVIDER_PATHS&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:resource</span>=<span class="string">&quot;@xml/file_paths&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>name的值一般都固定为android.support.v4.content.FileProvider。如果开发者继承了FileProvider，则可以写上其绝对路径。</li>
<li>authorities字段的值用来表明使用的使用者，在FileProvider的函数getUriForFile需要传入该参数。</li>
<li>exported 的值为false，表示该FileProvider只能本应用使用，不是public的。</li>
<li>grantUriPermissions 的值为true，表示允许赋予临时权限。</li>
</ul>
<h3 id="xml配置"><a href="#xml配置" class="headerlink" title="xml配置"></a>xml配置</h3><p>只有事先指定了目录，一个FileProvider才可以为文件生成一个对应的Content URI。要指定一个路径，需要在XML文件中指定其存储的路径。使用<code>&lt;paths&gt;</code>标签。例如:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">paths</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">files-path</span> <span class="attr">name</span>=<span class="string">&quot;my_images&quot;</span> <span class="attr">path</span>=<span class="string">&quot;images/&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">paths</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>&lt;root-path name=&quot;name&quot; path=&quot;path&quot; /&gt;</code>: <code>/</code></li>
<li><code>&lt;files-path name=&quot;name&quot; path=&quot;path&quot; /&gt;</code>: <code>/data/data/&lt;package-name&gt;/files/path/</code></li>
<li><code>&lt;cache-path name=&quot;name&quot; path=&quot;path&quot; /&gt;</code>: <code>/data/data/&lt;package-name&gt;/cache/path/</code></li>
<li><code>&lt;external-files-path name=&quot;name&quot; path=&quot;path&quot; /&gt;</code>: <code>Context.getExternalFilesDir(null) + &quot;/path/&quot;</code>，<code>/storage/emulated/0/Android/data/&lt;package_name&gt;/files/path/</code></li>
<li><code>&lt;external-cache-path name=&quot;name&quot; path=&quot;path&quot; /&gt;</code>: <code>Context.getExternalCacheDir() + &quot;/path/&quot;</code>，即<code>/storage/emulated/0/Android/data/&lt;package-name&gt;/cache/path/</code></li>
<li><code>&lt;external-media-path name=&quot;name&quot; path=&quot;path&quot; /&gt;</code>: <code>Context.getExternalMediaDirs() + &quot;/path/&quot;</code>，即<code>/storage/emulated/0/Android/media/&lt;package-name&gt;/path/</code></li>
<li><code>&lt;external-path name=&quot;name&quot; path=&quot;path&quot; /&gt;</code>: <code>Environment.getExternalStorageDirectory() + &quot;/path/&quot;</code>，即<code>/storage/emulated/0/path/</code></li>
</ul>
<p>在res目录下新建xml目录，然后新建文件file_paths.xml，根据上述内容编写。</p>
<h3 id="获取Content-Uri"><a href="#获取Content-Uri" class="headerlink" title="获取Content Uri"></a>获取Content Uri</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">File file = <span class="keyword">new</span> File(mContext.getFilesDir() + <span class="string">&quot;/text&quot;</span>, <span class="string">&quot;hello.txt&quot;</span>);</span><br><span class="line">Uri data;</span><br><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;</span><br><span class="line">    data = FileProvider.getUriForFile(mContext, <span class="string">&quot;com.hearing.fileprovider&quot;</span>, file);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    data = Uri.fromFile(file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="赋予临时权限"><a href="#赋予临时权限" class="headerlink" title="赋予临时权限"></a>赋予临时权限</h3><p>两种方法：（通常使用第2种）</p>
<ol>
<li>Context.grantUriPermission(package, Uri, mode_flags)</li>
<li>Intent.setFlags()：<code>intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION | FLAG_GRANT_WRITE_URI_PERMISSION);</code></li>
</ol>
<p>Flag意义如下：</p>
<ul>
<li>FLAG_GRANT_READ_URI_PERMISSION：表示读取权限； </li>
<li>FLAG_GRANT_WRITE_URI_PERMISSION：表示写入权限。</li>
</ul>
<h3 id="分享文件URI"><a href="#分享文件URI" class="headerlink" title="分享文件URI"></a>分享文件URI</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">shareFile</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Log.d(TAG, <span class="string">&quot;shareFile: &quot;</span>);</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent();</span><br><span class="line">    ComponentName componentName = <span class="keyword">new</span> ComponentName(<span class="string">&quot;com.hearing.fileproviderclient&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.hearing.fileproviderclient.MainActivity&quot;</span>);</span><br><span class="line">    intent.setComponent(componentName);</span><br><span class="line">    File file = <span class="keyword">new</span> File(mContext.getFilesDir() + <span class="string">&quot;/text&quot;</span>, <span class="string">&quot;hello.txt&quot;</span>);</span><br><span class="line">    Uri data;</span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;</span><br><span class="line">        data = FileProvider.getUriForFile(mContext, FILE_PROVIDER_AUTHORITIES, file);</span><br><span class="line">        <span class="comment">// 给目标应用一个临时授权</span></span><br><span class="line">        intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        data = Uri.fromFile(file);</span><br><span class="line">    &#125;</span><br><span class="line">    intent.setData(data);</span><br><span class="line">    startActivity(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Mime-Type"><a href="#Mime-Type" class="headerlink" title="Mime Type"></a>Mime Type</h1><h2 id="概述-5"><a href="#概述-5" class="headerlink" title="概述"></a>概述</h2><p>MIME：多用途互联网邮件扩展（Multipurpose Internet Mail Extensions）是一个互联网标准，它扩展了电子邮件标准，使其能够支持非ASCII字符、二进制格式附件等多种格式的邮件消息。</p>
<p>MIME TYPE一般以这种形式出现：<code>[type]/[subtype]</code></p>
<p>type标识内容type，有下面的形式：</p>
<ul>
<li>Text：用于标准化地表示的文本信息，文本消息可以是多种字符集和或者多种格式的；</li>
<li>Multipart：用于连接消息体的多个部分构成一个消息，这些部分可以是不同类型的数据；</li>
<li>Application：用于传输应用程序数据或者二进制数据；</li>
<li>Message：用于包装一个E-mail消息；</li>
<li>Image：用于传输静态图片数据；</li>
<li>Audio：用于传输音频或者音声数据；</li>
<li>Video：用于传输动态影像数据，可以是与音频编辑在一起的视频数据格式。</li>
</ul>
<p>subtype用于指定type的详细形式。<code>content-type/subtype</code>配对的集合和与此相关的参数，将随着时间而增长。为了确保这些值在一个有序而且公开的状态下开发，MIME使用Internet Assigned Numbers Authority (IANA)作为中心的注册机制来管理这些值。常用的subtype值如下所示：</p>
<ul>
<li>text/plain（纯文本）</li>
<li>text/html（HTML文档）</li>
<li>application/xhtml+xml（XHTML文档）</li>
<li>image/gif（GIF图像）</li>
<li>image/jpeg（JPEG图像）</li>
<li>image/png（PNG图像）</li>
<li>video/mpeg（MPEG动画）</li>
<li>application/octet-stream（任意的二进制数据）</li>
<li>application/pdf（PDF文档）</li>
<li>application/msword（Microsoft Word文件）</li>
<li>message/rfc822（RFC 822形式）</li>
<li>multipart/alternative（HTML邮件的HTML形式和纯文本形式，相同内容使用不同形式表示）</li>
<li>application/x-www-form-urlencoded（使用HTTP的POST方法提交的表单）</li>
<li>multipart/form-data（同上，但主要用于表单提交时伴随文件上传的场合）</li>
</ul>
<h2 id="使用-1"><a href="#使用-1" class="headerlink" title="使用"></a>使用</h2><p>当Android系统接收到一个隐式Intent要启动一个Activity(或其他组件)时，Android会根据以下三个信息比较Intent的信息与注册的组件的intent-filter的信息，从而为该Intent选择出最匹配的Activity(或其他组件)：</p>
<ul>
<li>intent中的action</li>
<li>intent中的category</li>
<li>intent中的data（包含Uri以及data的MIME类型）</li>
</ul>
<p>也就是隐式intent对象要满足要启动的目标组件中注册的intent-filter中的<code>&lt;action/&gt;</code>、<code>&lt;category/&gt;</code>、<code>&lt;data/&gt;</code>三个标签中的信息，即要分别通过action测试、category测试以及data测试。</p>
<p>MINI类型即在data中指定。</p>
<h1 id="Intent和Intent-filter"><a href="#Intent和Intent-filter" class="headerlink" title="Intent和Intent-filter"></a>Intent和Intent-filter</h1><h2 id="概述-6"><a href="#概述-6" class="headerlink" title="概述"></a>概述</h2><ul>
<li>Intent 是一个消息传递对象，可以用来从其他应用组件请求操作, Intent 包括显式和隐式。</li>
<li>Intent-filter 是 Manifest 中的一个表达式，用于指定该组件要接收的 Intent 类型。</li>
</ul>
<p>为了确保应用的安全性，启动 Service 时应该始终使用显式 Intent，且不要为服务声明 Intent-filter。</p>
<h2 id="构建Intent"><a href="#构建Intent" class="headerlink" title="构建Intent"></a>构建Intent</h2><h3 id="Component-name"><a href="#Component-name" class="headerlink" title="Component name"></a>Component name</h3><p>可选项，如果没有组件名称，则 Intent 为隐式，如需在应用中启动特定的组件，则应指定该组件的名称。可以使用 setComponent(), setClass(), setClassName() 或 Intent 构造函数设置组件名称。</p>
<h3 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h3><p>可以指定自己的 action。以下是一些用于启动 Activity 的常见操作：</p>
<ol>
<li>ACTION_VIEW: 拥有一些可向用户显示的信息(查看照片 或 观看视频等)。</li>
<li>ACTION_SEND：拥有一些用户可通过其他应用(例如电子邮件应用 或 社交共享应用)共享的数据。</li>
</ol>
<p>可以使用 setAction() 或 Intent 构造函数为 Intent 指定操作。</p>
<h3 id="Data"><a href="#Data" class="headerlink" title="Data"></a>Data</h3><p>指定数据 MIME 类型的 URI，提供的数据类型通常由 Intent 的 Action 决定，例如如果操作是 ACTION_EDIT 则数据应包含待编辑文档的 URI。</p>
<p>可以使用 setData() 设置数据 URI；可以使用 setType() 设置 MIME 类型；可以使用 setDataAndType() 同时显式设置二者。注意：若要同时设置 URI 和 MIME 类型，请勿调用 setData() 和 setType()，因为它们会互相抵消彼此的值。</p>
<h3 id="Category"><a href="#Category" class="headerlink" title="Category"></a>Category</h3><p>一个包含应处理 Intent 组件类型的附加信息的字符串。可以将任意数量的Category放入一个 Intent 中，但大多数 Intent 均不需要 Category。以下是一些常见category：</p>
<ul>
<li>CATEGORY_BROWSABLE：目标 Activity 允许本身通过网络浏览器启动，以显示链接引用的数据，如图像或电子邮件。</li>
<li>CATEGORY_LAUNCHER：该 Activity 是任务的初始 Activity，在系统的应用启动器中列出。</li>
<li>CATEGORY_HOME：桌面应用需要声明。</li>
<li>CATEGORY_DEFAULT：通过隐式启动Activity时，Android会默认加上一个CATEGORY_DEFAULT，所以如果Activity要支持隐式启动的话，除了默认LaunchActivity，其余都需要加上CATEGORY_DEFAULT。</li>
</ul>
<p>可以使用 addCategory() 指定 category。</p>
<h3 id="Extras"><a href="#Extras" class="headerlink" title="Extras"></a>Extras</h3><p>携带完成请求操作所需的附加信息的键值对，可以使用各种 putExtra() 方法添加 extra 数据。</p>
<h3 id="Flags"><a href="#Flags" class="headerlink" title="Flags"></a>Flags</h3><p>可以使用 setFlags() 方法添加Flags。</p>
<h2 id="接收隐式-Intent"><a href="#接收隐式-Intent" class="headerlink" title="接收隐式 Intent"></a>接收隐式 Intent</h2><p>应用组件应当为自身可执行的每个独特作业声明单独的filter。例如，图像库应用中的一个 Activity 可能会有两个filter，分别用于查看图像和编辑图像。</p>
<p>在 <code>&lt;intent-filter&gt;</code> 内部可以使用以下三个元素中的一个或多个指定要接受的 Intent 类型：</p>
<ul>
<li><code>&lt;action&gt;</code>：在 name 属性中，声明接受的 Intent 操作。</li>
<li><code>&lt;data&gt;</code>：使用一个或多个指定数据 URI（scheme、host、port、path）各个方面和 MIME 类型的属性，声明接受的数据类型。</li>
<li><code>&lt;category&gt;</code>：在 name 属性中，声明接受的 Intent category。</li>
</ul>
<p>请注意：要接收隐式 Intent，必须将 CATEGORY_DEFAULT category 包括在 Intent-filter中。方法 startActivity() 和 startActivityForResult() 将按照其声明 CATEGORY_DEFAULT category的方式处理所有 Intent。如果未在 Intent-filter中声明此category，则隐式 Intent 不会解析为您的 Activity。</p>
<p>可以创建一个包括多个 <code>&lt;action&gt;</code>、<code>&lt;data&gt;</code> 或 <code>&lt;category&gt;</code> 实例的filter，创建时，需确定组件能够处理这些filter元素的任何及所有组合。系统通过将 Intent 与所有这三个元素进行比较，根据filter测试隐式 Intent。隐式 Intent 若要传递给组件，必须通过所有这三项测试。</p>
<h2 id="Intent-解析"><a href="#Intent-解析" class="headerlink" title="Intent 解析"></a>Intent 解析</h2><p>当收到隐式 Intent 以启动 Activity 时，系统会根据以下三个方面将该 Intent 与 Intent-filter进行比较，搜索该 Intent 的最佳 Activity：</p>
<ul>
<li>Action</li>
<li>Data（URI 和数据类型）。</li>
<li>Category</li>
</ul>
<h3 id="Action测试"><a href="#Action测试" class="headerlink" title="Action测试"></a>Action测试</h3><p>要指定接受的 Intent action，Intent-filter既可以不声明任何 <code>&lt;action&gt;</code> 元素，也可以声明多个此类元素。要通过此filter，Intent 中指定的action必须与filter中列出的某一action匹配。</p>
<h3 id="Category测试"><a href="#Category测试" class="headerlink" title="Category测试"></a>Category测试</h3><p>要指定接受的 Intent category，Intent-filter既可以不声明任何 <code>&lt;category&gt;</code> 元素，也可以声明多个此类元素。要使 Intent 通过category测试，则 Intent 中的每个category均必须与filter中的category匹配。Intent-filter声明的category可以超出 Intent 中指定的数量，因此不含category的 Intent 应当始终会通过此测试，无论filter中声明何种category均是如此。</p>
<p>请注意：Android 会自动将 CATEGORY_DEFAULT category应用于传递给 startActivity() 和 startActivityForResult() 的所有隐式 Intent。如需 Activity 接收隐式 Intent，则必须将 “android.intent.category.DEFAULT” 的category包括在其 Intent-filter中。</p>
<h3 id="Data测试"><a href="#Data测试" class="headerlink" title="Data测试"></a>Data测试</h3><p>要指定接受的 Intent 数据，Intent-filter既可以不声明任何 <code>&lt;data&gt;</code> 元素，也可以声明多个此类元素，如下例所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:mimeType</span>=<span class="string">&quot;video/mpeg&quot;</span> <span class="attr">android:scheme</span>=<span class="string">&quot;http&quot;</span> <span class="attr">...</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:mimeType</span>=<span class="string">&quot;audio/mpeg&quot;</span> <span class="attr">android:scheme</span>=<span class="string">&quot;http&quot;</span> <span class="attr">...</span> /&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>每个 <code>&lt;data&gt;</code> 元素均可指定 URI 结构和数据类型（MIME 媒体类型）。URI 的每个部分都是一个单独的属性：scheme、host、port 和 path：<code>&lt;scheme&gt;://&lt;host&gt;:&lt;port&gt;/&lt;path&gt;</code></p>
<p>在 <code>&lt;data&gt;</code> 元素中，上述每个属性均为可选，但存在线性依赖关系：</p>
<ul>
<li>如果未指定scheme，则会忽略host。</li>
<li>如果未指定host，则会忽略port。</li>
<li>如果未指定scheme和host，则会忽略path。</li>
</ul>
<p>将 Intent 中的 URI 与filter中的 URI 规范进行比较时，它仅与filter中包含的部分 URI 进行比较。例如：</p>
<ul>
<li>如果filter仅指定scheme，则具有该scheme的所有 URI 均与该filter匹配。</li>
<li>如果filter指定scheme和host，但未指定path，则具有相同scheme和host的所有 URI 都会通过filter，无论其path如何均是如此。</li>
<li>如果filter指定scheme、host和path，则仅具有相同scheme、host和path的 URI 才会通过filter。</li>
</ul>
<p>请注意：path规范可以包含星号通配符 (*)，因此仅需部分匹配路径名即可。</p>
<p>数据测试会将 Intent 中的 URI 和 MIME 类型与filter中指定的 URI 和 MIME 类型进行比较。规则如下：</p>
<ul>
<li>仅当filter未指定任何 URI 或 MIME 类型时，不含 URI 和 MIME 类型的 Intent 才会通过测试。</li>
<li>对于包含 URI 但不含 MIME 类型（既未显式声明，也无法通过 URI 推断得出）的 Intent，仅当其 URI 与filter的 URI 格式匹配、且filter同样未指定 MIME 类型时，才会通过测试。</li>
<li>仅当filter列出相同的 MIME 类型且未指定 URI 格式时，包含 MIME 类型但不含 URI 的 Intent 才会通过测试。</li>
<li>仅当 MIME 类型与filter中列出的类型匹配时，同时包含 URI 类型和 MIME 类型（通过显式声明，或可以通过 URI 推断得出）的 Intent 才会通过测试的 MIME 类型部分。如果 Intent 的 URI 与filter中的 URI 匹配，或者如果 Intent 具有 content: 或 file: URI 且filter未指定 URI，则 Intent 会通过测试的 URI 部分。换言之，如果filter只是列出 MIME 类型，则假定组件支持 content: 和 file: 数据。</li>
</ul>
<p>请注意：如果 Intent 指定 URI 或 MIME 类型，则数据测试会在 <code>&lt;intent-filter&gt;</code> 中没有 <code>&lt;data&gt;</code> 元素时失败。</p>
<p>最后一条规则反映出对组件能够从文件中或内容提供程序处获得本地数据的预期。因此，其filter只能列出数据类型，不需要显式命名 content: 和 file: scheme。以下是一个典型示例，说明 <code>&lt;data&gt;</code> 元素向 Android 指出，组件可从内容提供程序处获得并显示图像数据：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:mimeType</span>=<span class="string">&quot;image/*&quot;</span> /&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>由于大部分可用数据均由内容提供程序分发，因此指定数据类型（而非 URI）的filter也许最为常见。</p>
<p>另一常见的配置是具有scheme和数据类型的filter。例如，下文中的 <code>&lt;data&gt;</code> 元素向 Android 指出，组件可从网络中检索视频数据以执行操作：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:scheme</span>=<span class="string">&quot;http&quot;</span> <span class="attr">android:mimeType</span>=<span class="string">&quot;video/*&quot;</span> /&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/10/Android%E5%8A%A8%E7%94%BB%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/10/Android%E5%8A%A8%E7%94%BB%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Android动画笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-10 14:20:19" itemprop="dateCreated datePublished" datetime="2019-09-10T14:20:19+08:00">2019-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/Framework/" itemprop="url" rel="index"><span itemprop="name">Framework</span></a>
                </span>
            </span>

          
            <span id="/2019/09/10/Android%E5%8A%A8%E7%94%BB%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="Android动画笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/09/10/Android%E5%8A%A8%E7%94%BB%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/09/10/Android%E5%8A%A8%E7%94%BB%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="View动画（补间动画）"><a href="#View动画（补间动画）" class="headerlink" title="View动画（补间动画）"></a>View动画（补间动画）</h1><table>
<thead>
<tr>
<th align="center">XML</th>
<th align="center">Java</th>
<th align="center">效果</th>
</tr>
</thead>
<tbody><tr>
<td align="center">alph</td>
<td align="center">AlphaAnimation</td>
<td align="center">渐变透明度动画效果</td>
</tr>
<tr>
<td align="center">scale</td>
<td align="center">ScaleAnimation</td>
<td align="center">渐变尺寸伸缩动画效果</td>
</tr>
<tr>
<td align="center">translate</td>
<td align="center">TranslateAnimation</td>
<td align="center">画面转换位置移动动画效果</td>
</tr>
<tr>
<td align="center">rotate</td>
<td align="center">RotateAnimation</td>
<td align="center">画面转移旋转动画效果</td>
</tr>
</tbody></table>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/2019/09/10/Android%E5%8A%A8%E7%94%BB%E7%AC%94%E8%AE%B0/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/27/Linux%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/27/Linux%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Linux笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-08-27 17:55:01" itemprop="dateCreated datePublished" datetime="2019-08-27T17:55:01+08:00">2019-08-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/OS/" itemprop="url" rel="index"><span itemprop="name">OS</span></a>
                </span>
            </span>

          
            <span id="/2019/08/27/Linux%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="Linux笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/08/27/Linux%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/08/27/Linux%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><h2 id="多条命令执行结果不输出到终端"><a href="#多条命令执行结果不输出到终端" class="headerlink" title="多条命令执行结果不输出到终端"></a>多条命令执行结果不输出到终端</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用;分隔的多条命令执行结果之间互不干扰</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls;lls;ls</span></span><br><span class="line">Downloads  termux-packages</span><br><span class="line">zsh: command not found: lls</span><br><span class="line">Downloads  termux-packages</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用&amp;&amp;分割的多条命令后一条会在前一条命令执行成功后才执行</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls&amp;&amp;lls&amp;&amp;ls</span></span><br><span class="line">Downloads  termux-packages</span><br><span class="line">zsh: command not found: lls</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用cmd &gt; /dev/null 2&gt;&amp;1将输出重定向到null，即不输出到终端</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用<span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span> <span class="built_in">echo</span> 1; <span class="keyword">else</span> <span class="built_in">echo</span> 0;<span class="keyword">fi</span>;可以得到上一条命令的执行结果（$?表示上一条命令的执行结果）</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls &gt; /dev/null 2&gt;&amp;1;<span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span> <span class="built_in">echo</span> 1; <span class="keyword">else</span> <span class="built_in">echo</span> 0;<span class="keyword">fi</span>;</span></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用&#123;&#125;包裹起来的多条命令</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> &#123;ls&amp;&amp;ls&amp;&amp;ls&#125; &gt; /dev/null 2&gt;&amp;1;<span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span> <span class="built_in">echo</span> 1; <span class="keyword">else</span> <span class="built_in">echo</span> 0;<span class="keyword">fi</span>;</span></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">echo</span>指定-e参数可开启转移，添加/c可不换行输出</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> -e <span class="string">&quot;please input a value:\c&quot;</span>;</span></span><br></pre></td></tr></table></figure>

<h2 id="后台运行"><a href="#后台运行" class="headerlink" title="后台运行"></a>后台运行</h2><p>当用户注销（logout）或者网络断开时，终端会收到 HUP（hangup）信号从而关闭其所有子进程。因此，解决办法有两种途径：</p>
<ul>
<li>让进程忽略 HUP 信号；</li>
<li>让进程运行在新的会话里从而成为不属于此终端的子进程。</li>
</ul>
<h3 id="nohup"><a href="#nohup" class="headerlink" title="nohup"></a>nohup</h3><p>nohup 的用途就是让提交的命令忽略 hangup 信号，一般我们可在结尾加上”&amp;”来将命令同时放入后台运行，也可用”&gt;filename 2&gt;&amp;1”来更改缺省的重定向文件名。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nohup ping www.baidu.com &amp;</span></span><br><span class="line">[1] 3059</span><br><span class="line">nohup: appending output to &#x27;nohup.out&#x27;</span><br><span class="line"><span class="meta">$</span><span class="bash"> ps -ef |grep 3059</span></span><br><span class="line">root      3059   984  0 21:06 pts/3    00:00:00 ping www.baidu.com</span><br><span class="line">root      3067   984  0 21:06 pts/3    00:00:00 grep 3059</span><br></pre></td></tr></table></figure>

<h3 id="setsid"><a href="#setsid" class="headerlink" title="setsid"></a>setsid</h3><p>换个角度思考，如果我们的进程不属于接受 HUP 信号的终端的子进程，那么自然也就不会受到 HUP 信号的影响了。setsid 就能做到这一点。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> setsid ping www.baidu.com</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ps -ef |grep www.baidu.com</span></span><br><span class="line">root     31094     1  0 07:28 ?        00:00:00 ping www.baidu.com</span><br><span class="line">root     31102 29217  0 07:29 pts/4    00:00:00 grep www.baidu.com</span><br></pre></td></tr></table></figure>

<p>进程 ID(PID)为31094，而它的父 ID（PPID）为1（即为 init 进程 ID），并不是当前终端的进程 ID。</p>
<h3 id="amp"><a href="#amp" class="headerlink" title="&amp;"></a>&amp;</h3><p>将一个或多个命名包含在<code>()</code>中就能让这些命令在子 shell 中运行中，从而扩展出很多有趣的功能。</p>
<p>当我们将<code>&amp;</code>也放入<code>()</code>内之后，就会发现所提交的作业并不在作业列表中，也就是说，是无法通过jobs来查看的。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> (ping www.baidu.com &amp;)</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ps -ef |grep www.baidu.com</span></span><br><span class="line">root     16270     1  0 14:13 pts/4    00:00:00 ping www.baidu.com</span><br><span class="line">root     16278 15362  0 14:13 pts/4    00:00:00 grep www.baidu.com</span><br></pre></td></tr></table></figure>

<p>从上例中可以看出，新提交的进程的父 ID（PPID）为1（init 进程的 PID），并不是当前终端的进程 ID。因此并不属于当前终端的子进程，从而也就不会受到当前终端的 HUP 信号的影响了。</p>
<h2 id="查看进程"><a href="#查看进程" class="headerlink" title="查看进程"></a>查看进程</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><ul>
<li>VSS - Virtual Set Size 虚拟耗用内存（包含共享库占用的内存），一个进程总共可访问的地址空间。其大小还包括了可能不在RAM中的内存（比如虽然malloc分配了空间，但尚未写入）。 VSS 很少被用于判断一个进程的真实内存使用量。</li>
<li>RSS - Resident Set Size 实际使用物理内存（包含共享库占用的内存），一个进程在RAM中真实存储的总内存。但是RSS还是可能会造成误导，因为它仅仅表示该进程所使用的所有共享库的大小，它不管有多少个进程使用该共享库，该共享库仅被加载到内存一次。所以RSS并不能准确反映单进程的内存占用情况。 </li>
<li>PSS - Proportional Set Size 实际使用的物理内存（比例分配共享库占用的内存），按比例表示使用的共享库， 例如：如果有三个进程都使用了一个共享库，共占用了30页内存。那么PSS将认为每个进程分别占用该共享库10页的大小。 PSS是非常有用的数据，因为系统中所有进程的PSS都相加的话，就刚好反映了系统中的总共占用的内存。 而当一个进程被销毁之后， 其占用的共享库那部分比例的PSS，将会再次按比例分配给余下使用该库的进程。这样PSS可能会造成一点的误导，因为当一个进程被销毁后，PSS不能准确地表示返回给全局系统的内存（the memory returned to the overall system）。</li>
<li>USS - Unique Set Size 进程独自占用的物理内存（不包含共享库占用的内存），一个进程所占用的私有内存。即该进程独占的内存。 USS是非常非常有用的数据，因为它反映了运行一个特定进程真实的边际成本（增量成本）。当一个进程被销毁后，USS是真实返回给系统的内存。当进程中存在一个可疑的内存泄露时，USS是最佳观察数据。</li>
</ul>
<p>一般来说内存占用大小有如下规律：VSS &gt;= RSS &gt;= PSS &gt;= USS</p>
<h3 id="free"><a href="#free" class="headerlink" title="free"></a>free</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> free -h</span></span><br><span class="line">       total       used        free      shared  buff/cache   available</span><br><span class="line">Mem:   7.9G        6.6G        1.0G         17M        223M        1.1G</span><br><span class="line">Swap:  19G         566M         19G                                    </span><br></pre></td></tr></table></figure>

<h3 id="top"><a href="#top" class="headerlink" title="top"></a>top</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 得到进程的pid</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> pidof sleep</span></span><br><span class="line">602</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> top指定查看PID</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> top -p 602</span></span><br><span class="line">top - 11:01:36 up 23 min,  0 users,  load average: 0.52, 0.58, 0.59</span><br><span class="line">Tasks:   1 total,   0 running,   1 sleeping,   0 stopped,   0 zombie</span><br><span class="line"><span class="meta">%</span><span class="bash">Cpu(s):  0.7 us,  0.9 sy,  0.0 ni, 98.2 id,  0.0 wa,  0.2 hi,  0.0 si,  0.0 st</span></span><br><span class="line">KiB Mem :  8266588 total,  2224708 free,  5812528 used,   229352 buff/cache</span><br><span class="line">KiB Swap: 20680852 total, 19784620 free,   896232 used.  2320328 avail Mem</span><br><span class="line"></span><br><span class="line">PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND</span><br><span class="line">602 hearing   15 42+   13956    808    688 S   0.0  0.0   0:00.01 sleep</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> top查看某些指定的PID</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> top -p 602,666,1001</span></span><br></pre></td></tr></table></figure>

<ul>
<li>键入 <code>P</code> 按照CPU排序输出</li>
<li>键入 <code>M</code> 按照内存排序输出</li>
</ul>
<h3 id="ps"><a href="#ps" class="headerlink" title="ps"></a>ps</h3><p>ps是显示瞬间进程的状态，并不动态连续；如果想对进程进行实时监控应该用top命令。如果输出较多可以结合less命令和管道来使用，即 <code>ps -ef | less</code> 。</p>
<ul>
<li>-A：所有的进程均显示出来，与 -e 具有同样的效用</li>
<li>-a：显示现行终端机下的所有进程，包括其他用户的进程</li>
<li>-u：以用户为主的进程状态/以针对用户的格式输出</li>
<li>-x：通常与 a 这个参数一起使用，可列出较完整信息</li>
<li>-l：较长、较详细的将该PID 的的信息列出；</li>
<li>-j：工作的格式 (jobs format)</li>
<li>-f：做一个更为完整的输出。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 根据CPU使用率来升序排序</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ps -aux --sort -pcpu | less</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 根据内存使用率来升序排序</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ps -aux --sort -pmem | less</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 合并命令，并通过管道显示前10个结果</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ps -aux --sort -pcpu,+pmem | head -n 10</span></span><br></pre></td></tr></table></figure>

<p>可以使用 <code>-C</code> 参数查看指定进程的信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ps -f -C sleep</span></span><br><span class="line">UID        PID  PPID  C STIME TTY          TIME CMD</span><br><span class="line">hearing    348     7  0 10:45 tty1     00:00:00 sleep 555</span><br></pre></td></tr></table></figure>

<p>也可以结合<code>watch</code>命令实时查看信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 每秒执行一次ps -aux --sort -pmem, -pcpu</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> watch -n 1 <span class="string">&#x27;ps -aux --sort -pmem, -pcpu&#x27;</span></span></span><br></pre></td></tr></table></figure>

<h3 id="proc"><a href="#proc" class="headerlink" title="proc"></a>proc</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat /proc/<span class="variable">$pid</span>/status</span></span><br><span class="line">Name:	main</span><br><span class="line">State:	S (sleeping)</span><br><span class="line">Tgid:	24154</span><br><span class="line">Pid:	24154</span><br><span class="line">PPid:	1</span><br><span class="line">TracerPid:	0</span><br><span class="line">Uid:	2000	2000	2000	2000</span><br><span class="line">Gid:	2000	2000	2000	2000</span><br><span class="line">FDSize:	32</span><br><span class="line">Groups:	1004 1007 1011 1015 1028 3001 3002 3003 3006</span><br><span class="line">VmPeak:	  777484 kB</span><br><span class="line">VmSize:	  777484 kB</span><br><span class="line">VmLck:	       0 kB</span><br><span class="line">VmPin:	       0 kB</span><br><span class="line">VmHWM:	   26960 kB</span><br><span class="line">VmRSS:	   26960 kB</span><br><span class="line">VmData:	   11680 kB</span><br><span class="line">VmStk:	    8192 kB</span><br><span class="line">VmExe:	      12 kB</span><br><span class="line">VmLib:	   52812 kB</span><br><span class="line">VmPTE:	     134 kB</span><br><span class="line">VmSwap:	       0 kB</span><br><span class="line">Threads:	13</span><br><span class="line">SigQ:	0/6947</span><br><span class="line">SigPnd:	0000000000000000</span><br><span class="line">ShdPnd:	0000000000000000</span><br><span class="line">SigBlk:	0000000000001204</span><br><span class="line">SigIgn:	0000000000000001</span><br><span class="line">SigCgt:	00000002000094f8</span><br><span class="line">CapInh:	0000000000000000</span><br><span class="line">CapPrm:	0000000000000000</span><br><span class="line">CapEff:	0000000000000000</span><br><span class="line">CapBnd:	00000000000000c0</span><br><span class="line">Seccomp:	0</span><br><span class="line">Cpus_allowed:	f</span><br><span class="line">Cpus_allowed_list:	0-3</span><br><span class="line">voluntary_ctxt_switches:	18</span><br><span class="line">nonvoluntary_ctxt_switches:	76</span><br></pre></td></tr></table></figure>

<h3 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h3><h4 id="procrank"><a href="#procrank" class="headerlink" title="procrank"></a>procrank</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">rocrank</span><br><span class="line">  PID      Vss      Rss      Pss      Uss  cmdline</span><br><span class="line"> 1078   59840K   59708K   42125K   39344K  com.csr.BTApp</span><br><span class="line"> 2683   59124K   59040K   37960K   33032K  com.android.launcher</span><br><span class="line"> 1042   51572K   51488K   35686K   33604K  android.process.acore</span><br><span class="line">  782   32808K   32748K   16775K   14716K  system_server</span><br><span class="line">  667   20560K   17560K   12739K    8940K  /system/bin/surfaceflinger</span><br><span class="line">  851   30124K   30036K   12085K    7996K  com.android.systemui</span><br><span class="line"> 2999   27680K   27596K    9929K    7040K  com.baidu.input</span><br><span class="line">  959   20764K   20676K    5522K    3788K  com.android.phone</span><br><span class="line"> 3468   21892K   21800K    4591K    1920K  com.apical.dreamthemetime</span><br><span class="line">  982   19880K   19792K    4438K    2644K  com.csr.csrservices</span><br><span class="line">  668   19592K   19480K    3525K    1360K  zygote</span><br><span class="line">  670    2960K    2960K    2407K    2356K  /system/bin/mediaserver</span><br><span class="line">  663    1784K    1784K    1209K    1116K  /system/bin/synergy_service</span><br><span class="line">  756    3404K    1348K    1133K    1124K  /usr/bin/gpsexe</span><br><span class="line">  669    1468K    1468K     959K     928K  /system/bin/drmserver</span><br><span class="line">  675     692K     692K     692K     692K  /bin/sh</span><br><span class="line"> 3482     656K     652K     456K     444K  procrank</span><br><span class="line">    1     164K     164K     144K     144K  /init</span><br><span class="line">                          ------   ------  ------</span><br><span class="line">                         195031K  163724K  TOTAL</span><br><span class="line"></span><br><span class="line">RAM: 480380K total, 3624K free, 732K buffers, 299788K cached, 264844K shmem, 7632K slab</span><br></pre></td></tr></table></figure>

<h4 id="dumpsys"><a href="#dumpsys" class="headerlink" title="dumpsys"></a>dumpsys</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dumpsys [options]</span><br><span class="line">        meminfo 显示内存信息</span><br><span class="line">        cpuinfo 显示CPU信息</span><br><span class="line">        account 显示accounts信息</span><br><span class="line">        activity 显示所有的activities的信息</span><br><span class="line">        window 显示键盘，窗口和它们的关系</span><br><span class="line">        wifi 显示wifi信息</span><br></pre></td></tr></table></figure>

<p>可以在其后通过包名或者进程pid展示指定进程的信息。</p>
<h1 id="UNIX与Linux"><a href="#UNIX与Linux" class="headerlink" title="UNIX与Linux"></a>UNIX与Linux</h1><p>Linux 是一个类似 Unix 的操作系统（类UNIX系统），Unix 要早于 Linux，Linux 的初衷就是要替代 UNIX，并在功能和用户体验上进行优化，所以 Linux 模仿了 UNIX（但并没有抄袭 UNIX 的源码），使得 Linux 在外观和交互上与 UNIX 非常类似。</p>
<p>二者的区别：</p>
<ul>
<li>UNIX 系统大多是与硬件配套的，也就是说，大多数 UNIX 系统如 AIX、HP-UX 等是无法安装在 x86 服务器和个人计算机上的，而 Linux 则可以运行在多种硬件平台上；</li>
<li>UNIX 是商业软件，而 Linux 是开源软件，是免费、公开源代码的。</li>
</ul>
<p>UNIX/Linux系统结构：可以粗糙地抽象为 3 个层次：底层是 UNIX/Linux 操作系统，即系统内核（Kernel）；中间层是 Shell 层，即命令解释层；高层则是应用层。</p>
<ol>
<li>内核层：内核层是 UNIX/Linux 系统的核心和基础，它直接附着在硬件平台之上，控制和管理系统内各种资源（硬件资源和软件资源），有效地组织进程的运行，从而扩展硬件的功能，提高资源的利用效率，为用户提供方便、高效、安全、可靠的应用环境。Linux 内核由如下几部分组成：内存管理、进程管理、设备驱动程序、文件系统和网络管理等。</li>
<li>Shell层：Shell 层是与用户直接交互的界面。用户可以在提示符下输入命令行，由 Shell 解释执行并输出相应结果或者有关信息，所以我们也把 Shell 称作命令解释器，利用系统提供的丰富命令可以快捷而简便地完成许多工作。目前主要有下列版本的shell：<ul>
<li>Bourne Shell(sh)：贝尔实验室开发的 　</li>
<li>Bourne Again Shell(bash)：GNU操作系统上默认的shell，大部分linux的发行套件使用的都是这种shell</li>
<li>Korn Shell：是对Bourne SHell的发展，在大部分内容上与Bourne Shell兼容</li>
<li>C Shell：是SUN公司Shell的BSD版本</li>
</ul>
</li>
<li>应用层：应用层提供基于 X Window 协议的图形环境。X Window 协议定义了一个系统所必须具备的功能，可系统能满足此协议及符合 X 协会其他的规范，便可称为 X Window。</li>
</ol>
<h1 id="Linux内核与发行版"><a href="#Linux内核与发行版" class="headerlink" title="Linux内核与发行版"></a>Linux内核与发行版</h1><p>Linux内核是计算机操作系统的核心。一个完整的 Linux发行版包括了内核与一些其他与文件相关的操作，用户管理系统，和软件包管理器等一系列软件。每个工具都是整个系统的一小部分。这些工具通常都是一个个独立的项目，有相应的开发者来开发及维护。</p>
<p>Linux的众多发行版可能是基于不同的内核版本的。例如：流行的 RHEL6发行版是基于很老但是很稳定的 2.6.32 版本的Linux内核的。其他的一些发行版可能会很快的更新以适应最新的内核版本。需要特别注意的一点是，内核并不是一个非此即彼的命题，例如RHEL6就在2.6.32的内核中引进了新版本内核的许多改进。</p>
<p>各发行版提供的其他基本工具和组成部分还有包括以下的内容：C/C++编译器，gdbdebugger 调试工具，核心系统库应用程序，用于在屏幕上绘图的底层接口以及高级的桌面环境，以及供安装和更新包括内核在内的众多组建的系统</p>
<p>Debian是包括Ubuntu在内许多发行版的上游，而Ubuntu又是Linux Mint及其他发行版的上游。Debian在服务器和桌面电脑领域都有着广泛的应用。Debian是一个纯开源计划并着重在一个关键点上，稳定性。它同时也提供了最大的和完整的软件仓库给用户。</p>
<h1 id="Android与Linux"><a href="#Android与Linux" class="headerlink" title="Android与Linux"></a>Android与Linux</h1><ul>
<li>Android采用Linux作为内核</li>
<li>Android对Linux内核做了修改，目的是适应在移动设备上使用</li>
<li>Android开始作为Linux的一个分支，后来由于无法并入Linux的主开发树，已被Linux Kernel小组从开发树中删除</li>
</ul>
<p>Android是在Linux内核基础上运行的，提供的核心系统服务包括安全、内存管理、进程管理、网络组和驱动模型等内容。在硬件层和系统中其他软件之间添加了硬件抽象层（HAL），严格上来说Android不算是Linux系统</p>
<p>Android内核是有标准的Linux内核修改而来的，继承了Linux内核的诸多优点，保留了Linux内核的主题框架，同时Android按照移动设备的要求，在文件系统、内存管理、进程间通信机智和电源管理方面进行了修改，添加了相关的驱动程序和必要的新功能。Android在很大程度上保留了Linux的基本架构。</p>
<h1 id="GNU"><a href="#GNU" class="headerlink" title="GNU"></a>GNU</h1><p>GPL：GNU通用公共许可协议（英语：GNU General Public License，缩写GNU GPL 或 GPL），是被广泛使用的自由软件许可证，给予了终端用户运行、学习、共享和修改软件的自由。</p>
<p>GNU是一个自由的操作系统，其内容软件完全以GPL方式发布。这个操作系统是GNU计划的主要目标，名称来自GNU’s Not Unix!的递归缩写，因为GNU的设计类似Unix，但它不包含具著作权的Unix代码。GNU的创始人，理查德·马修·斯托曼，将GNU视为“达成社会目的技术方法”。</p>
<p>作为操作系统，GNU的发展仍未完成，其中最大的问题是具有完备功能的内核尚未被开发成功。GNU的内核，称为Hurd，是自由软件基金会发展的重点，但是其发展尚未成熟。在实际使用上，多半使用Linux内核、FreeBSD等替代方案，作为系统核心，其中主要的操作系统是Linux的发行版。Linux操作系统包涵了Linux内核与其他自由软件项目中的GNU组件和软件，可以被称为GNU/Linux。</p>
<p>GNU/Linux命名争议，是在自由及开放源代码软件社群成员内的，关于是应该把使用GNU软件与Linux内核组合之操作系统称为“GNU/Linux”还是“Linux”的争议。</p>
<p>GNU/Linux这一名称是由自由软件基金会的创立者与GNU计划的发起人理查德·斯托曼所提出的。GNU的开发者与其支持者，希望以该名称来作为此操作系统的正式名称。他们认为，此操作系统，包括了GNU系统软件包与Linux kernel，使用GNU/Linux这个名称，可以良好概括它的主要内容。况且，GNU项目原本就是以发展一个自由的操作系统为远程项目，但迟迟没有完成。而Linux kernel的出现刚好可以补足这个缺口。</p>
<p>Linux内核本身并不是GNU计划的一部分，GNU/Linux这个名称在Linux社群中并没有得到一致认同。一些发行版社群例如Debian采用了GNU/Linux这一名称，但许多Linux社群中的成员认为使用Linux这一名称是更好的，为此提出了数项理由，主张Linux这个名称朗朗上口，且在公众与媒体中更为通用。Linux内核项目的发起人林纳斯·托瓦兹（Linus Torvalds）偏好于使用Linux，但对于GNU/Linux这个名字并不强烈反感。</p>
<h1 id="一切皆文件"><a href="#一切皆文件" class="headerlink" title="一切皆文件"></a>一切皆文件</h1><h2 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h2><p>linux/unix下的哲学核心思想是<strong>一切皆文件</strong>。它指的是，对所有文件（目录、字符设备、块设备、套接字、打印机、进程、线程、管道等）操作，读写都可用<code>fopen()/fclose()/fwrite()/fread()</code>等函数进行处理，屏蔽了硬件的区别，所有设备都抽象成文件，提供统一的接口给用户，虽然类型各不相同，但是对其提供的却是同一套操作界面，更进一步，对文件的操作也可以跨文件系统执行。</p>
<p>操作一个已经打开的文件：使用文件描述符（file descriptor），简称fd，它是一个对应某个已经打开的文件的索引（非负整数）。</p>
<p>Windows的内部实现也近似于“一切皆文件”的思想，当然，这一切都只在内核里才有，下载一个WinObj这软件就可以看到，Windows上各种设备、分区、虚拟对象都是挂载到根“\”下的，通过这个树可以访问各种设备、驱动、文件系统等。</p>
<p>Windows与Linux不同的就是把这些对象又重新封装了一层WindowsAPI，对外以设备、盘符、文件等等表现出来，重新封装WindowsAPI的目的是为了兼容性，而设备、盘符、文件这些是为了让普通用户更好理解。</p>
<h2 id="文件类型"><a href="#文件类型" class="headerlink" title="文件类型"></a>文件类型</h2><p><img src="Linux%E6%96%87%E4%BB%B6%E7%B1%BB%E5%9E%8B.png" alt="Linux文件类型"></p>
<h1 id="Inode"><a href="#Inode" class="headerlink" title="Inode"></a>Inode</h1><h2 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h2><p>inode是一个重要概念，是理解Unix/Linux文件系统和硬盘储存的基础。</p>
<p>文件储存在硬盘上，硬盘的最小存储单位叫做”扇区”（Sector）。每个扇区储存512字节（相当于0.5KB）。操作系统读取硬盘的时候，不会一个个扇区地读取，这样效率太低，而是一次性连续读取多个扇区，即一次性读取一个”块”（block）。这种由多个扇区组成的”块”，是文件存取的最小单位。”块”的大小，最常见的是4KB，即连续八个 sector组成一个 block。</p>
<p>文件数据都储存在”块”中，那么很显然，我们还必须找到一个地方储存文件的元信息，比如文件的创建者、文件的创建日期、文件的大小等等。这种储存文件元信息的区域就叫做inode，中文译名为”索引节点”。每一个文件都有对应的inode，里面包含了与该文件有关的一些信息。</p>
<h2 id="inode的内容"><a href="#inode的内容" class="headerlink" title="inode的内容"></a>inode的内容</h2><p>inode包含文件的元信息，具体来说有以下内容：</p>
<ul>
<li>文件的字节数</li>
<li>文件拥有者的User ID</li>
<li>文件的Group ID</li>
<li>文件的读、写、执行权限</li>
<li>文件的时间戳，共有三个：ctime指inode上一次变动的时间，mtime指文件内容上一次变动的时间，atime指文件上一次打开的时间。</li>
<li>链接数，即有多少文件名指向这个inode</li>
<li>文件数据block的位置</li>
</ul>
<p>可以用stat命令，查看某个文件的inode信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">stat</span> README.md</span></span><br><span class="line">  File: README.md</span><br><span class="line">  Size: 15              Blocks: 0          IO Block: 4096   regular file</span><br><span class="line">Device: fh/15d  Inode: 30680772461790950  Links: 1</span><br><span class="line">Access: (0777/-rwxrwxrwx)  Uid: ( 1000/ hearing)   Gid: ( 1000/ hearing)</span><br><span class="line">Access: 2019-08-16 20:56:58.121431000 +0800</span><br><span class="line">Modify: 2019-08-16 20:56:58.121431000 +0800</span><br><span class="line">Change: 2019-08-16 20:56:58.121431000 +0800</span><br><span class="line"> Birth: -</span><br></pre></td></tr></table></figure>

<p>总之，除了文件名以外的所有文件信息，都存在inode之中。至于为什么没有文件名，下文会有详细解释。</p>
<h2 id="inode的大小"><a href="#inode的大小" class="headerlink" title="inode的大小"></a>inode的大小</h2><p>inode也会消耗硬盘空间，所以硬盘格式化的时候，操作系统自动将硬盘分成两个区域。一个是数据区，存放文件数据；另一个是inode区（inode table），存放inode所包含的信息。</p>
<p>每个inode节点的大小，一般是128字节或256字节。inode节点的总数，在格式化时就给定，一般是每1KB或每2KB就设置一个inode。假定在一块1GB的硬盘中，每个inode节点的大小为128字节，每1KB就设置一个inode，那么inode table的大小就会达到128MB，占整块硬盘的12.8%。</p>
<p>查看每个硬盘分区的inode总数和已经使用的数量，可以使用<code>df -i</code>命令。</p>
<p>查看每个inode节点的大小，可以用如下命令：<code>sudo dumpe2fs -h /dev/hda | grep &quot;Inode size&quot;</code></p>
<p>由于每个文件都必须有一个inode，因此有可能发生inode已经用光，但是硬盘还未存满的情况。这时，就无法在硬盘上创建新文件。</p>
<h2 id="inode号码"><a href="#inode号码" class="headerlink" title="inode号码"></a>inode号码</h2><p>每个inode都有一个号码，操作系统用inode号码来识别不同的文件。Unix/Linux系统内部不使用文件名，而使用inode号码来识别文件。对于系统来说，文件名只是inode号码便于识别的别称或者绰号。</p>
<p>表面上，用户通过文件名，打开文件。实际上，系统内部这个过程分成三步：首先，系统找到这个文件名对应的inode号码；其次，通过inode号码，获取inode信息；最后，根据inode信息，找到文件数据所在的block，读出数据。</p>
<p>使用ls -i命令，可以看到文件名对应的inode号码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ls -i README.md</span></span><br><span class="line">30680772461790950 README.md</span><br></pre></td></tr></table></figure>

<h2 id="目录文件"><a href="#目录文件" class="headerlink" title="目录文件"></a>目录文件</h2><p>Unix/Linux系统中，目录（directory）也是一种文件。打开目录，实际上就是打开目录文件。</p>
<p>目录文件的结构非常简单，就是一系列目录项（dirent）的列表。每个目录项，由两部分组成：所包含文件的文件名，以及该文件名对应的inode号码。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ls命令只列出目录文件中的所有文件名：</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls</span></span><br><span class="line">HybridAccessory  README.md  _config.yml  db.json  gulpfile.js  node_modules  package-lock.json  package.json  scaffolds  source  themes</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ls -i命令列出整个目录文件，即文件名和inode号码：</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls -i</span></span><br><span class="line">  281474976845551 HybridAccessory   5348024557503872 db.json         281474976858064 package-lock.json    281474976858853 source</span><br><span class="line">30680772461790950 README.md          281474976845560 gulpfile.js     281474976858065 package.json         281474976859117 themes</span><br><span class="line"> 1125899906905575 _config.yml        281474976845561 node_modules    281474976858849 scaffolds</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ls -l命令列出文件的详细信息：</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls -l</span></span><br><span class="line">total 280</span><br><span class="line">drwxrwxrwx 1 hearing hearing   4096 Jul 22 14:06 HybridAccessory</span><br><span class="line">-rwxrwxrwx 1 hearing hearing     15 Aug 16 20:56 README.md</span><br><span class="line">-rwxrwxrwx 1 hearing hearing   2189 Aug 19 12:34 _config.yml</span><br><span class="line">-rwxrwxrwx 1 hearing hearing    174 Aug 27 17:55 db.json</span><br><span class="line">-rwxrwxrwx 1 hearing hearing   1596 Jul 22 14:06 gulpfile.js</span><br><span class="line">drwxrwxrwx 1 hearing hearing   4096 Jul 22 14:06 node_modules</span><br><span class="line">-rwxrwxrwx 1 hearing hearing 277830 Jul 22 14:06 package-lock.json</span><br><span class="line">-rwxrwxrwx 1 hearing hearing    686 Jul 22 14:06 package.json</span><br><span class="line">drwxrwxrwx 1 hearing hearing   4096 Jul 22 14:06 scaffolds</span><br><span class="line">drwxrwxrwx 1 hearing hearing   4096 Jul 29 11:35 source</span><br><span class="line">drwxrwxrwx 1 hearing hearing   4096 Aug 16 20:51 themes</span><br></pre></td></tr></table></figure>

<p>目录文件的读权限（r）和写权限（w），都是针对目录文件本身。由于目录文件内只有文件名和inode号码，所以如果只有读权限，只能获取文件名，无法获取其他信息，因为其他信息都储存在inode节点中，而读取inode节点内的信息需要目录文件的执行权限（x）。</p>
<p>查看目录大小：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> du -h --max-depth=1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> du -h -d 1</span></span><br></pre></td></tr></table></figure>

<h2 id="硬链接"><a href="#硬链接" class="headerlink" title="硬链接"></a>硬链接</h2><p>一般情况下，文件名和inode号码是”一一对应”关系，每个inode号码对应一个文件名。但是，Unix/Linux系统允许，多个文件名指向同一个inode号码。</p>
<p>这意味着，可以用不同的文件名访问同样的内容；对文件内容进行修改，会影响到所有文件名；但是，删除一个文件名，不影响另一个文件名的访问。这种情况就被称为”硬链接”（hard link）。</p>
<p>ln命令可以创建硬链接：<code>ln 源文件 目标文件</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ls -li</span></span><br><span class="line">total 0</span><br><span class="line">16044073672577795 drwxrwxrwx 1 hearing hearing 4096 Aug 27 18:07 test</span><br><span class="line">14918173765727074 -rw-rw-rw- 1 hearing hearing    0 Aug 27 18:06 test.txt</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ln test.txt test1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls -li</span></span><br><span class="line">total 0</span><br><span class="line">16044073672577795 drwxrwxrwx 1 hearing hearing 4096 Aug 27 18:07 test</span><br><span class="line">14918173765727074 -rw-rw-rw- 2 hearing hearing    0 Aug 27 18:06 test.txt</span><br><span class="line">14918173765727074 -rw-rw-rw- 2 hearing hearing    0 Aug 27 18:06 test1</span><br></pre></td></tr></table></figure>

<p>运行上面这条命令以后，源文件与目标文件的inode号码相同，都指向同一个inode。inode信息中有一项叫做”链接数”，记录指向该inode的文件名总数，这时就会增加1。反过来，删除一个文件名，就会使得inode节点中的”链接数”减1。当这个值减到0，表明没有文件名指向这个inode，系统就会回收这个inode号码，以及其所对应block区域。</p>
<p>创建目录时，默认会生成两个目录项：”.”和”..”。前者的inode号码就是当前目录的inode号码，等同于当前目录的”硬链接”；后者的inode号码就是当前目录的父目录的inode号码，等同于父目录的”硬链接”。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ls -ai</span></span><br><span class="line"> 9570149208327005 .   1970324837227736 ..  16044073672577795 test   4785074604151560 test2</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls -i ../</span></span><br><span class="line"> 9570149208327005 Downloads</span><br></pre></td></tr></table></figure>

<p>目录不能创建硬链接（hard link not allowed for directory）。</p>
<h2 id="软链接-快捷方式"><a href="#软链接-快捷方式" class="headerlink" title="软链接(快捷方式)"></a>软链接(快捷方式)</h2><p>文件A和文件B的inode号码虽然不一样，但是文件A的内容是文件B的路径。读取文件A时，系统会自动将访问者导向文件B。因此，无论打开哪一个文件，最终读取的都是文件B。这时，文件A就称为文件B的”软链接”（soft link）或者”符号链接（symbolic link）。</p>
<p>这意味着，文件A依赖于文件B而存在，如果删除了文件B，打开文件A就会报错：”No such file or directory”。这是软链接与硬链接最大的不同：文件A指向文件B的文件名，而不是文件B的inode号码，文件B的inode”链接数”不会因此发生变化。</p>
<p>ln -s命令可以创建软链接：<code>ln -s 源文文件或目录 目标文件或目录</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ln -s test2 test1</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ls -l</span></span><br><span class="line">total 0</span><br><span class="line">drwxrwxrwx 1 hearing hearing 4096 Aug 27 18:07 test</span><br><span class="line">lrwxrwxrwx 1 hearing hearing    5 Aug 27 18:17 test1 -&gt; test2</span><br><span class="line">-rw-rw-rw- 1 hearing hearing    5 Aug 27 18:09 test2</span><br></pre></td></tr></table></figure>

<h2 id="inode的特殊作用"><a href="#inode的特殊作用" class="headerlink" title="inode的特殊作用"></a>inode的特殊作用</h2><p>由于inode号码与文件名分离，这种机制导致了一些Unix/Linux系统特有的现象。</p>
<ol>
<li>有时，文件名包含特殊字符，无法正常删除。这时，直接删除inode节点，就能起到删除文件的作用。</li>
<li>移动文件或重命名文件，只是改变文件名，不影响inode号码。</li>
<li>打开一个文件以后，系统就以inode号码来识别这个文件，不再考虑文件名。因此，通常来说，系统无法从inode号码得知文件名。</li>
</ol>
<p>第3点使得软件更新变得简单，可以在不关闭软件的情况下进行更新，不需要重启。因为系统通过inode号码，识别运行中的文件，不通过文件名。更新的时候，新版文件以同样的文件名，生成一个新的inode，不会影响到运行中的文件。等到下一次运行这个软件的时候，文件名就自动指向新版文件，旧版文件的inode则被回收。</p>
<h1 id="文件描述符"><a href="#文件描述符" class="headerlink" title="文件描述符"></a>文件描述符</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>文件描述符在形式上是一个非负整数。实际上，它是一个索引值，指向内核为每一个进程所维护的该进程打开文件的记录表。当程序打开一个现有文件或者创建一个新文件时，内核向进程返回一个文件描述符。在程序设计中，一些涉及底层的程序编写往往会围绕着文件描述符展开。</p>
<p>Linux 系统中，把一切都看做是文件，当进程打开现有文件或创建新文件时，内核向进程返回一个文件描述符，文件描述符就是内核为了高效管理已被打开的文件所创建的索引，用来指向被打开的文件，所有执行I/O操作的系统调用都会通过文件描述符。</p>
<h2 id="文件描述符、文件、进程间的关系"><a href="#文件描述符、文件、进程间的关系" class="headerlink" title="文件描述符、文件、进程间的关系"></a>文件描述符、文件、进程间的关系</h2><p>1.描述：</p>
<ul>
<li>每个文件描述符会与一个打开的文件相对应</li>
<li>不同的文件描述符也可能指向同一个文件</li>
<li>相同的文件可以被不同的进程打开，也可以在同一个进程被多次打开</li>
</ul>
<p>2.系统为维护文件描述符，建立了三个表</p>
<ul>
<li>进程级的文件描述符表</li>
<li>系统级的文件描述符表</li>
<li>文件系统的i-node表 </li>
</ul>
<img src="文件描述符.png"/>

<img src="三个表的关系.png"/>

<ul>
<li>在进程A中，文件描述符1和30都指向了同一个打开的文件句柄（#23），这可能是该进程多次对执行打开操作</li>
<li>进程A中的文件描述符2和进程B的文件描述符2都指向了同一个打开的文件句柄（#73），这种情况有几种可能，1.进程A和进程B可能是父子进程关系;2.进程A和进程B打开了同一个文件，且文件描述符相同（低概率事件=_=）；3.A、B中某个进程通过UNIX域套接字将一个打开的文件描述符传递给另一个进程。</li>
<li>进程A的描述符0和进程B的描述符3分别指向不同的打开文件句柄，但这些句柄均指向i-node表的相同条目（#1936），换言之，指向同一个文件。发生这种情况是因为每个进程各自对同一个文件发起了打开请求。同一个进程两次打开同一个文件，也会发生类似情况。</li>
</ul>
<h2 id="文件描述符限制"><a href="#文件描述符限制" class="headerlink" title="文件描述符限制"></a>文件描述符限制</h2><p>“文件描述符”也是一种资源，系统中的每个进程都需要有“文件描述符”才能进行一些操作。</p>
<img src="文件描述符限制.png"/>

<p>永久修改用户级限制时有三种设置类型：</p>
<ul>
<li>soft 指的是当前系统生效的设置值</li>
<li>hard 指的是系统中所能设定的最大值</li>
<li><code>-</code> 指的是同时设置了 soft 和 hard 的值</li>
</ul>
<h2 id="检查某个进程的文件描述符相关内容"><a href="#检查某个进程的文件描述符相关内容" class="headerlink" title="检查某个进程的文件描述符相关内容"></a>检查某个进程的文件描述符相关内容</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看指定进程的限制：在 Max open files 那一行，可以看到当前设置中最大文件描述符的数量为1024</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cat /proc/803/limits</span></span><br><span class="line">Limit                     Soft Limit           Hard Limit           Units</span><br><span class="line">Max cpu time              unlimited            unlimited            seconds</span><br><span class="line">Max file size             unlimited            unlimited            bytes</span><br><span class="line">Max data size             unlimited            unlimited            bytes</span><br><span class="line">Max stack size            8388608              unlimited            bytes</span><br><span class="line">Max core file size        0                    unlimited            bytes</span><br><span class="line">Max resident set          unlimited            unlimited            bytes</span><br><span class="line">Max processes             8041                 8041                 processes</span><br><span class="line">Max open files            1024                 4096                 files</span><br><span class="line">Max locked memory         65536                65536                bytes</span><br><span class="line">Max address space         unlimited            unlimited            bytes</span><br><span class="line">Max file locks            unlimited            unlimited            locks</span><br><span class="line">Max pending signals       8041                 8041                 signals</span><br><span class="line">Max msgqueue size         819200               819200               bytes</span><br><span class="line">Max nice priority         40                   40</span><br><span class="line">Max realtime priority     0                    0</span><br><span class="line">Max realtime timeout      unlimited            unlimited            us</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看该进程占用了多少个文件描述符</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ll /proc/803/fd | wc -l</span></span><br><span class="line">5</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> ll /proc/803/fd</span></span><br><span class="line">total 0</span><br><span class="line">lrwx------ 1 hearing hearing 0 Aug 27 20:14 0 -&gt; /dev/tty3</span><br><span class="line">lrwx------ 1 hearing hearing 0 Aug 27 20:14 1 -&gt; /dev/tty3</span><br><span class="line">lrwx------ 1 hearing hearing 0 Aug 27 20:14 10 -&gt; /dev/tty3</span><br><span class="line">lrwx------ 1 hearing hearing 0 Aug 27 20:14 2 -&gt; /dev/tty3</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>实际应用过程中，如果出现“Too many open files” , 可以通过增大进程可用的文件描述符数量来解决，但往往故事不会这样结束，很多时候，并不是因为进程可用的文件描述符过少，而是因为程序bug，打开了大量的文件连接（web连接也会占用文件描述符）而没有释放。程序申请的资源在用完后及时释放，才是解决“Too many open files”的根本之道。</p>
<h1 id="证书-amp-CA"><a href="#证书-amp-CA" class="headerlink" title="证书&amp;CA"></a>证书&amp;CA</h1><ul>
<li>证书（“digital certificate”或“public key certificate”）：它是用来证明某某东西确实是某某东西的东西</li>
<li>CA（Certificate Authority）：证书授权中心，负责管理和签发证书的第三方机构</li>
<li>CA 证书：就是CA颁发的证书</li>
</ul>
<h1 id="apt-amp-dpkg"><a href="#apt-amp-dpkg" class="headerlink" title="apt&amp;dpkg"></a>apt&amp;dpkg</h1><h2 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h2><p>在Linux平台下使用源代码进行软件编译可以具有定制化的设置，但对于Linux distribution的发行商来说，毕竟不是每个人都会进行源代码编译的，这个问题将会严重的影响linux平台上软件的发行与推广。</p>
<p>为了解决上述的问题，厂商先在他们的系统上面编译好了用户所需要的软件，然后将这个编译好并可执行的软件直接发布给用户安装。不同的 Linux 发行版使用不同的打包系统，一般而言，大多数发行版分别属于两大包管理技术阵营：Debian 的”.deb”，和 Red Hat的”.rpm”。</p>
<h2 id="dpkg"><a href="#dpkg" class="headerlink" title="dpkg"></a>dpkg</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>dpkg - package manager for Debian。dpkg是Debian的一个底层包管理工具，主要用于对已下载到本地和已安装的软件包进行管理。</p>
<p>通过dpkg的机制，Debian提供的软件就能够简单的安装起来，同时能提供安装后的软件信息，只要派生于Debian的其它Linux distributions大多使用dpkg这个机制来管理，包括B2D，Ubuntu，Deepin等。</p>
<h3 id="deb软件包名规则"><a href="#deb软件包名规则" class="headerlink" title="deb软件包名规则"></a>deb软件包名规则</h3><p>格式为：<code>Package_Version-Build_Architecture.deb</code>，如：nano_1.3.10-2_i386.deb：</p>
<ul>
<li>软件包名称(Package Name): nano</li>
<li>版本(Version Number):1.3.10</li>
<li>修订号(Build Number):2</li>
<li>平台(Architecture):i386</li>
</ul>
<h3 id="dpkg软件包相关文件"><a href="#dpkg软件包相关文件" class="headerlink" title="dpkg软件包相关文件"></a>dpkg软件包相关文件</h3><ul>
<li>/etc/dpkg/dpkg.cfg：dpkg包管理软件的配置文件【Configuration file with default options】</li>
<li>/var/log/dpkg.log：dpkg包管理软件的日志文件【Default log file (see /etc/dpkg/dpkg.cfg(5) and option –log)】</li>
<li>/var/lib/dpkg/available：存放系统所有安装过的软件包信息【List of available packages.】</li>
<li>/var/lib/dpkg/status：存放系统现在所有安装软件的状态信息</li>
<li>/var/lib/dpkg/info：记安装软件包控制目录的控制信息文件</li>
</ul>
<h3 id="dpkg数据库"><a href="#dpkg数据库" class="headerlink" title="dpkg数据库"></a>dpkg数据库</h3><p>dpkg 使用文本文件作为数据库来维护系统中软件，包括文件清单, 依赖关系, 软件状态, 等等详细的内容，通常在 /var/lib/dpkg 目录下。通常在 status 文件中存储软件状态和控制信息。在 info/ 目录下备份控制文件，并在其下的 .list 文件中记录安装文件清单，其下的 .mdasums 保存文件的 MD5 编码。</p>
<h3 id="使用手册"><a href="#使用手册" class="headerlink" title="使用手册"></a>使用手册</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装软件包，必须是deb包的完整名称。（软件的安装可被拆分为两个对立的过程“解包”和“配置”）</span></span><br><span class="line">dpkg -i package-name.deb</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> “解包”：解开软件包到系统目录但不配置,如果和-R一起使用，参数可以是一个目录</span></span><br><span class="line">dpkg --unpack package-name.deb</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> “配置”：配置软件包</span></span><br><span class="line">dpkg --configure package-name.deb</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 列出 deb 包的内容</span></span><br><span class="line">dpkg -c package-name.deb</span><br></pre></td></tr></table></figure>

<p>安装相关选项：</p>
<ul>
<li>-R：递归地指向特定目录的所有安装包，可以结合-i, -A, –install, –unpack 与 –avail一起使用</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> --remove，移除软件包，但保留其配置文件</span></span><br><span class="line">dpkg -r package-name</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> --purge，清除软件包的所有文件（removes everything，including conffiles）</span></span><br><span class="line">dpkg -P package-name</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> --list, 查看系统中软件包名符合pattern模式的软件包</span></span><br><span class="line">dpkg -l package-name-pattern</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> --listfiles, 查看package-name对应的软件包安装的文件及目录</span></span><br><span class="line">dpkg -L package-name</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> --print-avail, 显示包的具体信息</span></span><br><span class="line">dpkg -p package-name</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> --status, 查看package-name（已安装）对应的软件包信息</span></span><br><span class="line">dpkg -s package-name</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> --search，从已经安装的软件包中查找包含filename的软件包名称 （Tip：也可使用子命令dpkg-query来进行查询操作）</span></span><br><span class="line">dpkg -S filename-search-pattern</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 解包</span></span><br><span class="line">dpkg -X pkg.deb</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 例：列出系统上安装的与dpkg相关的软件包</span></span><br><span class="line">dpkg -l \*dpkg*</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 例：查看dpkg软件包安装到系统中的文件</span></span><br><span class="line">dpkg -L dpkg</span><br></pre></td></tr></table></figure>

<h2 id="apt"><a href="#apt" class="headerlink" title="apt"></a>apt</h2><h3 id="apt简介"><a href="#apt简介" class="headerlink" title="apt简介"></a>apt简介</h3><p>虽然我们在使用dpkg时，已经解决掉了软件安装过程中的大量问题，但是当依赖关系不满足时，仍然需要手动解决，而apt这个工具解决了这样的问题，linux distribution 先将软件放置到对应的服务器中，然后分析软件的依赖关系，并且记录下来，然后当客户端有安装软件需求时，通过清单列表与本地的dpkg以存在的软件数据相比较，就能从网络端获取所有需要的具有依赖属性的软件了。</p>
<h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><p>Debian 采用集中式的软件仓库机制，将各式各样的软件包分门别类地存放在软件仓库中，进行有效地组织和管理。然后，将软件仓库置于许许多多的镜像服务器中，并保持基本一致。这样，所有的 Debian 用户随时都能获得最新版本的安装软件包。因此，对于用户，这些镜像服务器就是他们的软件源（Reposity）</p>
<p>然而，由于每位用户所处的网络环境不同，不可能随意地访问各镜像站点。为了能够有选择地访问，在 Debian 系统中，使用软件源配置文件/etc/apt/sources.list列出最合适访问的镜像站点地址。</p>
<p><code>apt udpate</code>过程：</p>
<ol>
<li>执行apt-get update</li>
<li>程序分析/etc/apt/sources.list</li>
<li>自动连网寻找list中对应的Packages/Sources/Release列表文件，如果有更新则下载之，存入/var/lib/apt/lists/目录</li>
<li>然后 apt-get install 相应的包，下载并安装。</li>
</ol>
<p>用户可以使用“apt-get update”命令刷新软件源，建立更新软件包列表。它会扫描每一个软件源服务器，并为该服务器所具有软件包资源建立索引文件，存放在本地的/var/lib/apt/lists/目录中。使用apt执行安装、更新操作时，都将依据这些索引文件，向软件源服务器申请资源。</p>
<h3 id="apt相关文件"><a href="#apt相关文件" class="headerlink" title="apt相关文件"></a>apt相关文件</h3><ul>
<li>var/lib/dpkg/available 文件的内容是软件包的描述信息, 该软件包括当前系统所使用的Debian 安装源中的所有软件包，其中包括当前系统中已安装的和未安装的软件包.</li>
<li>/etc/apt/sources.list 记录软件源的地址（当你执行 sudo apt-get install xxx 时，Ubuntu 就去这些站点下载软件包到本地并执行安装）</li>
<li>/var/cache/apt/archives 已经下载到的软件包都放在这里（用 apt-get install 安装软件时，软件包的临时存放路径）</li>
<li>/var/lib/apt/lists 使用apt-get update命令会从/etc/apt/sources.list中下载软件列表，并保存到该目录</li>
</ul>
<h3 id="创建apt软件源"><a href="#创建apt软件源" class="headerlink" title="创建apt软件源"></a>创建apt软件源</h3><h4 id="概述-3"><a href="#概述-3" class="headerlink" title="概述"></a>概述</h4><p>以下是我搭建的软件源目录结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">hearing&#x2F;</span><br><span class="line">├── bootstraps</span><br><span class="line">│   ├── bootstrap-aarch64</span><br><span class="line">│   ├── bootstrap-aarch64.zip</span><br><span class="line">│   ├── bootstrap-arm.zip</span><br><span class="line">│   ├── bootstrap-i686.zip</span><br><span class="line">│   └── bootstrap-x86_64.zip</span><br><span class="line">├── repository</span><br><span class="line">│   ├── dists</span><br><span class="line">│   |    └── stable</span><br><span class="line">│   |       ├── InRelease</span><br><span class="line">│   |       ├── main</span><br><span class="line">│   |       │   ├── binary-aarch64</span><br><span class="line">│   |       │   │   └── Packages</span><br><span class="line">│   |       │   ├── binary-all</span><br><span class="line">│   |       │   │   └── Packages</span><br><span class="line">│   |       │   ├── binary-arm</span><br><span class="line">│   |       │   │   └── Packages</span><br><span class="line">│   |       │   ├── binary-i686</span><br><span class="line">│   |       │   │   └── Packages</span><br><span class="line">│   |       │   └── binary-x86_64</span><br><span class="line">│   |       │       └── Packages</span><br><span class="line">│   |       ├── Release</span><br><span class="line">|   |       ├── Release.gpg</span><br><span class="line">|   |       └── repo.asc</span><br><span class="line">│   └── pool</span><br><span class="line">│       ├── aarch64</span><br><span class="line">│       |   ├── xxx.deb</span><br><span class="line">│       ├── all</span><br><span class="line">│       |   ├── xxx.deb</span><br><span class="line">│       ├── arm</span><br><span class="line">│       |   ├── xxx.deb</span><br><span class="line">│       ├── i686</span><br><span class="line">│       |   ├── xxx.deb</span><br><span class="line">│       └── x86_64</span><br><span class="line">│           ├── xxx.deb</span><br><span class="line">└── tmp</span><br><span class="line">    ├── xxx.tar.gz</span><br></pre></td></tr></table></figure>

<ul>
<li>bootstraps目录下放的是最终编译成功的zip文件</li>
<li>repository是自己制作的软件仓库</li>
<li>tmp放置的是上一步编译中下载失败的一些依赖</li>
</ul>
<h4 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h4><p>根据<code>https://wiki.debian.org/DebianRepository/Setup</code>中的说法，仓库分为两种，一种比较简单的是trivial archive，而另外一种复杂的仓库称为official archive。在一个official archive中，典型特征是顶层有个 dists 目录和 pool 目录。这样的好处是:</p>
<ul>
<li>将所有类型CPU的包列表(Packages或者Packages.gz文件)放在一个文件里面，这样每个机器要获取的包列表就比较小。</li>
<li>不同套件/不同CPU可共用的deb包（主要是那些 _all.deb）和源代码包，也只在 pool/all目录下存放一份。</li>
<li>源代码包(.dsc，orig.tar.xz)有路径存放，这样 dget / apt source 可以取到源代码包。</li>
</ul>
<p>对应的<code>/etc/apt/sources.list</code>配置如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deb http://192.168.56.47:80/hearing/repository stable main</span><br></pre></td></tr></table></figure>

<p>配置软件源的格式为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deb|deb-src uri distribution [component1] [component2] [...]</span><br></pre></td></tr></table></figure>

<h4 id="生成Packages"><a href="#生成Packages" class="headerlink" title="生成Packages"></a>生成Packages</h4><p>Packages文件包括每个deb包的位置，描述，版本等信息，生成命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dpkg-scanpackages all/ /dev/null| gzip -9c &gt; dists/stable/main/binary-all/Packages.gz</span><br><span class="line">dpkg-scanpackages all/ /dev/null| &gt; dists/stable/main/binary-all/Packages</span><br></pre></td></tr></table></figure>

<h4 id="生成Release"><a href="#生成Release" class="headerlink" title="生成Release"></a>生成Release</h4><p>Release文件里面包含了 Packages 等文件的大小和校验和(包含MD5/SHA1/SHA256/SHA512 多种值)，如果这个文件里面所描述的 Packages 大小与校验和与实际读取到的文件不一致，apt 会拒绝这个仓库。生成命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-ftparchive release $dir &gt; Release</span><br></pre></td></tr></table></figure>

<h4 id="生成Release-gpg-和-InRelease-文件"><a href="#生成Release-gpg-和-InRelease-文件" class="headerlink" title="生成Release.gpg 和 InRelease 文件"></a>生成Release.gpg 和 InRelease 文件</h4><p>Release.gpg 是一个签名文件，随同 Release 一起出现的，比较老的客户端只认这两个文件，而 InRelease 是内嵌签名的（也就是说，将原来 Release 的内容和 Release.gpg 的内容揉到一起了，注意这里不是简单地拼到一起），新的客户端才支持这个这个文件，观察一下 Debian 和 Ubuntu 的仓库 ( <a target="_blank" rel="noopener" href="http://mirrors.ustc.edu.cn/debian/dists/jessie/">http://mirrors.ustc.edu.cn/debian/dists/jessie/</a>, <a target="_blank" rel="noopener" href="http://mirrors.ustc.edu.cn/ubuntu/dists/xenial/">http://mirrors.ustc.edu.cn/ubuntu/dists/xenial/</a> ) ，可以看到 Debian 的仓库只有 Release 和 Release.gpg 这两个文件，而 Ubuntu 仓库里面这三个文件都有。</p>
<p>如何生成这两个文件：</p>
<ul>
<li>生成自己的gpg key: <code>gpg --list-keys || gpg --gen-key</code></li>
<li>生成Release.gpg: <code>gpg --armor --detach-sign --sign -o Release.gpg Release</code></li>
<li>生成InRelease: <code>gpg --clearsign -o InRelease Release</code></li>
</ul>
<h4 id="导入公钥"><a href="#导入公钥" class="headerlink" title="导入公钥"></a>导入公钥</h4><p>当运行<code>apt update</code>的时候，会出现警告：<code>The following signatures couldn&#39;t be verified because the public key is not available: NO_PUBKEY 722D2AFAD8BAD548</code>。</p>
<p>也就是说 InRelease / Release.gpg 虽然签名了，但由于这个签名所用的公钥没有被接受，因此还是不能正常使用，有三种解决方法：</p>
<ol>
<li><p>服务端将公钥导出，然后提供给客户端导入：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 导出</span></span><br><span class="line">gpg --export --armor 722D2AFAD8BAD548 -o my-repo.gpg-key.asc</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 导入</span></span><br><span class="line">sudo apt-key add my-repo.gpg-key.asc</span><br></pre></td></tr></table></figure>
</li>
<li><p>客户端在执行<code>apt update</code>的时候，添加<code>--allow-insecure-repositories</code>选项；在执行<code>apt install pkg</code>的时候，添加<code>--allow-unauthenticated</code>选项。</p>
</li>
<li><p>用户修改仓库的配置，改为<code>deb [trusted=yes] http://192.168.56.47:80/hearing/repository stable main</code></p>
</li>
</ol>
<h3 id="使用手册-1"><a href="#使用手册-1" class="headerlink" title="使用手册"></a>使用手册</h3><ol>
<li>apt-get update 更新源</li>
<li>apt-get dist-upgrade 升级系统到相应的发行版(根据 source.list 的配置)</li>
<li>apt-get upgrade 更新所有已经安装的软件包</li>
<li>apt-get install package_name 安装软件包(加上 –reinstall重新安装)，apt-get install package_name=version 安装指定版本的软件包</li>
<li>apt-get remove package_name 卸载一个已安装的软件包（保留配置文件）</li>
<li>apt-get purge package_name 移除软件包（删除配置信息）或apt-get –purge remove packagename</li>
<li>apt-get check 检查是否有损坏的依赖</li>
<li>apt-get autoclean：删除你已经删掉的软件（定期运行这个命令来清除那些已经卸载的软件包的.deb文件。通过这种方式，可以释放大量的磁盘空间。可以使用apt-get<br>clean以释放更多空间。这个命令会将已安装软件包裹的.deb文件一并删除）</li>
<li>apt-get clean 把安装的软件的备份也删除，不过这样不会影响软件的使用</li>
</ol>
<p>apt-cache对APT的程序包缓存执行各种操作。apt-cache不会操纵系统状态，但会提供操作以从包元数据中搜索并生成输出。</p>
<ol>
<li>apt-cache depends packagename 了解使用依赖</li>
<li>apt-cache rdepends packagename 是查看该包被哪些包依赖</li>
<li>apt-cache search packagename 搜索包</li>
<li>apt-cache show packagename 获取包的相关信息，如说明、大小、版本等</li>
<li>apt-cache showpkg packagename 显示软件包的大致信息</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/27/Termux%E8%A7%A3%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/27/Termux%E8%A7%A3%E6%9E%90/" class="post-title-link" itemprop="url">Termux解析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-08-27 17:32:01" itemprop="dateCreated datePublished" datetime="2019-08-27T17:32:01+08:00">2019-08-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">框架</span></a>
                </span>
            </span>

          
            <span id="/2019/08/27/Termux%E8%A7%A3%E6%9E%90/" class="post-meta-item leancloud_visitors" data-flag-title="Termux解析" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/08/27/Termux%E8%A7%A3%E6%9E%90/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/08/27/Termux%E8%A7%A3%E6%9E%90/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>Termux是一个Android下一个高级的终端模拟器，开源且不需要root，支持apt管理软件包，拥有自己的apt仓库源，可以十分方便地安装软件包，可以实现支持Python,PHP,Ruby,Go,Nodejs,MySQL等功能环境。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/termux/termux-app">仓库地址</a><br><a target="_blank" rel="noopener" href="https://github.com/ljd1996/termux">修改包名后台开启终端的仓库地址</a></p>
<h1 id="一切皆文件"><a href="#一切皆文件" class="headerlink" title="一切皆文件"></a>一切皆文件</h1><p>linux/unix下的哲学核心思想是<strong>一切皆文件</strong>。它指的是，对所有文件（目录、字符设备、块设备、套接字、打印机、进程、线程、管道等）操作，读写都可用<code>fopen()/fclose()/fwrite()/fread()</code>等函数进行处理，屏蔽了硬件的区别，所有设备都抽象成文件，提供统一的接口给用户，虽然类型各不相同，但是对其提供的却是同一套操作界面，更进一步，对文件的操作也可以跨文件系统执行。</p>
<p>操作一个已经打开的文件：使用文件描述符（file descriptor），简称fd，它是一个对应某个已经打开的文件的索引（非负整数）。</p>
<h1 id="文件描述符"><a href="#文件描述符" class="headerlink" title="文件描述符"></a>文件描述符</h1><p>文件描述符在形式上是一个非负整数。实际上，它是一个索引值，指向内核为每一个进程所维护的该进程打开文件的记录表。当程序打开一个现有文件或者创建一个新文件时，内核向进程返回一个文件描述符。在程序设计中，一些涉及底层的程序编写往往会围绕着文件描述符展开。</p>
<p>Linux 系统中，把一切都看做是文件，当进程打开现有文件或创建新文件时，内核向进程返回一个文件描述符，文件描述符就是内核为了高效管理已被打开的文件所创建的索引，用来指向被打开的文件，所有执行I/O操作的系统调用都会通过文件描述符。</p>
<h1 id="修改包名"><a href="#修改包名" class="headerlink" title="修改包名"></a>修改包名</h1><p>主要是指定目录的前缀.</p>
<p><a target="_blank" rel="noopener" href="https://ljd1996.github.io/2019/08/08/termux-app%E4%BF%AE%E6%94%B9%E5%8C%85%E5%90%8D">Termux修改包名</a></p>
<h1 id="源码解读"><a href="#源码解读" class="headerlink" title="源码解读"></a>源码解读</h1><p>流程图:</p>
<p><img src="Termux%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B.jpg" alt="Termux流程图"></p>
<h2 id="setupIfNeeded"><a href="#setupIfNeeded" class="headerlink" title="setupIfNeeded"></a>setupIfNeeded</h2><p>bootstraps.zip目录结构：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">bootstrap-aarch64</span><br><span class="line">    ├── SYMLINKS.txt</span><br><span class="line">    ├── bin</span><br><span class="line">    ├── etc</span><br><span class="line">    ├── include</span><br><span class="line">    ├── lib</span><br><span class="line">    ├── libexec</span><br><span class="line">    ├── repo.asc</span><br><span class="line">    ├── share</span><br><span class="line">    ├── tmp</span><br><span class="line">    └── var</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setupIfNeeded</span><span class="params">(<span class="keyword">final</span> Activity activity, <span class="keyword">final</span> Runnable whenDone)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Termux can only be run as the primary user (device owner) since only that</span></span><br><span class="line">    <span class="comment">// account has the expected file system paths. Verify that:</span></span><br><span class="line">    UserManager um = (UserManager) activity.getSystemService(Context.USER_SERVICE);</span><br><span class="line">    <span class="keyword">boolean</span> isPrimaryUser = um.getSerialNumberForUser(android.os.Process.myUserHandle()) == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (!isPrimaryUser) &#123;</span><br><span class="line">        Termux.mInstance.setInstalled(<span class="keyword">false</span>);</span><br><span class="line">        Termux.mInstance.getTermuxHandle().initFail();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> File PREFIX_FILE = <span class="keyword">new</span> File(Termux.PREFIX_PATH);</span><br><span class="line">    <span class="keyword">if</span> (PREFIX_FILE.isDirectory()) &#123;</span><br><span class="line">        whenDone.run();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> String STAGING_PREFIX_PATH = Termux.FILES_PATH + <span class="string">&quot;/usr-staging&quot;</span>;</span><br><span class="line">                <span class="keyword">final</span> File STAGING_PREFIX_FILE = <span class="keyword">new</span> File(STAGING_PREFIX_PATH);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (STAGING_PREFIX_FILE.exists()) &#123;</span><br><span class="line">                    deleteFolder(STAGING_PREFIX_FILE);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">8096</span>];</span><br><span class="line">                <span class="keyword">final</span> List&lt;Pair&lt;String, String&gt;&gt; symlinks = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">50</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">final</span> URL zipUrl = determineZipUrl();</span><br><span class="line">                <span class="keyword">try</span> (ZipInputStream zipInput = <span class="keyword">new</span> ZipInputStream(zipUrl.openStream())) &#123;</span><br><span class="line">                    ZipEntry zipEntry;</span><br><span class="line">                    <span class="keyword">while</span> ((zipEntry = zipInput.getNextEntry()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (zipEntry.getName().equals(<span class="string">&quot;SYMLINKS.txt&quot;</span>)) &#123;</span><br><span class="line">                            BufferedReader symlinksReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(zipInput));</span><br><span class="line">                            String line;</span><br><span class="line">                            <span class="keyword">while</span> ((line = symlinksReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                String[] parts = line.split(<span class="string">&quot;←&quot;</span>);</span><br><span class="line">                                <span class="keyword">if</span> (parts.length != <span class="number">2</span>)</span><br><span class="line">                                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Malformed symlink line: &quot;</span> + line);</span><br><span class="line">                                String oldPath = parts[<span class="number">0</span>];</span><br><span class="line">                                String newPath = STAGING_PREFIX_PATH + <span class="string">&quot;/&quot;</span> + parts[<span class="number">1</span>];</span><br><span class="line">                                symlinks.add(Pair.create(oldPath, newPath));</span><br><span class="line"></span><br><span class="line">                                ensureDirectoryExists(<span class="keyword">new</span> File(newPath).getParentFile());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            String zipEntryName = zipEntry.getName();</span><br><span class="line">                            File targetFile = <span class="keyword">new</span> File(STAGING_PREFIX_PATH, zipEntryName);</span><br><span class="line">                            <span class="keyword">boolean</span> isDirectory = zipEntry.isDirectory();</span><br><span class="line"></span><br><span class="line">                            ensureDirectoryExists(isDirectory ? targetFile : targetFile.getParentFile());</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (!isDirectory) &#123;</span><br><span class="line">                                <span class="keyword">try</span> (FileOutputStream outStream = <span class="keyword">new</span> FileOutputStream(targetFile)) &#123;</span><br><span class="line">                                    <span class="keyword">int</span> readBytes;</span><br><span class="line">                                    <span class="keyword">while</span> ((readBytes = zipInput.read(buffer)) != -<span class="number">1</span>)</span><br><span class="line">                                        outStream.write(buffer, <span class="number">0</span>, readBytes);</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span> (zipEntryName.startsWith(<span class="string">&quot;bin/&quot;</span>) || zipEntryName.startsWith(<span class="string">&quot;libexec&quot;</span>) || zipEntryName.startsWith(<span class="string">&quot;lib/apt/methods&quot;</span>)) &#123;</span><br><span class="line">                                    <span class="comment">//noinspection OctalInteger</span></span><br><span class="line">                                    Os.chmod(targetFile.getAbsolutePath(), <span class="number">0700</span>);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (symlinks.isEmpty())</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;No SYMLINKS.txt encountered&quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (Pair&lt;String, String&gt; symlink : symlinks) &#123;</span><br><span class="line">                    Os.symlink(symlink.first, symlink.second);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!STAGING_PREFIX_FILE.renameTo(PREFIX_FILE)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Unable to rename staging folder&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                activity.runOnUiThread(whenDone);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (<span class="keyword">final</span> Exception e) &#123;</span><br><span class="line">                Log.e(EmulatorDebug.LOG_TAG, <span class="string">&quot;Bootstrap error&quot;</span>, e);</span><br><span class="line">                Termux.mInstance.setInstalled(<span class="keyword">false</span>);</span><br><span class="line">                Termux.mInstance.getTermuxHandle().initFail();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ensureDirectoryExists</span><span class="params">(File directory)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!directory.isDirectory() &amp;&amp; !directory.mkdirs()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Unable to create directory: &quot;</span> + directory.getAbsolutePath());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Get bootstrap zip url for this systems cpu architecture.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> URL <span class="title">determineZipUrl</span><span class="params">()</span> <span class="keyword">throws</span> MalformedURLException </span>&#123;</span><br><span class="line">    String archName = determineTermuxArchName();</span><br><span class="line">    String url = Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N</span><br><span class="line">            ? <span class="string">&quot;https://termux.org/bootstrap-&quot;</span> + archName + <span class="string">&quot;.zip&quot;</span></span><br><span class="line">            : <span class="string">&quot;https://termux.net/bootstrap/bootstrap-&quot;</span> + archName + <span class="string">&quot;.zip&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> URL(url);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">determineTermuxArchName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Note that we cannot use System.getProperty(&quot;os.arch&quot;) since that may give e.g. &quot;aarch64&quot;</span></span><br><span class="line">    <span class="comment">// while a 64-bit runtime may not be installed (like on the Samsung Galaxy S5 Neo).</span></span><br><span class="line">    <span class="comment">// Instead we search through the supported abi:s on the device, see:</span></span><br><span class="line">    <span class="comment">// http://developer.android.com/ndk/guides/abis.html</span></span><br><span class="line">    <span class="comment">// Note that we search for abi:s in preferred order (the ordering of the</span></span><br><span class="line">    <span class="comment">// Build.SUPPORTED_ABIS list) to avoid e.g. installing arm on an x86 system where arm</span></span><br><span class="line">    <span class="comment">// emulation is available.</span></span><br><span class="line">    <span class="keyword">for</span> (String androidArch : Build.SUPPORTED_ABIS) &#123;</span><br><span class="line">        <span class="keyword">switch</span> (androidArch) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;arm64-v8a&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;aarch64&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;armeabi-v7a&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;arm&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;x86_64&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;x86_64&quot;</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;x86&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;i686&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Unable to determine arch from Build.SUPPORTED_ABIS =  &quot;</span> +</span><br><span class="line">            Arrays.toString(Build.SUPPORTED_ABIS));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="createSubprocess"><a href="#createSubprocess" class="headerlink" title="createSubprocess"></a>createSubprocess</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">create_subprocess</span><span class="params">(JNIEnv* env,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">char</span> <span class="keyword">const</span>* cmd,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">char</span> <span class="keyword">const</span>* cwd,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">char</span>* <span class="keyword">const</span> argv[],</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">char</span>** envp,</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">int</span>* pProcessId,</span></span></span><br><span class="line"><span class="function"><span class="params">        jint rows,</span></span></span><br><span class="line"><span class="function"><span class="params">        jint columns)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ptm = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR | O_CLOEXEC);</span><br><span class="line">    <span class="keyword">if</span> (ptm &lt; <span class="number">0</span>) <span class="keyword">return</span> throw_runtime_exception(env, <span class="string">&quot;Cannot open /dev/ptmx&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> LACKS_PTSNAME_R</span></span><br><span class="line">    <span class="keyword">char</span>* devname;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">char</span> devname[<span class="number">64</span>];</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">if</span> (grantpt(ptm) || unlockpt(ptm) ||</span><br><span class="line">#ifdef LACKS_PTSNAME_R</span><br><span class="line">            (devname = ptsname(ptm)) == <span class="literal">NULL</span></span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line">            ptsname_r(ptm, devname, <span class="keyword">sizeof</span>(devname))</span><br><span class="line">#endif</span><br><span class="line">       ) &#123;</span><br><span class="line">        <span class="keyword">return</span> throw_runtime_exception(env, <span class="string">&quot;Cannot grantpt()/unlockpt()/ptsname_r() on /dev/ptmx&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enable UTF-8 mode and disable flow control to prevent Ctrl+S from locking up the display.</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">tios</span>;</span></span><br><span class="line">    tcgetattr(ptm, &amp;tios);</span><br><span class="line">    tios.c_iflag |= IUTF8;</span><br><span class="line">    tios.c_iflag &amp;= ~(IXON | IXOFF);</span><br><span class="line">    tcsetattr(ptm, TCSANOW, &amp;tios);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Set initial winsize. */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">winsize</span> <span class="title">sz</span> = &#123;</span> .ws_row = (<span class="keyword">unsigned</span> <span class="keyword">short</span>) rows, .ws_col = (<span class="keyword">unsigned</span> <span class="keyword">short</span>) columns &#125;;</span><br><span class="line">    ioctl(ptm, TIOCSWINSZ, &amp;sz);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pid_t</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span> (pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> throw_runtime_exception(env, <span class="string">&quot;Fork failed&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        *pProcessId = (<span class="keyword">int</span>) pid;</span><br><span class="line">        <span class="keyword">return</span> ptm;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Clear signals which the Android java process may have blocked:</span></span><br><span class="line">        <span class="keyword">sigset_t</span> signals_to_unblock;</span><br><span class="line">        sigfillset(&amp;signals_to_unblock);</span><br><span class="line">        sigprocmask(SIG_UNBLOCK, &amp;signals_to_unblock, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        close(ptm);</span><br><span class="line">        setsid();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> pts = open(devname, O_RDWR);</span><br><span class="line">        <span class="keyword">if</span> (pts &lt; <span class="number">0</span>) <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        dup2(pts, <span class="number">0</span>);</span><br><span class="line">        dup2(pts, <span class="number">1</span>);</span><br><span class="line">        dup2(pts, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        DIR* self_dir = opendir(<span class="string">&quot;/proc/self/fd&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (self_dir != <span class="literal">NULL</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> self_dir_fd = dirfd(self_dir);</span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span>* <span class="title">entry</span>;</span></span><br><span class="line">            <span class="keyword">while</span> ((entry = readdir(self_dir)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                <span class="keyword">int</span> fd = atoi(entry-&gt;d_name);</span><br><span class="line">                <span class="keyword">if</span>(fd &gt; <span class="number">2</span> &amp;&amp; fd != self_dir_fd) close(fd);</span><br><span class="line">            &#125;</span><br><span class="line">            closedir(self_dir);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        clearenv();</span><br><span class="line">        <span class="keyword">if</span> (envp) <span class="keyword">for</span> (; *envp; ++envp) putenv(*envp);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (chdir(cwd) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">char</span>* error_message;</span><br><span class="line">            <span class="comment">// No need to free asprintf()-allocated memory since doing execvp() or exit() below.</span></span><br><span class="line">            <span class="keyword">if</span> (asprintf(&amp;error_message, <span class="string">&quot;chdir(\&quot;%s\&quot;)&quot;</span>, cwd) == <span class="number">-1</span>) error_message = <span class="string">&quot;chdir()&quot;</span>;</span><br><span class="line">            perror(error_message);</span><br><span class="line">            fflush(<span class="built_in">stderr</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        execvp(cmd, argv);</span><br><span class="line">        <span class="comment">// Show terminal output about failing exec() call:</span></span><br><span class="line">        <span class="keyword">char</span>* error_message;</span><br><span class="line">        <span class="keyword">if</span> (asprintf(&amp;error_message, <span class="string">&quot;exec(\&quot;%s\&quot;)&quot;</span>, cmd) == <span class="number">-1</span>) error_message = <span class="string">&quot;exec()&quot;</span>;</span><br><span class="line">        perror(error_message);</span><br><span class="line">        _exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="操作terminal"><a href="#操作terminal" class="headerlink" title="操作terminal"></a>操作terminal</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * A queue written to from a separate thread when the process outputs, and read by main thread to process by</span></span><br><span class="line"><span class="comment">    * terminal emulator.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ByteQueue mProcessToTerminalIOQueue = <span class="keyword">new</span> ByteQueue(<span class="number">4096</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * A queue written to from the main thread due to user interaction, and read by another thread which forwards by</span></span><br><span class="line"><span class="comment">    * writing to the &#123;<span class="doctag">@link</span> #mTerminalFileDescriptor&#125;.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ByteQueue mTerminalToProcessIOQueue = <span class="keyword">new</span> ByteQueue(<span class="number">4096</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initializeEmulator</span><span class="params">(<span class="keyword">int</span> columns, <span class="keyword">int</span> rows)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span>[] processId = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">1</span>];</span><br><span class="line">    mTerminalFileDescriptor = JNI.createSubprocess(mShellPath, mCwd, mArgs, mEnv, processId, rows, columns);</span><br><span class="line">    mShellPid = processId[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> FileDescriptor terminalFileDescriptorWrapped = wrapFileDescriptor(mTerminalFileDescriptor);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Thread(<span class="string">&quot;TermSessionInputReader[pid=&quot;</span> + mShellPid + <span class="string">&quot;]&quot;</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">try</span> (InputStream termIn = <span class="keyword">new</span> FileInputStream(terminalFileDescriptorWrapped)) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4096</span>];</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> read = termIn.read(buffer);</span><br><span class="line">                    <span class="keyword">if</span> (read == -<span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line">                    <span class="keyword">if</span> (!mProcessToTerminalIOQueue.write(buffer, <span class="number">0</span>, read)) <span class="keyword">return</span>;</span><br><span class="line">                    mMainThreadHandler.sendEmptyMessage(MSG_NEW_INPUT);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// Ignore, just shutting down.</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Thread(<span class="string">&quot;TermSessionOutputWriter[pid=&quot;</span> + mShellPid + <span class="string">&quot;]&quot;</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">byte</span>[] buffer = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">4096</span>];</span><br><span class="line">            <span class="keyword">try</span> (FileOutputStream termOut = <span class="keyword">new</span> FileOutputStream(terminalFileDescriptorWrapped)) &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">int</span> bytesToWrite = mTerminalToProcessIOQueue.read(buffer, <span class="keyword">true</span>);</span><br><span class="line">                    <span class="keyword">if</span> (bytesToWrite == -<span class="number">1</span>) <span class="keyword">return</span>;</span><br><span class="line">                    termOut.write(buffer, <span class="number">0</span>, bytesToWrite);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                <span class="comment">// Ignore.</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> Thread(<span class="string">&quot;TermSessionWaiter[pid=&quot;</span> + mShellPid + <span class="string">&quot;]&quot;</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> processExitCode = JNI.waitFor(mShellPid);</span><br><span class="line">            mMainThreadHandler.sendMessage(mMainThreadHandler.obtainMessage(MSG_PROCESS_EXITED, processExitCode));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.start();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mShellPath: /data/data/$pkg/files/usr/bin/login</span><br><span class="line">mCwd: /data/data/$pkg/files/home</span><br><span class="line">mArgs: [-login]</span><br><span class="line">mEnv: [TERM=xterm-256color, HOME=/data/data/$pkg/files/home, PREFIX=/data/data/$pkg/files/usr, BOOTCLASSPATH/system/framework/com.qualcomm.qti.camera.jar:/system/framework/QPerformance.jar:/system/framework/core-oj.jar:/system/framework/core-libart.jar:/system/framework/conscrypt.jar:/system/framework/okhttp.jar:/system/framework/bouncycastle.jar:/system/framework/apache-xml.jar:/system/framework/legacy-test.jar:/system/framework/ext.jar:/system/framework/framework.jar:/system/framework/telephony-common.jar:/system/framework/voip-common.jar:/system/framework/ims-common.jar:/system/framework/org.apache.http.legacy.boot.jar:/system/framework/android.hidl.base-V1.0-java.jar:/system/framework/android.hidl.manager-V1.0-java.jar:/system/framework/tcmiface.jar:/system/framework/WfdCommon.jar:/system/framework/oem-services.jar:/system/framework/qcom.fmradio.jar:/system/framework/telephony-ext.jar:/system/app/miui/miui.apk:/system/app/miuisystem/miuisystem.apk, ANDROID_ROOT=/system, ANDROID_DATA=/data, EXTERNAL_STORAGE=/sdcard, LD_LIBRARY_PATH=/data/data/$pkg/files/usr/lib, LANG=en_US.UTF-8, PATH=/data/data/$pkg/files/usr/bin:/data/data/$pkg/files/usr/bin/applets, PWD=/data/data/$pkg/files/home, TMPDIR=/data/data/$pkg/files/usr/tmp]</span><br><span class="line">mShellPid: 15381</span><br><span class="line">mTerminalFileDescriptor: 54</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/27/Android%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/27/Android%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Android代码混淆笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-08-27 15:18:31" itemprop="dateCreated datePublished" datetime="2019-08-27T15:18:31+08:00">2019-08-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/%E5%AE%9E%E6%88%98/" itemprop="url" rel="index"><span itemprop="name">实战</span></a>
                </span>
            </span>

          
            <span id="/2019/08/27/Android%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="Android代码混淆笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/08/27/Android%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/08/27/Android%E4%BB%A3%E7%A0%81%E6%B7%B7%E6%B7%86%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>Android SDK 自带了混淆工具Proguard。它位于SDK根目录\tools\proguard下面。如果开启了混淆，Proguard默认情况下会对所有代码，包括第三方包都进行混淆，可是有些代码或者第三方包是不能混淆的，这就需要我们手动编写混淆规则来保持不能被混淆的部分。</p>
<p>混淆有几个作用(默认开启)：</p>
<ol>
<li>【优化】它能优化java的字节码，使程序运行更快(-dontoptimize：关闭优化)；</li>
<li>【压缩】最直观的就是减少App大小，在混淆过程中它会找出未被使用过的类和类成员并删除他们(-dontshrink，关闭压缩)；</li>
<li>【混淆】这个功能使我们的java代码中的类、函数、变量名随机变成无意义的代号(-dontobfuscate：关闭混淆)。</li>
</ol>
<p>在Android Studio新版本中启用了R8混淆：</p>
<img src="R8.png"/>

<h1 id="开启混淆"><a href="#开启混淆" class="headerlink" title="开启混淆"></a>开启混淆</h1><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion <span class="number">29</span></span><br><span class="line">    buildToolsVersion <span class="string">&quot;29.0.1&quot;</span></span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            zipAlignEnabled <span class="literal">true</span>    <span class="comment">// 能优化java字节码，提高运行效率</span></span><br><span class="line">            minifyEnabled <span class="literal">true</span>      <span class="comment">// 开启混淆</span></span><br><span class="line">            <span class="comment">// &#x27;proguard-android.txt&#x27; 是默认导入的规则，这个文件位于/tools/proguard/下</span></span><br><span class="line">            <span class="comment">// &#x27;proguard-rules.pro&#x27;是针对我们自己的项目需要特别定义混淆规则</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android.txt&#x27;</span>), <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="混淆规则"><a href="#混淆规则" class="headerlink" title="混淆规则"></a>混淆规则</h1><h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p><code>proguard-android.txt</code>文件内容如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">混淆时不生成大小写混合的类名</span></span><br><span class="line">-dontusemixedcaseclassnames</span><br><span class="line"><span class="meta">#</span><span class="bash">不忽略非公共的类库</span></span><br><span class="line">-dontskipnonpubliclibraryclasses</span><br><span class="line"><span class="meta">#</span><span class="bash">混淆过程中打印详细信息</span></span><br><span class="line">-verbose</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">关闭优化</span></span><br><span class="line">-dontoptimize</span><br><span class="line"><span class="meta">#</span><span class="bash">不预校验</span></span><br><span class="line">-dontpreverify</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Annotation注释不能混淆</span></span><br><span class="line">-keepattributes *Annotation*</span><br><span class="line"><span class="meta">#</span><span class="bash">对于NDK开发 本地的native方法不能被混淆</span></span><br><span class="line">-keepclasseswithmembernames class * &#123;</span><br><span class="line">    native &lt;methods&gt;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">保持View的子类里面的<span class="built_in">set</span>、get方法不被混淆（*代替任意字符）</span></span><br><span class="line">-keepclassmembers public class * extends android.view.View &#123;</span><br><span class="line">   void set*(***);</span><br><span class="line">   *** get*();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">保持Activity子类里面的参数类型为View的方法不被混淆，如被XML里面应用的onClick方法</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> We want to keep methods <span class="keyword">in</span> Activity that could be used <span class="keyword">in</span> the XML attribute onClick</span></span><br><span class="line">-keepclassmembers class * extends android.app.Activity &#123;</span><br><span class="line">   public void *(android.view.View);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">保持枚举类型values()、以及valueOf(java.lang.String)成员不被混淆</span></span><br><span class="line">-keepclassmembers enum * &#123;</span><br><span class="line">    public static **[] values();</span><br><span class="line">    public static ** valueOf(java.lang.String);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">保持实现Parcelable接口的类里面的Creator成员不被混淆</span></span><br><span class="line">-keepclassmembers class * implements android.os.Parcelable &#123;</span><br><span class="line">  public static final android.os.Parcelable$Creator CREATOR;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">保持R类静态成员不被混淆</span></span><br><span class="line">-keepclassmembers class **.R$* &#123;</span><br><span class="line">    public static &lt;fields&gt;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">不警告support包中不使用的引用</span></span><br><span class="line">-dontwarn android.support.**</span><br><span class="line">-keep class android.support.annotation.Keep</span><br><span class="line">-keep @android.support.annotation.Keep class * &#123;*;&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">保持使用了Keep注解的方法以及类不被混淆</span></span><br><span class="line">-keepclasseswithmembers class * &#123;</span><br><span class="line">    @android.support.annotation.Keep &lt;methods&gt;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">保持使用了Keep注解的成员域以及类不被混淆</span></span><br><span class="line">-keepclasseswithmembers class * &#123;</span><br><span class="line">    @android.support.annotation.Keep &lt;fields&gt;;</span><br><span class="line">&#125;</span><br><span class="line">-keepclasseswithmembers class * &#123;</span><br><span class="line">    @android.support.annotation.Keep &lt;init&gt;(...);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面默认的规则中指示了些需要保持不能别混淆的代码，包括：</p>
<ol>
<li>继承至Android组件（Activity, Service…）的类。</li>
<li>自定义控件，继承至View的类（被xml文件引用到的，名字已经固定了的）</li>
<li>enum 枚举</li>
<li>实现了 android.os.Parcelable 接口的</li>
<li>Android R文件</li>
<li>数据库驱动…</li>
<li>Android support 包等</li>
<li>Android 的注释不能混淆</li>
<li>对于NDK开发 本地的native方法不能被混淆</li>
<li>对于特定的项目还有很多不能被混淆的，需要我们自己写规则来指示</li>
</ol>
<p>自己编写<code>proguard-rules.pro</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">压缩级别0-7，Android一般为5(对代码迭代优化的次数)</span></span><br><span class="line">-optimizationpasses 5 </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">不使用大小写混合类名</span></span><br><span class="line">-dontusemixedcaseclassnames </span><br><span class="line"></span><br><span class="line"><span class="meta"> #</span><span class="bash">混淆时记录日志</span></span><br><span class="line">-verbose</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">不警告org.greenrobot.greendao.database包及其子包里面未引用的引用</span></span><br><span class="line">-dontwarn org.greenrobot.greendao.database.**</span><br><span class="line">-dontwarn rx.**</span><br><span class="line">-dontwarn org.codehaus.jackson.**</span><br><span class="line">......</span><br><span class="line"><span class="meta">#</span><span class="bash">保持jackson包以及其子包的类和类成员不被混淆</span></span><br><span class="line">-keep class org.codehaus.jackson.** &#123;*;&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">--------重要说明-------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">-keep class 类名 &#123;*;&#125;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">-keepclassmembers class 类名&#123;*;&#125;</span></span><br><span class="line"><span class="meta">#</span><span class="bash">一个*表示保持了该包下的类名不被混淆；</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -keep class org.codehaus.jackson.*</span></span><br><span class="line"><span class="meta">#</span><span class="bash">二个**表示保持该包以及它包含的所有子包下的类名不被混淆</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -keep class org.codehaus.jackson.** </span></span><br><span class="line"><span class="meta">#</span><span class="bash">------------------------</span></span><br><span class="line"><span class="meta">#</span><span class="bash">保持类名、类里面的方法和变量不被混淆</span></span><br><span class="line">-keep class org.codehaus.jackson.** &#123;*;&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">不混淆类ClassTwoOne的类名以及类里面的public成员和方法</span></span><br><span class="line"><span class="meta">#</span><span class="bash">public 可以换成其他java属性如private、public static 、final等</span></span><br><span class="line"><span class="meta">#</span><span class="bash">还可以使&lt;init&gt;表示构造方法、&lt;methods&gt;表示方法、&lt;fields&gt;表示成员，</span></span><br><span class="line"><span class="meta">#</span><span class="bash">这些前面也可以加public等java属性限定</span></span><br><span class="line">-keep class com.dev.demo.two.ClassTwoOne &#123;</span><br><span class="line">    public *;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">不混淆类名，以及里面的构造函数</span></span><br><span class="line">-keep class com.dev.demo.ClassOne &#123;</span><br><span class="line">    public &lt;init&gt;();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">不混淆类名，以及参数为int 的构造函数</span></span><br><span class="line">-keep class com.dev.demo.two.ClassTwoTwo &#123;</span><br><span class="line">    public &lt;init&gt;(int);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">不混淆类的public修饰的方法，和private修饰的变量</span></span><br><span class="line">-keepclassmembers class com.dev.demo.two.ClassTwoThree &#123;</span><br><span class="line">    public &lt;methods&gt;;</span><br><span class="line">    private &lt;fields&gt;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#</span><span class="bash">不混淆内部类，需要用$修饰</span></span><br><span class="line"><span class="meta">#</span><span class="bash">不混淆内部类ClassTwoTwoInner以及里面的全部成员</span></span><br><span class="line">-keep class com.dev.demo.two.ClassTwoTwo$ClassTwoTwoInner&#123;*;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="混淆规则-1"><a href="#混淆规则-1" class="headerlink" title="混淆规则"></a>混淆规则</h2><ul>
<li><p>-keepattributes {name}：保护给定的属性不被混淆</p>
</li>
<li><p>-dontwarn {name}：不要警告指定库中找不到的引用。混淆在默认情况下会检查每个库的引用是否正确，但是有些第三方库里面会有用不到的类，有些没有正确引用，所以需要对第三方库取消警告，否则会报错，而且有可能混淆时间会很长</p>
</li>
<li><p>-keep {Modifier} {class_specification}：保留指定的类、类成员不被混淆</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">例如对一个可执行jar包来说,需要保护main的入口类,对一个类库来说需要保护它的所有public元素</span></span><br><span class="line">-keep public class MyMain&#123;</span><br><span class="line">    public static void main(java.lang.String[]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>-keepclassmembers {modifier} {class_specification}：保留指定的类成员不被混淆</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">例如指定继承了Serizalizable的类的如下成员不被混淆,成员属性和方法,非私有的属性非私有的方法.</span></span><br><span class="line">-keepclassmembers class * implements java.io.Serializable&#123;</span><br><span class="line">    static final long seriaVersionUID;</span><br><span class="line">    !private &lt;fields&gt;;</span><br><span class="line">    !private &lt;methods&gt;;</span><br><span class="line">    private void writeObject(java.io.ObjectOuputStream);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>-keepclasseswithmembers {class_specification}：保护指定成员的类,根据成员确定一些将要被保护的类</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">保护含有main方法的类以及这个类的main方法</span></span><br><span class="line">-keepclasseswithmembers public class * &#123;</span><br><span class="line">    public static void main(java.lang.String[]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>-keepnames {Modifier}{class_specification}：这个是-keep,allowshrinking {Modifier}{class_specification}的简写.意思是说允许压缩操作,如果在压缩过程中没有被删除,那么类名和该类中的成员的名字会被保护</p>
</li>
<li><p>-keepclassmembernames {Modifier}{class_specification}：如果在压缩过程中没有被删除在保护这个类中的成员</p>
</li>
<li><p>-keepclasseswithmembernames {Modifier}{class_specification}：如果在压缩过程中该类没有被删除,同样如果该类中有某个成员字段或者方法,那么保护这个类和这个方法</p>
</li>
<li><p>-printseeds {filename}将keep的成员输出到文件或者打印到标准输出</p>
</li>
</ul>
<h2 id="通配符"><a href="#通配符" class="headerlink" title="通配符"></a>通配符</h2><table>
<thead>
<tr>
<th align="left">通配符</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">&lt;fields&gt;</td>
<td align="left">匹配类中的所有字段</td>
</tr>
<tr>
<td align="left">&lt;methods&gt;</td>
<td align="left">匹配类中的所有方法</td>
</tr>
<tr>
<td align="left">&lt;init&gt;</td>
<td align="left">匹配类中的所有构造函数</td>
</tr>
<tr>
<td align="left">*</td>
<td align="left">匹配任意长度字符，但不含包名分隔符(.)。比如说我们的完整类名是com.example.test.MyActivity，使用com.<em>，或者com.exmaple.<em>都是无法匹配的，因为\</em>无法匹配包名中的分隔符，正确的匹配方式是com.exmaple.</em>.*，或者com.exmaple.test.*，这些都是可以的。</td>
</tr>
<tr>
<td align="left">**</td>
<td align="left">匹配任意长度字符，并且包含包名分隔符(.)。比如proguard-android.txt中使用的<code>-dontwarn android.support.**</code>就可以匹配android.support包下的所有内容，包括任意长度的子包。</td>
</tr>
<tr>
<td align="left">***</td>
<td align="left">匹配任意参数类型。比如<code>void set*(***)</code>，就能匹配任意传入的参数类型，*** get*()就能匹配任意返回值的类型。</td>
</tr>
</tbody></table>
<h2 id="删除日志"><a href="#删除日志" class="headerlink" title="删除日志"></a>删除日志</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 删除日志 (一定要把 -dontoptimize 配置去掉，否则无法删除日志)</span></span><br><span class="line">-assumenosideeffects class org.apache.log4j.** &#123;*;&#125;</span><br><span class="line">-assumenosideeffects class de.mindpipe.android.logging.log4j.LogConfigurator &#123;*;&#125;</span><br><span class="line">-assumenosideeffects class android.util.Log &#123;</span><br><span class="line">    public static boolean isLoggable(java.lang.String, int);</span><br><span class="line">    public static int v(...);</span><br><span class="line">    public static int i(...);</span><br><span class="line">    public static int w(...);</span><br><span class="line">    public static int d(...);</span><br><span class="line">    public static int e(...);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="混淆输出"><a href="#混淆输出" class="headerlink" title="混淆输出"></a>混淆输出</h1><p>成功打包后会在目录 app/build/outputs/mapping/release 下生成几个文件：</p>
<ul>
<li>dump.txt 混淆后类的内部结构说明</li>
<li>mapping.txt 混淆前与混淆后名称对应关系</li>
<li>seeds.txt 经过了一系列keep语句的保持，没有被混淆的类，成员的名称列表文件</li>
<li>usage.txt 经过压缩后被删除的没有使用的代码，方法…等的名称的列表文件</li>
</ul>
<h1 id="ReTrace"><a href="#ReTrace" class="headerlink" title="ReTrace"></a>ReTrace</h1><p>可以使用retrace工具和mapping文件反推崩溃日志以及还原混淆代码，retrace工具在tools/proguard/bin 下，可以使用retrace命令行工具，也可以使用proguardgui工具。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">retrace.sh -verbose mapping.txt stacktrace.txt &gt; out.txt</span><br></pre></td></tr></table></figure>

<p>有时为了Crash日志更容易定位可以在规则里面添加:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-keepattributes SourceFile, LineNumberTable</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/26/Android%E7%AD%BE%E5%90%8D%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/26/Android%E7%AD%BE%E5%90%8D%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Android签名笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-08-26 15:18:11" itemprop="dateCreated datePublished" datetime="2019-08-26T15:18:11+08:00">2019-08-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">系统</span></a>
                </span>
            </span>

          
            <span id="/2019/08/26/Android%E7%AD%BE%E5%90%8D%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="Android签名笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/08/26/Android%E7%AD%BE%E5%90%8D%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/08/26/Android%E7%AD%BE%E5%90%8D%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="应用沙盒"><a href="#应用沙盒" class="headerlink" title="应用沙盒"></a>应用沙盒</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Android 平台利用基于用户的 Linux 保护机制来识别和隔离应用资源，可将不同的应用分离开，并保护应用和系统免受恶意应用的攻击。为此，Android 会为每个 Android 应用分配一个独一无二的用户 ID (UID)，并在自己的进程中运行。</p>
<p>Android 会使用此 UID 设置一个内核级应用沙盒。内核会在进程级别利用标准的 Linux 机制（例如，分配给应用的用户 ID 和组 ID）实现应用和系统之间的安全防护。 默认情况下，应用不能彼此交互，而且对操作系统的访问权限会受到限制。例如，如果应用 A（一个单独的应用）尝试执行恶意操作，例如在没有权限的情况下读取应用 B 的数据或拨打电话，操作系统会阻止此类行为，因为应用 A 没有适当的用户权限。这一沙盒机制非常简单，可审核，并且基于已有数十年历史的 UNIX 风格的进程用户隔离和文件权限机制。</p>
<p>由于应用沙盒位于内核层面，因此该安全模型的保护范围扩展到了原生代码和操作系统应用。位于更高层面的所有软件（例如，操作系统库、应用框架、应用运行时环境和所有应用）都会在应用沙盒中运行。在某些平台上，为了执行安全防护机制，会限制开发者只能使用特定的开发框架、API 或语言。在 Android 上，并没有为此而限制开发者必须如何编写应用；在这方面，原生代码与解释型代码一样进行沙盒化。</p>
<h2 id="保护机制"><a href="#保护机制" class="headerlink" title="保护机制"></a>保护机制</h2><p>通常，要在经过适当配置的设备上攻破应用沙盒这道防线，必须要先攻破 Linux 内核的安全功能。但是，与其他安全功能类似，强制执行应用沙盒的各种保护机制并非无懈可击，因此深度防御对于防止通过单个漏洞入侵操作系统或其他应用非常重要。</p>
<p>Android 依靠许多保护机制来强制执行应用沙盒。 这些强制措施是随着时间的推移不断引入的，并且显著增强了基于 UID 的原始自主访问控制 (DAC) 沙盒的安全性。 以前的 Android 版本包括以下保护机制：</p>
<ul>
<li>在 Android 5.0 中，SELinux 提供了强制访问控制 (MAC) 来将系统和应用分离开。但是，所有第三方应用都在相同的 SELinux 环境中运行，因此应用间的隔离主要由 UID DAC 强制执行。</li>
<li>在 Android 6.0 中，SELinux 沙盒经过扩展，可以跨各个物理用户边界隔离应用。此外，Android 还为应用数据设置了更安全的默认设置：对于 targetSdkVersion &gt;= 24 的应用，应用主目录上的默认 DAC 权限从 751 更改为 700。这为私有应用数据提供了更安全的默认设置（但应用可能会替换这些默认设置）。</li>
<li>在 Android 8.0 中，所有应用都设为使用 seccomp-bpf 过滤器运行，该过滤器可限制允许应用使用的系统调用，从而增强应用/内核边界的安全性。</li>
<li>在 Android 9 中，targetSdkVersion &gt;= 28 的所有非特权应用都必须在不同的 SELinux 沙盒中运行，并针对各个应用提供 MAC。这种保护机制可以提升应用隔离效果，防止替换安全默认设置，并且（最重要的是）防止应用的数据可让所有人访问。</li>
</ul>
<h2 id="共享文件指南"><a href="#共享文件指南" class="headerlink" title="共享文件指南"></a>共享文件指南</h2><p>将应用数据设为可供所有人访问从安全方面来讲是一种不好的做法，因为这会为所有人授予访问权限，并且无法限定只让目标受众访问这些数据。这种做法会导致信息披露泄露，让代理漏洞变得混乱，并会成为针对包含敏感数据的应用（例如电子邮件客户端）的恶意软件的首选目标。在 Android 9 及更高版本中，targetSdkVersion&gt;=28 的应用明确禁止以这种方式共享文件。</p>
<p>在共享文件时，请遵循以下指南，而不是让应用数据可供所有人访问：</p>
<p>如果您的应用需要与其他应用共享文件，请使用<a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/providers/content-provider-basics.html">内容提供程序</a>或<a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/data/data-storage.html#filesExternal">外部存储设备</a>上的共享位置。内容提供程序会以适当的粒度共享数据，并且不会出现使用所有人都可访问的 UNIX 权限会带来的诸多问题（如需了解详情，请参阅<a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/providers/content-provider-basics.html">内容提供程序基础知识</a>）。<br>如果您的应用包含确实应让所有人访问的文件（例如照片），请使用<a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/data/data-storage.html#filesExterna[](https://developer.android.com/training/data-storage/files.html#PublicFiles)l">外部存储设备</a>。如需帮助，请参阅<a target="_blank" rel="noopener" href="https://developer.android.com/training/data-storage/files.html#PublicFiles">将文件保存至公共目录</a>。</p>
<h1 id="应用签名"><a href="#应用签名" class="headerlink" title="应用签名"></a>应用签名</h1><p>在 Android 上，应用签名是将应用放入其应用沙盒的第一步。已签名的应用证书定义了哪个用户 ID 与哪个应用相关联；不同的应用要以不同的用户 ID 运行。应用签名可确保一个应用无法访问任何其他应用的数据，通过明确定义的 IPC 进行访问时除外。</p>
<p>当应用（APK 文件）安装到 Android 设备上时，软件包管理器会验证 APK 是否已经过适当签名（已使用 APK 中包含的证书签名）。如果该证书（或更准确地说，证书中的公钥）与设备上的任何其他 APK 使用的签名密钥一致，那么这个新 APK 就可以选择在清单中指定它将与其他以类似方式签名的 APK 共用一个 UID。</p>
<p>应用可以由第三方（OEM、运营商、其他应用市场）签名，也可以自行签名。Android 提供了使用自签名证书进行代码签名的功能，而开发者无需外部协助或许可即可生成自签名证书。应用并非必须由核心机构签名。Android 目前不对应用证书进行 CA 认证。</p>
<p>应用还可以在“签名”保护级别声明安全权限，以便仅限使用同一个密钥签名的应用访问它们，同时维持单独的 UID 和应用沙盒。通过<a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/manifest/manifest-element#uid">共用 UID 功能</a>，可以与共用的应用沙盒建立更紧密的联系，这是因为借助该功能，使用同一个开发者密钥签名的两个或更多应用可以在其清单中声明共用的 UID。</p>
<p>Android 支持以下三种应用签名方案：</p>
<ul>
<li>v1 方案：基于 JAR 签名。</li>
<li>v2 方案：APK 签名方案 v2（在 Android 7.0 中引入）。</li>
<li>v3 方案：APK 签名方案 v3（在 Android 9 中引入）。</li>
</ul>
<p>为了最大限度地提高兼容性，请按照 v1、v2、v3 的先后顺序采用所有方案对应用进行签名。与只通过 v1 方案签名的应用相比，还通过 v2+ 方案签名的应用能够更快速地安装到 Android 7.0 及更高版本的设备上。更低版本的 Android 平台会忽略 v2+ 签名，这就需要应用包含 v1 签名。</p>
<h2 id="v1方案-jarsinger"><a href="#v1方案-jarsinger" class="headerlink" title="v1方案(jarsinger)"></a>v1方案(jarsinger)</h2><h3 id="签名机制"><a href="#签名机制" class="headerlink" title="签名机制"></a>签名机制</h3><p>v1 签名不保护 APK 的某些部分，例如 ZIP 元数据。APK 验证程序需要处理大量不可信（尚未经过验证）的数据结构，然后会舍弃不受签名保护的数据。这会导致相当大的受攻击面。此外，APK 验证程序必须解压所有已压缩的条目，而这需要花费更多时间和内存。为了解决这些问题，Android 7.0 中引入了 APK 签名方案 v2。</p>
<p>APK文件本质上是一个ZIP压缩包，而ZIP格式是固定的，主要由三部分构成：</p>
<ul>
<li>第一部分是内容块，所有的压缩文件都在这部分。每个压缩文件都有一个local file header，主要记录了文件名、压缩算法、压缩前后的文件大小、修改时间、CRC32值等。</li>
<li>第二部分称为中央目录，包含了多个central directory file header（和第一部分的local file header一一对应），每个中央目录文件头主要记录了压缩算法、注释信息、对应local file header的偏移量等，方便快速定位数据。</li>
<li>最后一部分是EOCD，主要记录了中央目录大小、偏移量和ZIP注释信息等</li>
</ul>
<p>V1签名只会检验第一部分的所有压缩文件，而不理会后两部分内容。</p>
<p>解压APK后，在META-INF目录下，可以看到三个文件：MANIFEST.MF、CERT.SF、CERT.RSA。它们都是V1签名的产物。</p>
<p>其中，MANIFEST.MF文件内容如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0   // 用来定义manifest文件的版本</span><br><span class="line">Built-By: Generated-by-ADT  // 声明该文件的构建者</span><br><span class="line">Created-By: Android Gradle 3.4.2  // 声明该文件的生成者</span><br><span class="line"></span><br><span class="line">Name: AndroidManifest.xml</span><br><span class="line">SHA-256-Digest: 2ukv+j6Xu2UEEelZaKeZ+63IpYQ5FqCbIfA6QKk7fgM=</span><br><span class="line"></span><br><span class="line">Name: META-INF/androidx.appcompat_appcompat.version</span><br><span class="line">SHA-256-Digest: n9KGQtOsoZHlx/wjg8/W+rsqrIdD8Cnau4mJrFhOMbw=</span><br><span class="line"></span><br><span class="line">Name: META-INF/androidx.arch.core_core-runtime.version</span><br><span class="line">SHA-256-Digest: wo/MpTY3vIjhJK8XJd8Ty5jGne3v1i+zzb4c22t2BiQ=</span><br><span class="line"></span><br><span class="line">// ...</span><br><span class="line"></span><br><span class="line">Name: res/drawable-nodpi-v4/filter_48.jpg</span><br><span class="line">SHA-256-Digest: FfpvAStgPFXWDjVvs/N2H+XULiIwwwfqGtp1fPg0YYo=</span><br><span class="line"></span><br><span class="line">// ...</span><br><span class="line"></span><br><span class="line">Name: res/xml/file_paths.xml</span><br><span class="line">SHA-256-Digest: 9s07yeSRLkE3+iYROBVOBmGlmApgGVDUeGsZQ9HYPfo=</span><br><span class="line"></span><br><span class="line">Name: resources.arsc</span><br><span class="line">SHA-256-Digest: uGEAbvopf67Kasj8mPZE7R1NpI9jzuaL26usC1mXVsE=</span><br></pre></td></tr></table></figure>

<p>它记录了APK中所有原始文件的数据摘要的Base64编码,而数据摘要算法就是SHA256（或SHA1）。</p>
<p>CERT.SF文件内容如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Signature-Version: 1.0</span><br><span class="line">Created-By: 1.0 (Android)</span><br><span class="line">SHA-256-Digest-Manifest: qXt5WBCgJuQFdkZK1ZpHd5KnGllF0FNY/yx++rgsdDc=</span><br><span class="line">X-Android-APK-Signed: 2</span><br><span class="line"></span><br><span class="line">Name: AndroidManifest.xml</span><br><span class="line">SHA-256-Digest: 9SF8sMBwuyZm25vpoYk4VZImaK37o4rXpIGKPWWDj9M=</span><br><span class="line"></span><br><span class="line">Name: META-INF/androidx.appcompat_appcompat.version</span><br><span class="line">SHA-256-Digest: ABbgKP0s08CVeuJ5ZMlIZx/AvJtb1QhNA0ffeXfCaHk=</span><br><span class="line"></span><br><span class="line">Name: META-INF/androidx.arch.core_core-runtime.version</span><br><span class="line">SHA-256-Digest: PjygIQMN5T6nIKT/hi5PFaxVcEB+W20fr4f0g2n7jrg=</span><br><span class="line"></span><br><span class="line">//...</span><br><span class="line"></span><br><span class="line">Name: res/xml/file_paths.xml</span><br><span class="line">SHA-256-Digest: aDSRY140t8cYqDFleCi9Gc4NTFo0EfbEY/Mr3vlfx1o=</span><br><span class="line"></span><br><span class="line">Name: resources.arsc</span><br><span class="line">SHA-256-Digest: KNGXNZ4K5DU+sdJIblO/zwEug24++hvcQxp7fbaf6Gk=</span><br></pre></td></tr></table></figure>

<p>SHA-256-Digest-Manifest记录了整个MANIFEST.MF文件的数据摘要的Base64编码。其余的普通属性则和MANIFEST.MF中的属性一一对应，分别记录了对应数据块的数据摘要的Base64编码。这里要注意的是：最后一行的换行符是必不可少，需要参与计算的。</p>
<p>CERT.RSA文件包含了对CERT.SF文件的数字签名和开发者的数字证书。RSA就是计算数字签名使用的非对称加密算法。</p>
<p>整个签名机制的最终产物就是MANIFEST.MF、CERT.SF、CERT.RSA三个文件。</p>
<p>除了CERT.RSA文件，其余两个签名文件其实跟keystore没什么关系，主要是文件自身的摘要及二次摘要，用不同的keystore进行签名，生成的MANIFEST.MF与CERT.SF都是一样的，不同的只有CERT.RSA签名文件。也就是说前两者主要保证各个文件的完整性，CERT.RSA从整体上保证APK的来源及完整性，不过META_INF中的文件不在校验范围中，这也是V1的一个缺点。</p>
<p>签名流程可查看源码：<a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/build/+/7e447ed/tools/signapk/SignApk.java">SignApk.java</a></p>
<h3 id="校验流程"><a href="#校验流程" class="headerlink" title="校验流程"></a>校验流程</h3><p>V1签名是怎么保证APK文件不被篡改的？ </p>
<ul>
<li>首先，如果破坏者修改了APK中的任何文件，那么被篡改文件的数据摘要的Base64编码就和MANIFEST.MF文件的记录值不一致，导致校验失败。</li>
<li>其次，如果破坏者同时修改了对应文件在MANIFEST.MF文件中的Base64值，那么MANIFEST.MF中对应数据块的Base64值就和CERT.SF文件中的记录值不一致，导致校验失败。</li>
<li>最后，如果破坏者更进一步，同时修改了对应文件在CERT.SF文件中的Base64值，那么CERT.SF的数字签名就和CERT.RSA记录的签名不一致，也会校验失败。</li>
<li>理论上不可能继续伪造CERT.SF的数字签名，因为破坏者没有开发者的私钥，但是可以重新签名。</li>
</ul>
<h2 id="v2方案-apksigner"><a href="#v2方案-apksigner" class="headerlink" title="v2方案(apksigner)"></a>v2方案(apksigner)</h2><h3 id="签名机制-1"><a href="#签名机制-1" class="headerlink" title="签名机制"></a>签名机制</h3><p>APK 签名方案 v2 是一种全文件签名方案，该方案能够发现对 APK 的受保护部分进行的所有更改，从而有助于加快验证速度并增强完整性保证。为了保持与 v1 APK 格式向后兼容，v2 及更高版本的 APK 签名会存储在“APK 签名分块”内，该分块是为了支持 APK 签名方案 v2 而引入的一个新容器。在 APK 文件中，“APK 签名分块”位于“ZIP 中央目录”（位于文件末尾）之前并紧邻该部分。</p>
<img src="签名前和签名后的APK.png"/>

<p>APK 签名方案 v2 是在 Android 7.0 (Nougat) 中引入的。为了使 APK 可在 Android 6.0 (Marshmallow) 及更低版本的设备上安装，应先使用 JAR 签名功能对 APK 进行签名，然后再使用 v2 方案对其进行签名。</p>
<p>为了保护 APK 内容，APK 包含以下 4 个部分：</p>
<ol>
<li>ZIP 条目的内容（从偏移量 0 处开始一直到“APK 签名分块”的起始位置）</li>
<li>APK 签名分块</li>
<li>ZIP 中央目录</li>
<li>ZIP 中央目录结尾</li>
</ol>
<p>V2签名同时修改了EOCD中的中央目录的偏移量，使签名后的APK还符合ZIP结构。</p>
<p>V2签名块的生成可参考<a target="_blank" rel="noopener" href="https://android.googlesource.com/platform/build/+/dd910c5/tools/signapk/src/com/android/signapk/ApkSignerV2.java">ApkSignerV2</a></p>
<ol>
<li>首先，根据多个签名算法，计算出整个APK的数据摘要，组成APK数据摘要集；</li>
<li>接着，把数据摘要、数字证书和额外属性组装起来，形成类似于V1签名的“MF”文件；</li>
<li>其次，再用相同的私钥，不同的签名算法，计算出“MF”文件的数字签名，形成类似于V1签名的“SF”文件；</li>
<li>然后，把第二列的类似MF文件、类似SF文件和开发者公钥一起组装成通过单个keystore签名后的v2签名块；</li>
<li>最后，把多个keystore签名后的签名块组装起来，就是完整的V2签名块了（Android中允许使用多个keystore对apk进行签名）。</li>
</ol>
<h3 id="验证流程"><a href="#验证流程" class="headerlink" title="验证流程"></a>验证流程</h3><p>APK 签名方案 v2 负责保护第 1、3、4 部分的完整性，以及第 2 部分包含的“APK 签名方案 v2 分块”中的 signed data 分块的完整性。第 1、3 和 4 部分的完整性通过其内容的一个或多个摘要来保护，这些摘要存储在 signed data 分块中，而这些分块则通过一个或多个签名来保护。</p>
<p>V1签名是怎么保证APK文件不被篡改的？ </p>
<ul>
<li>首先，如果破坏者修改了APK文件的任何部分（签名块本身除外），那么APK的数据摘要就和“MF”数据块中记录的数据摘要不一致，导致校验失败。</li>
<li>其次，如果破坏者同时修改了“MF”数据块中的数据摘要，那么“MF”数据块的数字签名就和“SF”数据块中记录的数字签名不一致，导致校验失败。</li>
<li>然后，如果破坏者使用自己的私钥去加密生成“SF”数据块，那么使用开发者的公钥去解密“SF”数据块中的数字签名就会失败。</li>
<li>最后，更进一步，若破坏者甚至替换了开发者公钥，那么使用数字证书中的公钥校验签名块中的公钥就会失败，这也正是数字证书的作用。</li>
</ul>
<h2 id="v3方案-apksigner"><a href="#v3方案-apksigner" class="headerlink" title="v3方案(apksigner)"></a>v3方案(apksigner)</h2><p>Android 9 新增了对 APK Signature Scheme v3 的支持。该架构提供的选择可以在其签名块中为每个签名证书加入一条轮转证据记录。 利用此功能，应用可以通过将 APK 文件过去的签名证书链接到现在签署应用时使用的证书，从而使用新签名证书来签署应用。</p>
<p>Android 9 支持 APK 密钥轮转，这使应用能够在 APK 更新过程中更改其签名密钥。为了实现轮转，APK 必须指示新旧签名密钥之间的信任级别。为了支持密钥轮转，我们将 APK 签名方案从 v2 更新为 v3，以允许使用新旧密钥。v3 在 APK 签名分块中添加了有关受支持的 SDK 版本和 proof-of-rotation 结构的信息。</p>
<p>为了保持与 v1 APK 格式向后兼容，v2 和 v3 APK 签名存储在“APK 签名分块”内紧邻 ZIP Central Directory 前面。v3 APK 签名分块的格式与 v2 相同。</p>
<h2 id="配置调试的Debug包apk可安装"><a href="#配置调试的Debug包apk可安装" class="headerlink" title="配置调试的Debug包apk可安装"></a>配置调试的Debug包apk可安装</h2><p>Android Studio 3.0会在debug apk的配置文件application标签里自动添加 android:testOnly=”true”属性，导致IDE中run跑出的apk无法安装，只能用于as测试安装。</p>
<p>解决办法：在gradle.properties(项目根目录或者gradle全局配置目录 ~/.gradle/)文件中添加<code>android.injected.testOnly=false</code> 之后就可以安装了。</p>
<h1 id="证书和密钥库"><a href="#证书和密钥库" class="headerlink" title="证书和密钥库"></a>证书和密钥库</h1><p>Keystore 称为密钥库，一个keystore里面可以放多组秘钥，每组密钥都有有效期、地址、公司等信息，可以通过别名来进行区分拿取。开发者将录入自己信息的秘钥（而非秘钥库Keystore）存入APP中，以认证此APP为自己开发。</p>
<p>Eclipse或Android Studio在Debug时,对App签名都会使用一个默认的密钥库:~/.android/debug.keystore</p>
<ul>
<li>密钥库名:   debug.keystore</li>
<li>密钥别名:   androiddebugkey</li>
<li>密钥库密码: android</li>
</ul>
<p>由于调试证书是由构建工具创建并且设计上不安全，因此大多数应用商店（包括 Google Play 商店）都不接受使用调试证书签署发布的 APK 或应用软件包。</p>
<h1 id="数据摘要、数字签名和数字证书"><a href="#数据摘要、数字签名和数字证书" class="headerlink" title="数据摘要、数字签名和数字证书"></a>数据摘要、数字签名和数字证书</h1><h2 id="数据摘要"><a href="#数据摘要" class="headerlink" title="数据摘要"></a>数据摘要</h2><p>数据摘要算法是一种能产生特定输出格式的算法，其原理是根据一定的运算规则对原始数据进行某种形式的信息提取，被提取出的信息就是原始数据的消息摘要，也称为数据指纹。 一般情况下，数据摘要算法具有以下特点：</p>
<ol>
<li>无论输入数据有多大（长），计算出来的数据摘要的长度总是固定的。例如：MD5算法计算出的数据摘要有128Bit。</li>
<li>一般情况下（不考虑碰撞的情况下），只要原始数据不同，那么其对应的数据摘要就不会相同。同时，只要原始数据有任何改动，那么其数据摘要也会完全不同。即：相同的原始数据必有相同的数据摘要，不同的原始数据，其数据摘要也必然不同。</li>
<li>不可逆性，即只能正向提取原始数据的数据摘要，而无法从数据摘要中恢复出原始数据。</li>
</ol>
<p>著名的摘要算法有RSA公司的MD5算法和SHA系列算法。</p>
<h2 id="数字签名和数字证书"><a href="#数字签名和数字证书" class="headerlink" title="数字签名和数字证书"></a>数字签名和数字证书</h2><p>数字签名和数字证书是成对出现的，两者不可分离（数字签名主要用来校验数据的完整性，数字证书主要用来确保公钥的安全发放）。</p>
<p>要明白数字签名的概念，必须要了解数据的加密、传输和校验流程。一般情况下，要实现数据的可靠通信，需要解决以下两个问题：</p>
<ol>
<li>确定数据的来源是其真正的发送者。</li>
<li>确保数据在传输过程中，没有被篡改，或者若被篡改了，可以及时发现。</li>
</ol>
<p>而数字签名，就是为了解决这两个问题而诞生的。 首先，数据的发送者需要先申请一对公私钥对，并将公钥交给数据接收者。 然后，若数据发送者需要发送数据给接收者，则首先要根据原始数据，生成一份数字签名，然后把原始数据和数字签名一起发送给接收者。 数字签名由以下两步计算得来：</p>
<ol>
<li>计算发送数据的数据摘要</li>
<li>用私钥对提取的数据摘要进行加密</li>
</ol>
<p>这样，数据接收者拿到的消息就包含了两块内容：</p>
<ol>
<li>原始数据内容</li>
<li>附加的数字签名</li>
</ol>
<p>接下来，接收者就会通过以下几步，校验数据的真实性：</p>
<ol>
<li>用相同的摘要算法计算出原始数据的数据摘要。</li>
<li>用预先得到的公钥解密数字签名。</li>
<li>对比签名得到的数据是否一致，如果一致，则说明数据没有被篡改，否则数据就是脏数据了。</li>
</ol>
<p>因为私钥只有发送者才有，所以其他人无法伪造数字签名。这样通过数字签名就确保了数据的可靠传输。 综上所述，数字签名就是只有发送者才能产生的别人无法伪造的一段数字串，这段数字串同时也是对发送者发送数据真实性的一个有效证明。</p>
<p>想法虽好，但是上面的整个流程，有一个前提，就是数据接收者能够正确拿到发送者的公钥。如果接收者拿到的公钥被篡改了，那么坏人就会被当成好人，而真正的数据发送者发送的数据则会被视作脏数据。那怎么才能保证公钥的安全性那？这就要靠数字证书来解决了。</p>
<p>数字证书是由有公信力的证书中心（CA）颁发给申请者的证书，主要包含了：证书的发布机构、证书的有效期、申请者的公钥、申请者信息、数字签名使用的算法，以及证书内容的数字签名。</p>
<p>可见，数字证书也用到了数字签名技术。只不过签名的内容是数据发送方的公钥，以及一些其它证书信息。这样数据发送者发送的消息就包含了三部分内容：</p>
<ol>
<li>原始数据内容</li>
<li>附加的数字签名</li>
<li>申请的数字证书。</li>
</ol>
<p>接收者拿到数据后，首先会根据CA的公钥，解码出发送者的公钥。然后就与上面的校验流程完全相同了。</p>
<p>所以，数字证书主要解决了公钥的安全发放问题。</p>
<h1 id="密钥管理"><a href="#密钥管理" class="headerlink" title="密钥管理"></a>密钥管理</h1><p>如果准备自行创建密钥和密钥库，请确保先为密钥库选择一个强密码，然后为密钥库中存储的每个私钥选择一个单独的强密码，且必须为密钥库存放在一个可靠的地方。</p>
<h1 id="签名步骤"><a href="#签名步骤" class="headerlink" title="签名步骤"></a>签名步骤</h1><h2 id="1-生成密钥对"><a href="#1-生成密钥对" class="headerlink" title="1. 生成密钥对"></a>1. 生成密钥对</h2><ol>
<li><p>生成密钥对</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkeypair -keystore 密钥库名 -alias 密钥别名 -validity 天数 -keyalg RSA</span><br><span class="line"></span><br><span class="line">参数:</span><br><span class="line">-genkeypair  生成一条密钥对(由私钥和公钥组成)</span><br><span class="line">-keystore    密钥库名字以及存储位置(默认当前目录)</span><br><span class="line">-alias       密钥对的别名(密钥库可以存在多个密钥对,用于区分不同密钥对)</span><br><span class="line">-validity    密钥对的有效期(单位: 天)</span><br><span class="line">-keyalg      生成密钥对的算法(常用RSA/DSA,DSA只用于签名,默认采用DSA)</span><br><span class="line">-delete      删除一条密钥</span><br></pre></td></tr></table></figure>

<p> 提示: 可重复使用此条命令,在同一密钥库中创建多条密钥对，例如，在debug.keystore中新增一对密钥,别名是release：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkeypair -keystore debug.keystore -alias release -validity 30000</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看密钥库</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">keytool -list -v -keystore 密钥库名</span><br><span class="line"></span><br><span class="line">参数:</span><br><span class="line">-list 查看密钥列表</span><br><span class="line">-v    查看密钥详情</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="2-签名"><a href="#2-签名" class="headerlink" title="2. 签名"></a>2. 签名</h2><h3 id="zipalign"><a href="#zipalign" class="headerlink" title="zipalign"></a>zipalign</h3><p>位于Android SDK/build-tools/SDK版本/下，zipalign是对zip包对齐的工具,使APK包内未压缩的数据有序排列对齐,从而减少APP运行时内存消耗。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zipalign -v 4 in.apk out.apk   # 4字节对齐优化</span><br><span class="line">zipalign -c -v 4 in.apk        # 检查APK是否对齐</span><br></pre></td></tr></table></figure>

<p>zipalign可以在V1签名后执行，但zipalign不能在V2签名后执行,只能在V2签名之前执行。</p>
<h3 id="jarsigner"><a href="#jarsigner" class="headerlink" title="jarsigner"></a>jarsigner</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jarsigner -keystore 密钥库名 xxx.apk 密钥别名</span><br></pre></td></tr></table></figure>

<p>从JDK7开始, jarsigner默认算法是SHA256, 但Android 4.2以下不支持该算法,所以需要修改算法, 添加参数<code>-digestalg SHA1 -sigalg SHA1withRSA</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">jarsigner -keystore 密钥库名 -digestalg SHA1 -sigalg SHA1withRSA xxx.apk 密钥别名</span><br><span class="line"></span><br><span class="line">参数:</span><br><span class="line">    -digestalg  摘要算法</span><br><span class="line">    -sigalg     签名算法</span><br></pre></td></tr></table></figure>

<h3 id="apksigner"><a href="#apksigner" class="headerlink" title="apksigner"></a>apksigner</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apksigner sign --ks 密钥库名 --ks-key-alias 密钥别名 xxx.apk</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 若密钥库中有多个密钥对,则必须指定密钥别名</span></span><br><span class="line">apksigner sign --ks 密钥库名 --ks-key-alias 密钥别名 xxx.apk</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 禁用V2签名</span></span><br><span class="line">apksigner sign --v2-signing-enabled false --ks 密钥库名 xxx.apk</span><br><span class="line"></span><br><span class="line">参数:</span><br><span class="line">    --ks-key-alias       密钥别名,若密钥库有一个密钥对,则可省略,反之必选</span><br><span class="line">    --v1-signing-enabled 是否开启V1签名,默认开启</span><br><span class="line">    --v2-signing-enabled 是否开启V2签名,默认开启</span><br></pre></td></tr></table></figure>

<h2 id="3-签名验证"><a href="#3-签名验证" class="headerlink" title="3. 签名验证"></a>3. 签名验证</h2><h3 id="keytool-只支持V1签名校验"><a href="#keytool-只支持V1签名校验" class="headerlink" title="keytool,只支持V1签名校验"></a>keytool,只支持V1签名校验</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">keytool -printcert -jarfile MyApp.apk (显示签名证书信息)</span><br><span class="line"></span><br><span class="line">参数:</span><br><span class="line">    -printcert           打印证书内容</span><br><span class="line">    -jarfile &lt;filename&gt;  已签名的jar文件 或apk文件   </span><br></pre></td></tr></table></figure>

<h3 id="apksigner-支持V1和V2签名校验"><a href="#apksigner-支持V1和V2签名校验" class="headerlink" title="apksigner,支持V1和V2签名校验"></a>apksigner,支持V1和V2签名校验</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apksigner verify -v --print-certs xxx.apk</span><br><span class="line"></span><br><span class="line">参数:</span><br><span class="line">    -v, --verbose 显示详情(显示是否使用V1和V2签名)</span><br><span class="line">    --print-certs 显示签名证书信息</span><br></pre></td></tr></table></figure>

<h1 id="Gradle签名发布"><a href="#Gradle签名发布" class="headerlink" title="Gradle签名发布"></a>Gradle签名发布</h1><p>可以使用Android Studio工具配置KeyStore相关的配置，会自动在build.gradle文件中生成配置。</p>
<ol>
<li><p>通过keytool生成签名文件</p>
</li>
<li><p>配置build.gradle</p>
 <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    signingConfigs &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            storeFile file(<span class="string">&quot;path/release.keystore&quot;</span>)</span><br><span class="line">            storePassword <span class="string">&quot;123456&quot;</span></span><br><span class="line">            keyAlias <span class="string">&quot;release.keystore&quot;</span></span><br><span class="line">            keyPassword <span class="string">&quot;123456&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        debug &#123;</span><br><span class="line">            storeFile file(<span class="string">&quot;path/test.keystore&quot;</span>)</span><br><span class="line">            storePassword <span class="string">&quot;123456&quot;</span></span><br><span class="line">            keyAlias <span class="string">&quot;test.keystore&quot;</span></span><br><span class="line">            keyPassword <span class="string">&quot;123456&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled enableProguardInReleaseBuilds</span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">&quot;proguard-android.txt&quot;</span>), <span class="string">&quot;proguard-rules.pro&quot;</span></span><br><span class="line">            signingConfig signingConfigs.release</span><br><span class="line"></span><br><span class="line">            android.applicationVariants.all &#123; variant -&gt;</span><br><span class="line">                variant.outputs.all &#123;</span><br><span class="line">                    <span class="keyword">if</span> (variant.buildType.name.equals(<span class="string">&#x27;release&#x27;</span>)) &#123;</span><br><span class="line">                        outputFileName = <span class="string">&quot;SecureMail$&#123;defaultConfig.versionName&#125;-$&#123;releaseTime()&#125;.apk&quot;</span></span><br><span class="line">                        variant.getPackageApplication().outputDirectory = <span class="keyword">new</span> File(</span><br><span class="line">                            project.rootDir.absolutePath + <span class="string">&quot;/app/release&quot;</span>)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    flavorDimensions <span class="string">&quot;version&quot;</span></span><br><span class="line">    productFlavors &#123;</span><br><span class="line">        hearing &#123;</span><br><span class="line">            dimension <span class="string">&quot;version&quot;</span></span><br><span class="line">            signingConfig signingConfigs.release</span><br><span class="line">        &#125;</span><br><span class="line">        full &#123;</span><br><span class="line">            dimension <span class="string">&quot;version&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">def</span> releaseTime() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Date().format(<span class="string">&quot;yyyy-MM-dd&quot;</span>, TimeZone.getTimeZone(<span class="string">&quot;UTC&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行打包命令</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./gradlew assemblerelease</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>注意：可以在根目录的gradle.properties文件中配置签名相关的变量，在build.gradle中直接引入即可。</p>
<h1 id="多渠道打包方案"><a href="#多渠道打包方案" class="headerlink" title="多渠道打包方案"></a>多渠道打包方案</h1><h2 id="Android-Gradle-Plugin"><a href="#Android-Gradle-Plugin" class="headerlink" title="Android Gradle Plugin"></a>Android Gradle Plugin</h2><p>Gradle Plugin本身提供了多渠道的打包策略： 首先，在AndroidManifest.xml中添加渠道信息占位符：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;InstallChannel&quot;</span> <span class="attr">android:value</span>=<span class="string">&quot;$&#123;InstallChannel&#125;&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后，通过Gradle Plugin提供的productFlavors标签，添加渠道信息：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">productFlavors&#123;</span><br><span class="line">    <span class="string">&quot;YingYongBao&quot;</span>&#123;</span><br><span class="line">        manifestPlaceholders = [<span class="attr">InstallChannel :</span> <span class="string">&quot;YingYongBao&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">&quot;360&quot;</span>&#123;</span><br><span class="line">        manifestPlaceholders = [<span class="attr">InstallChannel :</span> <span class="string">&quot;360&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，Gradle编译生成多渠道包时，会用不同的渠道信息替换AndroidManifest.xml中的占位符。我们在代码中，也就可以直接读取AndroidManifest.xml中的渠道信息了。</p>
<p>但是，这种方式存在一些缺点：</p>
<ol>
<li>每生成一个渠道包，都要重新执行一遍构建流程，效率太低，只适用于渠道较少的场景。</li>
<li>Gradle会为每个渠道包生成一个不同的BuildConfig.java类，记录渠道信息，导致每个渠道包的DEX的CRC值都不同。一般情况下，这是没有影响的。但是如果你使用了微信的Tinker热补丁方案，那么就需要为不同的渠道包打不同的补丁，这完全是不可以接受的。（因为Tinker是通过对比基础包APK和新包APK生成差分补丁，然后再把补丁和基础包APK一起合成新包APK。这就要求用于生成差分补丁的基础包DEX和用于合成新包的基础包DEX是完全一致的，即：每一个基础渠道包的DEX文件是完全一致的，不然就会合成失败）</li>
</ol>
<h2 id="ApkTool"><a href="#ApkTool" class="headerlink" title="ApkTool"></a>ApkTool</h2><p>ApkTool是一个逆向分析工具，可以把APK解开，添加代码后，重新打包成APK。因此，基于ApkTool的多渠道打包方案分为以下几步：</p>
<ol>
<li>复制一份新的APK</li>
<li>通过ApkTool工具，解压APK（apktool d origin.apk）</li>
<li>删除已有签名信息</li>
<li>添加渠道信息（可以在APK的任何文件添加渠道信息）</li>
<li>通过ApkTool工具，重新打包生成新APK（apktool b newApkDir）</li>
<li>重新签名</li>
</ol>
<p>优点： 不需要重新构建新渠道包，仅需要复制修改就可以了。并且因为是重新签名，所以同时支持V1和V2签名。</p>
<p>缺点：</p>
<ul>
<li>ApkTool工具不稳定，曾经遇到过升级Gradle Plugin版本后，低版本ApkTool解压APK失败的情况。</li>
<li>生成新渠道包时，需要重新解包、打包和签名，而这几步操作又是相对比较耗时的。经过测试：生成企鹅电竞10个渠道包需要16分钟左右，虽然比Gradle Plugin方案减少很多耗时。但是若需要同时生成上百个渠道包，则需要几个小时，显然不适合渠道非常多的业务场景。</li>
</ul>
<h2 id="VasDolly"><a href="#VasDolly" class="headerlink" title="VasDolly"></a>VasDolly</h2><h1 id="VasDolly实现原理"><a href="#VasDolly实现原理" class="headerlink" title="VasDolly实现原理"></a>VasDolly实现原理</h1><h2 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h2><p>众所周知，因为国内Android应用分发市场的现状，我们在发布APP时，一般需要生成多个渠道包，上传到不同的应用市场。这些渠道包需要包含不同的渠道信息，在APP和后台交互或者数据上报时，会带上各自的渠道信息。这样，我们就能统计到每个分发市场的下载数、用户数等关键数据。</p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/ljd1996/VasDolly">VasDolly</a></p>
<p>VasDolly是一种快速多渠道打包工具，同时支持基于V1签名和V2签名进行多渠道打包。插件本身会自动检测Apk使用的签名类别，并选择合适的多渠道打包方式，对使用者来说完全透明。</p>
<h2 id="基于V1签名的多渠道打包方案"><a href="#基于V1签名的多渠道打包方案" class="headerlink" title="基于V1签名的多渠道打包方案"></a>基于V1签名的多渠道打包方案</h2><p>根据之前的V1签名和校验机制可知，V1签名只会检验第一部分的所有压缩文件，而不理会后两部分内容。因此，只要把渠道信息写入到后两块内容就可以通过V1校验，而EOCD的注释字段无疑是最好的选择。</p>
<p>在APK文件的注释字段，添加渠道信息。 整个方案包括以下几步：</p>
<ol>
<li>复制APK</li>
<li>找到EOCD数据块</li>
<li>修改注释长度</li>
<li>添加渠道信息</li>
<li>添加渠道信息长度</li>
<li>添加魔数：方便从后向前读取数据，定位渠道信息。</li>
</ol>
<p>该方案的最大优点就是：不需要解压缩APK，不需要重新签名，只需要复制APK，在注释字段添加渠道信息。每个渠道包仅需几秒的耗时，非常适合渠道较多的APK。</p>
<h2 id="基于V2签名的多渠道打包方案"><a href="#基于V2签名的多渠道打包方案" class="headerlink" title="基于V2签名的多渠道打包方案"></a>基于V2签名的多渠道打包方案</h2><p>V2签名块中的数据摘要是针对APK的文件内容块、中央目录和EOCD三块内容计算的。但是在写入签名块后，修改了EOCD中的中央目录偏移量，那么在进行V2签名校验时，理论上在“数据摘要校验”这步应该会校验失败。</p>
<p>Android系统在校验APK的数据摘要时，首先会把EOCD的中央目录偏移量替换成签名块的偏移量，然后再计算数据摘要。而签名块的偏移量就是v2签名之前的中央目录偏移量，因此，这样计算出的数据摘要就和“MF”数据块中的数据摘要完全一致了。</p>
<p>Android系统只会关注ID为0x7109871a的V2签名块，并且忽略其他的ID-Value，同时V2签名只会保护APK本身，不包含签名块。因此，基于V2签名的多渠道打包方案就应运而生：在APK签名块中添加一个ID-Value，存储渠道信息。整个方案包括以下几步：</p>
<ol>
<li>找到APK的EOCD块</li>
<li>找到APK签名块</li>
<li>获取已有的ID-Value Pair</li>
<li>添加包含渠道信息的ID-Value</li>
<li>基于所有的ID-Value生成新的签名块</li>
<li>修改EOCD的中央目录的偏移量（上面已介绍过：修改EOCD的中央目录偏移量，不会导致数据摘要校验失败）</li>
<li>用新的签名块替代旧的签名块，生成带有渠道信息的APK</li>
</ol>
<h2 id="多渠道包的强校验"><a href="#多渠道包的强校验" class="headerlink" title="多渠道包的强校验"></a>多渠道包的强校验</h2><p>那么如何保证通过这些方案生成的渠道包，能够在所有Android平台上正确安装那？</p>
<p>Google提供了一个同时支持V1和V2签名和校验的工具：apksig。它包括一个apksigner命令行和一个apksig类库。其中前者就是Android SDK build-tools下面的命令行工具。正是借助后面的apksig来进行渠道包强校验，它可以保证渠道包在apk Minsdk ~ 最高版本之间都校验通过。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/21/Android-Gradle%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/21/Android-Gradle%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Android-Gradle笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-08-21 21:33:11" itemprop="dateCreated datePublished" datetime="2019-08-21T21:33:11+08:00">2019-08-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/Gradle/" itemprop="url" rel="index"><span itemprop="name">Gradle</span></a>
                </span>
            </span>

          
            <span id="/2019/08/21/Android-Gradle%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="Android-Gradle笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/08/21/Android-Gradle%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/08/21/Android-Gradle%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><h2 id="构建流程"><a href="#构建流程" class="headerlink" title="构建流程"></a>构建流程</h2><img src="构建流程.png" width="70%"/>

<img src="Android Build Process.png"/>

<p>典型 Android 应用模块的构建流程通常依循下列步骤：</p>
<ol>
<li>编译器将您的源代码转换成 DEX（Dalvik Executable) 文件（其中包括 Android 设备上运行的字节码），将所有其他内容转换成已编译资源。</li>
<li>APK 打包器将 DEX 文件和已编译资源合并成单个 APK。 不过，必须先签署 APK，才能将应用安装并部署到 Android 设备上。</li>
<li>APK 打包器使用调试或发布密钥库签署您的 APK：</li>
<li>在生成最终 APK 之前，打包器会使用 zipalign 工具对应用进行优化，减少其在设备上运行时占用的内存。</li>
</ol>
<p>简要步骤：</p>
<ul>
<li><code>Merged Manifest, Merged Resource, Merged Assets --&gt; aapt --&gt; R.java, Compiled Resource</code></li>
<li><code>R.java, Source Code --&gt; Java Compiler --&gt; .class files --&gt; proguard --&gt; proguarded.jar file --&gt; dex --&gt; .dex files</code></li>
<li><code>Compiled Resource, .dex files, .so files... --&gt; apkbuilder --&gt; .apk file --&gt; sign --&gt; sign.apk file --&gt; zipalign</code></li>
</ul>
<h2 id="构建配置文件"><a href="#构建配置文件" class="headerlink" title="构建配置文件"></a>构建配置文件</h2><p>Android Plugin for Gradle 引入了许多 DSL 元素，具体可参考：<a target="_blank" rel="noopener" href="http://google.github.io/android-gradle-dsl/current/index.html">DSL 参考文档</a></p>
<p>settings.gradle 文件位于项目根目录，用于指示 Gradle 在构建应用时应将哪些模块包括在内。对大多数项目而言，该文件很简单，只包括以下内容：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include <span class="string">&#x27;:app&#x27;</span></span><br></pre></td></tr></table></figure>

<p>顶级 build.gradle 文件位于项目根目录，用于定义适用于项目中所有模块的构建配置。 默认情况下，此顶级构建文件使用 buildscript 代码块来定义项目中所有模块共用的 Gradle 存储区和依赖项。 </p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The buildscript block is where you configure the repositories and</span></span><br><span class="line"><span class="comment"> * dependencies for Gradle itself—meaning, you should not include dependencies</span></span><br><span class="line"><span class="comment"> * for your modules here. For example, this block includes the Android plugin for</span></span><br><span class="line"><span class="comment"> * Gradle as a dependency because it provides the additional instructions Gradle</span></span><br><span class="line"><span class="comment"> * needs to build Android app modules.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">buildscript &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The repositories block configures the repositories Gradle uses to</span></span><br><span class="line"><span class="comment">     * search or download the dependencies. Gradle pre-configures support for remote</span></span><br><span class="line"><span class="comment">     * repositories such as JCenter, Maven Central, and Ivy. You can also use local</span></span><br><span class="line"><span class="comment">     * repositories or define your own remote repositories. The code below defines</span></span><br><span class="line"><span class="comment">     * JCenter as the repository Gradle should use to look for its dependencies.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * New projects created using Android Studio 3.0 and higher also include</span></span><br><span class="line"><span class="comment">     * Google&#x27;s Maven repository.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The dependencies block configures the dependencies Gradle needs to use</span></span><br><span class="line"><span class="comment">     * to build your project. The following line adds Android plugin for Gradle</span></span><br><span class="line"><span class="comment">     * version 3.4.2 as a classpath dependency.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">&#x27;com.android.tools.build:gradle:3.4.2&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The allprojects block is where you configure the repositories and</span></span><br><span class="line"><span class="comment"> * dependencies used by all modules in your project, such as third-party plugins</span></span><br><span class="line"><span class="comment"> * or libraries. However, you should configure module-specific dependencies in</span></span><br><span class="line"><span class="comment"> * each module-level build.gradle file. For new projects, Android Studio</span></span><br><span class="line"><span class="comment"> * includes JCenter and Google&#x27;s Maven repository by default, but it does not</span></span><br><span class="line"><span class="comment"> * configure any dependencies (unless you select a template that requires some).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">allprojects &#123;</span><br><span class="line">   repositories &#123;</span><br><span class="line">       google()</span><br><span class="line">       jcenter()</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于包含多个模块的 Android 项目，在项目级别定义某些属性，并在所有模块间共享这些属性可能会非常有用。为此，可以将额外属性添加到顶级 build.gradle 文件的 ext 代码块中。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;...&#125;</span><br><span class="line"></span><br><span class="line">allprojects &#123;...&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This block encapsulates custom properties and makes them available to all</span></span><br><span class="line"><span class="comment">// modules in the project.</span></span><br><span class="line">ext &#123;</span><br><span class="line">    <span class="comment">// The following are only a few examples of the types of properties you can define.</span></span><br><span class="line">    compileSdkVersion = <span class="number">28</span></span><br><span class="line">    <span class="comment">// You can also create properties to specify versions for dependencies.</span></span><br><span class="line">    <span class="comment">// Having consistent versions between modules can avoid conflicts with behavior.</span></span><br><span class="line">    supportLibVersion = <span class="string">&quot;28.0.0&quot;</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要从相同项目中的模块访问这些属性，在模块的 build.gradle 文件中使用以下语法（虽然 Gradle 可在模块级别定义项目范围的属性，但应避免这样做，因为这样会导致共享这些属性的模块进行耦合）。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">  <span class="comment">// Use the following syntax to access properties you defined at the project level:</span></span><br><span class="line">  <span class="comment">// rootProject.ext.property_name</span></span><br><span class="line">  compileSdkVersion rootProject.ext.compileSdkVersion</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation <span class="string">&quot;com.android.support:appcompat-v7:$&#123;rootProject.ext.supportLibVersion&#125;&quot;</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>模块级 build.gradle 文件位于各 project/module/ 目录中，用于配置适用于其所在模块的构建设置。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The first line in the build configuration applies the Android plugin for</span></span><br><span class="line"><span class="comment"> * Gradle to this build and makes the android block available to specify</span></span><br><span class="line"><span class="comment"> * Android-specific build options.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">&#x27;com.android.application&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The android block is where you configure all your Android-specific</span></span><br><span class="line"><span class="comment"> * build options.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * compileSdkVersion specifies the Android API level Gradle should use to</span></span><br><span class="line"><span class="comment">   * compile your app. This means your app can use the API features included in</span></span><br><span class="line"><span class="comment">   * this API level and lower.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  compileSdkVersion <span class="number">28</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * buildToolsVersion specifies the version of the SDK build tools, command-line</span></span><br><span class="line"><span class="comment">   * utilities, and compiler that Gradle should use to build your app. You need to</span></span><br><span class="line"><span class="comment">   * download the build tools using the SDK Manager.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * This property is optional because the plugin uses a recommended version of</span></span><br><span class="line"><span class="comment">   * the build tools by default.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  buildToolsVersion <span class="string">&quot;29.0.0&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The defaultConfig block encapsulates default settings and entries for all</span></span><br><span class="line"><span class="comment">   * build variants, and can override some attributes in main/AndroidManifest.xml</span></span><br><span class="line"><span class="comment">   * dynamically from the build system. You can configure product flavors to override</span></span><br><span class="line"><span class="comment">   * these values for different versions of your app.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  defaultConfig &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * applicationId uniquely identifies the package for publishing.</span></span><br><span class="line"><span class="comment">     * However, your source code should still reference the package name</span></span><br><span class="line"><span class="comment">     * defined by the package attribute in the main/AndroidManifest.xml file.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    applicationId <span class="string">&#x27;com.example.myapp&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Defines the minimum API level required to run the app.</span></span><br><span class="line">    minSdkVersion <span class="number">15</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Specifies the API level used to test the app.</span></span><br><span class="line">    targetSdkVersion <span class="number">28</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Defines the version number of your app.</span></span><br><span class="line">    versionCode <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Defines a user-friendly version name for your app.</span></span><br><span class="line">    versionName <span class="string">&quot;1.0&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The buildTypes block is where you can configure multiple build types.</span></span><br><span class="line"><span class="comment">   * By default, the build system defines two build types: debug and release. The</span></span><br><span class="line"><span class="comment">   * debug build type is not explicitly shown in the default build configuration,</span></span><br><span class="line"><span class="comment">   * but it includes debugging tools and is signed with the debug key. The release</span></span><br><span class="line"><span class="comment">   * build type applies Proguard settings and is not signed by default.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  buildTypes &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * By default, Android Studio configures the release build type to enable code</span></span><br><span class="line"><span class="comment">     * shrinking, using minifyEnabled, and specifies the Proguard settings file.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    release &#123;</span><br><span class="line">        minifyEnabled <span class="literal">true</span> <span class="comment">// Enables code shrinking for the release build type.</span></span><br><span class="line">        proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android.txt&#x27;</span>), <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The productFlavors block is where you can configure multiple product flavors.</span></span><br><span class="line"><span class="comment">   * This allows you to create different versions of your app that can</span></span><br><span class="line"><span class="comment">   * override the defaultConfig block with their own settings. Product flavors</span></span><br><span class="line"><span class="comment">   * are optional, and the build system does not create them by default.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * This example creates a free and paid product flavor. Each product flavor</span></span><br><span class="line"><span class="comment">   * then specifies its own application ID, so that they can exist on the Google</span></span><br><span class="line"><span class="comment">   * Play Store, or an Android device, simultaneously.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * If you declare product flavors, you must also declare flavor dimensions</span></span><br><span class="line"><span class="comment">   * and assign each flavor to a flavor dimension.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  flavorDimensions <span class="string">&quot;tier&quot;</span></span><br><span class="line">  productFlavors &#123;</span><br><span class="line">    free &#123;</span><br><span class="line">      dimension <span class="string">&quot;tier&quot;</span></span><br><span class="line">      applicationId <span class="string">&#x27;com.example.myapp.free&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    paid &#123;</span><br><span class="line">      dimension <span class="string">&quot;tier&quot;</span></span><br><span class="line">      applicationId <span class="string">&#x27;com.example.myapp.paid&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The splits block is where you can configure different APK builds that</span></span><br><span class="line"><span class="comment">   * each contain only code and resources for a supported screen density or</span></span><br><span class="line"><span class="comment">   * ABI. You&#x27;ll also need to configure your build so that each APK has a</span></span><br><span class="line"><span class="comment">   * different versionCode.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  splits &#123;</span><br><span class="line">    <span class="comment">// Settings to build multiple APKs based on screen density.</span></span><br><span class="line">    density &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Enable or disable building multiple APKs.</span></span><br><span class="line">      enable <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Exclude these densities when building multiple APKs.</span></span><br><span class="line">      exclude <span class="string">&quot;ldpi&quot;</span>, <span class="string">&quot;tvdpi&quot;</span>, <span class="string">&quot;xxxhdpi&quot;</span>, <span class="string">&quot;400dpi&quot;</span>, <span class="string">&quot;560dpi&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The dependencies block in the module-level build configuration file</span></span><br><span class="line"><span class="comment"> * specifies dependencies required to build only the module itself.</span></span><br><span class="line"><span class="comment"> * To learn more, go to Add build dependencies.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation project(<span class="string">&quot;:lib&quot;</span>)</span><br><span class="line">    implementation <span class="string">&#x27;com.android.support:appcompat-v7:28.0.0&#x27;</span></span><br><span class="line">    implementation fileTree(<span class="attr">dir:</span> <span class="string">&#x27;libs&#x27;</span>, <span class="attr">include:</span> [<span class="string">&#x27;*.jar&#x27;</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Gradle 还包括两个属性文件，均位于项目根目录中，可用于指定适用于 Gradle 构建工具包本身的设置：</p>
<ul>
<li>gradle.properties：可以在其中配置项目范围 Gradle 设置，例如 Gradle 后台进程的最大堆大小。 如需了解详细信息，请参阅构建环境。</li>
<li>local.properties：为构建系统配置本地环境属性，例如 SDK 安装路径。由于该文件的内容由 Android Studio 自动生成并且专用于本地开发者环境，因此不应手动修改该文件，或将其纳入版本控制系统。</li>
</ul>
<p>Android Studio 按逻辑关系将每个模块的源代码和资源分组为源集。模块的 main/ 源集包括其所有构建变体使用的代码和资源。其他源集目录为可选项，在配置新的构建变体时，Android Studio 不会自动为您创建这些目录。不过，创建类似于 main/ 的源集有助于让 Gradle 仅在构建特定应用版本时才应使用的文件和资源井然有序：</p>
<ul>
<li>src/main/：此源集包括所有构建变体共用的代码和资源。</li>
<li>src/buildType/：创建此源集可加入特定构建类型专用的代码和资源。</li>
<li>src/productFlavor/：创建此源集可加入特定产品风格专用的代码和资源。（注：如果配置构建以组合多个产品风格，则可为风格维度间产品风格的各个组合创建源集目录： src/productFlavor1ProductFlavor2/）</li>
<li>src/productFlavorBuildType/：创建此源集可加入特定构建变体专用的代码和资源。</li>
</ul>
<p>例如，要生成应用的“完整调试”版本，构建系统需要合并来自以下源集的代码、设置和资源：</p>
<ul>
<li>src/fullDebug/（构建变体源集）</li>
<li>src/debug/（构建类型源集）</li>
<li>src/full/（产品风格源集）</li>
<li>src/main/（主源集）</li>
</ul>
<p>注：当在 Android Studio 中使用 File &gt; New 菜单选项新建文件或目录时，可以针对特定源集进行创建。 可供您选择的源集取决于您的构建配置，如果所需目录尚不存在，Android Studio 会自动创建。</p>
<p>如果不同源集包含同一文件的不同版本，Gradle 将按以下优先顺序决定使用哪一个文件（左侧源集替换右侧源集的文件和设置）：</p>
<ul>
<li>构建变体 &gt; 构建类型 &gt; 产品风格 &gt; 主源集 &gt; 库依赖项</li>
</ul>
<p>这样一来，Gradle 便可使用专用于您试图构建的构建变体的文件，同时对与其他应用版本共用的 Activity、应用逻辑和资源加以重复利用。 在合并多个清单时，Gradle 使用同一优先顺序，这样每个构建变体都能在最终清单中定义不同的组件或权限。 </p>
<p>android对象为我们提供了3个属性：</p>
<ul>
<li>applicationVariants (仅仅适用于Android应用Gradle插件)</li>
<li>libraryVariants (仅仅适用于Android库Gradle插件)</li>
<li>testVariants (以上两种Gradle插件都使用)</li>
</ul>
<h1 id="SDK-Version"><a href="#SDK-Version" class="headerlink" title="SDK Version"></a>SDK Version</h1><h2 id="compileSdkVersion"><a href="#compileSdkVersion" class="headerlink" title="compileSdkVersion"></a>compileSdkVersion</h2><p>compileSdkVersion仅仅是告诉Gradle使用哪个版本的SDK编译应用，不会被包含到apk中，完全不影响应用的运行结果，关注compileSdkVersion版本的原因：</p>
<ul>
<li>应用想兼容新版本、使用了新版本API，此时就必须使用新版本及以上版本编译，否则就会编译报错；</li>
<li>如果使用了新版本的Support Library，此时也必须使用新版本及以上版本编译；</li>
<li>推荐使用最新版本编译，用新的编译检查，可以看到很多新版本相关的警告，提前预研新版本开发；</li>
</ul>
<h2 id="minSdkVersion"><a href="#minSdkVersion" class="headerlink" title="minSdkVersion"></a>minSdkVersion</h2><ol>
<li>minSdkVersion表明此应用兼容的最低版本，在低于该版本的手机上安装时会报错，无法安装；</li>
<li>如果最低版本设置为19，在代码中使用了API 23中的API，就会有警告。使用运行时检查系统版本的方式可解决；</li>
<li>如果使用的某个Support Library的最低版本为7，那minSdkVersion就必须大于等于7了，否则该Support Library在低于7的手机中就要报错了。</li>
</ol>
<h2 id="targetSdkVersion"><a href="#targetSdkVersion" class="headerlink" title="targetSdkVersion"></a>targetSdkVersion</h2><ol>
<li>如果targetSdkVersion为19（对应为Android4.4），应用运行时，最高只能使用API 19的新特性。即使代码中使用了API 23的新特性，实际运行时，也不会使用该新特性；</li>
<li>同样的API，比如AlarmManger的set()和get()方法，在API 19和之前的效果是不一样的，如果targetSdkVersion为18，无论运行手机是什么版本，都是旧效果；如果targetSdkVersion为19，那么在4.4以上的手机上运行时，就是新效果了。</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>综上所诉，compileSdkVersion决定了编译期间能否使用新版本的API。targetSDKVersion决定了运行期间使用哪种特性。建议用较低的minSdkVersion来覆盖最大的人群，用最新的compileSdkVersion和targetSDKVersion来获得最好的外观和行为。即：maxSdkVersion &gt;= buildToolsVersion &gt;= compileSdkVersion&gt;= targetSdkVersion &gt;= minSdkVersion</p>
<h1 id="Set-the-Application-ID"><a href="#Set-the-Application-ID" class="headerlink" title="Set the Application ID"></a>Set the Application ID</h1><h2 id="设置Application-ID"><a href="#设置Application-ID" class="headerlink" title="设置Application ID"></a>设置Application ID</h2><p>应用 ID 通过模块的 build.gradle 文件中的 applicationId 属性定义，如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId <span class="string">&quot;com.example.myapp&quot;</span></span><br><span class="line">        minSdkVersion <span class="number">15</span></span><br><span class="line">        targetSdkVersion <span class="number">24</span></span><br><span class="line">        versionCode <span class="number">1</span></span><br><span class="line">        versionName <span class="string">&quot;1.0&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>应用 ID 和软件包名称彼此无关，可以更改代码的软件包名称（代码命名空间），这不会影响应用 ID，反之亦然。Application ID的命名规则的限制：</p>
<ul>
<li>必须至少包含两段（一个或多个圆点）。</li>
<li>每段必须以字母开头。</li>
<li>所有字符必须为字母数字或下划线 [a-zA-Z0-9_]。</li>
</ul>
<p>注意：</p>
<ul>
<li>应用 ID 过去直接关联到代码的软件包名称；所以，有些 Android API 会在其方法名称和参数名称中使用“package name”一词，但这实际上是Application ID。例如，Context.getPackageName() 方法会返回您的应用 ID。</li>
<li>使用 WebView的话，Application ID 中应将软件包名称用作前缀；否则，可能会遇到如<a target="_blank" rel="noopener" href="https://code.google.com/p/android/issues/detail?id=211768&hl=zh-CN">问题 211768</a> 中所述的问题。</li>
</ul>
<h2 id="更改用于编译变体的Application-ID"><a href="#更改用于编译变体的Application-ID" class="headerlink" title="更改用于编译变体的Application ID"></a>更改用于编译变体的Application ID</h2><p>每个编译变体应定义为单独的产品特性。对于 productFlavors 块中的每个类型，可以重新定义 applicationId 属性，也可以使用 applicationIdSuffix 在默认的应用 ID 上追加一段，如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId <span class="string">&quot;com.example.myapp&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    productFlavors &#123;</span><br><span class="line">        free &#123;</span><br><span class="line">            applicationIdSuffix <span class="string">&quot;.free&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        pro &#123;</span><br><span class="line">            applicationIdSuffix <span class="string">&quot;.pro&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以根据自己的版本类型使用 applicationIdSuffix 追加一段，如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        debug &#123;</span><br><span class="line">            applicationIdSuffix <span class="string">&quot;.debug&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于 Gradle 会在产品特性后面应用版本类型配置，因此“free debug”编译变体的应用 ID 现在是“com.example.myapp.free.debug”。</p>
<p>注意：</p>
<ul>
<li>为了与以前的 SDK 工具兼容，如果未在 build.gradle 文件中定义 applicationId 属性，构建工具会将 AndroidManifest.xml 文件中的软件包名称用作应用 ID。在这种情况下，重构软件包名称也会更改您的应用 ID。</li>
<li>如果需要在清单文件中引用应用 ID，可以在任何清单属性中使用 ${applicationId} 占位符。在编译期间，Gradle 会将此标记替换为实际的应用 ID。</li>
</ul>
<h2 id="更改用于测试的应用-ID"><a href="#更改用于测试的应用-ID" class="headerlink" title="更改用于测试的应用 ID"></a>更改用于测试的应用 ID</h2><p>默认情况下，构建工具会将应用 ID 应用到您的测试 APK，该 APK 将应用 ID 用于给定的编译变体，同时追加 .test。例如，com.example.myapp.free 编译变体的测试 APK 的应用 ID 为 com.example.myapp.free.test。</p>
<p>可以通过在 defaultConfig 或 productFlavor 块中定义 testApplicationId 属性来更改应用 ID，不过应该没有必要这样做。</p>
<p>注意：为了避免与受测应用发生名称冲突，构建工具会为您的测试 APK 生成 R 类，其命名空间基于测试应用 ID，而不是清单文件中定义的软件包名称。</p>
<h2 id="更改软件包名称"><a href="#更改软件包名称" class="headerlink" title="更改软件包名称"></a>更改软件包名称</h2><p>默认情况下，项目的软件包名称与应用 ID 匹配，但您可以更改软件包名称。不过，如果您要更改软件包名称，需要注意的是，软件包名称（由项目目录结构定义）应始终与 AndroidManifest.xml 文件中的 package 属性匹配，如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">&quot;com.example.myapp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:versionCode</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:versionName</span>=<span class="string">&quot;1.0&quot;</span> &gt;</span></span><br></pre></td></tr></table></figure>

<p>Android 构建工具使用 package 属性来发挥两种作用：</p>
<ul>
<li>它会将此名称用作应用生成的 R.java 类的命名空间。示例：对于上面的清单，R 类将为 com.example.myapp.R。</li>
<li>它会使用此名称解析清单文件中声明的任何相关类名。示例：对于上面的清单，声明为 <code>&lt;activity android:name=&quot;.MainActivity&quot;&gt;</code> 的 Activity 将解析为 com.example.myapp.MainActivity。</li>
</ul>
<p>因此，package 属性中的名称应始终与项目的基础软件包名称匹配，基础软件包中保存着您的 Activity 及其他应用代码。当然，您的项目中可以包含子软件包，但是这些文件必须从 package 属性导入使用命名空间的 R.java 类，而且清单中声明的任何应用组件都必须添加缺失的子软件包名称（或者使用完全限定软件包名称）。</p>
<p>如果您要完全重构您的软件包名称，请确保也更新 package 属性。只要您使用 Android Studio 的工具重命名和重构您的软件包，那么这些就会自动保持同步。（如果它们未保持同步，您的应用代码将无法解析 R 类，因为它不再位于同一软件包中，并且清单无法识别您的 Activity 或其他组件。）</p>
<p>您必须始终在项目的主 AndroidManifest.xml 文件中指定 package 属性。如果您有其他清单文件（如产品特性或版本类型的清单文件），请注意，优先级最高的清单文件提供的软件包名称始终用于最终合并的清单。</p>
<p>还有一点需要了解：虽然清单 package 和 Gradle applicationId 可以具有不同的名称，但构建工具会在编译结束时将应用 ID 复制到 APK 的最终清单文件中。所以，如果您在编译后检查 AndroidManifest.xml 文件，发现 package 属性发生更改就不足为奇了。实际上，Google Play 商店和 Android 平台会查看 package 属性来识别您的应用。所以，编译系统利用原始值（设置 R 类的命名空间并解析清单类名称）后，它会舍弃该值并将其替换为应用 ID。</p>
<h1 id="Add-the-dependencies"><a href="#Add-the-dependencies" class="headerlink" title="Add the dependencies"></a>Add the dependencies</h1><p>指定依赖项时，不应使用动态版本号，比如 <code>&#39;com.android.tools.build:gradle:3.+&#39;</code>。 使用此功能，可能会导致意外版本更新和难以解析版本差异。</p>
<h2 id="依赖项类型"><a href="#依赖项类型" class="headerlink" title="依赖项类型"></a>依赖项类型</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="attr">plugin:</span> <span class="string">&#x27;com.android.application&#x27;</span></span><br><span class="line"></span><br><span class="line">android &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">// Dependency on a local library module</span></span><br><span class="line">    implementation project(<span class="string">&quot;:mylibrary&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Dependency on local binaries</span></span><br><span class="line">    implementation fileTree(<span class="attr">dir:</span> <span class="string">&#x27;libs&#x27;</span>, <span class="attr">include:</span> [<span class="string">&#x27;*.jar&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Dependency on a remote binary</span></span><br><span class="line">    implementation <span class="string">&#x27;com.example.android:app-magic:12.3&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="本地库模块依赖项"><a href="#本地库模块依赖项" class="headerlink" title="本地库模块依赖项"></a>本地库模块依赖项</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation project(<span class="string">&#x27;:mylibrary&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>这段代码声明名为“mylibrary”的 Android 库模块的依赖项（该名称必须匹配使用 settings.gradle 文件中的 include: 定义的库名称）。在构建应用时，构建系统会编译库模块，并将生成的编译内容打包到 APK中。</p>
<h3 id="本地二进制文件依赖项"><a href="#本地二进制文件依赖项" class="headerlink" title="本地二进制文件依赖项"></a>本地二进制文件依赖项</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation fileTree(<span class="attr">dir:</span> <span class="string">&#x27;libs&#x27;</span>, <span class="attr">include:</span> [<span class="string">&#x27;*.jar&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>Gradle 声明项目 module_name/libs/ 目录中 JAR 文件的依赖项（因为 Gradle 会读取 build.gradle 文件的相对路径）。或者，也可以像下面这样指定单独的文件：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation files(<span class="string">&#x27;libs/foo.jar&#x27;</span>, <span class="string">&#x27;libs/bar.jar&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="远程二进制文件依赖项"><a href="#远程二进制文件依赖项" class="headerlink" title="远程二进制文件依赖项"></a>远程二进制文件依赖项</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="string">&#x27;com.example.android:app-magic:12.3&#x27;</span></span><br></pre></td></tr></table></figure>

<p>以上代码实际上是下列代码的缩写形式：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation <span class="attr">group:</span> <span class="string">&#x27;com.example.android&#x27;</span>, <span class="attr">name:</span> <span class="string">&#x27;app-magic&#x27;</span>, <span class="attr">version:</span> <span class="string">&#x27;12.3&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这段代码声明<code>com.example.android</code>命名空间组内“app-magic”库 12.3 版本的依赖项。</p>
<p>注：与此类似的远程依赖项要求您声明相应的远程代码库，Gradle 应在其中寻找该库。如果本地尚不存在该库，Gradle 会在构建需要它时（例如，当您点击 Sync Project with Gradle Files 或当您运行构建时）从远程站点获取该库。</p>
<h2 id="依赖项配置"><a href="#依赖项配置" class="headerlink" title="依赖项配置"></a>依赖项配置</h2><table>
<thead>
<tr>
<th align="left">新配置</th>
<th align="left">已弃用配置</th>
<th align="left">行为</th>
</tr>
</thead>
<tbody><tr>
<td align="left">implementation</td>
<td align="left">compile</td>
<td align="left">Gradle 会将依赖项添加到编译类路径，并将依赖项打包到构建输出。但是，当您的模块配置 implementation 依赖项时，会告知 Gradle 您不想模块在编译时将依赖项泄露给其他模块。也就是说，依赖项只能在运行时供其他模块使用。使用此依赖项配置而不是api 或 compile（已弃用），可以显著缩短构建时间，因为它可以减少构建系统需要重新编译的模块数量。例如，如果 implementation 依赖项更改了其 API，Gradle 只会重新编译该依赖项和直接依赖它的模块。大多数应用和测试模块都应使用此配置。</td>
</tr>
<tr>
<td align="left">api</td>
<td align="left">compile</td>
<td align="left">Gradle 会将依赖项添加到编译类路径，并构建输出。当模块包括 api 依赖项时，会告知 Gradle 模块想将该依赖项间接导出至其他模块，以使这些模块在运行时和编译时均可使用该依赖项。此配置的行为类似于 compile （现已弃用），但您应仅对需要间接导出至其他上游消费者的依赖项慎重使用它。 这是因为，如果 api 依赖项更改了其外部 API，Gradle 会重新编译可以在编译时访问该依赖项的所有模块。 因此，拥有大量 api 依赖项会显著增加构建时间。 如果不想向不同的模块公开依赖项的 API，库模块应改用 implementation 依赖项。</td>
</tr>
<tr>
<td align="left">compileOnly</td>
<td align="left">provided</td>
<td align="left">Gradle 只会将依赖项添加到编译类路径（即不会将其添加到构建输出）。如果是创建 Android 模块且在编译期间需要使用该依赖项，在运行时可选择呈现该依赖项，则此配置会很有用。如果使用此配置，则您的库模块必须包含运行时条件，以便检查是否提供该依赖项，然后妥善更改其行为，以便模块在未提供依赖项的情况下仍可正常工作。这样做不会添加不重要的瞬时依赖项，有助于缩减最终 APK 的大小。 此配置的行为类似于 provided （现已弃用）。</td>
</tr>
<tr>
<td align="left">runtimeOnly</td>
<td align="left">apk</td>
<td align="left">Gradle 只会将依赖项添加到构建输出，供运行时使用。也就是说，不会将其添加到编译类路径。 此配置的行为类似于 apk（现已弃用）。</td>
</tr>
<tr>
<td align="left">annotationProcessor</td>
<td align="left">compile</td>
<td align="left">要在库中添加注解处理器依赖项，则必须使用 annotationProcessor 配置将其添加到注解处理器类路径。这是因为使用此配置可分离编译类路径与注解处理器类路径，从而提升构建性能。如果 Gradle 在编译类路径上找到注解处理器，则会停用 避免编译功能，这样会增加构建时间（Gradle 5.0 和更高版本会忽略编译类路径上的注解处理器）。如果 JAR 文件包含以下文件，则 Android Gradle Plugin 会假定依赖项是注解处理器：META-INF/services/javax.annotation.processing.Processor。如果插件检测到编译类路径上包含注解处理器，则会生成构建错误。</td>
</tr>
</tbody></table>
<p>以上配置适用于您的项目的主源集，该源集应用于所有构建不同类型。 如果您改为只想为特定构建不同类型源集或测试源集声明依赖项，则必须大写配置名称并在其前面加上构建不同类型或测试源集的名称作为前缀。</p>
<p>例如，要仅将 implementation 依赖项添加到您的“free”产品风格（使用远程二进制文件依赖项），需要使用下面这样的代码：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    freeImplementation <span class="string">&#x27;com.google.firebase:firebase-ads:9.8.0&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但如果想要为组合产品风格和构建类型的变体添加依赖项，则必须在 configurations 代码块中初始化配置名称。 以下示例向您的“freeDebug”构建变体添加 runtimeOnly 依赖项（使用本地二进制文件依赖项）：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">configurations &#123;</span><br><span class="line">    <span class="comment">// Initializes a placeholder for the freeDebugRuntimeOnly dependency</span></span><br><span class="line">    <span class="comment">// configuration.</span></span><br><span class="line">    freeDebugRuntimeOnly &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    freeDebugRuntimeOnly fileTree(<span class="attr">dir:</span> <span class="string">&#x27;libs&#x27;</span>, <span class="attr">include:</span> [<span class="string">&#x27;*.jar&#x27;</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要为您的本地测试和设备化测试添加 implementation 依赖项，需要使用下面这样的代码：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">// Adds a remote binary dependency only for local tests.</span></span><br><span class="line">    testImplementation <span class="string">&#x27;junit:junit:4.12&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Adds a remote binary dependency only for the instrumented test APK.</span></span><br><span class="line">    androidTestImplementation <span class="string">&#x27;com.android.support.test.espresso:espresso-core:3.0.2&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但某些配置在这种情况下没有意义。 例如，由于其他模块无法依赖 androidTest，因此如果使用 androidTestApi 配置，则会收到以下警告：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WARNING: Configuration &#39;androidTestApi&#39; is obsolete and has been replaced with &#39;androidTestImplementation&#39;.</span><br></pre></td></tr></table></figure>

<h3 id="添加注解处理器"><a href="#添加注解处理器" class="headerlink" title="添加注解处理器"></a>添加注解处理器</h3><p>如果将注解处理器添加到您的编译类路径，您将看到一条与以下消息类似的错误消息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: Annotation processors must be explicitly declared now.</span><br></pre></td></tr></table></figure>

<p>要解决此错误问题，请使用 annotationProcessor 配置您的依赖项，以在您的项目中添加注解处理器，如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">// Adds libraries defining annotations to only the compile classpath.</span></span><br><span class="line">    compileOnly <span class="string">&#x27;com.google.dagger:dagger:version-number&#x27;</span></span><br><span class="line">    <span class="comment">// Adds the annotation processor dependency to the annotation processor classpath.</span></span><br><span class="line">    annotationProcessor <span class="string">&#x27;com.google.dagger:dagger-compiler:version-number&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果需要向注解处理器传递参数，您可以在您的模块构建配置中使用 AnnotationProcessorOptions 代码块。 例如，如果要以键值对形式传递原始数据类型，则可使用 argument 属性，如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        ...</span><br><span class="line">        javaCompileOptions &#123;</span><br><span class="line">            annotationProcessorOptions &#123;</span><br><span class="line">                argument <span class="string">&quot;key1&quot;</span>, <span class="string">&quot;value1&quot;</span></span><br><span class="line">                argument <span class="string">&quot;key2&quot;</span>, <span class="string">&quot;value2&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但在使用 Android Gradle Plugin 3.2.0 和更高版本时，您需要使用 Gradle CommandLineArgumentProvider 接口传递表示文件或目录的处理器参数。使用 CommandLineArgumentProvider 可让您或注解处理器作者将增量构建属性类型注解应用于每个参数，从而提高增量构建和缓存干净构建的正确性和性能。</p>
<p>例如，下面的类可实现 CommandLineArgumentProvider 并注解处理器的每个参数。 此外，此示例也使用 Groovy 语言语法，且直接包含在模块的 build.gradle 文件中。</p>
<p>注：通常，注解处理器作者会提供此类或有关如何编写这种类的说明。这是因为每个参数均需指定正确的构建属性类型注解，才能按预期运行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyArgsProvider</span> <span class="keyword">implements</span> <span class="title">CommandLineArgumentProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Annotates each directory as either an input or output for the</span></span><br><span class="line">    <span class="comment">// annotation processor.</span></span><br><span class="line">    <span class="meta">@InputFiles</span></span><br><span class="line">    <span class="comment">// Using this annotation helps Gradle determine which part of the file path</span></span><br><span class="line">    <span class="comment">// should be considered during up-to-date checks.</span></span><br><span class="line">    <span class="meta">@PathSensitive(PathSensitivity.RELATIVE)</span></span><br><span class="line">    FileCollection inputDir</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OutputDirectory</span></span><br><span class="line">    File outputDir</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The class constructor sets the paths for the input and output directories.</span></span><br><span class="line">    MyArgsProvider(FileCollection input, File output) &#123;</span><br><span class="line">        inputDir = input</span><br><span class="line">        outputDir = output</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Specifies each directory as a command line argument for the processor.</span></span><br><span class="line">    <span class="comment">// The Android plugin uses this method to pass the arguments to the</span></span><br><span class="line">    <span class="comment">// annotation processor.</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">Iterable&lt;String&gt; <span class="title">asArguments</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Use the form &#x27;-Akey[=value]&#x27; to pass your options to the Java compiler.</span></span><br><span class="line">        [<span class="string">&quot;-AinputDir=$&#123;inputDir.singleFile.absolutePath&#125;&quot;</span>,</span><br><span class="line">         <span class="string">&quot;-AoutputDir=$&#123;outputDir.absolutePath&#125;&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">android &#123;...&#125;</span><br></pre></td></tr></table></figure>

<p>在创建实现 CommandLineArgumentProvider 的类后，您需要使用 annotationProcessorOptions.compilerArgumentProvider 属性初始化并将其传递至 Android 插件，如下所示。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This is in your module&#x27;s build.gradle file.</span></span><br><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        javaCompileOptions &#123;</span><br><span class="line">            annotationProcessorOptions &#123;</span><br><span class="line">                <span class="comment">// Creates a new MyArgsProvider object, specifies the input and</span></span><br><span class="line">                <span class="comment">// output paths for the constructor, and passes the object</span></span><br><span class="line">                <span class="comment">// to the Android plugin.</span></span><br><span class="line">                compilerArgumentProvider <span class="keyword">new</span> MyArgsProvider(files(<span class="string">&quot;input/path&quot;</span>),</span><br><span class="line">                                         <span class="keyword">new</span> File(<span class="string">&quot;output/path&quot;</span>))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果编译类路径中的依赖项包含您不需要的注解处理器，您可以将以下代码添加到 build.gradle 文件中，停用错误检查。 请记住，您添加到编译类路径中的注解处理器仍不会添加到处理器类路径中。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        ...</span><br><span class="line">        javaCompileOptions &#123;</span><br><span class="line">            annotationProcessorOptions &#123;</span><br><span class="line">                includeCompileClasspath <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果您将项目的注解处理器迁移到处理器类路径后遇到问题，可通过将 includeCompileClasspath 设置为 true，允许编译类路径上包含注解处理器。 但是，我们不建议将此属性设置为 true，并且我们将在以后的 Android plugin 更新版本中移除这种操作的相关选项。</p>
<h3 id="排除传递依赖项"><a href="#排除传递依赖项" class="headerlink" title="排除传递依赖项"></a>排除传递依赖项</h3><p>随着应用范围的扩大，其中可包含许多依赖项，包括直接依赖项和传递依赖项（应用的导入库所依赖的库）。 要排除不再需要的传递依赖项，您可以使用 exclude 关键字，如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    implementation(<span class="string">&#x27;some-library&#x27;</span>) &#123;</span><br><span class="line">        exclude <span class="attr">group:</span> <span class="string">&#x27;com.example.imgtools&#x27;</span>, <span class="attr">module:</span> <span class="string">&#x27;native&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果需要从您的测试中排除某些传递依赖项，上文所示的代码示例可能无法按预期发挥作用。 这是因为测试配置（例如 androidTestImplementation）扩展了模块的 implementation 配置。 也就是说，在 Gradle 解析配置时其中始终包含 implementation 依赖项。</p>
<p>因此，要从测试中排除传递依赖项，必须在执行代码时执行此操作，如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">android.testVariants.all &#123; variant -&gt;</span><br><span class="line">    variant.getCompileConfiguration().exclude <span class="attr">group:</span> <span class="string">&#x27;com.jakewharton.threetenabp&#x27;</span>, <span class="attr">module:</span> <span class="string">&#x27;threetenabp&#x27;</span></span><br><span class="line">    variant.getRuntimeConfiguration().exclude <span class="attr">group:</span> <span class="string">&#x27;com.jakewharton.threetenabp&#x27;</span>, <span class="attr">module:</span> <span class="string">&#x27;threetenabp&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用-variant-aware-依赖项管理"><a href="#使用-variant-aware-依赖项管理" class="headerlink" title="使用 variant-aware 依赖项管理"></a>使用 variant-aware 依赖项管理</h2><p>Android 插件 3.0.0 及更高版本包含一项新的依赖项机制，这种机制可以在消费库时自动匹配不同类型。 也就是说，应用的 debug 不同类型将自动消费库的 debug 不同类型，依此类推。 这种机制也适用于使用风格的情况—应用的 freeDebug 变体将使用库的 freeDebug 变体。</p>
<p>要让插件准确匹配变体，您需要为无法直接匹配的情况提供匹配回退。 假设您的应用配置一个名为“staging”的构建类型，但其库依赖项之一没有进行相应配置。 在插件尝试构建您的“staging”版本的应用时，它将无法了解库要使用哪一个版本，您将看到一条类似以下消息的错误消息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Error:Failed to resolve: Could not resolve project :mylibrary.</span><br><span class="line">Required by:</span><br><span class="line">    project :app</span><br></pre></td></tr></table></figure>

<img src="解决与变体匹配相关的构建错误.png"/>

<h2 id="远程代码库"><a href="#远程代码库" class="headerlink" title="远程代码库"></a>远程代码库</h2><p>如果您的依赖项并非本地库或文件树，Gradle 会在您的 build.gradle 文件 repositories 程序块中指定的任何一个在线代码库中寻找文件。 列出各代码库的顺序决定了 Gradle 在这些代码库中搜索各项目依赖项的顺序。 例如，如果代码库 A 和 B 都提供某依赖项，而您先列出代码库 A，则 Gradle 会从代码库 A 下载此依赖项。</p>
<p>默认情况下，Android Studio 新项目会在项目的顶级 build.gradle 文件中指定 Google 的 Maven 代码库和 JCenter 作为代码库位置，如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果您需要的内容来自 Maven 中央代码库，则添加 mavenCentral()；如果来自本地代码库，则使用 mavenLocal()，或者也可像下面这样声明特定 Maven 或 Ivy 代码库：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">        mavenCentral()</span><br><span class="line">        mavenLocal()</span><br><span class="line">        maven &#123;</span><br><span class="line">            url <span class="string">&quot;https://repo.example.com/maven2&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        maven &#123;</span><br><span class="line">            url <span class="string">&quot;file://local/repo/&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        ivy &#123;</span><br><span class="line">            url <span class="string">&quot;https://repo.example.com/ivy&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="依赖项顺序"><a href="#依赖项顺序" class="headerlink" title="依赖项顺序"></a>依赖项顺序</h2><p>例如，如果您的项目声明以下内容：</p>
<ul>
<li>LIB_A 和 LIB_B 上的依赖项（按照该顺序）</li>
<li>并且 LIB_A 依赖 LIB_C 和 LIB_D （按照该顺序）</li>
<li>并且 LIB_B 还依赖 LIB_C</li>
</ul>
<p>然后，扁平型依赖项顺序将如下所示：</p>
<ul>
<li>LIB_A</li>
<li>LIB_D</li>
<li>LIB_B</li>
<li>LIB_C</li>
</ul>
<h2 id="查看依赖项树"><a href="#查看依赖项树" class="headerlink" title="查看依赖项树"></a>查看依赖项树</h2><p>运行<code>gradle androidDependencies</code>即可查看依赖项树。</p>
<h2 id="修复依赖项解析错误"><a href="#修复依赖项解析错误" class="headerlink" title="修复依赖项解析错误"></a>修复依赖项解析错误</h2><h3 id="修复重复类错误"><a href="#修复重复类错误" class="headerlink" title="修复重复类错误"></a>修复重复类错误</h3><p>如果某类多次出现在运行时类路径中，您会收到一条与以下内容相似的错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Program type already present com.example.MyClass</span><br></pre></td></tr></table></figure>

<p>该错误通常是下列其中一种情况所致：</p>
<ul>
<li>二进制文件依赖项包括您的应用同时作为直接依赖项包括的库。 例如，您的应用在库 A 和库 B 上声明了直接依赖项，但库 A 的二进制文件中已包括库 B：要解决此问题，请取消将库 B 作为直接依赖项。</li>
<li>您的应用在同一库上具有本地二进制文件依赖项和远程二进制文件依赖项：要解决此问题，请移除其中一个二进制文件依赖项。</li>
</ul>
<h3 id="解决类路径之间的冲突问题"><a href="#解决类路径之间的冲突问题" class="headerlink" title="解决类路径之间的冲突问题"></a>解决类路径之间的冲突问题</h3><p>当 Gradle 解析编译类路径时，会先解析运行时类路径，然后使用此结果确定应添加到编译类路径的依赖项版本。 换言之，运行时类路径决定下游类路径的相同依赖项所需的版本号。</p>
<p>应用的运行时类路径还决定 Gradle 匹配运行类路径中应用测试 APK 的依赖项所需要的版本号：</p>
<img src="依赖项版本号.png"/>

<p>如果相同依赖项的冲突版本出现在多个类路径中，您可能会看到与以下内容相似的错误：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Conflict with dependency &#39;com.example.library:some-lib:2.0&#39; in project &#39;my-library&#39;.</span><br><span class="line">Resolved versions for runtime classpath (1.0) and compile classpath (2.0) differ.</span><br></pre></td></tr></table></figure>

<p>例如，当您的应用使用 implementation 依赖项配置加入某依赖项版本，并且库模块使用 runtimeOnly 配置加入此依赖项的不同版本时，可能会发生该冲突。 要解决此问题，请执行以下其中一项操作：</p>
<ul>
<li>将所需版本的依赖项作为 api 依赖项加入您的库模块。 也就是说，仅库模块声明此依赖项，但应用模块也可间接访问其 API。</li>
<li>或者，您也可以同时在两个模块中声明此依赖项，但应确保每个模块使用的版本相同。 请考虑配置项目范围的属性，以确保各依赖项的多个版本在整个项目中都保持一致。</li>
</ul>
<h2 id="应用自定义构建逻辑"><a href="#应用自定义构建逻辑" class="headerlink" title="应用自定义构建逻辑"></a>应用自定义构建逻辑</h2><p>本节介绍的内容在您想要扩展 Android Gradle Plugin 或编写自己的插件时很有用。</p>
<h3 id="为自定义逻辑发布变体依赖项"><a href="#为自定义逻辑发布变体依赖项" class="headerlink" title="为自定义逻辑发布变体依赖项"></a>为自定义逻辑发布变体依赖项</h3><p>库可以包含其他项目或子项目可能要使用的功能。 发布库是为其消费者提供库的流程。 库可以控制其消费者在编译时和运行时可访问的依赖项。现有两种不同的配置，其中包含消费者为使用库而必须使用的各类路径的传递依赖项，如下所述：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">variant_nameApiElements：此配置包含编译时消费者可使用的传递依赖项。</span><br><span class="line">variant_nameRuntimeElements：此配置包含运行时消费者可使用的传递依赖项。</span><br></pre></td></tr></table></figure>

<h3 id="自定义依赖项解析策略"><a href="#自定义依赖项解析策略" class="headerlink" title="自定义依赖项解析策略"></a>自定义依赖项解析策略</h3><p>项目包含的依赖项可能包含在相同库的两个不同版本中，这样会导致依赖项冲突。例如，如果您的项目依赖于模块 A 的版本 1 和模块 B 的版本 2，模块 A 间接依赖于模块 B 的版本 3，则会出现依赖项版本冲突。</p>
<p>要解决此冲突问题，Android Gradle Plugin 需使用以下依赖项解析策略：当插件检测到依赖图中包含相同模块的不同版本时，会默认选择版本最高的模块。但此策略可能无法按预期发挥作用。 要自定义依赖项解析策略，请使用以下配置解析您任务所需变体的特定依赖项：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">variant_nameCompileClasspath：此配置包含适用于给定变体编译类路径的解析策略。</span><br><span class="line">variant_nameRuntimeClasspath：此配置包含适用于给定变体运行时类路径的解析策略。</span><br></pre></td></tr></table></figure>

<p>Android Gradle Plugin 包含可用于访问各变体配置对象的 getter。 因此，您可以使用变体 API 查询依赖项解析策略，如下例所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    applicationVariants.all &#123; variant -&gt;</span><br><span class="line">        <span class="comment">// Return compile configuration objects of a variant.</span></span><br><span class="line">        variant.getCompileConfiguration().resolutionStrategy &#123;</span><br><span class="line">        <span class="comment">// Use Gradle&#x27;s ResolutionStrategy API</span></span><br><span class="line">        <span class="comment">// to customize how this variant resolves dependencies.</span></span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Return runtime configuration objects of a variant.</span></span><br><span class="line">        variant.getRuntimeConfiguration().resolutionStrategy &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Return annotation processor configuration of a variant.</span></span><br><span class="line">        variant.getAnnotationProcessorConfiguration().resolutionStrategy &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="配置编译变体"><a href="#配置编译变体" class="headerlink" title="配置编译变体"></a>配置编译变体</h1><h2 id="配置版本类型"><a href="#配置版本类型" class="headerlink" title="配置版本类型"></a>配置版本类型</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        manifestPlaceholders = [<span class="attr">hostName:</span><span class="string">&quot;www.example.com&quot;</span>]</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="literal">true</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android.txt&#x27;</span>), <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        debug &#123;</span><br><span class="line">            applicationIdSuffix <span class="string">&quot;.debug&quot;</span></span><br><span class="line">            debuggable <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">            * The `initWith` property allows you to copy configurations from other build types,</span></span><br><span class="line"><span class="comment">            * then configure only the settings you want to change. This one copies the debug build</span></span><br><span class="line"><span class="comment">            * type, and then changes the manifest placeholder and application ID.</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">        staging &#123;</span><br><span class="line">            initWith debug</span><br><span class="line">            manifestPlaceholders = [<span class="attr">hostName:</span><span class="string">&quot;internal.example.com&quot;</span>]</span><br><span class="line">            applicationIdSuffix <span class="string">&quot;.debugStaging&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置产品特性"><a href="#配置产品特性" class="headerlink" title="配置产品特性"></a>配置产品特性</h2><h3 id="配置产品特性-1"><a href="#配置产品特性-1" class="headerlink" title="配置产品特性"></a>配置产品特性</h3><p>创建产品特性与创建版本类型类似：将其添加到编译配置中的 productFlavors 代码块并添加所需的设置。产品特性支持与 defaultConfig 相同的属性，这是因为 defaultConfig 实际上属于 ProductFlavor 类。这意味着，您可以在 defaultConfig 代码块中为所有类型提供基本配置，并且每个类型都可以更改其中任何默认值.</p>
<p>所有类型都必须属于一个指定的类型维度，即一个产品特性组。即使您打算只使用一个维度，也必须将类型分配到类型维度.</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    defaultConfig &#123;...&#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        debug&#123;...&#125;</span><br><span class="line">        release&#123;...&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Specifies one flavor dimension.</span></span><br><span class="line">    flavorDimensions <span class="string">&quot;version&quot;</span></span><br><span class="line">    productFlavors &#123;</span><br><span class="line">        demo &#123;</span><br><span class="line">            <span class="comment">// Assigns this product flavor to the &quot;version&quot; flavor dimension.</span></span><br><span class="line">            <span class="comment">// This property is optional if you are using only one dimension.</span></span><br><span class="line">            dimension <span class="string">&quot;version&quot;</span></span><br><span class="line">            applicationIdSuffix <span class="string">&quot;.demo&quot;</span></span><br><span class="line">            versionNameSuffix <span class="string">&quot;-demo&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        full &#123;</span><br><span class="line">            dimension <span class="string">&quot;version&quot;</span></span><br><span class="line">            applicationIdSuffix <span class="string">&quot;.full&quot;</span></span><br><span class="line">            versionNameSuffix <span class="string">&quot;-full&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="将多个产品特性与类型维度结合使用"><a href="#将多个产品特性与类型维度结合使用" class="headerlink" title="将多个产品特性与类型维度结合使用"></a>将多个产品特性与类型维度结合使用</h3><p>在编译应用时，Gradle 会结合使用您定义的每个类型维度的产品特性配置以及版本类型配置，以创建最终的编译变体。Gradle 不会将属于同一类型维度的产品特性组合在一起。</p>
<p>以下代码示例使用 flavorDimensions 属性来创建“mode”类型维度和“api”类型维度，前者用于将“full”和“demo”产品特性进行分组，后者用于根据 API 级别对产品特性配置进行分组：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        debug &#123;...&#125;</span><br><span class="line">        release &#123;...&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Specifies the flavor dimensions you want to use. The order in which you</span></span><br><span class="line">    <span class="comment">// list each dimension determines its priority, from highest to lowest,</span></span><br><span class="line">    <span class="comment">// when Gradle merges variant sources and configurations. You must assign</span></span><br><span class="line">    <span class="comment">// each product flavor you configure to one of the flavor dimensions.</span></span><br><span class="line">    flavorDimensions <span class="string">&quot;api&quot;</span>, <span class="string">&quot;mode&quot;</span></span><br><span class="line"></span><br><span class="line">    productFlavors &#123;</span><br><span class="line">        demo &#123;</span><br><span class="line">            <span class="comment">// Assigns this product flavor to the &quot;mode&quot; flavor dimension.</span></span><br><span class="line">            dimension <span class="string">&quot;mode&quot;</span></span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        full &#123;</span><br><span class="line">            dimension <span class="string">&quot;mode&quot;</span></span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Configurations in the &quot;api&quot; product flavors override those in &quot;mode&quot;</span></span><br><span class="line">        <span class="comment">// flavors and the defaultConfig block. Gradle determines the priority</span></span><br><span class="line">        <span class="comment">// between flavor dimensions based on the order in which they appear next</span></span><br><span class="line">        <span class="comment">// to the flavorDimensions property above--the first dimension has a higher</span></span><br><span class="line">        <span class="comment">// priority than the second, and so on.</span></span><br><span class="line">        minApi24 &#123;</span><br><span class="line">            dimension <span class="string">&quot;api&quot;</span></span><br><span class="line">            minSdkVersion <span class="number">24</span></span><br><span class="line">            <span class="comment">// To ensure the target device receives the version of the app with</span></span><br><span class="line">            <span class="comment">// the highest compatible API level, assign version codes in increasing</span></span><br><span class="line">            <span class="comment">// value with API level. To learn more about assigning version codes to</span></span><br><span class="line">            <span class="comment">// support app updates and uploading to Google Play, read Multiple APK Support</span></span><br><span class="line">            versionCode <span class="number">30000</span> + android.defaultConfig.versionCode</span><br><span class="line">            versionNameSuffix <span class="string">&quot;-minApi24&quot;</span></span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        minApi23 &#123;</span><br><span class="line">            dimension <span class="string">&quot;api&quot;</span></span><br><span class="line">            minSdkVersion <span class="number">23</span></span><br><span class="line">            versionCode <span class="number">20000</span>  + android.defaultConfig.versionCode</span><br><span class="line">            versionNameSuffix <span class="string">&quot;-minApi23&quot;</span></span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        minApi21 &#123;</span><br><span class="line">            dimension <span class="string">&quot;api&quot;</span></span><br><span class="line">            minSdkVersion <span class="number">21</span></span><br><span class="line">            versionCode <span class="number">10000</span>  + android.defaultConfig.versionCode</span><br><span class="line">            versionNameSuffix <span class="string">&quot;-minApi21&quot;</span></span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上面的编译配置为例，Gradle 使用以下命名方案创建了总共 12 个编译变体：</p>
<ul>
<li>编译变体：[minApi24, minApi23, minApi21][Demo, Full][Debug, Release]</li>
<li>对应的 APK：app-[minApi24, minApi23, minApi21]-[demo, full]-[debug, release].apk</li>
</ul>
<p>除了可以为各个产品特性和编译变体创建源集目录外，您还可以为每个产品特性组合创建源集目录。例如，您可以创建 Java 源文件并将其添加到 src/demoMinApi24/java/ 目录中，这样 Gradle 就只会在编译同时对应这两种产品特性的变体时才使用这些源文件。您为产品特性组合创建的源集的优先级高于属于各个产品特性的源集。</p>
<h3 id="过滤变体"><a href="#过滤变体" class="headerlink" title="过滤变体"></a>过滤变体</h3><p>Gradle 会为您配置的产品特性和版本类型的每种可能组合创建编译变体。但是，某些编译变体可能并不是您需要的，或者在项目上下文中没有意义。您可以通过在模块级 build.gradle 文件中创建变体过滤器来移除某些编译变体配置。</p>
<p>以上一部分中的编译配置为例，假设您打算让“demo”版应用仅支持 API 级别 23 及更高级别。您可以使用 variantFilter 代码块过滤掉所有将“minApi21”和“demo”产品特性组合在一起的编译变体配置：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    buildTypes &#123;...&#125;</span><br><span class="line"></span><br><span class="line">    flavorDimensions <span class="string">&quot;api&quot;</span>, <span class="string">&quot;mode&quot;</span></span><br><span class="line">    productFlavors &#123;</span><br><span class="line">    demo &#123;...&#125;</span><br><span class="line">    full &#123;...&#125;</span><br><span class="line">    minApi24 &#123;...&#125;</span><br><span class="line">    minApi23 &#123;...&#125;</span><br><span class="line">    minApi21 &#123;...&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    variantFilter &#123; variant -&gt;</span><br><span class="line">        <span class="keyword">def</span> names = variant.flavors*.name</span><br><span class="line">        <span class="comment">// To check for a certain build type, use variant.buildType.name == &quot;&lt;buildType&gt;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (names.contains(<span class="string">&quot;minApi21&quot;</span>) &amp;&amp; names.contains(<span class="string">&quot;demo&quot;</span>)) &#123;</span><br><span class="line">            <span class="comment">// Gradle ignores any variants that satisfy the conditions above.</span></span><br><span class="line">            setIgnore(<span class="literal">true</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="维度回退"><a href="#维度回退" class="headerlink" title="维度回退"></a>维度回退</h3><p><strong>情况1：app中有某个build type但module中没有。</strong></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In the app&#x27;s build.gradle file.</span></span><br><span class="line">android &#123;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        debug &#123;&#125;</span><br><span class="line">        release &#123;&#125;</span><br><span class="line">        staging &#123;</span><br><span class="line">            <span class="comment">// 下面[]中的qa、debug、release是module中配置的buildType，必须含有其中一个或更多，</span></span><br><span class="line">            <span class="comment">// 若module中buildType没有staging，gradle会根据matchingFallbacks的配置，</span></span><br><span class="line">            <span class="comment">// 依次按顺序去匹配</span></span><br><span class="line">            <span class="comment">// 注意：module与module之间存在依赖关系的话，也要在特定的build types中指定匹配关系</span></span><br><span class="line">            matchingFallbacks = [<span class="string">&#x27;qa&#x27;</span>, <span class="string">&#x27;debug&#x27;</span>, <span class="string">&#x27;release&#x27;</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：module中有但app中没有的build type是不会报错的，因为gradle插件根本不会去module中请求build type。</p>
<p><strong>情况2：在app和它的module中都有同一个维度（比如：flavorDimensions ‘tier’），但你的app有的flavors在module中没有。</strong></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">flavorDimensions <span class="string">&#x27;tier&#x27;</span></span><br><span class="line">productFlavors &#123;</span><br><span class="line">    paid &#123;</span><br><span class="line">        <span class="comment">// 因为依赖app的module在&#x27;tier&#x27;维度下也有&#x27;paid&#x27;这个flavor，所以你不用去管，</span></span><br><span class="line">        <span class="comment">// gradle会自动为你匹配</span></span><br><span class="line">        dimension <span class="string">&#x27;tier&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    free &#123;</span><br><span class="line">        <span class="comment">// 因为module在&#x27;tier&#x27;维度下没有&#x27;free&#x27;这个flavor，所以需要指定matchingFallbacks</span></span><br><span class="line">        <span class="comment">// 让gradle知道怎么去匹配</span></span><br><span class="line">        <span class="comment">// 像下面这样配置，gradle会按顺序依次去匹配module中&#x27;tier&#x27;维度下的flavor，</span></span><br><span class="line">        <span class="comment">// 直到匹配到，否则会报错</span></span><br><span class="line">        matchingFallbacks = [<span class="string">&#x27;demo&#x27;</span>, <span class="string">&#x27;trial&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：对于在同一个维度下，module中有的flavors但app中没有是不会报错的，因为gradle插件根本不会去module中请求flavors。</p>
<p><strong>情况3：module中有某个dimension维度，但app中没有。</strong></p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// In the app&#x27;s build.gradle file.</span></span><br><span class="line">android &#123;</span><br><span class="line">    defaultConfig&#123;</span><br><span class="line">        <span class="comment">// 下面这句话告诉gradle，当遇到一个module中有个app中没有的&#x27;minApi&#x27;维度时，</span></span><br><span class="line">        <span class="comment">// 它应该按照下面这个顺序去匹配module中这个维度的flavors</span></span><br><span class="line">        missingDimensionStrategy <span class="string">&#x27;minApi&#x27;</span>, <span class="string">&#x27;minApi18&#x27;</span>, <span class="string">&#x27;minApi23&#x27;</span></span><br><span class="line">        <span class="comment">// 若其他module中还有更多app中没有的维度，你必须为所有的维度定义回退策略</span></span><br><span class="line">        missingDimensionStrategy <span class="string">&#x27;abi&#x27;</span>, <span class="string">&#x27;x86&#x27;</span>, <span class="string">&#x27;arm64&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    flavorDimensions <span class="string">&#x27;tier&#x27;</span></span><br><span class="line">    productFlavors &#123;</span><br><span class="line">        free &#123;</span><br><span class="line">            dimension <span class="string">&#x27;tier&#x27;</span></span><br><span class="line">            <span class="comment">// 你可以在一个特定的flavor中覆盖defaultConfig的配置</span></span><br><span class="line">            missingDimensionStrategy <span class="string">&#x27;minApi&#x27;</span>, <span class="string">&#x27;minApi23&#x27;</span>, <span class="string">&#x27;minApi18&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        paid &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：当一个维度app中有但module中没有的时候是不会报错，因为gradle插件只会匹配已经在module中存在的维度，比如module中没有abi这个维度，当app为freeX86Debug时，你的module就用freeDebug。</p>
<p><strong>情况4：若module中没有某个dimension，则app不需要在这个dimension下做任何处理。</strong></p>
<h2 id="创建源集"><a href="#创建源集" class="headerlink" title="创建源集"></a>创建源集</h2><h3 id="创建源集-1"><a href="#创建源集-1" class="headerlink" title="创建源集"></a>创建源集</h3><p>默认情况下，Android Studio 会为您希望在所有编译变体之间共享的所有内容创建 main/ 源集和目录。但是，您可以创建新的源集来精确控制 Gradle 为特定版本类型、产品特性（以及使用类型维度时的产品特性组合）和编译变体编译和打包的文件。例如，您可以在 main/ 源集中定义基本功能，并使用产品特性源集来为不同客户端更改应用的品牌，或仅为使用“debug”版本类型的编译变体添加特殊权限和日志记录功能。</p>
<p>Gradle 要求您以某种类似于 main/ 源集的方式组织源集文件和目录。例如，Gradle 要求将“debug”版本类型特有的 Java 类文件放在 src/debug/java/ 目录中。</p>
<p>可通过<code>gradle sourceSets</code>查看不同变体期望的源集路径；可通过Android Studio自带功能创建源集。</p>
<h3 id="更改默认源集配置"><a href="#更改默认源集配置" class="headerlink" title="更改默认源集配置"></a>更改默认源集配置</h3><p>可以使用sourceSets修改默认源集路径。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    sourceSets &#123;</span><br><span class="line">        <span class="comment">// Encapsulates configurations for the main source set.</span></span><br><span class="line">        main &#123;</span><br><span class="line">            <span class="comment">// Changes the directory for Java sources. The default directory is</span></span><br><span class="line">            <span class="comment">// &#x27;src/main/java&#x27;.</span></span><br><span class="line">            java.srcDirs = [<span class="string">&#x27;other/java&#x27;</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If you list multiple directories, Gradle uses all of them to collect</span></span><br><span class="line">            <span class="comment">// sources. Because Gradle gives these directories equal priority, if</span></span><br><span class="line">            <span class="comment">// you define the same resource in more than one directory, you get an</span></span><br><span class="line">            <span class="comment">// error when merging resources. The default directory is &#x27;src/main/res&#x27;.</span></span><br><span class="line">            res.srcDirs = [<span class="string">&#x27;other/res1&#x27;</span>, <span class="string">&#x27;other/res2&#x27;</span>]</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Note: You should avoid specifying a directory which is a parent to one</span></span><br><span class="line">            <span class="comment">// or more other directories you specify. For example, avoid the following:</span></span><br><span class="line">            <span class="comment">// res.srcDirs = [&#x27;other/res1&#x27;, &#x27;other/res1/layouts&#x27;, &#x27;other/res1/strings&#x27;]</span></span><br><span class="line">            <span class="comment">// You should specify either only the root &#x27;other/res1&#x27; directory, or only the</span></span><br><span class="line">            <span class="comment">// nested &#x27;other/res1/layouts&#x27; and &#x27;other/res1/strings&#x27; directories.</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// For each source set, you can specify only one Android manifest.</span></span><br><span class="line">            <span class="comment">// By default, Android Studio creates a manifest for your main source</span></span><br><span class="line">            <span class="comment">// set in the src/main/ directory.</span></span><br><span class="line">            manifest.srcFile <span class="string">&#x27;other/AndroidManifest.xml&#x27;</span></span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create additional blocks to configure other source sets.</span></span><br><span class="line">        androidTest &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If all the files for a source set are located under a single root</span></span><br><span class="line">            <span class="comment">// directory, you can specify that directory using the setRoot property.</span></span><br><span class="line">            <span class="comment">// When gathering sources for the source set, Gradle looks only in locations</span></span><br><span class="line">            <span class="comment">// relative to the root directory you specify. For example, after applying the</span></span><br><span class="line">            <span class="comment">// configuration below for the androidTest source set, Gradle looks for Java</span></span><br><span class="line">            <span class="comment">// sources only in the src/tests/java/ directory.</span></span><br><span class="line">            setRoot <span class="string">&#x27;src/tests&#x27;</span></span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用源集编译"><a href="#使用源集编译" class="headerlink" title="使用源集编译"></a>使用源集编译</h3><p>可以使用源集目录来添加只希望与某些配置打包在一起的代码和资源。例如，如果您要编译“demoDebug”这个变体（“demo”产品特性和“debug”版本类型的混合产物），则 Gradle 会查看这些目录，并为它们指定以下优先级：</p>
<ol>
<li>src/demoDebug/（编译变体源集）</li>
<li>src/debug/（版本类型源集）</li>
<li>src/demo/（产品特性源集）</li>
<li>src/main/（主源集）</li>
</ol>
<p>注意：如果您结合使用多个产品特性，那么这些产品特性的优先级由它们所属的类型维度决定。使用 android.flavorDimensions 属性列出类型维度时，属于您列出的第一个类型维度的产品特性的优先级高于属于第二个类型维度的产品特性，依此类推。此外，您为产品特性组合创建的源集的优先级高于属于各个产品特性的源集。</p>
<p>上面列出的顺序决定了 Gradle 组合代码和资源时哪个源集的优先级更高。由于 demoDebug/ 源集目录可能包含该编译变体特有的文件，因此，如果 demoDebug/ 包含在 debug/ 中也定义了的文件，则 Gradle 会使用 demoDebug/ 源集中的文件。类似地，Gradle 会为版本类型和产品特性源集中的文件提供比 main/ 中的相同文件更高的优先级。在应用以下编译规则时，Gradle 会考虑这种优先顺序：</p>
<ul>
<li>java/ 目录中的所有源代码将一起编译以生成单个输出。<br>  注意：对于给定的编译变体，如果 Gradle 遇到两个或更多个源集目录定义了同一个 Java 类的情况，则会抛出编译错误。例如，在编译调试 APK 时，您不能同时定义 src/debug/Utility.java 和 src/main/Utility.java。这是因为 Gradle 在编译过程中会查看这两个目录并抛出“重复类”错误。如果您要为不同的版本类型使用不同版本的 Utility.java，则可以让每个版本类型定义各自的文件版本，而不是将其包含在 main/ 源集中。</li>
<li>所有清单都将合并为一个清单，优先级将按照上面列出的顺序提供。也就是说，版本类型的清单设置会替换产品特性的清单设置，依此类推。</li>
<li>同样，values/ 目录中的文件也会合并在一起。如果两个文件（如两个 strings.xml 文件）的名称相同，将按照上面列表中的顺序指定优先级。也就是说，在版本类型源集的文件中定义的值会重写在产品特性的同一文件中定义的值，依此类推。</li>
<li>res/ 和 asset/ 目录中的资源会打包在一起。如果在两个或更多个源集中定义了同名的资源，将按照上面列表中的顺序指定优先级。</li>
<li>最后，在编译 APK 时，Gradle 会为库模块依赖项随附的资源和清单指定最低优先级。</li>
</ul>
<h2 id="声明依赖项"><a href="#声明依赖项" class="headerlink" title="声明依赖项"></a>声明依赖项</h2><p>可以为特定编译变体或测试源集配置依赖项，方法是在 Implementation 关键字前面加上编译变体或测试源集的名称作为前缀，如以下示例所示。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">// Adds the local &quot;mylibrary&quot; module as a dependency to the &quot;free&quot; flavor.</span></span><br><span class="line">    freeImplementation project(<span class="string">&quot;:mylibrary&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Adds a remote binary dependency only for local tests.</span></span><br><span class="line">    testImplementation <span class="string">&#x27;junit:junit:4.12&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Adds a remote binary dependency only for the instrumented test APK.</span></span><br><span class="line">    androidTestImplementation <span class="string">&#x27;com.android.support.test.espresso:espresso-core:3.0.2&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="配置签名设置"><a href="#配置签名设置" class="headerlink" title="配置签名设置"></a>配置签名设置</h2><p>除非您明确定义此版本的签名配置，否则 Gradle 不会为该版本的 APK 签名。您可以轻松创建发布密钥并使用 Android Studio 为发布版本类型签名。要使用 Gradle 编译配置为您的发布版本类型手动配置签名，请执行以下操作：</p>
<ol>
<li>创建一个密钥库。密钥库是一个包含一组私钥的二进制文件。您必须将密钥库保存在安全可靠的地方。</li>
<li>创建一个私钥。私钥代表将通过应用识别的实体，如个人或公司。</li>
<li>将签名配置添加到模块级 build.gradle 文件中：</li>
</ol>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    defaultConfig &#123;...&#125;</span><br><span class="line">    signingConfigs &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            storeFile file(<span class="string">&quot;myreleasekey.keystore&quot;</span>)</span><br><span class="line">            storePassword <span class="string">&quot;password&quot;</span></span><br><span class="line">            keyAlias <span class="string">&quot;MyReleaseKey&quot;</span></span><br><span class="line">            keyPassword <span class="string">&quot;password&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            ...</span><br><span class="line">            signingConfig signingConfigs.release</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：在编译文件中添加发布密钥和密钥存储区的密码并不是一种好的安全做法。作为替代方案，您可以配置编译文件以从环境变量获取这些密码，或让编译流程提示您输入这些密码。</p>
<p>要从环境变量获取这些密码，请编写以下代码：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">storePassword System.getenv(<span class="string">&quot;KSTOREPWD&quot;</span>)</span><br><span class="line">keyPassword System.getenv(<span class="string">&quot;KEYPWD&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>要让编译流程在您要从命令行调用此编译时提示您输入这些密码，请编写以下代码：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">storePassword System.console().readLine(<span class="string">&quot;\nKeystore password: &quot;</span>)</span><br><span class="line">keyPassword System.console().readLine(<span class="string">&quot;\nKey password: &quot;</span>)</span><br></pre></td></tr></table></figure>

<p>警告：请将密钥库和私钥保存在安全可靠的地方，并确保您为其创建了安全的备份。如果您将应用发布到 Google Play，随后丢失了用于为应用签名的密钥，那么您将无法向您的应用发布任何更新，因为您必须始终使用相同的密钥为应用的所有版本签名。</p>
<p>注意：当buildType.debug中没有指定signingConfig时，即使productFlavors中提供了签名配置，也会默认使用Android Studio提供的签名，因此如果要使debug下的flavor签名生效，需要指定debug的signingConfig为null，如下：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> flavorSigns = [</span><br><span class="line">        <span class="string">&quot;base&quot;</span>     : readSigningConfig(file(<span class="string">&#x27;../signing1.properties&#x27;</span>)),</span><br><span class="line">        <span class="string">&quot;flavorA&quot;</span>: readSigningConfig(file(<span class="string">&#x27;../signing2.properties&#x27;</span>)),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    signingConfigs &#123;</span><br><span class="line">        flavorSigns.forEach &#123; key, value -&gt;</span><br><span class="line">            <span class="string">&quot;$key&quot;</span> &#123;</span><br><span class="line">                keyAlias value.keyAlias</span><br><span class="line">                keyPassword value.keyPassword</span><br><span class="line">                storeFile value.storeFile</span><br><span class="line">                storePassword value.storePassword</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        signingConfig signingConfigs.base</span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        &#125;</span><br><span class="line">        debug &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="comment">// Android Studio adds a default signingConfig for debug builds and we can remove it by passing null.</span></span><br><span class="line">            <span class="comment">// By doing this, I delegate the signingConfig to the product flavors.</span></span><br><span class="line">            signingConfig <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    flavorDimensions <span class="string">&quot;version&quot;</span>, <span class="string">&quot;channel&quot;</span></span><br><span class="line"></span><br><span class="line">    productFlavors &#123;</span><br><span class="line">        stable &#123;</span><br><span class="line">            dimension <span class="string">&quot;version&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        alpha &#123;</span><br><span class="line">            dimension <span class="string">&quot;version&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        base &#123;</span><br><span class="line">            dimension <span class="string">&quot;channel&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        flavorA &#123;</span><br><span class="line">            dimension <span class="string">&quot;channel&quot;</span></span><br><span class="line">            signingConfig signingConfigs.flavorA</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="构建多应用"><a href="#构建多应用" class="headerlink" title="构建多应用"></a>构建多应用</h1><h2 id="构建多应用-1"><a href="#构建多应用-1" class="headerlink" title="构建多应用"></a>构建多应用</h2><h3 id="屏幕密度"><a href="#屏幕密度" class="headerlink" title="屏幕密度"></a>屏幕密度</h3><p>以下为compatibleScreens列出的每个屏幕密度生成单独的APK，但ldpi，xxhdpi和xxxhdpi除外：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  splits &#123;</span><br><span class="line">    <span class="comment">// Configures multiple APKs based on screen density.</span></span><br><span class="line">    density &#123;</span><br><span class="line">      <span class="comment">// Configures multiple APKs based on screen density.</span></span><br><span class="line">      enable <span class="literal">true</span></span><br><span class="line">      <span class="comment">// Specifies a list of screen densities Gradle should not create multiple APKs for.</span></span><br><span class="line">      exclude <span class="string">&quot;ldpi&quot;</span>, <span class="string">&quot;xxhdpi&quot;</span>, <span class="string">&quot;xxxhdpi&quot;</span></span><br><span class="line">      <span class="comment">// Specifies a list of compatible screen size settings for the manifest.</span></span><br><span class="line">      compatibleScreens <span class="string">&#x27;small&#x27;</span>, <span class="string">&#x27;normal&#x27;</span>, <span class="string">&#x27;large&#x27;</span>, <span class="string">&#x27;xlarge&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>enable：如果将此元素设置为true，Gradle会根据您定义的屏幕密度生成多个APK。默认值为false。</p>
</li>
<li><p>exclude：指定以逗号分隔的密度列表，Gradle不应为其生成单独的APK。</p>
</li>
<li><p>reset()：清除默认的屏幕密度列表，仅在与include元素组合时使用， 以指定要添加的密度。</p>
</li>
<li><p>include：指定Gradle应为其生成APK的密度列表。只能结合使用reset()来指定密度的确切列表。</p>
</li>
<li><p>compatibleScreens：指定兼容屏幕尺寸的逗号分隔列表，这会为每个APK在manifest中注入一个匹配的 <code>&lt;compatible-screens&gt;</code>节点。此设置提供了在同一build.gradle中管理屏幕密度和屏幕大小的便捷方法。但是，使用<code>&lt;compatible-screens&gt;</code>限制了应用程序可以使用的设备类型。</p>
  <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reset()  <span class="comment">// Clears the default list from all densities to no densities.</span></span><br><span class="line">include <span class="string">&quot;ldpi&quot;</span>, <span class="string">&quot;xxhdpi&quot;</span> <span class="comment">// Specifies the two densities we want to generate APKs for.</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>因为基于屏幕密度的每个APK都包含<code>&lt;compatible-screens&gt;</code>标记，其中包含有关APK支持的屏幕类型的特定限制，即使您发布了多个APK，某些新设备也无法匹配您的多个APK过滤器。因此，Gradle始终会生成一个额外的通用APK，其中包含所有屏幕密度的资源，并且不包含<code>&lt;compatible-screens&gt;</code>标记。您应该发布此通用APK以及每个密度的APK，以便为与APK兼容的设备提供后备兼容的<code>&lt;compatible-screens&gt;</code>标记。</p>
<h3 id="ABI"><a href="#ABI" class="headerlink" title="ABI"></a>ABI</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  splits &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Configures multiple APKs based on ABI.</span></span><br><span class="line">    abi &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Enables building multiple APKs per ABI.</span></span><br><span class="line">      enable <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// By default all ABIs are included, so use reset() and include to specify that we only</span></span><br><span class="line">      <span class="comment">// want APKs for x86 and x86_64.</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Resets the list of ABIs that Gradle should create APKs for to none.</span></span><br><span class="line">      reset()</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Specifies a list of ABIs that Gradle should create APKs for.</span></span><br><span class="line">      include <span class="string">&quot;x86&quot;</span>, <span class="string">&quot;x86_64&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Specifies that we do not want to also generate a universal APK that includes all ABIs.</span></span><br><span class="line">      universalApk <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ABI 包含以下信息：</p>
<ul>
<li>机器代码应使用的 CPU 指令集。</li>
<li>运行时内存存储和加载的字节顺序。</li>
<li>可执行二进制文件（例如程序和共享库）的格式，以及它们支持的内容类型。</li>
<li>用于解析内容与系统之间数据的各种约定。这些约定包括对齐限制，以及系统如何使用堆栈和在调用函数时注册。</li>
<li>运行时可用于机器代码的函数符号列表 - 通常来自非常具体的库集。</li>
</ul>
<img src="abi分类.png"/>

<ul>
<li>enable：如果您将此元素设置为true，Gradle会根据您定义的ABI生成多个APK。默认值是false</li>
<li>exclude：指定用逗号分隔的ABI的名单不生成单独的APK。</li>
<li>reset：清除ABI的默认列表。仅在与include元素结合使用时才使用， 以指定要添加的ABI。</li>
<li>include：指定Gradle应为其生成APK的ABI的逗号分隔列表。只能结合使用reset()来指定ABI的确切列表。</li>
<li>universalApk：如果true，除了per-ABI APK，Gradle还生成通用APK。通用APK包含单个APK中所有ABI的代码和资源。默认值是false。请注意，该选项仅在该splits.abi块中可用。当根据屏幕密度构建多个APK时，Gradle始终会生成一个通用APK，其中包含用于所有屏幕密度的代码和资源。</li>
</ul>
<p>在Gradle 3.1.0及更高版本中不再默认生成支持mips, mips64, 和armeabi的apk，因为 NDK r17 及更高版本不再支持这些abi。因此如果使用Gradle版本低于3.1.0，NDK高于r17，则会报错。</p>
<h2 id="配置版本"><a href="#配置版本" class="headerlink" title="配置版本"></a>配置版本</h2><p>默认生成的多个apk的版本信息是一样的，但是GP不允许同一应用的多apk拥有相同的版本信息，因此需要为其生成不同的版本。</p>
<p>如果您的构建包含通用APK，则应为其分配一个低于任何其他APK的版本代码。 由于Google Play商店会安装与目标设备兼容且版本编号最高的应用版本，因此将较低版本的代码分配给通用APK可确保Google Play商店尝试安装其中一个APK，然后再回到通用版本APK。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">  ...</span><br><span class="line">  defaultConfig &#123;</span><br><span class="line">    ...</span><br><span class="line">    versionCode <span class="number">4</span></span><br><span class="line">  &#125;</span><br><span class="line">  splits &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Map for the version code that gives each ABI a value.</span></span><br><span class="line">ext.abiCodes = [<span class="string">&#x27;armeabi-v7a&#x27;</span>:<span class="number">1</span>, <span class="string">&#x27;x86&#x27;</span>:<span class="number">2</span>, <span class="string">&#x27;x86_64&#x27;</span>:<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// For per-density APKs, create a similar map like this:</span></span><br><span class="line"><span class="comment">// ext.densityCodes = [&#x27;mdpi&#x27;: 1, &#x27;hdpi&#x27;: 2, &#x27;xhdpi&#x27;: 3]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.android.build.OutputFile</span><br><span class="line"></span><br><span class="line"><span class="comment">// For each APK output variant, override versionCode with a combination of</span></span><br><span class="line"><span class="comment">// ext.abiCodes * 1000 + variant.versionCode. In this example, variant.versionCode</span></span><br><span class="line"><span class="comment">// is equal to defaultConfig.versionCode. If you configure product flavors that</span></span><br><span class="line"><span class="comment">// define their own versionCode, variant.versionCode uses that value instead.</span></span><br><span class="line">android.applicationVariants.all &#123; variant -&gt;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Assigns a different version code for each output APK</span></span><br><span class="line">  <span class="comment">// other than the universal APK.</span></span><br><span class="line">  variant.outputs.each &#123; output -&gt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Stores the value of ext.abiCodes that is associated with the ABI for this variant.</span></span><br><span class="line">    <span class="keyword">def</span> baseAbiVersionCode =</span><br><span class="line">            <span class="comment">// Determines the ABI for this variant and returns the mapped value.</span></span><br><span class="line">            project.ext.abiCodes.get(output.getFilter(OutputFile.ABI))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Because abiCodes.get() returns null for ABIs that are not mapped by ext.abiCodes,</span></span><br><span class="line">    <span class="comment">// the following code does not override the version code for universal APKs.</span></span><br><span class="line">    <span class="comment">// However, because we want universal APKs to have the lowest version code,</span></span><br><span class="line">    <span class="comment">// this outcome is desirable.</span></span><br><span class="line">    <span class="keyword">if</span> (baseAbiVersionCode != <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Assigns the new version code to versionCodeOverride, which changes the version code</span></span><br><span class="line">      <span class="comment">// for only the output APK, not for the variant itself. Skipping this step simply</span></span><br><span class="line">      <span class="comment">// causes Gradle to use the value of variant.versionCode for the APK.</span></span><br><span class="line">      output.versionCodeOverride =</span><br><span class="line">              baseAbiVersionCode * <span class="number">1000</span> + variant.versionCode</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="格式化apk名"><a href="#格式化apk名" class="headerlink" title="格式化apk名"></a>格式化apk名</h2><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    applicationVariants.all &#123; variant -&gt;</span><br><span class="line">        variant.outputs.all &#123;</span><br><span class="line">            outputFileName = <span class="string">&quot;$&#123;variant.applicationId&#125;-$&#123;variant.name&#125;-$&#123;variant.versionName&#125;.apk&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Manifest合并"><a href="#Manifest合并" class="headerlink" title="Manifest合并"></a>Manifest合并</h1><h2 id="合并优先级"><a href="#合并优先级" class="headerlink" title="合并优先级"></a>合并优先级</h2><p>合并工具会根据每个清单文件的优先级按顺序合并，将所有清单文件组合到一个文件中。</p>
<img src="合并Manifest.png"/>

<p>有三种基本的清单文件可以互相合并，它们的合并优先级如下（按优先级由高到低的顺序）：</p>
<ol>
<li><p>编译变体的清单文件<br> 如果您的变体有多个源集，则其清单优先级如下：</p>
<ul>
<li>编译变体清单（如 src/demoDebug/）</li>
<li>版本类型清单（如 src/debug/）</li>
<li>产品类型清单（如 src/demo/）<br>如果您使用的是类型维度，则清单优先级将与每个维度在 flavorDimensions 属性中的列示顺序（按优先级由高到低的顺序）对应。</li>
</ul>
</li>
<li><p>应用模块的主清单文件</p>
</li>
<li><p>所包含的库中的清单文件<br> 如果您有多个库，则其清单优先级与依赖顺序（库出现在 Gradle dependencies 块中的顺序）匹配。例如，先将库清单合并到主清单中，然后再将主清单合并到编译变体清单中。</p>
</li>
</ol>
<p>注：build.gradle 文件中的编译配置将替换合并后的清单文件中的所有对应属性。例如，build.gradle 文件中的 minSdkVersion 将替换 <code>&lt;uses-sdk&gt;</code> 清单元素中的匹配属性。为了避免混淆，您只需省去 <code>&lt;uses-sdk&gt;</code> 元素并在 build.gradle 文件中定义这些属性。</p>
<h2 id="合并冲突启发式算法"><a href="#合并冲突启发式算法" class="headerlink" title="合并冲突启发式算法"></a>合并冲突启发式算法</h2><p>合并工具可以在逻辑上将一个清单中的每个 XML 元素与另一个清单中的对应元素相匹配。如果优先级较低的清单中的某个元素与优先级较高的清单中的任何元素都不匹配，则会将该元素添加到合并后的清单。不过，如果有匹配的元素，则合并工具会尝试将每个元素的所有属性组合到同一元素中。如果该工具发现两个清单包含相同的属性，但值不同，则会发生合并冲突。</p>
<table>
<thead>
<tr>
<th align="center">高优先级属性</th>
<th align="center">低优先级属性</th>
<th align="center">属性的合并结果</th>
</tr>
</thead>
<tbody><tr>
<td align="center">没有值</td>
<td align="center">没有值</td>
<td align="center">没有值（使用默认值）</td>
</tr>
<tr>
<td align="center">没有值</td>
<td align="center">值 B</td>
<td align="center">值 B</td>
</tr>
<tr>
<td align="center">值 A</td>
<td align="center">没有值</td>
<td align="center">值 A</td>
</tr>
<tr>
<td align="center">值 A</td>
<td align="center">值 A</td>
<td align="center">值 A</td>
</tr>
<tr>
<td align="center">值 A</td>
<td align="center">值 B</td>
<td align="center">冲突错误 - 您必须添加合并规则标记</td>
</tr>
</tbody></table>
<p>不过，在某些情况下，合并工具会采取其他行为方式以避免合并冲突：</p>
<ul>
<li><code>&lt;manifest&gt;</code> 元素中的属性绝不会合并在一起 - 仅使用优先级最高的清单中的属性。</li>
<li><code>&lt;uses-feature&gt;</code> 和 <code>&lt;uses-library&gt;</code> 元素中的 android:required 属性使用 OR 合并，这样一来，如果发生冲突，系统将应用 “true” 并始终包含某个清单所需的功能或库。</li>
<li><code>&lt;uses-sdk&gt;</code> 元素中的属性始终使用优先级较高的清单中的值，但以下情况除外：<ul>
<li>如果优先级较低的清单的 minSdkVersion 值较高，除非您应用 overrideLibrary 合并规则，否则会发生错误。</li>
<li>如果优先级较低的清单的 targetSdkVersion 值较低，合并工具将使用优先级较高的清单中的值，但也会添加所有必要的系统权限，以确保所导入的库继续正常工作（适用于较高的 Android 版本具有更多权限限制的情况）。</li>
</ul>
</li>
<li>绝不会在清单之间匹配 <code>&lt;intent-filter&gt;</code> 元素。每个该元素都被视为唯一的元素，并添加到合并后的清单中共同的父元素。</li>
</ul>
<p>对于属性之间的其他所有冲突，您将收到一条错误，并且必须通过在优先级较高的清单文件中添加一个特殊属性来指示合并工具如何解决此错误（请参阅有关合并规则标记的下一部分）。</p>
<p>不依赖于默认属性值：由于所有唯一属性都组合到同一元素中，因此如果优先级较高的清单实际上依赖于某个属性的默认值而不声明该属性，则可能会导致意外结果。例如，如果优先级较高的清单不声明 android:launchMode 属性，则会使用默认值 “standard”；但如果优先级较低的清单声明此属性具有其他值，则该值将应用于合并后的清单（替换默认值）。因此，您应该按期望明确定义每个属性。（清单参考文档中介绍了每个属性的默认值。）</p>
<h2 id="合并规则标记"><a href="#合并规则标记" class="headerlink" title="合并规则标记"></a>合并规则标记</h2><p>合并规则标记是一个 XML 属性，可用于表达您对如何解决合并冲突或移除不需要的元素和属性的偏好。您可以对整个元素应用标记，也可以只对元素中的特定属性应用标记。</p>
<p>合并两个清单文件时，合并工具会在优先级较高的清单文件中查找这些标记。</p>
<p>所有标记都属于 Android tools 命名空间，因此您必须先在 <code>&lt;manifest&gt;</code> 元素中声明此命名空间，如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">&quot;com.example.myapp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="节点标记"><a href="#节点标记" class="headerlink" title="节点标记"></a>节点标记</h3><p>向整个 XML 元素（给定清单元素中的所有属性及其所有子标记）应用合并规则：</p>
<ol>
<li><p><code>tools:node=&quot;merge&quot;</code>：如果使用合并冲突启发式算法时没有冲突，则合并此标记中的所有属性以及所有嵌套元素。这是元素的默认行为。</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// 低优先级</span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.ActivityOne&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:windowSoftInputMode</span>=<span class="string">&quot;stateUnchanged&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.SEND&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// 高优先级</span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.ActivityOne&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:screenOrientation</span>=<span class="string">&quot;portrait&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:node</span>=<span class="string">&quot;merge&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// 合并后</span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.ActivityOne&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:screenOrientation</span>=<span class="string">&quot;portrait&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:windowSoftInputMode</span>=<span class="string">&quot;stateUnchanged&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.SEND&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>tools:node=&quot;merge-only-attributes&quot;</code>：仅合并此标记中的属性，不合并嵌套元素。</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// 低优先级</span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.ActivityOne&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:windowSoftInputMode</span>=<span class="string">&quot;stateUnchanged&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.SEND&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:type</span>=<span class="string">&quot;image/*&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// 高优先级</span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.ActivityOne&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:screenOrientation</span>=<span class="string">&quot;portrait&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:node</span>=<span class="string">&quot;merge-only-attributes&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// 合并后</span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.ActivityOne&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:screenOrientation</span>=<span class="string">&quot;portrait&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:windowSoftInputMode</span>=<span class="string">&quot;stateUnchanged&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>tools:node=&quot;remove&quot;</code>：从合并后的清单中移除此元素。虽然您似乎应该只删除此元素，但如果您发现合并后的清单中有不需要的元素，而且该元素是由不受您控制的优先级较低的清单文件（如导入的库）提供的，则必须使用此属性。</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// 低优先级</span><br><span class="line"><span class="tag">&lt;<span class="name">activity-alias</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.alias&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;cow&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:value</span>=<span class="string">&quot;@string/moo&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;duck&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:value</span>=<span class="string">&quot;@string/quack&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity-alias</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// 高优先级</span><br><span class="line"><span class="tag">&lt;<span class="name">activity-alias</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.alias&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;cow&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:node</span>=<span class="string">&quot;remove&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity-alias</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// 合并后</span><br><span class="line"><span class="tag">&lt;<span class="name">activity-alias</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.alias&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;duck&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:value</span>=<span class="string">&quot;@string/quack&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity-alias</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>tools:node=&quot;removeAll&quot;</code>：与 tools:node=”remove” 类似，但它会移除与此元素类型匹配的所有元素（同一父元素内）。</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// 低优先级</span><br><span class="line"><span class="tag">&lt;<span class="name">activity-alias</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.alias&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;cow&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:value</span>=<span class="string">&quot;@string/moo&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;duck&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:value</span>=<span class="string">&quot;@string/quack&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity-alias</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// 高优先级</span><br><span class="line"><span class="tag">&lt;<span class="name">activity-alias</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.alias&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">tools:node</span>=<span class="string">&quot;removeAll&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity-alias</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// 合并后</span><br><span class="line"><span class="tag">&lt;<span class="name">activity-alias</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.alias&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity-alias</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>tools:node=&quot;replace&quot;</code>：完全替换优先级较低的元素。也就是说，如果优先级较低的清单中有匹配的元素，会将其忽略并完全按照此元素在此清单中显示的样子来使用它。</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// 低优先级</span><br><span class="line"><span class="tag">&lt;<span class="name">activity-alias</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.alias&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;cow&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:value</span>=<span class="string">&quot;@string/moo&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;duck&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:value</span>=<span class="string">&quot;@string/quack&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity-alias</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// 高优先级</span><br><span class="line"><span class="tag">&lt;<span class="name">activity-alias</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.alias&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:node</span>=<span class="string">&quot;replace&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;fox&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:value</span>=<span class="string">&quot;@string/dingeringeding&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity-alias</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// 合并后</span><br><span class="line"><span class="tag">&lt;<span class="name">activity-alias</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.alias&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta-data</span> <span class="attr">android:name</span>=<span class="string">&quot;fox&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:value</span>=<span class="string">&quot;@string/dingeringeding&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity-alias</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>tools:node=&quot;strict&quot;</code>：每当此元素在优先级较低的清单中与在优先级较高的清单中不完全匹配时，都会导致编译失败（除非已通过其他合并规则标记解决）。这将替换合并冲突启发式算法。例如，如果优先级较低的清单只是包含一个额外的属性，则编译将会失败（而默认行为会将该额外属性添加到合并后的清单）。</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// 低优先级</span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.ActivityOne&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:windowSoftInputMode</span>=<span class="string">&quot;stateUnchanged&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.SEND&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// 高优先级</span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.ActivityOne&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:screenOrientation</span>=<span class="string">&quot;portrait&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:node</span>=<span class="string">&quot;strict&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p> 这会生成清单合并错误。 这两个清单元素在严格模式下完全无法区分。因此，您必须应用其他合并规则标记来解决这些差异。（通常，这两个元素会很好地合并在一起，如上面的 tools:node=”merge” 示例中所示。）</p>
</li>
</ol>
<h3 id="属性标记"><a href="#属性标记" class="headerlink" title="属性标记"></a>属性标记</h3><ol>
<li><p><code>tools:remove=&quot;attr, ...&quot;</code>：从合并后的清单中移除指定属性。虽然您似乎可以只删除这些属性，但如果优先级较低的清单文件不包含这些属性，而且您希望确保不将它们纳入合并后的清单，则必须使用此属性。</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 低优先级</span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.ActivityOne&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:windowSoftInputMode</span>=<span class="string">&quot;stateUnchanged&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// 高优先级</span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.ActivityOne&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:screenOrientation</span>=<span class="string">&quot;portrait&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:remove</span>=<span class="string">&quot;android:windowSoftInputMode&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//合并后</span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.ActivityOne&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:screenOrientation</span>=<span class="string">&quot;portrait&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>tools:replace=&quot;attr, ...&quot;</code>：将优先级较低的清单中的指定属性替换为此清单中的属性。换句话说，始终保留优先级较高的清单的值。</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// 低优先级</span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.ActivityOne&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:theme</span>=<span class="string">&quot;@oldtheme&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:windowSoftInputMode</span>=<span class="string">&quot;stateUnchanged&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// 高优先级</span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.ActivityOne&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:theme</span>=<span class="string">&quot;@newtheme&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:screenOrientation</span>=<span class="string">&quot;portrait&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:replace</span>=<span class="string">&quot;android:theme,android:exported&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//合并后</span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.ActivityOne&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:theme</span>=<span class="string">&quot;@newtheme&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:screenOrientation</span>=<span class="string">&quot;portrait&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:windowSoftInputMode</span>=<span class="string">&quot;stateUnchanged&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>tools:strict=&quot;attr, ...&quot;</code>：每当这些属性在优先级较低的清单中与在优先级较高的清单中不完全匹配时，都会导致编译失败。这是所有属性的默认行为，但具有特殊行为的属性除外，如合并冲突启发式算法中所述。</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// 低优先级</span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.ActivityOne&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:screenOrientation</span>=<span class="string">&quot;landscape&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// 高优先级</span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.ActivityOne&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:screenOrientation</span>=<span class="string">&quot;portrait&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:strict</span>=<span class="string">&quot;android:screenOrientation&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p> 这会生成清单合并错误。 您必须应用其他合并规则标记来解决冲突。（切记：这是默认行为，因此如果您移除 tools:strict=”screenOrientation”，上面的示例将具有相同的结果。）</p>
</li>
<li><p>也可以对一个元素应用多个标记</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// 低优先级</span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.ActivityOne&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:theme</span>=<span class="string">&quot;@oldtheme&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:allowTaskReparenting</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:windowSoftInputMode</span>=<span class="string">&quot;stateUnchanged&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// 高优先级</span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.ActivityOne&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:theme</span>=<span class="string">&quot;@newtheme&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:screenOrientation</span>=<span class="string">&quot;portrait&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:replace</span>=<span class="string">&quot;android:theme,android:exported&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:remove</span>=<span class="string">&quot;android:windowSoftInputMode&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//合并后</span><br><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">&quot;com.example.ActivityOne&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:theme</span>=<span class="string">&quot;@newtheme&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:allowTaskReparenting</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:screenOrientation</span>=<span class="string">&quot;portrait&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="标记选择器"><a href="#标记选择器" class="headerlink" title="标记选择器"></a>标记选择器</h3><p>如果要仅对导入的特定库应用合并规则标记，请添加带有库软件包名称的 tools:selector 属性。例如，对于下面的清单，只有在优先级较低的清单文件来自 com.example.lib1 库时，才会应用 remove 合并规则。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">permission</span> <span class="attr">android:name</span>=<span class="string">&quot;permissionOne&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:node</span>=<span class="string">&quot;remove&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:selector</span>=<span class="string">&quot;com.example.lib1&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果优先级较低的清单来自其他任何来源，系统将会忽略 remove 合并规则。</p>
<p>注意：如果将此属性与某个属性标记一起使用，则它会应用于该标记中指定的所有属性。</p>
<h3 id="替换导入的库的-lt-uses-sdk-gt"><a href="#替换导入的库的-lt-uses-sdk-gt" class="headerlink" title="替换导入的库的 &lt;uses-sdk&gt;"></a>替换导入的库的 <code>&lt;uses-sdk&gt;</code></h3><p>默认情况下，导入 minSdkVersion 值高于主清单文件的库时会出错，而且无法导入该库。要使合并工具忽略此冲突并导入库，同时保留应用的较低 minSdkVersion 值，请将 overrideLibrary 属性添加到 <code>&lt;uses-sdk&gt;</code> 标记。属性值可以是一个或多个库软件包名称（用英文逗号分隔），指明可以替换主清单的 minSdkVersion 的库。</p>
<p>例如，如果应用的主清单按如下方式应用 overrideLibrary：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">package</span>=<span class="string">&quot;com.example.app&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span> <span class="attr">tools:overrideLibrary</span>=<span class="string">&quot;com.example.lib1, com.example.lib2&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>则以下清单可以合并，而不会出现与 <code>&lt;uses-sdk&gt;</code> 标记相关的错误，合并后的清单将保留应用清单中的 minSdkVersion=”2”。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">package</span>=<span class="string">&quot;com.example.lib1&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span> <span class="attr">android:minSdkVersion</span>=<span class="string">&quot;4&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="隐式系统权限"><a href="#隐式系统权限" class="headerlink" title="隐式系统权限"></a>隐式系统权限</h3><p>一些曾经可由应用自由访问的 Android API 在最新的 Android 版本中受到了系统权限的限制。为了避免中断预期会访问这些 API 的应用，最新的 Android 版本允许应用在无权限的情况下继续访问这些 API，前提是它们已将 targetSdkVersion 设为低于添加限制的版本的值。此行为会有效地向应用授予隐式权限，以允许访问这些 API。因此，这可能会对具有不同 targetSdkVersion 值的合并后的清单产生以下影响。</p>
<p>如果优先级较低的清单文件具有较低的 targetSdkVersion 值，因而为其提供了一项隐式权限，但优先级较高的清单不具备相同的隐式权限（因为它的 targetSdkVersion 等于或高于添加限制的版本），则合并工具会向合并后的清单明确添加相应的系统权限。</p>
<p>例如，如果您的应用将 targetSdkVersion 设为 4 或更高的值，但导入的某个库将 targetSdkVersion 设为 3 或更低的值，则合并工具会向合并后的清单添加 WRITE_EXTERNAL_STORAGE 权限。</p>
<p>注意：如果您已将应用的 targetSdkVersion 设为 23 或更高的值，那么当应用试图访问受任何危险权限保护的 API 时，您必须对这些权限执行运行时权限请求。</p>
<table>
<thead>
<tr>
<th align="center">优先级较低的清单声明</th>
<th align="center">向合并后的清单添加的权限</th>
</tr>
</thead>
<tbody><tr>
<td align="center">targetSdkVersion 为 3 或更低的值</td>
<td align="center">WRITE_EXTERNAL_STORAGE、READ_PHONE_STATE</td>
</tr>
<tr>
<td align="center">targetSdkVersion 为 15 或更低的值，并且使用 READ_CONTACTS</td>
<td align="center">READ_CALL_LOG</td>
</tr>
<tr>
<td align="center">targetSdkVersion 为 15 或更低的值，并且使用 WRITE_CONTACTS</td>
<td align="center">WRITE_CALL_LOG</td>
</tr>
</tbody></table>
<h2 id="检查合并后的清单并查找冲突"><a href="#检查合并后的清单并查找冲突" class="headerlink" title="检查合并后的清单并查找冲突"></a>检查合并后的清单并查找冲突</h2><p>可以通过Android Studio提供的工具查看合并后的Manifest文件。</p>
<h2 id="合并策略"><a href="#合并策略" class="headerlink" title="合并策略"></a>合并策略</h2><p>清单合并工具可以在逻辑上将一个清单文件中的每个 XML 元素与另一个文件中的对应元素匹配。合并工具会使用“匹配键”来匹配每个元素，匹配键可以是唯一的属性值（如 android:name），也可以是标记本身的自然唯一性（例如，只能有一个 &lt;<code>supports-screen&gt;</code> 元素）。如果两个清单具有相同的 XML 元素，则该工具会采用三种合并策略中的一种，将这两个元素合并在一起：</p>
<ul>
<li>合并：将所有非冲突属性组合到同一标记中，并按各自的合并策略合并子元素。如果任何属性相互冲突，使用合并规则标记将它们合并在一起。</li>
<li>仅合并子元素：不组合或合并属性（仅保留优先级最高的清单文件提供的属性），并按各自的合并策略合并子元素。</li>
<li>保留：将元素“按原样”保留，并将其添加到合并后的文件中的共同父元素。只有在可接受同一元素的多个声明时，才会采用此策略。</li>
</ul>
<img src="清单元素合并策略和匹配键.png"/>

<h1 id="将构建变量注入Manifest"><a href="#将构建变量注入Manifest" class="headerlink" title="将构建变量注入Manifest"></a>将构建变量注入Manifest</h1><p>如果需要将build.gradle中的变量注入到Manifest中，可以使用manifestPlaceholders属性：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        manifestPlaceholders = [<span class="attr">hostName:</span><span class="string">&quot;www.example.com&quot;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在Manifest中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">intent-filter</span> <span class="attr">...</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:scheme</span>=<span class="string">&quot;http&quot;</span> <span class="attr">android:host</span>=<span class="string">&quot;$&#123;hostName&#125;&quot;</span> <span class="attr">...</span> /&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>默认情况下，构建工具还会在${applicationId}占位符中提供应用程序的应用程序ID，该值始终与当前构建的最终应用程序ID匹配（包括构建变体的更改）。</p>
<p>例如，如果build.gradle中如下配置：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId <span class="string">&quot;com.example.myapp&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    productFlavors &#123;</span><br><span class="line">        free &#123;</span><br><span class="line">            applicationIdSuffix <span class="string">&quot;.free&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        pro &#123;</span><br><span class="line">            applicationIdSuffix <span class="string">&quot;.pro&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在Manifest中可以如下配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">intent-filter</span> <span class="attr">...</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;$&#123;applicationId&#125;.TRANSMOGRIFY&quot;</span> /&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="自定义BuildConfig"><a href="#自定义BuildConfig" class="headerlink" title="自定义BuildConfig"></a>自定义BuildConfig</h1><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;PLUGIN_NAME&quot;</span>, <span class="string">&quot;\&quot;$&#123;plugin_name&#125;\&quot;&quot;</span>)</span><br><span class="line">            buildConfigField(<span class="string">&quot;int&quot;</span>, <span class="string">&quot;PLUGIN_VERSION&quot;</span>, <span class="string">&quot;$&#123;plugin_version&#125;&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="压缩代码和资源"><a href="#压缩代码和资源" class="headerlink" title="压缩代码和资源"></a>压缩代码和资源</h1><p>代码压缩通过 ProGuard 提供，ProGuard 会检测和移除封装应用中未使用的类、字段、方法和属性，包括自带代码库中的未使用项（这使其成为以变通方式解决 64k 引用限制的有用工具）。ProGuard 还可优化字节码，移除未使用的代码指令，以及用短名称混淆其余的类、字段和方法。混淆过的代码可令您的 APK 难以被逆向工程，这在应用使用许可验证等安全敏感性功能时特别有用。</p>
<h2 id="压缩代码"><a href="#压缩代码" class="headerlink" title="压缩代码"></a>压缩代码</h2><h3 id="压缩代码-1"><a href="#压缩代码-1" class="headerlink" title="压缩代码"></a>压缩代码</h3><p>要通过 ProGuard 启用代码压缩，请在 build.gradle 文件内相应的构建类型中添加 <code>minifyEnabled true</code>。请注意，代码压缩会拖慢构建速度，因此您应该尽可能避免在调试构建中使用。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="literal">true</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android.txt&#x27;</span>),</span><br><span class="line">                    <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>getDefaultProguardFile(‘proguard-android.txt’) 方法可从 Android SDK tools/proguard/ 文件夹获取默认的 ProGuard 设置。提示：要想做进一步的代码压缩，请尝试使用位于同一位置的 proguard-android-optimize.txt 文件。它包括相同的 ProGuard 规则，但还包括其他在字节码一级（方法内和方法间）执行分析的优化，以进一步减小 APK 大小和帮助提高其运行速度。</li>
<li>proguard-rules.pro 文件用于添加自定义 ProGuard 规则。默认情况下，该文件位于模块根目录（build.gradle 文件旁）。</li>
</ul>
<p>要添加更多各构建变体专用的 ProGuard 规则，请在相应的 productFlavor 代码块中再添加一个 proguardFiles 属性。例如，以下 Gradle 文件会向 flavor2 产品定制添加 flavor2-rules.pro。现在 flavor2 使用所有三个 ProGuard 规则，因为还应用了来自 release 代码块的规则。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="literal">true</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android.txt&#x27;</span>),</span><br><span class="line">                   <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    productFlavors &#123;</span><br><span class="line">        flavor1 &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        flavor2 &#123;</span><br><span class="line">            proguardFile <span class="string">&#x27;flavor2-rules.pro&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每次构建时 ProGuard 都会输出下列文件：</p>
<ul>
<li>dump.txt：说明 APK 中所有类文件的内部结构。</li>
<li>mapping.txt：提供原始与混淆过的类、方法和字段名称之间的转换。</li>
<li>seeds.txt：列出未进行混淆的类和成员。</li>
<li>usage.txt：列出从 APK 移除的代码。</li>
</ul>
<p>这些文件保存在 <code>&lt;module-name&gt;/build/outputs/mapping/release/</code> 中。</p>
<h3 id="自定义要保留的代码"><a href="#自定义要保留的代码" class="headerlink" title="自定义要保留的代码"></a>自定义要保留的代码</h3><p>对于某些情况，默认 ProGuard 配置文件 (proguard-android.txt) 足以满足需要，ProGuard 会移除所有（并且只会移除）未使用的代码。不过，ProGuard 难以对许多情况进行正确分析，可能会移除应用真正需要的代码。举例来说，它可能错误移除代码的情况包括：</p>
<ul>
<li>当应用引用的类只来自 AndroidManifest.xml 文件时</li>
<li>当应用调用的方法来自 Java 原生接口 (JNI) 时</li>
<li>当应用在运行时（例如使用反射或自检）操作代码时</li>
</ul>
<p>测试应用应该能够发现因不当移除的代码而导致的错误，但您也可以通过查看 <code>&lt;module-name&gt;/build/outputs/mapping/release/</code> 中保存的 usage.txt 输出文件来检查移除了哪些代码。</p>
<p>要修正错误并强制 ProGuard 保留特定代码，请在 ProGuard 配置文件中添加一行 -keep 代码。例如：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-keep <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br></pre></td></tr></table></figure>

<p>或者，您可以向您想保留的代码添加 @Keep 注解。在类上添加 @Keep 可原样保留整个类。在方法或字段上添加它可完整保留方法/字段（及其名称）以及类名称。请注意，只有在使用注解支持库时，才能使用此注解。</p>
<p>在使用 -keep 选项时，有许多事项需要考虑；如需了解有关自定义配置文件的详细信息，请阅读 <a target="_blank" rel="noopener" href="http://stuff.mit.edu/afs/sipb/project/android/sdk/android-sdk-linux/tools/proguard/docs/index.html#manual/introduction.html">ProGuard 手册</a>。<a target="_blank" rel="noopener" href="http://stuff.mit.edu/afs/sipb/project/android/sdk/android-sdk-linux/tools/proguard/docs/index.html#manual/troubleshooting.html">问题排查</a>一章概述了您可能会在混淆代码时遇到的其他常见问题。</p>
<h3 id="解码混淆后的代码"><a href="#解码混淆后的代码" class="headerlink" title="解码混淆后的代码"></a>解码混淆后的代码</h3><p>ProGuard 每次运行时都会创建一个 mapping.txt 文件，其中显示了与混淆过的名称对应的原始类名称、方法名称和字段名称。ProGuard 将该文件保存在应用的 <code>&lt;module-name&gt;/build/outputs/mapping/release/</code> 目录中。</p>
<p>要自行将混淆过的堆栈追踪转换成可读的堆栈追踪，请使用 retrace 脚本（在 Windows 上为 retrace.bat；在 Mac/Linux 上为 retrace.sh）。它位于 <code>&lt;sdk-root&gt;/tools/proguard/</code> 目录中。该脚本利用 mapping.txt 文件和您的堆叠追踪生成新的可读堆叠追踪。使用 retrace 工具的语法如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">retrace.bat|retrace.sh [-verbose] mapping.txt [&lt;stacktrace_file&gt;]</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">retrace.bat -verbose mapping.txt obfuscated_trace.txt</span><br></pre></td></tr></table></figure>

<p>如果您不指定堆栈追踪文件，retrace 工具会从标准输入读取。</p>
<h3 id="通过-Instant-Run-启用代码压缩"><a href="#通过-Instant-Run-启用代码压缩" class="headerlink" title="通过 Instant Run 启用代码压缩"></a>通过 Instant Run 启用代码压缩</h3><p>Android 插件压缩器不会对您的代码进行混淆处理或优化，它只会删除未使用的代码。因此，您应该仅将其用于调试构建，并为发布构建启用 ProGuard，以便对发布 APK 的代码进行混淆处理和优化。</p>
<p>要启用 Android 插件压缩器，只需在 “debug” 构建类型中将 useProguard 设置为 false（并保留 minifyEnabled 设置 true）：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        debug &#123;</span><br><span class="line">            minifyEnabled <span class="literal">true</span></span><br><span class="line">            useProguard <span class="literal">false</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android.txt&#x27;</span>),</span><br><span class="line">                    <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="literal">true</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android.txt&#x27;</span>),</span><br><span class="line">                    <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="压缩资源"><a href="#压缩资源" class="headerlink" title="压缩资源"></a>压缩资源</h2><h3 id="压缩资源-1"><a href="#压缩资源-1" class="headerlink" title="压缩资源"></a>压缩资源</h3><p>资源压缩只与代码压缩协同工作。代码压缩器移除所有未使用的代码后，资源压缩器便可确定应用仍然使用的资源。这在您添加包含资源的代码库时体现得尤为明显 - 您必须移除未使用的库代码，使库资源变为未引用资源，才能通过资源压缩器将它们移除。</p>
<p>要启用资源压缩，请在 build.gradle 文件中将 shrinkResources 属性设置为 true（在用于代码压缩的 minifyEnabled 旁边）。例如：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            shrinkResources <span class="literal">true</span></span><br><span class="line">            minifyEnabled <span class="literal">true</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android.txt&#x27;</span>),</span><br><span class="line">                    <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果您尚未使用代码压缩用途的 minifyEnabled 构建应用，请先尝试使用它，然后再启用 shrinkResources，因为您可能需要编辑 proguard-rules.pro 文件以保留动态创建或调用的类或方法，然后再开始移除资源。</p>
<p>注：资源压缩器目前不会移除 values/ 文件夹中定义的资源（例如字符串、尺寸、样式和颜色）。这是因为 Android 资源打包工具 (AAPT) 不允许 Gradle 插件为资源指定预定义版本。</p>
<h3 id="自定义要保留的资源"><a href="#自定义要保留的资源" class="headerlink" title="自定义要保留的资源"></a>自定义要保留的资源</h3><p>如果您有想要保留或舍弃的特定资源，请在您的项目中创建一个包含 <code>&lt;resources&gt;</code> 标记的 XML 文件，并在 tools:keep 属性中指定每个要保留的资源，在 tools:discard 属性中指定每个要舍弃的资源。这两个属性都接受逗号分隔的资源名称列表。您可以使用星号字符作为通配符。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resources</span> <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:keep</span>=<span class="string">&quot;@layout/l_used*_c,@layout/l_used_a,@layout/l_used_b*&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:discard</span>=<span class="string">&quot;@layout/unused2&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>将该文件保存在项目资源中，例如，保存在 res/raw/keep.xml。构建不会将该文件打包到 APK 之中。</p>
<p>指定要舍弃的资源可能看似愚蠢，因为您本可将它们删除，但在使用构建变体时，这样做可能很有用。例如，如果您明知给定资源表面上会在代码中使用（并因此不会被压缩器移除），但实际不会用于给定构建变体，就可以将所有资源放入公用项目目录，然后为每个构建变体创建一个不同的 keep.xml 文件。构建工具也可能无法根据需要正确识别资源，这是因为编译器会添加内联资源 ID，而资源分析器可能不知道真正引用的资源和恰巧具有相同值的代码中的整数值之间的差别。</p>
<h3 id="启用严格引用检查"><a href="#启用严格引用检查" class="headerlink" title="启用严格引用检查"></a>启用严格引用检查</h3><p>正常情况下，资源压缩器可准确判定系统是否使用了资源。不过，如果您的代码调用 Resources.getIdentifier()（或您的任何库进行了这一调用 - AppCompat 库会执行该调用），这就表示您的代码将根据动态生成的字符串查询资源名称。当您执行这一调用时，默认情况下资源压缩器会采取防御性行为，将所有具有匹配名称格式的资源标记为可能已使用，无法移除。</p>
<p>例如，以下代码会使所有带 img_ 前缀的资源标记为已使用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String name = String.format(<span class="string">&quot;img_%1d&quot;</span>, angle + <span class="number">1</span>);</span><br><span class="line">res = getResources().getIdentifier(name, <span class="string">&quot;drawable&quot;</span>, getPackageName());</span><br></pre></td></tr></table></figure>

<p>资源压缩器还会浏览代码以及各种 res/raw/ 资源中的所有字符串常量，寻找格式类似于 <code>file:///android_res/drawable//ic_plus_anim_016.png</code> 的资源网址。如果它找到与其类似的字符串，或找到其他看似可用来构建与其类似的网址的字符串，则不会将它们移除。</p>
<p>这些是默认情况下启用的安全压缩模式的示例。但您可以停用这一“有备无患”处理方式，并指定资源压缩器只保留其确定已使用的资源。要执行此操作，请在 keep.xml 文件中将 shrinkMode 设置为 strict，如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resources</span> <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:shrinkMode</span>=<span class="string">&quot;strict&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果您确已启用严格压缩模式，并且代码也引用了包含动态生成字符串的资源（如上所示），则必须利用 tools:keep 属性手动保留这些资源。</p>
<h3 id="移除未使用的备用资源"><a href="#移除未使用的备用资源" class="headerlink" title="移除未使用的备用资源"></a>移除未使用的备用资源</h3><p>Gradle 资源压缩器只会移除未被您的应用代码引用的资源，这意味着它不会移除用于不同设备配置的备用资源。必要时，您可以使用 Android Gradle 插件的 resConfigs 属性来移除您的应用不需要的备用资源文件。</p>
<p>例如，如果您使用的库包含语言资源（例如使用的是 AppCompat 或 Google Play 服务），则 APK 将包括这些库中消息的所有已翻译语言字符串，无论应用的其余部分是否翻译为同一语言。如果您想只保留应用正式支持的语言，则可以利用 resConfig 属性指定这些语言。系统会移除未指定语言的所有资源。</p>
<p>下面这段代码展示了如何将语言资源限定为仅支持英语和法语：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        ...</span><br><span class="line">        resConfigs <span class="string">&quot;en&quot;</span>, <span class="string">&quot;fr&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同理，您也可以利用 APK 拆分为不同设备构建不同的 APK，自定义在 APK 中包括的屏幕密度或 ABI 资源。</p>
<h3 id="合并重复资源"><a href="#合并重复资源" class="headerlink" title="合并重复资源"></a>合并重复资源</h3><p>默认情况下，Gradle 还会合并同名资源，例如可能位于不同资源文件夹中的同名可绘制对象。这一行为不受 shrinkResources 属性控制，也无法停用，因为在有多个资源匹配代码查询的名称时，有必要利用这一行为来避免错误。</p>
<p>只有在两个或更多个文件具有完全相同的资源名称、类型和限定符时，才会进行资源合并。Gradle 会在重复项中选择其视为最佳选择的文件（根据下述优先顺序），并只将这一个资源传递给 AAPT，以供在 APK 文件中分发。</p>
<p>Gradle 会在下列位置寻找重复资源：</p>
<ul>
<li><p>与主源集关联的主资源，一般位于 src/main/res/ 中。</p>
</li>
<li><p>变体叠加，来自构建类型和构建风味。</p>
</li>
<li><p>库项目依赖项。<br>G<br>radle 会按以下级联优先顺序合并重复资源：</p>
</li>
<li><p>依赖项 → 主资源 → 构建风格 → 构建类型</p>
</li>
</ul>
<p>例如，如果某个重复资源同时出现在主资源和构建风味中，Gradle 会选择构建风格中的重复资源。</p>
<p>如果完全相同的资源出现在同一源集中，Gradle 无法合并它们，并且会发出资源合并错误。如果您在 build.gradle 文件的 sourceSet 属性中定义了多个源集，则可能会发生这种情况，例如，如果 src/main/res/ 和 src/main/res2/ 包含完全相同的资源，就可能会发生这种情况。</p>
<h3 id="排查资源压缩问题"><a href="#排查资源压缩问题" class="headerlink" title="排查资源压缩问题"></a>排查资源压缩问题</h3><p>当您压缩资源时，Gradle Console 会显示它从应用软件包中移除的资源的摘要。例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">:android:shrinkDebugResources</span><br><span class="line">Removed unused resources: Binary resource data reduced from 2570KB to 1711KB: Removed 33%</span><br><span class="line">:android:validateDebugSigning</span><br></pre></td></tr></table></figure>

<p>Gradle 还会在 <code>&lt;module-name&gt;/build/outputs/mapping/release/</code>（ProGuard 输出文件所在的文件夹）中创建一个名为 resources.txt 的诊断文件。该文件包括诸如哪些资源引用了其他资源以及使用或移除了哪些资源等详情。</p>
<p>例如，要了解您的 APK 为何仍包含 @drawable/ic_plus_anim_016，请打开 resources.txt 文件并搜索该文件名。您可能会发现，有其他资源引用了它，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">16:25:48.005 [QUIET] [system.out] @drawable&#x2F;add_schedule_fab_icon_anim : reachable&#x3D;true</span><br><span class="line">16:25:48.009 [QUIET] [system.out]     @drawable&#x2F;ic_plus_anim_016</span><br></pre></td></tr></table></figure>

<p>现在您需要了解为何 @drawable/add_schedule_fab_icon_anim 可以访问 - 如果您向上搜索，就会发现“The root reachable resources are:”之下列有该资源。这意味着存在对 add_schedule_fab_icon_anim 的代码引用（即在可访问代码中找到了其 R.drawable ID）。</p>
<p>如果您使用的不是严格检查，则存在看似可用于为动态加载资源构建资源名称的字符串常量时，可将资源 ID 标记为可访问。在这种情况下，如果您在构建输出中搜索资源名称，可能会找到类似下面这样的消息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">10:32:50.590 [QUIET] [system.out] Marking drawable:ic_plus_anim_016:2130837506</span><br><span class="line">    used because it format-string matches string pool constant ic_plus_anim_%1$d.</span><br></pre></td></tr></table></figure>

<p>如果您看到一个这样的字符串，并且您能确定该字符串未用于动态加载给定资源，就可以按照有关如何自定义要保留的资源部分中所述利用 tools:discard 属性通知构建系统将它移除。</p>
<h1 id="多DEX文件"><a href="#多DEX文件" class="headerlink" title="多DEX文件"></a>多DEX文件</h1><h2 id="关于“64K-引用限制”"><a href="#关于“64K-引用限制”" class="headerlink" title="关于“64K 引用限制”"></a>关于“64K 引用限制”</h2><p>Android 应用 (APK) 文件包含 Dalvik Executable (DEX) 文件形式的可执行字节码文件，这些文件包含用来运行应用的已编译代码。Dalvik Executable 规范将可在单个 DEX 文件内引用的方法总数限制为 65,536，其中包括 Android 框架方法、库方法以及您自己的代码中的方法。这一限制称为“64K 引用限制”。</p>
<p>Android 5.0（API 级别 21）之前的平台版本使用 Dalvik 运行时来执行应用代码。默认情况下，Dalvik 将应用限制为每个 APK 只能使用一个 classes.dex 字节码文件。要绕过这一限制，您可以在您的项目中添加多 dex 文件支持库：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    implementation <span class="string">&#x27;androidx.multidex:multidex:2.0.1&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果您不使用 AndroidX，请改为添加以下支持库依赖项：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    implementation <span class="string">&#x27;com.android.support:multidex:1.0.3&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此库会成为应用的主要 DEX 文件的一部分，然后管理对其他 DEX 文件及其所包含代码的访问。</p>
<p>Android 5.0（API 级别 21）及更高版本使用名为 ART 的运行时，它本身支持从 APK 文件加载多个 DEX 文件。ART 在应用安装时执行预编译，扫描 classesN.dex 文件，并将它们编译成单个 .oat 文件，以供 Android 设备执行。因此，如果您的 minSdkVersion 为 21 或更高的值，则不需要多 dex 文件支持库。</p>
<h2 id="多DEX配置"><a href="#多DEX配置" class="headerlink" title="多DEX配置"></a>多DEX配置</h2><p>将您的应用项目设为使用多 dex 文件配置要求您对应用项目进行以下修改，具体取决于应用支持的最低 Android 版本。</p>
<p>如果您的 minSdkVersion 设为 21 或更高的值，您只需在模块级 build.gradle 文件中将 multiDexEnabled 设为 true，如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        ...</span><br><span class="line">        minSdkVersion <span class="number">21</span></span><br><span class="line">        targetSdkVersion <span class="number">28</span></span><br><span class="line">        multiDexEnabled <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不过，如果您的 minSdkVersion 设为 20 或更低的值，则您必须使用多 dex 文件支持库，具体操作步骤如下：</p>
<ol>
<li><p>修改模块级 build.gradle 文件以启用多 dex 文件，并将多 dex 文件库添加为依赖项，如下所示：</p>
 <figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        ...</span><br><span class="line">        minSdkVersion <span class="number">15</span></span><br><span class="line">        targetSdkVersion <span class="number">28</span></span><br><span class="line">        multiDexEnabled <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile <span class="string">&#x27;com.android.support:multidex:1.0.3&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据是否替换 Application 类，执行以下某项操作：</p>
<ul>
<li><p>如果您不替换 Application 类，请修改清单文件以设置 <code>&lt;application&gt;</code> 标记中的 android:name，如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">&quot;com.example.myapp&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;android.support.multidex.MultiDexApplication&quot;</span> &gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>如果您替换 Application 类，请对其进行更改以扩展 MultiDexApplication（如果可能），如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">MultiDexApplication</span> </span>&#123; ... &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>或者，如果您替换 Application 类，但无法更改基类，则可以改为替换 attachBaseContext() 方法并调用 MultiDex.install(this) 来启用多 dex 文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">SomeOtherApplication</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">attachBaseContext</span><span class="params">(Context base)</span> </span>&#123;</span><br><span class="line">     <span class="keyword">super</span>.attachBaseContext(base);</span><br><span class="line">     MultiDex.install(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：在 MultiDex.install() 完成之前，不要通过反射或 JNI 执行 MultiDex.install() 或其他任何代码。多 dex 文件跟踪功能不会追踪这些调用，从而导致出现 ClassNotFoundException，或因 DEX 文件之间的类分区错误而导致验证错误。</p>
</li>
</ul>
</li>
</ol>
<p>现在，当您编译应用时，Android 编译工具会根据需要构造主要 DEX 文件 (classes.dex) 和辅助 DEX 文件（classes2.dex 和 classes3.dex 等）。然后，编译系统会将所有 DEX 文件打包到您的 APK 中。</p>
<p>在运行时，多 dex 文件 API 使用特殊的类加载器来搜索适用于您的方法的所有 DEX 文件（而不是只在主 classes.dex 文件中搜索）。</p>
<p>多 dex 文件支持库具有一些已知的局限性，将其纳入您的应用编译配置时，您应注意这些局限性并进行针对性的测试：</p>
<ul>
<li>启动期间在设备的数据分区上安装 DEX 文件的过程相当复杂，如果辅助 DEX 文件较大，可能会导致应用无响应 (ANR) 错误。在这种情况下，您应通过 ProGuard 应用代码压缩，以尽量减小 DEX 文件的大小，并移除未使用的那部分代码。</li>
<li>当运行的版本低于 Android 5.0（API 级别 21）时，使用多 dex 文件不足以避开 linearalloc 限制（<a target="_blank" rel="noopener" href="http://b.android.com/78035">问题 78035</a>）。此上限在 Android 4.0（API 级别 14）中有所提高，但这并未完全解决该问题。在低于 Android 4.0 的版本中，您可能会在达到 DEX 索引限制之前达到 linearalloc 限制。因此，如果您的目标 API 级别低于 14，请在这些版本的平台上进行全面测试，因为您的应用可能会在启动时或加载特定类组时出现问题。</li>
</ul>
<h2 id="声明主要-DEX-文件中必需的类"><a href="#声明主要-DEX-文件中必需的类" class="headerlink" title="声明主要 DEX 文件中必需的类"></a>声明主要 DEX 文件中必需的类</h2><p>为多 dex 文件应用编译每个 DEX 文件时，编译工具会执行复杂的决策制定来确定主要 DEX 文件中需要的类，以便您的应用能够成功启动。如果主要 DEX 文件中未提供启动期间需要的任何类，则您的应用会崩溃并出现 java.lang.NoClassDefFoundError 错误。</p>
<p>对于直接从您的应用代码访问的代码，不应发生这种情况，因为编译工具可以识别这些代码路径。但是，当代码路径的可见性较低时（例如，当您使用的库具有复杂的依赖项时），可能会发生这种情况。例如，如果代码使用自检机制或从原生代码调用 Java 方法，那么可能不会将这些类识别为主要 DEX 文件中的必需类。</p>
<p>因此，如果您收到 java.lang.NoClassDefFoundError，则必须使用版本类型中的 multiDexKeepFile 或 multiDexKeepProguard 属性声明这些其他类，以手动将这些类指定为主要 DEX 文件中的必需类。如果某个类在 multiDexKeepFile 或 multiDexKeepProguard 文件中匹配到，则会将该类添加到主要 DEX 文件。</p>
<h3 id="multiDexKeepFile-属性"><a href="#multiDexKeepFile-属性" class="headerlink" title="multiDexKeepFile 属性"></a>multiDexKeepFile 属性</h3><p>您在 multiDexKeepFile 中指定的文件应该每行包含一个类，并且类采用 com/example/MyClass.class 格式。例如，您可以创建一个名为 multidex-config.txt 的文件，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">com&#x2F;example&#x2F;MyClass.class</span><br><span class="line">com&#x2F;example&#x2F;MyOtherClass.class</span><br></pre></td></tr></table></figure>

<p>然后，您可以针对版本类型声明该文件，如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            multiDexKeepFile file(<span class="string">&#x27;multidex-config.txt&#x27;</span>)</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请注意，Gradle 会读取相对于 build.gradle 文件的路径，因此如果 multidex-config.txt 与 build.gradle 文件在同一目录中，以上示例将有效。</p>
<h3 id="multiDexKeepProguard-属性"><a href="#multiDexKeepProguard-属性" class="headerlink" title="multiDexKeepProguard 属性"></a>multiDexKeepProguard 属性</h3><p>multiDexKeepProguard 文件使用与 Proguard 相同的格式，并且支持全部 Proguard 语法。如需详细了解 Proguard 格式和语法，请参阅 Proguard 手册中的 <a target="_blank" rel="noopener" href="http://proguard.sourceforge.net/manual/usage.html#keepoptions">Keep 选项</a> 一节。</p>
<p>您在 multiDexKeepProguard 中指定的文件应该在任何有效的 ProGuard 语法中包含 -keep 选项。例如，-keep com.example.MyClass.class。您可以创建一个名为 multidex-config.pro 的文件，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-keep class com.example.MyClass</span><br><span class="line">-keep class com.example.MyClassToo</span><br></pre></td></tr></table></figure>

<p>如果您要指定软件包中的所有类，文件将如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-keep class com.example.** &#123; *; &#125; &#x2F;&#x2F; All classes in the com.example package</span><br></pre></td></tr></table></figure>

<p>然后，您可以针对版本类型声明该文件，如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            multiDexKeepProguard file(<span class="string">&#x27;multidex-config.pro&#x27;</span>)</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="在开发编译中优化多-dex-文件"><a href="#在开发编译中优化多-dex-文件" class="headerlink" title="在开发编译中优化多 dex 文件"></a>在开发编译中优化多 dex 文件</h2><p>多 dex 文件配置会大幅增加编译处理时间，因为编译系统必须就哪些类必须包含在主要 DEX 文件中以及哪些类可以包含在辅助 DEX 文件中做出复杂的决策。这意味着，使用多 dex 文件的增量编译通常耗时较长，可能会拖慢您的开发进度。</p>
<p>要缩短较长的增量编译时间，您应使用 dex 预处理在编译之间重用多 dex 文件输出。dex 预处理依赖于一种只在 Android 5.0（API 级别 21）及更高版本中提供的 ART 格式。如果您使用的是 Android Studio 2.3 及更高版本，那么在将您的应用部署到搭载 Android 5.0（API 级别 21）或更高版本的设备上时，IDE 会自动使用此功能。</p>
<p>提示：Android Plugin for Gradle 3.0.0 及更高版本得到了进一步改进来优化编译速度，如每个类的 dex 处理（这样，只有您修改的类会重新进行 dex 处理）。一般来说，为了获得最佳开发体验，您应始终升级到最新版 Android Studio 和 Android 插件。</p>
<p>不过，如果您是从命令行运行 Gradle 编译，则需要将 minSdkVersion 设为 21 或更高的值以启用 dex 预处理。要保留正式版的设置，一种有用的策略是使用产品类型（一个开发类型和一个发布类型，它们具有不同的 minSdkVersion 值）来创建两个应用版本，如下所示。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        ...</span><br><span class="line">        multiDexEnabled <span class="literal">true</span></span><br><span class="line">        <span class="comment">// The default minimum API level you want to support.</span></span><br><span class="line">        minSdkVersion <span class="number">15</span></span><br><span class="line">    &#125;</span><br><span class="line">    productFlavors &#123;</span><br><span class="line">        <span class="comment">// Includes settings you want to keep only while developing your app.</span></span><br><span class="line">        dev &#123;</span><br><span class="line">            <span class="comment">// Enables pre-dexing for command line builds. When using</span></span><br><span class="line">            <span class="comment">// Android Studio 2.3 or higher, the IDE enables pre-dexing</span></span><br><span class="line">            <span class="comment">// when deploying your app to a device running Android 5.0</span></span><br><span class="line">            <span class="comment">// (API level 21) or higher—regardless of what you set for</span></span><br><span class="line">            <span class="comment">// minSdkVersion.</span></span><br><span class="line">            minSdkVersion <span class="number">21</span></span><br><span class="line">        &#125;</span><br><span class="line">        prod &#123;</span><br><span class="line">            <span class="comment">// If you&#x27;ve configured the defaultConfig block for the production version of</span></span><br><span class="line">            <span class="comment">// your app, you can leave this block empty and Gradle uses configurations in</span></span><br><span class="line">            <span class="comment">// the defaultConfig block instead. You still need to include this flavor.</span></span><br><span class="line">            <span class="comment">// Otherwise, all variants use the &quot;dev&quot; flavor configurations.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled <span class="literal">true</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android.txt&#x27;</span>),</span><br><span class="line">                                                    <span class="string">&#x27;proguard-rules.pro&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile <span class="string">&#x27;com.android.support:multidex:1.0.3&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>提示：由于您有满足不同多 dex 文件需求的不同编译变体，因此也可以为不同的变体提供不同的清单文件（这样，只有适用于 API 级别 20 及更低级别的清单文件会更改 <code>&lt;application&gt;</code> 标记名称），或者为每个变体创建不同的 Application 子类（这样，只有适用于 API 级别 20 及更低级别的子类会扩展 MultiDexApplication 类或调用 MultiDex.install(this)）。</p>
<h2 id="测试多-dex-文件应用"><a href="#测试多-dex-文件应用" class="headerlink" title="测试多 dex 文件应用"></a>测试多 dex 文件应用</h2><p>编写多 dex 文件应用的插桩测试时，如果使用 MonitoringInstrumentation（或 AndroidJUnitRunner）插桩测试，则不需要额外的配置。如果使用其他 Instrumentation，则必须将其 onCreate() 方法替换为以下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle arguments)</span> </span>&#123;</span><br><span class="line">    MultiDex.install(getTargetContext());</span><br><span class="line">    <span class="keyword">super</span>.onCreate(arguments);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<ul>
<li>请勿使用已弃用的 MultiDexTestRunner，请改用 AndroidJUnitRunner。</li>
<li>目前不支持使用多 dex 文件创建测试 APK。</li>
</ul>
<h1 id="aapt"><a href="#aapt" class="headerlink" title="aapt"></a>aapt</h1><h2 id="资源"><a href="#资源" class="headerlink" title="资源"></a>资源</h2><p>Android 天生为兼容各种各样不同的设备做了相当多的工作，比如屏幕大小、国际化、键盘、像素密度等等，我们能为各种各样特定的场景下使用特定的资源做兼容而不用改动一行代码，假设我们为各种各样不同的场景适配了不同的资源，如何能快速的应用上这些资源呢？Android 为我们提供了 R 这个类，指定了一个资源的索引（id），然后我们只需要告诉系统在不同的业务场景下，使用对应的资源就好了，至于具体是指定资源里面的哪一个具体文件，由系统根据开发者的配置决定。</p>
<p>在这种场景下，假设我们给定的 id 是 x 值，那么当下业务需要使用这个资源的时候，手机的状态就是 y 值，有了(x,y)，在一个表里面就能迅速的定位到资源文件的具体路径了。这个表就是 resources.arsc，它是从 aapt 编译出来的。</p>
<p>其实二进制的资源（比如图片）是不需要编译的，只不过这个“编译”的行为，是为了生成 resources.arsc 以及对 xml 文件进行二进制化等操作，resources.arsc 是上面说的表，xml 的二进制化是为了系统读取上性能更好。AssetManager 在我们调用 R 相关的 id 的时候，就会在这个表里面找到对应的文件，读取出来。</p>
<p>Gradle 在编译资源的过程中，就是调用的这些<a target="_blank" rel="noopener" href="https://developer.android.com/studio/command-line/aapt2">aapt2命令</a>，传的参数也在这个文档里都介绍了，只不过对开发者隐藏起了调用细节。</p>
<p>aapt2 主要分两步，一步叫 compile，一步叫 link。创建一个空工程：只写了两个 xml，分别是 AndroidManifest.xml 和 activity_main.xml。</p>
<h2 id="Compile"><a href="#Compile" class="headerlink" title="Compile"></a>Compile</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> mkdir compiled</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> aapt2 compile src/main/res/layout/activity_main.xml -o compiled/</span></span><br></pre></td></tr></table></figure>

<p>在 compiled 文件夹中，生成了 layout_activity_main.xml.flat 这个文件，它是 aapt2 特有的，aapt 没有，aapt2 用它能进行增量编译。如果我们有很多的文件的话，需要依次调用 compile 才行，其实这里也可以使用 –dir 参数，只不过这个参数就没有增量编译的效果了。也就是说，当传递整个目录时，即使只有一个资源发生了变化，AAPT2也会重新编译目录中的所有文件。</p>
<h2 id="Link"><a href="#Link" class="headerlink" title="Link"></a>Link</h2><p>link 的工作量比 compile 要多一点，此处的输入是多个 flat 的文件 和 AndroidManifest.xml，外部资源，输出是只包含资源的 apk 和 R.java。命令如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">aapt2 link -o out.apk \</span><br><span class="line">-I $ANDROID_HOME/platforms/android-28/android.jar \</span><br><span class="line">compiled/layout_activity_main.xml.flat \</span><br><span class="line">--java src/main/java \</span><br><span class="line">--manifest src/main/AndroidManifest.xml</span><br></pre></td></tr></table></figure>

<ul>
<li>第二行 <code>-I</code> 是 import 外部资源，此处主要是 android 命名空间下定义的一些属性，我们平常使用的@android:xxx都是放在这个 jar 里面，其实我们也可以提供自己的资源供别人链接</li>
<li>第三行是输入的 flat 文件，如果有多个，直接在后面拼接即可</li>
<li>第四行是 R.java 生成的目录</li>
<li>第五行是指定 AndroidManifest.xml</li>
</ul>
<p>Link完成后会生成out.apk和R.java，out.apk中包含了一个resources.arsc文件。只带资源文件的可以用后缀名<code>.ap_</code>。</p>
<h2 id="查看编译后的资源"><a href="#查看编译后的资源" class="headerlink" title="查看编译后的资源"></a>查看编译后的资源</h2><p>除了是用 Android Studio 去查看 resources.arsc，还可以直接使用 <code>aapt2 dump apk</code> 信息的方式来查看资源相关的 ID 和状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aapt2 dump out.apk</span><br></pre></td></tr></table></figure>

<p>输出的结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Binary APK</span><br><span class="line">Package name=com.geminiwen.hello id=7f</span><br><span class="line">  type layout id=01 entryCount=1</span><br><span class="line">    resource 0x7f010000 layout/activity_main</span><br><span class="line">      () (file) res/layout/activity_main.xml type=XML</span><br></pre></td></tr></table></figure>

<p>可以看到 layout/activity_main 对应的 ID 是 0x7f010000。顺便看下一个用 Android Studio 新建出来的 apk（为了简单，暂时去除了 support library）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Binary APK</span><br><span class="line">Package name=com.gemini.app.properties id=7f</span><br><span class="line">  type color id=01 entryCount=3</span><br><span class="line">    resource 0x7f010000 color/colorAccent</span><br><span class="line">      () #ffd81b60</span><br><span class="line">    resource 0x7f010001 color/colorPrimary</span><br><span class="line">      () #ff008577</span><br><span class="line">    resource 0x7f010002 color/colorPrimaryDark</span><br><span class="line">      () #ff00574b</span><br><span class="line">  type drawable id=02 entryCount=3</span><br><span class="line">    resource 0x7f020000 drawable/$ic_launcher_foreground__0</span><br><span class="line">      (v24) (file) res/drawable-v24/$ic_launcher_foreground__0.xml type=XML</span><br><span class="line">    resource 0x7f020001 drawable/ic_launcher_background</span><br><span class="line">      () (file) res/drawable/ic_launcher_background.xml type=XML</span><br><span class="line">    resource 0x7f020002 drawable/ic_launcher_foreground</span><br><span class="line">      (v24) (file) res/drawable-v24/ic_launcher_foreground.xml type=XML</span><br><span class="line">  type layout id=03 entryCount=1</span><br><span class="line">    resource 0x7f030000 layout/activity_main</span><br><span class="line">      () (file) res/layout/activity_main.xml type=XML</span><br><span class="line">  type mipmap id=04 entryCount=2</span><br><span class="line">    resource 0x7f040000 mipmap/ic_launcher</span><br><span class="line">      (mdpi) (file) res/mipmap-mdpi-v4/ic_launcher.png type=PNG</span><br><span class="line">      (hdpi) (file) res/mipmap-hdpi-v4/ic_launcher.png type=PNG</span><br><span class="line">      (xhdpi) (file) res/mipmap-xhdpi-v4/ic_launcher.png type=PNG</span><br><span class="line">      (xxhdpi) (file) res/mipmap-xxhdpi-v4/ic_launcher.png type=PNG</span><br><span class="line">      (xxxhdpi) (file) res/mipmap-xxxhdpi-v4/ic_launcher.png type=PNG</span><br><span class="line">      (anydpi-v26) (file) res/mipmap-anydpi-v26/ic_launcher.xml type=XML</span><br><span class="line">    resource 0x7f040001 mipmap/ic_launcher_round</span><br><span class="line">      (mdpi) (file) res/mipmap-mdpi-v4/ic_launcher_round.png type=PNG</span><br><span class="line">      (hdpi) (file) res/mipmap-hdpi-v4/ic_launcher_round.png type=PNG</span><br><span class="line">      (xhdpi) (file) res/mipmap-xhdpi-v4/ic_launcher_round.png type=PNG</span><br><span class="line">      (xxhdpi) (file) res/mipmap-xxhdpi-v4/ic_launcher_round.png type=PNG</span><br><span class="line">      (xxxhdpi) (file) res/mipmap-xxxhdpi-v4/ic_launcher_round.png type=PNG</span><br><span class="line">      (anydpi-v26) (file) res/mipmap-anydpi-v26/ic_launcher_round.xml type=XML</span><br><span class="line">  type string id=05 entryCount=1</span><br><span class="line">    resource 0x7f050000 string/app_name</span><br><span class="line">      () &quot;Gemini&quot;</span><br></pre></td></tr></table></figure>

<h2 id="资源共享"><a href="#资源共享" class="headerlink" title="资源共享"></a>资源共享</h2><p>android.jar 只是一个编译用的桩，真正执行的时候，Android OS 提供了一个运行时的库(framework.jar)。android.jar很像一个 apk，只不过它存在的是 class 文件，然后存在一个 AndroidManifest.xml 和 resources.arsc。这就意味着我们也可以对它用aapt2 dump，执行如下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aapt2 dump $ANDROID_HOME/platforms/android-28/android.jar &gt; test.out</span><br></pre></td></tr></table></figure>

<p>得到很多类似如下的输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">resource 0x010a0000 anim/fade_in PUBLIC</span><br><span class="line">      () (file) res/anim/fade_in.xml type=XML</span><br><span class="line">    resource 0x010a0001 anim/fade_out PUBLIC</span><br><span class="line">      () (file) res/anim/fade_out.xml type=XML</span><br><span class="line">    resource 0x010a0002 anim/slide_in_left PUBLIC</span><br><span class="line">      () (file) res/anim/slide_in_left.xml type=XML</span><br><span class="line">    resource 0x010a0003 anim/slide_out_right PUBLIC</span><br><span class="line">      () (file) res/anim/slide_out_right.xml type=XML</span><br></pre></td></tr></table></figure>

<p>它多了一些PUBLIC的字段，一个 apk 文件里面的资源，如果被加上这个标记的话，就能被其他 apk 所引用，引用方式是<code>@包名:类型/名字</code>，例如：<code>@android:color/red</code>。</p>
<p>如果我们想要提供我们的资源，那么首先为我们的资源打上 PUBLIC 的标记，然后在 xml 中引用你的包名，比如：<code>@com.gemini.app:color/red</code> 就能引用到你定义的 color/red 了，如果你不指定包名，默认是自己。</p>
<p>至于 AAPT2 如何生成 PUBLIC，感兴趣的可以接着研究。</p>
<h1 id="Apk相关"><a href="#Apk相关" class="headerlink" title="Apk相关"></a>Apk相关</h1><h2 id="直接运行-Dex"><a href="#直接运行-Dex" class="headerlink" title="直接运行 Dex"></a>直接运行 Dex</h2><p>在 Android OS 上跑的虚拟机曾经叫 dalvik，现在叫 ART （Android Runtime）。</p>
<h3 id="编译-java文件"><a href="#编译-java文件" class="headerlink" title="编译.java文件"></a>编译.java文件</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>javac -cp . Main.java</code>可得到.class文件。</p>
<h3 id="编译-class文件"><a href="#编译-class文件" class="headerlink" title="编译.class文件"></a>编译.class文件</h3><p>使用dx工具编译，在build-tools下不同的版本中都有dx工具。命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ~/Software/android_sdk/build-tools/29.0.1/dx --dex --output=classes.dex Main.class</span></span><br></pre></td></tr></table></figure>

<h3 id="运行-dex文件"><a href="#运行-dex文件" class="headerlink" title="运行.dex文件"></a>运行.dex文件</h3><p>将生成的classes.dex文件push进手机，运行命令即可得到输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dalvikvm -cp classes.dex Main                                                                       </span></span><br><span class="line">Hello World!</span><br></pre></td></tr></table></figure>

<p>如果输错类名，得到输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Unable to locate class &#x27;Mai&#x27;</span><br><span class="line">java.lang.ClassNotFoundException: Didn&#x27;t find class &quot;Mai&quot; on path: DexPathList[[dex file &quot;classes.dex&quot;],nativeLibraryDirectories=[/system/lib64, /vendor/lib64, /system/lib64, /vendor/lib64]]</span><br><span class="line">	at dalvik.system.BaseDexClassLoader.findClass(BaseDexClassLoader.java:134)</span><br><span class="line">	at java.lang.ClassLoader.loadClass(ClassLoader.java:379)</span><br><span class="line">	at java.lang.ClassLoader.loadClass(ClassLoader.java:312)</span><br><span class="line">Exception in thread &quot;main&quot; java.lang.ClassNotFoundException: Didn&#x27;t find class &quot;Mai&quot; on path: DexPathList[[dex file &quot;classes.dex&quot;],nativeLibraryDirectories=[/system/lib64, /vendor/lib64, /system/lib64, /vendor/lib64]]</span><br><span class="line">	at dalvik.system.BaseDexClassLoader.findClass(BaseDexClassLoader.java:134)</span><br><span class="line">	at java.lang.ClassLoader.loadClass(ClassLoader.java:379)</span><br><span class="line">	at java.lang.ClassLoader.loadClass(ClassLoader.java:312)</span><br></pre></td></tr></table></figure>

<p>可以看到，此处的类加载器是 DexClassLoader，里面存在一个 DexPathList。</p>
<p>dalvikvm 除了能接受一个裸露的 dex 文件以外，还能接受一个 zip 格式的文件，只要求里面的 dex 文件名必须是 classes.dex 就行。比如我们传一个 zip/apk/jar 都能接受，毕竟他们的本质都是 zip。</p>
<h2 id="Dex-热修复与-Classpath"><a href="#Dex-热修复与-Classpath" class="headerlink" title="Dex 热修复与 Classpath"></a>Dex 热修复与 Classpath</h2><h3 id="热修复与-Classloader"><a href="#热修复与-Classloader" class="headerlink" title="热修复与 Classloader"></a>热修复与 Classloader</h3><p>参照腾讯开源的 Tinker 和阿里的 DexPatch 的原理，我们知道对于现在对于 java 代码的热修复主要从 DexClassLoader 里面的 dexPathList 入手，这里应用的原理就是 classloader 双亲委派里对于加载后的类的缓存机制。</p>
<ul>
<li>如果一个类在一个类加载器中加载过，就不会从其他类加载器中装载了。</li>
</ul>
<p>Android 提供的 DexClassloader 是按提供的 dex 顺序找的，因此对于 java 代码的热修复变得很简单：只要把想要被修复的 Dex 放到最前面，加载相关的类就好了，Tinker 和 DexPatch 当然还做了更多的事情，比如对 dex 进行 merge 之类的工作。</p>
<h3 id="构造有问题的-Dex"><a href="#构造有问题的-Dex" class="headerlink" title="构造有问题的 Dex"></a>构造有问题的 Dex</h3><p>首先要构造有问题的 Dex，写两个类，分别为Test.java，和HelloWorld.java，这里的HelloWorld类作为主入口，Test 类内容如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Bug!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Test test = <span class="keyword">new</span> Test();</span><br><span class="line">        test.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> javac Test.java HelloWorld.java</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> dx --dex -output=classes.dex Test.class HelloWorld.class</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> adb push classes.dex /sdcard/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> adb shell</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> /sdcard/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> dalvikvm -cp classes.dex HelloWorld</span></span><br><span class="line">Bug!</span><br></pre></td></tr></table></figure>

<h3 id="构造修复后的-Dex"><a href="#构造修复后的-Dex" class="headerlink" title="构造修复后的 Dex"></a>构造修复后的 Dex</h3><p>在 Test.java 中:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Fixed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造一个新的new.dex：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ~/javac Test.java HelloWorld.java</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ~/dx --dex --output=new.dex Test.class</span></span><br></pre></td></tr></table></figure>

<h3 id="应用热修复"><a href="#应用热修复" class="headerlink" title="应用热修复"></a>应用热修复</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dalvikvm -cp new.dex:classes.dex HelloWorld</span></span><br><span class="line">Fixed!</span><br><span class="line"><span class="meta">$</span><span class="bash"> dalvikvm -cp classes.dex HelloWorld</span></span><br><span class="line">Bug!</span><br></pre></td></tr></table></figure>

<h2 id="手动创建可安装Apk"><a href="#手动创建可安装Apk" class="headerlink" title="手动创建可安装Apk"></a>手动创建可安装Apk</h2><p>可以在脱离Gradle的情况下使用sdk工具手工创建Android项目，然后生成Apk并打包。</p>
<h3 id="新建工程"><a href="#新建工程" class="headerlink" title="新建工程"></a>新建工程</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Hello</span><br><span class="line">├── build</span><br><span class="line">├── compiled</span><br><span class="line">└── src</span><br><span class="line">    └── main</span><br><span class="line">        ├── AndroidManifest.xml</span><br><span class="line">        ├── java</span><br><span class="line">        │   └── com</span><br><span class="line">        │       └── test</span><br><span class="line">        │           ├── MainActivity.java</span><br><span class="line">        └── res</span><br><span class="line">            ├── drawable</span><br><span class="line">            │   └── ic_launcher.png</span><br><span class="line">            └── layout</span><br><span class="line">                └── activity_main.xml</span><br></pre></td></tr></table></figure>

<p>AndroidManifest.xml内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">&quot;com.test&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">uses-sdk</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:minSdkVersion</span>=<span class="string">&quot;21&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:targetSdkVersion</span>=<span class="string">&quot;29&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">&quot;@drawable/ic_launcher&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">&quot;坤坤&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;com.test.MainActivity&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LAUNCHER&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.action.MAIN&quot;</span> /&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.LEANBACK_LAUNCHER&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>MainActivity.java内容如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>activity_main.xml内容如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:gravity</span>=<span class="string">&quot;center&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">&quot;Test&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="编译资源"><a href="#编译资源" class="headerlink" title="编译资源"></a>编译资源</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> aapt2 compile src/main/res/layout/activity_main.xml -o compiled/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> aapt2 compile src/main/res/drawable/ic_launcher.png -o compiled/</span></span><br></pre></td></tr></table></figure>

<h3 id="链接资源"><a href="#链接资源" class="headerlink" title="链接资源"></a>链接资源</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> aapt2 link -o resources.ap_ -I <span class="variable">$ANDROID_HOME</span>/platforms/android-29/android.jar compiled/drawable_ic_launcher.png.flat compiled/layout_activity_main.xml.flat --java src/main/java --manifest src/main/AndroidManifest.xml</span></span><br></pre></td></tr></table></figure>

<h3 id="编译class"><a href="#编译class" class="headerlink" title="编译class"></a>编译class</h3><p>java工具链中是没有android sdk的，所以需要在编译的时候导入classpath。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> javac -d build -cp <span class="variable">$ANDROID_HOME</span>/platforms/android-29/android.jar src/main/java/**/*.java</span></span><br></pre></td></tr></table></figure>

<p>其中-d表示输出目录，-cp表示 classpath，后面跟着输入文件，src/main/java 目录下面所有的 java 文件。</p>
<h3 id="生成dex"><a href="#生成dex" class="headerlink" title="生成dex"></a>生成dex</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dx --dex --output=classes.dex build</span></span><br></pre></td></tr></table></figure>

<p>把前面的编译结果合起来，首先将ap_文件，复制一份，重命名成 apk 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp resources.ap_ app-debug.apk</span><br></pre></td></tr></table></figure>

<p>拿到了一个 apk（其实是zip文件），然后把 classes.dex 加进去。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zip -ur app-debug.apk classes.dex</span><br></pre></td></tr></table></figure>

<h3 id="签名"><a href="#签名" class="headerlink" title="签名"></a>签名</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 密码为android</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> apksigner sign -ks ~/.android/debug.keystore app-debug.apk</span></span><br></pre></td></tr></table></figure>

<h3 id="生成结果"><a href="#生成结果" class="headerlink" title="生成结果"></a>生成结果</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">app</span><br><span class="line">├── app-debug.apk</span><br><span class="line">├── build</span><br><span class="line">│   └── com</span><br><span class="line">│       └── test</span><br><span class="line">│           ├── MainActivity.class</span><br><span class="line">│           ├── R.class</span><br><span class="line">│           ├── R$drawable.class</span><br><span class="line">│           └── R$layout.class</span><br><span class="line">├── classes.dex</span><br><span class="line">├── compiled</span><br><span class="line">│   ├── drawable_ic_launcher.png.flat</span><br><span class="line">│   └── layout_activity_main.xml.flat</span><br><span class="line">├── resources.ap_</span><br><span class="line">└── src</span><br><span class="line">    └── main</span><br><span class="line">        ├── AndroidManifest.xml</span><br><span class="line">        ├── java</span><br><span class="line">        │   └── com</span><br><span class="line">        │       └── test</span><br><span class="line">        │           ├── MainActivity.java</span><br><span class="line">        │           └── R.java</span><br><span class="line">        └── res</span><br><span class="line">            ├── drawable</span><br><span class="line">            │   └── ic_launcher.png</span><br><span class="line">            └── layout</span><br><span class="line">                └── activity_main.xml</span><br></pre></td></tr></table></figure>

<h1 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h1><h2 id="配置调试的Debug包apk可安装"><a href="#配置调试的Debug包apk可安装" class="headerlink" title="配置调试的Debug包apk可安装"></a>配置调试的Debug包apk可安装</h2><p>Android Studio 3.0会在debug apk的配置文件application标签里自动添加 android:testOnly=”true”属性，导致IDE中run跑出的apk无法安装，只能用于as测试安装。</p>
<p>解决办法：在gradle.properties(项目根目录或者gradle全局配置目录 ~/.gradle/)文件中添加<code>android.injected.testOnly=false</code> 之后就可以安装了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/19/Android-OpenGL-ES%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/19/Android-OpenGL-ES%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Android-OpenGL-ES笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-08-19 10:12:24" itemprop="dateCreated datePublished" datetime="2019-08-19T10:12:24+08:00">2019-08-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/Framework/" itemprop="url" rel="index"><span itemprop="name">Framework</span></a>
                </span>
            </span>

          
            <span id="/2019/08/19/Android-OpenGL-ES%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="Android-OpenGL-ES笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/08/19/Android-OpenGL-ES%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/08/19/Android-OpenGL-ES%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><ul>
<li>OpenGL(Open Graphics Library)是一个用于渲染2D、3D矢量图形的跨语言、跨平台的应用程序编程接口（API）。</li>
<li>OpenGl一般用于在图形工作站，PC端使用，由于性能各方面原因，在移动端基本带不动OpenGl。为此，KhronosGroup 为 OpenGl 提供了一个子集，OpenGl ES(OpenGl for Embedded System)。</li>
<li>OpenGl ES是免费的跨平台的功能完善的2D/3D图形库接口的API，是OpenGL的一个子集。</li>
<li>移动端使用到的基本上都是OpenGl ES，当然Android开发下还专门为OpenGl提供了android.opengl包，并且提供了GlSurfaceView, GLU, GlUtils等工具类。</li>
</ul>
<p>Android 支持多版 OpenGL ES API：</p>
<ul>
<li>OpenGL ES 1.0 和 1.1 - 此 API 规范受 Android 1.0 及更高版本的支持。</li>
<li>OpenGL ES 2.0 - 此 API 规范受 Android 2.2（API 级别 8）及更高版本的支持。</li>
<li>OpenGL ES 3.0 - 此 API 规范受 Android 4.3（API 级别 18）及更高版本的支持。</li>
<li>OpenGL ES 3.1 - 此 API 规范受 Android 5.0（API 级别 21）及更高版本的支持。</li>
</ul>
<p>Android 通过其 Framework API 和 Native开发套件(NDK) 来支持 OpenGL，本文主要讲解 Framework API。Android Framework 中有两个基本类，用于通过 OpenGL ES API 来创建和操控图形：GLSurfaceView 和 GLSurfaceView.Renderer。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/graphics/opengl">Android-OpenGl-ES官方文档</a>。</p>
<h1 id="GlSurfaceView"><a href="#GlSurfaceView" class="headerlink" title="GlSurfaceView"></a>GlSurfaceView</h1><p>GlSurfaceView是一个 View，它继承自SurfaceView，并增加了Renderer，它的作用就是专门为OpenGl显示渲染使用的。使用方法：</p>
<p><strong>1.创建一个GlSurfaceView</strong><br><strong>2.为这个GlSurfaceView设置Renderer</strong><br><strong>3.在GlSurfaceView.renderer中绘制处理显示数据</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    GLSurfaceView glSurfaceView = <span class="keyword">new</span> GLSurfaceView(<span class="keyword">this</span>);</span><br><span class="line">    glSurfaceView.setRenderer(<span class="keyword">new</span> GLSurfaceView.Renderer() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceCreated</span><span class="params">(GL10 gl, EGLConfig config)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSurfaceChanged</span><span class="params">(GL10 gl, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDrawFrame</span><span class="params">(GL10 gl)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    setContentView(glSurfaceView);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="GlSurfaceView-Renderer"><a href="#GlSurfaceView-Renderer" class="headerlink" title="GlSurfaceView.Renderer"></a>GlSurfaceView.Renderer</h1><ul>
<li>onSurfaceCreated(): 系统会在创建 GLSurfaceView 时调用一次此方法。使用此方法可执行仅需发生一次的操作，例如设置 OpenGL 环境参数或初始化 OpenGL 图形对象。</li>
<li>onDrawFrame(): 系统会在每次重新绘制 GLSurfaceView 时调用此方法。请将此方法作为绘制（和重新绘制）图形对象的主要执行点。</li>
<li>onSurfaceChanged(): 系统会在 GLSurfaceView 几何图形发生变化（包括 GLSurfaceView 大小发生变化或设备屏幕方向发生变化）时调用此方法。使用此方法可响应 GLSurfaceView 容器中的更改。</li>
</ul>
<h1 id="声明OpenGL"><a href="#声明OpenGL" class="headerlink" title="声明OpenGL"></a>声明OpenGL</h1><p>如果应用使用的 OpenGL 功能不一定在所有设备上可用，则必须在 AndroidManifest.xml 文件中包含这些要求。以下是最常见的 OpenGL 清单声明：</p>
<ul>
<li><p>OpenGL ES 版本要求 - 如果应用需要特定版本的 OpenGL ES，则必须通过将以下设置添加到 Manifest 中来声明该要求，如下所示。</p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Tell the system this app requires OpenGL ES 2.0. --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-feature</span> <span class="attr">android:glEsVersion</span>=<span class="string">&quot;0x00020000&quot;</span> <span class="attr">android:required</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Tell the system this app requires OpenGL ES 3.0. --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-feature</span> <span class="attr">android:glEsVersion</span>=<span class="string">&quot;0x00030000&quot;</span> <span class="attr">android:required</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Tell the system this app requires OpenGL ES 3.1. --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-feature</span> <span class="attr">android:glEsVersion</span>=<span class="string">&quot;0x00030001&quot;</span> <span class="attr">android:required</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>纹理压缩要求 - 如果应用使用了纹理压缩格式，则必须使用 <code>&lt;supports-gl-texture&gt;</code> 在 Manifest 文件中声明应用支持的格式，如需详细了解可用的纹理<br>压缩格式，可参阅<a target="_blank" rel="noopener" href="https://developer.android.com/guide/topics/graphics/opengl?hl=zh-cn#textures">纹理压缩支持</a>。</p>
</li>
</ul>
<h1 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h1><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 GLSurfaceView 作为主要视图的 Activity 的最少实现</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OpenGLES20Activity</span> : <span class="type">Activity</span></span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> gLView: GLSurfaceView</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        gLView = MyGLSurfaceView(<span class="keyword">this</span>)</span><br><span class="line">        setContentView(gLView)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MyGLSurfaceView</span></span>(context: Context) : GLSurfaceView(context) &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> renderer: MyGLRenderer</span><br><span class="line"></span><br><span class="line">        <span class="keyword">init</span> &#123;</span><br><span class="line">            <span class="comment">// Create an OpenGL ES 2.0 context</span></span><br><span class="line">            setEGLContextClientVersion(<span class="number">2</span>)</span><br><span class="line">            renderer = MyGLRenderer()</span><br><span class="line">            setRenderer(renderer)</span><br><span class="line">            <span class="comment">// 该设置可防止系统在调用 requestRender() 之前重新绘制 GLSurfaceView 帧，更为高效。</span></span><br><span class="line">            <span class="comment">// Render the view only when there is a change in the drawing data</span></span><br><span class="line">            renderMode = GLSurfaceView.RENDERMODE_WHEN_DIRTY</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MyGLRenderer</span> : <span class="type">GLSurfaceView.Renderer &#123;</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSurfaceCreated</span><span class="params">(unused: <span class="type">GL10</span>, config: <span class="type">EGLConfig</span>)</span></span> &#123;</span><br><span class="line">            <span class="comment">// Set the background frame color</span></span><br><span class="line">            GLES20.glClearColor(<span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDrawFrame</span><span class="params">(unused: <span class="type">GL10</span>)</span></span> &#123;</span><br><span class="line">            <span class="comment">// Redraw background color</span></span><br><span class="line">            GLES20.glClear(GLES20.GL_COLOR_BUFFER_BIT)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSurfaceChanged</span><span class="params">(unused: <span class="type">GL10</span>, width: <span class="type">Int</span>, height: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">            GLES20.glViewport(<span class="number">0</span>, <span class="number">0</span>, width, height)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="定义形状"><a href="#定义形状" class="headerlink" title="定义形状"></a>定义形状</h1><p>默认情况下，OpenGL ES 会假定一个坐标系，其中 [0,0,0] (X,Y,Z) 指定 GLSurfaceView 帧的中心，[1,1,0] 指定帧的右上角，而 [-1,-1,0] 指定帧的左下角，此形状的坐标是按照逆时针顺序定义的。</p>
<h2 id="定义三角形"><a href="#定义三角形" class="headerlink" title="定义三角形"></a>定义三角形</h2><p>通过 OpenGL ES 可以使用三维空间中的坐标定义绘制的对象，在 OpenGL 中，执行此操作的典型方式是为坐标定义浮点数的顶点数组。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// number of coordinates per vertex in this array</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">val</span> COORDS_PER_VERTEX = <span class="number">3</span></span><br><span class="line"><span class="keyword">var</span> triangleCoords = floatArrayOf(     <span class="comment">// in counterclockwise order:</span></span><br><span class="line">        <span class="number">0.0f</span>, <span class="number">0.622008459f</span>, <span class="number">0.0f</span>,      <span class="comment">// top</span></span><br><span class="line">        -<span class="number">0.5f</span>, -<span class="number">0.311004243f</span>, <span class="number">0.0f</span>,    <span class="comment">// bottom left</span></span><br><span class="line">        <span class="number">0.5f</span>, -<span class="number">0.311004243f</span>, <span class="number">0.0f</span>      <span class="comment">// bottom right</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Triangle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set color with red, green, blue and alpha (opacity) values</span></span><br><span class="line">    <span class="keyword">val</span> color = floatArrayOf(<span class="number">0.63671875f</span>, <span class="number">0.76953125f</span>, <span class="number">0.22265625f</span>, <span class="number">1.0f</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// (number of coordinate values * 4 bytes per float)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> vertexBuffer: FloatBuffer = ByteBuffer.allocateDirect(triangleCoords.size * <span class="number">4</span>).run &#123;</span><br><span class="line">        <span class="comment">// use the device hardware&#x27;s native byte order</span></span><br><span class="line">        order(ByteOrder.nativeOrder())</span><br><span class="line"></span><br><span class="line">        <span class="comment">// create a floating point buffer from the ByteBuffer</span></span><br><span class="line">        asFloatBuffer().apply &#123;</span><br><span class="line">            <span class="comment">// add the coordinates to the FloatBuffer</span></span><br><span class="line">            put(triangleCoords)</span><br><span class="line">            <span class="comment">// set the buffer to read the first coordinate</span></span><br><span class="line">            position(<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="定义方形"><a href="#定义方形" class="headerlink" title="定义方形"></a>定义方形</h2><p>有多种方式可以定义方形，但在 OpenGL ES 中绘制此类形状的典型方式是使用两个绘制在一起的三角形：</p>
<p><img src="%E5%AE%9A%E4%B9%89%E6%96%B9%E5%BD%A2.png" alt="定义方形"></p>
<p>对于表示该形状的两个三角形，应按逆时针顺序定义顶点，并将这些值放入 ByteBuffer 中。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// number of coordinates per vertex in this array</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">val</span> COORDS_PER_VERTEX = <span class="number">3</span></span><br><span class="line"><span class="keyword">var</span> squareCoords = floatArrayOf(</span><br><span class="line">        -<span class="number">0.5f</span>,  <span class="number">0.5f</span>, <span class="number">0.0f</span>,      <span class="comment">// top left</span></span><br><span class="line">        -<span class="number">0.5f</span>, -<span class="number">0.5f</span>, <span class="number">0.0f</span>,      <span class="comment">// bottom left</span></span><br><span class="line">        <span class="number">0.5f</span>, -<span class="number">0.5f</span>, <span class="number">0.0f</span>,      <span class="comment">// bottom right</span></span><br><span class="line">        <span class="number">0.5f</span>,  <span class="number">0.5f</span>, <span class="number">0.0f</span>       <span class="comment">// top right</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Square2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> drawOrder = shortArrayOf(<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>) <span class="comment">// order to draw vertices</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// initialize vertex byte buffer for shape coordinates</span></span><br><span class="line">    <span class="comment">// (# of coordinate values * 4 bytes per float)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> vertexBuffer: FloatBuffer = ByteBuffer.allocateDirect(squareCoords.size * <span class="number">4</span>).run &#123;</span><br><span class="line">        order(ByteOrder.nativeOrder())</span><br><span class="line">        asFloatBuffer().apply &#123;</span><br><span class="line">            put(squareCoords)</span><br><span class="line">            position(<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// initialize byte buffer for the draw list</span></span><br><span class="line">    <span class="comment">// (# of coordinate values * 2 bytes per short)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> drawListBuffer: ShortBuffer = ByteBuffer.allocateDirect(drawOrder.size * <span class="number">2</span>).run &#123;</span><br><span class="line">        order(ByteOrder.nativeOrder())</span><br><span class="line">        asShortBuffer().apply &#123;</span><br><span class="line">            put(drawOrder)</span><br><span class="line">            position(<span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="绘制形状"><a href="#绘制形状" class="headerlink" title="绘制形状"></a>绘制形状</h1><h2 id="初始化形状"><a href="#初始化形状" class="headerlink" title="初始化形状"></a>初始化形状</h2><p>在进行任何绘制之前必须初始化并加载打算绘制的形状，除非在程序中使用的形状结构（原始坐标）在执行过程中发生变化，否则应该在渲染程序的 onSurfaceCreated() 方法中对它们进行初始化，以提高内存和处理效率。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyGLRenderer</span> : <span class="type">GLSurfaceView.Renderer &#123;</span></span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> mTriangle: Triangle</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> mSquare: Square</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSurfaceCreated</span><span class="params">(unused: <span class="type">GL10</span>, config: <span class="type">EGLConfig</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">// initialize a triangle</span></span><br><span class="line">        mTriangle = Triangle()</span><br><span class="line">        <span class="comment">// initialize a square</span></span><br><span class="line">        mSquare = Square()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="绘制形状-1"><a href="#绘制形状-1" class="headerlink" title="绘制形状"></a>绘制形状</h2><p>使用 OpenGL ES 2.0 绘制定义的形状需要大量代码，因为必须向图形渲染管道提供大量信息，具体来说需要定义以下内容：</p>
<ul>
<li>顶点(Vertex)着色程序 - 用于渲染形状的顶点的 OpenGL ES 图形代码。</li>
<li>片段(Fragment)着色程序 - 用于使用颜色或纹理渲染形状面的 OpenGL ES 代码。</li>
<li>程序 - 包含希望用于绘制一个或多个形状的着色程序的 OpenGL ES 对象。</li>
</ul>
<p>至少需要一个顶点着色程序绘制形状，以及一个 Fragment 着色程序为该形状着色，还必须对这些着色程序进行编译，然后将其添加到之后用于绘制形状的 OpenGL ES 程序中。以下示例展示了如何定义可用于绘制 Triangle 类中的形状的基本着色程序：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Triangle</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> vertexShaderCode =</span><br><span class="line">            <span class="string">&quot;attribute vec4 vPosition;&quot;</span> +</span><br><span class="line">            <span class="string">&quot;void main() &#123;&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  gl_Position = vPosition;&quot;</span> +</span><br><span class="line">            <span class="string">&quot;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> fragmentShaderCode =</span><br><span class="line">            <span class="string">&quot;precision mediump float;&quot;</span> +</span><br><span class="line">            <span class="string">&quot;uniform vec4 vColor;&quot;</span> +</span><br><span class="line">            <span class="string">&quot;void main() &#123;&quot;</span> +</span><br><span class="line">            <span class="string">&quot;  gl_FragColor = vColor;&quot;</span> +</span><br><span class="line">            <span class="string">&quot;&#125;&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>着色程序包含 OpenGL 着色语言 (GLSL) 代码，必须先对其进行编译，然后才能在 OpenGL ES 环境中使用。要编译此代码，可以在渲染程序类中创建一个实用程序方法：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">loadShader</span><span class="params">(type: <span class="type">Int</span>, shaderCode: <span class="type">String</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create a vertex shader type (GLES20.GL_VERTEX_SHADER)</span></span><br><span class="line">    <span class="comment">// or a fragment shader type (GLES20.GL_FRAGMENT_SHADER)</span></span><br><span class="line">    <span class="keyword">return</span> GLES20.glCreateShader(type).also &#123; shader -&gt;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// add the source code to the shader and compile it</span></span><br><span class="line">        GLES20.glShaderSource(shader, shaderCode)</span><br><span class="line">        GLES20.glCompileShader(shader)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要绘制形状，必须编译着色程序代码，将它们添加到 OpenGL ES 程序对象中，然后关联该程序。该操作需要在绘制对象的构造函数中完成，因此只需执行一次。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Triangle</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> mProgram: <span class="built_in">Int</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> vertexShader: <span class="built_in">Int</span> = loadShader(GLES20.GL_VERTEX_SHADER, vertexShaderCode)</span><br><span class="line">        <span class="keyword">val</span> fragmentShader: <span class="built_in">Int</span> = loadShader(GLES20.GL_FRAGMENT_SHADER, fragmentShaderCode)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// create empty OpenGL ES Program</span></span><br><span class="line">        mProgram = GLES20.glCreateProgram().also &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// add the vertex shader to program</span></span><br><span class="line">            GLES20.glAttachShader(it, vertexShader)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// add the fragment shader to program</span></span><br><span class="line">            GLES20.glAttachShader(it, fragmentShader)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// creates OpenGL ES program executables</span></span><br><span class="line">            GLES20.glLinkProgram(it)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时可以添加绘制形状的实际调用，使用 OpenGL ES 绘制形状时需要指定多个参数，以告知渲染管道要绘制的形状以及如何进行绘制。由于绘制选项因形状而异，因此最好使形状类包含自身的绘制逻辑。</p>
<p>创建用于绘制形状的 draw() 方法，此代码将位置和颜色值设置为形状的顶点着色程序和 Fragment 着色程序，然后执行绘制功能。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> positionHandle: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> mColorHandle: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> vertexCount: <span class="built_in">Int</span> = triangleCoords.size / COORDS_PER_VERTEX</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> vertexStride: <span class="built_in">Int</span> = COORDS_PER_VERTEX * <span class="number">4</span> <span class="comment">// 4 bytes per vertex</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">draw</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// Add program to OpenGL ES environment</span></span><br><span class="line">    GLES20.glUseProgram(mProgram)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get handle to vertex shader&#x27;s vPosition member</span></span><br><span class="line">    positionHandle = GLES20.glGetAttribLocation(mProgram, <span class="string">&quot;vPosition&quot;</span>).also &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Enable a handle to the triangle vertices</span></span><br><span class="line">        GLES20.glEnableVertexAttribArray(it)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Prepare the triangle coordinate data</span></span><br><span class="line">        GLES20.glVertexAttribPointer(</span><br><span class="line">                it,</span><br><span class="line">                COORDS_PER_VERTEX,</span><br><span class="line">                GLES20.GL_FLOAT,</span><br><span class="line">                <span class="literal">false</span>,</span><br><span class="line">                vertexStride,</span><br><span class="line">                vertexBuffer</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment">// get handle to fragment shader&#x27;s vColor member</span></span><br><span class="line">        mColorHandle = GLES20.glGetUniformLocation(mProgram, <span class="string">&quot;vColor&quot;</span>).also &#123; colorHandle -&gt;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Set color for drawing the triangle</span></span><br><span class="line">            GLES20.glUniform4fv(colorHandle, <span class="number">1</span>, color, <span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Draw the triangle</span></span><br><span class="line">        GLES20.glDrawArrays(GLES20.GL_TRIANGLES, <span class="number">0</span>, vertexCount)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Disable vertex array</span></span><br><span class="line">        GLES20.glDisableVertexAttribArray(it)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将所有的代码编译完成之后，只需从渲染程序的 onDrawFrame() 方法中调用 draw() 方法即可绘制此对象：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDrawFrame</span><span class="params">(unused: <span class="type">GL10</span>)</span></span> &#123;</span><br><span class="line">    mTriangle.draw()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在横屏手机上绘制结果如下：</p>
<p><img src="%E4%B8%89%E8%A7%92%E5%BD%A2-%E6%97%A0%E8%BD%AC%E6%8D%A2.jpg" alt="三角形-无转换"></p>
<p>形状偏斜的原因在于，对象的顶点尚未针对显示 GLSurfaceView 的屏幕区域的比例进行校正。</p>
<h1 id="投影和相机视图"><a href="#投影和相机视图" class="headerlink" title="投影和相机视图"></a>投影和相机视图</h1><p>在 Android 设备上显示图形时，一个基本问题在于屏幕的尺寸和形状各不相同，OpenGL 假设屏幕采用均匀的方形坐标系。</p>
<p><img src="OpenGL-Android%E5%9D%90%E6%A0%87%E7%B3%BB.png" alt="OpenGL-Android坐标系"></p>
<p>上图左侧显示了针对 OpenGL 假定的均匀坐标系，右侧显示了坐标实际上如何映射到右侧屏幕方向为横向的设备屏幕上。要解决此问题，可以通过应用 OpenGL 投影模式和相机视图来转换坐标，这样，图形对象在任何屏幕上都具有正确的比例。</p>
<ul>
<li>投影：根据显示绘制对象的 GLSurfaceView 的宽度和高度调整绘制对象的坐标。通常只有在渲染程序的 onSurfaceChanged() 方法中确定或更改 OpenGL 视图的比例时，才需要计算投影转换。</li>
<li>相机视图：根据虚拟相机的位置调整绘制对象的坐标。相机视图转换可能在确定 GLSurfaceView 时计算一次，也可能会根据用户操作或应用的功能动态变化。</li>
</ul>
<h2 id="定义投影"><a href="#定义投影" class="headerlink" title="定义投影"></a>定义投影</h2><p>用于投影转换的数据使用 GLSurfaceView.Renderer 的 onSurfaceChanged() 方法计算。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vPMatrix is an abbreviation for &quot;Model View Projection Matrix&quot;--模型视图投影矩阵</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> vPMatrix = FloatArray(<span class="number">16</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> projectionMatrix = FloatArray(<span class="number">16</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> viewMatrix = FloatArray(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSurfaceChanged</span><span class="params">(unused: <span class="type">GL10</span>, width: <span class="type">Int</span>, height: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    GLES20.glViewport(<span class="number">0</span>, <span class="number">0</span>, width, height)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> ratio: <span class="built_in">Float</span> = width.toFloat() / height.toFloat()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// this projection matrix is applied to object coordinates</span></span><br><span class="line">    <span class="comment">// in the onDrawFrame() method</span></span><br><span class="line">    Matrix.frustumM(projectionMatrix, <span class="number">0</span>, -ratio, ratio, -<span class="number">1f</span>, <span class="number">1f</span>, <span class="number">3f</span>, <span class="number">7f</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="定义相机视图"><a href="#定义相机视图" class="headerlink" title="定义相机视图"></a>定义相机视图</h2><p>通过在渲染程序中添加相机视图转换作为绘制流程的一部分，完成绘制对象的转换流程。在以下示例代码中，相机视图转换使用 Matrix.setLookAtM() 方法进行计算，然后与之前计算的投影矩阵合并。之后，系统会将合并后的转换矩阵传递到绘制的形状。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDrawFrame</span><span class="params">(unused: <span class="type">GL10</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// Set the camera position (View matrix)</span></span><br><span class="line">    Matrix.setLookAtM(viewMatrix, <span class="number">0</span>, <span class="number">0f</span>, <span class="number">0f</span>, -<span class="number">3f</span>, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Calculate the projection and view transformation</span></span><br><span class="line">    Matrix.multiplyMM(vPMatrix, <span class="number">0</span>, projectionMatrix, <span class="number">0</span>, viewMatrix, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Draw shape</span></span><br><span class="line">    mTriangle.draw(vPMatrix)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="应用投影和相机转换"><a href="#应用投影和相机转换" class="headerlink" title="应用投影和相机转换"></a>应用投影和相机转换</h2><p>为了使用预览部分中显示的合并后的投影和相机视图转换矩阵，请先将矩阵变体添加到之前在 Triangle 类中定义的顶点着色程序。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Triangle</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> vertexShaderCode =</span><br><span class="line">            <span class="comment">// This matrix member variable provides a hook to manipulate</span></span><br><span class="line">            <span class="comment">// the coordinates of the objects that use this vertex shader</span></span><br><span class="line">            <span class="string">&quot;uniform mat4 uMVPMatrix;&quot;</span> +</span><br><span class="line">            <span class="string">&quot;attribute vec4 vPosition;&quot;</span> +</span><br><span class="line">            <span class="string">&quot;void main() &#123;&quot;</span> +</span><br><span class="line">            <span class="comment">// the matrix must be included as a modifier of gl_Position</span></span><br><span class="line">            <span class="comment">// Note that the uMVPMatrix factor *must be first* in order</span></span><br><span class="line">            <span class="comment">// for the matrix multiplication product to be correct.</span></span><br><span class="line">            <span class="string">&quot;  gl_Position = uMVPMatrix * vPosition;&quot;</span> +</span><br><span class="line">            <span class="string">&quot;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use to access and set the view transformation</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> vPMatrixHandle: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，修改图形对象的 draw() 方法以接受合并后的转换矩阵，并将其应用于形状：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">draw</span><span class="params">(mvpMatrix: <span class="type">FloatArray</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// Add program to OpenGL ES environment</span></span><br><span class="line">    GLES20.glUseProgram(mProgram)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get handle to vertex shader&#x27;s vPosition member</span></span><br><span class="line">    positionHandle = GLES20.glGetAttribLocation(mProgram, <span class="string">&quot;vPosition&quot;</span>).also &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Enable a handle to the triangle vertices</span></span><br><span class="line">        GLES20.glEnableVertexAttribArray(it)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Prepare the triangle coordinate data</span></span><br><span class="line">        GLES20.glVertexAttribPointer(</span><br><span class="line">                it,</span><br><span class="line">                COORDS_PER_VERTEX,</span><br><span class="line">                GLES20.GL_FLOAT,</span><br><span class="line">                <span class="literal">false</span>,</span><br><span class="line">                vertexStride,</span><br><span class="line">                vertexBuffer</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment">// get handle to fragment shader&#x27;s vColor member</span></span><br><span class="line">        mColorHandle = GLES20.glGetUniformLocation(mProgram, <span class="string">&quot;vColor&quot;</span>).also &#123; colorHandle -&gt;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Set color for drawing the triangle</span></span><br><span class="line">            GLES20.glUniform4fv(colorHandle, <span class="number">1</span>, color, <span class="number">0</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// get handle to shape&#x27;s transformation matrix</span></span><br><span class="line">        vPMatrixHandle = GLES20.glGetUniformLocation(mProgram, <span class="string">&quot;uMVPMatrix&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Pass the projection and view transformation to the shader</span></span><br><span class="line">        GLES20.glUniformMatrix4fv(vPMatrixHandle, <span class="number">1</span>, <span class="literal">false</span>, mvpMatrix, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Draw the triangle</span></span><br><span class="line">        GLES20.glDrawArrays(GLES20.GL_TRIANGLES, <span class="number">0</span>, vertexCount)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Disable vertex array</span></span><br><span class="line">        GLES20.glDisableVertexAttribArray(positionHandle)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就能按照正确的比例显示形状了。</p>
<h1 id="添加动画"><a href="#添加动画" class="headerlink" title="添加动画"></a>添加动画</h1><h2 id="旋转形状"><a href="#旋转形状" class="headerlink" title="旋转形状"></a>旋转形状</h2><p>使用 OpenGL ES 2.0 旋转绘制的对象相对比较简单。在渲染程序中，再创建一个转换矩阵（旋转矩阵），然后将其与投影和相机视图转换矩阵相结合：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> rotationMatrix = FloatArray(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDrawFrame</span><span class="params">(gl: <span class="type">GL10</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> scratch = FloatArray(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a rotation transformation for the triangle</span></span><br><span class="line">    <span class="keyword">val</span> time = SystemClock.uptimeMillis() % <span class="number">4000L</span></span><br><span class="line">    <span class="keyword">val</span> angle = <span class="number">0.090f</span> * time.toInt()</span><br><span class="line">    Matrix.setRotateM(rotationMatrix, <span class="number">0</span>, angle, <span class="number">0f</span>, <span class="number">0f</span>, -<span class="number">1.0f</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Combine the rotation matrix with the projection and camera view</span></span><br><span class="line">    <span class="comment">// Note that the vPMatrix factor *must be first* in order</span></span><br><span class="line">    <span class="comment">// for the matrix multiplication product to be correct.</span></span><br><span class="line">    Matrix.multiplyMM(scratch, <span class="number">0</span>, vPMatrix, <span class="number">0</span>, rotationMatrix, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Draw triangle</span></span><br><span class="line">    mTriangle.draw(scratch)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果三角形在进行这些更改后没有旋转，请确保已对 GLSurfaceView.RENDERMODE_WHEN_DIRTY 设置取消备注。</p>
<h2 id="启用连续渲染"><a href="#启用连续渲染" class="headerlink" title="启用连续渲染"></a>启用连续渲染</h2><p>请确保对将渲染模式设置为仅在脏时才进行绘制的行取消备注，否则 OpenGL 仅按一个增量旋转形状，然后就等待从 GLSurfaceView 容器调用 requestRender()：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyGLSurfaceView</span></span>(context: Context) : GLSurfaceView(context) &#123;</span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        <span class="comment">// Render the view only when there is a change in the drawing data.</span></span><br><span class="line">        <span class="comment">// To allow the triangle to rotate automatically, this line is commented out:</span></span><br><span class="line">        <span class="comment">//renderMode = GLSurfaceView.RENDERMODE_WHEN_DIRTY</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>除非在没有任何用户互动的情况下更改对象，否则通常最好启用此标记。</p>
<h1 id="响应触摸事件"><a href="#响应触摸事件" class="headerlink" title="响应触摸事件"></a>响应触摸事件</h1><h2 id="设置触摸监听器"><a href="#设置触摸监听器" class="headerlink" title="设置触摸监听器"></a>设置触摸监听器</h2><p>为了使 OpenGL ES 应用响应触摸事件，需要在 GLSurfaceView 类中实现 onTouchEvent() 方法。以下示例实现展示了如何监听 MotionEvent.ACTION_MOVE 事件，并将其平移到某个形状的旋转角度。这里需要取消上面<code>renderMode = GLSurfaceView.RENDERMODE_WHEN_DIRTY</code>的注释。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> TOUCH_SCALE_FACTOR: <span class="built_in">Float</span> = <span class="number">180.0f</span> / <span class="number">320f</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> previousX: <span class="built_in">Float</span> = <span class="number">0f</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> previousY: <span class="built_in">Float</span> = <span class="number">0f</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTouchEvent</span><span class="params">(e: <span class="type">MotionEvent</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="comment">// MotionEvent reports input details from the touch screen</span></span><br><span class="line">    <span class="comment">// and other input controls. In this case, you are only</span></span><br><span class="line">    <span class="comment">// interested in events where the touch position changed.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> x: <span class="built_in">Float</span> = e.x</span><br><span class="line">    <span class="keyword">val</span> y: <span class="built_in">Float</span> = e.y</span><br><span class="line"></span><br><span class="line">    <span class="keyword">when</span> (e.action) &#123;</span><br><span class="line">        MotionEvent.ACTION_MOVE -&gt; &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> dx: <span class="built_in">Float</span> = x - previousX</span><br><span class="line">            <span class="keyword">var</span> dy: <span class="built_in">Float</span> = y - previousY</span><br><span class="line"></span><br><span class="line">            <span class="comment">// reverse direction of rotation above the mid-line</span></span><br><span class="line">            <span class="keyword">if</span> (y &gt; height / <span class="number">2</span>) &#123;</span><br><span class="line">                dx *= -<span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// reverse direction of rotation to left of the mid-line</span></span><br><span class="line">            <span class="keyword">if</span> (x &lt; width / <span class="number">2</span>) &#123;</span><br><span class="line">                dy *= -<span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            renderer.angle += (dx + dy) * TOUCH_SCALE_FACTOR</span><br><span class="line">            requestRender()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    previousX = x</span><br><span class="line">    previousY = y</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="线程安全"><a href="#线程安全" class="headerlink" title="线程安全"></a>线程安全</h2><p>上面的代码需要公开 angle 成员，由于渲染程序代码在独立于应用的主界面线程的线程上运行，因此必须将此公开变量声明为 volatile。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyGLRenderer</span> : <span class="type">GLSurfaceView.Renderer &#123;</span></span></span><br><span class="line">    <span class="meta">@Volatile</span></span><br><span class="line">    <span class="keyword">var</span> angle: <span class="built_in">Float</span> = <span class="number">0f</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="应用旋转"><a href="#应用旋转" class="headerlink" title="应用旋转"></a>应用旋转</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDrawFrame</span><span class="params">(gl: <span class="type">GL10</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">val</span> scratch = FloatArray(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a rotation for the triangle</span></span><br><span class="line">    <span class="comment">// long time = SystemClock.uptimeMillis() % 4000L;</span></span><br><span class="line">    <span class="comment">// float angle = 0.090f * ((int) time);</span></span><br><span class="line">    Matrix.setRotateM(rotationMatrix, <span class="number">0</span>, angle, <span class="number">0f</span>, <span class="number">0f</span>, -<span class="number">1.0f</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Combine the rotation matrix with the projection and camera view</span></span><br><span class="line">    <span class="comment">// Note that the mvpMatrix factor *must be first* in order</span></span><br><span class="line">    <span class="comment">// for the matrix multiplication product to be correct.</span></span><br><span class="line">    Matrix.multiplyMM(scratch, <span class="number">0</span>, mvpMatrix, <span class="number">0</span>, rotationMatrix, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Draw triangle</span></span><br><span class="line">    triangle.draw(scratch)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就可以实现拖动旋转三角形了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/9/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/11/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="苍耳叔叔"
      src="/images/head.png">
  <p class="site-author-name" itemprop="name">苍耳叔叔</p>
  <div class="site-description" itemprop="description">梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">158</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">40</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">99</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ljd1996" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ljd1996" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hearing1996@gmail.com" title="E-Mail → mailto:hearing1996@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">苍耳叔叔</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : true,
      notify     : true,
      appId      : 'pCnIlzs46HJGpubm7D3TnrBC-gzGzoHsz',
      appKey     : '7LzW4wBI9lY5DtVFNkFWcjs0',
      placeholder: "欢迎评论交流！",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
