<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
<meta property="og:type" content="website">
<meta property="og:title" content="苍耳的博客">
<meta property="og:url" content="http://yoursite.com/page/11/index.html">
<meta property="og:site_name" content="苍耳的博客">
<meta property="og:description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="苍耳叔叔">
<meta property="article:tag" content="诗歌，宋词，后台，Android，Java">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/11/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>苍耳的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">苍耳的博客</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">细水长流</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/08/08/termux-app%E4%BF%AE%E6%94%B9%E5%8C%85%E5%90%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/08/termux-app%E4%BF%AE%E6%94%B9%E5%8C%85%E5%90%8D/" class="post-title-link" itemprop="url">termux-app修改包名</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-08-08 09:43:44" itemprop="dateCreated datePublished" datetime="2019-08-08T09:43:44+08:00">2019-08-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/%E6%A1%86%E6%9E%B6/" itemprop="url" rel="index"><span itemprop="name">框架</span></a>
                </span>
            </span>

          
            <span id="/2019/08/08/termux-app%E4%BF%AE%E6%94%B9%E5%8C%85%E5%90%8D/" class="post-meta-item leancloud_visitors" data-flag-title="termux-app修改包名" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/08/08/termux-app%E4%BF%AE%E6%94%B9%E5%8C%85%E5%90%8D/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/08/08/termux-app%E4%BF%AE%E6%94%B9%E5%8C%85%E5%90%8D/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>Termux-app是一个Android上的Linux虚拟机工具，它拥有自己的包管理工具和软件源，可以实现很多Linux上的功能。源码地址：<code>https://github.com/termux/termux-app</code>。</p>
<p>Termux在初始化安装时会从远端下载一个对应系统架构的bootstraps-arch.zip文件，它是一个Linux的基本环境，其目录结构如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">bootstraps-arch&#x2F;</span><br><span class="line">├── bin</span><br><span class="line">├── etc</span><br><span class="line">├── include</span><br><span class="line">├── lib</span><br><span class="line">├── libexec</span><br><span class="line">├── share</span><br><span class="line">├── SYMLINKS.txt</span><br><span class="line">├── tmp</span><br><span class="line">└── var</span><br></pre></td></tr></table></figure>

<p>bootstraps文件跟app的包名所绑定，如果需要将该功能集成到自己的Android项目中，则需要修改包名参数为自己的app包名，指定自定义的软件仓库，然后重新编译bootstraps.zip文件，在Termux-app项目中替换引入。</p>
<h1 id="Compiling-packages-termux-packages"><a href="#Compiling-packages-termux-packages" class="headerlink" title="Compiling packages(termux-packages)"></a>Compiling packages(termux-packages)</h1><p>需要在机器上安装docker环境，由于编译termux-packages需要一些系统环境，因此使用docker来完成这个编译过程无疑是一个比较省时间的做法。docker的镜像名为：<code>termux/package-builder</code>。</p>
<ol>
<li><p>获取<code>https://github.com/termux/termux-packages</code>仓库</p>
</li>
<li><p>修改<code>termux-packages/scripts/build/termux_step_setup_variables.sh</code>(最好修改所有的package_name):</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;$&#123;TERMUX_PREFIX:=&quot;/data/data/$package_name/files/usr&quot;&#125;&quot;</span><br><span class="line">&quot;$&#123;TERMUX_ANDROID_HOME:=&quot;/data/data/$package_name/files/home&quot;&#125;&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行docker脚本进入docker容器:<code>./scripts/run-docker.sh</code></p>
</li>
<li><p>在容器中开始编译过程：<code>./build-package.sh -a arch $lib_name</code>，会在debs目录下生成对应的deb包。</p>
<p> 我在编译时使用的是<code>-a</code>参数值是<code>all</code>，必需的package可以在编译脚本中看到(下文会提到)。在build的过程中可能会出现依赖包下载失败的问题，可以在网上查找对应的依赖包下载之后放置到某个地方，然后修改对应packages的build.sh脚本参数，使之从自己定义的url出下载依赖包，build.sh的位置在：<code>termux-packages/packages/$package/build.sh</code>。</p>
</li>
</ol>
<h1 id="Create-apt-repository"><a href="#Create-apt-repository" class="headerlink" title="Create apt repository"></a>Create apt repository</h1><h2 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h2><p>由于termux软件源中的deb包是与包名绑定的，因此如果需要使用软件源则需要自己修改包名后重新编译对应的package包，然后将生成的deb包上传到自己的软件仓库上，本节主要介绍如何搭建一个<code>apt repository</code>。具体的指引可以参考<code>https://wiki.debian.org/DebianRepository/Setup</code>中的文档。</p>
<p>以下是我搭建的软件源目录结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">hearing&#x2F;</span><br><span class="line">├── bootstraps</span><br><span class="line">│   ├── bootstrap-aarch64</span><br><span class="line">│   ├── bootstrap-aarch64.zip</span><br><span class="line">│   ├── bootstrap-arm.zip</span><br><span class="line">│   ├── bootstrap-i686.zip</span><br><span class="line">│   └── bootstrap-x86_64.zip</span><br><span class="line">├── repository</span><br><span class="line">│   ├── dists</span><br><span class="line">│   |    └── stable</span><br><span class="line">│   |       ├── InRelease</span><br><span class="line">│   |       ├── main</span><br><span class="line">│   |       │   ├── binary-aarch64</span><br><span class="line">│   |       │   │   └── Packages</span><br><span class="line">│   |       │   ├── binary-all</span><br><span class="line">│   |       │   │   └── Packages</span><br><span class="line">│   |       │   ├── binary-arm</span><br><span class="line">│   |       │   │   └── Packages</span><br><span class="line">│   |       │   ├── binary-i686</span><br><span class="line">│   |       │   │   └── Packages</span><br><span class="line">│   |       │   └── binary-x86_64</span><br><span class="line">│   |       │       └── Packages</span><br><span class="line">│   |       ├── Release</span><br><span class="line">|   |       ├── Release.gpg</span><br><span class="line">|   |       └── repo.asc</span><br><span class="line">│   └── pool</span><br><span class="line">│       ├── aarch64</span><br><span class="line">│       |   ├── xxx.deb</span><br><span class="line">│       ├── all</span><br><span class="line">│       |   ├── xxx.deb</span><br><span class="line">│       ├── arm</span><br><span class="line">│       |   ├── xxx.deb</span><br><span class="line">│       ├── i686</span><br><span class="line">│       |   ├── xxx.deb</span><br><span class="line">│       └── x86_64</span><br><span class="line">│           ├── xxx.deb</span><br><span class="line">└── tmp</span><br><span class="line">    ├── xxx.tar.gz</span><br></pre></td></tr></table></figure>

<ul>
<li>bootstraps目录下放的是最终编译成功的zip文件</li>
<li>repository是自己制作的软件仓库</li>
<li>tmp放置的是上一步编译中下载失败的一些依赖</li>
</ul>
<h2 id="引用"><a href="#引用" class="headerlink" title="引用"></a>引用</h2><p>根据<code>https://wiki.debian.org/DebianRepository/Setup</code>中的说法，仓库分为两种，一种比较简单的是trivial archive，而另外一种复杂的仓库称为official archive。在一个official archive中，典型特征是顶层有个 dists 目录和 pool 目录。这样的好处是:</p>
<ul>
<li>将所有类型CPU的包列表(Packages或者Packages.gz文件)放在一个文件里面，这样每个机器要获取的包列表就比较小。</li>
<li>不同套件/不同CPU可共用的deb包（主要是那些 _all.deb）和源代码包，也只在 pool/all目录下存放一份。</li>
<li>源代码包(.dsc，orig.tar.xz)有路径存放，这样 dget / apt source 可以取到源代码包。</li>
</ul>
<p>对应的<code>/etc/apt/sources.list</code>配置如下:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deb http://192.168.56.47:80/hearing/repository stable main</span><br></pre></td></tr></table></figure>

<p>配置软件源的格式为：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deb|deb-src uri distribution [component1] [component2] [...]</span><br></pre></td></tr></table></figure>

<h2 id="生成Packages"><a href="#生成Packages" class="headerlink" title="生成Packages"></a>生成Packages</h2><p>Packages文件包括每个deb包的位置，描述，版本等信息，生成命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dpkg-scanpackages all/ /dev/null| gzip -9c &gt; dists/stable/main/binary-all/Packages.gz</span><br><span class="line">dpkg-scanpackages all/ /dev/null| &gt; dists/stable/main/binary-all/Packages</span><br></pre></td></tr></table></figure>

<h2 id="生成Release"><a href="#生成Release" class="headerlink" title="生成Release"></a>生成Release</h2><p>Release文件里面包含了 Packages 等文件的大小和校验和(包含MD5/SHA1/SHA256/SHA512 多种值)，如果这个文件里面所描述的 Packages 大小与校验和与实际读取到的文件不一致，apt 会拒绝这个仓库。生成命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-ftparchive release $dir &gt; Release</span><br></pre></td></tr></table></figure>

<h2 id="生成Release-gpg-和-InRelease-文件"><a href="#生成Release-gpg-和-InRelease-文件" class="headerlink" title="生成Release.gpg 和 InRelease 文件"></a>生成Release.gpg 和 InRelease 文件</h2><p>Release.gpg 是一个签名文件，随同 Release 一起出现的，比较老的客户端只认这两个文件，而 InRelease 是内嵌签名的（也就是说，将原来 Release 的内容和 Release.gpg 的内容揉到一起了，注意这里不是简单地拼到一起），新的客户端才支持这个这个文件，观察一下 Debian 和 Ubuntu 的仓库 ( <a target="_blank" rel="noopener" href="http://mirrors.ustc.edu.cn/debian/dists/jessie/">http://mirrors.ustc.edu.cn/debian/dists/jessie/</a>, <a target="_blank" rel="noopener" href="http://mirrors.ustc.edu.cn/ubuntu/dists/xenial/">http://mirrors.ustc.edu.cn/ubuntu/dists/xenial/</a> ) ，可以看到 Debian 的仓库只有 Release 和 Release.gpg 这两个文件，而 Ubuntu 仓库里面这三个文件都有。</p>
<p>如何生成这两个文件：</p>
<ul>
<li>生成自己的gpg key: <code>gpg --list-keys || gpg --gen-key</code></li>
<li>生成Release.gpg: <code>gpg --armor --detach-sign --sign -o Release.gpg Release</code></li>
<li>生成InRelease: <code>gpg --clearsign -o InRelease Release</code></li>
</ul>
<h2 id="导入公钥"><a href="#导入公钥" class="headerlink" title="导入公钥"></a>导入公钥</h2><p>当运行<code>apt update</code>的时候，会出现警告：<code>The following signatures couldn&#39;t be verified because the public key is not available: NO_PUBKEY 722D2AFAD8BAD548</code>。</p>
<p>也就是说 InRelease / Release.gpg 虽然签名了，但由于这个签名所用的公钥没有被接受，因此还是不能正常使用，有三种解决方法：</p>
<ol>
<li><p>服务端将公钥导出，然后提供给客户端导入：</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 导出</span></span><br><span class="line">gpg --export --armor 722D2AFAD8BAD548 -o my-repo.gpg-key.asc</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 导入</span></span><br><span class="line">sudo apt-key add my-repo.gpg-key.asc</span><br></pre></td></tr></table></figure>
</li>
<li><p>客户端在执行<code>apt update</code>的时候，添加<code>--allow-insecure-repositories</code>选项；在执行<code>apt install pkg</code>的时候，添加<code>--allow-unauthenticated</code>选项。</p>
</li>
<li><p>用户修改仓库的配置，改为<code>deb [trusted=yes] http://192.168.56.47:80/hearing/repository stable main</code></p>
</li>
</ol>
<h1 id="Getting-bootstraps-termux-packaging"><a href="#Getting-bootstraps-termux-packaging" class="headerlink" title="Getting bootstraps(termux-packaging)"></a>Getting bootstraps(termux-packaging)</h1><ol>
<li>将获得的deb文件上传到一个<code>apt repository</code></li>
<li>获取<code>https://github.com/termux/termux-packaging</code>仓库</li>
<li>在scripts目录下运行:<code>./generate-bootstraps.sh -p /data/data/$package_name/files/usr -r http://localhost/hearing/repository</code></li>
<li>上传得到的bootstraps.zip文件(可能需要修改bootstraps.zip中的source.list中的软件源)</li>
</ol>
<p>generate-bootstraps.sh脚本中可以看到需要的依赖包：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Package manager.</span></span><br><span class="line">pull_package apt</span><br><span class="line">pull_package game-repo</span><br><span class="line">pull_package science-repo</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Core utilities.</span></span><br><span class="line">pull_package bash</span><br><span class="line">pull_package bzip2</span><br><span class="line">pull_package command-not-found</span><br><span class="line">pull_package coreutils</span><br><span class="line">pull_package curl</span><br><span class="line">pull_package dash</span><br><span class="line">pull_package diffutils</span><br><span class="line">pull_package findutils</span><br><span class="line">pull_package gawk</span><br><span class="line">pull_package grep</span><br><span class="line">pull_package gzip</span><br><span class="line">pull_package less</span><br><span class="line">pull_package procps</span><br><span class="line">pull_package psmisc</span><br><span class="line">pull_package sed</span><br><span class="line">pull_package tar</span><br><span class="line">pull_package termux-exec</span><br><span class="line">pull_package termux-tools</span><br><span class="line">pull_package xz-utils</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Additional.</span></span><br><span class="line">pull_package busybox</span><br><span class="line">pull_package ed</span><br><span class="line">pull_package dos2unix</span><br><span class="line">pull_package inetutils</span><br><span class="line">pull_package net-tools</span><br><span class="line">pull_package patch</span><br><span class="line">pull_package unzip</span><br><span class="line">pull_package util-linux</span><br></pre></td></tr></table></figure>

<h1 id="Termux-app"><a href="#Termux-app" class="headerlink" title="Termux-app"></a>Termux-app</h1><p>将Termux-app源码中的bootstraps.zip的url替换成我们自己的url。</p>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="Java自动将deb文件分目录"><a href="#Java自动将deb文件分目录" class="headerlink" title="Java自动将deb文件分目录"></a>Java自动将deb文件分目录</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        File file = <span class="keyword">new</span> File(<span class="string">&quot;dir/debs&quot;</span>);</span><br><span class="line">        File[] debs = file.listFiles();</span><br><span class="line">        <span class="keyword">for</span> (File f : debs) &#123;</span><br><span class="line">            <span class="keyword">if</span> (f.getName().endsWith(<span class="string">&quot;aarch64.deb&quot;</span>)) &#123;</span><br><span class="line">                Runtime.getRuntime().exec(<span class="string">&quot;cp &quot;</span>+f.getPath() + <span class="string">&quot; diraarch64&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f.getName().endsWith(<span class="string">&quot;all.deb&quot;</span>)) &#123;</span><br><span class="line">                Runtime.getRuntime().exec(<span class="string">&quot;cp &quot;</span>+f.getPath() + <span class="string">&quot; dirall&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f.getName().endsWith(<span class="string">&quot;arm.deb&quot;</span>)) &#123;</span><br><span class="line">                Runtime.getRuntime().exec(<span class="string">&quot;cp &quot;</span>+f.getPath() + <span class="string">&quot; dirarm&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f.getName().endsWith(<span class="string">&quot;i686.deb&quot;</span>)) &#123;</span><br><span class="line">                Runtime.getRuntime().exec(<span class="string">&quot;cp &quot;</span>+f.getPath() + <span class="string">&quot; diri686&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f.getName().endsWith(<span class="string">&quot;x86_64.deb&quot;</span>)) &#123;</span><br><span class="line">                Runtime.getRuntime().exec(<span class="string">&quot;cp &quot;</span>+f.getPath() + <span class="string">&quot; dirx86_64&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/23/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/07/23/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Java编程思想笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-07-23 14:24:51" itemprop="dateCreated datePublished" datetime="2019-07-23T14:24:51+08:00">2019-07-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">语言</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          
            <span id="/2019/07/23/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="Java编程思想笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/07/23/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/07/23/Java%E7%BC%96%E7%A8%8B%E6%80%9D%E6%83%B3%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="考虑使用静态工厂方法替代构造方法"><a href="#考虑使用静态工厂方法替代构造方法" class="headerlink" title="考虑使用静态工厂方法替代构造方法"></a>考虑使用静态工厂方法替代构造方法</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Boolean <span class="title">valueOf</span><span class="params">(<span class="keyword">boolean</span> b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> b ? Boolean.TRUE : Boolean.FALSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="使用Builder模式替代参数过多的构造器"><a href="#使用Builder模式替代参数过多的构造器" class="headerlink" title="使用Builder模式替代参数过多的构造器"></a>使用Builder模式替代参数过多的构造器</h1><p>当类构造器的参数过多时，容易导致程序由于参数传递顺序等问题产生一些难以调试的Bug，因此有一种解决方法是JavaBeans模式，这种模式通过提供一个无参的构造器，然后通过一系列的setter方法去设置对象的属性，这种模式有两个缺点：</p>
<ul>
<li>代码冗长</li>
<li>由于构造方法在多次调用中被分割，所以在构造过程中 JavaBean 可能处于不一致的状态。一个相关的缺点是，JavaBeans 模式排除了让类不可变的可能性，并且需要增加工作以确保线程安全。</li>
</ul>
<p>另一种解决方式是Builder模式，通过在类中提供一个通常是static类型的Builder类，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Builder Pattern</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NutritionFacts</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> servingSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> servings;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> calories;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> fat;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> sodium;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> carbohydrate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Required parameters</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> servingSize;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> servings;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Optional parameters - initialized to default values</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> calories      = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> fat           = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> sodium        = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> carbohydrate  = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">(<span class="keyword">int</span> servingSize, <span class="keyword">int</span> servings)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.servingSize = servingSize;</span><br><span class="line">            <span class="keyword">this</span>.servings    = servings;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">calories</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123; </span><br><span class="line">            calories = val;      </span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">fat</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123; </span><br><span class="line">           fat = val;           </span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">sodium</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123; </span><br><span class="line">           sodium = val;        </span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">this</span>; </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Builder <span class="title">carbohydrate</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123; </span><br><span class="line">           carbohydrate = val;  </span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">this</span>; </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> NutritionFacts <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> NutritionFacts(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">NutritionFacts</span><span class="params">(Builder builder)</span> </span>&#123;</span><br><span class="line">        servingSize  = builder.servingSize;</span><br><span class="line">        servings     = builder.servings;</span><br><span class="line">        calories     = builder.calories;</span><br><span class="line">        fat          = builder.fat;</span><br><span class="line">        sodium       = builder.sodium;</span><br><span class="line">        carbohydrate = builder.carbohydrate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NutritionFacts cocaCola = <span class="keyword">new</span> NutritionFacts.Builder(<span class="number">240</span>, <span class="number">8</span>)</span><br><span class="line">    .calories(<span class="number">100</span>).sodium(<span class="number">35</span>).carbohydrate(<span class="number">27</span>).build();</span><br></pre></td></tr></table></figure>

<p>总而言之，当设计类的构造方法或静态工厂的参数超过几个时，Builder 模式是一个不错的选择，特别是如果许多参数是可选的或相同类型的。客户端代码比使用伸缩构造方法（telescoping constructors）更容易读写，并且 builder 比 JavaBeans 更安全。</p>
<h1 id="使用私有构造方法执行非实例化"><a href="#使用私有构造方法执行非实例化" class="headerlink" title="使用私有构造方法执行非实例化"></a>使用私有构造方法执行非实例化</h1><p>对于一些只包含静态方法和静态属性的类，可以采用私有构造方法防止该类被继承，从而执行非实例化。</p>
<h1 id="消除过期的对象引用"><a href="#消除过期的对象引用" class="headerlink" title="消除过期的对象引用"></a>消除过期的对象引用</h1><ul>
<li><p>内存泄漏原因之一：集合类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Can you spot the &quot;memory leak&quot;?</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Stack</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object[] elements;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Stack</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        elements = <span class="keyword">new</span> Object[DEFAULT_INITIAL_CAPACITY];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(Object e)</span> </span>&#123;</span><br><span class="line">        ensureCapacity();</span><br><span class="line">        elements[size++] = e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 内存泄漏</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (size == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EmptyStackException();</span><br><span class="line">        <span class="keyword">return</span> elements[--size];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 修改版本</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (size == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> EmptyStackException();</span><br><span class="line">        Object result = elements[--size];</span><br><span class="line">        elements[size] = <span class="keyword">null</span>; <span class="comment">// Eliminate obsolete reference</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Ensure space for at least one more element, roughly</span></span><br><span class="line"><span class="comment">    * doubling the capacity each time the array needs to grow.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ensureCapacity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (elements.length == size)</span><br><span class="line">            elements = Arrays.copyOf(elements, <span class="number">2</span> * size + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>内存泄漏原因之二：缓存。可以使用WeakHashMap来避免。</p>
</li>
<li><p>内存泄漏原因之三：监听器等回调方法。</p>
</li>
</ul>
<h1 id="避免使用Finalizer和Cleaner-Java-9-机制"><a href="#避免使用Finalizer和Cleaner-Java-9-机制" class="headerlink" title="避免使用Finalizer和Cleaner(Java 9)机制"></a>避免使用Finalizer和Cleaner(Java 9)机制</h1><h1 id="使用-try-with-resources-语句替代-try-finally"><a href="#使用-try-with-resources-语句替代-try-finally" class="headerlink" title="使用 try-with-resources 语句替代 try-finally"></a>使用 try-with-resources 语句替代 try-finally</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> Exception();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如上语句中，只会捕获finally中的异常。为了防止该问题的出现可以使用try-with-resources，这是Java 7的一个特性，Java 类库和第三方类库中的许多类和接口现在都实现或继承了AutoCloseable接口。如果你编写的类表示必须关闭的资源，那么这个类也应该实现 AutoCloseable 接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AutoCloseable</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此建议使用如下方式关闭资源：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// try-with-resources - the the best way to close resources!</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> String <span class="title">firstLineOfFile</span><span class="params">(String path)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> (BufferedReader br = <span class="keyword">new</span> BufferedReader(</span><br><span class="line">           <span class="keyword">new</span> FileReader(path))) &#123;</span><br><span class="line">       <span class="keyword">return</span> br.readLine();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// try-with-resources on multiple resources - short and sweet</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copy</span><span class="params">(String src, String dst)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> (InputStream   in = <span class="keyword">new</span> FileInputStream(src);</span><br><span class="line">         OutputStream out = <span class="keyword">new</span> FileOutputStream(dst)) &#123;</span><br><span class="line">        <span class="keyword">byte</span>[] buf = <span class="keyword">new</span> <span class="keyword">byte</span>[BUFFER_SIZE];</span><br><span class="line">        <span class="keyword">int</span> n;</span><br><span class="line">        <span class="keyword">while</span> ((n = in.read(buf)) &gt;= <span class="number">0</span>)</span><br><span class="line">            out.write(buf, <span class="number">0</span>, n);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果调用 readLine 和（不可见）close 方法都抛出异常，则后一个异常将被抑制（suppressed），而不是前者。 事实上，为了保留你真正想看到的异常，可能会抑制多个异常。 这些抑制的异常没有被抛弃， 而是打印在堆栈跟踪中，并标注为被抑制了。 你也可以使用 getSuppressed 方法以编程方式访问它们，该方法在 Java 7 中已添加到的 Throwable 中。</p>
<p>可以在 try-with-resources 语句中添加 catch 子句，就像在常规的 try-finally 语句中一样。这允许你处理异常，而不会在另一层嵌套中污染代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// try-with-resources with a catch clause</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> String <span class="title">firstLineOfFile</span><span class="params">(String path, String defaultVal)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> (BufferedReader br = <span class="keyword">new</span> BufferedReader(</span><br><span class="line">           <span class="keyword">new</span> FileReader(path))) &#123;</span><br><span class="line">        <span class="keyword">return</span> br.readLine();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> defaultVal;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="重写equals方法"><a href="#重写equals方法" class="headerlink" title="重写equals方法"></a>重写equals方法</h1><p>重写equals方法必须遵守相应的规则：</p>
<ul>
<li>自反性： 对于任何非空引用 x，x.equals(x) 必须返回 true。</li>
<li>对称性： 对于任何非空引用 x 和 y，如果且仅当 y.equals(x) 返回 true 时 x.equals(y) 必须返回 true。</li>
<li>传递性： 对于任何非空引用 x、y、z，如果 x.equals(y) 返回 true，y.equals(z) 返回 true，则 x.equals(z) 必须返回 true。</li>
<li>一致性： 对于任何非空引用 x 和 y，如果在 equals 比较中使用的信息没有修改，则 x.equals(y) 的多次调用必须始终返回 true 或始终返回 false。</li>
<li>对于任何非空引用 x，x.equals(null) 必须返回 false。</li>
<li>重写equals方法一定要重写hashCode方法。</li>
</ul>
<p>equals方法与hashCode方法有几个约定：</p>
<ul>
<li>当在一个应用程序执行过程中，如果在 equals 方法比较中没有修改任何信息，在一个对象上重复调用 hashCode 方法时，它必须始终返回相同的值。从一个应用程序到另一个应用程序的每一次执行返回的值可以是不一致的。</li>
<li>如果两个对象根据 equals(Object) 方法比较是相等的，那么在两个对象上调用 hashCode 就必须产生的结果是相同的整数。</li>
<li>如果两个对象根据 equals(Object) 方法比较并不相等，则不要求在每个对象上调用 hashCode 都必须产生不同的结果。 但是，程序员应该意识到，为不相等的对象生成不同的结果可能会提高散列表（hash tables）的性能。</li>
</ul>
<p>当不重写 hashCode 时，所违反第二个关键条款是：相等的对象必须具有相等的哈希码（ hash codes）。 </p>
<h1 id="始终重写toString方法"><a href="#始终重写toString方法" class="headerlink" title="始终重写toString方法"></a>始终重写toString方法</h1><h1 id="谨慎地重写clone方法"><a href="#谨慎地重写clone方法" class="headerlink" title="谨慎地重写clone方法"></a>谨慎地重写clone方法</h1><h1 id="考虑实现Comparable接口"><a href="#考虑实现Comparable接口" class="headerlink" title="考虑实现Comparable接口"></a>考虑实现Comparable接口</h1><h1 id="使类和成员的可访问性最小化"><a href="#使类和成员的可访问性最小化" class="headerlink" title="使类和成员的可访问性最小化"></a>使类和成员的可访问性最小化</h1><ul>
<li>private —— 该成员只能在声明它的顶级类内访问。</li>
<li>package-private —— 成员可以从被声明的包中的任何类中访问。从技术上讲，如果没有指定访问修饰符（接口成员除外，它默认是公共的），这是默认访问级别。</li>
<li>protected —— 成员可以从被声明的类的子类中访问（会受一些限制 [JLS, 6.6.2]），以及它声明的包中的任何类。</li>
<li>public —— 该成员可以从任何地方被访问。</li>
</ul>
<h1 id="最小化可变性"><a href="#最小化可变性" class="headerlink" title="最小化可变性"></a>最小化可变性</h1><p>不可变类简单来说是它的实例不能被修改的类。包含在每个实例中的所有信息在对象的生命周期中是固定的，因此不会观察到任何变化。Java平台类库包含许多不可变的类，包括 String 类，基本类型包装类以及 BigInteger 类和 BigDecimal 类。</p>
<p>不可变类比可变类更容易设计，实现和使用。他们不太容易出错，更安全。除非有充分的理由使类成为可变类，否则类应该是不可变的。要使一个类不可变，需要遵循以下五条规则：</p>
<ul>
<li>不要提供修改对象状态的方法。</li>
<li>确保这个类不能被继承。</li>
<li>把所有属性设置为 final。</li>
<li>把所有的属性设置为 private。</li>
<li>确保对任何可变组件的互斥访问。如果你的类有任何引用可变对象的属性，请确保该类的客户端无法获得对这些对象的引用。切勿将这样的属性初始化为客户端提供的对象引用，或从访问方法返回属性。在构造方法，访问方法和 readObject 方法中进行防御性拷贝。</li>
</ul>
<p>不可变的特点：</p>
<ul>
<li>不可变对象本质上是线程安全的; 它们不需要同步</li>
<li>不仅可以共享不可变的对象，而且可以共享内部信息</li>
<li>不可变对象为其他对象提供了很好的构件</li>
<li>不可变对象提供了免费的原子失败机制</li>
<li>不可变类的主要缺点是对于每个不同的值都需要一个单独的对象</li>
</ul>
<p>为了保证不变性，一个类不得允许子类化，这可以通过使类用 final 修饰，但是还有另外一个更灵活的选择：可以使其所有的构造方法私有或包级私有，并添加公共静态工厂，而不是公共构造方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Immutable class with static factories instead of constructors</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Complex</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">double</span> re;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">double</span> im;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Complex</span><span class="params">(<span class="keyword">double</span> re, <span class="keyword">double</span> im)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.re = re;</span><br><span class="line">        <span class="keyword">this</span>.im = im;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Complex <span class="title">valueOf</span><span class="params">(<span class="keyword">double</span> re, <span class="keyword">double</span> im)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Complex(re, im);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ... <span class="comment">// Remainder unchanged</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总而言之，坚决不要为每个属性编写一个 get 方法后再编写一个对应的 set 方法。 除非有充分的理由使类成为可变类，否则类应该是不可变的。 不可变类提供了许多优点，唯一的缺点是在某些情况下可能会出现性能问题。 </p>
<h1 id="组合优于继承（装饰器模式）"><a href="#组合优于继承（装饰器模式）" class="headerlink" title="组合优于继承（装饰器模式）"></a>组合优于继承（装饰器模式）</h1><p>继承打破了封装，换句话说，一个子类依赖于其父类的实现细节来保证其正确的功能。 父类的实现可能会从发布版本不断变化，如果是这样，子类可能会被破坏，即使它的代码没有任何改变。 因此，一个子类必须与其超类一起更新而变化，除非父类的作者为了继承的目的而专门设计它，并对应有文档的说明。</p>
<p>为了具体说明，假设有一个使用 HashSet 的程序，为了调整程序的性能，需要查询 HashSet ，从创建它之后已经添加了多少个元素，为了提供这个功能，编写了一个 HashSet 变体，它保留了尝试元素插入的数量，并导出了这个插入数量的一个访问方法，HashSet 类包含两个添加元素的方法，分别是 add 和 addAll，所以我们重写这两个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Broken - Inappropriate use of inheritance!</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InstrumentedHashSet</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">HashSet</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line">    <span class="comment">// The number of attempted element insertions</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> addCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InstrumentedHashSet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InstrumentedHashSet</span><span class="params">(<span class="keyword">int</span> initCap, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(initCap, loadFactor);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">        addCount++;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.add(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addAll</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">        addCount += c.size();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.addAll(c);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAddCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> addCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时的addAll方法会出现一个问题，因为在其内又调用了add方法，因此计数器叠加了两次。</p>
<p>为了解决这个问题，可以使用组合替代继承。给新类增加一个私有属性，该属性是现有类的实例引用，这种设计被称为组合。因此可以这样修改上述功能代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForwardingSet</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">Set</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;E&gt; s;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ForwardingSet</span><span class="params">(Set&lt;E&gt; s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.s = s;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        s.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s.contains(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s.isEmpty();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s.size();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterator&lt;E&gt; <span class="title">iterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s.iterator();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s.add(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s.remove(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">containsAll</span><span class="params">(Collection&lt;?&gt; c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s.containsAll(c);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addAll</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s.addAll(c);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">removeAll</span><span class="params">(Collection&lt;?&gt; c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s.removeAll(c);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">retainAll</span><span class="params">(Collection&lt;?&gt; c)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s.retainAll(c);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object[] toArray() &#123;</span><br><span class="line">        <span class="keyword">return</span> s.toArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T[] toArray(T[] a) &#123;</span><br><span class="line">        <span class="keyword">return</span> s.toArray(a);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s.equals(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s.hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InstrumentedSet</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">ForwardingSet</span>&lt;<span class="title">E</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> addCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InstrumentedSet</span><span class="params">(Set&lt;E&gt; s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(s);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">        addCount++;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.add(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">addAll</span><span class="params">(Collection&lt;? extends E&gt; c)</span> </span>&#123;</span><br><span class="line">        addCount += c.size();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.addAll(c);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAddCount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> addCount;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>InstrumentedSet 类被称为包装类，因为每个 InstrumentedSet 实例都包含（“包装”）另一个 Set 实例。 这也被称为装饰器模式，因为 InstrumentedSet 类通过添加计数功能来“装饰”一个集合。</p>
<p>总之，继承是强大的，但它是有问题的，因为它违反封装。 只有在子类和父类之间存在真正的子类型关系时才适用。 即使如此，如果子类与父类不在同一个包中，并且父类不是为继承而设计的，继承可能会导致脆弱性。 为了避免这种脆弱性，使用合成和转发代替继承，特别是如果存在一个合适的接口来实现包装类。 包装类不仅比子类更健壮，而且更强大。</p>
<h1 id="接口优于抽象类"><a href="#接口优于抽象类" class="headerlink" title="接口优于抽象类"></a>接口优于抽象类</h1><p>接口通过包装类模式确保安全的，强大的功能增强成为可能。如果使用抽象类来定义类型，那么只能继承，生成的类比包装类更脆弱。</p>
<h1 id="接口仅用来定义类型"><a href="#接口仅用来定义类型" class="headerlink" title="接口仅用来定义类型"></a>接口仅用来定义类型</h1><h1 id="使用静态成员类而不是非静态类"><a href="#使用静态成员类而不是非静态类" class="headerlink" title="使用静态成员类而不是非静态类"></a>使用静态成员类而不是非静态类</h1><p>如果声明了一个不需要访问宿主实例的成员类，应该使它成为一个静态成员类，而不是非静态的成员类，因为非静态内部类的每个实例都会有一个隐藏的外部引用给它的宿主实例，如前所述，存储这个引用需要占用时间和空间；更严重的是可能会导致即使宿主类在满足垃圾回收的条件时却仍然驻留在内存中，由此产生的内存泄漏可能是灾难性的，由于引用是不可见的，所以通常难以检测到。</p>
<h1 id="将源文件限制为单个顶级类"><a href="#将源文件限制为单个顶级类" class="headerlink" title="将源文件限制为单个顶级类"></a>将源文件限制为单个顶级类</h1><p>虽然 Java 编译器允许在单个源文件中定义多个顶级类，但这样做没有任何好处，并且存在重大风险。风险源于在源文件中定义多个顶级类使得为类提供多个定义成为可能，使用哪个定义会受到源文件传递给编译器的顺序的影响。</p>
<h1 id="不要使用原始类型"><a href="#不要使用原始类型" class="headerlink" title="不要使用原始类型"></a>不要使用原始类型</h1><table>
<thead>
<tr>
<th align="center">术语</th>
<th align="center">中文含义</th>
<th align="center">举例</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Parameterized type</td>
<td align="center">参数化类型</td>
<td align="center">List&lt;String&gt;</td>
</tr>
<tr>
<td align="center">Actual type parameter</td>
<td align="center">实际类型参数</td>
<td align="center">String</td>
</tr>
<tr>
<td align="center">Generic type</td>
<td align="center">泛型类型</td>
<td align="center">List&lt;E&gt;</td>
</tr>
<tr>
<td align="center">Formal type parameter</td>
<td align="center">形式类型参数</td>
<td align="center">E</td>
</tr>
<tr>
<td align="center">Unbounded wildcard type</td>
<td align="center">无限制通配符类型</td>
<td align="center">List&lt;?&gt;</td>
</tr>
<tr>
<td align="center">Raw type</td>
<td align="center">原始类型</td>
<td align="center">List</td>
</tr>
<tr>
<td align="center">Bounded type parameter</td>
<td align="center">限制类型参数</td>
<td align="center">&lt;E extends Number&gt;</td>
</tr>
<tr>
<td align="center">Recursive type bound</td>
<td align="center">递归类型限制</td>
<td align="center">&lt;T extends Comparable&lt;T&gt;&gt;</td>
</tr>
<tr>
<td align="center">Bounded wildcard type</td>
<td align="center">限制通配符类型</td>
<td align="center">List&lt;? extends Number&gt;</td>
</tr>
<tr>
<td align="center">Generic method</td>
<td align="center">泛型方法</td>
<td align="center">static &lt;E&gt; List&lt;E&gt; asList(E[] a)</td>
</tr>
<tr>
<td align="center">Type token</td>
<td align="center">类型令牌</td>
<td align="center">String.class</td>
</tr>
</tbody></table>
<h1 id="列表优于数组"><a href="#列表优于数组" class="headerlink" title="列表优于数组"></a>列表优于数组</h1><p>数组是协变的（covariant），这意味着如果 Sub 是 Super 的子类型，则数组类型 Sub[] 是数组类型 Super[] 的子类型；相比之下，泛型是不变的（invariant），对于任何两种不同的类型 Type1 和 Type2，List<Type1> 既不是 List<Type2> 的子类型也不是父类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Fails at runtime!</span></span><br><span class="line">Object[] objectArray = <span class="keyword">new</span> Long[<span class="number">1</span>];</span><br><span class="line">objectArray[<span class="number">0</span>] = <span class="string">&quot;I don&#x27;t fit in&quot;</span>; <span class="comment">// Throws ArrayStoreException</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Won&#x27;t compile!</span></span><br><span class="line">List&lt;Object&gt; ol = <span class="keyword">new</span> ArrayList&lt;Long&gt;(); <span class="comment">// Incompatible types</span></span><br><span class="line">ol.add(<span class="string">&quot;I don&#x27;t fit in&quot;</span>);</span><br></pre></td></tr></table></figure>

<h1 id="优先考虑泛型"><a href="#优先考虑泛型" class="headerlink" title="优先考虑泛型"></a>优先考虑泛型</h1><h1 id="使用限定通配符来增加API的灵活性"><a href="#使用限定通配符来增加API的灵活性" class="headerlink" title="使用限定通配符来增加API的灵活性"></a>使用限定通配符来增加API的灵活性</h1><h1 id="使用枚举类型替代整型常量"><a href="#使用枚举类型替代整型常量" class="headerlink" title="使用枚举类型替代整型常量"></a>使用枚举类型替代整型常量</h1><h1 id="注解优于命名模式"><a href="#注解优于命名模式" class="headerlink" title="注解优于命名模式"></a>注解优于命名模式</h1><p>如下实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Anonymous class instance as a function object - obsolete!</span></span><br><span class="line">Collections.sort(words, <span class="keyword">new</span> Comparator&lt;String&gt;() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(String s1, String s2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Integer.compare(s1.length(), s2.length());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>可以修改为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Lambda expression as function object (replaces anonymous class)</span></span><br><span class="line">Collections.sort(words, (s1, s2) -&gt; Integer.compare(s1.length(), s2.length()));</span><br></pre></td></tr></table></figure>

<p>另一个实例，在枚举中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Enum type with constant-specific class bodies &amp; data </span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Operation</span> </span>&#123;</span><br><span class="line">    PLUS(<span class="string">&quot;+&quot;</span>) &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">apply</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123; <span class="keyword">return</span> x + y; &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    MINUS(<span class="string">&quot;-&quot;</span>) &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">apply</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123; <span class="keyword">return</span> x - y; &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    TIMES(<span class="string">&quot;*&quot;</span>) &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">apply</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123; <span class="keyword">return</span> x * y; &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    DIVIDE(<span class="string">&quot;/&quot;</span>) &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">apply</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123; <span class="keyword">return</span> x / y; &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String symbol;</span><br><span class="line"></span><br><span class="line">    Operation(String symbol) &#123; <span class="keyword">this</span>.symbol = symbol; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> symbol; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">double</span> <span class="title">apply</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DoubleBinaryOperator 接口是 java.util.function 中许多预定义的函数接口之一，它表示一个函数，它接受两个 double 类型参数并返回 double 类型的结果。因此可以修改上述枚举如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">Operation</span> </span>&#123;</span><br><span class="line">    PLUS  (<span class="string">&quot;+&quot;</span>, (x, y) -&gt; x + y),</span><br><span class="line">    MINUS (<span class="string">&quot;-&quot;</span>, (x, y) -&gt; x - y),</span><br><span class="line">    TIMES (<span class="string">&quot;*&quot;</span>, (x, y) -&gt; x * y),</span><br><span class="line">    DIVIDE(<span class="string">&quot;/&quot;</span>, (x, y) -&gt; x / y);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String symbol;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DoubleBinaryOperator op;</span><br><span class="line"></span><br><span class="line">    Operation(String symbol, DoubleBinaryOperator op) &#123;</span><br><span class="line">        <span class="keyword">this</span>.symbol = symbol;</span><br><span class="line">        <span class="keyword">this</span>.op = op;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> symbol; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">apply</span><span class="params">(<span class="keyword">double</span> x, <span class="keyword">double</span> y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> op.applyAsDouble(x, y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>lambda 没有名称和文档; 如果计算不是自解释的，或者超过几行，则不要将其放入 lambda 表达式中。 一行代码对于 lambda 说是理想的，三行代码是合理的最大值。</p>
<p>Lambda 仅限于函数式接口，它不能获取对自身的引用。</p>
<h1 id="通过接口引用对象"><a href="#通过接口引用对象" class="headerlink" title="通过接口引用对象"></a>通过接口引用对象</h1><h1 id="明智地进行优化"><a href="#明智地进行优化" class="headerlink" title="明智地进行优化"></a>明智地进行优化</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">不要去计较效率上的一些小小的得失，在 97% 的情况下，不成熟的优化才是一切问题的根源。</span><br><span class="line">    —Donald E. Knuth [Knuth74]</span><br></pre></td></tr></table></figure>

<h1 id="对可恢复的情况使用受检异常，对编程错误使用运行时异常"><a href="#对可恢复的情况使用受检异常，对编程错误使用运行时异常" class="headerlink" title="对可恢复的情况使用受检异常，对编程错误使用运行时异常"></a>对可恢复的情况使用受检异常，对编程错误使用运行时异常</h1><p>对于可恢复的情况，要抛出受检异常；对于程序错误，就要抛出运行时异常。不确定是否可恢复，就抛出为受检异常。不要定义任何既不是受检异常也不是运行异常的抛出类型。要在受检异常上提供方法，以便协助程序恢复。</p>
<p>但是要避免不必要的使用受检异常。</p>
<h1 id="抛出与抽象对应的异常"><a href="#抛出与抽象对应的异常" class="headerlink" title="抛出与抽象对应的异常"></a>抛出与抽象对应的异常</h1><p>为了避免方法抛出的异常和它所执行的任务没有任何关系，我们可以在程序中进行异常转译：<strong>更高层的实现应该捕获低层的异常，同时抛出可以按照高层抽象进行解释的异常</strong>，如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">    ListIterator&lt;E&gt; i = listIterator(index);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span>(i.next() );</span><br><span class="line">    &#125; <span class="keyword">catch</span> (NoSuchElementException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(<span class="string">&quot;Index: &quot;</span> + index);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果不能阻止或者处理来自更低层的异常，一般的做法是使用异常转译，只有在低层方法的规范碰巧可以保证“它所抛出的所有异常对于更高层也是合适的”情况下，才可以将异常从低层传播到高层。异常链对高层和低层异常都提供了最佳的功能：它允许抛出适当的高层异常，同时又能捕获低层的原因进行失败分析。</p>
<h1 id="保持失败原子性"><a href="#保持失败原子性" class="headerlink" title="保持失败原子性"></a>保持失败原子性</h1><p>当对象抛出异常之后，通常我们期望这个对象仍然保持在一种定义良好的可用状态之中，即使失败是发生在执行某个操作的过程中间。对于受检异常而言，这尤为重要，因为调用者期望能从这种异常中进行恢复。一般而言，失败的方法调用应该使对象保持在被调用之前的状态，具有这种属性的方法被称为具有失败原子性 （failure atomic）。</p>
<p>有几种途径可以实现这种效果：</p>
<ol>
<li><p>设计不可变的对象。如果一个操作失败了，它可能会阻止创建新的对象，但是永远也不会使已有的对象保持在不一致的状态之中，因为当每个对象被创建之后它就处于一致的状态之中，以后也不会再发生变化。</p>
</li>
<li><p>在可变对象上执行操作时，获得失败原子性最常见的办法是，在执行操作之前检查参数的有效性，这可以使得在对象的状态被修改之前，先抛出适当的异常。如下代码所示：</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( size == <span class="number">0</span> )</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> EmptyStackException();</span><br><span class="line">    Object result = elements[--size];</span><br><span class="line">    elements[size] = <span class="keyword">null</span>; <span class="comment">/* Eliminate obsolete reference */</span></span><br><span class="line">    <span class="keyword">return</span>(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 另一种类似的方式是：调整计算处理过程的顺序，使得任何可能会失败的计算部分都在对象状态被修改之前发生。</p>
</li>
<li><p>在对象的一份临时拷贝上执行操作，当操作完成之后再用临时拷贝中的结果代替对象的内容。</p>
</li>
<li><p>编写一段恢复代码 （recovery code），由它来拦截操作过程中发生的失败，以及便对象回滚到操作开始之前的状态上，这种办法主要用于永久性的（基于磁盘的）数据结构。</p>
</li>
</ol>
<p>总而言之，作为方法规范的一部分，它产生的任何异常都应该让对象保持在调用该方法之前的状态。如果违反这条规则， API 文档就应该清楚地指明对象将会处于什么样的状态。遗憾的是，大量现有的 API 文档都未能做到这一点。</p>
<h1 id="不要忽略异常"><a href="#不要忽略异常" class="headerlink" title="不要忽略异常"></a>不要忽略异常</h1><p>如果选择忽略异常，catch 块中应该包含一条注释，说明为什么可以这么做。</p>
<h1 id="谨慎地使用延迟初始化"><a href="#谨慎地使用延迟初始化" class="headerlink" title="谨慎地使用延迟初始化"></a>谨慎地使用延迟初始化</h1><h1 id="考虑使用自定义的序列化形式"><a href="#考虑使用自定义的序列化形式" class="headerlink" title="考虑使用自定义的序列化形式"></a>考虑使用自定义的序列化形式</h1><h1 id="移位运算比乘除法快"><a href="#移位运算比乘除法快" class="headerlink" title="移位运算比乘除法快"></a>移位运算比乘除法快</h1><ul>
<li>从效率上看，使用移位指令有更高的效率，因为移位指令占2个机器周期，而乘除法指令占4个机器周期。</li>
<li>从硬件上看，移位对硬件而言更容易实现。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/30/asp-net-core%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/30/asp-net-core%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">asp.net-core学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-04-30 10:58:29" itemprop="dateCreated datePublished" datetime="2019-04-30T10:58:29+08:00">2019-04-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E5%8F%B0/" itemprop="url" rel="index"><span itemprop="name">后台</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%8E%E5%8F%B0/Asp/" itemprop="url" rel="index"><span itemprop="name">Asp</span></a>
                </span>
            </span>

          
            <span id="/2019/04/30/asp-net-core%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="asp.net-core学习笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/04/30/asp-net-core%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/04/30/asp-net-core%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><table>
<thead>
<tr>
<th align="left">ASP.NET Core</th>
<th align="left">ASP.NET 4.x</th>
</tr>
</thead>
<tbody><tr>
<td align="left">针对 Windows、macOS 或 Linux 进行生成</td>
<td align="left">针对 Windows 进行生成</td>
</tr>
<tr>
<td align="left">Razor 页面 是在 ASP.NET Core 2.x 及更高版本中创建 Web UI 时建议使用的方法。</td>
<td align="left">使用 Web 窗体、SignalR、MVC、Web API、WebHooks 或网页</td>
</tr>
<tr>
<td align="left">每个计算机多个版本</td>
<td align="left">每个计算机一个版本</td>
</tr>
<tr>
<td align="left">使用 C# 或 F# 通过 Visual Studio、Visual Studio for Mac 或 Visual Studio Code 进行开发</td>
<td align="left">使用 C#、VB 或 F# 通过 Visual Studio 进行开发</td>
</tr>
<tr>
<td align="left">比 ASP.NET 4.x 性能更高</td>
<td align="left">良好的性能</td>
</tr>
<tr>
<td align="left">选择 .NET Framework 或 .NET Core 运行时</td>
<td align="left">使用 .NET Framework 运行时</td>
</tr>
</tbody></table>
<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><h2 id="依赖注入"><a href="#依赖注入" class="headerlink" title="依赖注入"></a>依赖注入</h2><h3 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h3><ul>
<li>使用接口抽象化依赖关系实现。</li>
<li>注册服务容器中的依赖关系，ASP.NET Core 提供了一个内置的服务容器 IServiceProvider，服务已在应用的 Startup.ConfigureServices 方法中注册。</li>
<li>将服务注入到使用它的类的构造函数中，框架负责创建依赖关系的实例，并在不再需要时对其进行处理。</li>
</ul>
<p>实例：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IMyDependency</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">Task <span class="title">WriteMessage</span>(<span class="params"><span class="keyword">string</span> message</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyDependency</span> : <span class="title">IMyDependency</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> ILogger&lt;MyDependency&gt; _logger;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyDependency</span>(<span class="params">ILogger&lt;MyDependency&gt; logger</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Task <span class="title">WriteMessage</span>(<span class="params"><span class="keyword">string</span> message</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _logger.LogInformation(</span><br><span class="line">            <span class="string">&quot;MyDependency.WriteMessage called. Message: &#123;MESSAGE&#125;&quot;</span>, </span><br><span class="line">            message);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Task.FromResult(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    services.AddMvc().SetCompatibilityVersion(CompatibilityVersion.Version_2_2);</span><br><span class="line"></span><br><span class="line">    services.AddScoped&lt;IMyDependency, MyDependency&gt;();</span><br><span class="line">    services.AddTransient&lt;IOperationTransient, Operation&gt;();</span><br><span class="line">    services.AddScoped&lt;IOperationScoped, Operation&gt;();</span><br><span class="line">    services.AddSingleton&lt;IOperationSingleton, Operation&gt;();</span><br><span class="line">    services.AddSingleton&lt;IOperationSingletonInstance&gt;(<span class="keyword">new</span> Operation(Guid.Empty));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// OperationService depends on each of the other Operation types.</span></span><br><span class="line">    services.AddTransient&lt;OperationService, OperationService&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MyDependency 在其构造函数中请求 ILogger<TCategoryName>，以链式方式使用依赖关系注入并不罕见，每个请求的依赖关系相应地请求其自己的依赖关系，容器解析图中的依赖关系并返回完全解析的服务。</p>
<h3 id="服务生存期"><a href="#服务生存期" class="headerlink" title="服务生存期"></a>服务生存期</h3><h4 id="暂时"><a href="#暂时" class="headerlink" title="暂时"></a>暂时</h4><p>暂时生存期服务是每次从服务容器进行请求时创建的，这种生存期适合轻量级、无状态的服务。</p>
<h4 id="作用域（Scoped）"><a href="#作用域（Scoped）" class="headerlink" title="作用域（Scoped）"></a>作用域（Scoped）</h4><p>作用域生存期服务以每个客户端请求（连接）一次的方式创建。</p>
<p>警告：在中间件内使用有作用域的服务时，请将该服务注入至 Invoke 或 InvokeAsync 方法，请不要通过构造函数注入进行注入，因为它会强制服务的行为与单一实例类似。</p>
<h4 id="单例"><a href="#单例" class="headerlink" title="单例"></a>单例</h4><p>单一实例生存期服务是在第一次请求时（或者在运行 ConfigureServices 并且使用服务注册指定实例时）创建的，每个后续请求都使用相同的实例，如果应用需要单一实例行为，建议允许服务容器管理服务的生存期，不要实现单一实例设计模式并提供用户代码来管理对象在类中的生存期。</p>
<p>警告：从单一实例解析有作用域的服务很危险，当处理后续请求时，它可能会导致服务处于不正确的状态。</p>
<h1 id="Razor页面"><a href="#Razor页面" class="headerlink" title="Razor页面"></a>Razor页面</h1><h2 id="入门"><a href="#入门" class="headerlink" title="入门"></a>入门</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 新建Razor页面项目</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> dotnet new webapp -o RazorPagesMovie</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 本地部署</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> dotnet run</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出</span></span><br><span class="line">: Microsoft.AspNetCore.DataProtection.KeyManagement.XmlKeyManager[0]</span><br><span class="line">      User profile is available. Using &#x27;/home/hearing/.aspnet/DataProtection-Keys&#x27; as key repository; keys will not be encrypted at rest.</span><br><span class="line">Hosting environment: Development</span><br><span class="line">Content root path: /home/hearing/WorkSpace/asp/hello</span><br><span class="line">Now listening on: https://localhost:5001</span><br><span class="line">Now listening on: http://localhost:5000</span><br></pre></td></tr></table></figure>

<p>项目文件：</p>
<ul>
<li>Pages 文件夹：包含 Razor 页面和支持文件。 每个 Razor 页面都是一对文件：<ul>
<li>一个 .cshtml 文件，其中包含使用 Razor 语法的 C＃ 代码的 HTML 标记。</li>
<li>一个 .cshtml.cs 文件，其中包含处理页面事件的 C# 代码。</li>
<li>支持文件的名称以下划线开头。例如，_Layout.cshtml 文件可配置所有页面通用的 UI 元素。 此文件设置页面顶部的导航菜单和页面底部的版权声明。</li>
</ul>
</li>
<li>wwwroot文件夹：包含静态文件，如 HTML 文件、JavaScript 文件和 CSS 文件。</li>
<li>appsettings.json：包含配置数据，如连接字符串。</li>
<li>Program.cs：包含程序的入口点。</li>
<li>Startup.cs：包含配置应用行为的代码，例如，是否需要同意 cookie。 有关更多信息，请参见ASP.NET Core 中的应用启动。</li>
</ul>
<h1 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h1><h2 id="入门-1"><a href="#入门-1" class="headerlink" title="入门"></a>入门</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 新建Razor页面项目</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> dotnet new mvc -o MvcHello</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 本地部署</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> dotnet run</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 输出</span></span><br><span class="line">: Microsoft.AspNetCore.DataProtection.KeyManagement.XmlKeyManager[0]</span><br><span class="line">      User profile is available. Using &#x27;/home/hearing/.aspnet/DataProtection-Keys&#x27; as key repository; keys will not be encrypted at rest.</span><br><span class="line">Hosting environment: Development</span><br><span class="line">Content root path: /home/hearing/WorkSpace/asp/MvcHello</span><br><span class="line">Now listening on: https://localhost:5001</span><br><span class="line">Now listening on: http://localhost:5000</span><br></pre></td></tr></table></figure>

<p>目录结构：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">MvcHello</span><br><span class="line">├── appsettings.Development.json</span><br><span class="line">├── appsettings.json</span><br><span class="line">├── bin</span><br><span class="line">│   └── Debug</span><br><span class="line">│       └── netcoreapp2.2</span><br><span class="line">├── Controllers</span><br><span class="line">│   ├── HelloWorldController.cs</span><br><span class="line">│   └── HomeController.cs</span><br><span class="line">├── Models</span><br><span class="line">│   └── ErrorViewModel.cs</span><br><span class="line">├── MvcHello.csproj</span><br><span class="line">├── obj</span><br><span class="line">│   ├── Debug</span><br><span class="line">│   │   └── netcoreapp2.2</span><br><span class="line">│   ├── MvcHello.csproj.nuget.cache</span><br><span class="line">│   ├── MvcHello.csproj.nuget.dgspec.json</span><br><span class="line">│   ├── MvcHello.csproj.nuget.g.props</span><br><span class="line">│   ├── MvcHello.csproj.nuget.g.targets</span><br><span class="line">│   └── project.assets.json</span><br><span class="line">├── Program.cs</span><br><span class="line">├── Properties</span><br><span class="line">│   └── launchSettings.json</span><br><span class="line">├── Startup.cs</span><br><span class="line">├── Views</span><br><span class="line">│   ├── Home</span><br><span class="line">│   │   ├── Index.cshtml</span><br><span class="line">│   │   └── Privacy.cshtml</span><br><span class="line">│   ├── Shared</span><br><span class="line">│   │   ├── _CookieConsentPartial.cshtml</span><br><span class="line">│   │   ├── Error.cshtml</span><br><span class="line">│   │   ├── _Layout.cshtml</span><br><span class="line">│   │   └── _ValidationScriptsPartial.cshtml</span><br><span class="line">│   ├── _ViewImports.cshtml</span><br><span class="line">│   └── _ViewStart.cshtml</span><br><span class="line">└── wwwroot</span><br><span class="line">    ├── css</span><br><span class="line">    │   └── site.css</span><br><span class="line">    ├── favicon.ico</span><br><span class="line">    ├── js</span><br><span class="line">    │   └── site.js</span><br><span class="line">    └── lib</span><br><span class="line">        ├── bootstrap</span><br><span class="line">        ├── jquery</span><br><span class="line">        ├── jquery-validation</span><br><span class="line">        └── jquery-validation-unobtrusive</span><br></pre></td></tr></table></figure>

<h2 id="Route"><a href="#Route" class="headerlink" title="Route"></a>Route</h2><p>在 Startup类 的Configure 方法中，可能会看到与下面类似的代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app.UseMvc(routes =&gt; &#123;</span><br><span class="line">   routes.MapRoute(<span class="string">&quot;default&quot;</span>, <span class="string">&quot;&#123;controller=Home&#125;/&#123;action=Index&#125;/&#123;id?&#125;&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在对 UseMvc 的调用中，MapRoute 用于创建单个路由，亦称 default 路由。大多数 MVC 应用使用带有模板的路由，与 default 路由类似。路由模板：</p>
<ul>
<li>{controller=Home} 将 Home 定义为默认 controller</li>
<li>{action=Index} 将 Index 定义为默认 action</li>
<li>{id?} 将 id 定义为可选参数</li>
</ul>
<p>路由模板 “{controller=Home}/{action=Index}/{id?}” 可以匹配诸如 /Products/Details/5 之类的 URL 路径，并通过对路径进行标记来提取路由值 { controller = Products, action = Details, id = 5 }。 MVC 将尝试查找名为 ProductsController 的控制器并运行 Details 操作：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProductsController</span> : <span class="title">Controller</span> &#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Details</span>(<span class="params"><span class="keyword">int</span> id</span>)</span> &#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="依赖关系注入"><a href="#依赖关系注入" class="headerlink" title="依赖关系注入"></a>依赖关系注入</h2><h3 id="控制器"><a href="#控制器" class="headerlink" title="控制器"></a>控制器</h3><h4 id="构造函数注入"><a href="#构造函数注入" class="headerlink" title="构造函数注入"></a>构造函数注入</h4><p>服务作为构造函数参数添加，并且运行时从服务容器中解析服务，通常使用接口来定义服务。例如，考虑需要当前时间的应用，以下接口公开 IDateTime 服务：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IDateTime</span></span><br><span class="line">&#123;</span><br><span class="line">    DateTime Now &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SystemDateTime</span> : <span class="title">IDateTime</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> DateTime Now</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> DateTime.Now; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注册：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    services.AddSingleton&lt;IDateTime, SystemDateTime&gt;();</span><br><span class="line"></span><br><span class="line">    services.AddMvc().SetCompatibilityVersion(CompatibilityVersion.Version_2_2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HomeController</span> : <span class="title">Controller</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> IDateTime _dateTime;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HomeController</span>(<span class="params">IDateTime dateTime</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _dateTime = dateTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> serverTime = _dateTime.Now;</span><br><span class="line">        <span class="keyword">if</span> (serverTime.Hour &lt; <span class="number">12</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ViewData[<span class="string">&quot;Message&quot;</span>] = <span class="string">&quot;It&#x27;s morning here - Good Morning!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (serverTime.Hour &lt; <span class="number">17</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ViewData[<span class="string">&quot;Message&quot;</span>] = <span class="string">&quot;It&#x27;s afternoon here - Good Afternoon!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            ViewData[<span class="string">&quot;Message&quot;</span>] = <span class="string">&quot;It&#x27;s evening here - Good Evening!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> View();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="FromServices注入"><a href="#FromServices注入" class="headerlink" title="FromServices注入"></a>FromServices注入</h4><p>FromServicesAttribute 允许将服务直接注入到操作方法，而无需使用构造函数注入：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">About</span>(<span class="params">[FromServices] IDateTime dateTime</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ViewData[<span class="string">&quot;Message&quot;</span>] = <span class="string">$&quot;Current server time: <span class="subst">&#123;dateTime.Now&#125;</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> View();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h3><p>ASP.NET Core 支持将依赖关系注入到视图。 这对于视图特定服务很有用，例如仅为填充视图元素所需的本地化或数据。 应尽量在控制器和视图之间保持问题分离。 视图显示的大部分数据应该从控制器传入。</p>
<h4 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h4><p>可使用 @inject 指令将服务注入到视图中，可将 @inject 看作向视图添加属性，并用 DI 填充该属性。@inject 的语法：<code>@inject &lt;type&gt; &lt;name&gt;</code>，示例：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">@using System.Threading.Tasks</span><br><span class="line">@using ViewInjectSample.Model</span><br><span class="line">@using ViewInjectSample.Model.Services</span><br><span class="line">@model IEnumerable<span class="tag">&lt;<span class="name">ToDoItem</span>&gt;</span></span><br><span class="line">@inject StatisticsService StatsService</span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>To Do Items<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>To Do Items<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>Total Items: @StatsService.GetCount()<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>Completed: @StatsService.GetCompletedCount()<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span>Avg. Priority: @StatsService.GetAveragePriority()<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>Name<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>Priority<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">th</span>&gt;</span>Is Done?<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            @foreach (var item in Model)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">td</span>&gt;</span>@item.Name<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">td</span>&gt;</span>@item.Priority<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">td</span>&gt;</span>@item.IsDone<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在 Startup.cs 的 ConfigureServices 中为依赖关系注入注册此服务：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    services.AddMvc();</span><br><span class="line"></span><br><span class="line">    services.AddTransient&lt;IToDoItemRepository, ToDoItemRepository&gt;();</span><br><span class="line">    services.AddTransient&lt;StatisticsService&gt;();</span><br><span class="line">    services.AddTransient&lt;ProfileOptionsService&gt;();</span><br></pre></td></tr></table></figure>

<h4 id="填充查找数据"><a href="#填充查找数据" class="headerlink" title="填充查找数据"></a>填充查找数据</h4><p>视图注入可用于填充 UI 元素（如下拉列表）中的选项。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> ViewInjectSample.Model;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ViewInjectSample.Controllers</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProfileController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">Route(<span class="meta-string">&quot;Profile&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> look up profile based on logged-in user</span></span><br><span class="line">            <span class="keyword">var</span> profile = <span class="keyword">new</span> Profile()</span><br><span class="line">            &#123;</span><br><span class="line">                Name = <span class="string">&quot;Steve&quot;</span>,</span><br><span class="line">                FavColor = <span class="string">&quot;Blue&quot;</span>,</span><br><span class="line">                Gender = <span class="string">&quot;Male&quot;</span>,</span><br><span class="line">                State = <span class="keyword">new</span> State(<span class="string">&quot;Ohio&quot;</span>,<span class="string">&quot;OH&quot;</span>)</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">return</span> View(profile);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">ViewInjectSample.Model.Services</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ProfileOptionsService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;<span class="keyword">string</span>&gt; <span class="title">ListGenders</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// keeping this simple</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;() &#123;<span class="string">&quot;Female&quot;</span>, <span class="string">&quot;Male&quot;</span>&#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;State&gt; <span class="title">ListStates</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// a few states from USA</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> List&lt;State&gt;()</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">new</span> State(<span class="string">&quot;Alabama&quot;</span>, <span class="string">&quot;AL&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> State(<span class="string">&quot;Alaska&quot;</span>, <span class="string">&quot;AK&quot;</span>),</span><br><span class="line">                <span class="keyword">new</span> State(<span class="string">&quot;Ohio&quot;</span>, <span class="string">&quot;OH&quot;</span>)</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;<span class="keyword">string</span>&gt; <span class="title">ListColors</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;() &#123; <span class="string">&quot;Blue&quot;</span>,<span class="string">&quot;Green&quot;</span>,<span class="string">&quot;Red&quot;</span>,<span class="string">&quot;Yellow&quot;</span> &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">@using System.Threading.Tasks</span><br><span class="line">@using ViewInjectSample.Model.Services</span><br><span class="line">@model ViewInjectSample.Model.Profile</span><br><span class="line">@inject ProfileOptionsService Options</span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Update Profile<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Update Profile<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    Name: @Html.TextBoxFor(m =&gt; m.Name)</span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">    Gender: @Html.DropDownList(&quot;Gender&quot;,</span><br><span class="line">           Options.ListGenders().Select(g =&gt; </span><br><span class="line">                new SelectListItem() &#123; Text = g, Value = g &#125;))</span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    State: @Html.DropDownListFor(m =&gt; m.State.Code,</span><br><span class="line">           Options.ListStates().Select(s =&gt; </span><br><span class="line">                new SelectListItem() &#123; Text = s.Name, Value = s.Code&#125;))</span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    Fav. Color: @Html.DropDownList(&quot;FavColor&quot;,</span><br><span class="line">           Options.ListColors().Select(c =&gt; </span><br><span class="line">                new SelectListItem() &#123; Text = c, Value = c &#125;))</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h2><ul>
<li>驻留在项目的根级别“Controllers”文件夹中</li>
<li>继承自 Microsoft.AspNetCore.Mvc.Controller</li>
</ul>
<p>控制器是一个可实例化的类，其中下列条件至少某一个为 true：</p>
<ul>
<li>类名称带有“Controller”后缀</li>
<li>该类继承自带有“Controller”后缀的类</li>
<li>使用 [Controller] 属性修饰该类</li>
</ul>
<p>控制器上的公共方法（除了那些使用 [NonAction] 属性装饰的方法）均为操作。操作上的参数会绑定到请求数据，并使用模型绑定进行验证。所有模型绑定的内容都会执行模型验证。 ModelState.IsValid 属性值指示模型绑定和验证是否成功。</p>
<p>操作方法应包含用于将请求映射到某个业务关注点的逻辑，业务关注点通常应当表示为控制器通过依赖关系注入来访问的服务，然后，操作将业务操作的结果映射到应用程序状态。</p>
<p>操作可以返回任何内容，但是经常返回生成响应的 IActionResult（或异步方法的 Task<IActionResult>）的实例，操作方法负责选择响应的类型，操作结果会做出响应。</p>
<p>添加控制器：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> Microsoft.AspNetCore.Mvc;</span><br><span class="line"><span class="keyword">using</span> System.Text.Encodings.Web;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MvcHello.Controllers</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HelloWorldController</span> : <span class="title">Controller</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// GET: /HelloWorld/</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Index</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;This is my default action...&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// GET: /HelloWorld/Welcome/</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">string</span> <span class="title">Welcome</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;This is the Welcome action method...&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="View"><a href="#View" class="headerlink" title="View"></a>View</h2><h3 id="创建视图"><a href="#创建视图" class="headerlink" title="创建视图"></a>创建视图</h3><p>在 Views / [ControllerName] 文件夹中创建特定于控制器的视图。 控制器之间共享的视图都将置于 Views/Shared 文件夹。 要创建一个视图，请添加新文件，并将其命名为与 .cshtml 文件扩展名相关联的控制器操作的相同名称。</p>
<p>Razor 标记以 @ 符号开头。 通过将 C# 代码放置在用大括号 ({ … }) 括住的 Razor 代码块内，运行 C# 语句。如下所示：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@&#123;</span><br><span class="line">    ViewData[<span class="string">&quot;Title&quot;</span>] = <span class="string">&quot;About&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&lt;h2&gt;@ViewData[<span class="string">&quot;Title&quot;</span>].&lt;/h2&gt;</span><br><span class="line">&lt;h3&gt;@ViewData[<span class="string">&quot;Message&quot;</span>]&lt;/h3&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;Use <span class="keyword">this</span> area to provide additional information.&lt;/p&gt;</span><br></pre></td></tr></table></figure>

<h3 id="添加视图"><a href="#添加视图" class="headerlink" title="添加视图"></a>添加视图</h3><p>在 HelloWorldController 类中，将 Index 方法替换为以下代码：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Index</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> View();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为 HelloWorldController 添加 Index 视图。</p>
<ol>
<li>添加一个名为“Views/HelloWorld”的新文件夹。</li>
<li>向 Views/HelloWorld 文件夹添加名为“Index.cshtml”的新文件，并添加内容。</li>
</ol>
<h3 id="更改标题和页脚等"><a href="#更改标题和页脚等" class="headerlink" title="更改标题和页脚等"></a>更改标题和页脚等</h3><p>修改Views/Shared/_Layout.cshtml 文件中的相关内容，并确认 Views/_ViewStart.cshtml 文件：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@&#123;</span><br><span class="line">    Layout = <span class="string">&quot;_Layout&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Views/_ViewStart.cshtml 文件将 Views/Shared/_Layout.cshtml 文件引入到每个视图中。 可以使用 Layout 属性设置不同的布局视图，或将它设置为 null，这样将不会使用任何布局文件。</p>
<h3 id="控制器传递数据"><a href="#控制器传递数据" class="headerlink" title="控制器传递数据"></a>控制器传递数据</h3><h4 id="强类型数据-ViewModel"><a href="#强类型数据-ViewModel" class="headerlink" title="强类型数据 (ViewModel)"></a>强类型数据 (ViewModel)</h4><p>使用 viewmodel 将数据传递给视图可让视图充分利用强类型检查。 强类型化（或强类型）意味着每个变量和常量都有明确定义的类型（例如 string、int 或 DateTime）。 在编译时检查视图中使用的类型是否有效。</p>
<p>使用 @model 指令指定模型。 使用带有 @Model 的模型：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@model WebApplication1.ViewModels.Address</span><br><span class="line"></span><br><span class="line">&lt;h2&gt;Contact&lt;/h2&gt;</span><br><span class="line">&lt;address&gt;</span><br><span class="line">    @Model.Street&lt;br&gt;</span><br><span class="line">    @Model.City, @Model.State @Model.PostalCode&lt;br&gt;</span><br><span class="line">    &lt;abbr title=<span class="string">&quot;Phone&quot;</span>&gt;P:&lt;/abbr&gt; <span class="number">425.555</span><span class="number">.0100</span></span><br><span class="line">&lt;/address&gt;</span><br></pre></td></tr></table></figure>

<p>为了将模型提供给视图，控制器将其作为参数进行传递：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Contact</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ViewData[<span class="string">&quot;Message&quot;</span>] = <span class="string">&quot;Your contact page.&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> viewModel = <span class="keyword">new</span> Address()</span><br><span class="line">    &#123;</span><br><span class="line">        Name = <span class="string">&quot;Microsoft&quot;</span>,</span><br><span class="line">        Street = <span class="string">&quot;One Microsoft Way&quot;</span>,</span><br><span class="line">        City = <span class="string">&quot;Redmond&quot;</span>,</span><br><span class="line">        State = <span class="string">&quot;WA&quot;</span>,</span><br><span class="line">        PostalCode = <span class="string">&quot;98052-6399&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> View(viewModel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="弱类型数据（ViewData、ViewData-属性和-ViewBag）"><a href="#弱类型数据（ViewData、ViewData-属性和-ViewBag）" class="headerlink" title="弱类型数据（ViewData、ViewData 属性和 ViewBag）"></a>弱类型数据（ViewData、ViewData 属性和 ViewBag）</h4><p>与强类型不同，弱类型（或松散类型）意味着不显式声明要使用的数据类型，可以使用弱类型数据集合将少量数据传入及传出控制器和视图。ViewBag 在 Razor 页中不可用。</p>
<p>ViewData 是通过 string 键访问的 ViewDataDictionary 对象。 字符串数据可以直接存储和使用，而不需要强制转换，但是在提取其他 ViewData 对象值时必须将其强制转换为特定类型。可以让控制器将视图模板所需的动态数据（参数）放置在视图模板稍后可以访问的 ViewData 字典中，将Welcome方法改为如下内容：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">Welcome</span>(<span class="params"><span class="keyword">string</span> name, <span class="keyword">int</span> numTimes = <span class="number">1</span></span>)</span> &#123;</span><br><span class="line">    ViewData[<span class="string">&quot;Message&quot;</span>] = <span class="string">&quot;Hello &quot;</span> + name;</span><br><span class="line">    ViewData[<span class="string">&quot;NumTimes&quot;</span>] = numTimes;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// return View(&quot;Views/HelloWorld/Welcome.cshtml&quot;);</span></span><br><span class="line">    <span class="keyword">return</span> View();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建一个名为 Views/HelloWorld/Welcome.cshtml 的 Welcome 视图模板，内容如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@&#123;</span><br><span class="line">    ViewData[&quot;Title&quot;] = &quot;Welcome&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>Welcome<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    @for (int i = 0; i <span class="tag">&lt; (<span class="attr">int</span>)<span class="attr">ViewData</span>[&quot;<span class="attr">NumTimes</span>&quot;]; <span class="attr">i</span>++)</span></span><br><span class="line"><span class="tag">    &#123;</span></span><br><span class="line">        &lt;li&gt;@ViewData[&quot;Message&quot;]&lt;/li&gt;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>实例：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> IActionResult <span class="title">SomeAction</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ViewData[<span class="string">&quot;Greeting&quot;</span>] = <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">    ViewData[<span class="string">&quot;Address&quot;</span>]  = <span class="keyword">new</span> Address()</span><br><span class="line">    &#123;</span><br><span class="line">        Name = <span class="string">&quot;Steve&quot;</span>,</span><br><span class="line">        Street = <span class="string">&quot;123 Main St&quot;</span>,</span><br><span class="line">        City = <span class="string">&quot;Hudson&quot;</span>,</span><br><span class="line">        State = <span class="string">&quot;OH&quot;</span>,</span><br><span class="line">        PostalCode = <span class="string">&quot;44236&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> View();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在视图中处理数据：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@&#123;</span><br><span class="line">    // Since Address isn&#x27;t a string, it requires a cast.</span><br><span class="line">    var address = ViewData[&quot;Address&quot;] as Address;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@ViewData[&quot;Greeting&quot;] World!</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">address</span>&gt;</span></span><br><span class="line">    @address.Name<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    @address.Street<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    @address.City, @address.State @address.PostalCode</span><br><span class="line"><span class="tag">&lt;/<span class="name">address</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h2><p>可以结合 Entity Framework Core (EF Core) 使用来处理数据库，EF Core 是对象关系映射 (ORM) 框架，可以简化需要编写的数据访问代码。要创建的模型类称为 POCO 类（源自“简单传统 CLR 对象”），因为它们与 EF Core 没有任何依赖关系，它们只定义将存储在数据库中的数据的属性。</p>
<h3 id="建表"><a href="#建表" class="headerlink" title="建表"></a>建表</h3><p>在数据库中建立表，需要与实体类对应。</p>
<h3 id="安装相关包"><a href="#安装相关包" class="headerlink" title="安装相关包"></a>安装相关包</h3><p>通过Nuget包管理器安装MySql.Data.EntityFrameworkCore包：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dotnet add package  MySql.Data.EntityFrameworkCore</span></span><br></pre></td></tr></table></figure>

<h3 id="添加实体类"><a href="#添加实体类" class="headerlink" title="添加实体类"></a>添加实体类</h3><p>在“Models”文件夹下添加“User.cs”：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.ComponentModel.DataAnnotations;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MvcHello.Models</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">User</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//用户Id</span></span><br><span class="line">        [<span class="meta">Key</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> Id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;   </span><br><span class="line">        <span class="comment">//用户名</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment">//用户密码</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">string</span> Password &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>User 类可包含：</p>
<ul>
<li>数据库需要 Id 字段以获取主键。</li>
<li>[DataType(DataType.Date)]：DataType 属性指定数据的类型 (Date)。 通过此特性：<ul>
<li>用户无需在数据字段中输入时间信息。</li>
<li>仅显示日期，而非时间信息。</li>
</ul>
</li>
</ul>
<h3 id="添加数据库上下文类"><a href="#添加数据库上下文类" class="headerlink" title="添加数据库上下文类"></a>添加数据库上下文类</h3><p>在根目录下加上 DataAccess 目录做为数据库操作目录，在该目录下加上 Base 目录做数据库上下文目录，在Base目录下添加上下文类，继承 DbContext 类，通过构造函数注入数据库连接，添加 DbSet<User> 实体属性，代码如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"><span class="keyword">using</span> Microsoft.EntityFrameworkCore;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MvcHello.DataAccess.Base</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserDbContext</span> : <span class="title">DbContext</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">UserDbContext</span> (<span class="params">DbContextOptions&lt;UserDbContext&gt; options</span>): <span class="title">base</span>(<span class="params">options</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> DbSet&lt;MvcHello.Models.User&gt; User &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="添加数据库连接配置（MySQL）"><a href="#添加数据库连接配置（MySQL）" class="headerlink" title="添加数据库连接配置（MySQL）"></a>添加数据库连接配置（MySQL）</h3><p>将连接字符串添加到 appsettings.json 文件：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;Logging&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;LogLevel&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;Default&quot;</span>: <span class="string">&quot;Warning&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;AllowedHosts&quot;</span>: <span class="string">&quot;*&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;ConnectionStrings&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;UserDbContext&quot;</span>: <span class="string">&quot;server=localhost;user id=root;password=123456;database=asp;charset=utf8;sslMode=None&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="添加数据库操作服务类"><a href="#添加数据库操作服务类" class="headerlink" title="添加数据库操作服务类"></a>添加数据库操作服务类</h3><p>在 DataAccess 目录下新建 Interface 目录，用于保存数据库操作的接口，在该目录下新建 IUserDao 接口，在接口里增加相关数据库添、删、改、查接口，代码如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">MvcHello.DataAccess.Interface</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IUserDao</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//插入数据</span></span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">CreateUser</span>(<span class="params">User user</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//取全部记录</span></span><br><span class="line">        <span class="function">IEnumerable&lt;User&gt; <span class="title">GetUsers</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//取某id记录</span></span><br><span class="line">        <span class="function">User <span class="title">GetUserByID</span>(<span class="params"><span class="keyword">int</span> id</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据id更新整条记录</span></span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">UpdateUser</span>(<span class="params">User user</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据id更新名称</span></span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">UpdateNameByID</span>(<span class="params"><span class="keyword">int</span> id, <span class="keyword">string</span> name</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据id删掉记录</span></span><br><span class="line">        <span class="function"><span class="keyword">bool</span> <span class="title">DeleteUserByID</span>(<span class="params"><span class="keyword">int</span> id</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 DataAccess 目录下新建 Implement 目录，用于保存数据库操作接口的实现，在该目录下新建 UserDao 类，继承 IUserDao 接口，实现接口里的数据库操作方法，在构造函数注入 UserDbContext 数据库上下文，代码如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">MvcHello.DataAccess.Implement</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserDao</span>: <span class="title">IUserDao</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> UserDbContext Context;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">UserDao</span>(<span class="params">UserDbContext context</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Context = context;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//插入数据</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">CreateUser</span>(<span class="params">User user</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Context.User.Add(user);</span><br><span class="line">            <span class="keyword">return</span> Context.SaveChanges() &gt; <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//取全部记录</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> IEnumerable&lt;User&gt; <span class="title">GetUsers</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> Context.User.ToList();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//取某id记录</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> User <span class="title">GetUserByID</span>(<span class="params"><span class="keyword">int</span> id</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> Context.User.SingleOrDefault(s =&gt; s.Id == id);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据id更新整条记录</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">UpdateUser</span>(<span class="params">User user</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Context.User.Update(user);</span><br><span class="line">            <span class="keyword">return</span> Context.SaveChanges() &gt; <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据id更新名称</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">UpdateNameByID</span>(<span class="params"><span class="keyword">int</span> id, <span class="keyword">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> state = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">var</span> user = Context.User.SingleOrDefault(s =&gt; s.Id == id);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (user != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                user.Name = name;</span><br><span class="line">                state = Context.SaveChanges() &gt; <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> state;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//根据id删掉记录</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">bool</span> <span class="title">DeleteUserByID</span>(<span class="params"><span class="keyword">int</span> id</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> user = Context.User.SingleOrDefault(s =&gt; s.Id == id);</span><br><span class="line">            Context.User.Remove(user);</span><br><span class="line">            <span class="keyword">return</span> Context.SaveChanges() &gt; <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="控制器中注入使用"><a href="#控制器中注入使用" class="headerlink" title="控制器中注入使用"></a>控制器中注入使用</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//插入数据</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ActionResult&lt;<span class="keyword">string</span>&gt; <span class="title">Create</span>(<span class="params"><span class="keyword">string</span> name, <span class="keyword">string</span> password</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty(name.Trim()))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;姓名不能为空&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">string</span>.IsNullOrEmpty(password.Trim()))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;密码不能为空&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> user = <span class="keyword">new</span> User() &#123;</span><br><span class="line">        Name = name,</span><br><span class="line">        Password = password</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> result = iHelloDao.CreateUser(user);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;学生插入成功&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;学生插入失败&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//取全部记录</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ActionResult&lt;<span class="keyword">string</span>&gt; <span class="title">Gets</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> names = <span class="string">&quot;没有数据&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> users = iHelloDao.GetUsers();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (users != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        names = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> s <span class="keyword">in</span> users)</span><br><span class="line">        &#123;</span><br><span class="line">            names += <span class="string">$&quot;<span class="subst">&#123;s.Name&#125;</span> \r\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">            </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> names;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="在Starup-cs中注册数据库服务"><a href="#在Starup-cs中注册数据库服务" class="headerlink" title="在Starup.cs中注册数据库服务"></a>在Starup.cs中注册数据库服务</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">ConfigureServices</span>(<span class="params">IServiceCollection services</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    services.Configure&lt;CookiePolicyOptions&gt;(options =&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// This lambda determines whether user consent for non-essential cookies is needed for a given request.</span></span><br><span class="line">        options.CheckConsentNeeded = context =&gt; <span class="literal">true</span>;</span><br><span class="line">        options.MinimumSameSitePolicy = SameSiteMode.None;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    services.AddDbContext&lt;UserDbContext&gt;(d =&gt; d.UseMySQL(Configuration.GetConnectionString(<span class="string">&quot;UserDbContext&quot;</span>)));</span><br><span class="line">    services.AddScoped&lt;IUserDao, UserDao&gt;();</span><br><span class="line"></span><br><span class="line">    services.AddMvc().SetCompatibilityVersion(CompatibilityVersion.Version_2_2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/29/C-Sharp%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/29/C-Sharp%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">C#学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-04-29 19:40:30" itemprop="dateCreated datePublished" datetime="2019-04-29T19:40:30+08:00">2019-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">语言</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AF%AD%E8%A8%80/C/" itemprop="url" rel="index"><span itemprop="name">C#</span></a>
                </span>
            </span>

          
            <span id="/2019/04/29/C-Sharp%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="C#学习笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/04/29/C-Sharp%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/04/29/C-Sharp%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>在Linux上编译运行C#需要安装mono(毕竟微软家的呵)，安装方式见官网。</p>
<h1 id="程序结构"><a href="#程序结构" class="headerlink" title="程序结构"></a>程序结构</h1><p>一个 C# 程序主要包括以下部分：</p>
<ul>
<li>命名空间声明（Namespace declaration）</li>
<li>一个 Class</li>
<li>Class 方法</li>
<li>Class 属性</li>
<li>一个 Main 方法</li>
<li>语句（Statements）&amp; 表达式（Expressions）</li>
<li>注释</li>
</ul>
<p>实例：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">HelloWorldApplication</span> &#123;</span><br><span class="line">   <span class="keyword">class</span> <span class="title">HelloWorld</span> &#123;</span><br><span class="line">      <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span> &#123;</span><br><span class="line">         <span class="comment">/* 我的第一个 C# 程序*/</span></span><br><span class="line">         Console.WriteLine(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">         Console.ReadKey();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译运行：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 编译生成.exe文件</span></span><br><span class="line">mcs test.cs</span><br><span class="line"><span class="comment">// 运行.exe文件</span></span><br><span class="line">mono test.exe</span><br></pre></td></tr></table></figure>

<h1 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h1><h2 id="using关键字"><a href="#using关键字" class="headerlink" title="using关键字"></a>using关键字</h2><p>using 关键字用于在程序中包含命名空间。一个程序可以包含多个 using 语句。</p>
<h2 id="class关键字"><a href="#class关键字" class="headerlink" title="class关键字"></a>class关键字</h2><p>class 关键字用于声明一个类。</p>
<h2 id="C-关键字"><a href="#C-关键字" class="headerlink" title="C# 关键字"></a>C# 关键字</h2><p>关键字是 C# 编译器预定义的保留字，如果想使用这些关键字作为标识符，可以在关键字前面加上 @ 字符作为前缀。</p>
<p>在 C# 中，有些关键字在代码的上下文中有特殊的意义，如 get 和 set，这些被称为上下文关键字（contextual keywords）。下表列出了 C# 中的保留关键字（Reserved Keywords）和上下文关键字（Contextual Keywords）：</p>
<img src="保留关键字.png"/>

<img src="上下文关键字.png"/>

<h1 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h1><p>在 C# 中，变量分为以下几种类型：</p>
<ul>
<li>值类型（Value types）</li>
<li>引用类型（Reference types）</li>
<li>指针类型（Pointer types）</li>
</ul>
<h2 id="值类型（Value-types）"><a href="#值类型（Value-types）" class="headerlink" title="值类型（Value types）"></a>值类型（Value types）</h2><p>值类型变量可以直接分配给一个值。它们是从类 System.ValueType 中派生的(<strong>结构体和枚举都是值类型</strong>)。</p>
<img src="值类型.png"/>

<p>表达式 sizeof(type) 产生以字节为单位存储对象或类型的存储尺寸。</p>
<h3 id="struct"><a href="#struct" class="headerlink" title="struct"></a>struct</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> Books &#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">string</span> title;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">string</span> author;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">string</span> subject;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">int</span> book_id;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>C# 中的结构有以下特点：</p>
<ul>
<li>结构可带有方法、字段、索引、属性、运算符方法和事件。</li>
<li>结构可定义构造函数，但不能定义析构函数。但是，您不能为结构定义默认的构造函数。默认的构造函数是自动定义的，且不能被改变。</li>
<li>与类不同，结构不能继承其他的结构或类。</li>
<li>结构不能作为其他结构或类的基础结构。</li>
<li>结构可实现一个或多个接口。</li>
<li>结构成员不能指定为 abstract、virtual 或 protected。</li>
<li>当使用 New 操作符创建一个结构对象时，会调用适当的构造函数来创建结构。与类不同，结构可以不使用 New 操作符即可被实例化。</li>
<li>如果不使用 New 操作符，只有在所有的字段都被初始化之后，字段才被赋值，对象才被使用。</li>
<li>类是引用类型，结构是值类型。</li>
<li>结构不支持继承。</li>
<li>结构不能声明默认的构造函数。</li>
</ul>
<h3 id="enum"><a href="#enum" class="headerlink" title="enum"></a>enum</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> &lt;enum_name&gt; &#123;</span><br><span class="line">    enumeration list </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>enum_name 指定枚举的类型名称。</li>
<li>enumeration list 是一个用逗号分隔的标识符列表。</li>
</ul>
<p>枚举列表中的每个符号代表一个整数值，一个比它前面的符号大的整数值。默认情况下，第一个枚举符号的值是 0.例如：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EnumTest</span> &#123;</span><br><span class="line">    <span class="keyword">enum</span> Day &#123; Sun, Mon, Tue, Wed, Thu, Fri, Sat &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> x = (<span class="keyword">int</span>)Day.Sun;</span><br><span class="line">        <span class="keyword">int</span> y = (<span class="keyword">int</span>)Day.Fri;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Sun = &#123;0&#125;&quot;</span>, x);</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;Fri = &#123;0&#125;&quot;</span>, y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="引用类型（Reference-types）"><a href="#引用类型（Reference-types）" class="headerlink" title="引用类型（Reference types）"></a>引用类型（Reference types）</h2><p>引用类型不包含存储在变量中的实际数据，但它们包含对变量的引用。换句话说，它们指的是一个内存位置。使用多个变量时，引用类型可以指向一个内存位置。如果内存位置的数据是由一个变量改变的，其他变量会自动反映这种值的变化。内置的 引用类型有：object、dynamic 和 string。</p>
<h3 id="对象（Object）类型"><a href="#对象（Object）类型" class="headerlink" title="对象（Object）类型"></a>对象（Object）类型</h3><p>对象（Object）类型 是 C# 通用类型系统（Common Type System - CTS）中所有数据类型的终极基类。Object 是 System.Object 类的别名。所以对象（Object）类型可以被分配任何其他类型（值类型、引用类型、预定义类型或用户自定义类型）的值。但是，在分配值之前，需要先进行类型转换。</p>
<p>当一个值类型转换为对象类型时，则被称为 装箱；另一方面，当一个对象类型转换为值类型时，则被称为 拆箱。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> obj;</span><br><span class="line">obj = <span class="number">100</span>; <span class="comment">// 这是装箱</span></span><br></pre></td></tr></table></figure>

<h3 id="动态（Dynamic）类型"><a href="#动态（Dynamic）类型" class="headerlink" title="动态（Dynamic）类型"></a>动态（Dynamic）类型</h3><p>可以存储任何类型的值在动态数据类型变量中。这些变量的类型检查是在运行时发生的。声明动态类型的语法：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">dynamic</span> &lt;variable_name&gt; = <span class="keyword">value</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 例如：</span></span><br><span class="line"><span class="keyword">dynamic</span> d = <span class="number">20</span>;</span><br></pre></td></tr></table></figure>

<p><strong>动态类型与对象类型相似，但是对象类型变量的类型检查是在编译时发生的，而动态类型变量的类型检查是在运行时发生的。</strong></p>
<h3 id="字符串（String）类型"><a href="#字符串（String）类型" class="headerlink" title="字符串（String）类型"></a>字符串（String）类型</h3><p>字符串（String）类型允许您给变量分配任何字符串值。字符串（String）类型是 System.String 类的别名。它是从对象（Object）类型派生的。字符串（String）类型的值可以通过两种形式进行分配：引号和@引号(称作”逐字字符串”，将转义字符<code>\</code>当作普通字符对待)。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">string</span> str = <span class="string">@&quot;C:\Windows&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 等价于：</span></span><br><span class="line"><span class="keyword">string</span> str = <span class="string">&quot;C:\\Windows&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// @ 字符串中可以任意换行，换行符及缩进空格都计算在字符串长度之内。</span></span><br><span class="line"><span class="keyword">string</span> str = <span class="string">@&quot;&lt;script type=&quot;&quot;text/javascript&quot;&quot;&gt;</span></span><br><span class="line"><span class="string">    &lt;!--</span></span><br><span class="line"><span class="string">    --&gt;</span></span><br><span class="line"><span class="string">&lt;/script&gt;&quot;</span>;</span><br></pre></td></tr></table></figure>

<h2 id="指针类型（Pointer-types）"><a href="#指针类型（Pointer-types）" class="headerlink" title="指针类型（Pointer types）"></a>指针类型（Pointer types）</h2><p>指针类型变量存储另一种类型的内存地址。C# 中的指针与 C 或 C++ 中的指针有相同的功能。声明指针类型的语法：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">type* identifier;</span><br><span class="line"><span class="comment">// 例如：</span></span><br><span class="line"><span class="keyword">char</span>* cptr;</span><br><span class="line"><span class="keyword">int</span>* iptr;</span><br></pre></td></tr></table></figure>

<h2 id="类型转换"><a href="#类型转换" class="headerlink" title="类型转换"></a>类型转换</h2><ul>
<li>隐式类型转换:这些转换是 C# 默认的以安全方式进行的转换, 不会导致数据丢失。例如，从小的整数类型转换为大的整数类型，从派生类转换为基类。</li>
<li>显式类型转换:显式类型转换(方法：(type)value)，即强制类型转换。显式转换需要强制转换运算符，而且强制转换会造成数据丢失。</li>
</ul>
<p>C#提供了下列内置的类型转换方法：</p>
<table>
<thead>
<tr>
<th align="left">方法</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">ToBoolean</td>
<td align="left">如果可能的话，把类型转换为布尔型。</td>
</tr>
<tr>
<td align="left">ToByte</td>
<td align="left">把类型转换为字节类型。</td>
</tr>
<tr>
<td align="left">ToChar</td>
<td align="left">如果可能的话，把类型转换为单个 Unicode 字符类型。</td>
</tr>
<tr>
<td align="left">ToDateTime</td>
<td align="left">把类型（整数或字符串类型）转换为 日期-时间 结构。</td>
</tr>
<tr>
<td align="left">ToDecimal</td>
<td align="left">把浮点型或整数类型转换为十进制类型。</td>
</tr>
<tr>
<td align="left">ToDouble</td>
<td align="left">把类型转换为双精度浮点型。</td>
</tr>
<tr>
<td align="left">ToInt16</td>
<td align="left">把类型转换为 16 位整数类型。</td>
</tr>
<tr>
<td align="left">ToInt32</td>
<td align="left">把类型转换为 32 位整数类型。</td>
</tr>
<tr>
<td align="left">ToInt64</td>
<td align="left">把类型转换为 64 位整数类型。</td>
</tr>
<tr>
<td align="left">ToSbyte</td>
<td align="left">把类型转换为有符号字节类型。</td>
</tr>
<tr>
<td align="left">ToSingle</td>
<td align="left">把类型转换为小浮点数类型。</td>
</tr>
<tr>
<td align="left">ToString</td>
<td align="left">把类型转换为字符串类型。</td>
</tr>
<tr>
<td align="left">ToType</td>
<td align="left">把类型转换为指定类型。</td>
</tr>
<tr>
<td align="left">ToUInt16</td>
<td align="left">把类型转换为 16 位无符号整数类型。</td>
</tr>
<tr>
<td align="left">ToUInt32</td>
<td align="left">把类型转换为 32 位无符号整数类型。</td>
</tr>
<tr>
<td align="left">ToUInt64</td>
<td align="left">把类型转换为 64 位无符号整数类型。</td>
</tr>
</tbody></table>
<h1 id="变量和常量"><a href="#变量和常量" class="headerlink" title="变量和常量"></a>变量和常量</h1><h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p>变量定义的语法：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;data_type&gt; &lt;variable_list&gt;;</span><br></pre></td></tr></table></figure>

<h2 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h2><h3 id="整数常量"><a href="#整数常量" class="headerlink" title="整数常量"></a>整数常量</h3><p>整数常量可以是十进制、八进制或十六进制的常量。</p>
<ul>
<li>前缀：指定基数，0x 或 0X 表示十六进制，0 表示八进制，没有前缀则表示十进制。</li>
<li>后缀：可以是 U 和 L 的组合，其中，U 和 L 分别表示 unsigned 和 long。后缀可以是大写或者小写，多个后缀以任意顺序进行组合。</li>
</ul>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">212</span>         <span class="comment">/* 合法 */</span></span><br><span class="line"><span class="number">215u</span>        <span class="comment">/* 合法 */</span></span><br><span class="line"><span class="number">0xFee</span>L      <span class="comment">/* 合法 */</span></span><br><span class="line"><span class="number">078</span>         <span class="comment">/* 非法：8 不是一个八进制数字 */</span></span><br><span class="line"><span class="number">032U</span>U       <span class="comment">/* 非法：不能重复后缀 */</span></span><br><span class="line"></span><br><span class="line"><span class="number">85</span>         <span class="comment">/* 十进制 */</span></span><br><span class="line"><span class="number">0213</span>       <span class="comment">/* 八进制 */</span></span><br><span class="line"><span class="number">0x4b</span>       <span class="comment">/* 十六进制 */</span></span><br><span class="line"><span class="number">30</span>         <span class="comment">/* int */</span></span><br><span class="line"><span class="number">30u</span>        <span class="comment">/* 无符号 int */</span></span><br><span class="line"><span class="number">30l</span>        <span class="comment">/* long */</span></span><br><span class="line"><span class="number">30u</span>l       <span class="comment">/* 无符号 long */</span></span><br></pre></td></tr></table></figure>

<h3 id="浮点常量"><a href="#浮点常量" class="headerlink" title="浮点常量"></a>浮点常量</h3><p>一个浮点常量是由整数部分、小数点、小数部分和指数部分组成。可以使用小数形式或者指数形式来表示浮点常量。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3.14159</span>       <span class="comment">/* 合法 */</span></span><br><span class="line"><span class="number">314159E-5</span>L    <span class="comment">/* 合法 */</span></span><br><span class="line"><span class="number">510</span>E          <span class="comment">/* 非法：不完全指数 */</span></span><br><span class="line"><span class="number">210f</span>          <span class="comment">/* 非法：没有小数或指数 */</span></span><br><span class="line">.e55          <span class="comment">/* 非法：缺少整数或小数 */</span></span><br></pre></td></tr></table></figure>

<p>使用小数形式表示时，必须包含小数点、指数或同时包含两者。使用指数形式表示时，必须包含整数部分、小数部分或同时包含两者。有符号的指数是用 e 或 E 表示的。</p>
<h3 id="字符常量"><a href="#字符常量" class="headerlink" title="字符常量"></a>字符常量</h3><p>字符常量括在单引号里.</p>
<h3 id="字符串常量"><a href="#字符串常量" class="headerlink" title="字符串常量"></a>字符串常量</h3><p>字符串常量是括在双引号 “” 里，或者是括在 @”” 里。字符串常量包含的字符与字符常量相似，可以是：普通字符、转义序列和通用字符.</p>
<h3 id="定义常量"><a href="#定义常量" class="headerlink" title="定义常量"></a>定义常量</h3><p>常量是使用 const 关键字来定义的 。定义一个常量的语法如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &lt;data_type&gt; &lt;constant_name&gt; = <span class="keyword">value</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Console"><a href="#Console" class="headerlink" title="Console"></a>Console</h2><p>System 命名空间中的 Console 类提供了一个函数 ReadLine()，用于接收来自用户的输入，并把它存储到一个变量中。提供了WriteLine()方法用于输出至控制台。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> num;</span><br><span class="line">num = Convert.ToInt32(Console.ReadLine());</span><br><span class="line">Console.WriteLine(<span class="string">&quot;test &#123;0&#125;&quot;</span>, num);</span><br></pre></td></tr></table></figure>

<p>函数 Convert.ToInt32() 把用户输入的数据转换为 int 数据类型，因为 Console.ReadLine() 只接受字符串格式的数据。</p>
<h1 id="集合（Collection）"><a href="#集合（Collection）" class="headerlink" title="集合（Collection）"></a>集合（Collection）</h1><table>
<thead>
<tr>
<th align="left">类</th>
<th align="left">描述和用法</th>
</tr>
</thead>
<tbody><tr>
<td align="left">动态数组（ArrayList）</td>
<td align="left">它代表了可被单独索引的对象的有序集合。<br>它基本上可以替代一个数组。但是，与数组不同的是，您可以使用索引在指定的位置添加和移除项目，动态数组会自动重新调整它的大小。它也允许在列表中进行动态内存分配、增加、搜索、排序各项。</td>
</tr>
<tr>
<td align="left">哈希表（Hashtable）</td>
<td align="left">它使用键来访问集合中的元素。<br>当使用键访问元素时，则使用哈希表，而且您可以识别一个有用的键值。哈希表中的每一项都有一个键/值对。键用于访问集合中的项目。</td>
</tr>
<tr>
<td align="left">排序列表（SortedList）</td>
<td align="left">它可以使用键和索引来访问列表中的项。<br>排序列表是数组和哈希表的组合。它包含一个可使用键或索引访问各项的列表。如果您使用索引访问各项，则它是一个动态数组（ArrayList），如果您使用键访问各项，则它是一个哈希表（Hashtable）。集合中的各项总是按键值排序。</td>
</tr>
<tr>
<td align="left">堆栈（Stack）</td>
<td align="left">它代表了一个后进先出的对象集合。<br>当需要对各项进行后进先出的访问时，则使用堆栈。当您在列表中添加一项，称为推入元素，当您从列表中移除一项时，称为弹出元素。</td>
</tr>
<tr>
<td align="left">队列（Queue）</td>
<td align="left">它代表了一个先进先出的对象集合。<br>当需要对各项进行先进先出的访问时，则使用队列。当您在列表中添加一项，称为入队，当您从列表中移除一项时，称为出队。</td>
</tr>
<tr>
<td align="left">点阵列（BitArray）</td>
<td align="left">它代表了一个使用值 1 和 0 来表示的二进制数组。<br>当需要存储位，但是事先不知道位数时，则使用点阵列。您可以使用整型索引从点阵列集合中访问各项，索引从零开始。</td>
</tr>
</tbody></table>
<h1 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h1><p>运算符大多和Java类似，以下举出几个不一样的：</p>
<table>
<thead>
<tr>
<th align="left">运算符</th>
<th align="left">描述</th>
<th align="left">实例</th>
</tr>
</thead>
<tbody><tr>
<td align="left">sizeof()</td>
<td align="left">返回数据类型的大小。</td>
<td align="left">sizeof(int)，将返回 4.</td>
</tr>
<tr>
<td align="left">typeof()</td>
<td align="left">返回 class 的类型。</td>
<td align="left">typeof(StreamReader);</td>
</tr>
<tr>
<td align="left">&amp;</td>
<td align="left">返回变量的地址。</td>
<td align="left">&a; 将得到变量的实际地址。</td>
</tr>
<tr>
<td align="left">*</td>
<td align="left">变量的指针。</td>
<td align="left">*a; 将指向一个变量。</td>
</tr>
<tr>
<td align="left">is</td>
<td align="left">判断对象是否为某一类型。</td>
<td align="left">if( Ford is Car) // 检查 Ford 是否是 Car 类的一个对象。</td>
</tr>
<tr>
<td align="left">as</td>
<td align="left">强制转换，即使转换失败也不会抛出异常。</td>
<td align="left">Object obj = new StringReader(“Hello”);</td>
</tr>
<tr>
<td align="left">StringReader r = obj as StringReader;</td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<h1 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h1><table>
<thead>
<tr>
<th align="left">语句</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">if 语句</td>
<td align="left">一个 if 语句 由一个布尔表达式后跟一个或多个语句组成。</td>
</tr>
<tr>
<td align="left">if…else 语句</td>
<td align="left">一个 if 语句 后可跟一个可选的 else 语句，else 语句在布尔表达式为假时执行。</td>
</tr>
<tr>
<td align="left">switch 语句    一个</td>
<td align="left">switch 语句允许测试一个变量等于多个值时的情况。</td>
</tr>
<tr>
<td align="left">? :</td>
<td align="left">三元判断运算符</td>
</tr>
<tr>
<td align="left">while 循环</td>
<td align="left">当给定条件为真时，重复语句或语句组。它会在执行循环主体之前测试条件。</td>
</tr>
<tr>
<td align="left">for/foreach 循环</td>
<td align="left">多次执行一个语句序列，简化管理循环变量的代码。(如：foreach (int i in array))</td>
</tr>
<tr>
<td align="left">do…while 循环</td>
<td align="left">除了它是在循环主体结尾测试条件外，其他与 while 语句类似。</td>
</tr>
</tbody></table>
<h1 id="可空类型（Nullable）"><a href="#可空类型（Nullable）" class="headerlink" title="可空类型（Nullable）"></a>可空类型（Nullable）</h1><p>C# 提供了一个特殊的数据类型: Nullable 类型（可空类型），可空类型可以表示其基础值类型正常范围内的值，再加上一个 null 值。</p>
<p>在处理数据库和其他包含可能未赋值的元素的数据类型时，将 null 赋值给数值类型或布尔型的功能特别有用。例如，数据库中的布尔型字段可以存储值 true 或 false，或者，该字段也可以未定义。声明一个 nullable 类型（可空类型）的语法如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt; data_type&gt; ? &lt;variable_name&gt; = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<p>实例:</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CalculatorApplication</span> &#123;</span><br><span class="line">   <span class="keyword">class</span> <span class="title">NullablesAtShow</span> &#123;</span><br><span class="line">      <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span> &#123;</span><br><span class="line">         <span class="keyword">int</span>? num1 = <span class="literal">null</span>;</span><br><span class="line">         <span class="keyword">int</span>? num2 = <span class="number">45</span>;</span><br><span class="line">         <span class="keyword">double</span>? num3 = <span class="keyword">new</span> <span class="keyword">double</span>?();</span><br><span class="line">         <span class="keyword">double</span>? num4 = <span class="number">3.14157</span>;</span><br><span class="line">         </span><br><span class="line">         <span class="keyword">bool</span>? boolval = <span class="keyword">new</span> <span class="keyword">bool</span>?();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// 显示值</span></span><br><span class="line">         </span><br><span class="line">         Console.WriteLine(<span class="string">&quot;显示可空类型的值： &#123;0&#125;, &#123;1&#125;, &#123;2&#125;, &#123;3&#125;&quot;</span>, </span><br><span class="line">                            num1, num2, num3, num4);</span><br><span class="line">         Console.WriteLine(<span class="string">&quot;一个可空的布尔值： &#123;0&#125;&quot;</span>, boolval);</span><br><span class="line">         Console.ReadLine();</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Null-合并运算符（-）"><a href="#Null-合并运算符（-）" class="headerlink" title="Null 合并运算符（??）"></a>Null 合并运算符（??）</h2><p>Null 合并运算符用于定义可空类型和引用类型的默认值。Null 合并运算符为类型转换定义了一个预设值，以防可空类型的值为 Null。Null 合并运算符把操作数类型隐式转换为另一个可空（或不可空）的值类型的操作数的类型。如果第一个操作数的值为 null，则运算符返回第二个操作数的值，否则返回第一个操作数的值。下面的实例演示了这点：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">CalculatorApplication</span> &#123;</span><br><span class="line">   <span class="keyword">class</span> <span class="title">NullablesAtShow</span> &#123;</span><br><span class="line">         </span><br><span class="line">      <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span> &#123;</span><br><span class="line">         </span><br><span class="line">         <span class="keyword">double</span>? num1 = <span class="literal">null</span>;</span><br><span class="line">         <span class="keyword">double</span>? num2 = <span class="number">3.14157</span>;</span><br><span class="line">         <span class="keyword">double</span> num3;</span><br><span class="line">         num3 = num1 ?? <span class="number">5.34</span>;      <span class="comment">// num1 如果为空值则返回 5.34</span></span><br><span class="line">         Console.WriteLine(<span class="string">&quot;num3 的值： &#123;0&#125;&quot;</span>, num3);</span><br><span class="line">         num3 = num2 ?? <span class="number">5.34</span>;</span><br><span class="line">         Console.WriteLine(<span class="string">&quot;num3 的值： &#123;0&#125;&quot;</span>, num3);</span><br><span class="line">         Console.ReadLine();</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="访问修饰符"><a href="#访问修饰符" class="headerlink" title="访问修饰符"></a>访问修饰符</h1><p>一个 访问修饰符 定义了一个类成员的范围和可见性。C# 支持的访问修饰符如下所示：</p>
<ul>
<li>public：所有对象都可以访问；</li>
<li>private：对象本身在对象内部可以访问；</li>
<li>protected：只有该类对象及其子类对象可以访问</li>
<li>internal：同一个程序集的对象可以访问；</li>
<li>protected internal：访问限于当前程序集或派生自包含类的类型。</li>
</ul>
<p>类的默认访问标识符是 internal，成员的默认访问标识符是 private。</p>
<h2 id="public-访问修饰符"><a href="#public-访问修饰符" class="headerlink" title="public 访问修饰符"></a>public 访问修饰符</h2><p>public 访问修饰符允许一个类将其成员变量和成员函数暴露给其他的函数和对象。任何公有成员可以被外部的类访问。</p>
<h2 id="private-访问修饰符"><a href="#private-访问修饰符" class="headerlink" title="private 访问修饰符"></a>private 访问修饰符</h2><p>private 访问修饰符允许一个类将其成员变量和成员函数对其他的函数和对象进行隐藏。只有同一个类中的函数可以访问它的私有成员。即使是类的实例也不能访问它的私有成员。</p>
<h2 id="protected-访问修饰符"><a href="#protected-访问修饰符" class="headerlink" title="protected 访问修饰符"></a>protected 访问修饰符</h2><p>protected 访问修饰符允许子类访问它的基类的成员变量和成员函数。这样有助于实现继承。</p>
<h2 id="internal-访问修饰符"><a href="#internal-访问修饰符" class="headerlink" title="internal 访问修饰符"></a>internal 访问修饰符</h2><p>internal 访问修饰符允许一个类将其成员变量和成员函数暴露给当前程序中的其他函数和对象。换句话说，带有 internal 访问修饰符的任何成员可以被定义在该成员所定义的应用程序内的任何类或方法访问。</p>
<h2 id="protected-internal-访问修饰符"><a href="#protected-internal-访问修饰符" class="headerlink" title="protected internal 访问修饰符"></a>protected internal 访问修饰符</h2><p>protected internal 访问修饰符允许在本类,派生类或者包含该类的程序集中访问。这也被用于实现继承。</p>
<h1 id="class"><a href="#class" class="headerlink" title="class"></a>class</h1><p><strong>析构函数不能继承或重载。</strong></p>
<h2 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h2><p>C#不支持多重继承，同Java一样也需要接口来实现，继承语法：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;访问修饰符符&gt; <span class="keyword">class</span> &lt;基类&gt; &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> &lt;派生类&gt; : &lt;基类&gt; &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>父类对象应在子类对象创建之前被创建，可以在成员初始化列表中进行父类的初始化(base类似于Java中的super)：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Rectangle</span> &#123;</span><br><span class="line">    <span class="comment">// 成员变量</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">double</span> length;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">double</span> width;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Rectangle</span>(<span class="params"><span class="keyword">double</span> l, <span class="keyword">double</span> w</span>)</span> &#123;</span><br><span class="line">        length = l;</span><br><span class="line">        width = w;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Display</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">Tabletop</span> : <span class="title">Rectangle</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">double</span> cost;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Tabletop</span>(<span class="params"><span class="keyword">double</span> l, <span class="keyword">double</span> w</span>) : <span class="title">base</span>(<span class="params">l, w</span>)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Display</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">base</span>.Display();</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;成本： &#123;0&#125;&quot;</span>, GetCost());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">ExecuteRectangle</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span> &#123;</span><br><span class="line">        Tabletop t = <span class="keyword">new</span> Tabletop(<span class="number">4.5</span>, <span class="number">7.5</span>);</span><br><span class="line">        t.Display();</span><br><span class="line">        Console.ReadLine();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h2><p>在面向对象编程范式中，多态性往往表现为”<strong>一个接口，多个功能</strong>“。</p>
<ul>
<li>静态多态性中，函数的响应是在编译时发生的;</li>
<li>动态多态性中，函数的响应是在运行时发生的。</li>
</ul>
<h3 id="静态多态性"><a href="#静态多态性" class="headerlink" title="静态多态性"></a>静态多态性</h3><p>在编译时，函数和对象的连接机制被称为早期绑定，也被称为静态绑定。C# 提供了两种技术来实现静态多态性。分别为：</p>
<ul>
<li>函数重载</li>
<li>运算符重载</li>
</ul>
<h3 id="动态多态性"><a href="#动态多态性" class="headerlink" title="动态多态性"></a>动态多态性</h3><p>动态多态性是通过 抽象类 和 虚方法 实现的。</p>
<p>C# 允许使用关键字 abstract 创建抽象类，用于提供接口的部分类的实现。当一个派生类继承自该抽象类时，实现即完成。抽象类包含抽象方法，抽象方法可被派生类实现。派生类具有更专业的功能。下面是有关抽象类的一些规则：</p>
<ul>
<li>不能创建一个抽象类的实例。</li>
<li>不能在一个抽象类外部声明一个抽象方法。</li>
<li>通过在类定义前面放置关键字 <strong>sealed</strong>，可以将类声明为密封类。当一个类被声明为 sealed 时，它不能被继承。抽象类不能被声明为 sealed。</li>
</ul>
<p>实例：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PolymorphismApplication</span> &#123;</span><br><span class="line">   <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title">Shape</span> &#123;</span><br><span class="line">       <span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> <span class="keyword">int</span> <span class="title">area</span>(<span class="params"></span>)</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">class</span> <span class="title">Rectangle</span>:  <span class="title">Shape</span> &#123;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">int</span> length;</span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">int</span> width;</span><br><span class="line">      </span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">Rectangle</span>(<span class="params"> <span class="keyword">int</span> a=<span class="number">0</span>, <span class="keyword">int</span> b=<span class="number">0</span></span>)</span> &#123;</span><br><span class="line">         length = a;</span><br><span class="line">         width = b;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">int</span> <span class="title">area</span> (<span class="params"></span>)</span> &#123; </span><br><span class="line">         Console.WriteLine(<span class="string">&quot;Rectangle 类的面积：&quot;</span>);</span><br><span class="line">         <span class="keyword">return</span> (width * length); </span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">class</span> <span class="title">RectangleTester</span> &#123;</span><br><span class="line">      <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span> &#123;</span><br><span class="line">         Rectangle r = <span class="keyword">new</span> Rectangle(<span class="number">10</span>, <span class="number">7</span>);</span><br><span class="line">         <span class="keyword">double</span> a = r.area();</span><br><span class="line">         Console.WriteLine(<span class="string">&quot;面积： &#123;0&#125;&quot;</span>,a);</span><br><span class="line">         Console.ReadKey();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当有一个定义在类中的函数需要在继承类中实现时，可以使用虚方法。虚方法是使用关键字 virtual 声明的。虚方法可以在不同的继承类中有不同的实现。对虚方法的调用是在运行时发生的。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">PolymorphismApplication</span> &#123;</span><br><span class="line">   <span class="keyword">class</span> <span class="title">Shape</span>  &#123;</span><br><span class="line">      <span class="keyword">protected</span> <span class="keyword">int</span> width, height;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">Shape</span>(<span class="params"> <span class="keyword">int</span> a=<span class="number">0</span>, <span class="keyword">int</span> b=<span class="number">0</span></span>)</span> &#123;</span><br><span class="line">         width = a;</span><br><span class="line">         height = b;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">area</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">         Console.WriteLine(<span class="string">&quot;父类的面积：&quot;</span>);</span><br><span class="line">         <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">class</span> <span class="title">Rectangle</span>: <span class="title">Shape</span> &#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">Rectangle</span>(<span class="params"> <span class="keyword">int</span> a=<span class="number">0</span>, <span class="keyword">int</span> b=<span class="number">0</span></span>): <span class="title">base</span>(<span class="params">a, b</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">int</span> <span class="title">area</span> (<span class="params"></span>)</span> &#123;</span><br><span class="line">         Console.WriteLine(<span class="string">&quot;Rectangle 类的面积：&quot;</span>);</span><br><span class="line">         <span class="keyword">return</span> (width * height); </span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">class</span> <span class="title">Triangle</span>: <span class="title">Shape</span> &#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="title">Triangle</span>(<span class="params"><span class="keyword">int</span> a = <span class="number">0</span>, <span class="keyword">int</span> b = <span class="number">0</span></span>): <span class="title">base</span>(<span class="params">a, b</span>)</span> &#123;</span><br><span class="line">      </span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">int</span> <span class="title">area</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">         Console.WriteLine(<span class="string">&quot;Triangle 类的面积：&quot;</span>);</span><br><span class="line">         <span class="keyword">return</span> (width * height / <span class="number">2</span>); </span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">class</span> <span class="title">Caller</span> &#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">CallArea</span>(<span class="params">Shape sh</span>)</span> &#123;</span><br><span class="line">         <span class="keyword">int</span> a;</span><br><span class="line">         a = sh.area();</span><br><span class="line">         Console.WriteLine(<span class="string">&quot;面积： &#123;0&#125;&quot;</span>, a);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">class</span> <span class="title">Tester</span> &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span> &#123;</span><br><span class="line">         Caller c = <span class="keyword">new</span> Caller();</span><br><span class="line">         Rectangle r = <span class="keyword">new</span> Rectangle(<span class="number">10</span>, <span class="number">7</span>);</span><br><span class="line">         Triangle t = <span class="keyword">new</span> Triangle(<span class="number">10</span>, <span class="number">5</span>);</span><br><span class="line">         c.CallArea(r);</span><br><span class="line">         c.CallArea(t);</span><br><span class="line">         Console.ReadKey();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：<strong>override重写的属性必须是virtual、abstract或override</strong>。</p>
<h1 id="interface"><a href="#interface" class="headerlink" title="interface"></a>interface</h1><p>类似于Java。</p>
<h1 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h1><p>在一个命名空间中声明的类的名称与另一个命名空间中声明的相同的类的名称不冲突。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">namespace_name</span> &#123;</span><br><span class="line">   <span class="comment">// 代码声明</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可通过namespace_name.item_name方式调用命名空间中的item。使用 using 命名空间指令，这样在使用的时候就不用在前面加上命名空间名称。</p>
<h1 id="预处理器指令"><a href="#预处理器指令" class="headerlink" title="预处理器指令"></a>预处理器指令</h1><p>预处理器指令指导编译器在实际编译开始之前对信息进行预处理。</p>
<p>所有的预处理器指令都是以 # 开始。且在一行上，只有空白字符可以出现在预处理器指令之前。预处理器指令不是语句，所以它们不以分号（;）结束。</p>
<p>C# 编译器没有一个单独的预处理器，但是，指令被处理时就像是有一个单独的预处理器一样。在 C# 中，预处理器指令用于在条件编译中起作用。与 C 和 C++ 不同的是，它们不是用来创建宏。一个预处理器指令必须是该行上的唯一指令。</p>
<table>
<thead>
<tr>
<th align="left">预处理器指令</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">#define</td>
<td align="left">它用于定义一系列成为符号的字符。</td>
</tr>
<tr>
<td align="left">#undef</td>
<td align="left">它用于取消定义符号。</td>
</tr>
<tr>
<td align="left">#if</td>
<td align="left">它用于测试符号是否为真。</td>
</tr>
<tr>
<td align="left">#else</td>
<td align="left">它用于创建复合条件指令，与 #if 一起使用。</td>
</tr>
<tr>
<td align="left">#elif</td>
<td align="left">它用于创建复合条件指令。</td>
</tr>
<tr>
<td align="left">#endif</td>
<td align="left">指定一个条件指令的结束。</td>
</tr>
<tr>
<td align="left">#line</td>
<td align="left">它可以让您修改编译器的行数以及（可选地）输出错误和警告的文件名。</td>
</tr>
<tr>
<td align="left">#error</td>
<td align="left">它允许从代码的指定位置生成一个错误。</td>
</tr>
<tr>
<td align="left">#warning</td>
<td align="left">它允许从代码的指定位置生成一级警告。</td>
</tr>
<tr>
<td align="left">#region</td>
<td align="left">它可以让您在使用 Visual Studio Code Editor 的大纲特性时，指定一个可展开或折叠的代码块。</td>
</tr>
<tr>
<td align="left">#endregion</td>
<td align="left">它标识着 #region 块的结束。</td>
</tr>
</tbody></table>
<h1 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h1><ul>
<li>try：一个 try 块标识了一个将被激活的特定的异常的代码块。后跟一个或多个 catch 块。</li>
<li>catch：程序通过异常处理程序捕获异常。catch 关键字表示异常的捕获。</li>
<li>finally：finally 块用于执行给定的语句，不管异常是否被抛出都会执行。例如，如果您打开一个文件，不管是否出现异常文件都要被关闭。</li>
<li>throw：当问题出现时，程序抛出一个异常。使用 throw 关键字来完成。</li>
</ul>
<p>C# 中的异常类主要是直接或间接地派生于 System.Exception 类。System.ApplicationException 和 System.SystemException 类是派生于 System.Exception 类的异常类。</p>
<ul>
<li>System.ApplicationException 类支持由应用程序生成的异常。所以程序员定义的异常都应派生自该类。</li>
<li>System.SystemException 类是所有预定义的系统异常的基类。</li>
</ul>
<h1 id="反射（Reflection）"><a href="#反射（Reflection）" class="headerlink" title="反射（Reflection）"></a>反射（Reflection）</h1><h1 id="委托（Delegate）"><a href="#委托（Delegate）" class="headerlink" title="委托（Delegate）"></a>委托（Delegate）</h1><p>委托是存有对某个方法的引用的一种引用类型变量。引用可在运行时被改变。委托特别用于实现事件和回调方法。所有的委托都派生自 System.Delegate 类。</p>
<h2 id="声明委托"><a href="#声明委托" class="headerlink" title="声明委托"></a>声明委托</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delegate</span> &lt;<span class="keyword">return</span> type&gt; &lt;<span class="keyword">delegate</span>-name&gt; &lt;parameter list&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下面的委托可被用于引用任何一个带有一个单一的 string 参数的方法，并返回一个 int 类型变量</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">delegate</span> <span class="keyword">int</span> <span class="title">MyDelegate</span> (<span class="params"><span class="keyword">string</span> s</span>)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="实例化委托"><a href="#实例化委托" class="headerlink" title="实例化委托"></a>实例化委托</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">delegate</span> <span class="keyword">void</span> <span class="title">printString</span>(<span class="params"><span class="keyword">string</span> s</span>)</span>;</span><br><span class="line">...</span><br><span class="line">printString ps1 = <span class="keyword">new</span> printString(WriteToScreen);</span><br><span class="line">printString ps2 = <span class="keyword">new</span> printString(WriteToFile);</span><br></pre></td></tr></table></figure>

<h2 id="委托的多播"><a href="#委托的多播" class="headerlink" title="委托的多播"></a>委托的多播</h2><p>委托对象可使用 “+” 运算符进行合并。一个合并委托调用它所合并的两个委托。只有相同类型的委托可被合并。”-“ 运算符可用于从合并的委托中移除组件委托。</p>
<p>使用委托的这个有用的特点，可以创建一个委托被调用时要调用的方法的调用列表。这被称为委托的 多播（multicasting），也叫组播。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">delegate</span> <span class="keyword">int</span> <span class="title">NumberChanger</span>(<span class="params"><span class="keyword">int</span> n</span>)</span>;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">DelegateAppl</span> &#123;</span><br><span class="line">   <span class="keyword">class</span> <span class="title">TestDelegate</span> &#123;</span><br><span class="line">      <span class="keyword">static</span> <span class="keyword">int</span> num = <span class="number">10</span>;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">AddNum</span>(<span class="params"><span class="keyword">int</span> p</span>)</span> &#123;</span><br><span class="line">         num += p;</span><br><span class="line">         <span class="keyword">return</span> num;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">MultNum</span>(<span class="params"><span class="keyword">int</span> q</span>)</span> &#123;</span><br><span class="line">         num *= q;</span><br><span class="line">         <span class="keyword">return</span> num;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getNum</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> num;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span> &#123;</span><br><span class="line">         <span class="comment">// 创建委托实例</span></span><br><span class="line">         NumberChanger nc;</span><br><span class="line">         NumberChanger nc1 = <span class="keyword">new</span> NumberChanger(AddNum);</span><br><span class="line">         NumberChanger nc2 = <span class="keyword">new</span> NumberChanger(MultNum);</span><br><span class="line">         nc = nc1;</span><br><span class="line">         nc += nc2;</span><br><span class="line">         <span class="comment">// 调用多播</span></span><br><span class="line">         nc(<span class="number">5</span>);</span><br><span class="line">         Console.WriteLine(<span class="string">&quot;Value of Num: &#123;0&#125;&quot;</span>, getNum()); <span class="comment">// 75</span></span><br><span class="line">         Console.ReadKey();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="事件（Event）"><a href="#事件（Event）" class="headerlink" title="事件（Event）"></a>事件（Event）</h1><ul>
<li>发布器（publisher） 是一个包含事件和委托定义的对象。事件和委托之间的联系也定义在这个对象中。发布器（publisher）类的对象调用这个事件，并通知其他的对象。</li>
<li>订阅器（subscriber） 是一个接受事件并提供事件处理程序的对象。在发布器（publisher）类中的委托调用订阅器（subscriber）类中的方法（事件处理程序）。</li>
</ul>
<h2 id="声明事件"><a href="#声明事件" class="headerlink" title="声明事件"></a>声明事件</h2><p>在类的内部声明事件，首先必须声明该事件的委托类型。例如：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">delegate</span> <span class="keyword">void</span> <span class="title">BoilerLogHandler</span>(<span class="params"><span class="keyword">string</span> status</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>然后，声明事件本身，使用 event 关键字：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基于上面的委托定义事件</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">event</span> BoilerLogHandler BoilerEventLog;</span><br></pre></td></tr></table></figure>

<p>上面的代码定义了一个名为 BoilerLogHandler 的委托和一个名为 BoilerEventLog 的事件，该事件在生成的时候会调用委托。</p>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">SimpleEvent</span> &#123;</span><br><span class="line">  <span class="keyword">using</span> System;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/***********发布器类***********/</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EventTest</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> <span class="keyword">value</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">delegate</span> <span class="keyword">void</span> <span class="title">NumManipulationHandler</span>(<span class="params"></span>)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">event</span> NumManipulationHandler ChangeNum;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">OnNumChanged</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (ChangeNum != <span class="literal">null</span>) &#123;</span><br><span class="line">        ChangeNum(); <span class="comment">/* 事件被触发 */</span></span><br><span class="line">      &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        Console.WriteLine( <span class="string">&quot;event not fire&quot;</span> );</span><br><span class="line">        Console.ReadKey(); <span class="comment">/* 回车继续 */</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EventTest</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      <span class="keyword">int</span> n = <span class="number">5</span>;</span><br><span class="line">      SetValue(n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetValue</span>(<span class="params"><span class="keyword">int</span> n</span>)</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">value</span> != n) &#123;</span><br><span class="line">        <span class="keyword">value</span> = n;</span><br><span class="line">        OnNumChanged();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/***********订阅器类***********/</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">subscribEvent</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printf</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      Console.WriteLine( <span class="string">&quot;event fire&quot;</span> );</span><br><span class="line">      Console.ReadKey(); <span class="comment">/* 回车继续 */</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/***********触发***********/</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MainClass</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">      EventTest e = <span class="keyword">new</span> EventTest(); <span class="comment">/* 实例化对象,第一次没有触发事件 */</span></span><br><span class="line">      subscribEvent v = <span class="keyword">new</span> subscribEvent(); <span class="comment">/* 实例化对象 */</span></span><br><span class="line">      e.ChangeNum += <span class="keyword">new</span> EventTest.NumManipulationHandler(v.printf); <span class="comment">/* 注册 */</span></span><br><span class="line">      e.SetValue(<span class="number">7</span>);</span><br><span class="line">      e.SetValue(<span class="number">11</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当上面的代码被编译和执行时，它会产生下列结果：</span></span><br><span class="line"><span class="keyword">event</span> not fire</span><br><span class="line"><span class="keyword">event</span> fire</span><br><span class="line"><span class="keyword">event</span> fire</span><br></pre></td></tr></table></figure>

<h1 id="泛型（Generic）"><a href="#泛型（Generic）" class="headerlink" title="泛型（Generic）"></a>泛型（Generic）</h1><p>使用泛型是一种增强程序功能的技术，具体表现在以下几个方面：</p>
<ul>
<li>它有助于最大限度地重用代码、保护类型的安全以及提高性能。</li>
<li>可以创建泛型集合类。.NET 框架类库在 System.Collections.Generic 命名空间中包含了一些新的泛型集合类。可以使用这些泛型集合类来替代 System.Collections 中的集合类。</li>
<li>可以创建自己的泛型接口、泛型类、泛型方法、泛型事件和泛型委托。</li>
<li>可以对泛型类进行约束以访问特定数据类型的方法。</li>
<li>关于泛型数据类型中使用的类型的信息可在运行时通过使用反射获取。</li>
</ul>
<h2 id="泛型类"><a href="#泛型类" class="headerlink" title="泛型类"></a>泛型类</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">GenericApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyGenericArray</span>&lt;<span class="title">T</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> T[] array;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MyGenericArray</span>(<span class="params"><span class="keyword">int</span> size</span>)</span> &#123;</span><br><span class="line">            array = <span class="keyword">new</span> T[size + <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> T <span class="title">getItem</span>(<span class="params"><span class="keyword">int</span> index</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> array[index];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setItem</span>(<span class="params"><span class="keyword">int</span> index, T <span class="keyword">value</span></span>)</span> &#123;</span><br><span class="line">            array[index] = <span class="keyword">value</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">           </span><br><span class="line">    <span class="keyword">class</span> <span class="title">Tester</span> &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span> &#123;</span><br><span class="line">            <span class="comment">// 声明一个整型数组</span></span><br><span class="line">            MyGenericArray&lt;<span class="keyword">int</span>&gt; intArray = <span class="keyword">new</span> MyGenericArray&lt;<span class="keyword">int</span>&gt;(<span class="number">5</span>);</span><br><span class="line">            <span class="comment">// 设置值</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> c = <span class="number">0</span>; c &lt; <span class="number">5</span>; c++) &#123;</span><br><span class="line">                intArray.setItem(c, c*<span class="number">5</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获取值</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> c = <span class="number">0</span>; c &lt; <span class="number">5</span>; c++) &#123;</span><br><span class="line">                Console.Write(intArray.getItem(c) + <span class="string">&quot; &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Console.WriteLine();</span><br><span class="line">            <span class="comment">// 声明一个字符数组</span></span><br><span class="line">            MyGenericArray&lt;<span class="keyword">char</span>&gt; charArray = <span class="keyword">new</span> MyGenericArray&lt;<span class="keyword">char</span>&gt;(<span class="number">5</span>);</span><br><span class="line">            <span class="comment">// 设置值</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> c = <span class="number">0</span>; c &lt; <span class="number">5</span>; c++) &#123;</span><br><span class="line">                charArray.setItem(c, (<span class="keyword">char</span>)(c+<span class="number">97</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 获取值</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> c = <span class="number">0</span>; c &lt; <span class="number">5</span>; c++) &#123;</span><br><span class="line">                Console.Write(charArray.getItem(c) + <span class="string">&quot; &quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            Console.WriteLine();</span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="泛型方法"><a href="#泛型方法" class="headerlink" title="泛型方法"></a>泛型方法</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">GenericMethodAppl</span> &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">Program</span> &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Swap</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="keyword">ref</span> T lhs, <span class="keyword">ref</span> T rhs</span>)</span> &#123;</span><br><span class="line">            T temp;</span><br><span class="line">            temp = lhs;</span><br><span class="line">            lhs = rhs;</span><br><span class="line">            rhs = temp;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> a, b;</span><br><span class="line">            <span class="keyword">char</span> c, d;</span><br><span class="line">            a = <span class="number">10</span>;</span><br><span class="line">            b = <span class="number">20</span>;</span><br><span class="line">            c = <span class="string">&#x27;I&#x27;</span>;</span><br><span class="line">            d = <span class="string">&#x27;V&#x27;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 在交换之前显示值</span></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Int values before calling swap:&quot;</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;a = &#123;0&#125;, b = &#123;1&#125;&quot;</span>, a, b);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Char values before calling swap:&quot;</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;c = &#123;0&#125;, d = &#123;1&#125;&quot;</span>, c, d);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 调用 swap</span></span><br><span class="line">            Swap&lt;<span class="keyword">int</span>&gt;(<span class="keyword">ref</span> a, <span class="keyword">ref</span> b);</span><br><span class="line">            Swap&lt;<span class="keyword">char</span>&gt;(<span class="keyword">ref</span> c, <span class="keyword">ref</span> d);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 在交换之后显示值</span></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Int values after calling swap:&quot;</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;a = &#123;0&#125;, b = &#123;1&#125;&quot;</span>, a, b);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Char values after calling swap:&quot;</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;c = &#123;0&#125;, d = &#123;1&#125;&quot;</span>, c, d);</span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="泛型委托"><a href="#泛型委托" class="headerlink" title="泛型委托"></a>泛型委托</h2><p>可以通过类型参数定义泛型委托。例如：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">delegate</span> T <span class="title">NumberChanger</span>&lt;<span class="title">T</span>&gt;(<span class="params">T n</span>)</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">delegate</span> T <span class="title">NumberChanger</span>&lt;<span class="title">T</span>&gt;(<span class="params">T n</span>)</span>;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">GenericDelegateAppl</span> &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">TestDelegate</span> &#123;</span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">int</span> num = <span class="number">10</span>;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">AddNum</span>(<span class="params"><span class="keyword">int</span> p</span>)</span> &#123;</span><br><span class="line">            num += p;</span><br><span class="line">            <span class="keyword">return</span> num;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">MultNum</span>(<span class="params"><span class="keyword">int</span> q</span>)</span> &#123;</span><br><span class="line">            num *= q;</span><br><span class="line">            <span class="keyword">return</span> num;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getNum</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> num;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span> &#123;</span><br><span class="line">            <span class="comment">// 创建委托实例</span></span><br><span class="line">            NumberChanger&lt;<span class="keyword">int</span>&gt; nc1 = <span class="keyword">new</span> NumberChanger&lt;<span class="keyword">int</span>&gt;(AddNum);</span><br><span class="line">            NumberChanger&lt;<span class="keyword">int</span>&gt; nc2 = <span class="keyword">new</span> NumberChanger&lt;<span class="keyword">int</span>&gt;(MultNum);</span><br><span class="line">            <span class="comment">// 使用委托对象调用方法</span></span><br><span class="line">            nc1(<span class="number">25</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Value of Num: &#123;0&#125;&quot;</span>, getNum());</span><br><span class="line">            nc2(<span class="number">5</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Value of Num: &#123;0&#125;&quot;</span>, getNum());</span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Lambda表达式"><a href="#Lambda表达式" class="headerlink" title="Lambda表达式"></a>Lambda表达式</h1><h2 id="1、表达式Lambda"><a href="#1、表达式Lambda" class="headerlink" title="1、表达式Lambda"></a>1、表达式Lambda</h2><p>表达式位于 =&gt; 运算符右侧的 lambda 表达式称为“表达式 lambda”。 表达式 lambda 会返回表达式的结果，并采用以下基本形式：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(input parameters) =&gt; expression</span><br></pre></td></tr></table></figure>

<p>仅当 lambda 只有一个输入参数时，括号才是可选的；否则括号是必需的。括号内的两个或更多输入参数使用逗号加以分隔；有时，编译器难以或无法推断输入类型，如果出现这种情况，可以按以下示例中所示方式显式指定类型：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">int</span> x, <span class="keyword">string</span> s) =&gt; s.Length &gt; x</span><br></pre></td></tr></table></figure>

<p>使用空括号指定零个输入参数：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">() =&gt; SomeMethod()</span><br></pre></td></tr></table></figure>

<h2 id="2、语句Lambda"><a href="#2、语句Lambda" class="headerlink" title="2、语句Lambda"></a>2、语句Lambda</h2><p>当lambda表达式中，有多个语句时，写成如下形式：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(input parameters) =&gt; &#123;statement;&#125;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">delegate</span> <span class="keyword">void</span> <span class="title">TestDelegate</span>(<span class="params"><span class="keyword">string</span> s</span>)</span>;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">TestDelegate myDel = n =&gt; &#123;</span><br><span class="line">  <span class="keyword">string</span> s = n + <span class="string">&quot; &quot;</span> + <span class="string">&quot;World&quot;</span>;</span><br><span class="line">  Console.WriteLine(s); </span><br><span class="line">&#125;;</span><br><span class="line">myDel(<span class="string">&quot;Hello&quot;</span>);</span><br></pre></td></tr></table></figure>

<h1 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h1><h2 id="Thread类"><a href="#Thread类" class="headerlink" title="Thread类"></a>Thread类</h2><p>Thread类的常用属性：</p>
<table>
<thead>
<tr>
<th align="left">属性</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">CurrentContext</td>
<td align="left">获取线程正在其中执行的当前上下文。</td>
</tr>
<tr>
<td align="left">CurrentCulture</td>
<td align="left">获取或设置当前线程的区域性。</td>
</tr>
<tr>
<td align="left">CurrentPrinciple</td>
<td align="left">获取或设置线程的当前负责人（对基于角色的安全性而言）。</td>
</tr>
<tr>
<td align="left">CurrentThread</td>
<td align="left">获取当前正在运行的线程。</td>
</tr>
<tr>
<td align="left">CurrentUICulture</td>
<td align="left">获取或设置资源管理器使用的当前区域性以便在运行时查找区域性特定的资源。</td>
</tr>
<tr>
<td align="left">ExecutionContext</td>
<td align="left">获取一个 ExecutionContext 对象，该对象包含有关当前线程的各种上下文的信息。</td>
</tr>
<tr>
<td align="left">IsAlive</td>
<td align="left">获取一个值，该值指示当前线程的执行状态。</td>
</tr>
<tr>
<td align="left">IsBackground</td>
<td align="left">获取或设置一个值，该值指示某个线程是否为后台线程。</td>
</tr>
<tr>
<td align="left">IsThreadPoolThread</td>
<td align="left">获取一个值，该值指示线程是否属于托管线程池。</td>
</tr>
<tr>
<td align="left">ManagedThreadId</td>
<td align="left">获取当前托管线程的唯一标识符。</td>
</tr>
<tr>
<td align="left">Name</td>
<td align="left">获取或设置线程的名称。</td>
</tr>
<tr>
<td align="left">Priority</td>
<td align="left">获取或设置一个值，该值指示线程的调度优先级。</td>
</tr>
<tr>
<td align="left">ThreadState</td>
<td align="left">获取一个值，该值包含当前线程的状态。</td>
</tr>
</tbody></table>
<p>Thread类的常用方法：</p>
<table>
<thead>
<tr>
<th align="left">序号</th>
<th align="left">方法名 &amp; 描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">public void Abort()<br>在调用此方法的线程上引发 ThreadAbortException，以开始终止此线程的过程。调用此方法通常会终止线程。</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">public static LocalDataStoreSlot AllocateDataSlot()<br>在所有的线程上分配未命名的数据槽。为了获得更好的性能，请改用以 ThreadStaticAttribute 属性标记的字段。</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">public static LocalDataStoreSlot AllocateNamedDataSlot( string name) <br>在所有线程上分配已命名的数据槽。为了获得更好的性能，请改用以 ThreadStaticAttribute 属性标记的字段。</td>
</tr>
<tr>
<td align="left">4</td>
<td align="left">public static void BeginCriticalRegion()<br>通知主机执行将要进入一个代码区域，在该代码区域内线程中止或未经处理的异常的影响可能会危害应用程序域中的其他任务。</td>
</tr>
<tr>
<td align="left">5</td>
<td align="left">public static void BeginThreadAffinity()<br>通知主机托管代码将要执行依赖于当前物理操作系统线程的标识的指令。</td>
</tr>
<tr>
<td align="left">6</td>
<td align="left">public static void EndCriticalRegion()<br>通知主机执行将要进入一个代码区域，在该代码区域内线程中止或未经处理的异常仅影响当前任务。</td>
</tr>
<tr>
<td align="left">7</td>
<td align="left">public static void EndThreadAffinity()<br>通知主机托管代码已执行完依赖于当前物理操作系统线程的标识的指令。</td>
</tr>
<tr>
<td align="left">8</td>
<td align="left">public static void FreeNamedDataSlot(string name)<br>为进程中的所有线程消除名称与槽之间的关联。为了获得更好的性能，请改用以 ThreadStaticAttribute 属性标记的字段。</td>
</tr>
<tr>
<td align="left">9</td>
<td align="left">public static Object GetData( LocalDataStoreSlot slot ) <br>在当前线程的当前域中从当前线程上指定的槽中检索值。为了获得更好的性能，请改用以 ThreadStaticAttribute 属性标记的字段。</td>
</tr>
<tr>
<td align="left">10</td>
<td align="left">public static AppDomain GetDomain()<br>返回当前线程正在其中运行的当前域。</td>
</tr>
<tr>
<td align="left">11</td>
<td align="left">public static AppDomain GetDomainID()<br>返回唯一的应用程序域标识符。</td>
</tr>
<tr>
<td align="left">12</td>
<td align="left">public static LocalDataStoreSlot GetNamedDataSlot( string name ) <br>查找已命名的数据槽。为了获得更好的性能，请改用以 ThreadStaticAttribute 属性标记的字段。</td>
</tr>
<tr>
<td align="left">13</td>
<td align="left">public void Interrupt()<br>中断处于 WaitSleepJoin 线程状态的线程。</td>
</tr>
<tr>
<td align="left">14</td>
<td align="left">public void Join()<br>在继续执行标准的 COM 和 SendMessage 消息泵处理期间，阻塞调用线程，直到某个线程终止为止。此方法有不同的重载形式。</td>
</tr>
<tr>
<td align="left">15</td>
<td align="left">public static void MemoryBarrier()<br>按如下方式同步内存存取：执行当前线程的处理器在对指令重新排序时，不能采用先执行 MemoryBarrier 调用之后的内存存取，再执行 MemoryBarrier 调用之前的内存存取的方式。</td>
</tr>
<tr>
<td align="left">16</td>
<td align="left">public static void ResetAbort()<br>取消为当前线程请求的 Abort。</td>
</tr>
<tr>
<td align="left">17</td>
<td align="left">public static void SetData( LocalDataStoreSlot slot, Object data ) <br>在当前正在运行的线程上为此线程的当前域在指定槽中设置数据。为了获得更好的性能，请改用以 ThreadStaticAttribute 属性标记的字段。</td>
</tr>
<tr>
<td align="left">18</td>
<td align="left">public void Start()<br>开始一个线程。</td>
</tr>
<tr>
<td align="left">19</td>
<td align="left">public static void Sleep( int millisecondsTimeout ) <br>让线程暂停一段时间。</td>
</tr>
<tr>
<td align="left">20</td>
<td align="left">public static void SpinWait( int iterations ) <br>导致线程等待由 iterations 参数定义的时间量。</td>
</tr>
<tr>
<td align="left">21</td>
<td align="left">public static byte VolatileRead( ref byte address )<br>public static double VolatileRead( ref double address )<br>public static int VolatileRead( ref int address )<br>public static Object VolatileRead( ref Object address ) <br>读取字段值。无论处理器的数目或处理器缓存的状态如何，该值都是由计算机的任何处理器写入的最新值。此方法有不同的重载形式。这里只给出了一些形式。</td>
</tr>
<tr>
<td align="left">22</td>
<td align="left">public static void VolatileWrite( ref byte address, byte value )<br>public static void VolatileWrite( ref double address, double value )<br>public static void VolatileWrite( ref int address, int value )<br>public static void VolatileWrite( ref Object address, Object value ) <br>立即向字段写入一个值，以使该值对计算机中的所有处理器都可见。此方法有不同的重载形式。这里只给出了一些形式。</td>
</tr>
<tr>
<td align="left">23</td>
<td align="left">public static bool Yield()<br>导致调用线程执行准备好在当前处理器上运行的另一个线程。由操作系统选择要执行的线程。</td>
</tr>
</tbody></table>
<h2 id="创建线程"><a href="#创建线程" class="headerlink" title="创建线程"></a>创建线程</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MultithreadingApplication</span> &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">ThreadCreationProgram</span> &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CallToChildThread</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Child thread starts&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span> &#123;</span><br><span class="line">            ThreadStart childref = <span class="keyword">new</span> ThreadStart(CallToChildThread);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;In Main: Creating the Child thread&quot;</span>);</span><br><span class="line">            Thread childThread = <span class="keyword">new</span> Thread(childref);</span><br><span class="line">            childThread.Start();</span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 结果：</span></span><br><span class="line">In Main: Creating the Child thread</span><br><span class="line">Child thread starts</span><br></pre></td></tr></table></figure>

<h2 id="管理线程"><a href="#管理线程" class="headerlink" title="管理线程"></a>管理线程</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MultithreadingApplication</span> &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">ThreadCreationProgram</span> &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CallToChildThread</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Child thread starts&quot;</span>);</span><br><span class="line">            <span class="comment">// 线程暂停 5000 毫秒</span></span><br><span class="line">            <span class="keyword">int</span> sleepfor = <span class="number">5000</span>; </span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Child Thread Paused for &#123;0&#125; seconds&quot;</span>, </span><br><span class="line">                              sleepfor / <span class="number">1000</span>);</span><br><span class="line">            Thread.Sleep(sleepfor);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;Child thread resumes&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span> &#123;</span><br><span class="line">            ThreadStart childref = <span class="keyword">new</span> ThreadStart(CallToChildThread);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;In Main: Creating the Child thread&quot;</span>);</span><br><span class="line">            Thread childThread = <span class="keyword">new</span> Thread(childref);</span><br><span class="line">            childThread.Start();</span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 结果：</span></span><br><span class="line">In Main: Creating the Child thread</span><br><span class="line">Child thread starts</span><br><span class="line">Child Thread Paused <span class="keyword">for</span> <span class="number">5</span> seconds</span><br><span class="line">Child thread resumes</span><br></pre></td></tr></table></figure>

<h2 id="销毁线程"><a href="#销毁线程" class="headerlink" title="销毁线程"></a>销毁线程</h2><p>Abort() 方法用于销毁线程。通过抛出 ThreadAbortException 在运行时中止线程。这个异常不能被捕获，如果有 finally 块，控制会被送至 finally 块。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Threading;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MultithreadingApplication</span> &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title">ThreadCreationProgram</span> &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">CallToChildThread</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;Child thread starts&quot;</span>);</span><br><span class="line">                <span class="comment">// 计数到 10</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> counter = <span class="number">0</span>; counter &lt;= <span class="number">10</span>; counter++) &#123;</span><br><span class="line">                    Thread.Sleep(<span class="number">500</span>);</span><br><span class="line">                    Console.WriteLine(counter);</span><br><span class="line">                &#125;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;Child Thread Completed&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ThreadAbortException e) &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;Thread Abort Exception&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">&quot;Couldn&#x27;t catch the Thread Exception&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span> &#123;</span><br><span class="line">            ThreadStart childref = <span class="keyword">new</span> ThreadStart(CallToChildThread);</span><br><span class="line">            Console.WriteLine(<span class="string">&quot;In Main: Creating the Child thread&quot;</span>);</span><br><span class="line">            Thread childThread = <span class="keyword">new</span> Thread(childref);</span><br><span class="line">            childThread.Start();</span><br><span class="line">            <span class="comment">// 停止主线程一段时间</span></span><br><span class="line">            Thread.Sleep(<span class="number">2000</span>);</span><br><span class="line">            <span class="comment">// 现在中止子线程</span></span><br><span class="line">            Console.WriteLine(<span class="string">&quot;In Main: Aborting the Child thread&quot;</span>);</span><br><span class="line">            childThread.Abort();</span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 结果：</span></span><br><span class="line">In Main: Creating the Child thread</span><br><span class="line">Child thread starts</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line">In Main: Aborting the Child thread</span><br><span class="line">Thread Abort Exception</span><br><span class="line">Couldn<span class="string">&#x27;t catch the Thread Exception </span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/12/Git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/12/Git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Git学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-12 10:51:16" itemprop="dateCreated datePublished" datetime="2019-03-12T10:51:16+08:00">2019-03-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">工具</span></a>
                </span>
            </span>

          
            <span id="/2019/03/12/Git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="Git学习笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/03/12/Git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/03/12/Git%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><h2 id="仓库"><a href="#仓库" class="headerlink" title="仓库"></a>仓库</h2><p>存放代码的目录，分为本地仓库和远程仓库，本地和远程可以通过 git remote add 建立关联。</p>
<p>本地仓库有三大分区：</p>
<ul>
<li>工作区 (Working Directory): 是我们编辑代码的地方</li>
<li>暂存区 (Stage or Index): 数据暂时存放的区域，可以在工作区和版本库之间进行数据的交流</li>
<li>版本库 (Commit History): 存放已经提交的数据，push 的时候就是把这个区域的数据推送到远程仓库</li>
</ul>
<h2 id="分支"><a href="#分支" class="headerlink" title="分支"></a>分支</h2><p>git 中的分支本质上是一个指向某个 commit 的指针。</p>
<h2 id="文件的生命周期"><a href="#文件的生命周期" class="headerlink" title="文件的生命周期"></a>文件的生命周期</h2><p>对于 git 仓库里的每一个文件（除了 .git 目录和被 .gitignore 忽略的文件），有如下几种状态：</p>
<ul>
<li>Untracked 未跟踪</li>
<li>Unmodified 未修改</li>
<li>Modified 已修改</li>
<li>Staged 暂存区</li>
</ul>
<img src="git文件生命周期.jpg"/>

<h1 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">git init # 在当前目录下初始化一个本地 git 仓库</span><br><span class="line">git status # 检查当前文件状态</span><br><span class="line">git diff # 比较工作区和暂存区</span><br><span class="line">git diff HEAD # 比较工作区和版本库</span><br><span class="line">git diff --cached # 比较暂存区和版本库</span><br><span class="line">git add &lt;filename&gt; # 将 &lt;filename&gt; 添加到暂存区</span><br><span class="line">git add -A # 将所有文件添加到暂存区</span><br><span class="line">git add . # 将当前目录下的所有文件添加到暂存区</span><br><span class="line">git commit # 提交更改（将暂存区的文件提交到 Commit History）</span><br><span class="line">git commit --amend # 修改 commit 信息</span><br><span class="line">git push origin &lt;branch&gt; # 将本地分支推送到远程仓库</span><br><span class="line">git pull origin &lt;branch&gt; # 将远程仓库的分支拉取到本地</span><br><span class="line">git clone &lt;repository&gt; [&lt;directory&gt;] # 克隆远程分支到本地，repository 可以由 schema 为 http[s], ssh, git, ftp[s], file 等各种 uri 表示，也可以是 scp 风格的路径表示。directory 表示克隆下来的仓库目录名</span><br><span class="line">git config [--global|--local] user.name &quot;&lt;username&gt;&quot; # 设置用户名，用户名会出现在 commit 信息里，加了--local参数只影响当前仓库的配置，加--global参数会影响本机上所有仓库的配置，默认是--local</span><br><span class="line">git config [--global|--local] user.email &quot;&lt;email&gt;&quot; # 设置用户邮箱，邮箱会出现在 commit 信息里</span><br><span class="line">git remote add origin &lt;repository&gt; # 添加一个远程分支，命名为 origin</span><br><span class="line">git log [--oneline] # 查看 commit 信息</span><br><span class="line">git log --oneline --graph # 查看 commit 节点树</span><br></pre></td></tr></table></figure>

<h1 id="高级操作"><a href="#高级操作" class="headerlink" title="高级操作"></a>高级操作</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">git branch # 查看本地分支</span><br><span class="line">git branch -a # 查看所有分支，包括远程分支</span><br><span class="line">git branch &lt;name&gt; # 创建一个和当前分支版本库一样的分支</span><br><span class="line">git checkout &lt;branch&gt; # 切换分支</span><br><span class="line">git checkout -b &lt;branch&gt; &lt;start_point&gt; # 创建一个新分支并切换，新分支的 HEAD 指针指向 start_point, start_point 可以是本地分支或远程分支的任意一个 commit</span><br><span class="line">git reset --soft &lt;commit&gt; # 将版本库的 HEAD 指向 commit</span><br><span class="line">git reset --mixed &lt;commit&gt; # 将版本库和暂存区的 HEAD 指向 commit</span><br><span class="line">git reset --hard &lt;commit&gt; # 将版本库、暂存区和工作区的 HEAD 指向 commit，但不会影响未跟踪的文件</span><br><span class="line">git rebase &lt;branch&gt; # 把当前分支变基到 branch 上</span><br><span class="line">git stash # 将暂存区中的文件储藏起来</span><br><span class="line">git stash apply # 恢复储藏的文件到暂存区</span><br><span class="line">git revert &lt;commit&gt; # 撤销之前的某一个 commit</span><br></pre></td></tr></table></figure>

<p>如下实例中，蓝色是版本库，绿色是暂存区，红色是工作区：</p>
<img src="reset1.png"/>

<p>git reset有三个选项：</p>
<ul>
<li>soft就是只动repo</li>
<li>mixed就是动repo还有staging(这个是默认参数)</li>
<li>hard就是动repo还有staging还有working</li>
</ul>
<ol>
<li><p>soft：只修改版本库repo</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --soft &lt;B commit&gt;</span><br></pre></td></tr></table></figure>

 <img src="reset2.png"/>
</li>
<li><p>mixed：修改版本库和暂存区</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --mixed &lt;B commit&gt;</span><br></pre></td></tr></table></figure>

 <img src="reset3.png"/>
</li>
<li><p>hard：修改版本库、暂存区和工作区</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard &lt;B commit&gt;</span><br></pre></td></tr></table></figure>

 <img src="reset4.png"/>

</li>
</ol>
<h1 id="冲突解决"><a href="#冲突解决" class="headerlink" title="冲突解决"></a>冲突解决</h1><p>当发生冲突的时候，冲突的文件中会出现以下格式的内容。</p>
<p>解决冲突的时候，可以选择保留当前修改，保留另一个分支的修改，或是两个都不保留，重新编辑。</p>
<p>解决冲突的时候既要解决文本冲突，也要注意逻辑冲突。当冲突解决完成后，应该将当前文件加入暂存区，并执行对应命令加上 –continue 参数。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</span><br><span class="line">            modification belongs to current branch</span><br><span class="line">=======</span><br><span class="line">            modification belongs to other branch</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt;&gt;&gt;&gt;&gt; commit 38a1cab...</span></span><br></pre></td></tr></table></figure>

<h1 id="gitignore"><a href="#gitignore" class="headerlink" title=".gitignore"></a>.gitignore</h1><p>文件 .gitignore 的格式规范如下：</p>
<ul>
<li>所有空行或者以 ＃ 开头的行都会被 Git 忽略。</li>
<li>可以使用标准的 glob 模式匹配。</li>
<li>匹配模式可以以（/）开头防止递归。</li>
<li>匹配模式可以以（/）结尾指定目录。</li>
<li>要忽略指定模式以外的文件或目录，可以在模式前加上惊叹号（!）取反。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> no .a files</span></span><br><span class="line">*.a</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> but <span class="keyword">do</span> track lib.a, even though you<span class="string">&#x27;re ignoring .a files above</span></span></span><br><span class="line">!lib.a</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> only ignore the TODO file <span class="keyword">in</span> the current directory, not subdir/TODO</span></span><br><span class="line">/TODO</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ignore all files <span class="keyword">in</span> the build/ directory</span></span><br><span class="line">build/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ignore doc/notes.txt, but not doc/server/arch.txt</span></span><br><span class="line">doc/*.txt</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> ignore all .pdf files <span class="keyword">in</span> the doc/ directory</span></span><br><span class="line">doc/**/*.pdf</span><br></pre></td></tr></table></figure>

<h1 id="Merge-amp-Rebase"><a href="#Merge-amp-Rebase" class="headerlink" title="Merge &amp; Rebase"></a>Merge &amp; Rebase</h1><ul>
<li>Merge: 合并两个分支</li>
<li>Rebase: 改变分支的 base commit</li>
</ul>
<p>这两种操作都可以合并分支，rebase 的优势在于可以使 commit history 的线性程度更高。线性程度高的好处在于，浏览历史的时候更整洁，不容易碰到分叉，分叉部分的代码差异可能更大。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git merge &lt;branch&gt; # 把 branch 合并到当前分支</span><br><span class="line">git rebase &lt;commit&gt; # 把当前分支 rebase 到 commit 上</span><br></pre></td></tr></table></figure>

<p>rebase黄金准则: 永远不要 rebase 到一个共享的分支，只能 rebase 自己使用的私有分支。</p>
<p>假设我们有如下图一所示仓库，该仓库有master和develop两个分支，且develop是在（3.added merge.txt file）commit处从master拉出来的分支。 </p>
<img src="rebase1.png"/>

<p><strong>merge</strong></p>
<p>假设现在HEAD在（6.added hello.txt file）处，也就是在master分支最近的一次提交处，此时执行git merge develop, 结果如下图所示。 </p>
<img src="rebase2.png"/>

<p>工作原理就是：git 会自动根据两个分支的共同祖先即 (3.added merge.txt file)这个 commit 和两个分支的最新提交即 (6.added hello.txt file) 和 (5.added test.txt file) 进行一个三方合并，然后将合并中修改的内容生成一个新的 commit，即图二的(7.Merge branch ‘develop’)。<br>这是merge的效果，简单来说就合并两个分支并生成一个新的提交。</p>
<p><strong>rebase</strong></p>
<p>假设初始状态也是图一所显示的。两个分支一个master，一个develop，此时HEAD在（6.added hello.txt file）处，现在执行git rebase develop,结果如下图三所示。 </p>
<img src="rebase3.png"/>

<p>在执行git rebase develop之前，HEAD在（6.added hello.txt file）处，当执行rebase操作时，git 会从两个分支的共同祖先 (3.added merge.txt file)开始提取 当前分支（此时是master分支）上的修改，即 （6.added hello.txt file）这个commit，再将 master 分支指向 目标分支的最新提交（此时是develop分支）即（5.added test.txt file） 处，然后将刚刚提取的修改应用到这个最新提交后面。如果提取的修改有多个，那git将依次应用到最新的提交后面，如下两图所示，图四为初始状态，图五为执行rebase后的状态。 </p>
<img src="rebase4.png"/>

<img src="rebase5.png"/>

<p>初始状态如下图六所示,和之前一样的是，develop分支也是在 (3.added merge.txt file)处从master分支拉取develop分支。不一样的是两个分支各个commit的时间不同，之前develop分支的4和5commit在master分支3之后6之前，现在是develop分支的4提交早于master分支的5提交，develop分支的6提交晚于master的5提交早于master的7提交。 </p>
<img src="rebase6.png"/>

<p>在上图情况下，在master分支的7commit处，执行git merge develop，结果如下图七所示：</p>
<img src="rebase7.png"/>

<p>执行git rebase develop，结果如下图八所示：</p>
<img src="rebase8.png"/>

<ol>
<li>可以看出merge结果能够体现出时间线，但是rebase会打乱时间线。 </li>
<li>而rebase看起来简洁，但是merge看起来不太简洁。 </li>
<li>最终结果是都把代码合起来了，所以具体怎么使用这两个命令看项目需要。</li>
</ol>
<p>还有一点说明的是，在项目中经常使用git pull来拉取代码，git pull相当于是git fetch + git merge，如果此时运行git pull -r，也就是git pull –rebase，相当于git fetch + git rebase</p>
<h1 id="撤销rebase"><a href="#撤销rebase" class="headerlink" title="撤销rebase"></a>撤销rebase</h1><p>当我们在本地的develop分支开发完成后，commit修改的内容，然后将origin/develop分支rebase到本地的develop分支，准备push代码的时候发现origin/develop分支的内容有问题，需要回退本地分支到rebase之前的状态（也可以撤销rebase其他本地分支的操作），首先执行命令：<code>git reflog</code>。输出如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git reflog</span></span><br><span class="line">eec33cda (HEAD -&gt; develop) HEAD@&#123;0&#125;: rebase finished: returning to refs/heads/develop</span><br><span class="line">eec33cda (HEAD -&gt; develop) HEAD@&#123;1&#125;: rebase: commit test</span><br><span class="line">bf335175 (origin/develop) HEAD@&#123;2&#125;: rebase: checkout origin/develop</span><br><span class="line">af69383a HEAD@&#123;3&#125;: commit: commit test</span><br></pre></td></tr></table></figure>

<p>解释一下上述输出：</p>
<ul>
<li>HEAD@{3}：提交本次内容</li>
<li>HEAD@{2}：开始rebase，首先checkout到origin/develop分支</li>
<li>HEAD@{1}：将origin/develop分支上的变动rebase到本地develop分支</li>
<li>HEAD@{0}：rebase结束</li>
</ul>
<p>如果要撤销本地rebase操作，只需要执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git reset --hard HEAD@&#123;3&#125;</span><br></pre></td></tr></table></figure>

<p>即可成功撤销rebase操作，回退到之前commit的状态。</p>
<h1 id="detached-HEAD"><a href="#detached-HEAD" class="headerlink" title="detached HEAD"></a>detached HEAD</h1><p>首先看看下面这种常规的commit情况：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">        HEAD (refers to branch &#x27;master&#x27;)</span><br><span class="line">        |</span><br><span class="line">        v</span><br><span class="line">a---b---c branch &#x27;master&#x27; (refers to commit &#x27;c&#x27;)</span><br><span class="line">    ^</span><br><span class="line">    |</span><br><span class="line">    tag &#x27;v2.0&#x27; (refers to commit &#x27;b&#x27;)</span><br></pre></td></tr></table></figure>

<p>此时再执行下述操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> edit; git add; git commit</span></span><br><span class="line"></span><br><span class="line">            HEAD (refers to branch &#x27;master&#x27;)</span><br><span class="line">            |</span><br><span class="line">            v</span><br><span class="line">a---b---c---d branch &#x27;master&#x27; (refers to commit &#x27;d&#x27;)</span><br><span class="line">    ^</span><br><span class="line">    |</span><br><span class="line">    tag &#x27;v2.0&#x27; (refers to commit &#x27;b&#x27;)</span><br></pre></td></tr></table></figure>

<p>运行命令<code>git checkout master</code>后会checkout到master的最新commit上，接下来运行下述命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git checkout v2.0  <span class="comment"># 或 git checkout master^^</span></span></span><br><span class="line"></span><br><span class="line">    HEAD (refers to commit &#x27;b&#x27;)</span><br><span class="line">    |</span><br><span class="line">    v</span><br><span class="line">a---b---c---d branch &#x27;master&#x27; (refers to commit &#x27;d&#x27;)</span><br><span class="line">    ^</span><br><span class="line">    |</span><br><span class="line">    tag &#x27;v2.0&#x27; (refers to commit &#x27;b&#x27;)</span><br></pre></td></tr></table></figure>

<p>现在head已经指向commit b，这就是所谓的dedatched head状态。从这里可以看出，head是当前index的状态，而不是当前分支（的最近commit节点）。这仅仅意味着head指向某个特定的commit点，而不是指向每一个特定的分支（的顶端节点）。如果我们此时提交一个commit：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> edit; git add; git commit</span></span><br><span class="line"></span><br><span class="line">    HEAD (refers to commit &#x27;e&#x27;)</span><br><span class="line">    |</span><br><span class="line">    v</span><br><span class="line">    e</span><br><span class="line">    |</span><br><span class="line">    |</span><br><span class="line">a---b---c---d branch &#x27;master&#x27; (refers to commit &#x27;d&#x27;)</span><br><span class="line">    ^</span><br><span class="line">    |</span><br><span class="line">    tag &#x27;v2.0&#x27; (refers to commit &#x27;b&#x27;)</span><br></pre></td></tr></table></figure>

<p>注意，此时产生了一个新的提交点，但是它只能被head索引到，不属于任何一个分支。当然，我们还可以给在这个“无名分支”的基础上继续提交。实际上，我们可以进行任何git的常规操作。但是，当我们运行<code>git checkout master</code>后：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git checkout master</span></span><br><span class="line"></span><br><span class="line">            HEAD (refers to branch &#x27;master&#x27;)</span><br><span class="line">    e       |</span><br><span class="line">    |       |</span><br><span class="line">    |       v</span><br><span class="line">a---b---c---d branch &#x27;master&#x27; (refers to commit &#x27;d&#x27;)</span><br><span class="line">    ^</span><br><span class="line">    |</span><br><span class="line">    tag &#x27;v2.0&#x27; (refers to commit &#x27;b&#x27;)</span><br></pre></td></tr></table></figure>

<p>此时，<code>commit e</code>已经处于无法被索引到的状态。最终e将被git的默认回收机制所回收，除非在它们被回收之前创建一个指向它们的索引。如果我们没有从<code>commit e</code>离开的话，可以这样创建一个指向e的索引：        </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git checkout -b develop  <span class="comment"># 创建一个develop分支，指向e，接着更新head指向分支develop，此时不再处在detached head的状态</span></span></span><br></pre></td></tr></table></figure>

<h1 id="patch"><a href="#patch" class="headerlink" title="patch"></a>patch</h1><h2 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h2><p>如果一个软件有了新版本，我们可以完整地下载新版本的代码进行编译安装。然而，像Linux Kernel这样的大型项目，代码即使压缩，也超过70MB，每次全新下载是有相当大的代价的。然而，每次更新变动的代码可能不超过1MB，因此，我们只要能够有两个版本代码的diff的数据，应该就可以以极低的代价更新程序了。</p>
<p>git提供了两种简单的patch方案。一是用git diff生成的标准patch，二是git format-patch生成的Git专用Patch。</p>
<h2 id="git-diff生成的标准patch"><a href="#git-diff生成的标准patch" class="headerlink" title="git diff生成的标准patch"></a>git diff生成的标准patch</h2><ul>
<li>最初在master(或别的分支上)</li>
<li>新建分支修改bug： git checkout -b fix</li>
<li>在fix分支上，提交修改内容： git commit -m “fix a bug”</li>
<li>与master分支对比产生patch: git diff &gt; patch</li>
<li>使用git apply命令，在一条干净的分支上应用patch: git checkout master —&gt; git checkout -b PATCH — &gt; git apply –check patch —–&gt; (补丁patch可以加入的话) git apply patch —&gt; git commit -m “apply patch”</li>
<li>切换到master上合并PATCH分支：git checkout master —-&gt; git merge PATCH</li>
</ul>
<p>注意：无论多少个文件、多少次commit的diff，都只会产生一个patch。</p>
<h2 id="git-format-patch生成的git专用补丁"><a href="#git-format-patch生成的git专用补丁" class="headerlink" title="git format-patch生成的git专用补丁"></a>git format-patch生成的git专用补丁</h2><ul>
<li>最初在master(或别的分支上)</li>
<li>新建分支修改bug： git checkout -b fix</li>
<li>在fix分支上，提交修改内容： git commit -m “fix a bug”</li>
<li>将此次commit后的fix分支内容与master对比，根据commit msg生成一个patch: git format-patch -M master —-&gt;生成0001-fix-a-bug.patch</li>
<li>使用git am命令，在一条干净的分支上应用patch: git checkout master —&gt; git checkout -b PATCH —&gt; git am 0001-fix-a-bug.patch —&gt; git commit -m “apply patch”</li>
<li>切换到master上合并PATCH分支：git checkout master —-&gt; git merge PATCH</li>
</ul>
<p>注意：每次commit，都只会产生对应的一个patch。</p>
<ul>
<li>git am时出错：<code>.git/rebase-apply still exists but mbox given</code><br>  <code>git am –abort</code>（该命令将git的状态恢复到之前状态就可以继续提交patch了）</li>
<li>打补丁<br>  <code>patch -p1 &lt; my.patch</code></li>
<li>取消补丁<br>  <code>patch -R -p1 &lt; my.patch</code></li>
</ul>
<h2 id="创建patch-文件的常用命令行"><a href="#创建patch-文件的常用命令行" class="headerlink" title="创建patch 文件的常用命令行"></a>创建patch 文件的常用命令行</h2><ul>
<li>某次提交（含）之前的几次提交：<code>git format-patch 【commit sha1 id】-n</code><br>  n指从sha1 id对应的commit开始算起n个提交。<br>  eg：<code>git format-patch  2a2fb4539925bfa4a141fe492d9828d030f7c8a8 -2</code></li>
<li>某个提交的patch：<code>git format-patch 【commit sha1 id】 -1</code><br>  eg：<code>git format-patch  2a2fb4539925bfa4a141fe492d9828d030f7c8a8 -1</code></li>
<li>某两次提交之间的所有patch:<code>git format-patch 【commit sha1 id】..【commit sha1 id】</code><br>  eg：<code>git format-patch  2a2fb4539925bfa4a141fe492d9828d030f7c8a8..89aebfcc73bdac8054be1a242598610d8ed5f3c8</code></li>
</ul>
<h2 id="创建diff文件的常用方法"><a href="#创建diff文件的常用方法" class="headerlink" title="创建diff文件的常用方法"></a>创建diff文件的常用方法</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git diff  【commit sha1 id】 【commit sha1 id】 &gt;  【diff文件名】</span><br><span class="line"><span class="meta">#</span><span class="bash"> eg：</span></span><br><span class="line">git diff  2a2fb4539925bfa4a141fe492d9828d030f7c8a8  89aebfcc73bdac8054be1a242598610d8ed5f3c8 &gt; patch.diff</span><br></pre></td></tr></table></figure>

<h2 id="两种patch的比较"><a href="#两种patch的比较" class="headerlink" title="两种patch的比较"></a>两种patch的比较</h2><ul>
<li>兼容性：很明显，git diff生成的Patch兼容性强。如果你在修改的代码的官方版本库不是Git管理的版本库，那么你必须使用git diff生成的patch才能让你的代码被项目的维护人接受。</li>
<li>除错功能：对于git diff生成的patch，你可以用git apply –check 查看补丁是否能够干净顺利地应用到当前分支中；如果git format-patch 生成的补丁不能打到当前分支，git am会给出提示，并协助你完成打补丁工作，你也可以使用git am -3进行三方合并。从这一点上看，两者除错功能都很强。</li>
<li>版本库信息：由于git format-patch生成的补丁中含有这个补丁开发者的名字，因此在应用补丁时，这个名字会被记录进版本库，显然，这样做是恰当的。因此，目前使用Git的开源社区往往建议使用format-patch生成补丁。</li>
</ul>
<h1 id="submodule"><a href="#submodule" class="headerlink" title="submodule"></a>submodule</h1><ul>
<li>添加：<code>git submodule add repo_address path</code>，path可省略</li>
<li>更新：<code>git submodule update</code></li>
<li>初始化/更新：<code>git submodule update --init --recursive</code></li>
<li>删除：首先，要在<code>.gitmodules</code>文件中删除相应配置信息。然后，执行<code>git rm –cached</code>命令将子模块所在的文件从git中删除</li>
<li>clone带有submodule的项目：<code>git clone --recurse-submodules address</code></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/04/EOS%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/04/EOS%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" class="post-title-link" itemprop="url">EOS源码解读</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-03-04 15:11:27" itemprop="dateCreated datePublished" datetime="2019-03-04T15:11:27+08:00">2019-03-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/" itemprop="url" rel="index"><span itemprop="name">区块链</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/EOS/" itemprop="url" rel="index"><span itemprop="name">EOS</span></a>
                </span>
            </span>

          
            <span id="/2019/03/04/EOS%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" class="post-meta-item leancloud_visitors" data-flag-title="EOS源码解读" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/03/04/EOS%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/03/04/EOS%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h1><img src="eos_block_structure.png"/>

<h2 id="Block"><a href="#Block" class="headerlink" title="Block"></a>Block</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /eos/libraries/chain/include/eosio/chain/block.hpp</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">signed_block</span> :</span> <span class="keyword">public</span> signed_block_header &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	signed_block( <span class="keyword">const</span> signed_block&amp; ) = <span class="keyword">default</span>;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	signed_block() = <span class="keyword">default</span>;</span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">signed_block</span><span class="params">( <span class="keyword">const</span> signed_block_header&amp; h )</span>:<span class="title">signed_block_header</span><span class="params">(h)</span></span>&#123;&#125;</span><br><span class="line">	signed_block( signed_block&amp;&amp; ) = <span class="keyword">default</span>;</span><br><span class="line">	signed_block&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> signed_block&amp;) = <span class="keyword">delete</span>;</span><br><span class="line">	<span class="function">signed_block <span class="title">clone</span><span class="params">()</span> <span class="keyword">const</span> </span>&#123; <span class="keyword">return</span> *<span class="keyword">this</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">vector</span>&lt;transaction_receipt&gt;   transactions; <span class="comment">/// new or generated transactions</span></span><br><span class="line">	extensions_type               block_extensions;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// /eos/libraries/chain/include/eosio/chain/types.hpp</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="built_in">vector</span>&lt;<span class="built_in">std</span>::<span class="built_in">pair</span>&lt;<span class="keyword">uint16_t</span>,<span class="built_in">vector</span>&lt;<span class="keyword">char</span>&gt;&gt;&gt; extensions_type;</span><br></pre></td></tr></table></figure>

<p>signed_block结构体是从signed_block_header继承而来的，这个signed_block_header结构体只是包含了一条数据，那就是producer的签名。signed_block_header结构体又是从block_header继承而来的，这个结构体就包含了一个block中很多重要的数据，包括时间戳，producer的名字，所有交易的merkle root，所有action的root等信息。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /eos/libraries/chain/include/eosio/chain/block_header.hpp</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">block_header</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	 block_timestamp_type             timestamp;</span><br><span class="line">	 account_name                     producer;</span><br><span class="line">	 <span class="keyword">uint16_t</span>                         confirmed = <span class="number">1</span>;  </span><br><span class="line"></span><br><span class="line">	 block_id_type                    previous;</span><br><span class="line"></span><br><span class="line">	 checksum256_type                 transaction_mroot;</span><br><span class="line">	 checksum256_type                 action_mroot;</span><br><span class="line"></span><br><span class="line">	 <span class="keyword">uint32_t</span>                          schedule_version = <span class="number">0</span>;</span><br><span class="line">	 optional&lt;producer_schedule_type&gt;  new_producers;</span><br><span class="line">	 extensions_type                   header_extensions;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">signed_block_header</span> :</span> <span class="keyword">public</span> block_header</span><br><span class="line">&#123;</span><br><span class="line">	 signature_type    producer_signature;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="Transaction"><a href="#Transaction" class="headerlink" title="Transaction"></a>Transaction</h2><p>signed_block中定义了transaction_receipt类型的vector，表示区块是由按顺序组织的交易来构成的集合。block_extensions则定义了一系列的扩展信息，这些信息都由一个整数类型的code来定义，需要的时候，都可以根据这个整数code来解析相应的信息。下面看看transaction_receipt的定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /eos/libraries/chain/include/eosio/chain/block.hpp</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">transaction_receipt_header</span> &#123;</span></span><br><span class="line">   <span class="keyword">enum</span> status_enum &#123;</span><br><span class="line">      executed  = <span class="number">0</span>, <span class="comment">///&lt; succeed, no error handler executed</span></span><br><span class="line">      soft_fail = <span class="number">1</span>, <span class="comment">///&lt; objectively failed (not executed), error handler executed</span></span><br><span class="line">      hard_fail = <span class="number">2</span>, <span class="comment">///&lt; objectively failed and error handler objectively failed thus no state change</span></span><br><span class="line">      delayed   = <span class="number">3</span>, <span class="comment">///&lt; transaction delayed/deferred/scheduled for future execution</span></span><br><span class="line">      expired   = <span class="number">4</span>  <span class="comment">///&lt; transaction expired and storage space refuned to user</span></span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   transaction_receipt_header():status(hard_fail)&#123;&#125;</span><br><span class="line">   <span class="function"><span class="keyword">explicit</span> <span class="title">transaction_receipt_header</span><span class="params">( status_enum s )</span>:<span class="title">status</span><span class="params">(s)</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">friend</span> <span class="keyword">inline</span> <span class="keyword">bool</span> <span class="keyword">operator</span> ==( <span class="keyword">const</span> transaction_receipt_header&amp; lhs, <span class="keyword">const</span> transaction_receipt_header&amp; rhs ) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">std</span>::tie(lhs.status, lhs.cpu_usage_us, lhs.net_usage_words) == <span class="built_in">std</span>::tie(rhs.status, rhs.cpu_usage_us, rhs.net_usage_words);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   fc::enum_type&lt;<span class="keyword">uint8_t</span>,status_enum&gt;   status;</span><br><span class="line">   <span class="keyword">uint32_t</span>                             cpu_usage_us = <span class="number">0</span>; <span class="comment">///&lt; total billed CPU usage (microseconds)</span></span><br><span class="line">   fc::unsigned_int                     net_usage_words; <span class="comment">///&lt;  total billed NET usage, so we can reconstruct resource state when skipping context free data... hard failures...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">transaction_receipt</span> :</span> <span class="keyword">public</span> transaction_receipt_header &#123;</span><br><span class="line"></span><br><span class="line">   transaction_receipt():transaction_receipt_header()&#123;&#125;</span><br><span class="line">   explicit transaction_receipt( const transaction_id_type&amp; tid ):transaction_receipt_header(executed),trx(tid)&#123;&#125;</span><br><span class="line">   explicit transaction_receipt( const packed_transaction&amp; ptrx ):transaction_receipt_header(executed),trx(ptrx)&#123;&#125;</span><br><span class="line"></span><br><span class="line">   fc::static_variant&lt;transaction_id_type, packed_transaction&gt; trx;</span><br><span class="line"></span><br><span class="line">   <span class="function">digest_type <span class="title">digest</span><span class="params">()</span><span class="keyword">const</span> </span>&#123;</span><br><span class="line">      digest_type::encoder enc;</span><br><span class="line">      fc::raw::pack( enc, status );</span><br><span class="line">      fc::raw::pack( enc, cpu_usage_us );</span><br><span class="line">      fc::raw::pack( enc, net_usage_words );</span><br><span class="line">      <span class="keyword">if</span>( trx.contains&lt;transaction_id_type&gt;() )</span><br><span class="line">         fc::raw::pack( enc, trx.get&lt;transaction_id_type&gt;() );</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">         fc::raw::pack( enc, trx.get&lt;packed_transaction&gt;().packed_digest() );</span><br><span class="line">      <span class="keyword">return</span> enc.result();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// /eos/libraries/chain/include/eosio/chain/types.hpp</span></span><br><span class="line"><span class="keyword">using</span> checksum_type       = fc::sha256;</span><br><span class="line"><span class="keyword">using</span> transaction_id_type = checksum_type;</span><br><span class="line"></span><br><span class="line"><span class="comment">// /eos/libraries/chain/include/eosio/chain/transaction.hpp</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">packed_transaction</span> &#123;</span></span><br><span class="line">   <span class="comment">// 定义打包数据是否压缩的枚举类型</span></span><br><span class="line">   <span class="keyword">enum</span> compression_type &#123;</span><br><span class="line">      <span class="comment">// 没有压缩</span></span><br><span class="line">      none = <span class="number">0</span>,</span><br><span class="line">      <span class="comment">// 使用zlib压缩</span></span><br><span class="line">      zlib = <span class="number">1</span>,</span><br><span class="line">   &#125;;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 签名信息</span></span><br><span class="line">   <span class="built_in">vector</span>&lt;signature_type&gt;                  signatures;</span><br><span class="line">   <span class="comment">// 是否压缩的标识信息</span></span><br><span class="line">   fc::enum_type&lt;<span class="keyword">uint8_t</span>,compression_type&gt; compression;</span><br><span class="line">   <span class="comment">// 上下文无关的信息</span></span><br><span class="line">   bytes                                   packed_context_free_data;</span><br><span class="line">   <span class="comment">// 打包后的交易数据</span></span><br><span class="line">   bytes                                   packed_trx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>transaction_receipt_header主要是记录了这个交易的状态信息，以及CPU和网络的使用情况。当一笔交易被某个区块引用时，区块生产者针对这笔交易会做出相应的操作，而操作的不同结果会导致这笔交易的不同状态.而transaction_receipt结构体主要包含了一个打包过的交易以及其对应的交易类型。</p>
<p>packed_transaction中打包的数据来自于signed_transaction结构体，这个结构体的主要作用就是对交易做签名。signed_transaction又是从transaction结构体继承而来，一个transaction结构体的实例包含一系列的action，这些action要么全部成功，要么全部失败。</p>
<p>交易ID是通过对交易内容本身经过Hash运算得出，所以每个交易的ID是与其内容一一对应的。交易的主体是由操作构成的。一个交易在纳入区块之前必须含有签名，用以验证交易的合法性。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /eos/libraries/chain/include/eosio/chain/transaction.hpp</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">signed_transaction</span> :</span> <span class="keyword">public</span> transaction</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// 签名信息</span></span><br><span class="line">	 <span class="built_in">vector</span>&lt;signature_type&gt;    signatures;</span><br><span class="line">	 <span class="comment">// 上下文无关的数据</span></span><br><span class="line">	 <span class="built_in">vector</span>&lt;bytes&gt;             context_free_data;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">transaction</span> :</span> <span class="keyword">public</span> transaction_header &#123;</span><br><span class="line">	 <span class="comment">// 上下文无关的action</span></span><br><span class="line">	 <span class="built_in">vector</span>&lt;action&gt;         context_free_actions;</span><br><span class="line">	 <span class="comment">// 交易操作</span></span><br><span class="line">	 <span class="built_in">vector</span>&lt;action&gt;         actions;</span><br><span class="line">	 <span class="comment">// 交易扩展类型</span></span><br><span class="line">	 extensions_type        transaction_extensions;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// /eos/libraries/chain/include/eosio/chain/transaction.hpp</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">transaction_header</span> &#123;</span></span><br><span class="line">	 <span class="comment">// 这个交易的过期时间</span></span><br><span class="line">	 time_point_sec         expiration;</span><br><span class="line">	 <span class="comment">// 在最后的2^16 blocks中指定一个具体的block number</span></span><br><span class="line">	 <span class="keyword">uint16_t</span>               ref_block_num       = <span class="number">0U</span>;</span><br><span class="line">	 <span class="comment">// 在指定的get_ref_blocknum的blockid中取低位的32bit</span></span><br><span class="line">	 <span class="keyword">uint32_t</span>               ref_block_prefix    = <span class="number">0U</span>L;</span><br><span class="line">	 <span class="comment">// 最大的网络带块</span></span><br><span class="line">	 fc::unsigned_int       max_net_usage_words = <span class="number">0U</span>L;</span><br><span class="line">	 <span class="comment">// 最大的CPU使用</span></span><br><span class="line">	 <span class="keyword">uint8_t</span>                max_cpu_usage_ms    = <span class="number">0</span>;</span><br><span class="line">	 <span class="comment">// 这个交易的延期时间</span></span><br><span class="line">	 fc::unsigned_int       delay_sec           = <span class="number">0U</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>交易分为两种类型：一种是账户发起的普通交易，一种是由代码生成的自动交易，自动交易可以设置一个延迟时间，这样的交易叫延迟型交易，这种交易不会立即被执行，而是等到设定时间到时才会被执行。</p>
<p>transaction_header结构体包含了与每一个交易相关联的固定大小的数据，这些数据从具体的交易数据中分离出来，可以在需要的时候，帮助解析交易数据，而不再需要更多的动态内存分配。</p>
<p>所有的交易都有一个期限，这个期限限定了一个交易必须在规定时间内被纳入区块链，如果我们发现一个交易的时限已经过去，就可以放心的放弃这个交易，因为所有生产者都不会将它纳入任何区块。</p>
<h2 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /eos/contracts/eosiolib/action.hpp</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">action</span> &#123;</span></span><br><span class="line">   <span class="comment">// 账户：操作的来源</span></span><br><span class="line">   account_name               account;</span><br><span class="line">   <span class="comment">// 名称：操作的标识</span></span><br><span class="line">   action_name                name;</span><br><span class="line">   <span class="comment">// 授权：执行操作的许可列表</span></span><br><span class="line">   <span class="built_in">vector</span>&lt;permission_level&gt;   authorization;</span><br><span class="line">   <span class="comment">// 数据：执行操作需要用到的信息</span></span><br><span class="line">   bytes                      data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>EOS区块链中的交易是由一个个action组成的，操作可以理解成一个能够更改区块链全局状态的方法，操作的顺序是确定的，一个交易内的操作要么全部执行成功，要么都不执行，这与交易的本意是一致的。操作是区块链的最底层逻辑，相当于区块链这个大脑的神经元，区块链的智能最终也是通过一个个操作的组合来实现的。</p>
<p>操作的设计原则：</p>
<ul>
<li>独立原则 操作本身须包含足以解释操作含义的信息，而不需要依赖区块链提供的上下文信息来帮助解释。所以，即便一个操作的当前状态可以通过区块链上的数据推导得出，我们也需要将状态信息纳入操作数据中，以便每个操作是容易理解的。这个原则体现的是区块的可解释性，这一点非常重要，这个底层的设计原则将影响整个区块链的使用效率</li>
<li>余额可计算原则 一个账户当前的余额计算，仅仅依赖于与这个账户相关的信息便可得出，而不需要解析整个区块链才能获得。这个原则针对的是比特币的设计，由于比特币的余额计算需要扫描区块链中的所有交易才能精准的计算出一个账户的余额，这使得一个非常基础的计算落地起来都变得相当繁琐，EOS的这个设计目的在于提升运算效率。</li>
<li>明确费用原则 区块链的交易费用随时间变化而变化，所以，一个签名过的交易须明确的认同这个交易所需要支付的费用，这个费用是在交易形成之前就已经设定并且明确好了的，这一点也非常重要，因为明确的费用协议才能保证余额的正确计算。</li>
<li>明确授权原则 每个操作须包含足够的授权信息以标明是哪一个账户拥有授权这个操作的权力，这种明确授权的设计思路带来几个好处：</li>
<li>便于集中管理</li>
<li>可以优化授权管理</li>
<li>便于并行处理</li>
<li>关联账户原则 每个操作须包含足够的关联账户信息，以保证这个操作能够遍历所有相关联的账户，也就是这个操作能够影响的所有账户，这个原则的目的同样是为了确保账户的余额能够得到及时和准确的运算</li>
</ul>
<p>操作的来源：</p>
<ul>
<li>由一个账号产生，通过签名来授权，即显性方式。</li>
<li>由代码生成，即隐形方式。</li>
</ul>
<h2 id="区块日志"><a href="#区块日志" class="headerlink" title="区块日志"></a>区块日志</h2><p>区块日志是存储区块的二进制文件，区块日志的特性是只能从末尾追加(append only)，区块日志包含两类文件：</p>
<p>区块文件，结构如下：</p>
<p>+———+—————-+———+—————-+—–+————+——————-+</p>
<p>| Block 1 | Pos of Block 1 | Block 2 | Pos of Block 2 | … | Head Block | Pos of Head Block |</p>
<p>+———+—————-+———+—————-+—–+————+——————-+</p>
<p>区块文件包含区块的内容以及每个区块的位置信息。区块位置信息是固定的8字节宽度，这样便于在连续读取区块的时候，按照读一个区块，向后跳跃8个字节，读一个区块，向后跳跃8个字节的模式快速加载区块内容。</p>
<p>索引文件，结构如下：</p>
<p>+—————-+—————-+—–+——————-+</p>
<p>| Pos of Block 1 | Pos of Block 2 | … | Pos of Head Block |</p>
<p>+—————-+—————-+—–+——————-+</p>
<p>区块索引的目的在于提供一个基于区块序号的快速随机搜索方法，使用索引文件可以快速定位目标区块在区块文件中的具体位置。索引文件不是必须的，没有索引文件区块链仍然可以运行，索引文件的主要作用是通过少量空间换取速度提升。索引文件可以通过顺序读取区块文件来重新构建。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/27/EOS%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/27/EOS%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">EOS学习笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-27 16:30:52" itemprop="dateCreated datePublished" datetime="2019-02-27T16:30:52+08:00">2019-02-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/" itemprop="url" rel="index"><span itemprop="name">区块链</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/EOS/" itemprop="url" rel="index"><span itemprop="name">EOS</span></a>
                </span>
            </span>

          
            <span id="/2019/02/27/EOS%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="EOS学习笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/02/27/EOS%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/02/27/EOS%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>EOS: Enterprise Operation System 中文意思为：商业级区块链操作系统。EOS 项目的目标是建立可以承载商业级智能合约与应用的区块链基础设施，成为区块链世界的“底层操作系统”。</p>
<p>EOS通过石墨烯技术解决延迟和数据吞吐量问题，TPS可达到数千，交易的确认时间也只有数秒。同时声称未来使用并行链的方式，最高可以达到数百万TPS。此外，在 EOS 上转账交易及运行智能合约不需要消耗 EOS代币。而是EOS 系统当中，抵押代币获取对应的资源，来执行相应交易，在EOS运行程序完全免费的说是不准确的。</p>
<p>EOS底层使用的是石墨烯技术，石墨烯是一个开源的区块链底层库，采用的是 DPOS（Delegated Proof-of-Stake 股份授权证明机制 ）的共识机制。DPOS为了提高出块速度TPS，限制了参与记账了人数，在DPOS中，记账者不称为矿工，而是改称为见证人Witness，现在EOS中，又有一个新词：Block Producer，简称BP，翻译为超级节点。</p>
<p>DPOS下节点需要参与见证人选举，只有赢得选举的节点才能负责出块，在EOS中，赢得选举的21个节点见证人轮流出块。另外还有100个备用见证人（候选节点），在21个见证人出现问题后做替补。EOS的发行总量是10亿，见证人在完成打包交易区块后，可以领取到区块的奖励，区块的奖励来自对发行量的通胀增发，通胀率每年接近5%。</p>
<h1 id="钱包和账户"><a href="#钱包和账户" class="headerlink" title="钱包和账户"></a>钱包和账户</h1><h2 id="钱包"><a href="#钱包" class="headerlink" title="钱包"></a>钱包</h2><p>EOS钱包功能官方上定义很单一，仅仅存私钥公钥，提供私钥公钥生成和导入，其他的功能由EOS账户统一管理，比如代币查询、交易、合约功能都属于账户关联下的功能。</p>
<h2 id="账户"><a href="#账户" class="headerlink" title="账户"></a>账户</h2><p>EOS账号由一串自定义字符组成，与以太坊中不同。账户名下有EOS系统的代币和用户调用eosio.token合约创建的代币、合约和公钥等</p>
<h2 id="钱包和账户关系"><a href="#钱包和账户关系" class="headerlink" title="钱包和账户关系"></a>钱包和账户关系</h2><p>EOS里面的key是公私钥对成对出现的，key和password不是同一个概念，虽然看起来都是一串很长的字符，但是password是针对钱包wallet的，而key则是针对账户account的。</p>
<p>假如创建了钱包hearing，不等于已经在链上有了hearing这个账户，实际上wallet和account两者之间完全是没有关系的，只有当你将account的key放在wallet里的时候，它们两者之间才有了联系。EOS账户创建需要关联钱包公钥，账户创建可以使用同一个钱包公钥创建多个账户，但各个账户是独立的。可以理解成使用同一个密码创建了不同的账户，账户数据相互独立。</p>
<p>每一个account都会有两组公私钥对，对应该账户的两个角色——owner和active。所以我们每次创建账户的时候，都需要给新账户导入两个key进去。官方推荐用户平时使用 Active 私钥，把Owner 私钥离线保存。只有重大安全问题时需要用到 Owner 私钥。</p>
<h2 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h2><p>-p</p>
<h1 id="创建钱包和账户"><a href="#创建钱包和账户" class="headerlink" title="创建钱包和账户"></a>创建钱包和账户</h1><ol>
<li><p>开启keosd</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> keosd &amp;</span></span><br></pre></td></tr></table></figure>

 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> pkill keosd</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>开启nodeos</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nodeos -e -p eosio \</span></span><br><span class="line">--plugin eosio::producer_plugin \</span><br><span class="line">--plugin eosio::chain_api_plugin \</span><br><span class="line">--plugin eosio::http_plugin \</span><br><span class="line">--plugin eosio::history_plugin \</span><br><span class="line">--plugin eosio::history_api_plugin \</span><br><span class="line">--access-control-allow-origin=&#x27;*&#x27; \</span><br><span class="line">--contracts-console \</span><br><span class="line">--http-validate-host=false \</span><br><span class="line">--verbose-http-errors \</span><br><span class="line">--filter-on=&#x27;*&#x27; &gt;&gt; nodeos.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
</li>
<li><p>钱包操作</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet list   <span class="comment"># 查看钱包</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet create --to-console/--file -n hearing    <span class="comment"># 创建钱包，生成私钥，-n指定钱包名，默认名为default</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet open   <span class="comment"># 打开钱包</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet unlock   <span class="comment"># 解锁钱包，需要提供钱包私钥</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet create_key <span class="comment"># 在钱包中创建私钥</span></span></span><br><span class="line">Created new private key with a public key of: &quot;EOS7qyuXyBtqMYLYBveB3APTiWeyu1d6Z4mTLX1mMP5ZU3kWUqXcJ&quot;</span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet keys   <span class="comment"># 查看钱包的keys</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>导入开发者Key</p>
<p> 每个新的EOSIO链都有一个名为“eosio”的默认“系统”账户。此帐户用于通过加载系统合同来设置链，该合同规定了EOSIO链的治理和共识。每个新的EOSIO链都带有一个开发密钥，这个密钥是相同的(5KQwrPbwdL6PhXujxW37FSSQZ1JiwsST4cqQzDeyXtP79zkvFD3)。这个账户在我看来就是一个使用5KQwrPbwdL6PhXujxW37FSSQZ1JiwsST4cqQzDeyXtP79zkvFD3秘钥对创建的，所以开发者需要把它导入到某个钱包，并得到对应的公钥。</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet import --private-key 5KQwrPbwdL6PhXujxW37FSSQZ1JiwsST4cqQzDeyXtP79zkvFD3   <span class="comment"># 将开发者私钥导入到default钱包，会输出对应的公钥，可通过-n指定钱包</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建秘钥</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos create key --to-console</span></span><br><span class="line">Private key: 5KRuAjE9xf6zK3AeMTZa9yLCZMQmhaBxuZePRtdUnWqB5nkd5Jk</span><br><span class="line">Public key: EOS8XaSdS9EieYyWuAfUma7cmB4TEuPWjcU8mpMRR2jztuwd1Cs2a</span><br></pre></td></tr></table></figure>

 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos create key --to-console</span></span><br><span class="line">Private key: 5J3BgEZ168EEP9shdnWBhZsPZRAfjjpUyKVxx1qjezXzJW9bEZv</span><br><span class="line">Public key: EOS81sw5LyVND1KjYoGA7iYNSo9ezgyucEjNzVAP1bPBHRdgkJo29</span><br></pre></td></tr></table></figure>
</li>
<li><p>向wallet导入秘钥</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet import -n hearing --private-key 5J3BgEZ168EEP9shdnWBhZsPZRAfjjpUyKVxx1qjezXzJW9bEZv</span></span><br><span class="line">imported private key for: EOS81sw5LyVND1KjYoGA7iYNSo9ezgyucEjNzVAP1bPBHRdgkJo29</span><br></pre></td></tr></table></figure>

 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos wallet import -n hearing --private-key 5KRuAjE9xf6zK3AeMTZa9yLCZMQmhaBxuZePRtdUnWqB5nkd5Jk</span></span><br><span class="line">imported private key for: EOS8XaSdS9EieYyWuAfUma7cmB4TEuPWjcU8mpMRR2jztuwd1Cs2a</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建账户</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos create account [OPTIONS] creator name OwnerKey [ActiveKey]  <span class="comment"># 命令中的key为public-key</span></span></span><br></pre></td></tr></table></figure>

 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos create account eosio hearing EOS81sw5LyVND1KjYoGA7iYNSo9ezgyucEjNzVAP1bPBHRdgkJo29 EOS8XaSdS9EieYyWuAfUma7cmB4TEuPWjcU8mpMRR2jztuwd1Cs2a</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos create account hearing hearing1 EOS81sw5LyVND1KjYoGA7iYNSo9ezgyucEjNzVAP1bPBHRdgkJo29 EOS8XaSdS9EieYyWuAfUma7cmB4TEuPWjcU8mpMRR2jztuwd1Cs2a</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="智能合约"><a href="#智能合约" class="headerlink" title="智能合约"></a>智能合约</h1><p>在eos私有节点操作中，我们通常是一个合约对应一个合约账户，并且一个账户中只能部署一个智能合约。如果在同一个账户部署多个合约，那么最后部署的合约会覆盖掉之前的合约。</p>
<h2 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h2><ol>
<li><p>编写合约</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;eosiolib/eosio.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> eosio;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> [[<span class="title">eosio</span>:</span>:contract(<span class="string">&quot;hello&quot;</span>)]] hello : <span class="keyword">public</span> contract &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">using</span> contract::contract;</span><br><span class="line"></span><br><span class="line">    [[eosio::action]]</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">hi</span><span class="params">( name user )</span> </span>&#123;</span><br><span class="line">        print( <span class="string">&quot;Hello, &quot;</span>, user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">EOSIO_DISPATCH( hello, (hi))</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译合约</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> eosio-cpp -I include -o hello.wasm hello.cpp --abigen</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建账户</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos create account eosio hello EOS7qyuXyBtqMYLYBveB3APTiWeyu1d6Z4mTLX1mMP5ZU3kWUqXcJ -p eosio@active    <span class="comment"># -p指定账户的权限</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>部署合约</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos <span class="built_in">set</span> contract hello CONTRACTS_DIR/hello -p hello@active</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>调用合约</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos push action hello hi <span class="string">&#x27;[&quot;bob&quot;]&#x27;</span> -p alice@active</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="eosio-token合约"><a href="#eosio-token合约" class="headerlink" title="eosio.token合约"></a>eosio.token合约</h2><p>在eos目录中自带的合约中，有一个eosio.token智能合约，这个智能合约的功能是为账户发放token，token可以用来转账操作。</p>
<ol>
<li><p>创建账户</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos create account eosio eosio.token EOS81sw5LyVND1KjYoGA7iYNSo9ezgyucEjNzVAP1bPBHRdgkJo29 EOS8XaSdS9EieYyWuAfUma7cmB4TEuPWjcU8mpMRR2jztuwd1Cs2a</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>把eosio.token合约部署到eosio.token账户上</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos <span class="built_in">set</span> contract eosio.token ./eosio.token</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建代币</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos push action eosio.token create <span class="string">&#x27;[ &quot;eosio&quot;, &quot;1000000000.0000 EOS&quot;, 0, 0, 0]&#x27;</span> -p eosio.token@active</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>为账户发放token</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos push action eosio.token issue <span class="string">&#x27;[ &quot;lilei&quot;, &quot;1000.0000 EOS&quot;, &quot;&quot; ]&#x27;</span> -p eosio@active</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>交易token</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos push action eosio.token transfer <span class="string">&#x27;[ &quot;eosio&quot;, &quot;hearing&quot;, &quot;25.0000 EOS&quot;, &quot;m&quot; ]&#x27;</span> -p eosio@active</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查询余额</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos get currency balance eosio.token hearing EOS</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h1 id="单主机多节点"><a href="#单主机多节点" class="headerlink" title="单主机多节点"></a>单主机多节点</h1><h2 id="关于配置"><a href="#关于配置" class="headerlink" title="关于配置"></a>关于配置</h2><p>比如机器10.186.11.211上的部分配置：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">bnet-endpoint = <span class="number">10.186</span><span class="number">.11</span><span class="number">.211</span>:<span class="number">4321</span>    </span><br><span class="line"></span><br><span class="line"><span class="comment">//for communicatin with cleos</span></span><br><span class="line">http-server-address = <span class="number">10.186</span><span class="number">.11</span><span class="number">.211</span>:<span class="number">8888</span>  </span><br><span class="line">  </span><br><span class="line"><span class="comment">//for sync block</span></span><br><span class="line">p2p-listen-endpoint = <span class="number">10.186</span><span class="number">.11</span><span class="number">.211</span>:<span class="number">9876</span> </span><br><span class="line">p2p-peer-address = <span class="number">10.186</span><span class="number">.11</span><span class="number">.223</span>:<span class="number">9876</span></span><br><span class="line">p2p-peer-address = <span class="number">10.186</span><span class="number">.11</span><span class="number">.220</span>:<span class="number">9876</span></span><br><span class="line">p2p-peer-address = <span class="number">10.186</span><span class="number">.11</span><span class="number">.141</span>:<span class="number">9876</span> </span><br></pre></td></tr></table></figure>

<ul>
<li>bnet-endpoint: 所监听的传入链接的端点。　默认：0.0.0.0:4321</li>
<li>http-server-address: 本地的http服务地址 默认: 127.0.0.1:8888</li>
<li>p2p-listen-endpoint: 所监听的p2p传入链接的端点。　默认：0.0.0.0:9876</li>
<li>p2p-peer-address: 公共的p2p对等节点地址。</li>
</ul>
<h2 id="启动keosd"><a href="#启动keosd" class="headerlink" title="启动keosd"></a>启动keosd</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> keosd --http-server-address 127.0.0.1:8899</span></span><br></pre></td></tr></table></figure>

<h2 id="创建钱包"><a href="#创建钱包" class="headerlink" title="创建钱包"></a>创建钱包</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos --wallet-url http://127.0.0.1:8899  wallet create --to-console</span></span><br><span class="line">Creating wallet: default</span><br><span class="line">Save password to use in the future to unlock this wallet.</span><br><span class="line">Without password imported keys will not be retrievable.</span><br><span class="line">&quot;PW5J2VNR7bJpNtuJXwaEy2LNug5BNbBRRZUR8DcMPd7CrqMVtvnVn&quot;</span><br></pre></td></tr></table></figure>

<h2 id="加载eosio秘钥"><a href="#加载eosio秘钥" class="headerlink" title="加载eosio秘钥"></a>加载eosio秘钥</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos --wallet-url http://127.0.0.1:8899 wallet import --private-key 5KQwrPbwdL6PhXujxW37FSSQZ1JiwsST4cqQzDeyXtP79zkvFD3</span></span><br><span class="line">imported private key for: EOS6MRyAjQq8ud7hVNYcfnVPJqcVpscN5So8BhtHuGYqET5GDW5CV</span><br></pre></td></tr></table></figure>

<h2 id="启动第一个生产节点"><a href="#启动第一个生产节点" class="headerlink" title="启动第一个生产节点"></a>启动第一个生产节点</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nodeos --enable-stale-production --producer-name eosio --plugin eosio::chain_api_plugin --plugin eosio::net_api_plugin --max-transaction-time=1000 --hard-replay-blockchain</span></span><br></pre></td></tr></table></figure>

<h2 id="启动第二个生产节点"><a href="#启动第二个生产节点" class="headerlink" title="启动第二个生产节点"></a>启动第二个生产节点</h2><h3 id="加载eosio-bios合约"><a href="#加载eosio-bios合约" class="headerlink" title="加载eosio.bios合约"></a>加载eosio.bios合约</h3><p>要启动其他节点，必须先加载eosio.bios合同。通过此合同，可以直接控制其他帐户的资源分配并访问其他特权API调用。（如果第一次已经加载了合约，那么这一步可以跳过）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos --wallet-url http://127.0.0.1:8899 <span class="built_in">set</span> contract eosio ./eosio.bios</span></span><br></pre></td></tr></table></figure>

<h3 id="创建账户-inita"><a href="#创建账户-inita" class="headerlink" title="创建账户(inita)"></a>创建账户(inita)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos create key --to-console</span></span><br><span class="line">Private key: 5JcjxL4XqNvR85aQ9hAqworWJuoJfDoGo7wUtZLDbVePRXWCxUf</span><br><span class="line">Public key: EOS58iXdanxG4nwok3AVSrDGu4Fj2dTB9HqeLUdbQu6wRRgyq18CS</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos --wallet-url http://127.0.0.1:8899 wallet import --private-key 5JcjxL4XqNvR85aQ9hAqworWJuoJfDoGo7wUtZLDbVePRXWCxUf</span></span><br><span class="line">imported private key for: EOS58iXdanxG4nwok3AVSrDGu4Fj2dTB9HqeLUdbQu6wRRgyq18CS</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos --wallet-url http://127.0.0.1:8899 create account eosio inita EOS58iXdanxG4nwok3AVSrDGu4Fj2dTB9HqeLUdbQu6wRRgyq18CS EOS58iXdanxG4nwok3AVSrDGu4Fj2dTB9HqeLUdbQu6wRRgyq18CS</span></span><br></pre></td></tr></table></figure>

<h3 id="命令行启动节点"><a href="#命令行启动节点" class="headerlink" title="命令行启动节点"></a>命令行启动节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nodeos --producer-name inita --plugin eosio::chain_api_plugin --plugin eosio::net_api_plugin --http-server-address 127.0.0.1:8889 --p2p-listen-endpoint 127.0.0.1:9877 --p2p-peer-address 127.0.0.1:9876 --config-dir node2 --data-dir node2 --private-key 5JcjxL4XqNvR85aQ9hAqworWJuoJfDoGo7wUtZLDbVePRXWCxUf</span></span><br></pre></td></tr></table></figure>

<p>将inita注册为具有bios节点的生产者，并且bios节点需要执行动作来更新生产者计划（测试失败）:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos --wallet-url http://127.0.0.1:8899 push action eosio setprods <span class="string">&quot;&#123; \&quot;schedule\&quot;: [&#123;\&quot;producer_name\&quot;: \&quot;inita\&quot;,\&quot;block_signing_key\&quot;: \&quot;EOS58iXdanxG4nwok3AVSrDGu4Fj2dTB9HqeLUdbQu6wRRgyq18CS\&quot;&#125;]&#125;&quot;</span> -p eosio@active</span></span><br></pre></td></tr></table></figure>

<h3 id="配置文件启动节点"><a href="#配置文件启动节点" class="headerlink" title="配置文件启动节点"></a>配置文件启动节点</h3><p>也可以通过conf文件启动多个节点，方式如下：</p>
<p>node2.ini：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> communicatin with cleos</span></span><br><span class="line">http-server-address = 127.0.0.1:8889</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> sync block</span></span><br><span class="line">p2p-listen-endpoint = 127.0.0.1:9877</span><br><span class="line">p2p-peer-address = 127.0.0.1:9876</span><br><span class="line">p2p-peer-address = 127.0.0.1:9878</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> agent-name = <span class="string">&quot;EOS Test Agent&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> eosio, this flag must be <span class="literal">true</span>, <span class="keyword">else</span> must be <span class="built_in">set</span> <span class="literal">false</span>, it decide whether or not </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> product block</span></span><br><span class="line">enable-stale-production = true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> producer name</span></span><br><span class="line">producer-name = inita</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> producer key,get by use<span class="string">&quot;cleos ceate key&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> private-key =[<span class="string">&quot;EOS8Znrtgwt8TfpmbVpTKvA2oB8Nqey625CLN8bCN3TEbgx86Dsvr&quot;</span>, <span class="string">&quot;5K463ynhZoCDDa4RDcr63cUwWLTnKqmdcoTKTHBjqoKfv4u5V7p&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> load plugin</span></span><br><span class="line">plugin = eosio::chain_api_plugin</span><br><span class="line">plugin = eosio::history_api_plugin</span><br><span class="line">plugin = eosio::chain_plugin</span><br><span class="line">plugin = eosio::history_plugin</span><br><span class="line">plugin = eosio::net_plugin</span><br><span class="line">plugin = eosio::net_api_plugin </span><br></pre></td></tr></table></figure>

<p>node3.ini：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> communicatin with cleos</span></span><br><span class="line">http-server-address = 127.0.0.1:8890</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> sync block</span></span><br><span class="line">p2p-listen-endpoint = 127.0.0.1:9878</span><br><span class="line">p2p-peer-address = 127.0.0.1:9876</span><br><span class="line">p2p-peer-address = 127.0.0.1:9877</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> agent-name = <span class="string">&quot;EOS Test Agent&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> eosio, this flag must be <span class="literal">true</span>, <span class="keyword">else</span> must be <span class="built_in">set</span> <span class="literal">false</span>, it decide whether or not </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> product block</span></span><br><span class="line">enable-stale-production = true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> producer name</span></span><br><span class="line">producer-name = initb</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> producer key,get by use<span class="string">&quot;cleos ceate key&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> private-key =[<span class="string">&quot;EOS8Znrtgwt8TfpmbVpTKvA2oB8Nqey625CLN8bCN3TEbgx86Dsvr&quot;</span>, <span class="string">&quot;5K463ynhZoCDDa4RDcr63cUwWLTnKqmdcoTKTHBjqoKfv4u5V7p&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> load plugin</span></span><br><span class="line">plugin = eosio::chain_api_plugin</span><br><span class="line">plugin = eosio::history_api_plugin</span><br><span class="line">plugin = eosio::chain_plugin</span><br><span class="line">plugin = eosio::history_plugin</span><br><span class="line">plugin = eosio::net_plugin</span><br><span class="line">plugin = eosio::net_api_plugin </span><br></pre></td></tr></table></figure>

<p>启动node2：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nodeos --config node2.ini --config-dir node2 --data-dir node2 --private-key 5JcjxL4XqNvR85aQ9hAqworWJuoJfDoGo7wUtZLDbVePRXWCxUf</span><br></pre></td></tr></table></figure>

<p>启动node3：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nodeos --config node3.ini --config-dir node3 --data-dir node3 --private-key 5JcjxL4XqNvR85aQ9hAqworWJuoJfDoGo7wUtZLDbVePRXWCxUf</span><br></pre></td></tr></table></figure>

<h1 id="搭建测试网络的自动化脚本"><a href="#搭建测试网络的自动化脚本" class="headerlink" title="搭建测试网络的自动化脚本"></a>搭建测试网络的自动化脚本</h1><p>为方便搭建测试环境，我将一些相关的操作都封装到了一个shell脚本中，在此附上脚本的github地址：<a target="_blank" rel="noopener" href="https://github.com/ljd1996/eos_script/tree/master/mult_node">https://github.com/ljd1996/eos_script/tree/master/mult_node</a>.</p>
<p>该脚本的目录结构如下：</p>
<pre><code>├── conf
│   ├── node10.ini
│   ├── node11.ini
│   ├── node12.ini
│   ├── node1.ini
│   ├── node2.ini
│   ├── node3.ini
│   ├── node4.ini
│   ├── node5.ini
│   ├── node6.ini
│   ├── node7.ini
│   ├── node8.ini
│   └── node9.ini
├── data
├── key
├── log
└── wpk
├── start.sh</code></pre>
<p>下面我将分别介绍每个文件和目录的作用：</p>
<ul>
<li>data目录主要存储节点启动后的区块等相关的数据，均由EOS自动生成，不需要自己做相关处理；</li>
<li>key目录用来存储节点构建过程中生成的账户的秘钥对；</li>
<li>log用来存项keos和nodeos运行过程中的日志输出；</li>
<li>wpk目录用来存储账户数据；</li>
<li>start.sh是脚本的源码。</li>
</ul>
<p>其中，在运行脚本时我们唯一需要修改的是conf下面的配置文件，下面是其中一个配置文件的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> communicatin with cleos</span></span><br><span class="line">http-server-address = 192.168.11.103:8888</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> sync block</span></span><br><span class="line">p2p-listen-endpoint = 192.168.11.103:9876</span><br><span class="line">p2p-peer-address = 192.168.11.103:9877</span><br><span class="line">p2p-peer-address = 192.168.11.103:9878</span><br><span class="line">p2p-peer-address = 192.168.11.103:9879</span><br><span class="line">p2p-peer-address = 192.168.11.135:9880</span><br><span class="line">p2p-peer-address = 192.168.11.135:9881</span><br><span class="line">p2p-peer-address = 192.168.11.135:9882</span><br><span class="line">p2p-peer-address = 192.168.11.135:9883</span><br><span class="line">p2p-peer-address = 192.168.11.135:9884</span><br><span class="line">p2p-peer-address = 192.168.11.135:9885</span><br><span class="line">p2p-peer-address = 192.168.11.135:9886</span><br><span class="line">p2p-peer-address = 192.168.11.135:9887</span><br><span class="line">p2p-peer-address = 192.168.11.135:9888</span><br><span class="line">p2p-peer-address = 192.168.11.135:9889</span><br><span class="line">p2p-peer-address = 192.168.11.103:9890</span><br><span class="line">p2p-peer-address = 192.168.11.103:9891</span><br><span class="line">p2p-peer-address = 192.168.11.103:9892</span><br><span class="line">p2p-peer-address = 192.168.11.103:9893</span><br><span class="line">p2p-peer-address = 192.168.11.103:9894</span><br><span class="line">p2p-peer-address = 192.168.11.103:9895</span><br><span class="line">p2p-peer-address = 192.168.11.103:9896</span><br><span class="line">p2p-peer-address = 192.168.11.103:9897</span><br><span class="line">p2p-peer-address = 192.168.11.135:9877</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> eosio, this flag must be <span class="literal">true</span>, <span class="keyword">else</span> must be <span class="built_in">set</span> <span class="literal">false</span>, it decide whether or not product block</span></span><br><span class="line">enable-stale-production = true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> load plugin</span></span><br><span class="line">plugin = eosio::chain_api_plugin</span><br><span class="line">plugin = eosio::history_api_plugin</span><br><span class="line">plugin = eosio::chain_plugin</span><br><span class="line">plugin = eosio::history_plugin</span><br><span class="line">plugin = eosio::net_plugin</span><br><span class="line">plugin = eosio::net_api_plugin</span><br><span class="line">plugin = eosio::txn_test_gen_plugin</span><br></pre></td></tr></table></figure>

<ul>
<li>http-server-address： 开启的节点之中，这个值不能冲突，ip为本机的ip（ip:port）</li>
<li>p2p-listen-endpoint： 在节点的端到端连接中表示自己这个节点的位置，也需保持唯一，ip为本机的ip（ip:port）</li>
<li>p2p-peer-address： 端到端连接中其他节点的位置</li>
<li>enable-stale-production： 出块节点需要设置为true</li>
<li>plugin： 插件</li>
</ul>
<p>在每次启动节点前，确定一下自己需要启动的节点数以及各自节点的网络地址，然后把conf下的配置文件按照上述原则进行修改，每个node.imi对应一个节点的配置文件，且命名规则和原来一样递增，否则可能会造成节点的开启失败。</p>
<p>脚本使用方法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 清除相关数据</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./start.sh clean</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 运行脚本启动节点</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./start.sh run wallet_dir contracts_dir node_num</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> wallet_dir：本地钱包所在目录</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> contracts_dir：EOS中系统智能合约所在目录</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> node_num：在本机要开启的节点数，视conf中的配置文件数而定</span></span><br></pre></td></tr></table></figure>

<h1 id="多主机多节点测试网搭建"><a href="#多主机多节点测试网搭建" class="headerlink" title="多主机多节点测试网搭建"></a>多主机多节点测试网搭建</h1><p>本节主要介绍如何通过自动化脚本在两台物理机上分别开启多个节点，并测试TPS的过程。</p>
<h2 id="主机A的配置"><a href="#主机A的配置" class="headerlink" title="主机A的配置"></a>主机A的配置</h2><p>在主机A：192.168.11.103中开启12个节点，其中节点1–eosio节点作为出块节点。下面给出几个配置文件的内容：</p>
<p>node1.imi：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> communicatin with cleos</span></span><br><span class="line">http-server-address = 192.168.11.103:8888</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> sync block</span></span><br><span class="line">p2p-listen-endpoint = 192.168.11.103:9876</span><br><span class="line">p2p-peer-address = 192.168.11.103:9877</span><br><span class="line">p2p-peer-address = 192.168.11.103:9878</span><br><span class="line">p2p-peer-address = 192.168.11.103:9879</span><br><span class="line">p2p-peer-address = 192.168.11.135:9880</span><br><span class="line">p2p-peer-address = 192.168.11.135:9881</span><br><span class="line">p2p-peer-address = 192.168.11.135:9882</span><br><span class="line">p2p-peer-address = 192.168.11.135:9883</span><br><span class="line">p2p-peer-address = 192.168.11.135:9884</span><br><span class="line">p2p-peer-address = 192.168.11.135:9885</span><br><span class="line">p2p-peer-address = 192.168.11.135:9886</span><br><span class="line">p2p-peer-address = 192.168.11.135:9887</span><br><span class="line">p2p-peer-address = 192.168.11.135:9888</span><br><span class="line">p2p-peer-address = 192.168.11.135:9889</span><br><span class="line">p2p-peer-address = 192.168.11.103:9890</span><br><span class="line">p2p-peer-address = 192.168.11.103:9891</span><br><span class="line">p2p-peer-address = 192.168.11.103:9892</span><br><span class="line">p2p-peer-address = 192.168.11.103:9893</span><br><span class="line">p2p-peer-address = 192.168.11.103:9894</span><br><span class="line">p2p-peer-address = 192.168.11.103:9895</span><br><span class="line">p2p-peer-address = 192.168.11.103:9896</span><br><span class="line">p2p-peer-address = 192.168.11.103:9897</span><br><span class="line">p2p-peer-address = 192.168.11.135:9877</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> eosio, this flag must be <span class="literal">true</span>, <span class="keyword">else</span> must be <span class="built_in">set</span> <span class="literal">false</span>, it decide whether or not product block</span></span><br><span class="line">enable-stale-production = true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> load plugin</span></span><br><span class="line">plugin = eosio::chain_api_plugin</span><br><span class="line">plugin = eosio::history_api_plugin</span><br><span class="line">plugin = eosio::chain_plugin</span><br><span class="line">plugin = eosio::history_plugin</span><br><span class="line">plugin = eosio::net_plugin</span><br><span class="line">plugin = eosio::net_api_plugin</span><br><span class="line">plugin = eosio::txn_test_gen_plugin</span><br></pre></td></tr></table></figure>

<p>node12.imi：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> communicatin with cleos</span></span><br><span class="line">http-server-address = 192.168.11.103:8909</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> sync block</span></span><br><span class="line">p2p-listen-endpoint = 192.168.11.103:9897</span><br><span class="line">p2p-peer-address = 192.168.11.103:9876</span><br><span class="line">p2p-peer-address = 192.168.11.103:9877</span><br><span class="line">p2p-peer-address = 192.168.11.103:9878</span><br><span class="line">p2p-peer-address = 192.168.11.103:9879</span><br><span class="line">p2p-peer-address = 192.168.11.135:9881</span><br><span class="line">p2p-peer-address = 192.168.11.135:9882</span><br><span class="line">p2p-peer-address = 192.168.11.135:9883</span><br><span class="line">p2p-peer-address = 192.168.11.135:9884</span><br><span class="line">p2p-peer-address = 192.168.11.135:9885</span><br><span class="line">p2p-peer-address = 192.168.11.135:9886</span><br><span class="line">p2p-peer-address = 192.168.11.135:9887</span><br><span class="line">p2p-peer-address = 192.168.11.135:9888</span><br><span class="line">p2p-peer-address = 192.168.11.135:9889</span><br><span class="line">p2p-peer-address = 192.168.11.103:9890</span><br><span class="line">p2p-peer-address = 192.168.11.103:9891</span><br><span class="line">p2p-peer-address = 192.168.11.103:9892</span><br><span class="line">p2p-peer-address = 192.168.11.103:9893</span><br><span class="line">p2p-peer-address = 192.168.11.103:9894</span><br><span class="line">p2p-peer-address = 192.168.11.103:9895</span><br><span class="line">p2p-peer-address = 192.168.11.103:9896</span><br><span class="line">p2p-peer-address = 192.168.11.135:9880</span><br><span class="line">p2p-peer-address = 192.168.11.135:9877</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">if</span> eosio, this flag must be <span class="literal">true</span>, <span class="keyword">else</span> must be <span class="built_in">set</span> <span class="literal">false</span>, it decide whether or not product block</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> enable-stale-production = <span class="literal">true</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> load plugin</span></span><br><span class="line">plugin = eosio::chain_api_plugin</span><br><span class="line">plugin = eosio::history_api_plugin</span><br><span class="line">plugin = eosio::chain_plugin</span><br><span class="line">plugin = eosio::history_plugin</span><br><span class="line">plugin = eosio::net_plugin</span><br><span class="line">plugin = eosio::net_api_plugin </span><br><span class="line">plugin = eosio::txn_test_gen_plugin</span><br></pre></td></tr></table></figure>

<p>开启节点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./start.sh run /home/hearing/eosio-wallet ~/Downloads/eosio.contracts 12</span></span><br></pre></td></tr></table></figure>

<h2 id="主机B的配置"><a href="#主机B的配置" class="headerlink" title="主机B的配置"></a>主机B的配置</h2><p>在主机A：192.168.11.135中开启10个节点，所有节点都不出块。下面给出一个配置文件的内容：</p>
<p>node1.imi：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> communicatin with cleos</span></span><br><span class="line">http-server-address = 192.168.11.135:8892</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">for</span> sync block</span></span><br><span class="line">p2p-listen-endpoint = 192.168.11.135:9880</span><br><span class="line">p2p-peer-address = 192.168.11.103:9876</span><br><span class="line">p2p-peer-address = 192.168.11.103:9877</span><br><span class="line">p2p-peer-address = 192.168.11.103:9878</span><br><span class="line">p2p-peer-address = 192.168.11.103:9879</span><br><span class="line">p2p-peer-address = 192.168.11.135:9881</span><br><span class="line">p2p-peer-address = 192.168.11.135:9882</span><br><span class="line">p2p-peer-address = 192.168.11.135:9883</span><br><span class="line">p2p-peer-address = 192.168.11.135:9884</span><br><span class="line">p2p-peer-address = 192.168.11.135:9885</span><br><span class="line">p2p-peer-address = 192.168.11.135:9886</span><br><span class="line">p2p-peer-address = 192.168.11.135:9887</span><br><span class="line">p2p-peer-address = 192.168.11.135:9888</span><br><span class="line">p2p-peer-address = 192.168.11.135:9889</span><br><span class="line">p2p-peer-address = 192.168.11.103:9890</span><br><span class="line">p2p-peer-address = 192.168.11.103:9891</span><br><span class="line">p2p-peer-address = 192.168.11.103:9892</span><br><span class="line">p2p-peer-address = 192.168.11.103:9893</span><br><span class="line">p2p-peer-address = 192.168.11.103:9894</span><br><span class="line">p2p-peer-address = 192.168.11.103:9895</span><br><span class="line">p2p-peer-address = 192.168.11.103:9896</span><br><span class="line">p2p-peer-address = 192.168.11.103:9897</span><br><span class="line">p2p-peer-address = 192.168.11.135:9877</span><br></pre></td></tr></table></figure>

<p>开启节点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ./start.sh run /home/hearing/eosio-wallet ~/Downloads/eosio.contracts 10</span></span><br></pre></td></tr></table></figure>

<h2 id="测试tps"><a href="#测试tps" class="headerlink" title="测试tps"></a>测试tps</h2><p>使用EOS官方推荐的txn_test_gen_plugin插件作为tps的测试工具，其原理如下：</p>
<ol>
<li><p>在一个指定的节点上新建测试账户</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl --data-binary <span class="string">&#x27;[&quot;eosio&quot;, &quot;5KQwrPbwdL6PhXujxW37FSSQZ1JiwsST4cqQzDeyXtP79zkvFD3&quot;]&#x27;</span> http://192.168.11.103:8888/v1/txn_test_gen/create_test_accounts</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在测试账户间进行自动交易(每10秒产生20个交易)</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl --data-binary <span class="string">&#x27;[&quot;&quot;, 10, 20]&#x27;</span> http://192.168.11.103:8888/v1/txn_test_gen/start_generation</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>上述产生交易的步骤也可在其他节点上运行</p>
</li>
<li><p>查看节点的输出日志，计算tps</p>
<ul>
<li><p>出块节点的日志：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">info  2019-03-13T07:56:24.050 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 00000519d3484607... #1305 @ 2019-03-13T07:56:24.000 signed by eosio [trxs: 371, lib: 1304, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:24.539 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000051aaa2f783e... #1306 @ 2019-03-13T07:56:24.500 signed by eosio [trxs: 358, lib: 1305, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:25.017 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000051beb1d3276... #1307 @ 2019-03-13T07:56:25.000 signed by eosio [trxs: 257, lib: 1306, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:25.549 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000051c6c7937c6... #1308 @ 2019-03-13T07:56:25.500 signed by eosio [trxs: 155, lib: 1307, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:26.028 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000051d9113d888... #1309 @ 2019-03-13T07:56:26.000 signed by eosio [trxs: 154, lib: 1308, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:26.559 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000051ed4d34911... #1310 @ 2019-03-13T07:56:26.500 signed by eosio [trxs: 276, lib: 1309, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:27.023 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000051f69ccd987... #1311 @ 2019-03-13T07:56:27.000 signed by eosio [trxs: 163, lib: 1310, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:27.544 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 000005208f4e00f9... #1312 @ 2019-03-13T07:56:27.500 signed by eosio [trxs: 249, lib: 1311, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:28.033 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 000005210110210b... #1313 @ 2019-03-13T07:56:28.000 signed by eosio [trxs: 214, lib: 1312, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:28.526 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 00000522ea3e4544... #1314 @ 2019-03-13T07:56:28.500 signed by eosio [trxs: 314, lib: 1313, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:29.017 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 000005234705e92a... #1315 @ 2019-03-13T07:56:29.000 signed by eosio [trxs: 259, lib: 1314, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:29.527 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 00000524841be821... #1316 @ 2019-03-13T07:56:29.500 signed by eosio [trxs: 502, lib: 1315, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:30.014 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 000005257f6d4e2e... #1317 @ 2019-03-13T07:56:30.000 signed by eosio [trxs: 897, lib: 1316, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:30.521 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 00000526b3aa10f1... #1318 @ 2019-03-13T07:56:30.500 signed by eosio [trxs: 526, lib: 1317, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:31.023 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000052756e32d73... #1319 @ 2019-03-13T07:56:31.000 signed by eosio [trxs: 652, lib: 1318, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:31.514 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 000005288100c034... #1320 @ 2019-03-13T07:56:31.500 signed by eosio [trxs: 616, lib: 1319, confirmed: 0]</span><br><span class="line">info  2019-03-13T07:56:32.048 thread-0  producer_plugin.cpp:1584      produce_block        ] Produced block 0000052914f4a78b... #1321 @ 2019-03-13T07:56:32.000 signed by eosio [trxs: 662, lib: 1320, confirmed: 0]</span><br></pre></td></tr></table></figure>
</li>
<li><p>其他节点的日志：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">info  2019-03-13T07:55:53.164 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 9f6a6c4c171e385a... #1243 @ 2019-03-13T07:55:53.000 signed by eosio [trxs: 128, lib: 1242, conf: 0, latency: 164 ms]</span><br><span class="line">info  2019-03-13T07:55:53.600 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block faff04083aafe1e8... #1244 @ 2019-03-13T07:55:53.500 signed by eosio [trxs: 79, lib: 1243, conf: 0, latency: 100 ms]</span><br><span class="line">info  2019-03-13T07:55:54.139 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block bf606f4ee1ee1498... #1245 @ 2019-03-13T07:55:54.000 signed by eosio [trxs: 113, lib: 1244, conf: 0, latency: 139 ms]</span><br><span class="line">info  2019-03-13T07:55:54.806 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block e7ba16b5cda9ae0e... #1246 @ 2019-03-13T07:55:54.500 signed by eosio [trxs: 224, lib: 1245, conf: 0, latency: 306 ms]</span><br><span class="line">info  2019-03-13T07:55:55.151 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 149c694678a74f0e... #1247 @ 2019-03-13T07:55:55.000 signed by eosio [trxs: 144, lib: 1246, conf: 0, latency: 151 ms]</span><br><span class="line">info  2019-03-13T07:55:55.634 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 06efdba68e432e11... #1248 @ 2019-03-13T07:55:55.500 signed by eosio [trxs: 112, lib: 1247, conf: 0, latency: 134 ms]</span><br><span class="line">info  2019-03-13T07:55:56.100 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 1722e7db91fbc95b... #1249 @ 2019-03-13T07:55:56.000 signed by eosio [trxs: 112, lib: 1248, conf: 0, latency: 100 ms]</span><br><span class="line">info  2019-03-13T07:55:56.615 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block a1ea6b148a9669a8... #1250 @ 2019-03-13T07:55:56.500 signed by eosio [trxs: 112, lib: 1249, conf: 0, latency: 115 ms]</span><br><span class="line">info  2019-03-13T07:55:57.131 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block ea93f8c7878d058b... #1251 @ 2019-03-13T07:55:57.000 signed by eosio [trxs: 112, lib: 1250, conf: 0, latency: 131 ms]</span><br><span class="line">info  2019-03-13T07:55:57.744 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block a0f4be3b1b68b79c... #1252 @ 2019-03-13T07:55:57.500 signed by eosio [trxs: 169, lib: 1251, conf: 0, latency: 244 ms]</span><br><span class="line">info  2019-03-13T07:55:58.173 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 7334cd134b162612... #1253 @ 2019-03-13T07:55:58.000 signed by eosio [trxs: 126, lib: 1252, conf: 0, latency: 173 ms]</span><br><span class="line">info  2019-03-13T07:55:58.730 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 0c563bf6bad3095a... #1254 @ 2019-03-13T07:55:58.500 signed by eosio [trxs: 169, lib: 1253, conf: 0, latency: 230 ms]</span><br><span class="line">info  2019-03-13T07:55:59.086 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 6d0901b8f1b15739... #1255 @ 2019-03-13T07:55:59.000 signed by eosio [trxs: 64, lib: 1254, conf: 0, latency: 86 ms]</span><br><span class="line">info  2019-03-13T07:55:59.778 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 01a641dfcb07dbe5... #1256 @ 2019-03-13T07:55:59.500 signed by eosio [trxs: 251, lib: 1255, conf: 0, latency: 278 ms]</span><br><span class="line">info  2019-03-13T07:56:00.131 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 308907ac4cf4bc98... #1257 @ 2019-03-13T07:56:00.000 signed by eosio [trxs: 85, lib: 1256, conf: 0, latency: 131 ms]</span><br><span class="line">info  2019-03-13T07:56:00.688 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 3834f77aa9b994c9... #1258 @ 2019-03-13T07:56:00.500 signed by eosio [trxs: 128, lib: 1257, conf: 0, latency: 188 ms]</span><br><span class="line">info  2019-03-13T07:56:01.359 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 4ad642cb075d8d2a... #1259 @ 2019-03-13T07:56:01.000 signed by eosio [trxs: 206, lib: 1258, conf: 0, latency: 359 ms]</span><br><span class="line">info  2019-03-13T07:56:01.630 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 9ed257c131cffcee... #1260 @ 2019-03-13T07:56:01.500 signed by eosio [trxs: 114, lib: 1259, conf: 0, latency: 130 ms]</span><br><span class="line">info  2019-03-13T07:56:02.114 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block be8627adc345d6a4... #1261 @ 2019-03-13T07:56:02.000 signed by eosio [trxs: 96, lib: 1260, conf: 0, latency: 114 ms]</span><br><span class="line">info  2019-03-13T07:56:02.732 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 6d609f6c67134258... #1262 @ 2019-03-13T07:56:02.500 signed by eosio [trxs: 211, lib: 1261, conf: 0, latency: 232 ms]</span><br><span class="line">info  2019-03-13T07:56:03.152 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block d884495e2f09d7ff... #1263 @ 2019-03-13T07:56:03.000 signed by eosio [trxs: 116, lib: 1262, conf: 0, latency: 152 ms]</span><br><span class="line">info  2019-03-13T07:56:03.741 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 2735616823a12a4b... #1264 @ 2019-03-13T07:56:03.500 signed by eosio [trxs: 133, lib: 1263, conf: 0, latency: 241 ms]</span><br><span class="line">info  2019-03-13T07:56:04.321 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 55d4565cc4094b30... #1265 @ 2019-03-13T07:56:04.000 signed by eosio [trxs: 192, lib: 1264, conf: 0, latency: 321 ms]</span><br><span class="line">info  2019-03-13T07:56:04.744 thread-0  producer_plugin.cpp:345       on_incoming_block    ] Received block 1e4ba2d9bee5b06f... #1266 @ 2019-03-13T07:56:04.500 signed by eosio [trxs: 228, lib: 1265, conf: 0, latency: 244 ms]</span><br></pre></td></tr></table></figure>

<p>tps的计算方式为日志中的<code>trxs</code>数值乘以2，因为EOS的出块时间是每500毫秒出一个区块。</p>
</li>
</ul>
</li>
</ol>
<h1 id="启动测试网"><a href="#启动测试网" class="headerlink" title="启动测试网"></a>启动测试网</h1><p>用户可以主观地给候选节点投票，当所有代币的15%进行投票后，会由投票数靠前的节点（默认21个）出块，出块的节点票数必须大于0，且超级节点数默认<strong>不大于</strong>21个。</p>
<p>可以通过上述给出的链接中的脚本进行自动化启动，具体使用如下（我这里一共开启了包括创世节点在内共6个节点，主网启动后，由其中的三个节点轮流出块）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 初始化</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./start.sh clean                                                                        </span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启节点并注册候选人</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./start.sh run_vote /home/hearing/eosio-wallet ~/Downloads/eosio.contracts/ 6</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 投票</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 数字4表示user2投票给prod2，user3投票给prod3，user4投票给user4</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./start.sh vote 4</span></span><br></pre></td></tr></table></figure>

<p>此时会由prod2，3，4作为BP轮流出块（<strong>候选账户名需要跟节点名相同</strong>）。</p>
<p>注意：由于txn_test_gen_plugin的限制，当启动测试网后，貌似不能直接通过它去测试TPS（create_test_accounts会报错），故我这里加上了手动创建测试账户的过程（秘钥不能更改）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cleos system newaccount --transfer eosio txn.test.a EOS5hBSuDvcU2hHZJLAWCzBCCS7pV6SeQ4FuMhLPQPYqu9hcFakhy --stake-net <span class="string">&quot;100000000.0000 EOS&quot;</span> --stake-cpu <span class="string">&quot;100000000.0000 EOS&quot;</span> --buy-ram <span class="string">&quot;20000.0000 EOS&quot;</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos system newaccount --transfer eosio txn.test.b EOS5gUGqvjsoAmqEJvSBAygi7XF75CaCDfpysZRRVPRBdAzcirTWG --stake-net <span class="string">&quot;100000000.0000 EOS&quot;</span> --stake-cpu <span class="string">&quot;100000000.0000 EOS&quot;</span> --buy-ram <span class="string">&quot;20000.0000 EOS&quot;</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cleos system newaccount --transfer eosio txn.test.t EOS5gUGqvjsoAmqEJvSBAygi7XF75CaCDfpysZRRVPRBdAzcirTWG --stake-net <span class="string">&quot;100000000.0000 EOS&quot;</span> --stake-cpu <span class="string">&quot;100000000.0000 EOS&quot;</span> --buy-ram <span class="string">&quot;20000.0000 EOS&quot;</span></span></span><br></pre></td></tr></table></figure>

<p>限制端口带宽的相关命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo iptables -t mangle -F</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo tc qdisc del dev lo root</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo tc qdisc add dev lo root handle 1: htb default 1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo tc class add dev lo parent 1: classid 1:1 htb rate 100mbps</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo tc class add dev lo parent 1:1 classid 1:5 htb rate 256Kbit ceil 512Kbit prio 1</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo tc filter add dev lo parent 1:0 prio 1 protocol ip handle 5 fw flowid 1:5</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo iptables -A OUTPUT -t mangle -p tcp --sport 9877:9879 -j MARK --set-mark 5</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo iptables -A INPUT -t mangle -p tcp --sport 9877:9879 -j MARK --set-mark 5</span></span><br></pre></td></tr></table></figure>

<p>然后通过txn_test_gen_plugin提供的start_generation接口进行模拟交易，并测试TPS。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl --data-binary <span class="string">&#x27;[&quot;&quot;, 20, 20]&#x27;</span> http://127.0.0.1:8888/v1/txn_test_gen/start_generation</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/26/SDN%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/26/SDN%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">SDN笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-26 10:06:09" itemprop="dateCreated datePublished" datetime="2019-02-26T10:06:09+08:00">2019-02-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a>
                </span>
            </span>

          
            <span id="/2019/02/26/SDN%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="SDN笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/02/26/SDN%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/02/26/SDN%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>现有网络中，对流量的控制和转发都依赖于网络设备实现，且设备中集成了与业务特性紧耦合的操作系统和专用硬件，这些操作系统和专用硬件都是各个厂家自己开发和设计的。</p>
<p>SDN是一种新型的网络架构，它的设计理念是将网络的控制平面与数据转发平面进行分离，从而通过集中的控制器中的软件平台去实现可编程化控制底层硬件，实现对网络资源灵活的按需调配。在SDN网络中，网络设备只负责单纯的数据转发，可以采用通用的硬件;而原来负责控制的操作系统将提炼为独立的网络操作系统，负责对不同业务特性进行适配，而且网络操作系统和业务特性以及硬件设备之间的通信都可以通过编程实现。</p>
<p>与传统网络相比，SDN的基本特征有3点：</p>
<ol>
<li>控制与转发分离。转发平面由受控转发的设备组成，转发方式以及业务逻辑由运行在分离出去的控制面上的控制应用所控制。</li>
<li>控制平面与转发平面之间的开放接口。SDN 为控制平面提供开放可编程接口。通过这种方式，控制应用只需要关注自身逻辑，而不需要关注底层更多的实现细节。</li>
<li>逻辑上的集中控制。逻辑上集中的控制平面可以控制多个转发面设备，也就是控制整个物理网络，因而可以获得全局的网络状态视图，并根据该全局网络状态视图实现对网络的优化控制。</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/24/adb%E7%94%A8%E6%B3%95%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/24/adb%E7%94%A8%E6%B3%95%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">adb用法笔记</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-24 00:30:03" itemprop="dateCreated datePublished" datetime="2019-02-24T00:30:03+08:00">2019-02-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/" itemprop="url" rel="index"><span itemprop="name">Android</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android/%E7%B3%BB%E7%BB%9F/" itemprop="url" rel="index"><span itemprop="name">系统</span></a>
                </span>
            </span>

          
            <span id="/2019/02/24/adb%E7%94%A8%E6%B3%95%E7%AC%94%E8%AE%B0/" class="post-meta-item leancloud_visitors" data-flag-title="adb用法笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/02/24/adb%E7%94%A8%E6%B3%95%E7%AC%94%E8%AE%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/02/24/adb%E7%94%A8%E6%B3%95%E7%AC%94%E8%AE%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h1><p>ADB，即 Android Debug Bridge.</p>
<h1 id="命令语法"><a href="#命令语法" class="headerlink" title="命令语法"></a>命令语法</h1><p>adb 命令的基本语法如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb [-d|-e|-s &lt;serialNumber&gt;] &lt;command&gt;</span><br></pre></td></tr></table></figure>

<p>如果只有一个设备/模拟器连接时，可以省略掉 [-d|-e|-s &lt;serialNumber&gt;] 这一部分，直接使用 adb &lt;command&gt;。</p>
<h1 id="指定目标设备"><a href="#指定目标设备" class="headerlink" title="指定目标设备"></a>指定目标设备</h1><table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">-d</td>
<td align="center">指定当前唯一通过 USB 连接的 Android 设备为命令目标</td>
</tr>
<tr>
<td align="center">-e</td>
<td align="center">指定当前唯一运行的模拟器为命令目标</td>
</tr>
<tr>
<td align="center">-s &lt;serialNumber&gt;</td>
<td align="center">指定相应 serialNumber 号的设备/模拟器为命令目标</td>
</tr>
</tbody></table>
<p>在多个设备/模拟器连接的情况下较常用的是 -s &lt;serialNumber&gt; 参数，serialNumber 可以通过 adb devices 命令获取。</p>
<h1 id="启动-停止"><a href="#启动-停止" class="headerlink" title="启动/停止"></a>启动/停止</h1><p>启动 adb server 命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb start-server</span><br></pre></td></tr></table></figure>

<p>一般无需手动执行此命令，在运行 adb 命令时若发现 adb server 没有启动会自动调起。</p>
<p>停止 adb server 命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb kill-server</span><br></pre></td></tr></table></figure>

<h1 id="无线连接"><a href="#无线连接" class="headerlink" title="无线连接"></a>无线连接</h1><ol>
<li>将 Android 设备与将运行 adb 的电脑连接到同一个局域网。</li>
<li>将设备与电脑通过 USB 线连接。</li>
<li>让设备在 5555 端口监听 TCP/IP 连接:<code>adb tcpip 5555</code>。</li>
<li>断开 USB 连接。</li>
<li>找到设备的 IP 地址。</li>
<li>通过 IP 地址连接设备:<code>adb connect &lt;device-ip-address&gt;</code>。</li>
<li>确认连接状态:<code>adb devices</code>。</li>
<li>断开无线连接:<code>adb disconnect &lt;device-ip-address&gt;</code>。</li>
</ol>
<h1 id="应用管理"><a href="#应用管理" class="headerlink" title="应用管理"></a>应用管理</h1><h2 id="查看应用列表"><a href="#查看应用列表" class="headerlink" title="查看应用列表"></a>查看应用列表</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell pm list packages [-f] [-d] [-e] [-s] [-3] [-i] [-u] [--user USER_ID] [FILTER]</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">显示列表</th>
</tr>
</thead>
<tbody><tr>
<td align="center">无</td>
<td align="center">所有应用</td>
</tr>
<tr>
<td align="center">-f</td>
<td align="center">显示应用关联的 apk 文件</td>
</tr>
<tr>
<td align="center">-d</td>
<td align="center">只显示 disabled 的应用</td>
</tr>
<tr>
<td align="center">-e</td>
<td align="center">只显示 enabled 的应用</td>
</tr>
<tr>
<td align="center">-s</td>
<td align="center">只显示系统应用</td>
</tr>
<tr>
<td align="center">-3</td>
<td align="center">只显示第三方应用</td>
</tr>
<tr>
<td align="center">-i</td>
<td align="center">显示应用的 installer</td>
</tr>
<tr>
<td align="center">-u</td>
<td align="center">包含已卸载应用</td>
</tr>
<tr>
<td align="center">&lt;FILTER&gt;</td>
<td align="center">包名包含 &lt;FILTER&gt; 字符串</td>
</tr>
</tbody></table>
<h2 id="安装-APK"><a href="#安装-APK" class="headerlink" title="安装 APK"></a>安装 APK</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb install &lt;apk file&gt;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">-r</td>
<td align="center">允许覆盖安装。</td>
</tr>
<tr>
<td align="center">-s</td>
<td align="center">将应用安装到 sdcard。</td>
</tr>
<tr>
<td align="center">-d</td>
<td align="center">允许降级覆盖安装。</td>
</tr>
</tbody></table>
<h2 id="卸载应用"><a href="#卸载应用" class="headerlink" title="卸载应用"></a>卸载应用</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb uninstall [-k] &lt;packagename&gt;</span><br></pre></td></tr></table></figure>

<p>-k 参数可选，表示卸载应用但保留数据和缓存目录。</p>
<h2 id="清除应用数据与缓存"><a href="#清除应用数据与缓存" class="headerlink" title="清除应用数据与缓存"></a>清除应用数据与缓存</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell pm clear &lt;packagename&gt;</span><br></pre></td></tr></table></figure>

<p>这条命令的效果相当于在设置里的应用信息界面点击了「清除缓存」和「清除数据」。</p>
<h1 id="与应用交互"><a href="#与应用交互" class="headerlink" title="与应用交互"></a>与应用交互</h1><p>主要是使用 <code>am &lt;command&gt;</code> 命令，常用的 command 如下：</p>
<table>
<thead>
<tr>
<th align="center">command</th>
<th align="center">用途</th>
</tr>
</thead>
<tbody><tr>
<td align="center">start [options] &lt;INTENT&gt;</td>
<td align="center">启动 &lt;INTENT&gt; 指定的 Activity</td>
</tr>
<tr>
<td align="center">startservice [options] &lt;INTENT&gt;</td>
<td align="center">启动 &lt;INTENT&gt; 指定的 Service</td>
</tr>
<tr>
<td align="center">broadcast [options] &lt;INTENT&gt;</td>
<td align="center">发送 &lt;INTENT&gt; 指定的广播</td>
</tr>
<tr>
<td align="center">force-stop &lt;packagename&gt;</td>
<td align="center">停止 &lt;packagename&gt; 相关的进程</td>
</tr>
</tbody></table>
<p>&lt;INTENT&gt; 参数很灵活，和写 Android 程序时代码里的 Intent 相对应。用于决定 intent 对象的选项如下：</p>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">-a &lt;ACTION&gt;</td>
<td align="center">指定 action，比如 android.intent.action.VIEW</td>
</tr>
<tr>
<td align="center">-c &lt;CATEGORY&gt;</td>
<td align="center">指定 category，比如 android.intent.category.APP_CONTACTS</td>
</tr>
<tr>
<td align="center">-n &lt;COMPONENT&gt;</td>
<td align="center">指定完整 component 名，用于明确指定启动哪个 Activity，如 com.example.app/.ExampleActivity</td>
</tr>
</tbody></table>
<p>&lt;INTENT&gt; 里还能带数据，就像写代码时的 Bundle 一样：</p>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="center">–esn &lt;EXTRA_KEY&gt;</td>
<td align="center">null 值（只有 key 名）</td>
</tr>
<tr>
<td align="center">–es &lt;EXTRA_KEY&gt; &lt;EXTRA_STRING_VALUE&gt;</td>
<td align="center">String 值</td>
</tr>
<tr>
<td align="center">–ez &lt;EXTRA_KEY&gt; &lt;EXTRA_BOOLEAN_VALUE&gt;</td>
<td align="center">boolean 值</td>
</tr>
<tr>
<td align="center">–ei &lt;EXTRA_KEY&gt; &lt;EXTRA_INT_VALUE&gt;</td>
<td align="center">integer 值</td>
</tr>
<tr>
<td align="center">–el &lt;EXTRA_KEY&gt; &lt;EXTRA_LONG_VALUE&gt;</td>
<td align="center">long 值</td>
</tr>
<tr>
<td align="center">–ef &lt;EXTRA_KEY&gt; &lt;EXTRA_FLOAT_VALUE&gt;</td>
<td align="center">float 值</td>
</tr>
<tr>
<td align="center">–eu &lt;EXTRA_KEY&gt; &lt;EXTRA_URI_VALUE&gt;</td>
<td align="center">URI</td>
</tr>
<tr>
<td align="center">–ecn &lt;EXTRA_KEY&gt; &lt;EXTRA_COMPONENT_NAME_VALUE&gt;</td>
<td align="center">component name</td>
</tr>
<tr>
<td align="center">–eia &lt;EXTRA_KEY&gt; &lt;EXTRA_INT_VALUE&gt;[,&lt;EXTRA_INT_VALUE…]</td>
<td align="center">integer 数组</td>
</tr>
<tr>
<td align="center">–ela &lt;EXTRA_KEY&gt; &lt;EXTRA_LONG_VALUE&gt;[,&lt;EXTRA_LONG_VALUE…]</td>
<td align="center">long 数组</td>
</tr>
</tbody></table>
<h2 id="调起-Activity"><a href="#调起-Activity" class="headerlink" title="调起 Activity"></a>调起 Activity</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start [options] &lt;INTENT&gt;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -n com.tencent.mm/.ui.LauncherUI</span><br></pre></td></tr></table></figure>

<p>表示调起微信主界面。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am start -n org.mazhuang.boottimemeasure/.MainActivity --es &quot;toast&quot; &quot;hello, world&quot;</span><br></pre></td></tr></table></figure>

<p>表示调起 org.mazhuang.boottimemeasure/.MainActivity 并传给它 string 数据键值对 toast - hello, world。</p>
<h2 id="调起-Service"><a href="#调起-Service" class="headerlink" title="调起 Service"></a>调起 Service</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am startservice [options] &lt;INTENT&gt;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am startservice -n com.tencent.mm/.plugin.accountsync.model.AccountAuthenticatorService</span><br></pre></td></tr></table></figure>

<p>表示调起微信的某 Service。</p>
<h2 id="发送广播"><a href="#发送广播" class="headerlink" title="发送广播"></a>发送广播</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am broadcast [options] &lt;INTENT&gt;</span><br></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am broadcast -a android.intent.action.BOOT_COMPLETED -n org.mazhuang.boottimemeasure/.BootCompletedReceiver</span><br></pre></td></tr></table></figure>

<p>表示向 org.mazhuang.boottimemeasure/.BootCompletedReceiver 发送一个 BOOT_COMPLETED 广播，这类用法在测试的时候很实用，比如某个广播的场景很难制造，可以考虑通过这种方式来发送广播。</p>
<h2 id="强制停止应用"><a href="#强制停止应用" class="headerlink" title="强制停止应用"></a>强制停止应用</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am force-stop &lt;packagename&gt;</span><br></pre></td></tr></table></figure>

<p>命令示例：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell am force-stop com.qihoo360.mobilesafe</span><br></pre></td></tr></table></figure>

<h1 id="设备-进程信息"><a href="#设备-进程信息" class="headerlink" title="设备/进程信息"></a>设备/进程信息</h1><h2 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h2><p>原生Linux的查看方式见<a target="_blank" rel="noopener" href="https://ljd1996.github.io/2019/08/27/Linux%E7%AC%94%E8%AE%B0/">Linux笔记</a></p>
<h2 id="procrank"><a href="#procrank" class="headerlink" title="procrank"></a>procrank</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">rocrank</span><br><span class="line">  PID      Vss      Rss      Pss      Uss  cmdline</span><br><span class="line"> 1078   59840K   59708K   42125K   39344K  com.csr.BTApp</span><br><span class="line"> 2683   59124K   59040K   37960K   33032K  com.android.launcher</span><br><span class="line"> 1042   51572K   51488K   35686K   33604K  android.process.acore</span><br><span class="line">  782   32808K   32748K   16775K   14716K  system_server</span><br><span class="line">  667   20560K   17560K   12739K    8940K  /system/bin/surfaceflinger</span><br><span class="line">  851   30124K   30036K   12085K    7996K  com.android.systemui</span><br><span class="line"> 2999   27680K   27596K    9929K    7040K  com.baidu.input</span><br><span class="line">  959   20764K   20676K    5522K    3788K  com.android.phone</span><br><span class="line"> 3468   21892K   21800K    4591K    1920K  com.apical.dreamthemetime</span><br><span class="line">  982   19880K   19792K    4438K    2644K  com.csr.csrservices</span><br><span class="line">  668   19592K   19480K    3525K    1360K  zygote</span><br><span class="line">  670    2960K    2960K    2407K    2356K  /system/bin/mediaserver</span><br><span class="line">  663    1784K    1784K    1209K    1116K  /system/bin/synergy_service</span><br><span class="line">  756    3404K    1348K    1133K    1124K  /usr/bin/gpsexe</span><br><span class="line">  669    1468K    1468K     959K     928K  /system/bin/drmserver</span><br><span class="line">  675     692K     692K     692K     692K  /bin/sh</span><br><span class="line"> 3482     656K     652K     456K     444K  procrank</span><br><span class="line">    1     164K     164K     144K     144K  /init</span><br><span class="line">                          ------   ------  ------</span><br><span class="line">                         195031K  163724K  TOTAL</span><br><span class="line"></span><br><span class="line">RAM: 480380K total, 3624K free, 732K buffers, 299788K cached, 264844K shmem, 7632K slab</span><br></pre></td></tr></table></figure>

<h2 id="dumpsys"><a href="#dumpsys" class="headerlink" title="dumpsys"></a>dumpsys</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">dumpsys [options]</span><br><span class="line">        meminfo 显示内存信息</span><br><span class="line">        cpuinfo 显示CPU信息</span><br><span class="line">        account 显示accounts信息</span><br><span class="line">        activity 显示所有的activities的信息</span><br><span class="line">        window 显示键盘，窗口和它们的关系</span><br><span class="line">        wifi 显示wifi信息</span><br></pre></td></tr></table></figure>

<p>可以在其后通过包名或者进程pid展示指定进程的信息。</p>
<h2 id="型号"><a href="#型号" class="headerlink" title="型号"></a>型号</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell getprop ro.product.model</span><br></pre></td></tr></table></figure>

<h2 id="电池状况"><a href="#电池状况" class="headerlink" title="电池状况"></a>电池状况</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys battery</span><br></pre></td></tr></table></figure>

<h2 id="屏幕分辨率"><a href="#屏幕分辨率" class="headerlink" title="屏幕分辨率"></a>屏幕分辨率</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell wm size</span><br></pre></td></tr></table></figure>

<h2 id="屏幕密度"><a href="#屏幕密度" class="headerlink" title="屏幕密度"></a>屏幕密度</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell wm density</span><br></pre></td></tr></table></figure>

<h2 id="android-id"><a href="#android-id" class="headerlink" title="android_id"></a>android_id</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell settings get secure android_id</span><br></pre></td></tr></table></figure>

<h2 id="IMEI"><a href="#IMEI" class="headerlink" title="IMEI"></a>IMEI</h2><p>在 Android 4.4 及以下版本可通过如下命令获取 IMEI：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys iphonesubinfo</span><br></pre></td></tr></table></figure>

<p>而在 Android 5.0 及以上版本里这个命令输出为空，得通过其它方式获取了（需要 root 权限）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service call iphonesubinfo 1</span><br></pre></td></tr></table></figure>

<h2 id="Android-系统版本"><a href="#Android-系统版本" class="headerlink" title="Android 系统版本"></a>Android 系统版本</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell getprop ro.build.version.release</span><br></pre></td></tr></table></figure>

<h2 id="Mac-地址"><a href="#Mac-地址" class="headerlink" title="Mac 地址"></a>Mac 地址</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell cat /sys/class/net/wlan0/address</span><br></pre></td></tr></table></figure>

<h2 id="CPU-信息"><a href="#CPU-信息" class="headerlink" title="CPU 信息"></a>CPU 信息</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell cat /proc/cpuinfo</span><br></pre></td></tr></table></figure>

<h2 id="更多硬件与系统属性"><a href="#更多硬件与系统属性" class="headerlink" title="更多硬件与系统属性"></a>更多硬件与系统属性</h2><p>设备的更多硬件与系统属性可以通过如下命令查看：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell cat /system/build.prop</span><br></pre></td></tr></table></figure>

<p>这会输出很多信息，包括前面几个小节提到的「型号」和「Android 系统版本」等。输出里还包括一些其它有用的信息，它们也可通过 adb shell getprop &lt;属性名&gt; 命令单独查看，列举一部分属性如下：</p>
<img src="硬件与设备信息.png"/>

<h1 id="模拟按键-输入"><a href="#模拟按键-输入" class="headerlink" title="模拟按键/输入"></a>模拟按键/输入</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Usage: input [&lt;source&gt;] &lt;command&gt; [&lt;arg&gt;...]</span><br><span class="line"></span><br><span class="line">The sources are:</span><br><span class="line">      mouse</span><br><span class="line">      keyboard</span><br><span class="line">      joystick</span><br><span class="line">      touchnavigation</span><br><span class="line">      touchpad</span><br><span class="line">      trackball</span><br><span class="line">      stylus</span><br><span class="line">      dpad</span><br><span class="line">      gesture</span><br><span class="line">      touchscreen</span><br><span class="line">      gamepad</span><br><span class="line"></span><br><span class="line">The commands and default sources are:</span><br><span class="line">      text &lt;string&gt; (Default: touchscreen)</span><br><span class="line">      keyevent [--longpress] &lt;key code number or name&gt; ... (Default: keyboard)</span><br><span class="line">      tap &lt;x&gt; &lt;y&gt; (Default: touchscreen)</span><br><span class="line">      swipe &lt;x1&gt; &lt;y1&gt; &lt;x2&gt; &lt;y2&gt; [duration(ms)] (Default: touchscreen)</span><br><span class="line">      press (Default: trackball)</span><br><span class="line">      roll &lt;dx&gt; &lt;dy&gt; (Default: trackball)</span><br></pre></td></tr></table></figure>

<p>比如使用 adb shell input keyevent &lt;keycode&gt; 命令，部分keycode如下：</p>
<img src="keycode.png"/>

<p>比如可以使用 <code>adb shell input text hello</code> 命令来输入文本。</p>
<h1 id="屏幕截图"><a href="#屏幕截图" class="headerlink" title="屏幕截图"></a>屏幕截图</h1><p>-p 指定保存为png.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell screencap -p /sdcard/sc.png</span><br></pre></td></tr></table></figure>

<h1 id="录制屏幕"><a href="#录制屏幕" class="headerlink" title="录制屏幕"></a>录制屏幕</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell screenrecord /sdcard/filename.mp4</span><br></pre></td></tr></table></figure>

<h1 id="由包名获取apk路径"><a href="#由包名获取apk路径" class="headerlink" title="由包名获取apk路径"></a>由包名获取apk路径</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell pm path pkg</span><br></pre></td></tr></table></figure>

<h1 id="获取当前APP包名"><a href="#获取当前APP包名" class="headerlink" title="获取当前APP包名"></a>获取当前APP包名</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell dumpsys window | findstr mCurrentFocus</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/23/Network-Coding/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.png">
      <meta itemprop="name" content="苍耳叔叔">
      <meta itemprop="description" content="梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="苍耳的博客">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/23/Network-Coding/" class="post-title-link" itemprop="url">Network-Coding</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-02-23 21:00:53" itemprop="dateCreated datePublished" datetime="2019-02-23T21:00:53+08:00">2019-02-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-05-14 14:14:57" itemprop="dateModified" datetime="2021-05-14T14:14:57+08:00">2021-05-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a>
                </span>
            </span>

          
            <span id="/2019/02/23/Network-Coding/" class="post-meta-item leancloud_visitors" data-flag-title="Network-Coding" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/02/23/Network-Coding/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/02/23/Network-Coding/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="TCP-IP的问题"><a href="#TCP-IP的问题" class="headerlink" title="TCP/IP的问题"></a>TCP/IP的问题</h1><p>互联网上的数据传递都是封装在“包裹”里的,将信息传递到终点的程序，以及这些“包裹”的格式，通常用 TCP/IP 协议来描述。为了让 TCP 数据传输成功，接收数据的人需要按照当时发出时的顺序，准确的来接收这些“数字包裹”。如果其中有一个数据包，因为某种原因给丢失了，那么这种互联网协议就会将其看作是网络拥堵的一个信号，数据传输速度立刻下降一半，之后它速度回升起来的也非常缓慢。该处理机制在某些状况下也许很理想，但是在另外一些状况下就会很糟糕。其根本的原因就在于：这套互联网协议本身并没有足够的智能，来分别接下来做什么事才是最正确的选择。同时，尽管从理论上来说，数字包可以从 A 点到 B 点以无限条路径进行传说，但事实上，在一个 TCP 连接中，数据传输一般都走的是相同的路径，这就给了数字黑客以机会，方便他们侵入到你的通信交流中。</p>
<h1 id="网络编码"><a href="#网络编码" class="headerlink" title="网络编码"></a>网络编码</h1><p>网络编码是一种通过中继节点对接收到的信息进行编码来达到提高多播网络容量的技术。在传统的数据传输技术中，中继节点只负责数据的存储转发，而基于网络编码技术的网络的中继节点在具备传统中继功能的基础上，会根据网络编码规则将接收到的信息进行线性或非线性处理再进行传播，这种做法最直观的优势是减少了传输次数。</p>
<p>“网络编码”能够让网络中的每一个节点都变得比现在更加智能。在 TCP/IP 协议中，网络节点只是一些简单的转换节点，只负责存储“数字包裹”，并且按照之前预设的路径转发到下一节点，而相比之下，在“网络编码”中，每一个节点都可以对“数字包裹”进行再加工，比如重新编制路径，或者重新编码。将智能赋予到网络的每个节点，是该技术称得上“破坏性创新”的理由。因为这将赋予信息处理技术以史无前例的灵活性。例如，它可以利用多路径 TCP，另外，应用了再编码机制，可以进一步的提升安全性和数据传输速度，甚至能够在网络的每个节点内部存储数据信息。</p>
<p>在”网络编码”中，“数字包裹”中的内容被看作是一个真实的数字，“数字包裹”以“批”为单位进行处理。每一个节点都构建了一套线性方程，利用的是从“数字包裹”中提取出来的数字，以及随机生成的一组系数。每一个线性方程都能生成一个已编码的包裹，其系数存储在编码包裹的头部，未知的变量是每一个包裹的实际信息，当作一个数字。换句话说，每一个已编码的包裹中，都一次性的在几个“标准”的包裹上含有部分的信息，但同时还乘以不同的系数。如果你还没有忘记高中数学的话，你知道需要 N 个线性方程来解决 N 个未知变量。因为每一个以编码的数字包裹都包含一个单独的方程，这意味着接收信息者如果想要解码这段信息，就需要 N 个这样的数字包裹(当然乘以不同的系数才可以)。</p>
<p>这样做使得接收内容彻底与数字包裹接收的顺序撇开了关系,接收信息者得到了 N 个已编码的包裹，每个都配有不同的系数，所以它能够解开所有的方程，还原最原始的数据。这种打破固有顺序所带来的灵活性，意味着整个信息系统将更加高效。也意味着曾经在 TCP/IP 中发生的严重的数据传递延迟甚至数据包丢失的情况一去不复返。因为顺序不再重要，数字包裹可以在网络中以各种不同的路径进行传递，这样会提升安全性。也就没有人能够切入到私人的通信网络中。</p>
<h1 id="线性网络编码"><a href="#线性网络编码" class="headerlink" title="线性网络编码"></a>线性网络编码</h1><h2 id="线性网络编码-1"><a href="#线性网络编码-1" class="headerlink" title="线性网络编码"></a>线性网络编码</h2><p>假设网络是有向的，执行线性网络编码时每个节点收到所有连入线路的数据后，再执行编码，然后把数据从连出线路发出。新的数据包括执行线性编码所用的系数以及合成后的数据。</p>
<img src="线性网络编码.png"/>

<h2 id="随机线性网络编码"><a href="#随机线性网络编码" class="headerlink" title="随机线性网络编码"></a>随机线性网络编码</h2><p>随机线性网络编码可以取得更好的组播传输速率，较为实用。在实际网络中，节点会将来自连入线路的封包缓存起来，当节点需要发送封包时再将缓存的封包执行网络编码，然后发出。</p>
<img src="随机线性网络编码.png"/>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/10/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/12/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="苍耳叔叔"
      src="/images/head.png">
  <p class="site-author-name" itemprop="name">苍耳叔叔</p>
  <div class="site-description" itemprop="description">梦里寻她千百度，蓦然回首，那人却在，灯火阑珊处。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">156</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">100</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ljd1996" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ljd1996" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:hearing1996@gmail.com" title="E-Mail → mailto:hearing1996@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">苍耳叔叔</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : true,
      notify     : true,
      appId      : 'pCnIlzs46HJGpubm7D3TnrBC-gzGzoHsz',
      appKey     : '7LzW4wBI9lY5DtVFNkFWcjs0',
      placeholder: "欢迎评论交流！",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
